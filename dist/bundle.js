(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{ABILITY_ARROW_MIN_LENGTH:()=>Qs,ABILITY_BULLET_EFFECT_RADIUS:()=>C,ABILITY_BULLET_FORCE_MULTIPLIER:()=>M,AIStrategy:()=>qr,AI_AGGRESSIVE_HERO_MULTIPLIER:()=>qi,AI_DEFENSE_COMMAND_INTERVAL_SEC:()=>Vi,AI_DEFENSE_RADIUS_PX:()=>is,AI_ECONOMIC_HERO_MULTIPLIER:()=>Ji,AI_HERO_COMMAND_INTERVAL_SEC:()=>Xi,AI_MAX_MIRRORS:()=>Ki,AI_MIRROR_ARC_SPACING_RAD:()=>ts,AI_MIRROR_COMMAND_INTERVAL_SEC:()=>zi,AI_MIRROR_PURCHASE_INTERVAL_SEC:()=>$i,AI_MIRROR_REPOSITION_THRESHOLD_PX:()=>es,AI_MIRROR_SUN_DISTANCE_PX:()=>Zi,AI_STRUCTURE_COMMAND_INTERVAL_SEC:()=>Yi,AI_STRUCTURE_PLACEMENT_ANGLE_STEP_RAD:()=>os,AI_STRUCTURE_PLACEMENT_DISTANCE_PX:()=>ss,AI_WAVES_ATTACK_THRESHOLD:()=>ji,AI_WAVES_HERO_MULTIPLIER:()=>Qi,ASTEROID_MAX_SIZE:()=>Ht,ASTEROID_MIN_SIZE:()=>Ut,BEAM_ABILITY_BASE_DAMAGE:()=>rn,BEAM_ABILITY_COOLDOWN:()=>nn,BEAM_ABILITY_DAMAGE_PER_DISTANCE:()=>ln,BEAM_ABILITY_MAX_RANGE:()=>an,BEAM_ALONG_COMPONENT:()=>k,BEAM_ATTACK_DAMAGE:()=>sn,BEAM_ATTACK_RANGE:()=>en,BEAM_ATTACK_SPEED:()=>on,BEAM_EFFECT_RADIUS:()=>v,BEAM_FORCE_STRENGTH:()=>O,BEAM_MAX_HEALTH:()=>tn,BEAM_PERPENDICULAR_COMPONENT:()=>G,BORDER_FADE_WIDTH:()=>zt,BOUNCING_BULLET_LIFETIME:()=>xs,BOUNCING_BULLET_SPEED_MAX:()=>ms,BOUNCING_BULLET_SPEED_MIN:()=>ys,BUILDING_BUILD_TIME:()=>cs,BULLET_CASING_LIFETIME:()=>gs,BULLET_CASING_SPEED_MAX:()=>ps,BULLET_CASING_SPEED_MIN:()=>us,CASING_COLLISION_DAMPING:()=>As,CASING_SPACEDUST_COLLISION_DISTANCE:()=>fs,CASING_SPACEDUST_FORCE:()=>Ss,CLICK_DRAG_THRESHOLD:()=>Ks,COUNTDOWN_DURATION:()=>Xt,DAGGER_ABILITY_COOLDOWN:()=>jo,DAGGER_ABILITY_DAMAGE:()=>Jo,DAGGER_ABILITY_RANGE:()=>qo,DAGGER_ATTACK_DAMAGE:()=>$o,DAGGER_ATTACK_RANGE:()=>Yo,DAGGER_ATTACK_SPEED:()=>Ko,DAGGER_CLOAK_OPACITY:()=>Zo,DAGGER_MAX_HEALTH:()=>Xo,DAGGER_VISIBILITY_DURATION:()=>Qo,DEPLOYED_TURRET_ANIMATION_DURATION:()=>Fo,DEPLOYED_TURRET_ANIMATION_FRAME_COUNT:()=>vo,DEPLOYED_TURRET_ATTACK_DAMAGE:()=>wo,DEPLOYED_TURRET_ATTACK_RANGE:()=>Ro,DEPLOYED_TURRET_ATTACK_SPEED:()=>bo,DEPLOYED_TURRET_HEALTH_BAR_SIZE:()=>Oo,DEPLOYED_TURRET_MAX_HEALTH:()=>Mo,DEPLOYED_TURRET_SPRITE_SCALE:()=>Do,DRILLER_ABILITY_COOLDOWN:()=>Uo,DRILLER_ATTACK_DAMAGE:()=>ko,DRILLER_ATTACK_RANGE:()=>Bo,DRILLER_ATTACK_SPEED:()=>Go,DRILLER_BUILDING_DAMAGE_MULTIPLIER:()=>zo,DRILLER_DECELERATION:()=>Vo,DRILLER_DRILL_DAMAGE:()=>Wo,DRILLER_DRILL_SPEED:()=>Ho,DRILLER_MAX_HEALTH:()=>No,DUST_CLUSTER_COUNT:()=>K,DUST_CLUSTER_RADIUS_PX:()=>j,DUST_CLUSTER_SPAWN_RATIO:()=>q,DUST_COLOR_FADE_IN_SPEED:()=>nt,DUST_COLOR_FADE_OUT_SPEED:()=>rt,DUST_COLOR_FORCE_SCALE:()=>at,DUST_COLOR_IMPACT_HOLD_SEC:()=>ot,DUST_FADE_TO_NORMAL_DELAY_MS:()=>Mt,DUST_FADE_TO_SLIGHT_DELAY_MS:()=>Rt,DUST_FAST_MOVEMENT_THRESHOLD:()=>It,DUST_GLOW_STATE_FULL:()=>Pt,DUST_GLOW_STATE_NORMAL:()=>Et,DUST_GLOW_STATE_SLIGHT:()=>_t,DUST_GLOW_TRANSITION_SPEED_DOWN:()=>bt,DUST_GLOW_TRANSITION_SPEED_UP:()=>wt,DUST_MIN_VELOCITY:()=>V,DUST_PARTICLE_DIAMETER_PX:()=>W,DUST_PARTICLE_SIZE:()=>H,DUST_PUSH_MIN_EFFECTIVE_SPEED_PX_PER_SEC:()=>J,DUST_REPULSION_CELL_SIZE_PX:()=>Y,DUST_REPULSION_RADIUS_PX:()=>X,DUST_REPULSION_STRENGTH:()=>$,DUST_SHADOW_LENGTH_PX:()=>ht,DUST_SHADOW_MAX_DISTANCE_PX:()=>lt,DUST_SHADOW_OPACITY:()=>ct,DUST_SHADOW_WIDTH_PX:()=>dt,DUST_SLOW_MOVEMENT_THRESHOLD:()=>Ct,DUST_SPRITE_SCALE_FACTOR:()=>mt,DUST_TRAIL_LENGTH_PER_SPEED:()=>xt,DUST_TRAIL_MAX_LENGTH_PX:()=>pt,DUST_TRAIL_MIN_LENGTH_PX:()=>ut,DUST_TRAIL_MIN_SPEED_PX_PER_SEC:()=>gt,DUST_TRAIL_WIDTH_PX:()=>yt,FLUID_FORWARD_COMPONENT:()=>N,FLUID_MIN_DISTANCE:()=>U,FLUID_RADIAL_COMPONENT:()=>B,FORGE_BLINK_UPGRADE_COST:()=>Ni,FORGE_CRUNCH_INTERVAL:()=>He,FORGE_CRUNCH_SUCK_DURATION:()=>We,FORGE_CRUNCH_SUCK_FORCE:()=>Ye,FORGE_CRUNCH_SUCK_RADIUS:()=>Ve,FORGE_CRUNCH_WAVE_DURATION:()=>ze,FORGE_CRUNCH_WAVE_FORCE:()=>$e,FORGE_CRUNCH_WAVE_RADIUS:()=>Xe,FORGE_DUST_PUSH_FORCE_MULTIPLIER:()=>et,FORGE_DUST_PUSH_RADIUS_PX:()=>tt,FORGE_FLAME_ALPHA:()=>Oe,FORGE_FLAME_OFFSET_MULTIPLIER:()=>Ge,FORGE_FLAME_ROTATION_SPEED_RAD_PER_SEC:()=>Be,FORGE_FLAME_SIZE_MULTIPLIER:()=>Ne,FORGE_FLAME_WARMTH_FADE_PER_SEC:()=>ke,FORGE_UPGRADE_BUTTON_DISTANCE_PX:()=>hs,FORGE_UPGRADE_BUTTON_RADIUS_PX:()=>ls,FOUNDRY_REGEN_UPGRADE_COST:()=>Fi,FOUNDRY_REGEN_UPGRADE_ITEM:()=>vi,FOUNDRY_STRAFE_UPGRADE_COST:()=>Li,FOUNDRY_STRAFE_UPGRADE_ITEM:()=>Di,GATLING_ATTACK_DAMAGE:()=>si,GATLING_ATTACK_RANGE:()=>ii,GATLING_ATTACK_SPEED:()=>oi,GATLING_COST:()=>Ci,GATLING_MAX_HEALTH:()=>ei,GATLING_RADIUS:()=>ni,GRAVE_ATTACK_DAMAGE:()=>ie,GRAVE_ATTACK_RANGE:()=>te,GRAVE_ATTACK_SPEED:()=>se,GRAVE_HERO_ATTACK_RANGE_MULTIPLIER:()=>ee,GRAVE_MAX_HEALTH:()=>Zt,GRAVE_MAX_SMALL_PARTICLES:()=>de,GRAVE_NUM_PROJECTILES:()=>oe,GRAVE_PROJECTILE_ATTRACTION_FORCE:()=>ae,GRAVE_PROJECTILE_EFFECT_RADIUS:()=>b,GRAVE_PROJECTILE_FORCE_MULTIPLIER:()=>L,GRAVE_PROJECTILE_HIT_DISTANCE:()=>ce,GRAVE_PROJECTILE_LAUNCH_SPEED:()=>le,GRAVE_PROJECTILE_MIN_SPEED:()=>re,GRAVE_PROJECTILE_ORBIT_RADIUS:()=>ne,GRAVE_PROJECTILE_TRAIL_LENGTH:()=>he,GRAVE_SMALL_PARTICLES_PER_ATTACK:()=>ue,GRAVE_SMALL_PARTICLE_REGEN_RATE:()=>ge,GRAVE_SMALL_PARTICLE_SIZE:()=>xe,GRAVE_SMALL_PARTICLE_SPEED:()=>pe,HERO_ATTACK_RANGE_ALPHA:()=>qs,HERO_BUTTON_DISTANCE_PX:()=>as,HERO_BUTTON_RADIUS_PX:()=>rs,HERO_PRODUCTION_TIME_SEC:()=>ns,HERO_UNIT_COST:()=>wi,INFLUENCE_BALL_ABILITY_COOLDOWN:()=>fo,INFLUENCE_BALL_ATTACK_DAMAGE:()=>yo,INFLUENCE_BALL_ATTACK_RANGE:()=>xo,INFLUENCE_BALL_ATTACK_SPEED:()=>mo,INFLUENCE_BALL_DURATION:()=>To,INFLUENCE_BALL_EFFECT_RADIUS:()=>F,INFLUENCE_BALL_EXPLOSION_RADIUS:()=>Ao,INFLUENCE_BALL_FORCE_MULTIPLIER:()=>D,INFLUENCE_BALL_MAX_HEALTH:()=>po,INFLUENCE_BALL_PROJECTILE_SPEED:()=>So,INFLUENCE_RADIUS:()=>n,LAD_SUN_OUTLINE_COLOR:()=>l,MAP_PLAYABLE_BOUNDARY:()=>Vt,MAP_SIZE:()=>Wt,MARINE_ABILITY_BULLET_COUNT:()=>Ws,MARINE_ABILITY_BULLET_DAMAGE:()=>Ys,MARINE_ABILITY_BULLET_LIFETIME:()=>Vs,MARINE_ABILITY_BULLET_SPEED:()=>zs,MARINE_ABILITY_COOLDOWN:()=>Hs,MARINE_ABILITY_SPREAD_ANGLE:()=>Xs,MARINE_ATTACK_DAMAGE:()=>Jt,MARINE_ATTACK_RANGE:()=>qt,MARINE_ATTACK_SPEED:()=>Qt,MARINE_MAX_HEALTH:()=>jt,MAX_RAY_DISTANCE:()=>vt,MINIGUN_ATTACK_DAMAGE:()=>Je,MINIGUN_ATTACK_RANGE:()=>qe,MINIGUN_ATTACK_SPEED:()=>Qe,MINIGUN_COST:()=>Ii,MINIGUN_LASER_WIDTH_PX:()=>Ze,MINIGUN_MAX_HEALTH:()=>je,MINIGUN_RADIUS:()=>ti,MINION_PROJECTILE_EFFECT_RADIUS:()=>R,MINION_PROJECTILE_FORCE_MULTIPLIER:()=>w,MIN_WAYPOINT_DISTANCE:()=>vs,MIRROR_ACTIVE_GLOW_RADIUS:()=>Bs,MIRROR_CLICK_RADIUS_PX:()=>ks,MIRROR_COUNTDOWN_DEPLOY_DISTANCE:()=>Yt,MIRROR_DUST_PUSH_FORCE_MULTIPLIER:()=>Z,MIRROR_DUST_PUSH_RADIUS_PX:()=>Q,MIRROR_MAX_GLOW_DISTANCE:()=>Gs,MIRROR_MAX_HEALTH:()=>$t,MIRROR_PROXIMITY_MULTIPLIER:()=>Us,MIRROR_REGEN_PER_SEC:()=>Kt,MORTAR_ABILITY_COOLDOWN:()=>wn,MORTAR_ATTACK_DAMAGE:()=>Mn,MORTAR_ATTACK_RANGE:()=>Cn,MORTAR_ATTACK_SPEED:()=>Rn,MORTAR_DETECTION_CONE_ANGLE:()=>bn,MORTAR_MAX_HEALTH:()=>In,MORTAR_PROJECTILE_SPEED:()=>Dn,MORTAR_SPLASH_DAMAGE_FALLOFF:()=>Fn,MORTAR_SPLASH_RADIUS:()=>Ln,MOVEMENT_POINT_ANIMATION_FPS:()=>Tt,MOVEMENT_POINT_ANIMATION_FRAME_COUNT:()=>At,MUZZLE_FLASH_DURATION:()=>ds,NOVA_ABILITY_COOLDOWN:()=>ur,NOVA_ATTACK_DAMAGE:()=>dr,NOVA_ATTACK_RANGE:()=>cr,NOVA_ATTACK_SPEED:()=>gr,NOVA_BOMB_ARMING_TIME:()=>mr,NOVA_BOMB_BOUNCE_DAMPING:()=>fr,NOVA_BOMB_DECELERATION:()=>xr,NOVA_BOMB_EXPLOSION_DAMAGE:()=>Ar,NOVA_BOMB_EXPLOSION_RADIUS:()=>Tr,NOVA_BOMB_INITIAL_SPEED:()=>pr,NOVA_BOMB_MAX_BOUNCES:()=>Sr,NOVA_BOMB_MIN_SPEED:()=>yr,NOVA_BOMB_RADIUS:()=>Mr,NOVA_BOMB_SCATTER_ARC:()=>Er,NOVA_BOMB_SCATTER_BULLET_COUNT:()=>_r,NOVA_BOMB_SCATTER_BULLET_DAMAGE:()=>Ir,NOVA_BOMB_SCATTER_BULLET_LIFETIME:()=>Cr,NOVA_BOMB_SCATTER_BULLET_SPEED:()=>Pr,NOVA_MAX_HEALTH:()=>hr,PARTICLE_SCATTER_FORCE:()=>I,PARTICLE_SCATTER_RADIUS:()=>P,PATH_WAYPOINT_ARRIVAL_MULTIPLIER:()=>Ds,PLAYER_1_COLOR:()=>r,PLAYER_2_COLOR:()=>a,PREIST_ABILITY_COOLDOWN:()=>kn,PREIST_ATTACK_DAMAGE:()=>Nn,PREIST_ATTACK_RANGE:()=>On,PREIST_ATTACK_SPEED:()=>Bn,PREIST_HEALING_BOMB_EXPLOSION_RADIUS:()=>$n,PREIST_HEALING_BOMB_MAX_RANGE:()=>Vn,PREIST_HEALING_BOMB_PARTICLE_COUNT:()=>Xn,PREIST_HEALING_BOMB_PARTICLE_HEALING:()=>Yn,PREIST_HEALING_BOMB_PARTICLE_LIFETIME:()=>jn,PREIST_HEALING_BOMB_PARTICLE_SPEED:()=>Kn,PREIST_HEALING_BOMB_SPEED:()=>zn,PREIST_HEALING_PER_SECOND:()=>Un,PREIST_HEALING_RANGE:()=>Gn,PREIST_MAX_HEALTH:()=>vn,PREIST_NUM_BEAMS:()=>Wn,PREIST_TARGET_LOCK_DURATION:()=>Hn,PRODUCTION_BUTTON_WAVE_MAX_RADIUS_PX:()=>io,PRODUCTION_BUTTON_WAVE_PROGRESS_PER_FRAME:()=>so,RAYTRACING_NUM_RAYS:()=>Dt,RAY_ABILITY_COOLDOWN:()=>ho,RAY_ATTACK_DAMAGE:()=>ao,RAY_ATTACK_RANGE:()=>ro,RAY_ATTACK_SPEED:()=>lo,RAY_BEAM_DAMAGE:()=>co,RAY_BEAM_MAX_BOUNCES:()=>go,RAY_BEAM_WIDTH:()=>uo,RAY_MAX_HEALTH:()=>no,SHADE_OPACITY:()=>Bt,SHADOW_LENGTH:()=>Ot,SMALL_SELECTION_THRESHOLD:()=>js,SOLAR_MIRROR_COST:()=>bi,SOLAR_MIRROR_FROM_FOUNDRY_COST:()=>Oi,SOL_ICON_TEXT_SPACING:()=>Js,SPACE_DUST_PARTICLE_COUNT:()=>z,SPOTLIGHT_ABILITY_COOLDOWN:()=>un,SPOTLIGHT_ACTIVE_TIME_SEC:()=>xn,SPOTLIGHT_ATTACK_DAMAGE:()=>dn,SPOTLIGHT_ATTACK_RANGE:()=>cn,SPOTLIGHT_ATTACK_SPEED:()=>gn,SPOTLIGHT_BULLET_DAMAGE:()=>An,SPOTLIGHT_BULLET_HIT_RADIUS_PX:()=>Pn,SPOTLIGHT_BULLET_LENGTH_PX:()=>_n,SPOTLIGHT_BULLET_LIFETIME_SEC:()=>Tn,SPOTLIGHT_BULLET_SPEED:()=>Sn,SPOTLIGHT_BULLET_WIDTH_PX:()=>En,SPOTLIGHT_CONE_ANGLE_RAD:()=>mn,SPOTLIGHT_FIRE_RATE_PER_SEC:()=>fn,SPOTLIGHT_MAX_HEALTH:()=>hn,SPOTLIGHT_SETUP_TIME_SEC:()=>pn,SPOTLIGHT_TEARDOWN_TIME_SEC:()=>yn,STARLING_ATTACK_DAMAGE:()=>fe,STARLING_ATTACK_RANGE:()=>me,STARLING_ATTACK_SPEED:()=>Se,STARLING_BLINK_COOLDOWN_SEC:()=>ve,STARLING_BLINK_DISTANCE_PX:()=>De,STARLING_COLLISION_RADIUS_PX:()=>Me,STARLING_COST_PER_ENERGY:()=>Ke,STARLING_DUST_PUSH_FORCE_MULTIPLIER:()=>st,STARLING_DUST_PUSH_RADIUS_PX:()=>it,STARLING_EXPLORATION_CHANGE_INTERVAL:()=>_e,STARLING_LASER_IMPACT_PARTICLES:()=>Re,STARLING_LASER_PARTICLE_LIFETIME:()=>be,STARLING_LASER_PARTICLE_SPEED:()=>we,STARLING_LASER_WIDTH_PX:()=>Le,STARLING_MAX_HEALTH:()=>ye,STARLING_MERGE_COUNT:()=>Bi,STARLING_MERGE_DURATION_SEC:()=>ki,STARLING_MERGE_GATE_MAX_HEALTH:()=>Ui,STARLING_MERGE_GATE_RADIUS_PX:()=>Gi,STARLING_MERGE_HOLD_DURATION_MS:()=>Hi,STARLING_MERGE_HOLD_RADIUS_PX:()=>Wi,STARLING_MOVE_ACCELERATION_PX_PER_SEC:()=>Te,STARLING_MOVE_SPEED:()=>Ae,STARLING_PROJECTILE_HIT_RADIUS_PX:()=>Ce,STARLING_PROJECTILE_MAX_RANGE_PX:()=>Ie,STARLING_PROJECTILE_SPEED:()=>Pe,STARLING_REGEN_RATE_PER_SEC:()=>Fe,STARLING_SPAWN_INTERVAL:()=>Ee,STARLING_SPRITE_ROTATION_OFFSET_RAD:()=>St,STARLING_SPRITE_SCALE_FACTOR:()=>ft,STAR_LAYER_CONFIGS:()=>Ft,STAR_WRAP_SIZE:()=>Lt,STATE_HASH_TICK_INTERVAL:()=>Ns,STELLAR_FORGE_MAX_HEALTH:()=>Ue,STICKY_BOMB_ARM_TIME:()=>Br,STICKY_BOMB_DECELERATION:()=>vr,STICKY_BOMB_DIAGONAL_LASER_DAMAGE:()=>Xr,STICKY_BOMB_DIAGONAL_LASER_WIDTH:()=>Yr,STICKY_BOMB_DISINTEGRATE_PARTICLE_COUNT:()=>Ur,STICKY_BOMB_DISINTEGRATE_PARTICLE_LIFETIME:()=>Wr,STICKY_BOMB_DISINTEGRATE_PARTICLE_SPEED:()=>Hr,STICKY_BOMB_INITIAL_SPEED:()=>Dr,STICKY_BOMB_LASER_ANGLE:()=>$r,STICKY_BOMB_LASER_DURATION:()=>jr,STICKY_BOMB_LASER_RANGE:()=>Kr,STICKY_BOMB_MAX_LIFETIME:()=>kr,STICKY_BOMB_MIN_SPEED:()=>Or,STICKY_BOMB_RADIUS:()=>Gr,STICKY_BOMB_STICK_DISTANCE:()=>Nr,STICKY_BOMB_WIDE_LASER_DAMAGE:()=>zr,STICKY_BOMB_WIDE_LASER_WIDTH:()=>Vr,STRATEGIC_ASTEROID_DISTANCE:()=>Gt,STRATEGIC_ASTEROID_SIZE:()=>kt,SUBSIDIARY_FACTORY_ATTACK_DAMAGE:()=>Ti,SUBSIDIARY_FACTORY_ATTACK_RANGE:()=>Ai,SUBSIDIARY_FACTORY_ATTACK_SPEED:()=>Ei,SUBSIDIARY_FACTORY_COST:()=>Ri,SUBSIDIARY_FACTORY_MAX_HEALTH:()=>Si,SUBSIDIARY_FACTORY_PRODUCTION_INTERVAL:()=>Pi,SUBSIDIARY_FACTORY_RADIUS:()=>_i,SWIPE_ARROW_SIZE:()=>oo,SWIPE_EFFECT_SPEED:()=>eo,SWIRLER_ATTACK_DAMAGE:()=>li,SWIRLER_ATTACK_RANGE:()=>ai,SWIRLER_ATTACK_SPEED:()=>hi,SWIRLER_COST:()=>Mi,SWIRLER_DUST_ORBIT_SPEED_BASE:()=>mi,SWIRLER_DUST_SPEED_MULTIPLIER:()=>fi,SWIRLER_GROWTH_RATE_PER_SEC:()=>ui,SWIRLER_INFLUENCE_RADIUS:()=>di,SWIRLER_INITIAL_RADIUS_MULTIPLIER:()=>gi,SWIRLER_MAX_HEALTH:()=>ri,SWIRLER_MIN_INFLUENCE_RADIUS:()=>yi,SWIRLER_RADIUS:()=>ci,SWIRLER_SHRINK_BASE_RATE:()=>pi,SWIRLER_SHRINK_DAMAGE_MULTIPLIER:()=>xi,TANK_ABILITY_COOLDOWN:()=>er,TANK_ATTACK_DAMAGE:()=>Qn,TANK_ATTACK_RANGE:()=>Jn,TANK_ATTACK_SPEED:()=>Zn,TANK_COLLISION_RADIUS_PX:()=>lr,TANK_DEFENSE:()=>tr,TANK_MAX_HEALTH:()=>qn,TANK_SHIELD_RADIUS:()=>ir,TANK_STUN_DURATION:()=>ar,TANK_WAVE_ANGLE:()=>sr,TANK_WAVE_RANGE:()=>or,TANK_WAVE_SPEED:()=>nr,TANK_WAVE_WIDTH:()=>rr,TAP_EFFECT_MAX_RADIUS:()=>to,TAP_EFFECT_SPEED:()=>Zs,TURRET_DEPLOYER_ABILITY_COOLDOWN:()=>Co,TURRET_DEPLOYER_ATTACK_DAMAGE:()=>Po,TURRET_DEPLOYER_ATTACK_RANGE:()=>_o,TURRET_DEPLOYER_ATTACK_SPEED:()=>Io,TURRET_DEPLOYER_MAX_HEALTH:()=>Eo,TURRET_PROJECTILE_SPEED:()=>Lo,UI_BACKGROUND_COLOR:()=>$s,UNIT_ARRIVAL_THRESHOLD:()=>_s,UNIT_ASTEROID_AVOIDANCE_BUFFER_PX:()=>Rs,UNIT_ASTEROID_AVOIDANCE_LOOKAHEAD_PX:()=>Ms,UNIT_ASTEROID_AVOIDANCE_STRENGTH:()=>ws,UNIT_AVOIDANCE_RANGE_PX:()=>Is,UNIT_AVOIDANCE_STRENGTH:()=>Cs,UNIT_HERO_AVOIDANCE_MULTIPLIER:()=>bs,UNIT_MINION_YIELD_MULTIPLIER:()=>Ls,UNIT_MOVE_SPEED:()=>Ts,UNIT_PATH_DRAW_RADIUS:()=>Os,UNIT_RADIUS_PX:()=>Ps,UNIT_STRUCTURE_STANDOFF_PX:()=>Fs,UNIT_TURN_SPEED_RAD_PER_SEC:()=>Es,VELARIS_ABILITY_COOLDOWN:()=>Fr,VELARIS_ATTACK_DAMAGE:()=>br,VELARIS_ATTACK_RANGE:()=>wr,VELARIS_ATTACK_SPEED:()=>Lr,VELARIS_MAX_HEALTH:()=>Rr,VISIBILITY_PROXIMITY_RANGE:()=>Nt,WARP_GATE_BUTTON_HIT_RADIUS_PX:()=>S,WARP_GATE_BUTTON_OFFSET:()=>f,WARP_GATE_BUTTON_RADIUS:()=>m,WARP_GATE_CANCEL_DECAY_ENERGY_PER_SEC:()=>E,WARP_GATE_CHARGE_TIME:()=>h,WARP_GATE_COMPLETION_WINDOW_SEC:()=>_,WARP_GATE_ENERGY_REQUIRED:()=>c,WARP_GATE_INITIAL_DELAY:()=>d,WARP_GATE_RADIUS:()=>y,WARP_GATE_SHOCKWAVE_MAX_RADIUS_PX:()=>A,WARP_GATE_SHOCKWAVE_PROGRESS_PER_FRAME:()=>T,WARP_GATE_SPIRAL_FORCE_RADIAL:()=>p,WARP_GATE_SPIRAL_FORCE_TANGENT:()=>x,WARP_GATE_SPIRAL_MIN_DISTANCE:()=>u,WARP_GATE_SPIRAL_RADIUS:()=>g});class i{constructor(t,e){this.x=t,this.y=e}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}normalize(){const t=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return 0===t?new i(0,0):new i(this.x/t,this.y/t)}}class s{constructor(t,e,i=1){this.origin=t,this.direction=e,this.intensity=i}intersects(t,e){const s=new i(this.origin.x-t.x,this.origin.y-t.y),o=this.direction.x*this.direction.x+this.direction.y*this.direction.y,n=2*(s.x*this.direction.x+s.y*this.direction.y);return n*n-4*o*(s.x*s.x+s.y*s.y-e*e)>=0}intersectsPolygon(t){for(let e=0;e<t.length;e++){const i=t[e],s=t[(e+1)%t.length];if(null!==this.intersectsLineSegment(i,s))return!0}return!1}getIntersectionDistance(t){let e=null;for(let i=0;i<t.length;i++){const s=t[i],o=t[(i+1)%t.length],n=this.intersectsLineSegment(s,o);null!==n&&(null===e||n<e)&&(e=n)}return e}intersectsLineSegment(t,e){const s=new i(e.x-t.x,e.y-t.y),o=new i(t.x-this.origin.x,t.y-this.origin.y),n=this.direction.x*s.y-this.direction.y*s.x;if(Math.abs(n)<1e-4)return null;const r=(o.x*s.y-o.y*s.x)/n,a=(o.x*this.direction.y-o.y*this.direction.x)/n;return r>=0&&a>=0&&a<=1?r:null}}class o{constructor(t,e=1,i=100,s="normal"){this.position=t,this.intensity=e,this.radius=i,this.type=s}emitLight(t){return new s(this.position,t,this.intensity)}}const n=300,r="#0066FF",a="#FF0000",l="#FFD700",h=6,c=100,d=1,g=200,u=5,p=50,x=20,y=50,m=28,f=30,S=40,A=220,T=.06,E=220,_=20,P=150,I=200,C=30,M=.5,R=25,w=.4,b=20,L=.4,F=35,D=.5,v=40,O=300,N=.6,B=.4,k=.7,G=.3,U=.1,H=1,W=2*H,z=3e3,V=.2,X=W,Y=4*W,$=.8,K=8,j=220,q=.35,J=3,Q=110,Z=1.1,tt=160,et=.9,it=50,st=.5,ot=.08,nt=7.5,rt=1.4,at=35,lt=420,ht=18,ct=.25,dt=.6,gt=2,ut=2,pt=8,xt=.08,yt=.6,mt=3,ft=6,St=Math.PI/2,At=30,Tt=60,Et=0,_t=1,Pt=2,It=5,Ct=1,Mt=2e3,Rt=1e3,wt=3,bt=.5,Lt=4e3,Ft=[{count:200,parallaxFactor:.1,sizeRange:[.5,1]},{count:150,parallaxFactor:.2,sizeRange:[.8,1.5]},{count:100,parallaxFactor:.35,sizeRange:[1,2]},{count:50,parallaxFactor:.5,sizeRange:[1.5,2.5]}],Dt=64,vt=2e3,Ot=1500,Nt=150,Bt=.3,kt=120,Gt=250,Ut=30,Ht=kt,Wt=2e3,zt=150,Vt=Wt/2-zt,Xt=3,Yt=150,$t=100,Kt=2,jt=100,qt=300,Jt=10,Qt=5,Zt=150,te=400,ee=.25,ie=15,se=2,oe=6,ne=50,re=80,ae=300,le=400,he=15,ce=10,de=30,ge=2,ue=5,pe=120,xe=2,ye=50,me=120,fe=5,Se=2,Ae=50,Te=120,Ee=10,_e=5,Pe=320,Ie=140,Ce=8,Me=3,Re=3,we=30,be=.3,Le=2,Fe=2,De=80,ve=6,Oe=.75,Ne=.45,Be=Math.PI,ke=2,Ge=.35,Ue=1e3,He=10,We=.8,ze=1.2,Ve=250,Xe=300,Ye=150,$e=100,Ke=50,je=200,qe=350,Je=12,Qe=6,Ze=12,ti=30,ei=200,ii=175,si=12,oi=4,ni=30,ri=250,ai=0,li=0,hi=0,ci=35,di=400,gi=.5,ui=30,pi=20,xi=.5,yi=50,mi=80,fi=2.5,Si=500,Ai=0,Ti=0,Ei=0,_i=40,Pi=15,Ii=500,Ci=250,Mi=750,Ri=1e3,wi=300,bi=50,Li=1e3,Fi=1e3,Di="strafe-upgrade",vi="regen-upgrade",Oi=300,Ni=3e3,Bi=10,ki=10,Gi=18,Ui=80,Hi=2e3,Wi=30,zi=2,Vi=1,Xi=3,Yi=5,$i=8,Ki=6,ji=8,qi=.7,Ji=1.5,Qi=1.2,Zi=220,ts=.6,es=40,is=350,ss=140,os=Math.PI/4,ns=8,rs=28,as=100,ls=22,hs=140,cs=5,ds=.05,gs=2,us=100,ps=150,xs=.5,ys=150,ms=250,fs=5,Ss=50,As=.3,Ts=100,Es=8,_s=5,Ps=10,Is=40,Cs=.7,Ms=140,Rs=12,ws=1.1,bs=.3,Ls=1.4,Fs=4,Ds=2,vs=50,Os=50,Ns=30,Bs=15,ks=20,Gs=1e3,Us=2,Hs=5,Ws=15,zs=500,Vs=1,Xs=10*Math.PI/180,Ys=5,$s="#000011",Ks=10,js=50,qs=.2,Js=2,Qs=10,Zs=.05,to=40,eo=.08,io=48,so=.12,oo=15,no=120,ro=250,ao=8,lo=3,ho=8,co=25,go=5,uo=3,po=100,xo=200,yo=5,mo=1.5,fo=15,So=300,Ao=150,To=10,Eo=90,_o=180,Po=6,Io=2,Co=12,Mo=150,Ro=300,wo=12,bo=2,Lo=400,Fo=.1,Do=.08,vo=28,Oo=40,No=140,Bo=0,ko=0,Go=0,Uo=5,Ho=500,Wo=30,zo=2,Vo=200,Xo=80,Yo=100,$o=35,Ko=1.5,jo=6,qo=150,Jo=50,Qo=8,Zo=.4,tn=70,en=150,sn=20,on=1,nn=8,rn=30,an=600,ln=.1,hn=95,cn=0,dn=0,gn=1,un=12,pn=1,xn=4,yn=5,mn=5*Math.PI/180,fn=8,Sn=600,An=4,Tn=1.2,En=1.5,_n=10,Pn=6,In=120,Cn=450,Mn=40,Rn=.5,wn=0,bn=150*Math.PI/180,Ln=80,Fn=.5,Dn=300,vn=110,On=0,Nn=0,Bn=0,kn=10,Gn=350,Un=.02,Hn=.5,Wn=2,zn=400,Vn=500,Xn=50,Yn=.01,$n=120,Kn=200,jn=.5,qn=300,Jn=0,Qn=0,Zn=0,tr=50,er=12,ir=60,sr=Math.PI/2,or=400,nr=150,rr=40,ar=2,lr=20,hr=105,cr=250,dr=6,gr=2,ur=0,pr=400,xr=150,yr=50,mr=2,fr=.7,Sr=10,Ar=50,Tr=100,Er=30*Math.PI/180,_r=12,Pr=350,Ir=8,Cr=1,Mr=15,Rr=90,wr=200,br=15,Lr=1.5,Fr=0,Dr=500,vr=200,Or=20,Nr=25,Br=.5,kr=5,Gr=12,Ur=20,Hr=150,Wr=1,zr=40,Vr=20,Xr=25,Yr=12,$r=45*Math.PI/180,Kr=500,jr=.15;var qr,Jr;!function(t){t.ECONOMIC="economic",t.DEFENSIVE="defensive",t.AGGRESSIVE="aggressive",t.WAVES="waves"}(qr||(qr={}));class Qr{constructor(t,e){this.position=t,this.owner=e,this.health=$t,this.maxHealth=$t,this.efficiency=1,this.isSelected=!1,this.linkedStructure=null,this.targetPosition=null,this.velocity=new i(0,0),this.reflectionAngle=0,this.closestSunDistance=1/0,this.moveOrder=0,this.MAX_SPEED=50,this.ACCELERATION=25,this.DECELERATION=50,this.ARRIVAL_THRESHOLD=2,this.SLOW_RADIUS_PX=60,this.AVOIDANCE_BLEND_FACTOR=.6,this.ROTATION_SPEED_RAD_PER_SEC=Math.PI,this.ROTATION_SNAP_THRESHOLD_RAD=.01}isPathClear(t,e=[]){const o=new i(t.x-this.position.x,t.y-this.position.y).normalize(),n=new s(this.position,o),r=this.position.distanceTo(t);for(const t of e){const e=n.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<r)return!1}return!0}isCircleBlockingRay(t,e,i,s){const o=i.x-this.position.x,n=i.y-this.position.y,r=o*t.x+n*t.y;if(r<=0||r>=e)return!1;const a=this.position.x+t.x*r,l=this.position.y+t.y*r,h=i.x-a,c=i.y-l;return h*h+c*c<=s*s}hasLineOfSightToLight(t,e=[]){for(const i of t)if(this.isPathClear(i.position,e))return!0;return!1}hasLineOfSightToForge(t,e=[],i=[]){return this.hasLineOfSightToStructure(t,e,i)}hasLineOfSightToStructure(t,e=[],o=[]){const n=new i(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),r=this.position.distanceTo(t.position),a=new s(this.position,n);for(const t of e){const e=a.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<r)return!1}for(const e of o){for(const i of e.buildings)if(i!==t&&this.isCircleBlockingRay(n,r,i.position,i.radius))return!1;if(e.stellarForge&&e.stellarForge!==t&&this.isCircleBlockingRay(n,r,e.stellarForge.position,e.stellarForge.radius))return!1}return!0}getClosestVisibleSun(t,e=[]){let i=null,s=1/0;for(const o of t)if(this.isPathClear(o.position,e)){const t=this.position.distanceTo(o.position);t<s&&(i=o,s=t)}return i}getClosestSun(t){let e=null,i=1/0;for(const s of t){const t=this.position.distanceTo(s.position);t<i&&(e=s,i=t)}return e}generateEnergy(t){return this.getEnergyRatePerSec()*t}getEnergyRatePerSec(){const t=Math.max(1,Us-this.closestSunDistance/Gs);return 10*this.efficiency*t}setTarget(t){this.targetPosition=t}setLinkedStructure(t){this.linkedStructure=t}getLinkedStructure(t){var e;return null!==(e=this.linkedStructure)&&void 0!==e?e:t}updateReflectionAngle(t,e,s=[],o){if(!t)return;const n=this.getClosestVisibleSun(e,s);if(!n)return void(this.closestSunDistance=1/0);this.closestSunDistance=this.position.distanceTo(n.position);const r=new i(n.position.x-this.position.x,n.position.y-this.position.y).normalize(),a=new i(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),l=r.x+a.x,h=r.y+a.y,c=(Math.sqrt(l*l+h*h)>0?Math.atan2(h,l):Math.atan2(r.y,r.x))+Math.PI/2,d=this.getShortestAngleDelta(this.reflectionAngle,c),g=this.ROTATION_SPEED_RAD_PER_SEC*o;Math.abs(d)<=Math.max(this.ROTATION_SNAP_THRESHOLD_RAD,g)?this.reflectionAngle=c:this.reflectionAngle+=Math.sign(d)*g}getShortestAngleDelta(t,e){let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(t,e=null){if(!this.targetPosition)return;const s=this.targetPosition.x-this.position.x,o=this.targetPosition.y-this.position.y,n=Math.sqrt(s*s+o*o);if(n<this.ARRIVAL_THRESHOLD)return this.position=this.targetPosition,this.targetPosition=null,void(this.velocity=new i(0,0));let r=s/n,a=o/n;if(e){const t=this.calculateObstacleAvoidance(e);if(t){r+=t.x*this.AVOIDANCE_BLEND_FACTOR,a+=t.y*this.AVOIDANCE_BLEND_FACTOR;const e=Math.sqrt(r*r+a*a);e>0&&(r/=e,a/=e)}}if(n<=this.SLOW_RADIUS_PX){const t=Math.max(0,n/this.SLOW_RADIUS_PX),e=this.MAX_SPEED*t;this.velocity.x=r*e,this.velocity.y=a*e}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(n>e*e/(2*this.DECELERATION)&&e<this.MAX_SPEED)this.velocity.x+=r*this.ACCELERATION*t,this.velocity.y+=a*this.ACCELERATION*t;else if(e>.1){const i=this.DECELERATION*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0;const i=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));i>this.MAX_SPEED&&(this.velocity.x=this.velocity.x/i*this.MAX_SPEED,this.velocity.y=this.velocity.y/i*this.MAX_SPEED)}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let e=0,s=0,o=0;const n=60;for(const i of t.suns){const t=this.position.x-i.position.x,r=this.position.y-i.position.y,a=Math.sqrt(t*t+r*r),l=i.radius+30;if(a<l+n){const i=(l+n-a)/n;e+=t/a*i,s+=r/a*i,o++}}for(const i of t.players){for(const t of i.solarMirrors){if(t===this)continue;const i=this.position.x-t.position.x,r=this.position.y-t.position.y,a=Math.sqrt(i*i+r*r),l=40;if(a<l+n&&a>0){const t=(l+n-a)/n;e+=i/a*t,s+=r/a*t,o++}}if(i.stellarForge){const t=i.stellarForge,r=this.position.x-t.position.x,a=this.position.y-t.position.y,l=Math.sqrt(r*r+a*a),h=t.radius+30;if(l<h+n){const t=(h+n-l)/n;e+=r/l*t,s+=a/l*t,o++}}}if(o>0){const t=Math.sqrt(e*e+s*s);if(t>0)return new i(e/t,s/t)}return null}takeDamage(t){this.health-=t}containsPoint(t){return this.position.distanceTo(t)<ks}}class Zr{constructor(t,e,s){this.position=t,this.glowState=Et,this.glowTransition=0,this.targetGlowState=Et,this.lastMovementTime=0,this.impactColor=null,this.impactBlend=0,this.impactTargetBlend=0,this.impactHoldTimeSec=0,this.baseColor=Zr.generateBaseColor(s),this.currentColor=this.baseColor,this.velocity=e||new i(2*(Math.random()-.5),2*(Math.random()-.5))}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>It)this.targetGlowState=Pt,this.lastMovementTime=Date.now();else if(e>Ct)this.glowState<_t&&(this.targetGlowState=_t),this.lastMovementTime=Date.now();else{const t=Date.now()-this.lastMovementTime;t>Mt?this.targetGlowState=Et:t>Rt&&this.glowState===Pt&&(this.targetGlowState=_t)}const i=this.glowState<this.targetGlowState?wt:bt;(this.glowState<this.targetGlowState||this.glowState>this.targetGlowState)&&(this.glowTransition+=t*i,this.glowTransition>=1&&(this.glowState=this.targetGlowState,this.glowTransition=0)),this.updateImpactBlend(t),this.velocity.x*=.98,this.velocity.y*=.98;const s=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(s<V)if(0===s)this.velocity.x=V,this.velocity.y=0;else{const t=V/s;this.velocity.x*=t,this.velocity.y*=t}}applyForce(t){this.velocity.x+=t.x,this.velocity.y+=t.y}applyImpactColor(t,e){!t||e<=0||(this.impactColor=t,this.impactTargetBlend=Math.max(this.impactTargetBlend,Math.min(1,e)),this.impactHoldTimeSec=ot)}updateColor(t,e){let i=this.baseColor;t&&e>0&&(i=this.blendColors(this.baseColor,t,e)),this.impactColor&&this.impactBlend>0?this.currentColor=this.blendColors(i,this.impactColor,this.impactBlend):this.currentColor=i}blendColors(t,e,i){if(!(t&&e&&t.startsWith("#")&&e.startsWith("#")))return this.baseColor;const s=parseInt(t.slice(1),16),o=parseInt(e.slice(1),16);if(isNaN(s)||isNaN(o))return this.baseColor;const n=s>>16&255,r=s>>8&255,a=255&s,l=o>>16&255,h=o>>8&255,c=255&o;return`#${(Math.round(n+(l-n)*i)<<16|Math.round(r+(h-r)*i)<<8|Math.round(a+(c-a)*i)).toString(16).padStart(6,"0")}`}updateImpactBlend(t){this.impactHoldTimeSec>0&&(this.impactHoldTimeSec=Math.max(0,this.impactHoldTimeSec-t));const e=this.impactHoldTimeSec>0?this.impactTargetBlend:0,i=(e>this.impactBlend?nt:rt)*t;this.impactBlend<e?this.impactBlend=Math.min(e,this.impactBlend+i):this.impactBlend>e&&(this.impactBlend=Math.max(e,this.impactBlend-i)),0===e&&0===this.impactBlend&&(this.impactTargetBlend=0,this.impactColor=null)}static generateBaseColor(t){if(t&&t.neutral.length>0){const e=Math.random()>.7&&t.accent.length>0?t.accent:t.neutral;return e[Math.floor(Math.random()*e.length)]}const e=85+110*Math.random();let i=e,s=e,o=e;const n=Math.random();n<.18?(i=e-8,s=e-4,o=e+14):n<.28&&(i=e+10,s=e-10,o=e+12);const r=t=>Math.max(0,Math.min(255,Math.round(t)));return`#${(r(i)<<16|r(s)<<8|r(o)).toString(16).padStart(6,"0")}`}}class ta{constructor(t){this.position=t,this.phase="idle",this.phaseTimer=0}start(){this.phase="suck",this.phaseTimer=We}update(t){"idle"!==this.phase&&(this.phaseTimer-=t,this.phaseTimer<=0&&("suck"===this.phase?(this.phase="wave",this.phaseTimer=ze):"wave"===this.phase&&(this.phase="idle",this.phaseTimer=0)))}isActive(){return"idle"!==this.phase}getPhaseProgress(){if("idle"===this.phase)return 0;const t="suck"===this.phase?We:ze;return 1-this.phaseTimer/t}}class ea{constructor(t,e){this.position=t,this.rotation=0,this.lifetime=0,this.maxLifetime=gs,this.velocity=e,this.rotationSpeed=10*(Math.random()-.5)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=.95,this.velocity.y*=.95,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}applyCollision(t){this.velocity.x+=t.x*As,this.velocity.y+=t.y*As}}class ia{constructor(t,e){this.position=t,this.angle=e,this.lifetime=0,this.maxLifetime=ds}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class sa{constructor(t,e){this.position=t,this.lifetime=0,this.maxLifetime=xs,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.y+=100*t,this.velocity.x*=.98,this.velocity.y*=.98,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class oa{constructor(t,e,s,o=Ys){this.position=t,this.owner=s,this.damage=o,this.lifetime=0,this.maxLifetime=Vs,this.maxRange=1/0,this.hitRadiusPx=10,this.velocity=e,this.startPosition=new i(t.x,t.y)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime||this.startPosition.distanceTo(this.position)>=this.maxRange}checkHit(t){return this.position.distanceTo(t.position)<this.hitRadiusPx}}class na{constructor(t,e,i,s,o=Le){this.startPos=t,this.endPos=e,this.owner=i,this.damage=s,this.widthPx=o,this.lifetime=0,this.maxLifetime=.1}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}class ra{constructor(t,e,i,s){this.position=t,this.velocity=e,this.maxLifetime=i,this.faction=s,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class aa{constructor(t,e,i,s,o=2){this.position=t,this.velocity=e,this.maxLifetime=i,this.color=s,this.size=o,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t,this.velocity.x*=.95,this.velocity.y*=.95}getOpacity(){return Math.max(0,1-this.lifetime/this.maxLifetime)}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class la{constructor(t,e,s,o,n){this.lifetime=0,this.spriteFragment=null,this.opacity=1,this.position=new i(t.x,t.y),this.velocity=e,this.rotation=s,this.rotationSpeed=4*(Math.random()-.5),this.spriteFragment=o,this.fadeStartTime=n}update(t){if(this.lifetime+=t,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=la.VELOCITY_DAMPING,this.velocity.y*=la.VELOCITY_DAMPING,this.lifetime<la.INITIAL_FADE_DURATION)this.opacity=1-la.OPACITY_DROP*(this.lifetime/la.INITIAL_FADE_DURATION);else if(this.lifetime<this.fadeStartTime)this.opacity=la.STABLE_OPACITY;else{const t=(this.lifetime-this.fadeStartTime)/la.FINAL_FADE_DURATION;this.opacity=Math.max(0,la.STABLE_OPACITY*(1-t))}}shouldDespawn(){return this.lifetime>=this.fadeStartTime+la.FINAL_FADE_DURATION}}la.VELOCITY_DAMPING=.98,la.INITIAL_FADE_DURATION=.5,la.OPACITY_DROP=.7,la.STABLE_OPACITY=.3,la.FINAL_FADE_DURATION=1;class ha{constructor(t,e){this.position=t,this.owner=e,this.health=Ue,this.maxHealth=Ue,this.isReceivingLight=!1,this.incomingLightPerSec=0,this.unitQueue=[],this.heroProductionUnitType=null,this.heroProductionRemainingSec=0,this.heroProductionDurationSec=0,this.isSelected=!1,this.targetPosition=null,this.velocity=new i(0,0),this.baseMaxSpeed=50,this.acceleration=30,this.deceleration=50,this.slowRadiusPx=80,this.AVOIDANCE_BLEND_FACTOR=.6,this.radius=40,this.crunchTimer=0,this.currentCrunch=null,this.pendingEnergy=0,this.minionPath=[],this.moveOrder=0,this.rotation=0,this.crunchTimer=Math.random()*He}setMinionPath(t){this.minionPath=t.map(t=>new i(t.x,t.y))}initializeDefaultPath(t){this.minionPath=[new i(t.x,t.y)]}canProduceUnits(){return this.isReceivingLight&&this.health>0}produceUnit(t,e,i){return!(this.health<=0||i<e||(this.unitQueue.push(t),0))}enqueueHeroUnit(t){this.unitQueue.push(t)}startHeroProductionIfIdle(){if(this.heroProductionUnitType||0===this.unitQueue.length)return;const t=this.unitQueue.shift();t&&(this.heroProductionUnitType=t,this.heroProductionDurationSec=ns,this.heroProductionRemainingSec=ns)}advanceHeroProduction(t){if(this.startHeroProductionIfIdle(),!this.heroProductionUnitType)return null;if(!this.canProduceUnits())return null;if(this.heroProductionRemainingSec=Math.max(0,this.heroProductionRemainingSec-t),this.heroProductionRemainingSec>0)return null;const e=this.heroProductionUnitType;return this.heroProductionUnitType=null,this.heroProductionDurationSec=0,this.heroProductionRemainingSec=0,e}updateLightStatus(t,e,i=[],s=[]){this.isReceivingLight=!1,this.incomingLightPerSec=0;for(const o of t)o.getLinkedStructure(this)===this&&o.hasLineOfSightToLight(e,i)&&o.hasLineOfSightToForge(this,i,s)&&(this.isReceivingLight=!0,this.incomingLightPerSec+=o.getEnergyRatePerSec())}getCurrentMaxSpeed(){if(!this.isReceivingLight||this.incomingLightPerSec<=0)return 0;const t=Math.min(2,this.incomingLightPerSec/100);return this.baseMaxSpeed*t}update(t,e=null){this.health>0&&this.isReceivingLight&&(this.crunchTimer-=t),this.currentCrunch&&(this.currentCrunch.update(t),this.currentCrunch.isActive()||(this.currentCrunch=null));const i=this.getCurrentMaxSpeed();if(this.targetPosition&&0!==i){const s=this.targetPosition.x-this.position.x,o=this.targetPosition.y-this.position.y,n=Math.sqrt(Math.pow(s,2)+Math.pow(o,2));if(n<5)this.position.x=this.targetPosition.x,this.position.y=this.targetPosition.y,this.velocity.x=0,this.velocity.y=0,this.targetPosition=null;else{let r=s/n,a=o/n;if(e){const t=this.calculateObstacleAvoidance(e);if(t){r+=t.x*this.AVOIDANCE_BLEND_FACTOR,a+=t.y*this.AVOIDANCE_BLEND_FACTOR;const e=Math.sqrt(r*r+a*a);e>0&&(r/=e,a/=e)}}if(n<=this.slowRadiusPx){const t=i*Math.max(0,n/this.slowRadiusPx);this.velocity.x=r*t,this.velocity.y=a*t}else{this.velocity.x+=r*this.acceleration*t,this.velocity.y+=a*this.acceleration*t;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));e>i&&(this.velocity.x=this.velocity.x/e*i,this.velocity.y=this.velocity.y/e*i)}}}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>.1){const i=this.deceleration*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let e=0,s=0,o=0;const n=80;for(const i of t.suns){const t=this.position.x-i.position.x,r=this.position.y-i.position.y,a=Math.sqrt(t*t+r*r),l=i.radius+this.radius+10;if(a<l+n){const i=(l+n-a)/n;e+=t/a*i,s+=r/a*i,o++}}for(const i of t.players){if(i.stellarForge&&i.stellarForge!==this){const t=i.stellarForge,r=this.position.x-t.position.x,a=this.position.y-t.position.y,l=Math.sqrt(r*r+a*a),h=this.radius+t.radius+10;if(l<h+n&&l>0){const t=(h+n-l)/n;e+=r/l*t,s+=a/l*t,o++}}for(const t of i.solarMirrors){const i=this.position.x-t.position.x,r=this.position.y-t.position.y,a=Math.sqrt(i*i+r*r),l=this.radius+30;if(a<l+n){const t=(l+n-a)/n;e+=i/a*t,s+=r/a*t,o++}}}if(o>0){const t=Math.sqrt(e*e+s*s);if(t>0)return new i(e/t,s/t)}return null}shouldCrunch(){if(this.crunchTimer<=0&&this.health>0&&this.isReceivingLight){this.crunchTimer=He,this.currentCrunch=new ta(new i(this.position.x,this.position.y)),this.currentCrunch.start(),this.rotation+=Math.PI/3,this.rotation>=2*Math.PI&&(this.rotation-=2*Math.PI);const t=this.pendingEnergy;return this.pendingEnergy=0,t}return 0}addPendingEnergy(t){this.pendingEnergy+=t}getCurrentCrunch(){return this.currentCrunch}setTarget(t){this.targetPosition=new i(t.x,t.y)}toggleSelection(){this.isSelected=!this.isSelected}containsPoint(t){return this.position.distanceTo(t)<=this.radius}}class ca{constructor(t,e,i,s,o,n,r){this.position=t,this.owner=e,this.radius=s,this.attackRange=o,this.attackDamage=n,this.attackSpeed=r,this.attackCooldown=0,this.target=null,this.buildProgress=0,this.accumulatedEnergy=0,this.energyRequired=0,this.isComplete=!1,this.isSelected=!1,this.health=i,this.maxHealth=i}update(t,e,i,s=[],o=[],n=Vt){this.attackCooldown>0&&(this.attackCooldown-=t),this.isComplete&&(this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0)&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target,e,o,s,n),this.attackCooldown=1/this.attackSpeed)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t,e=[],i=[],s=[],o=Vt){"health"in t&&(t.health-=this.attackDamage)}takeDamage(t){this.health-=t}isDestroyed(){return this.health<=0}addBuildProgress(t){this.isComplete||(this.buildProgress+=t,this.buildProgress>=1&&(this.buildProgress=1,this.isComplete=!0))}addEnergy(t){this.isComplete||(this.accumulatedEnergy+=t,this.energyRequired>0&&(this.buildProgress=Math.min(1,this.accumulatedEnergy/this.energyRequired),this.buildProgress>=1&&(this.isComplete=!0)))}containsPoint(t){return this.position.distanceTo(t)<=this.radius}canShoot(){return this.attackRange>0&&this.attackDamage>0}}class da extends ca{constructor(t,e){super(t,e,je,ti,qe,Je,Qe),this.lastShotEffects={},this.lastShotLasers=[],this.energyRequired=Ii}attack(t,e=[],s=[],o=[],n=Vt){const r=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.sqrt(r*r+a*a);if(l<=0)return;const h=r/l,c=a/l;let d=this.getRayBoundaryDistance(this.position.x,this.position.y,h,c,n),g=null;for(const t of s){const e=this.getStructureRadius(t),i=this.getRayCircleHitDistance(this.position.x,this.position.y,h,c,t.position.x,t.position.y,e);null!==i&&i<d&&(d=i,g=t)}for(const t of o){const e=this.getRayCircleHitDistance(this.position.x,this.position.y,h,c,t.position.x,t.position.y,t.size);null!==e&&e<d&&(d=e,g=null)}const u=new i(this.position.x+h*d,this.position.y+c*d),p=new na(new i(this.position.x,this.position.y),new i(u.x,u.y),this.owner,this.attackDamage,Ze);this.lastShotLasers.push(p);const x=.5*Ze;for(const t of e){if(!("collisionRadiusPx"in t))continue;const e=(t.position.x-this.position.x)*h+(t.position.y-this.position.y)*c;if(e<0||e>d)continue;const i=this.position.x+h*e,s=this.position.y+c*e,o=t.position.x-i,n=t.position.y-s,r=o*o+n*n,a=x+t.collisionRadiusPx;r<=a*a&&t.takeDamage(this.attackDamage)}g&&"owner"in g&&g.owner!==this.owner&&"health"in g&&(g.health-=this.attackDamage);const y=Math.atan2(a,r);this.lastShotEffects.muzzleFlash=new ia(new i(this.position.x,this.position.y),y);const m=y+Math.PI/2+.5*(Math.random()-.5),f=us+Math.random()*(ps-us);this.lastShotEffects.casing=new ea(new i(this.position.x,this.position.y),new i(Math.cos(m)*f,Math.sin(m)*f));const S=y+Math.PI+1*(Math.random()-.5),A=ys+Math.random()*(ms-ys);this.lastShotEffects.bouncingBullet=new sa(new i(t.position.x,t.position.y),new i(Math.cos(S)*A,Math.sin(S)*A))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}getAndClearLastShotLasers(){const t=this.lastShotLasers;return this.lastShotLasers=[],t}getRayBoundaryDistance(t,e,i,s,o){let n=1/0;if(Math.abs(i)>.001){const e=(o-t)/i;e>0&&e<n&&(n=e);const s=(-o-t)/i;s>0&&s<n&&(n=s)}if(Math.abs(s)>.001){const t=(o-e)/s;t>0&&t<n&&(n=t);const i=(-o-e)/s;i>0&&i<n&&(n=i)}return n===1/0?0:n}getRayCircleHitDistance(t,e,i,s,o,n,r){const a=(o-t)*i+(n-e)*s;if(a<0)return null;const l=o-(t+i*a),h=n-(e+s*a),c=l*l+h*h,d=r*r;if(c>d)return null;const g=Math.sqrt(d-c),u=a-g;return u>=0?u:a+g}getStructureRadius(t){return"radius"in t?t.radius:ks}}class ga extends ca{constructor(t,e){super(t,e,ei,ni,ii,si,oi),this.lastShotEffects={},this.energyRequired=Ci}attack(t,e=[],s=[],o=[],n=Vt){super.attack(t);const r=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.atan2(a,r);this.lastShotEffects.muzzleFlash=new ia(new i(this.position.x,this.position.y),l);const h=l+Math.PI/2+.5*(Math.random()-.5),c=us+Math.random()*(ps-us);this.lastShotEffects.casing=new ea(new i(this.position.x,this.position.y),new i(Math.cos(h)*c,Math.sin(h)*c));const d=l+Math.PI+1*(Math.random()-.5),g=ys+Math.random()*(ms-ys);this.lastShotEffects.bouncingBullet=new sa(new i(t.position.x,t.position.y),new i(Math.cos(d)*g,Math.sin(d)*g))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}}class ua extends ca{constructor(t,e){super(t,e,ri,ci,ai,li,hi),this.energyRequired=Mi;const i=di*gi;this.currentInfluenceRadius=i,this.targetInfluenceRadius=i}update(t,e,i,s=[]){if(super.update(t,e,i,s),this.isComplete){this.targetInfluenceRadius<di&&(this.targetInfluenceRadius=Math.min(this.targetInfluenceRadius+ui*t,di));const e=this.targetInfluenceRadius-this.currentInfluenceRadius;Math.abs(e)>.1?this.currentInfluenceRadius+=.2*e:this.currentInfluenceRadius=this.targetInfluenceRadius}}applyDustSwirl(t,e){if(this.isComplete)for(const e of t){const t=e.position.x-this.position.x,i=e.position.y-this.position.y,s=Math.sqrt(t*t+i*i);if(s>this.currentInfluenceRadius||s<1)continue;const o=i/s,n=-t/s,r=s/this.currentInfluenceRadius,a=mi*(1+fi*(1-r));e.velocity.x=o*a,e.velocity.y=n*a}}absorbProjectile(t){if(!this.isComplete)return!1;const e=t.position.x-this.position.x,i=t.position.y-this.position.y;if(Math.sqrt(e*e+i*i)>this.currentInfluenceRadius)return!1;let s=5;"damage"in t&&"number"==typeof t.damage?s=t.damage:"GraveProjectile"===t.constructor.name?s=ie:"InfluenceBallProjectile"===t.constructor.name&&(s=10);const o=pi+s*xi;return this.targetInfluenceRadius=Math.max(this.targetInfluenceRadius-o,yi),!0}deflectProjectile(t){return this.absorbProjectile(t)}}class pa extends ca{constructor(t,e){super(t,e,Si,_i,Ai,Ti,Ei),this.productionTimer=0,this.completedProduction=null,this.productionQueue=[],this.currentProduction=null,this.productionProgress=0,this.energyRequired=Ri}update(t,e,i){if(this.isComplete&&(!this.currentProduction&&this.productionQueue.length>0&&(this.currentProduction=this.productionQueue.shift()||null,this.productionProgress=0),this.currentProduction)){const e=this.getProductionTime(this.currentProduction);this.addProductionProgress(t/e)}}enqueueProduction(t){this.productionQueue.push(t)}getCompletedProduction(){const t=this.completedProduction;return t&&(this.completedProduction=null),t}addProductionProgress(t){this.currentProduction&&(this.productionProgress+=t,this.productionProgress>=1&&(this.productionProgress=0,this.completedProduction=this.currentProduction,this.currentProduction=null))}getProductionTime(t){return"solar-mirror"===t?cs:Pi}canUpgradeStrafe(){return this.isComplete&&!this.owner.hasStrafeUpgrade}canQueueStrafeUpgrade(){return this.canUpgradeStrafe()&&!this.hasProductionItem(Di)}canUpgradeRegen(){return this.isComplete&&!this.owner.hasRegenUpgrade}canQueueRegenUpgrade(){return this.canUpgradeRegen()&&!this.hasProductionItem(vi)}hasProductionItem(t){return this.currentProduction===t||this.productionQueue.includes(t)}upgradeStrafe(){return!!this.canUpgradeStrafe()&&(this.owner.hasStrafeUpgrade=!0,!0)}upgradeRegen(){return!!this.canUpgradeRegen()&&(this.owner.hasRegenUpgrade=!0,!0)}}!function(t){t.RADIANT="Radiant",t.AURUM="Aurum",t.VELARIS="Velaris"}(Jr||(Jr={}));class xa{constructor(t,e){this.name=t,this.faction=e,this.energy=100,this.stellarForge=null,this.solarMirrors=[],this.units=[],this.buildings=[],this.isAi=!1,this.aiNextMirrorCommandSec=0,this.aiNextDefenseCommandSec=0,this.aiNextHeroCommandSec=0,this.aiNextStructureCommandSec=0,this.aiNextMirrorPurchaseCommandSec=0,this.aiStrategy=qr.ECONOMIC,this.hasStrafeUpgrade=!1,this.hasRegenUpgrade=!1,this.hasBlinkUpgrade=!1,this.unitsCreated=0,this.unitsLost=0,this.energyGathered=0}isDefeated(){return null===this.stellarForge||this.stellarForge.health<=0}addEnergy(t){this.energy+=t,this.energyGathered+=t}spendEnergy(t){return this.energy>=t&&(this.energy-=t,!0)}}class ya{constructor(t,e,s,o,n,r,a=5,l=Ps){this.position=t,this.owner=e,this.attackRange=o,this.attackDamage=n,this.attackSpeed=r,this.abilityCooldownTime=a,this.attackCooldown=0,this.abilityCooldown=0,this.target=null,this.manualTarget=null,this.rallyPoint=null,this.lastAbilityEffects=[],this.isHero=!1,this.moveOrder=0,this.isSelected=!1,this.rotation=0,this.velocity=new i(0,0),this.waypoints=[],this.currentWaypointIndex=0,this.stunDuration=0,this.health=s,this.maxHealth=s,this.collisionRadiusPx=l}setManualTarget(t,e){this.manualTarget=t,this.target=t,this.clearMovementOrders(),e&&(this.rallyPoint=new i(e.x,e.y))}clearManualTarget(){this.manualTarget=null,this.target=null}getManualTarget(){return this.manualTarget}clearMovementOrders(){this.rallyPoint=null,this.waypoints=[],this.currentWaypointIndex=0,this.velocity.x=0,this.velocity.y=0}update(t,e,i,s=[]){if(this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.stunDuration>0)this.stunDuration-=t;else if(this.moveTowardRallyPoint(t,Ts,i,s),this.manualTarget&&this.isTargetDead(this.manualTarget)&&(this.manualTarget=null,this.target=null,this.clearMovementOrders()),this.target&&!this.isTargetDead(this.target)||(this.manualTarget?this.target=this.manualTarget:this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed),this.target&&!this.isTargetDead(this.target)&&this.position.distanceTo(this.target.position)<=this.attackRange){const e=this.target.position.x-this.position.x,i=this.target.position.y-this.position.y,s=Math.atan2(i,e)+Math.PI/2,o=this.getShortestAngleDelta(this.rotation,s),n=Es*t;Math.abs(o)<=n?this.rotation=s:this.rotation+=Math.sign(o)*n,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}setPath(t){this.waypoints=t.map(t=>new i(t.x,t.y)),this.currentWaypointIndex=0,this.waypoints.length>0&&(this.rallyPoint=this.waypoints[0])}getStructureStandoffPoint(t,e){const s=this.position.x-t.x,o=this.position.y-t.y,n=Math.sqrt(s*s+o*o),r=e+this.collisionRadiusPx+Fs;if(n<=0)return new i(t.x+r,t.y);const a=r/n;return new i(t.x+s*a,t.y+o*a)}moveTowardRallyPoint(t,e,i,s=[]){if(!this.rallyPoint)return this.velocity.x=0,void(this.velocity.y=0);const o=this.rallyPoint.x-this.position.x,n=this.rallyPoint.y-this.position.y,r=Math.sqrt(o*o+n*n);if(r<=_s)return this.waypoints.length>0&&this.currentWaypointIndex<this.waypoints.length-1?(this.currentWaypointIndex++,void(this.rallyPoint=this.waypoints[this.currentWaypointIndex])):(this.rallyPoint=null,this.waypoints=[],this.currentWaypointIndex=0,this.velocity.x=0,void(this.velocity.y=0));let a=o/r,l=n/r;const h=Is,c=h*h;let d=0,g=0;for(let t=0;t<i.length;t++){const e=i[t];if(e===this||e.isDead())continue;const s=this.position.x-e.position.x,o=this.position.y-e.position.y,n=s*s+o*o;if(n>0&&n<c){const t=Math.sqrt(n);let i=(h-t)/h;this.isHero&&!e.isHero?i*=bs:!this.isHero&&e.isHero&&(i*=Ls),d+=s/t*i,g+=o/t*i}}const u=Math.sqrt(d*d+g*g);u>0&&(d/=u,g/=u);let p=0,x=0;const y=Ms,m=Rs;for(let t=0;t<s.length;t++){const e=s[t],i=e.position.x-this.position.x,o=e.position.y-this.position.y,n=i*a+o*l,r=e.size+this.collisionRadiusPx+m,h=r*r;if(n>0&&n<y){const t=i-a*n,e=o-l*n,s=t*t+e*e;if(s<h){const t=a*o-l*i,e=t>0?l:-l,n=t>0?-a:a,h=(r-Math.sqrt(s))/r;p+=e*h,x+=n*h}}const c=this.position.x-e.position.x,d=this.position.y-e.position.y,g=c*c+d*d;if(g<h){const t=Math.sqrt(g);if(t>0){const e=(r-t)/r;p+=c/t*e,x+=d/t*e}}}const f=Math.sqrt(p*p+x*x);f>0&&(p/=f,x/=f),a+=d*Cs,l+=g*Cs,a+=p*ws,l+=x*ws;const S=Math.sqrt(a*a+l*l);if(S>0&&(a/=S,l/=S),S>0){const e=Math.atan2(l,a)+Math.PI/2,i=this.getShortestAngleDelta(this.rotation,e),s=Es*t;Math.abs(i)<=s?this.rotation=e:this.rotation+=Math.sign(i)*s,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}const A=e*t,T=a*A,E=l*A;this.position.x+=T,this.position.y+=E,this.velocity.x=a*e,this.velocity.y=l*e;const _=Vt;this.position.x=Math.max(-_,Math.min(_,this.position.x)),this.position.y=Math.max(-_,Math.min(_,this.position.y))}getShortestAngleDelta(t,e){let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=this.attackDamage)}useAbility(t){return!(this.abilityCooldown>0||(this.abilityCooldown=this.abilityCooldownTime,0))}getAndClearLastAbilityEffects(){const t=this.lastAbilityEffects;return this.lastAbilityEffects=[],t}applyStun(t){this.stunDuration=Math.max(this.stunDuration,t)}isStunned(){return this.stunDuration>0}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class ma extends ya{constructor(t,e,s=[]){super(t,e,ye,me,fe,Se,ve,Me),this.explorationTarget=null,this.explorationTimer=0,this.currentPathWaypointIndex=0,this.assignedPath=[],this.hasManualOrder=!1,this.lastShotLasers=[],this.pathHash="",this.hasReachedFinalWaypoint=!1,this.currentMoveSpeedPxPerSec=Ae,this.spriteLevel=1,this.assignedPath=s.map(t=>new i(t.x,t.y)),this.pathHash=this.generatePathHash(this.assignedPath)}generatePathHash(t){return 0===t.length?"no-path":t.map(t=>`${Math.round(t.x)},${Math.round(t.y)}`).join("|")}setManualRallyPoint(t){this.tryBlinkToward(t),this.rallyPoint=t,this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1}setManualTarget(t,e){this.manualTarget=t,this.target=t,this.clearMovementOrders(),this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1,e&&this.setManualRallyPoint(e)}setPath(t){this.assignedPath=t.map(t=>new i(t.x,t.y)),this.pathHash=this.generatePathHash(this.assignedPath),this.currentPathWaypointIndex=0,this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1,this.rallyPoint=null}tryBlinkToward(t){if(!this.owner.hasBlinkUpgrade||this.abilityCooldown>0)return;const e=t.x-this.position.x,i=t.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s<=0)return;const o=Math.min(De,s),n=e/s,r=i/s;this.position.x+=n*o,this.position.y+=r*o,this.velocity.x=0,this.velocity.y=0,this.abilityCooldown=this.abilityCooldownTime}getAssignedPathLength(){return this.assignedPath.length}getPathHash(){return this.pathHash}getHasReachedFinalWaypoint(){return this.hasReachedFinalWaypoint}getCurrentPathWaypointIndex(){return this.currentPathWaypointIndex}getCurrentMoveSpeedPxPerSec(){return this.currentMoveSpeedPxPerSec}hasActiveManualOrder(){return this.hasManualOrder}clearManualOrders(){this.hasManualOrder=!1,this.clearManualTarget(),this.clearMovementOrders(),this.hasReachedFinalWaypoint=!1}getAndClearLastShotProjectiles(){return[]}getAndClearLastShotLasers(){const t=this.lastShotLasers;return this.lastShotLasers=[],t}updateAI(t,e){var s,o;if(!this.hasManualOrder)if(this.assignedPath.length>0){const e=this.assignedPath[this.currentPathWaypointIndex],i=null!==(s=this.getStandoffPointForWaypoint(t,e))&&void 0!==s?s:e;if(this.position.distanceTo(i)<_s*Ds){if(!(this.currentPathWaypointIndex<this.assignedPath.length-1))return this.rallyPoint=i,void(this.hasReachedFinalWaypoint=!0);{this.currentPathWaypointIndex++;const e=this.assignedPath[this.currentPathWaypointIndex];this.rallyPoint=null!==(o=this.getStandoffPointForWaypoint(t,e))&&void 0!==o?o:e}}else this.rallyPoint=i}else{let s=null,o=null;for(const i of e)if(i instanceof ha&&i.owner!==this.owner&&t.isObjectVisibleToPlayer(i.position,this.owner)){s=i.position,o=i.radius;break}if(!s)for(const e of t.players)if(e!==this.owner){for(const i of e.solarMirrors)if(t.isObjectVisibleToPlayer(i.position,this.owner)){s=i.position;break}if(s)break}if(!s){if(this.explorationTimer<=0||!this.explorationTarget||this.position.distanceTo(this.explorationTarget)<_s){const t=Math.random()*Math.PI*2,e=300+500*Math.random();this.explorationTarget=new i(this.position.x+Math.cos(t)*e,this.position.y+Math.sin(t)*e),this.explorationTimer=_e}s=this.explorationTarget}s&&(this.rallyPoint=o?this.getStructureStandoffPoint(s,o):s)}}getStandoffPointForWaypoint(t,e){for(const i of t.players){if(i.stellarForge&&e.distanceTo(i.stellarForge.position)<i.stellarForge.radius+this.collisionRadiusPx)return this.getStructureStandoffPoint(i.stellarForge.position,i.stellarForge.radius);for(const t of i.buildings)if(e.distanceTo(t.position)<t.radius+this.collisionRadiusPx)return this.getStructureStandoffPoint(t.position,t.radius)}return null}moveTowardRallyPoint(t,e,i,s=[]){if(this.assignedPath.length>0&&this.currentPathWaypointIndex===this.assignedPath.length-1&&!this.hasReachedFinalWaypoint&&null!==this.rallyPoint){const t=Is;for(let e=0;e<i.length;e++){const s=i[e];if(!(s instanceof ma)||s===this||s.isDead()||s.owner!==this.owner)continue;if(s.pathHash!==this.pathHash)continue;if(!s.hasReachedFinalWaypoint)continue;const o=this.position.x-s.position.x,n=this.position.y-s.position.y;if(o*o+n*n<t*t)return this.rallyPoint=null,this.velocity.x=0,this.velocity.y=0,void(this.hasReachedFinalWaypoint=!0)}}super.moveTowardRallyPoint(t,e,i,s)}update(t,e,i=[],s=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.explorationTimer-=t,this.owner.hasRegenUpgrade&&this.owner.stellarForge&&this.health<this.maxHealth&&this.position.distanceTo(this.owner.stellarForge.position)<=n&&(this.health=Math.min(this.maxHealth,this.health+Fe*t)),this.owner.hasStrafeUpgrade?this.currentMoveSpeedPxPerSec=Ae:this.currentMoveSpeedPxPerSec<Ae&&(this.currentMoveSpeedPxPerSec=Math.min(Ae,this.currentMoveSpeedPxPerSec+Te*t)),this.moveTowardRallyPoint(t,this.currentMoveSpeedPxPerSec,i,s),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}attack(t){const e=t.position.x-this.position.x,s=t.position.y-this.position.y;if(Math.sqrt(e*e+s*s)<=0)return;const o=new na(new i(this.position.x,this.position.y),new i(t.position.x,t.position.y),this.owner,this.attackDamage);this.lastShotLasers.push(o),"takeDamage"in t&&t.takeDamage(this.attackDamage),this.owner.hasStrafeUpgrade||(this.currentMoveSpeedPxPerSec=0)}}class fa{constructor(t,e,s){this.absorbedCount=0,this.assignedStarlings=[],this.position=new i(t.x,t.y),this.owner=e,this.remainingSec=ki,this.assignedStarlings=s,this.maxHealth=Ui,this.health=this.maxHealth,this.radius=Gi}}class Sa{constructor(t,e){this.position=t,this.owner=e,this.chargeTime=0,this.accumulatedEnergy=0,this.isCharging=!1,this.isComplete=!1,this.isCancelling=!1,this.hasDissipated=!1,this.completionRemainingSec=0,this.health=100,this.hasEmittedShockwave=!1,this.hasReceivedEnergyThisTick=!1}update(t){if(!this.hasDissipated){if(this.isCancelling){const e=E*t;return this.accumulatedEnergy=Math.max(0,this.accumulatedEnergy-e),this.chargeTime=this.accumulatedEnergy/c*h,void(this.accumulatedEnergy<=0&&(this.isCharging=!1,this.isComplete=!1,this.isCancelling=!1,this.hasDissipated=!0))}if(this.isComplete)return this.completionRemainingSec=Math.max(0,this.completionRemainingSec-t),void(this.completionRemainingSec<=0&&this.startCancellation());this.isCharging&&(this.chargeTime=this.accumulatedEnergy/c*h,this.accumulatedEnergy>=c&&(this.isComplete=!0,this.isCharging=!1,this.completionRemainingSec=_))}}addEnergy(t){!this.isCharging||this.isComplete||this.isCancelling||this.hasDissipated||(this.hasReceivedEnergyThisTick=!0,this.accumulatedEnergy+=t,this.chargeTime=this.accumulatedEnergy/c*h)}startCharging(){this.isCharging=!0,this.isCancelling=!1,this.hasDissipated=!1,this.chargeTime=0,this.accumulatedEnergy=0,this.completionRemainingSec=0}takeDamage(t){return this.health-=t,this.health<=0&&(this.cancel(),!0)}cancel(){this.startCancellation()}startCancellation(){this.isCancelling||this.hasDissipated||(this.isCancelling=!0,this.isCharging=!1,this.isComplete=!1,this.completionRemainingSec=0)}resetEnergyReceipt(){this.hasReceivedEnergyThisTick=!1}shouldEmitShockwave(){return!this.hasEmittedShockwave&&this.chargeTime>=1&&(this.hasEmittedShockwave=!0,!0)}}var Aa,Ta,Ea=function(t,e,i,s){return new(i||(i=Promise))(function(o,n){function r(t){try{l(s.next(t))}catch(t){n(t)}}function a(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}l((s=s.apply(t,e||[])).next())})};!function(t){t.GAME_COMMAND="game_command",t.GAME_STATE="game_state",t.PLAYER_JOIN="player_join",t.PLAYER_LEAVE="player_leave",t.LOBBY_UPDATE="lobby_update",t.GAME_START="game_start",t.PING="ping",t.PONG="pong"}(Aa||(Aa={})),function(t){t.CONNECTED="connected",t.DISCONNECTED="disconnected",t.MESSAGE_RECEIVED="message_received",t.PLAYER_JOINED="player_joined",t.PLAYER_LEFT="player_left",t.ERROR="error"}(Ta||(Ta={}));class _a{constructor(t){this.connection=null,this.dataChannel=null,this.onMessageCallback=null,this.onConnectedCallback=null,this.onDisconnectedCallback=null,this.peerId=t}createPeerConnection(){return new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]})}createOffer(){return Ea(this,void 0,void 0,function*(){this.connection=this.createPeerConnection(),this.setupConnectionHandlers(),this.dataChannel=this.connection.createDataChannel("gameData",{ordered:!0,maxRetransmits:3}),this.setupDataChannelHandlers(this.dataChannel);const t=yield this.connection.createOffer();return yield this.connection.setLocalDescription(t),yield this.waitForIceGathering(),this.connection.localDescription})}createAnswer(t){return Ea(this,void 0,void 0,function*(){this.connection=this.createPeerConnection(),this.setupConnectionHandlers(),this.connection.ondatachannel=t=>{this.dataChannel=t.channel,this.setupDataChannelHandlers(this.dataChannel)},yield this.connection.setRemoteDescription(t);const e=yield this.connection.createAnswer();return yield this.connection.setLocalDescription(e),yield this.waitForIceGathering(),this.connection.localDescription})}waitForIceGathering(){return this.connection?new Promise(t=>{if("complete"===this.connection.iceGatheringState)return void t();const e=()=>{"complete"===this.connection.iceGatheringState&&(this.connection.removeEventListener("icegatheringstatechange",e),t())};this.connection.addEventListener("icegatheringstatechange",e)}):Promise.reject(new Error("Connection not initialized"))}setAnswer(t){return Ea(this,void 0,void 0,function*(){if(!this.connection)throw new Error("Connection not initialized");yield this.connection.setRemoteDescription(t)})}addIceCandidate(t){return Ea(this,void 0,void 0,function*(){if(!this.connection)throw new Error("Connection not initialized");yield this.connection.addIceCandidate(t)})}setupConnectionHandlers(){this.connection&&(this.connection.onicecandidate=t=>{t.candidate&&console.log("ICE candidate:",t.candidate)},this.connection.onconnectionstatechange=()=>{this.connection&&(console.log("Connection state:",this.connection.connectionState),"connected"===this.connection.connectionState?this.onConnectedCallback&&this.onConnectedCallback():"disconnected"!==this.connection.connectionState&&"failed"!==this.connection.connectionState&&"closed"!==this.connection.connectionState||this.onDisconnectedCallback&&this.onDisconnectedCallback())})}setupDataChannelHandlers(t){t.onopen=()=>{console.log("Data channel opened with peer:",this.peerId)},t.onclose=()=>{console.log("Data channel closed with peer:",this.peerId)},t.onerror=t=>{console.error("Data channel error:",t)},t.onmessage=t=>{try{const e=JSON.parse(t.data);this.onMessageCallback&&this.onMessageCallback(e)}catch(t){console.error("Failed to parse network message:",t)}}}sendMessage(t){if(this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(JSON.stringify(t))}catch(t){console.error("Failed to send message:",t)}else console.warn("Data channel not open, cannot send message")}onMessage(t){this.onMessageCallback=t}onConnected(t){this.onConnectedCallback=t}onDisconnected(t){this.onDisconnectedCallback=t}close(){this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.connection&&(this.connection.close(),this.connection=null)}isConnected(){return null!==this.dataChannel&&"open"===this.dataChannel.readyState}getPeerId(){return this.peerId}}class Pa{constructor(t){this.peers=new Map,this.eventListeners=new Map,this.lobby=null,this.isHost=!1,this.localPlayerId=t}createLobby(t,e,i=2){return this.isHost=!0,this.lobby={id:this.generateLobbyId(),name:t,hostId:this.localPlayerId,players:[{id:this.localPlayerId,username:e,isHost:!0,isReady:!0}],maxPlayers:i,gameStarted:!1},this.lobby}connectToPeer(t,e){return Ea(this,void 0,void 0,function*(){const i=new _a(t);this.setupPeerHandlers(i);const s=yield i.createAnswer(e);return this.peers.set(t,i),s})}createOfferForPeer(t){return Ea(this,void 0,void 0,function*(){const e=new _a(t);this.setupPeerHandlers(e);const i=yield e.createOffer();return this.peers.set(t,e),i})}completeConnection(t,e){return Ea(this,void 0,void 0,function*(){const i=this.peers.get(t);if(!i)throw new Error(`No peer connection found for ${t}`);yield i.setAnswer(e)})}setupPeerHandlers(t){t.onMessage(e=>{this.handleMessage(t.getPeerId(),e)}),t.onConnected(()=>{console.log("Peer connected:",t.getPeerId()),this.emit(Ta.CONNECTED,{peerId:t.getPeerId()})}),t.onDisconnected(()=>{console.log("Peer disconnected:",t.getPeerId()),this.removePeer(t.getPeerId()),this.emit(Ta.DISCONNECTED,{peerId:t.getPeerId()})})}handleMessage(t,e){switch(console.log("Received message from",t,":",e),e.type){case Aa.PLAYER_JOIN:if(this.isHost&&this.lobby){const t=e.data;this.lobby.players.push(t),this.broadcastLobbyUpdate()}break;case Aa.LOBBY_UPDATE:this.lobby=e.data,this.emit(Ta.PLAYER_JOINED,e.data);break;case Aa.GAME_START:this.lobby&&(this.lobby.gameStarted=!0);break;case Aa.GAME_COMMAND:default:this.emit(Ta.MESSAGE_RECEIVED,e)}}sendToPeer(t,e){const i=this.peers.get(t);i?i.sendMessage(e):console.warn(`Cannot send to peer ${t}: not connected`)}broadcast(t){this.peers.forEach(e=>{e.sendMessage(t)})}broadcastLobbyUpdate(){if(!this.lobby)return;const t={type:Aa.LOBBY_UPDATE,senderId:this.localPlayerId,timestamp:Date.now(),data:this.lobby};this.broadcast(t)}sendGameCommand(t){const e={type:Aa.GAME_COMMAND,senderId:this.localPlayerId,timestamp:Date.now(),data:t};this.broadcast(e)}startGame(){if(!this.isHost||!this.lobby)return void console.warn("Only host can start the game");this.lobby.gameStarted=!0;const t={type:Aa.GAME_START,senderId:this.localPlayerId,timestamp:Date.now(),data:this.lobby};this.broadcast(t)}on(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}emit(t,e){const i=this.eventListeners.get(t);i&&i.forEach(t=>t(e))}removePeer(t){const e=this.peers.get(t);e&&(e.close(),this.peers.delete(t)),this.lobby&&(this.lobby.players=this.lobby.players.filter(e=>e.id!==t),this.isHost&&this.broadcastLobbyUpdate())}disconnect(){this.peers.forEach(t=>{t.close()}),this.peers.clear(),this.lobby=null,this.isHost=!1,this.eventListeners.clear()}generateLobbyId(){return`lobby_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}getLobby(){return this.lobby}getLocalPlayerId(){return this.localPlayerId}isLobbyHost(){return this.isHost}getPeerCount(){return this.peers.size}getPeerIds(){return Array.from(this.peers.keys())}}class Ia{static generateHostCode(t,e,i){return Ea(this,void 0,void 0,function*(){const s={type:"offer",sdp:t,playerId:e,username:i};return btoa(JSON.stringify(s))})}static parseHostCode(t){try{const e=JSON.parse(atob(t));if("offer"!==e.type)throw new Error("Invalid connection code: not an offer");return{offer:e.sdp,playerId:e.playerId||"host",username:e.username||"Host"}}catch(t){throw new Error("Invalid connection code format")}}static generateAnswerCode(t,e,i){return Ea(this,void 0,void 0,function*(){const s={type:"answer",sdp:t,playerId:e,username:i};return btoa(JSON.stringify(s))})}static parseAnswerCode(t){try{const e=JSON.parse(atob(t));if("answer"!==e.type)throw new Error("Invalid connection code: not an answer");return{answer:e.sdp,playerId:e.playerId||"client",username:e.username||"Client"}}catch(t){throw new Error("Invalid connection code format")}}}class Ca{constructor(t,e,i){this.position=t,this.sides=e,this.size=i,this.vertices=[],this.rotation=0,this.generateVertices(),this.rotationSpeed=.5*(Math.random()-.5)}generateVertices(){this.vertices=[];for(let t=0;t<this.sides;t++){const e=2*Math.PI*t/this.sides,s=.8+.4*Math.random(),o=this.size*s;this.vertices.push(new i(Math.cos(e)*o,Math.sin(e)*o))}}getWorldVertices(){return this.vertices.map(t=>{const e=Math.cos(this.rotation),s=Math.sin(this.rotation);return new i(this.position.x+t.x*e-t.y*s,this.position.y+t.x*s+t.y*e)})}update(t){this.rotation+=this.rotationSpeed*t}containsPoint(t){const e=this.getWorldVertices();let i=!1;for(let s=0,o=e.length-1;s<e.length;o=s++){const n=e[s].x,r=e[s].y,a=e[o].x,l=e[o].y;r>t.y!=l>t.y&&t.x<(a-n)*(t.y-r)/(l-r)+n&&(i=!i)}return i}}class Ma{constructor(t,e,s,o=100,n=0,r=null){this.position=new i(t.x,t.y),this.damage=Math.round(e),this.remainingHealth=Math.round(n),this.creationTime=s,this.maxHealth=o,this.unitId=r,this.velocity=new i(20*(Math.random()-.5),-50)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}isExpired(t){return t-this.creationTime>2}getOpacity(t){const e=t-this.creationTime;return Math.max(0,1-e/2)}}class Ra{constructor(){this.players=[],this.suns=[],this.spaceDust=[],this.warpGates=[],this.starlingMergeGates=[],this.starlingMergeGateExplosions=[],this.asteroids=[],this.muzzleFlashes=[],this.bulletCasings=[],this.bouncingBullets=[],this.abilityBullets=[],this.minionProjectiles=[],this.mortarProjectiles=[],this.laserBeams=[],this.impactParticles=[],this.influenceZones=[],this.influenceBallProjectiles=[],this.deployedTurrets=[],this.damageNumbers=[],this.crescentWaves=[],this.novaBombs=[],this.novaScatterBullets=[],this.stickyBombs=[],this.stickyLasers=[],this.disintegrationParticles=[],this.sparkleParticles=[],this.deathParticles=[],this.gameTime=0,this.stateHash=0,this.stateHashTickCounter=0,this.isRunning=!1,this.countdownTime=Xt,this.isCountdownActive=!0,this.mirrorsMovedToSun=!1,this.mapSize=2e3,this.damageDisplayMode="damage",this.networkManager=null,this.localPlayerIndex=0,this.pendingCommands=[],this.MAX_PUSH_DISTANCE=10,this.PUSH_MULTIPLIER=15,this.dustSpatialHash=new Map,this.dustSpatialHashKeys=[]}update(t){var e,s;this.gameTime+=t,this.starlingMergeGateExplosions.length=0,this.networkManager&&this.processPendingNetworkCommands(),this.isCountdownActive&&(this.countdownTime-=t,this.mirrorsMovedToSun||(this.initializeMirrorMovement(),this.mirrorsMovedToSun=!0),this.countdownTime<=0&&(this.isCountdownActive=!1,this.countdownTime=0));for(const t of this.warpGates)t.resetEnergyReceipt();for(const e of this.asteroids)e.update(t);this.isCountdownActive||this.updateAi(t);for(const o of this.players)if(!o.isDefeated()){if(o.solarMirrors.length>0&&(o.solarMirrors=o.solarMirrors.filter(t=>t.health>0)),o.stellarForge){const n=new i(o.stellarForge.position.x,o.stellarForge.position.y);if(o.stellarForge.updateLightStatus(o.solarMirrors,this.suns,this.asteroids,this.players),this.isCountdownActive||(o.stellarForge.update(t,this),this.checkCollision(o.stellarForge.position,o.stellarForge.radius,o.stellarForge)&&(o.stellarForge.position=n,o.stellarForge.targetPosition=null,o.stellarForge.velocity=new i(0,0)),this.applyDustPushFromMovingEntity(o.stellarForge.position,o.stellarForge.velocity,tt,et,this.getPlayerImpactColor(o),t)),!this.isCountdownActive){const t=o.stellarForge.shouldCrunch();if(t>0){const n=Math.floor(t/Ke);for(let t=0;t<n;t++){const r=2*Math.PI*t/n,a=o.stellarForge.radius+Me+5,l=new i(o.stellarForge.position.x+Math.cos(r)*a,o.stellarForge.position.y+Math.sin(r)*a),h=new ma(l,o,null!==(s=null===(e=o.stellarForge)||void 0===e?void 0:e.minionPath)&&void 0!==s?s:[]);o.units.push(h),o.unitsCreated++}n>0&&console.log(`${o.name} forge crunch spawned ${n} Starlings with ${t.toFixed(0)} energy`)}}if(!this.isCountdownActive){const e=o.stellarForge.advanceHeroProduction(t);if(e){const t=o.stellarForge.radius+Ps+5,s=new i(o.stellarForge.position.x,o.stellarForge.position.y+t),n=this.createHeroUnit(e,s,o);n&&(o.units.push(n),o.unitsCreated++,console.log(`${o.name} forged hero ${e}`))}}}for(const e of o.solarMirrors){const s=new i(e.position.x,e.position.y);e.update(t,this),this.checkCollision(e.position,20,e)&&(e.position=s,e.targetPosition=null,e.velocity=new i(0,0)),this.applyDustPushFromMovingEntity(e.position,e.velocity,Q,Z,this.getPlayerImpactColor(o),t),e.linkedStructure instanceof ca&&e.linkedStructure.isDestroyed()&&e.setLinkedStructure(null),e.linkedStructure instanceof ha&&e.linkedStructure!==o.stellarForge&&e.setLinkedStructure(null);const l=e.getLinkedStructure(o.stellarForge);if(e.updateReflectionAngle(l,this.suns,this.asteroids,t),e.hasLineOfSightToLight(this.suns,this.asteroids)&&l){const i=e.generateEnergy(t);if(l instanceof ha&&o.stellarForge&&e.hasLineOfSightToForge(o.stellarForge,this.asteroids,this.players))o.addEnergy(i),o.stellarForge.addPendingEnergy(i);else if(l instanceof ca&&e.hasLineOfSightToStructure(l,this.asteroids,this.players))l.isComplete||l.addEnergy(i);else if(l instanceof Sa&&e.hasLineOfSightToStructure(l,this.asteroids,this.players)){const t=!l.isComplete;l.isCharging&&!l.isComplete&&l.addEnergy(i),t&&l.isComplete&&o.stellarForge&&e.setLinkedStructure(o.stellarForge)}}if(o.stellarForge&&e.health<$t&&o.stellarForge.position.distanceTo(e.position)<=n&&(e.health=Math.min($t,e.health+Kt*t),Math.random()<2.5*t)){const t=Math.random()*Math.PI*2,s=25*Math.random(),n=new i(e.position.x+Math.cos(t)*s,e.position.y+Math.sin(t)*s),l=new i(30*(Math.random()-.5),30*(Math.random()-.5)-20),h=o===this.players[0]?r:a;this.sparkleParticles.push(new aa(n,l,.8,h,2+2*Math.random()))}}}for(const t of this.warpGates)!t.isCharging||t.isComplete||t.isCancelling||t.hasReceivedEnergyThisTick||t.startCancellation();this.updateSpaceDust(t);const o=[],l=[];for(const t of this.players)if(!t.isDefeated()){o.push(...t.units),l.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&l.push(e);for(const e of this.starlingMergeGates)e.owner===t&&e.health>0&&l.push(e);t.stellarForge&&l.push(t.stellarForge)}for(const e of this.players){if(e.isDefeated())continue;const s=[];for(const t of this.players)if(t!==e&&!t.isDefeated()){s.push(...t.units),s.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&s.push(e);for(const e of this.starlingMergeGates)e.owner===t&&e.health>0&&s.push(e);t.stellarForge&&s.push(t.stellarForge)}if(!this.isCountdownActive)for(const n of e.units){if(n instanceof ma&&n.updateAI(this,s),n.update(t,s,o,this.asteroids),n instanceof ma&&this.applyDustPushFromMovingEntity(n.position,n.velocity,it,st,this.getPlayerImpactColor(n.owner),t),n instanceof ba)for(const e of n.getProjectiles())if(e.isAttacking){const i=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,b,i*L,this.getPlayerImpactColor(n.owner),t)}if(n instanceof wa){const t=n.getAndClearLastShotEffects();t.muzzleFlash&&this.muzzleFlashes.push(t.muzzleFlash),t.casing&&this.bulletCasings.push(t.casing),t.bouncingBullet&&this.bouncingBullets.push(t.bouncingBullet)}const e=n.getAndClearLastAbilityEffects();if(this.abilityBullets.push(...e),n instanceof ma){const t=n.getAndClearLastShotLasers();if(t.length>0){this.laserBeams.push(...t);for(const e of t)for(let t=0;t<Re;t++){const s=2*Math.PI*t/Re,o=new i(Math.cos(s)*we,Math.sin(s)*we);this.impactParticles.push(new ra(new i(e.endPos.x,e.endPos.y),o,be,e.owner.faction))}}}if(n instanceof Oa){const t=n.getAndClearProjectile();t&&this.influenceBallProjectiles.push(t)}if(n instanceof za){const t=n.getAndClearLastShotProjectiles();t.length>0&&this.mortarProjectiles.push(...t)}if(n instanceof Ka){const t=n.getCrescentWave();t&&!this.crescentWaves.includes(t)&&this.crescentWaves.push(t)}if(n instanceof qa){const t=n.getAndClearBomb();t&&this.novaBombs.push(t)}if(n instanceof Za){const t=n.getAndClearBombToCreate();t&&this.stickyBombs.push(t);const e=n.getAndClearLasersToCreate();e.length>0&&this.stickyLasers.push(...e);const i=n.getAndClearParticlesToCreate();i.length>0&&this.disintegrationParticles.push(...i)}if(n instanceof Da){n.updateBeamSegments(t);for(const e of n.getBeamSegments())this.applyFluidForceFromBeam(e.startPos,e.endPos,v,O,this.getPlayerImpactColor(n.owner),t);n.abilityCooldown>n.abilityCooldownTime-.1&&n.drillDirection&&(this.processRayBeamAbility(n),n.drillDirection=null)}if(n instanceof ka&&n.abilityCooldown>n.abilityCooldownTime-.1&&this.processTurretDeployment(n),n instanceof $a&&this.updateSpotlightAbility(n,s,t),n instanceof Ua&&n.isDrilling&&(n.updateDrilling(t),this.processDrillerCollisions(n,t)),n instanceof Ha&&n.updateTimers(t),n instanceof ba)for(const t of n.getProjectiles())if(t.isAttacking){let e=!1;for(const i of this.players){for(const s of i.buildings)if(s instanceof ua){if(s.owner===t.owner)continue;if(s.absorbProjectile(t)){t.isAttacking=!1,t.trail=[],t.targetEnemy=null,e=!0;break}}if(e)break}}}this.isCountdownActive||this.updateStarlingMergeGatesForPlayer(e,t);const h=e.units.filter(t=>t.isDead());for(const t of h){const i=e===this.players[0]?r:a;this.createDeathParticles(t,i)}if(e.unitsLost+=h.length,e.units=e.units.filter(t=>!t.isDead()),!this.isCountdownActive)for(const i of e.buildings){if(i.update(t,s,o,this.asteroids,l,Vt),i instanceof da||i instanceof ga){const t=i.getAndClearLastShotEffects();t.muzzleFlash&&this.muzzleFlashes.push(t.muzzleFlash),t.casing&&this.bulletCasings.push(t.casing),t.bouncingBullet&&this.bouncingBullets.push(t.bouncingBullet)}if(i instanceof da){const t=i.getAndClearLastShotLasers();t.length>0&&this.laserBeams.push(...t)}if(i instanceof pa){if(i.currentProduction){const s=this.getMirrorLightOnStructure(e,i);if(s>0){const e=s/10*(1/cs)*t;i.addProductionProgress(e)}}const s=i.getCompletedProduction();s===Di?i.upgradeStrafe():s===vi&&i.upgradeRegen()}}if(!this.isCountdownActive)for(const i of e.buildings)if(!i.isComplete)if(e.stellarForge&&i.position.distanceTo(e.stellarForge.position)<=n&&e.stellarForge){const e=1/cs*t;i.addBuildProgress(e)}else{const s=this.getMirrorLightOnStructure(e,i);if(s>0){const e=s/10*(1/cs)*t;i.addBuildProgress(e)}}const c=e.buildings.filter(t=>t.isDestroyed());for(const t of c){const i=e===this.players[0]?r:a;this.createDeathParticles(t,i)}e.buildings=e.buildings.filter(t=>!t.isDestroyed())}this.isCountdownActive||(this.resolveUnitCollisions(o),this.resolveUnitObstacleCollisions(o)),this.stateHashTickCounter+=1,this.stateHashTickCounter%Ns===0&&this.updateStateHash();for(const e of this.muzzleFlashes)e.update(t);this.muzzleFlashes=this.muzzleFlashes.filter(t=>!t.shouldDespawn());for(const e of this.bulletCasings){e.update(t);for(const t of this.spaceDust)if(e.position.distanceTo(t.position)<fs){const s=new i(t.position.x-e.position.x,t.position.y-e.position.y).normalize();t.applyForce(new i(s.x*Ss,s.y*Ss)),e.applyCollision(new i(-s.x*Ss,-s.y*Ss))}}this.bulletCasings=this.bulletCasings.filter(t=>!t.shouldDespawn());for(const e of this.bouncingBullets)e.update(t);this.bouncingBullets=this.bouncingBullets.filter(t=>!t.shouldDespawn());for(const e of this.abilityBullets){e.update(t);let i=!1;for(const t of this.players){for(const s of t.units)if(s instanceof Ka&&s.isPositionInShield(e.position)&&e.owner!==t){i=!0,e.lifetime=e.maxLifetime;break}if(i)break}if(i)continue;e.isHealingBomb&&e.healingBombOwner&&e.shouldDespawn()&&e.healingBombOwner.explodeHealingBomb(e.position);const s=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,C,s*M,this.getPlayerImpactColor(e.owner),t);for(const t of this.players)if(t!==e.owner&&!e.isHealingBomb){for(const i of t.units)if(e.checkHit(i)){let t=e.damage;if(e.isBeamProjectile&&e.beamOwner){const s=e.beamOwner,o=s.position.distanceTo(i.position),n=1+o*ln;t=Math.round(rn*n),s.lastBeamDamage=t,s.lastBeamDistance=o,s.lastBeamMultiplier=n,s.lastBeamTime=this.gameTime}i.takeDamage(t);const s=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,t,i.maxHealth,i.health,s),e.lifetime=e.maxLifetime;break}if(!e.shouldDespawn()){for(const i of t.solarMirrors)if(!(i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`mirror_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,$t,i.health,s),e.lifetime=e.maxLifetime;break}if(!e.shouldDespawn()){for(const i of this.starlingMergeGates)if(!(i.owner!==t||i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`merge_gate_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,s),e.lifetime=e.maxLifetime;break}if(!e.shouldDespawn()&&t.stellarForge&&e.checkHit(t.stellarForge)){let i=e.damage;if(e.isBeamProjectile&&e.beamOwner){const s=e.beamOwner,o=s.position.distanceTo(t.stellarForge.position),n=1+o*ln;i=Math.round(rn*n),s.lastBeamDamage=i,s.lastBeamDistance=o,s.lastBeamMultiplier=n,s.lastBeamTime=this.gameTime}t.stellarForge.health-=i;const s=`forge_${t.stellarForge.position.x}_${t.stellarForge.position.y}_${t.name}`;this.addDamageNumber(t.stellarForge.position,i,Ue,t.stellarForge.health,s),e.lifetime=e.maxLifetime}}}}}this.abilityBullets=this.abilityBullets.filter(t=>!t.shouldDespawn());for(const e of this.mortarProjectiles){e.update(t);let i=!1;for(const t of this.players)if(t!==e.owner){for(const s of t.units)if(e.checkHit(s)){i=!0;break}if(i)break}if(i||e.shouldDespawn()){const t=[];for(const i of this.players)if(i!==e.owner){t.push(...i.units),i.stellarForge&&i.stellarForge.health>0&&t.push(i.stellarForge);for(const e of i.buildings)e.health>0&&t.push(e)}const i=e.applySplashDamage(t);for(const t of i){const i=1-e.position.distanceTo(t.position)/e.splashRadius*(1-Fn),s=Math.round(e.damage*i);if(t instanceof ya){const e=`unit_${t.position.x}_${t.position.y}_${t.owner.name}`;this.addDamageNumber(t.position,s,t.maxHealth,t.health,e)}else if("isBuilding"in t&&t.isBuilding){const e=`building_${t.position.x}_${t.position.y}`;this.addDamageNumber(t.position,s,t.maxHealth,t.health,e)}else if("isForge"in t&&t.isForge){const e=`forge_${t.position.x}_${t.position.y}`;this.addDamageNumber(t.position,s,t.maxHealth,t.health,e)}}e.lifetime=e.maxLifetime}}this.mortarProjectiles=this.mortarProjectiles.filter(t=>!t.shouldDespawn());for(const e of this.minionProjectiles){e.update(t);let i=!1;for(const t of this.players){for(const s of t.units)if(s instanceof Ka&&s.isPositionInShield(e.position)&&e.owner!==t){i=!0,e.distanceTraveledPx=e.maxRangePx;break}if(i)break}if(i)continue;const s=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,R,s*w,this.getPlayerImpactColor(e.owner),t);let o=!1;for(const t of this.players){for(const i of t.buildings)if(i instanceof ua){if(i.owner===e.owner)continue;if(i.absorbProjectile(e)){e.distanceTraveledPx=e.maxRangePx,o=!0;break}}if(o)break}if(o)continue;let n=!1;for(const t of this.players)if(t!==e.owner){for(const i of t.units)if(e.checkHit(i)){i.takeDamage(e.damage);const t=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,t),n=!0;break}if(n)break;for(const i of t.solarMirrors)if(!(i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`mirror_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,$t,i.health,s),n=!0;break}if(n)break;for(const i of this.starlingMergeGates)if(!(i.owner!==t||i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`merge_gate_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,s),n=!0;break}if(n)break;for(const i of t.buildings)if(e.checkHit(i)){i.health-=e.damage;const s=`building_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,s),n=!0;break}if(n)break;if(t.stellarForge&&e.checkHit(t.stellarForge)){t.stellarForge.health-=e.damage;const i=`forge_${t.stellarForge.position.x}_${t.stellarForge.position.y}_${t.name}`;this.addDamageNumber(t.stellarForge.position,e.damage,Ue,t.stellarForge.health,i),n=!0;break}}n&&(e.distanceTraveledPx=e.maxRangePx)}this.minionProjectiles=this.minionProjectiles.filter(t=>!t.shouldDespawn()),this.laserBeams=this.laserBeams.filter(e=>!e.update(t));for(const e of this.impactParticles)e.update(t);this.impactParticles=this.impactParticles.filter(t=>!t.shouldDespawn());for(const e of this.sparkleParticles)e.update(t);this.sparkleParticles=this.sparkleParticles.filter(t=>!t.shouldDespawn());for(const e of this.deathParticles)e.update(t);this.deathParticles=this.deathParticles.filter(t=>!t.shouldDespawn()),this.influenceZones=this.influenceZones.filter(e=>!e.update(t));for(const e of this.influenceBallProjectiles){e.update(t);const s=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,F,s*D,this.getPlayerImpactColor(e.owner),t);let o=!1;for(const t of this.players){for(const i of t.buildings)if(i instanceof ua){if(i.owner===e.owner)continue;if(i.absorbProjectile(e)){e.lifetime=e.maxLifetime,o=!0;break}}if(o)break}if(!o&&e.shouldExplode()){const t=new Na(new i(e.position.x,e.position.y),e.owner);this.influenceZones.push(t)}}this.influenceBallProjectiles=this.influenceBallProjectiles.filter(t=>!t.shouldExplode());for(const e of this.crescentWaves){e.update(t);for(const t of this.players)for(const i of t.units)!e.affectedUnits.has(i)&&e.isPointInWave(i.position)&&(i.applyStun(ar),e.affectedUnits.add(i));this.abilityBullets=this.abilityBullets.filter(t=>!e.isPointInWave(t.position)),this.minionProjectiles=this.minionProjectiles.filter(t=>!e.isPointInWave(t.position)),this.mortarProjectiles=this.mortarProjectiles.filter(t=>!e.isPointInWave(t.position)),this.influenceBallProjectiles=this.influenceBallProjectiles.filter(t=>!e.isPointInWave(t.position)),this.bouncingBullets=this.bouncingBullets.filter(t=>!e.isPointInWave(t.position))}this.crescentWaves=this.crescentWaves.filter(t=>!t.shouldDespawn());for(const e of this.novaBombs){e.update(t);for(const t of this.asteroids)if(e.position.distanceTo(t.position)<t.size+Mr){const i=e.position.x-t.position.x,s=e.position.y-t.position.y,o=Math.sqrt(i*i+s*s);if(o>0){const n=i/o,r=s/o;e.bounce(n,r),e.position.x=t.position.x+n*(t.size+Mr),e.position.y=t.position.y+r*(t.size+Mr)}}const s=Vt;e.position.x<=-s?(e.bounce(1,0),e.position.x=-s):e.position.x>=s&&(e.bounce(-1,0),e.position.x=s),e.position.y<=-s?(e.bounce(0,1),e.position.y=-s):e.position.y>=s&&(e.bounce(0,-1),e.position.y=s);for(const t of this.abilityBullets)if(t.owner!==e.owner&&e.position.distanceTo(t.position)<Mr){e.takeDamage();break}for(const t of this.mortarProjectiles)if(t.owner!==e.owner&&e.position.distanceTo(t.position)<Mr){e.takeDamage();break}if(e.shouldExplode()){const t=e.getScatterDirection();if(t){const s=Math.atan2(t.y,t.x),o=Er/2;for(let t=0;t<_r;t++){const n=s-o+t/(_r-1)*Er,r=new i(Math.cos(n)*Pr,Math.sin(n)*Pr);this.novaScatterBullets.push(new Qa(new i(e.position.x,e.position.y),r,e.owner))}for(const t of this.players)if(t!==e.owner){for(const i of t.units)e.position.distanceTo(i.position)<=Tr&&(i.health-=Ar);for(const i of t.buildings)e.position.distanceTo(i.position)<=Tr&&(i.health-=Ar)}e.novaUnit&&e.novaUnit.getActiveBomb()===e&&e.novaUnit.clearActiveBomb()}}}this.novaBombs=this.novaBombs.filter(t=>!t.shouldExplode());for(const e of this.novaScatterBullets){e.update(t);for(const t of this.players)if(t!==e.owner)for(const i of t.units)if(e.checkHit(i)){i.health-=e.damage,e.lifetime=e.maxLifetime;break}}this.novaScatterBullets=this.novaScatterBullets.filter(t=>!t.shouldDespawn());for(const e of this.stickyBombs){if(e.update(t),!e.isStuck){for(const t of this.asteroids)if(e.position.distanceTo(t.position)<t.size+Nr){const s=e.position.x-t.position.x,o=e.position.y-t.position.y,n=Math.sqrt(s*s+o*o);if(n>0){const r=new i(s/n,o/n);e.stickToSurface("asteroid",r,t),e.position.x=t.position.x+r.x*(t.size+Gr),e.position.y=t.position.y+r.y*(t.size+Gr)}break}if(!e.isStuck)for(const t of this.players){for(const s of t.buildings)if(e.position.distanceTo(s.position)<Nr){const t=e.position.x-s.position.x,o=e.position.y-s.position.y,n=Math.sqrt(t*t+o*o);if(n>0){const r=new i(t/n,o/n);e.stickToSurface("structure",r,s)}break}if(e.isStuck)break;for(const s of t.solarMirrors)if(e.position.distanceTo(s.position)<Nr){const t=e.position.x-s.position.x,o=e.position.y-s.position.y,n=Math.sqrt(t*t+o*o);if(n>0){const r=new i(t/n,o/n);e.stickToSurface("structure",r,s)}break}if(e.isStuck)break;if(t.stellarForge&&e.position.distanceTo(t.stellarForge.position)<Nr){const s=e.position.x-t.stellarForge.position.x,o=e.position.y-t.stellarForge.position.y,n=Math.sqrt(s*s+o*o);if(n>0){const r=new i(s/n,o/n);e.stickToSurface("structure",r,t.stellarForge)}break}if(e.isStuck)break}if(!e.isStuck){const t=Vt,s=Nr;e.position.x<=-t+s?(e.stickToSurface("edge",new i(1,0)),e.position.x=-t+Gr):e.position.x>=t-s?(e.stickToSurface("edge",new i(-1,0)),e.position.x=t-Gr):e.position.y<=-t+s?(e.stickToSurface("edge",new i(0,1)),e.position.y=-t+Gr):e.position.y>=t-s&&(e.stickToSurface("edge",new i(0,-1)),e.position.y=t-Gr)}}e.shouldDisintegrate()&&e.velarisOwner.onBombDestroyed(e)}this.stickyBombs=this.stickyBombs.filter(t=>!t.shouldDespawn());for(const e of this.stickyLasers){e.update(t);for(const t of this.players)if(t!==e.owner){for(const i of t.units)e.checkHit(i)&&(i.health-=e.damage,this.damageNumbers.push(new Ma(i.position,e.damage,this.gameTime)));for(const i of t.buildings)e.checkHit(i)&&(i.health-=e.damage,this.damageNumbers.push(new Ma(i.position,e.damage,this.gameTime)));for(const i of t.solarMirrors)e.checkHit(i)&&(i.health-=e.damage,this.damageNumbers.push(new Ma(i.position,e.damage,this.gameTime)));t.stellarForge&&e.checkHit(t.stellarForge)&&(t.stellarForge.health-=e.damage,this.damageNumbers.push(new Ma(t.stellarForge.position,e.damage,this.gameTime)))}}this.stickyLasers=this.stickyLasers.filter(t=>!t.shouldDespawn());for(const e of this.disintegrationParticles)e.update(t);this.disintegrationParticles=this.disintegrationParticles.filter(t=>!t.shouldDespawn());const h=[];for(const t of this.players)if(!t.isDefeated()){h.push(...t.units),h.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&h.push(e);t.stellarForge&&h.push(t.stellarForge)}for(const e of this.deployedTurrets){const i=h.filter(t=>t.owner!==e.owner);e.update(t,i)}this.deployedTurrets=this.deployedTurrets.filter(t=>!t.isDead());for(const e of this.damageNumbers)e.update(t);this.damageNumbers=this.damageNumbers.filter(t=>!t.isExpired(this.gameTime))}updateSpaceDust(t){this.applyDustRepulsion(t);for(const e of this.spaceDust){e.update(t);let i=null;for(let t=0;t<this.players.length;t++){const s=this.players[t];if(s.stellarForge&&!s.isDefeated()){const o=e.position.distanceTo(s.stellarForge.position);if(o<n){const e=0===t?r:a;(!i||o<i.distance)&&(i={color:e,distance:o})}}}if(i){const t=1-i.distance/n;e.updateColor(i.color,t)}else e.updateColor(null,0)}for(const e of this.warpGates)if(e.isCharging&&e.chargeTime>=d)for(const s of this.spaceDust){const o=s.position.distanceTo(e.position);if(o<g&&o>u){const n=new i(e.position.x-s.position.x,e.position.y-s.position.y).normalize(),r=new i(-n.y,n.x),a=new i(n.x*p+r.x*x,n.y*p+r.y*x);s.applyForce(new i(a.x*t/o,a.y*t/o))}}for(const e of this.players)if(e.stellarForge&&!e.isDefeated()){const s=e.stellarForge.getCurrentCrunch();if(s&&s.isActive())for(const e of this.spaceDust){const o=e.position.distanceTo(s.position);if("suck"===s.phase&&o<Ve){if(o>5){const n=new i(s.position.x-e.position.x,s.position.y-e.position.y).normalize(),r=Ye/Math.sqrt(o);e.applyForce(new i(n.x*r*t,n.y*r*t))}}else if("wave"===s.phase&&o<Xe&&o>5){const n=new i(e.position.x-s.position.x,e.position.y-s.position.y).normalize(),r=s.getPhaseProgress()*Xe,a=Math.abs(o-r),l=50,h=Math.exp(-a/l),c=$e*h;e.applyForce(new i(n.x*c*t,n.y*c*t))}}}for(const e of this.players)for(const i of e.buildings)i instanceof ua&&i.applyDustSwirl(this.spaceDust,t)}applyDustRepulsion(t){const e=Y,i=X,s=i*i,o=$;for(let t=0;t<this.dustSpatialHashKeys.length;t++){const e=this.dustSpatialHashKeys[t],i=this.dustSpatialHash.get(e);i&&(i.length=0)}this.dustSpatialHashKeys.length=0;for(let t=0;t<this.spaceDust.length;t++){const i=this.spaceDust[t],s=Math.floor(i.position.x/e)<<16^65535&Math.floor(i.position.y/e);let o=this.dustSpatialHash.get(s);o||(o=[],this.dustSpatialHash.set(s,o)),0===o.length&&this.dustSpatialHashKeys.push(s),o.push(t)}for(let n=0;n<this.spaceDust.length;n++){const r=this.spaceDust[n],a=Math.floor(r.position.x/e),l=Math.floor(r.position.y/e);let h=0,c=0;for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){const d=a+e<<16^l+t&65535,g=this.dustSpatialHash.get(d);if(g)for(let t=0;t<g.length;t++){const e=g[t];if(e===n)continue;const a=this.spaceDust[e],l=r.position.x-a.position.x,d=r.position.y-a.position.y,u=l*l+d*d;if(u>0&&u<s){const t=Math.sqrt(u),e=1-t/i,s=e*e*o;h+=l/t*s,c+=d/t*s}}}0===h&&0===c||(r.velocity.x+=h*t,r.velocity.y+=c*t)}}updateAi(t){for(const t of this.players){if(!t.isAi||t.isDefeated())continue;const e=this.getEnemiesForPlayer(t);this.updateAiMirrorsForPlayer(t),this.updateAiMirrorPurchaseForPlayer(t),this.updateAiDefenseForPlayer(t,e),this.updateAiHeroProductionForPlayer(t),this.updateAiStructuresForPlayer(t,e)}}updateStarlingMergeGatesForPlayer(t,e){for(let s=this.starlingMergeGates.length-1;s>=0;s--){const o=this.starlingMergeGates[s];if(o.owner!==t)continue;if(o.health<=0){this.releaseStarlingMergeGate(o,t),this.starlingMergeGateExplosions.push(new i(o.position.x,o.position.y)),this.starlingMergeGates.splice(s,1);continue}o.remainingSec=Math.max(0,o.remainingSec-e);const n=o.assignedStarlings;let r=0;for(let t=0;t<n.length;t++){const e=n[t];e.isDead()||(e.clearManualTarget(),e.setManualRallyPoint(o.position),e.position.distanceTo(o.position)<=Gi?(e.health=0,o.absorbedCount+=1):(n[r]=e,r+=1))}n.length=r,o.remainingSec<=0&&(o.absorbedCount>=Bi?(this.starlingMergeGateExplosions.push(new i(o.position.x,o.position.y)),t.solarMirrors.push(new Qr(new i(o.position.x,o.position.y),t))):(this.releaseStarlingMergeGate(o,t),this.starlingMergeGateExplosions.push(new i(o.position.x,o.position.y))),this.starlingMergeGates.splice(s,1))}}releaseStarlingMergeGate(t,e){var s,o;const n=t.absorbedCount;if(n>0){const r=Gi+Me+4;for(let a=0;a<n;a++){const l=2*Math.PI*a/n,h=new i(t.position.x+Math.cos(l)*r,t.position.y+Math.sin(l)*r),c=new ma(h,e,null!==(o=null===(s=e.stellarForge)||void 0===s?void 0:s.minionPath)&&void 0!==o?o:[]);e.units.push(c),e.unitsCreated++}}for(const e of t.assignedStarlings)e.isDead()||e.clearManualOrders();t.assignedStarlings.length=0}getEnemiesForPlayer(t){const e=[];for(const i of this.players)if(i!==t&&!i.isDefeated()){e.push(...i.units),e.push(...i.buildings);for(const t of i.solarMirrors)t.health>0&&e.push(t);for(const t of this.starlingMergeGates)t.owner===i&&t.health>0&&e.push(t);i.stellarForge&&e.push(i.stellarForge)}return e}updateAiMirrorsForPlayer(t){if(this.gameTime<t.aiNextMirrorCommandSec)return;if(t.aiNextMirrorCommandSec=this.gameTime+zi,!t.stellarForge||0===t.solarMirrors.length)return;const e=this.getClosestSunToPoint(t.stellarForge.position);if(!e)return;const s=t.solarMirrors.length,o=Math.atan2(t.stellarForge.position.y-e.position.y,t.stellarForge.position.x-e.position.x)-ts*(s-1)/2,n=e.radius+Zi;for(let r=0;r<s;r++){const s=t.solarMirrors[r],a=o+ts*r,l=new i(e.position.x+Math.cos(a)*n,e.position.y+Math.sin(a)*n);s.position.distanceTo(l)>es&&s.setTarget(l)}}updateAiMirrorPurchaseForPlayer(t){}updateAiDefenseForPlayer(t,e){if(this.gameTime<t.aiNextDefenseCommandSec)return;t.aiNextDefenseCommandSec=this.gameTime+Vi;const s=this.findAiThreat(t,e);if(s){const e=s.enemy.position;for(const s of t.units)s.isHero?s.rallyPoint=new i(e.x,e.y):s instanceof ma&&s.setManualRallyPoint(new i(e.x,e.y));return}if(!t.stellarForge)return;if(t.aiStrategy===qr.WAVES){if(!(t.units.length>=ji)){for(const e of t.units)e.isHero?e.rallyPoint=new i(t.stellarForge.position.x,t.stellarForge.position.y):e instanceof ma&&e.setManualRallyPoint(new i(t.stellarForge.position.x,t.stellarForge.position.y));return}{const e=this.getEnemyForgeForPlayer(t);if(e){for(const s of t.units)(s.isHero||s instanceof ma)&&(s.rallyPoint=new i(e.position.x,e.position.y),s instanceof ma&&s.setManualRallyPoint(new i(e.position.x,e.position.y)));return}}}else if(t.aiStrategy===qr.AGGRESSIVE){const e=this.getEnemyForgeForPlayer(t);if(e){for(const s of t.units)s.isHero?s.rallyPoint=new i(e.position.x,e.position.y):s instanceof ma&&s.setManualRallyPoint(new i(e.position.x,e.position.y));return}}const o=t.solarMirrors.length;let n=0;for(const e of t.units)if(e.isHero)e.rallyPoint=new i(t.stellarForge.position.x,t.stellarForge.position.y);else if(e instanceof ma)if(n<o){const s=t.solarMirrors[n];e.setManualRallyPoint(new i(s.position.x,s.position.y)),n+=1}else e.setManualRallyPoint(new i(t.stellarForge.position.x,t.stellarForge.position.y))}getEnemyForgeForPlayer(t){for(const e of this.players)if(e!==t&&!e.isDefeated()&&e.stellarForge)return e.stellarForge;return null}updateAiHeroProductionForPlayer(t){if(this.gameTime<t.aiNextHeroCommandSec)return;let e=Xi;switch(t.aiStrategy){case qr.AGGRESSIVE:e=Xi*qi;break;case qr.ECONOMIC:e=Xi*Ji;break;case qr.WAVES:e=Xi*Qi;break;default:e=Xi}if(t.aiNextHeroCommandSec=this.gameTime+e,!t.stellarForge||!t.stellarForge.canProduceUnits())return;const i=this.getAiHeroTypesForFaction(t.faction);for(const e of i)if(!this.isHeroUnitAlive(t,e)&&!this.isHeroUnitQueuedOrProducing(t.stellarForge,e)){if(!t.spendEnergy(wi))return;return t.stellarForge.enqueueHeroUnit(e),void t.stellarForge.startHeroProductionIfIdle()}}updateAiStructuresForPlayer(t,e){var i;if(this.gameTime<t.aiNextStructureCommandSec)return;if(t.aiNextStructureCommandSec=this.gameTime+Yi,!t.stellarForge)return;const s=t.buildings.filter(t=>t instanceof da).length,o=t.buildings.filter(t=>t instanceof ua).length,n=t.buildings.some(t=>t instanceof pa);let r=null;const a=t.faction===Jr.RADIANT;switch(t.aiStrategy){case qr.ECONOMIC:!n&&t.energy>=Ri?r="subsidiaryFactory":a&&s<1&&t.energy>=Ii?r="minigun":a&&o<1&&t.energy>=Mi&&(r="swirler");break;case qr.DEFENSIVE:a&&o<2&&t.energy>=Mi?r="swirler":a&&s<3&&t.energy>=Ii?r="minigun":!n&&t.energy>=Ri?r="subsidiaryFactory":a&&s<5&&t.energy>=Ii&&(r="minigun");break;case qr.AGGRESSIVE:!n&&t.energy>=Ri?r="subsidiaryFactory":a&&s<1&&t.energy>=Ii&&(r="minigun");break;case qr.WAVES:!n&&t.energy>=Ri?r="subsidiaryFactory":a&&s<2&&t.energy>=Ii?r="minigun":a&&o<1&&t.energy>=Mi?r="swirler":a&&s<3&&t.energy>=Ii&&(r="minigun")}if(!r)return;const l=this.findAiThreat(t,e),h=null!==(i=null==l?void 0:l.guardPoint)&&void 0!==i?i:this.getAiStructureAnchor(t);if(!h)return;let c=null;switch(r){case"subsidiaryFactory":c=this.findAiStructurePlacement(h,_i,t),c&&t.spendEnergy(Ri)&&t.buildings.push(new pa(c,t));break;case"swirler":c=this.findAiStructurePlacement(h,ci,t),c&&t.spendEnergy(Mi)&&t.buildings.push(new ua(c,t));break;case"minigun":c=this.findAiStructurePlacement(h,ti,t),c&&t.spendEnergy(Ii)&&t.buildings.push(new da(c,t))}}getAiStructureAnchor(t){if(!t.stellarForge)return null;if(0===t.solarMirrors.length||0===this.suns.length)return t.stellarForge.position;let e=null,i=1/0;for(const s of t.solarMirrors){const t=s.getClosestSun(this.suns);if(!t)continue;const o=s.position.distanceTo(t.position);o<i&&(i=o,e=s)}return e?e.position:t.stellarForge.position}findAiStructurePlacement(t,e,s){const o=s.buildings.length*os,n=ss+e;for(let s=0;s<8;s++){const r=o+os*s,a=new i(t.x+Math.cos(r)*n,t.y+Math.sin(r)*n);if(!this.checkCollision(a,e))return a}return null}findAiThreat(t,e){if(!t.stellarForge)return null;const i=[t.stellarForge.position];for(const e of t.solarMirrors)i.push(e.position);let s=null,o=null,n=1/0;const r=is*is;for(const t of i)for(const i of e){if("health"in i&&i.health<=0)continue;const e=i.position.x-t.x,a=i.position.y-t.y,l=e*e+a*a;l<=r&&l<n&&(n=l,s=i,o=t)}return s&&o?{enemy:s,guardPoint:o}:null}getClosestSunToPoint(t){let e=null,i=1/0;for(const s of this.suns){const o=t.distanceTo(s.position);o<i&&(i=o,e=s)}return e}getAiHeroTypesForFaction(t){switch(t){case Jr.RADIANT:return["Marine","Dagger","Beam","Mortar","Preist","Tank","Spotlight"];case Jr.AURUM:return["Driller"];case Jr.VELARIS:return["Grave","Ray","InfluenceBall","TurretDeployer"];default:return[]}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof wa;case"Grave":return t instanceof ba;case"Ray":return t instanceof Da;case"InfluenceBall":return t instanceof Oa;case"TurretDeployer":return t instanceof ka;case"Driller":return t instanceof Ua;case"Dagger":return t instanceof Ha;case"Beam":return t instanceof Wa;case"Mortar":return t instanceof za;case"Preist":return t instanceof Xa;case"Tank":return t instanceof Ka;case"Spotlight":return t instanceof $a;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}applyDustPushFromMovingEntity(t,e,i,s,o,n){const r=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));if(r<=0)return;const a=Math.max(r,J);this.applyFluidForceFromMovingObject(t,e,i,a*s,o,n)}applyFluidForceFromMovingObject(t,e,s,o,n,r){for(const a of this.spaceDust){const l=a.position.distanceTo(t);if(l<s&&l>U){const h=new i(a.position.x-t.x,a.position.y-t.y).normalize(),c=e.normalize(),d=N,g=B,u=new i(c.x*d+h.x*g,c.y*d+h.y*g),p=1-l/s,x=o*p*p;if(n){const t=Math.min(1,x/at);t>0&&a.applyImpactColor(n,t)}a.applyForce(new i(u.x*x*r,u.y*x*r))}}}applyFluidForceFromBeam(t,e,s,o,n,r){const a=t.distanceTo(e);if(a<U)return;const l=new i(e.x-t.x,e.y-t.y).normalize();for(const e of this.spaceDust){const h=new i(e.position.x-t.x,e.position.y-t.y),c=h.x*l.x+h.y*l.y,d=Math.max(0,Math.min(a,c)),g=new i(t.x+l.x*d,t.y+l.y*d),u=e.position.distanceTo(g);if(u<s&&u>U){const t=new i(e.position.x-g.x,e.position.y-g.y).normalize(),a=k,h=G,c=new i(l.x*a+t.x*h,l.y*a+t.y*h),d=1-u/s,p=o*d*d;if(n){const t=Math.min(1,p/at);t>0&&e.applyImpactColor(n,t)}e.applyForce(new i(c.x*p*r,c.y*p*r))}}}getPlayerImpactColor(t){const e=this.players.indexOf(t);return 0===e?r:1===e?a:r}initializeMirrorMovement(){if(0===this.suns.length)return;const t=this.suns[0];for(const e of this.players){if(!e.stellarForge||e.solarMirrors.length<2)continue;const s=e.stellarForge.position,o=s.x-t.position.x,n=s.y-t.position.y,r=Math.atan2(n,o),a=r+Math.PI/2,l=r-Math.PI/2;if(e.solarMirrors.length>=1){const t=new i(s.x+Math.cos(a)*Yt,s.y+Math.sin(a)*Yt);e.solarMirrors[0].setTarget(t)}if(e.solarMirrors.length>=2){const t=new i(s.x+Math.cos(l)*Yt,s.y+Math.sin(l)*Yt);e.solarMirrors[1].setTarget(t)}}}isPointInShadow(t){if(0===this.suns.length)return!0;for(const e of this.suns){const o=new i(e.position.x-t.x,e.position.y-t.y).normalize(),n=new s(t,o),r=t.distanceTo(e.position);let a=!0;for(const t of this.asteroids){const e=n.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<r){a=!1;break}}if(a)return!1}return!0}isObjectVisibleToPlayer(t,e,i){const s=this.suns.find(t=>"lad"===t.type);if(s)return this.isObjectVisibleInLadMode(t,e,i,s);if(i&&i instanceof Ha&&i.isCloakedToEnemies()&&i.owner!==e)return!1;if(!this.isPointInShadow(t))return!0;for(const i of e.units)if(i.position.distanceTo(t)<=Nt)return!0;return!!(e.stellarForge&&e.stellarForge.position.distanceTo(t)<=n)||!!this.isObjectRevealedBySpotlight(t,e)}getLadSide(t,e){return t.x<e.position.x?"light":"dark"}isObjectVisibleInLadMode(t,e,i,s){if(i&&i instanceof Ha&&i.isCloakedToEnemies()&&i.owner!==e)return!1;const o=e.stellarForge?this.getLadSide(e.stellarForge.position,s):"light",n=this.getLadSide(t,s);return!(i&&"owner"in i&&i.owner)||(i.owner===e||n===o||this.isObjectRevealedBySpotlight(t,e))}processRayBeamAbility(t){if(!t.drillDirection)return;const e=[];let s=new i(t.position.x,t.position.y),o=t.drillDirection.normalize(),n=0;const r=2e3;for(;n<go;){let a=null,l=r;for(const t of this.asteroids){const e=this.rayIntersectsAsteroid(s,o,t);if(e){const t=s.distanceTo(e);t<l&&(l=t,a={pos:e,type:"asteroid"})}}for(const e of this.players)if(e!==t.owner){for(const t of e.units){const e=this.rayIntersectsUnit(s,o,t.position);if(e){const i=s.distanceTo(e);i<l&&(l=i,a={pos:e,type:"unit",target:t})}}if(e.stellarForge){const t=this.rayIntersectsUnit(s,o,e.stellarForge.position,e.stellarForge.radius);if(t){const i=s.distanceTo(t);i<l&&(l=i,a={pos:t,type:"forge",target:e.stellarForge})}}}for(const t of this.suns){const e=this.rayIntersectsUnit(s,o,t.position,t.radius);if(e){const t=s.distanceTo(e);t<l&&(l=t,a={pos:e,type:"sun"})}}const h=this.rayIntersectsEdge(s,o);if(h&&s.distanceTo(h)<l&&(l=s.distanceTo(h),a={pos:h,type:"edge"}),!a){const n=new i(s.x+o.x*r,s.y+o.y*r);e.push(new va(s,n,t.owner));break}if(e.push(new va(s,a.pos,t.owner)),"unit"===a.type||"forge"===a.type){if(a.target){a.target.takeDamage(co);const t="forge"===a.type?Ue:a.target.maxHealth,e="forge"===a.type?`forge_${a.target.position.x}_${a.target.position.y}_${a.target.owner.name}`:`unit_${a.target.position.x}_${a.target.position.y}_${a.target.owner.name}`;this.addDamageNumber(a.target.position,co,t,a.target.health,e)}break}if("sun"===a.type||"edge"===a.type)break;"asteroid"===a.type&&(n++,s=a.pos,o=new i(-o.x,-o.y))}t.setBeamSegments(e)}updateSpotlightAbility(t,e,i){if(t.updateSpotlightState(i),!t.isSpotlightActive()||!t.spotlightDirection)return void t.setSpotlightRangePx(0);const s=this.getSpotlightMaxRangePx(t);t.setSpotlightRangePx(s);const o=s*t.spotlightLengthFactor;if(!t.canFireSpotlight()||o<=0)return;const n=this.getSpotlightTargetsInCone(t,e,o);if(n.length>0){const e=t.fireSpotlightAtTargets(n,o);e.length>0&&this.abilityBullets.push(...e)}}getSpotlightMaxRangePx(t){const e=t.spotlightDirection;if(!e)return 0;let i=1/0;const s=this.rayIntersectsEdge(t.position,e);s&&(i=t.position.distanceTo(s));for(const s of this.asteroids){const o=this.rayIntersectsAsteroid(t.position,e,s);if(o){const e=t.position.distanceTo(o);e<i&&(i=e)}}return Number.isFinite(i)?i:0}getSpotlightTargetsInCone(t,e,i){const s=[],o=t.spotlightDirection;if(!o)return s;const n=Math.atan2(o.y,o.x),r=mn/2,a=i*i;for(const i of e){const e=i.position.x-t.position.x,o=i.position.y-t.position.y;if(e*e+o*o>a)continue;let l=Math.atan2(o,e)-n;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;Math.abs(l)<=r&&s.push(i)}return s}isPositionInSpotlightCone(t,e,i){const s=t.spotlightDirection;if(!s)return!1;const o=e.x-t.position.x,n=e.y-t.position.y;if(o*o+n*n>i*i)return!1;const r=Math.atan2(s.y,s.x);let a=Math.atan2(n,o)-r;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;return Math.abs(a)<=mn/2}isObjectRevealedBySpotlight(t,e){for(const i of e.units){if(!(i instanceof $a))continue;if(!i.isSpotlightActive()||!i.spotlightDirection)continue;const e=i.spotlightRangePx*i.spotlightLengthFactor;if(!(e<=0)&&this.isPositionInSpotlightCone(i,t,e))return!0}return!1}rayIntersectsAsteroid(t,e,s){const o=new i(s.position.x-t.x,s.position.y-t.y),n=o.x*e.x+o.y*e.y;if(n<0)return null;const r=new i(t.x+e.x*n,t.y+e.y*n);return r.distanceTo(s.position)<60?r:null}rayIntersectsUnit(t,e,s,o=8){const n=new i(s.x-t.x,s.y-t.y),r=n.x*e.x+n.y*e.y;if(r<0)return null;const a=new i(t.x+e.x*r,t.y+e.y*r);return a.distanceTo(s)<o?a:null}rayIntersectsEdge(t,e){const s=this.mapSize;let o=null,n=1/0;const r=[{x:0,normal:new i(1,0)},{x:s,normal:new i(-1,0)},{y:0,normal:new i(0,1)},{y:s,normal:new i(0,-1)}];for(const s of r){let r=null;if("x"in s&&void 0!==s.x){if(Math.abs(e.x)>.001){const o=(s.x-t.x)/e.x;o>0&&(r=new i(s.x,t.y+e.y*o))}}else if("y"in s&&void 0!==s.y&&Math.abs(e.y)>.001){const o=(s.y-t.y)/e.y;o>0&&(r=new i(t.x+e.x*o,s.y))}if(r){const e=t.distanceTo(r);e<n&&(n=e,o=r)}}return o}processTurretDeployment(t){let e=null,s=1/0;for(const i of this.asteroids){const o=t.position.distanceTo(i.position);o<s&&o<200&&(s=o,e=i)}if(e){const s=new Ga(new i(e.position.x,e.position.y),t.owner,e);this.deployedTurrets.push(s)}}processDrillerCollisions(t,e){for(const e of this.suns)if(t.position.distanceTo(e.position)<e.radius+10)return t.health=0,void t.stopDrilling();for(const e of this.asteroids)if(e.containsPoint(t.position))return t.hideInAsteroid(e),void t.stopDrilling();for(const e of this.players)if(e!==t.owner){for(const i of e.units)if(t.position.distanceTo(i.position)<15){i.takeDamage(Wo);const t=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,Wo,i.maxHealth,i.health,t)}for(const i of e.buildings)if(t.position.distanceTo(i.position)<40){const t=Wo*zo;i.takeDamage(t);const s=`building_${i.position.x}_${i.position.y}_${e.name}`;this.addDamageNumber(i.position,t,i.maxHealth,i.health,s)}if(e.stellarForge&&t.position.distanceTo(e.stellarForge.position)<e.stellarForge.radius+10){const t=Wo*zo;e.stellarForge.health-=t;const i=`forge_${e.stellarForge.position.x}_${e.stellarForge.position.y}_${e.name}`;this.addDamageNumber(e.stellarForge.position,t,Ue,e.stellarForge.health,i)}}const i=this.mapSize;if(t.position.x<0||t.position.x>i||t.position.y<0||t.position.y>i){const s=Math.sqrt(Math.pow(t.drillVelocity.x,2)+Math.pow(t.drillVelocity.y,2));if(s>0){const i=Vo*e,o=Math.max(0,s-i);0===o?t.stopDrilling():(t.drillVelocity.x=t.drillVelocity.x/s*o,t.drillVelocity.y=t.drillVelocity.y/s*o)}t.position.x=Math.max(0,Math.min(i,t.position.x)),t.position.y=Math.max(0,Math.min(i,t.position.y))}}resolveUnitCollisions(t){for(let e=0;e<t.length;e++){const i=t[e];if(!i.isDead())for(let s=e+1;s<t.length;s++){const o=t[s];if(o.isDead())continue;let n=o.position.x-i.position.x,r=o.position.y-i.position.y,a=n*n+r*r;0===a&&(n=e%2==0?1:-1,r=0,a=1);const l=i.collisionRadiusPx+o.collisionRadiusPx;if(a<l*l){const t=Math.sqrt(a),e=l-t,s=n/t*e,h=r/t*e;i.isHero&&!o.isHero?(o.position.x+=s,o.position.y+=h):!i.isHero&&o.isHero?(i.position.x-=s,i.position.y-=h):(i.position.x-=.5*s,i.position.y-=.5*h,o.position.x+=.5*s,o.position.y+=.5*h)}}}}resolveUnitObstacleCollisions(t){for(const e of t){if(e.isDead())continue;const t=new i(e.position.x,e.position.y);if(this.checkCollision(e.position,e.collisionRadiusPx)){let i=0,s=0,o=0;for(const t of this.asteroids){const n=e.position.x-t.position.x,r=e.position.y-t.position.y,a=n*n+r*r,l=t.size+e.collisionRadiusPx+Rs;if(a<l*l||t.containsPoint(e.position)){const t=Math.sqrt(a)||1,e=(l-t)/l;i+=n/t*e,s+=r/t*e,o++}}for(const t of this.players)if(t.stellarForge){const n=t.stellarForge,r=e.position.x-n.position.x,a=e.position.y-n.position.y,l=Math.sqrt(r*r+a*a),h=n.radius+e.collisionRadiusPx;if(l<h){const t=(h-l)/h;i+=r/l*t,s+=a/l*t,o++}}for(const t of this.players)for(const n of t.solarMirrors){if(n.owner===e.owner)continue;const t=e.position.x-n.position.x,r=e.position.y-n.position.y,a=Math.sqrt(t*t+r*r),l=20+e.collisionRadiusPx;if(a<l){const e=(l-a)/l;i+=t/a*e,s+=r/a*e,o++}}for(const t of this.players)for(const n of t.buildings){const t=e.position.x-n.position.x,r=e.position.y-n.position.y,a=Math.sqrt(t*t+r*r),l=n.radius+e.collisionRadiusPx;if(a<l){const e=(l-a)/l;i+=t/a*e,s+=r/a*e,o++}}if(o>0){const o=Math.sqrt(i*i+s*s);if(o>0){const n=Math.min(this.MAX_PUSH_DISTANCE,o*this.PUSH_MULTIPLIER);e.position.x=t.x+i/o*n,e.position.y=t.y+s/o*n}}this.checkCollision(e.position,e.collisionRadiusPx)&&(e.position=t,e.rallyPoint&&this.checkCollision(e.rallyPoint,e.collisionRadiusPx)&&(e.rallyPoint=null))}this.clampUnitOutsideStructures(e)}}clampUnitOutsideStructures(t){for(const e of this.players){e.stellarForge&&this.pushUnitOutsideCircle(t,e.stellarForge.position,e.stellarForge.radius);for(const i of e.buildings)this.pushUnitOutsideCircle(t,i.position,i.radius)}}pushUnitOutsideCircle(t,e,i){const s=i+t.collisionRadiusPx+Fs,o=t.position.x-e.x,n=t.position.y-e.y,r=o*o+n*n;if(r<s*s){const i=Math.sqrt(r);if(i>0){const r=s/i;t.position.x=e.x+o*r,t.position.y=e.y+n*r}else t.position.x=e.x+s,t.position.y=e.y}}createHeroUnit(t,e,i){switch(t){case"Marine":return new wa(e,i);case"Grave":return new ba(e,i);case"Ray":return new Da(e,i);case"InfluenceBall":return new Oa(e,i);case"TurretDeployer":return new ka(e,i);case"Driller":return new Ua(e,i);case"Dagger":return new Ha(e,i);case"Beam":return new Wa(e,i);case"Mortar":return new za(e,i);case"Preist":return new Xa(e,i);case"Tank":return new Ka(e,i);case"Spotlight":return new $a(e,i);case"Nova":return new qa(e,i);case"Velaris":return new Za(e,i);default:return null}}checkCollision(t,e=Ps,i=null){for(const e of this.asteroids)if(e.containsPoint(t))return!0;for(const s of this.players){if(s.stellarForge){if(s.stellarForge===i)continue;if(t.distanceTo(s.stellarForge.position)<s.stellarForge.radius+e)return!0}for(const o of s.solarMirrors)if(o!==i&&t.distanceTo(o.position)<20+e)return!0;for(const o of s.buildings)if(o!==i&&t.distanceTo(o.position)<o.radius+e)return!0}return!1}getMirrorLightOnStructure(t,e){let o=0;for(const n of t.solarMirrors){if(n.getLinkedStructure(t.stellarForge)!==e)continue;if(!n.hasLineOfSightToLight(this.suns,this.asteroids))continue;const r=new s(n.position,new i(e.position.x-n.position.x,e.position.y-n.position.y).normalize(),1);let a=!0;for(const t of this.asteroids)if(r.intersectsPolygon(t.getWorldVertices())){a=!1;break}if(a){const t=this.suns.reduce((t,e)=>n.position.distanceTo(e.position)<(t?n.position.distanceTo(t.position):1/0)?e:t,null);if(t){const e=n.position.distanceTo(t.position);o+=Math.max(1,Us*(1-Math.min(1,e/Gs)))}}}return o}updateStateHash(){var t,e,i;let s=2166136261;const o=t=>{const e=Math.floor(100*t);s=Math.imul(s^e,16777619)},n=t=>{s=Math.imul(s^t,16777619)},r=t=>{n(t.length);for(let e=0;e<t.length;e++)n(t.charCodeAt(e))};o(this.gameTime),o(this.suns.length),o(this.asteroids.length),o(V),n(this.spaceDust.length);for(const e of this.spaceDust)o(e.position.x),o(e.position.y),o(e.velocity.x),o(e.velocity.y),o(e.glowTransition),n(e.glowState),n(e.targetGlowState),o(e.impactBlend),o(e.impactTargetBlend),o(e.impactHoldTimeSec),r(e.baseColor),r(null!==(t=e.impactColor)&&void 0!==t?t:"");for(const t of this.players){if(o(t.energy),n(t.isAi?1:0),o(t.aiNextMirrorCommandSec),o(t.aiNextDefenseCommandSec),o(t.aiNextHeroCommandSec),o(t.aiNextStructureCommandSec),o(t.aiNextMirrorPurchaseCommandSec),r(t.aiStrategy),n(t.hasStrafeUpgrade?1:0),n(t.hasRegenUpgrade?1:0),n(t.hasBlinkUpgrade?1:0),t.stellarForge){o(t.stellarForge.position.x),o(t.stellarForge.position.y),o(t.stellarForge.health),n(t.stellarForge.unitQueue.length);for(const e of t.stellarForge.unitQueue)r(e);r(null!==(e=t.stellarForge.heroProductionUnitType)&&void 0!==e?e:""),o(t.stellarForge.heroProductionRemainingSec),o(t.stellarForge.heroProductionDurationSec),o(t.stellarForge.crunchTimer),o(t.stellarForge.rotation),t.stellarForge.targetPosition?(o(t.stellarForge.targetPosition.x),o(t.stellarForge.targetPosition.y)):(o(-1),o(-1)),o(t.stellarForge.velocity.x),o(t.stellarForge.velocity.y)}else o(-1);for(const e of t.solarMirrors)o(e.position.x),o(e.position.y),o(e.health),o(e.efficiency),o(e.reflectionAngle),e.linkedStructure?(e.linkedStructure instanceof ha?n(1):n(2),o(e.linkedStructure.position.x),o(e.linkedStructure.position.y)):(n(0),o(-1),o(-1)),e.targetPosition?(o(e.targetPosition.x),o(e.targetPosition.y)):(o(-1),o(-1)),o(e.velocity.x),o(e.velocity.y);for(const e of t.units){o(e.position.x),o(e.position.y),o(e.velocity.x),o(e.velocity.y),o(e.rotation),o(e.health),o(e.isHero?1:0),o(e.collisionRadiusPx),n(e.moveOrder),e.rallyPoint?(o(e.rallyPoint.x),o(e.rallyPoint.y)):(o(-1),o(-1));const t=e.getManualTarget();t?(n(1),n(t instanceof ha?1:t instanceof ca?2:t instanceof Qr?3:4),o(t.position.x),o(t.position.y)):(n(0),o(-1),o(-1)),e instanceof ma&&(n(e.getAssignedPathLength()),n(e.getCurrentPathWaypointIndex()),n(e.hasActiveManualOrder()?1:0),o(e.getCurrentMoveSpeedPxPerSec()),o(e.abilityCooldown)),e instanceof $a&&(n(e.getSpotlightStateCode()),o(e.spotlightStateElapsedSec),o(e.spotlightFireCooldownSec),o(e.spotlightLengthFactor),o(e.spotlightRangePx),e.spotlightDirection?(o(e.spotlightDirection.x),o(e.spotlightDirection.y)):(o(-1),o(-1)))}for(const e of t.buildings)if(o(e.position.x),o(e.position.y),o(e.health),o(e.isComplete?1:0),e instanceof pa){o(e.productionProgress),r(null!==(i=e.currentProduction)&&void 0!==i?i:""),n(e.productionQueue.length);for(const t of e.productionQueue)r(t)}}n(this.starlingMergeGates.length);for(const t of this.starlingMergeGates)o(t.position.x),o(t.position.y),o(t.remainingSec),o(t.health),n(t.absorbedCount),n(t.assignedStarlings.length),n(this.players.indexOf(t.owner));n(this.warpGates.length);for(const t of this.warpGates)o(t.position.x),o(t.position.y),o(t.chargeTime),o(t.accumulatedEnergy),n(t.isCharging?1:0),n(t.isComplete?1:0),n(t.isCancelling?1:0),n(t.hasDissipated?1:0),o(t.completionRemainingSec),o(t.health),n(this.players.indexOf(t.owner));n(this.minionProjectiles.length);for(const t of this.minionProjectiles)o(t.position.x),o(t.position.y),o(t.velocity.x),o(t.velocity.y),o(t.damage),o(t.distanceTraveledPx),o(t.maxRangePx),n(this.players.indexOf(t.owner));n(this.muzzleFlashes.length);for(const t of this.muzzleFlashes)o(t.position.x),o(t.position.y),o(t.angle),o(t.lifetime),o(t.maxLifetime);n(this.bulletCasings.length);for(const t of this.bulletCasings)o(t.position.x),o(t.position.y),o(t.velocity.x),o(t.velocity.y),o(t.rotation),o(t.rotationSpeed),o(t.lifetime),o(t.maxLifetime);n(this.bouncingBullets.length);for(const t of this.bouncingBullets)o(t.position.x),o(t.position.y),o(t.velocity.x),o(t.velocity.y),o(t.lifetime),o(t.maxLifetime);this.stateHash=s>>>0}initializeSpaceDust(t,e,s,o){this.spaceDust=[];const n=K,r=j,a=q,l=[];for(let t=0;t<n;t++){const t=(Math.random()-.5)*e,o=(Math.random()-.5)*s;l.push(new i(t,o))}for(let n=0;n<t;n++){let t=0,n=0;if(Math.random()<a&&l.length>0){const e=l[Math.floor(Math.random()*l.length)],i=Math.random()*Math.PI*2,s=Math.sqrt(Math.random())*r;t=e.x+Math.cos(i)*s,n=e.y+Math.sin(i)*s}else t=(Math.random()-.5)*e,n=(Math.random()-.5)*s;this.spaceDust.push(new Zr(new i(t,n),void 0,o))}}initializeAsteroids(t,e,s){this.asteroids=[];for(let o=0;o<t;o++){let t=!1,o=0,n=0,r=0,a=0;for(;!t&&o<50;){const i=Math.random()*Math.PI*2,l=200+Math.random()*(Math.min(e,s)/2-300);n=Math.cos(i)*l,r=Math.sin(i)*l,a=Ut+Math.random()*(80-Ut),t=!0;for(const e of this.asteroids){const i=n-e.position.x,s=r-e.position.y;if(Math.sqrt(i*i+s*s)<a+e.size){t=!1;break}}o++}if(t){const t=3+Math.floor(7*Math.random());this.asteroids.push(new Ca(new i(n,r),t,a))}}}checkVictoryConditions(){const t=this.players.filter(t=>!t.isDefeated());return 1===t.length?t[0]:null}initializePlayer(t,e,i){t.stellarForge=new ha(e,t);for(const e of i){const i=new Qr(e,t);t.solarMirrors.push(i)}}addDamageNumber(t,e,i,s,o=null){const n=Math.max(0,s);"remaining-life"===this.damageDisplayMode&&null!==o&&(this.damageNumbers=this.damageNumbers.filter(t=>t.unitId!==o)),this.damageNumbers.push(new Ma(t,e,this.gameTime,i,n,o))}setupNetworkManager(t,e){this.networkManager=t,this.localPlayerIndex=e,this.networkManager.on(Ta.MESSAGE_RECEIVED,t=>{if(t&&"object"==typeof t&&"type"in t&&t.type===Aa.GAME_COMMAND){const e=t.data;this.receiveNetworkCommand(e)}})}sendGameCommand(t,e){if(!this.networkManager)return;const i={tick:Math.floor(60*this.gameTime),playerId:this.networkManager.getLocalPlayerId(),command:t,data:e};this.networkManager.sendGameCommand(i)}receiveNetworkCommand(t){this.pendingCommands.push(t)}processPendingNetworkCommands(){if(0!==this.pendingCommands.length){this.pendingCommands.sort((t,e)=>t.tick-e.tick);for(const t of this.pendingCommands)this.executeNetworkCommand(t);this.pendingCommands=[]}}executeNetworkCommand(t){const e=0===this.localPlayerIndex?1:0,i=this.players[e];if(i)switch(t.command){case"unit_move":this.executeUnitMoveCommand(i,t.data);break;case"unit_target_structure":this.executeUnitTargetStructureCommand(i,t.data);break;case"unit_ability":this.executeUnitAbilityCommand(i,t.data);break;case"unit_path":this.executeUnitPathCommand(i,t.data);break;case"hero_purchase":this.executeHeroPurchaseCommand(i,t.data);break;case"building_purchase":this.executeBuildingPurchaseCommand(i,t.data);break;case"mirror_purchase":this.executeMirrorPurchaseCommand(i,t.data);break;case"mirror_move":this.executeMirrorMoveCommand(i,t.data);break;case"mirror_link":this.executeMirrorLinkCommand(i,t.data);break;case"starling_merge":this.executeStarlingMergeCommand(i,t.data);break;case"foundry_production":this.executeFoundryProductionCommand(i,t.data);break;case"foundry_strafe_upgrade":this.executeFoundryUpgradeCommand(i,t.data,"strafe");break;case"foundry_regen_upgrade":this.executeFoundryUpgradeCommand(i,t.data,"regen");break;case"forge_blink_upgrade":this.executeForgeBlinkUpgradeCommand(i);break;case"forge_move":this.executeForgeMoveCommand(i,t.data);break;case"set_rally_path":this.executeSetRallyPathCommand(i,t.data);break;default:console.warn("Unknown network command:",t.command)}}executeUnitMoveCommand(t,e){const{unitIds:s,targetX:o,targetY:n,moveOrder:r}=e,a=new i(o,n);for(const e of s){const i=t.units.find(t=>this.getUnitNetworkId(t)===e);i?(i.clearManualTarget(),i instanceof ma?i.setManualRallyPoint(a):i.rallyPoint=a,"number"==typeof r&&(i.moveOrder=r)):console.warn(`Unit not found for network command: ${e}`)}}executeUnitTargetStructureCommand(t,e){var i,s,o;const{unitIds:n,targetPlayerIndex:r,structureType:a,structureIndex:l,moveOrder:h}=e,c=this.players[r];if(!c)return void console.warn("Target player not found for unit target command.");let d=null;if("forge"===a?d=null!==(i=c.stellarForge)&&void 0!==i?i:null:"building"===a?d=null!==(s=c.buildings[l])&&void 0!==s?s:null:"mirror"===a&&(d=null!==(o=c.solarMirrors[l])&&void 0!==o?o:null),d)for(const e of null!=n?n:[]){const i=t.units.find(t=>this.getUnitNetworkId(t)===e);if(i){const t=this.getCombatTargetRadiusPx(d),e=i.getStructureStandoffPoint(d.position,t);i.setManualTarget(d,e),"number"==typeof h&&(i.moveOrder=h)}else console.warn(`Unit not found for network command: ${e}`)}else console.warn("Target structure not found for unit target command.")}createDeathParticles(t,e){let s,o;t instanceof ca?(s=Math.floor(11*Math.random())+10,o=16):t.isHero?(s=Math.floor(11*Math.random())+10,o=12):(s=Math.floor(5*Math.random())+4,o=8);const n=10*Math.random()+5;for(let r=0;r<s;r++){const a=2*Math.PI*r/s+.5*(Math.random()-.5),l=50+100*Math.random(),h=new i(Math.cos(a)*l,Math.sin(a)*l),c=document.createElement("canvas"),d=o+Math.random()*o;c.width=d,c.height=d;const g=c.getContext("2d");g&&(g.fillStyle=e,g.fillRect(0,0,d,d));const u=new la(new i(t.position.x,t.position.y),h,Math.random()*Math.PI*2,c,n);this.deathParticles.push(u)}}getCombatTargetRadiusPx(t){return t instanceof Qr?ks:"radius"in t?t.radius:0}executeUnitAbilityCommand(t,e){const{unitId:s,directionX:o,directionY:n}=e,r=new i(o,n),a=t.units.find(t=>this.getUnitNetworkId(t)===s);a?a.useAbility(r):console.warn(`Unit not found for ability command: ${s}`)}executeUnitPathCommand(t,e){const{unitIds:s,waypoints:o,moveOrder:n}=e,r=(null!=o?o:[]).map(t=>new i(t.x,t.y));for(const e of null!=s?s:[]){const i=t.units.find(t=>this.getUnitNetworkId(t)===e);i?(i.clearManualTarget(),i.setPath(r),"number"==typeof n&&(i.moveOrder=n)):console.warn(`Unit not found for path command: ${e}`)}}executeHeroPurchaseCommand(t,e){const{heroType:i}=e;t.stellarForge&&(t.stellarForge.enqueueHeroUnit(i),t.stellarForge.startHeroProductionIfIdle())}executeBuildingPurchaseCommand(t,e){const{buildingType:s,positionX:o,positionY:n}=e,r=new i(o,n);if(["Minigun","Cannon","Gatling","GatlingTower","SpaceDustSwirler"].includes(s)&&t.faction!==Jr.RADIANT)return;let a=0;"Minigun"===s||"Cannon"===s?a=Ii:"Gatling"===s||"GatlingTower"===s?a=Ci:"SpaceDustSwirler"===s?a=Mi:"SubsidiaryFactory"!==s&&"Foundry"!==s||(a=Ri),t.spendEnergy(a)&&("Minigun"===s||"Cannon"===s?t.buildings.push(new da(r,t)):"Gatling"===s||"GatlingTower"===s?t.buildings.push(new ga(r,t)):"SpaceDustSwirler"===s?t.buildings.push(new ua(r,t)):"SubsidiaryFactory"!==s&&"Foundry"!==s||t.buildings.push(new pa(r,t)))}executeMirrorPurchaseCommand(t,e){}executeMirrorMoveCommand(t,e){const{mirrorIndices:s,targetX:o,targetY:n,moveOrder:r}=e,a=new i(o,n);for(const e of null!=s?s:[]){const i=t.solarMirrors[e];i&&(i.setTarget(a),"number"==typeof r&&(i.moveOrder=r))}}executeMirrorLinkCommand(t,e){var i,s;const{mirrorIndices:o,structureType:n,buildingIndex:r}=e;let a=null;"forge"===n?a=null!==(i=t.stellarForge)&&void 0!==i?i:null:"building"===n&&(a=null!==(s=t.buildings[r])&&void 0!==s?s:null);for(const e of null!=o?o:[]){const i=t.solarMirrors[e];i&&i.setLinkedStructure(a)}}executeStarlingMergeCommand(t,e){const{unitIds:s,targetX:o,targetY:n}=e;if(!Array.isArray(s))return;const r=new i(o,n);this.applyStarlingMerge(t,s,r)}applyStarlingMerge(t,e,i){if(!t.buildings.some(t=>t instanceof pa))return;const s=[];for(const i of e){if(s.length>=Bi)break;const e=t.units.find(t=>this.getUnitNetworkId(t)===i);e instanceof ma&&!e.isDead()&&s.push(e)}if(!(s.length<Bi)){for(const t of s)t.clearManualTarget(),t.setManualRallyPoint(i);this.starlingMergeGates.push(new fa(i,t,s))}}executeFoundryProductionCommand(t,e){const{buildingId:i,itemType:s}=e,o=t.buildings[i];o instanceof pa&&o.isComplete}executeFoundryUpgradeCommand(t,e,i){const{buildingId:s}=e,o=t.buildings[s];o instanceof pa&&o.isComplete&&("strafe"!==i?o.canQueueRegenUpgrade()&&t.spendEnergy(Fi)&&o.enqueueProduction(vi):o.canQueueStrafeUpgrade()&&t.spendEnergy(Li)&&o.enqueueProduction(Di))}executeForgeBlinkUpgradeCommand(t){t.hasBlinkUpgrade||t.spendEnergy(Ni)&&(t.hasBlinkUpgrade=!0)}executeForgeMoveCommand(t,e){const{targetX:s,targetY:o,moveOrder:n}=e,r=new i(s,o);t.stellarForge&&(t.stellarForge.targetPosition=r,"number"==typeof n&&(t.stellarForge.moveOrder=n))}executeSetRallyPathCommand(t,e){const{waypoints:s}=e,o=s.map(t=>new i(t.x,t.y));t.stellarForge&&t.stellarForge.setMinionPath(o)}getUnitNetworkId(t){return`${this.players.indexOf(t.owner)}_${t.position.x.toFixed(1)}_${t.position.y.toFixed(1)}_${t.maxHealth}_${t.constructor.name}`}}const{Marine:wa}=(t=>{const{Unit:e,Vector2D:i,Constants:s,MuzzleFlash:o,BulletCasing:n,BouncingBullet:r,AbilityBullet:a}=t;return{Marine:class extends e{constructor(t,e){super(t,e,s.MARINE_MAX_HEALTH,s.MARINE_ATTACK_RANGE,s.MARINE_ATTACK_DAMAGE,s.MARINE_ATTACK_SPEED,s.MARINE_ABILITY_COOLDOWN),this.lastShotEffects={},this.isHero=!0}attack(t){super.attack(t);const e=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.atan2(a,e);this.lastShotEffects.muzzleFlash=new o(new i(this.position.x,this.position.y),l);const h=l+Math.PI/2+.5*(Math.random()-.5),c=s.BULLET_CASING_SPEED_MIN+Math.random()*(s.BULLET_CASING_SPEED_MAX-s.BULLET_CASING_SPEED_MIN);this.lastShotEffects.casing=new n(new i(this.position.x,this.position.y),new i(Math.cos(h)*c,Math.sin(h)*c));const d=l+Math.PI+1*(Math.random()-.5),g=s.BOUNCING_BULLET_SPEED_MIN+Math.random()*(s.BOUNCING_BULLET_SPEED_MAX-s.BOUNCING_BULLET_SPEED_MIN);this.lastShotEffects.bouncingBullet=new r(new i(t.position.x,t.position.y),new i(Math.cos(d)*g,Math.sin(d)*g))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}useAbility(t){if(!super.useAbility(t))return!1;const e=Math.atan2(t.y,t.x),o=s.MARINE_ABILITY_SPREAD_ANGLE,n=s.MARINE_ABILITY_BULLET_COUNT;for(let t=0;t<n;t++){const r=e+(t/Math.max(n-1,1)-.5)*o*2,l=s.MARINE_ABILITY_BULLET_SPEED,h=new i(Math.cos(r)*l,Math.sin(r)*l),c=new a(new i(this.position.x,this.position.y),h,this.owner);this.lastAbilityEffects.push(c)}return!0}}}})({Unit:ya,Vector2D:i,Constants:e,MuzzleFlash:ia,BulletCasing:ea,BouncingBullet:sa,AbilityBullet:oa}),{Grave:ba,GraveProjectile:La,GraveSmallParticle:Fa}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class o{constructor(t,e,i){this.position=t,this.progress=0,this.currentTargetIndex=e,this.nextTargetIndex=i}update(t,e){if(e.length<2)return;const i=e[this.currentTargetIndex%e.length],o=e[this.nextTargetIndex%e.length],n=i.distanceTo(o);if(n>.1?this.progress+=s.GRAVE_SMALL_PARTICLE_SPEED/n*t:this.progress=1,this.progress>=1){this.progress=0,this.currentTargetIndex=this.nextTargetIndex;do{this.nextTargetIndex=Math.floor(Math.random()*e.length)}while(this.nextTargetIndex===this.currentTargetIndex&&e.length>1)}this.position.x=i.x+(o.x-i.x)*this.progress,this.position.y=i.y+(o.y-i.y)*this.progress}}class n{constructor(t,e,i,o){this.position=t,this.owner=i,this.index=o,this.lifetime=0,this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.velocity=e,this.targetAngle=o/s.GRAVE_NUM_PROJECTILES*Math.PI*2}update(t,e){if(this.isAttacking)this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;else{const i=e.x+Math.cos(this.targetAngle)*s.GRAVE_PROJECTILE_ORBIT_RADIUS,o=e.y+Math.sin(this.targetAngle)*s.GRAVE_PROJECTILE_ORBIT_RADIUS,n=i-this.position.x,r=o-this.position.y,a=Math.sqrt(n*n+r*r);if(a>0){const e=s.GRAVE_PROJECTILE_MIN_SPEED,i=Math.min(e*t,a);this.position.x+=n/a*i,this.position.y+=r/a*i,this.velocity.x=n/a*e,this.velocity.y=r/a*e}}this.isAttacking&&(this.trail.push(new i(this.position.x,this.position.y)),this.trail.length>s.GRAVE_PROJECTILE_TRAIL_LENGTH&&this.trail.shift(),this.lifetime+=t,!this.targetEnemy&&this.lifetime>2&&this.returnToOrbit()),this.isAttacking&&this.targetEnemy&&this.position.distanceTo(this.targetEnemy.position)<s.GRAVE_PROJECTILE_HIT_DISTANCE&&("health"in this.targetEnemy&&(this.targetEnemy.health-=s.GRAVE_ATTACK_DAMAGE),this.returnToOrbit())}launchAtTarget(t){this.isAttacking=!0,this.targetEnemy=t,this.trail=[],this.lifetime=0;const e=t.position.x-this.position.x,i=t.position.y-this.position.y,o=Math.sqrt(e*e+i*i);if(o>0){const t=e/o,n=i/o;this.velocity.x=t*s.GRAVE_PROJECTILE_LAUNCH_SPEED,this.velocity.y=n*s.GRAVE_PROJECTILE_LAUNCH_SPEED}}launchInDirection(t){this.isAttacking=!0,this.targetEnemy=null,this.trail=[],this.lifetime=0,this.velocity.x=t.x*s.GRAVE_PROJECTILE_LAUNCH_SPEED,this.velocity.y=t.y*s.GRAVE_PROJECTILE_LAUNCH_SPEED}returnToOrbit(){this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.lifetime=0}}return{Grave:class extends e{constructor(t,e){super(t,e,s.GRAVE_MAX_HEALTH,s.GRAVE_ATTACK_RANGE*s.GRAVE_HERO_ATTACK_RANGE_MULTIPLIER,s.GRAVE_ATTACK_DAMAGE,s.GRAVE_ATTACK_SPEED,5),this.projectiles=[],this.smallParticles=[],this.smallParticleCount=s.GRAVE_MAX_SMALL_PARTICLES,this.projectileLaunchCooldown=0,this.smallParticleRegenTimer=0,this.isUsingAbility=!1,this.isHero=!0;for(let o=0;o<s.GRAVE_NUM_PROJECTILES;o++){const r=o/s.GRAVE_NUM_PROJECTILES*Math.PI*2,a=Math.cos(r)*s.GRAVE_PROJECTILE_ORBIT_RADIUS,l=Math.sin(r)*s.GRAVE_PROJECTILE_ORBIT_RADIUS;this.projectiles.push(new n(new i(t.x+a,t.y+l),new i(0,0),e,o))}this.initializeSmallParticles()}initializeSmallParticles(){this.smallParticles=[];const t=Math.floor(this.smallParticleCount);for(let e=0;e<t;e++){const t=e%this.projectiles.length,s=(e+1)%this.projectiles.length,n=this.projectiles[t].position;this.smallParticles.push(new o(new i(n.x,n.y),t,s))}}update(t,e,n,r=[]){super.update(t,e,n,r),this.smallParticleRegenTimer+=t;const a=1/s.GRAVE_SMALL_PARTICLE_REGEN_RATE;for(;this.smallParticleRegenTimer>=a&&this.smallParticleCount<s.GRAVE_MAX_SMALL_PARTICLES;)if(this.smallParticleCount++,this.smallParticleRegenTimer-=a,this.smallParticles.length<Math.floor(this.smallParticleCount)){const t=this.smallParticles.length%this.projectiles.length,e=(this.smallParticles.length+1)%this.projectiles.length,s=this.projectiles[t].position;this.smallParticles.push(new o(new i(s.x,s.y),t,e))}this.projectileLaunchCooldown>0&&(this.projectileLaunchCooldown-=t);const l=this.projectiles.map(t=>t.position);for(const e of this.projectiles)e.update(t,this.position);for(const e of this.smallParticles)e.update(t,l);if(this.canLaunchProjectile()&&this.position.distanceTo(this.target.position)<=this.attackRange){const t=this.projectiles.find(t=>!t.isAttacking);if(t){t.launchAtTarget(this.target),this.projectileLaunchCooldown=1/this.attackSpeed,this.smallParticleCount-=s.GRAVE_SMALL_PARTICLES_PER_ATTACK;const e=s.GRAVE_SMALL_PARTICLES_PER_ATTACK;this.smallParticles.splice(0,Math.min(e,this.smallParticles.length))}}}canLaunchProjectile(){return!this.isUsingAbility&&null!==this.target&&this.projectileLaunchCooldown<=0&&this.smallParticleCount>=s.GRAVE_SMALL_PARTICLES_PER_ATTACK}attack(t){}useAbility(t){if(!super.useAbility(t))return!1;const e=this.projectiles.filter(t=>!t.isAttacking);if(0===e.length)return!1;for(const i of e)i.launchInDirection(t);const i=Math.min(this.smallParticleCount,s.GRAVE_MAX_SMALL_PARTICLES);return this.smallParticleCount-=i,this.smallParticles=[],this.isUsingAbility=!1,!0}startAbilityDrag(){this.isUsingAbility=!0}endAbilityDrag(){this.isUsingAbility=!1}getProjectiles(){return this.projectiles}getSmallParticles(){return this.smallParticles}getSmallParticleCount(){return this.smallParticleCount}},GraveProjectile:n,GraveSmallParticle:o}})({Unit:ya,Vector2D:i,Constants:e}),{Ray:Da,RayBeamSegment:va}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;return{Ray:class extends e{constructor(t,e){super(t,e,s.RAY_MAX_HEALTH,s.RAY_ATTACK_RANGE,s.RAY_ATTACK_DAMAGE,s.RAY_ATTACK_SPEED,s.RAY_ABILITY_COOLDOWN),this.beamSegments=[],this.drillDirection=null,this.isHero=!0}useAbility(t){return!!super.useAbility(t)&&(this.drillDirection=t,!0)}getBeamSegments(){return this.beamSegments}setBeamSegments(t){this.beamSegments=t}updateBeamSegments(t){this.beamSegments=this.beamSegments.filter(e=>!e.update(t))}},RayBeamSegment:class{constructor(t,e,i){this.startPos=t,this.endPos=e,this.owner=i,this.lifetime=0,this.maxLifetime=.5}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}}})({Unit:ya,Vector2D:i,Constants:e}),{InfluenceBall:Oa,InfluenceZone:Na,InfluenceBallProjectile:Ba}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class o{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.maxLifetime=5,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldExplode(){return this.lifetime>=this.maxLifetime}}return{InfluenceBall:class extends e{constructor(t,e){super(t,e,s.INFLUENCE_BALL_MAX_HEALTH,s.INFLUENCE_BALL_ATTACK_RANGE,s.INFLUENCE_BALL_ATTACK_DAMAGE,s.INFLUENCE_BALL_ATTACK_SPEED,s.INFLUENCE_BALL_ABILITY_COOLDOWN),this.projectileToCreate=null,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const e=new i(t.x*s.INFLUENCE_BALL_PROJECTILE_SPEED,t.y*s.INFLUENCE_BALL_PROJECTILE_SPEED);return this.projectileToCreate=new o(new i(this.position.x,this.position.y),e,this.owner),!0}getAndClearProjectile(){const t=this.projectileToCreate;return this.projectileToCreate=null,t}},InfluenceZone:class{constructor(t,e,i=s.INFLUENCE_BALL_EXPLOSION_RADIUS,o=s.INFLUENCE_BALL_DURATION){this.position=t,this.owner=e,this.radius=i,this.duration=o,this.lifetime=0}update(t){return this.lifetime+=t,this.lifetime>=this.duration}isExpired(){return this.lifetime>=this.duration}},InfluenceBallProjectile:o}})({Unit:ya,Vector2D:i,Constants:e}),{TurretDeployer:ka,DeployedTurret:Ga}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;return{TurretDeployer:class extends e{constructor(t,e){super(t,e,s.TURRET_DEPLOYER_MAX_HEALTH,s.TURRET_DEPLOYER_ATTACK_RANGE,s.TURRET_DEPLOYER_ATTACK_DAMAGE,s.TURRET_DEPLOYER_ATTACK_SPEED,s.TURRET_DEPLOYER_ABILITY_COOLDOWN),this.isHero=!0}useAbility(t){return!!super.useAbility(t)}},DeployedTurret:class{constructor(t,e,i=null){this.position=t,this.owner=e,this.attachedToAsteroid=i,this.maxHealth=s.DEPLOYED_TURRET_MAX_HEALTH,this.attackCooldown=0,this.target=null,this.firingAnimationProgress=0,this.isFiring=!1,this.health=this.maxHealth}update(t,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.isFiring&&(this.firingAnimationProgress+=t/s.DEPLOYED_TURRET_ANIMATION_DURATION,this.firingAnimationProgress>=1&&(this.firingAnimationProgress=0,this.isFiring=!1)),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=s.DEPLOYED_TURRET_ATTACK_RANGE&&(this.attack(this.target),this.attackCooldown=1/s.DEPLOYED_TURRET_ATTACK_SPEED,this.isFiring=!0,this.firingAnimationProgress=0)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=s.DEPLOYED_TURRET_ATTACK_DAMAGE)}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}}})({Unit:ya,Vector2D:i,Constants:e}),{Driller:Ua}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;return{Driller:class extends e{constructor(t,e){super(t,e,s.DRILLER_MAX_HEALTH,s.DRILLER_ATTACK_RANGE,s.DRILLER_ATTACK_DAMAGE,s.DRILLER_ATTACK_SPEED,s.DRILLER_ABILITY_COOLDOWN),this.isDrilling=!1,this.isHidden=!1,this.drillDirection=null,this.drillVelocity=new i(0,0),this.hiddenInAsteroid=null,this.isHero=!0}attack(t){}useAbility(t){return!this.isDrilling&&!!super.useAbility(t)&&(this.isDrilling=!0,this.isHidden=!1,this.drillDirection=t.normalize(),this.drillVelocity=new i(this.drillDirection.x*s.DRILLER_DRILL_SPEED,this.drillDirection.y*s.DRILLER_DRILL_SPEED),!0)}updateDrilling(t){this.isDrilling&&this.drillVelocity&&(this.position.x+=this.drillVelocity.x*t,this.position.y+=this.drillVelocity.y*t)}stopDrilling(){this.isDrilling=!1,this.drillVelocity=new i(0,0)}hideInAsteroid(t){this.isHidden=!0,this.hiddenInAsteroid=t,this.position=new i(t.position.x,t.position.y)}isHiddenInAsteroid(){return this.isHidden}}}})({Unit:ya,Vector2D:i,Constants:e}),{Dagger:Ha}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:o}=t;return{Dagger:class extends e{constructor(t,e){super(t,e,s.DAGGER_MAX_HEALTH,s.DAGGER_ATTACK_RANGE,s.DAGGER_ATTACK_DAMAGE,s.DAGGER_ATTACK_SPEED,s.DAGGER_ABILITY_COOLDOWN),this.isCloaked=!0,this.visibilityTimer=0,this.canSeeEnemies=!1,this.enemyVisionTimer=0,this.isHero=!0}updateTimers(t){this.visibilityTimer>0&&(this.visibilityTimer-=t,this.visibilityTimer<=0&&(this.visibilityTimer=0,this.isCloaked=!0)),this.enemyVisionTimer>0&&(this.enemyVisionTimer-=t,this.enemyVisionTimer<=0&&(this.enemyVisionTimer=0,this.canSeeEnemies=!1))}useAbility(t){if(!super.useAbility(t))return!1;this.isCloaked=!1,this.visibilityTimer=s.DAGGER_VISIBILITY_DURATION,this.canSeeEnemies=!0,this.enemyVisionTimer=s.DAGGER_VISIBILITY_DURATION;const e=t.normalize(),n=Math.atan2(e.y,e.x),r=new i(400*Math.cos(n),400*Math.sin(n)),a=new o(new i(this.position.x,this.position.y),r,this.owner,s.DAGGER_ABILITY_DAMAGE);return a.maxRange=s.DAGGER_ABILITY_RANGE,this.lastAbilityEffects.push(a),!0}update(t,e,i,s=[]){let o=e;this.canSeeEnemies||(o=[]),super.update(t,o,i,s)}isCloakedToEnemies(){return this.isCloaked}hasEnemyVision(){return this.canSeeEnemies}}}})({Unit:ya,Vector2D:i,Constants:e,AbilityBullet:oa}),{Beam:Wa}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:o}=t;return{Beam:class extends e{constructor(t,e){super(t,e,s.BEAM_MAX_HEALTH,s.BEAM_ATTACK_RANGE,s.BEAM_ATTACK_DAMAGE,s.BEAM_ATTACK_SPEED,s.BEAM_ABILITY_COOLDOWN),this.lastBeamDamage=0,this.lastBeamDistance=0,this.lastBeamMultiplier=0,this.lastBeamTime=0,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const e=t.normalize(),n=new i(1e3*e.x,1e3*e.y),r=new o(new i(this.position.x,this.position.y),n,this.owner,s.BEAM_ABILITY_BASE_DAMAGE);return r.maxRange=s.BEAM_ABILITY_MAX_RANGE,r.isBeamProjectile=!0,r.beamOwner=this,this.lastAbilityEffects.push(r),!0}}}})({Unit:ya,Vector2D:i,Constants:e,AbilityBullet:oa}),{Mortar:za,MortarProjectile:Va}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class o{constructor(t,e,i,s,o){this.position=t,this.owner=i,this.damage=s,this.splashRadius=o,this.lifetime=0,this.maxLifetime=3,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}checkHit(t){return this.position.distanceTo(t.position)<15}applySplashDamage(t){const e=[];for(const i of t){const t=this.position.distanceTo(i.position);if(t<=this.splashRadius){const o=1-t/this.splashRadius*(1-s.MORTAR_SPLASH_DAMAGE_FALLOFF),n=this.damage*o;"health"in i&&(i.health-=n,e.push(i))}}return e}}return{Mortar:class extends e{constructor(t,e){super(t,e,s.MORTAR_MAX_HEALTH,s.MORTAR_ATTACK_RANGE,s.MORTAR_ATTACK_DAMAGE,s.MORTAR_ATTACK_SPEED,s.MORTAR_ABILITY_COOLDOWN),this.isSetup=!1,this.facingDirection=null,this.lastShotProjectiles=[],this.isHero=!0}useAbility(t){return this.facingDirection=t.normalize(),this.isSetup=!0,!0}update(t,e,i,s=[]){if(!this.isSetup||!this.facingDirection)return this.attackCooldown>0&&(this.attackCooldown-=t),void(this.abilityCooldown>0&&(this.abilityCooldown-=t));const o=this.getEnemiesInCone(e);super.update(t,o,i,s)}getEnemiesInCone(t){if(!this.facingDirection)return[];const e=[],i=Math.atan2(this.facingDirection.y,this.facingDirection.x),o=s.MORTAR_DETECTION_CONE_ANGLE/2;for(const s of t){const t=s.position.x-this.position.x,n=s.position.y-this.position.y;let r=Math.atan2(n,t)-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;Math.abs(r)<=o&&e.push(s)}return e}attack(t){const e=t.position.x-this.position.x,n=t.position.y-this.position.y,r=Math.atan2(n,e),a=s.MORTAR_PROJECTILE_SPEED,l=new i(Math.cos(r)*a,Math.sin(r)*a),h=new o(new i(this.position.x,this.position.y),l,this.owner,this.attackDamage,s.MORTAR_SPLASH_RADIUS);this.lastShotProjectiles.push(h)}getAndClearLastShotProjectiles(){const t=this.lastShotProjectiles;return this.lastShotProjectiles=[],t}isReadyToFire(){return this.isSetup&&null!==this.facingDirection}getFacingDirection(){return this.facingDirection}},MortarProjectile:o}})({Unit:ya,Vector2D:i,Constants:e}),{Preist:Xa,HealingBombParticle:Ya}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:o}=t;class n{constructor(t,e,i){this.position=t,this.velocity=e,this.owner=i,this.lifetime=0,this.maxLifetime=s.PREIST_HEALING_BOMB_PARTICLE_LIFETIME,this.hasHealed=new Set}update(t){return this.lifetime+=t,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime>=this.maxLifetime}}return{Preist:class extends e{constructor(t,e){super(t,e,s.PREIST_MAX_HEALTH,s.PREIST_HEALING_RANGE,s.PREIST_ATTACK_DAMAGE,s.PREIST_ATTACK_SPEED,s.PREIST_ABILITY_COOLDOWN),this.beamTargets=[],this.healingBombParticles=[],this.isHero=!0;for(let t=0;t<s.PREIST_NUM_BEAMS;t++)this.beamTargets.push({target:null,lockTimer:0})}update(t,e,i,o=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.moveTowardRallyPoint(t,s.UNIT_MOVE_SPEED,i,o);const n=this.getFriendlyUnits(i);if(this.updateHealingBeams(t,n),this.updateHealingBombParticles(t,i),this.beamTargets[0].target&&!this.isTargetDead(this.beamTargets[0].target)){const e=this.beamTargets[0].target,i=e.position.x-this.position.x,o=e.position.y-this.position.y,n=Math.atan2(o,i)+Math.PI/2,r=this.getShortestAngleDelta(this.rotation,n),a=s.UNIT_TURN_SPEED_RAD_PER_SEC*t;Math.abs(r)<=a?this.rotation=n:this.rotation+=Math.sign(r)*a,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}getFriendlyUnits(t){return t.filter(t=>t.owner===this.owner&&t!==this&&!t.isDead())}updateHealingBeams(t,e){for(const e of this.beamTargets)if(e.lockTimer>0&&(e.lockTimer-=t),e.target){const t=this.isTargetDead(e.target),i=this.position.distanceTo(e.target.position)>this.attackRange,s="health"in e.target&&"maxHealth"in e.target&&e.target.health>=e.target.maxHealth;(t||i||s||e.lockTimer<=0)&&(e.target=null,e.lockTimer=0)}for(const t of this.beamTargets)if(!t.target){const i=this.findBestHealingTarget(e);i&&(t.target=i,t.lockTimer=s.PREIST_TARGET_LOCK_DURATION)}for(const e of this.beamTargets)if(e.target&&"health"in e.target&&"maxHealth"in e.target){const i=e.target,o=i.maxHealth*s.PREIST_HEALING_PER_SECOND*t;i.health=Math.min(i.maxHealth,i.health+o)}}findBestHealingTarget(t){const e=new Set(this.beamTargets.filter(t=>t.target).map(t=>t.target)),i=t.filter(t=>!e.has(t)&&(!(t.health>=t.maxHealth)&&this.position.distanceTo(t.position)<=this.attackRange));return 0===i.length?null:(i.sort((t,e)=>t.isHero!==e.isHero?t.isHero?-1:1:t.health/t.maxHealth-e.health/e.maxHealth),i[0])}getHealingBeamTargets(){return this.beamTargets.map(t=>t.target)}useAbility(t){if(!super.useAbility(t))return!1;const e=t.normalize(),n=new i(e.x*s.PREIST_HEALING_BOMB_SPEED,e.y*s.PREIST_HEALING_BOMB_SPEED),r=new o(new i(this.position.x,this.position.y),n,this.owner,0);return r.maxRange=s.PREIST_HEALING_BOMB_MAX_RANGE,r.isHealingBomb=!0,r.healingBombOwner=this,this.lastAbilityEffects.push(r),!0}explodeHealingBomb(t){for(let e=0;e<s.PREIST_HEALING_BOMB_PARTICLE_COUNT;e++){const e=Math.random()*Math.PI*2,o=.5+.5*Math.random(),r=s.PREIST_HEALING_BOMB_PARTICLE_SPEED*o,a=new i(Math.cos(e)*r,Math.sin(e)*r),l=new n(new i(t.x,t.y),a,this.owner);this.healingBombParticles.push(l)}}updateHealingBombParticles(t,e){this.healingBombParticles=this.healingBombParticles.filter(i=>{const o=i.update(t);if(!o)for(const t of e)if(!t.isDead()&&!i.hasHealed.has(t)&&i.position.distanceTo(t.position)<=(t.collisionRadiusPx||s.UNIT_RADIUS_PX)){const e=t.maxHealth*s.PREIST_HEALING_BOMB_PARTICLE_HEALING;t.health=Math.min(t.maxHealth,t.health+e),i.hasHealed.add(t)}return!o})}getHealingBombParticles(){return this.healingBombParticles}attack(t){}},HealingBombParticle:n}})({Unit:ya,Vector2D:i,Constants:e,AbilityBullet:oa}),{Spotlight:$a}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:o}=t;return{Spotlight:class extends e{constructor(t,e){super(t,e,s.SPOTLIGHT_MAX_HEALTH,s.SPOTLIGHT_ATTACK_RANGE,s.SPOTLIGHT_ATTACK_DAMAGE,s.SPOTLIGHT_ATTACK_SPEED,s.SPOTLIGHT_ABILITY_COOLDOWN),this.spotlightDirection=null,this.spotlightState="inactive",this.spotlightStateElapsedSec=0,this.spotlightFireCooldownSec=0,this.spotlightLengthFactor=0,this.spotlightRangePx=0,this.isHero=!0}attack(t){}useAbility(t){return"inactive"===this.spotlightState&&!!super.useAbility(t)&&(this.spotlightDirection=t.normalize(),this.spotlightState="setup",this.spotlightStateElapsedSec=0,this.spotlightFireCooldownSec=0,this.spotlightLengthFactor=0,!0)}updateSpotlightState(t){if("inactive"!==this.spotlightState){if(this.spotlightStateElapsedSec+=t,"setup"===this.spotlightState){const t=s.SPOTLIGHT_SETUP_TIME_SEC;this.spotlightLengthFactor=Math.min(1,this.spotlightStateElapsedSec/t),this.spotlightStateElapsedSec>=t&&(this.spotlightState="active",this.spotlightStateElapsedSec=0,this.spotlightLengthFactor=1)}else if("active"===this.spotlightState)this.spotlightLengthFactor=1,this.spotlightStateElapsedSec>=s.SPOTLIGHT_ACTIVE_TIME_SEC&&(this.spotlightState="teardown",this.spotlightStateElapsedSec=0);else if("teardown"===this.spotlightState){const t=s.SPOTLIGHT_TEARDOWN_TIME_SEC,e=Math.min(1,this.spotlightStateElapsedSec/t);this.spotlightLengthFactor=Math.max(0,1-e),this.spotlightStateElapsedSec>=t&&(this.spotlightState="inactive",this.spotlightDirection=null,this.spotlightLengthFactor=0,this.spotlightRangePx=0,this.spotlightFireCooldownSec=0)}this.spotlightFireCooldownSec>0&&(this.spotlightFireCooldownSec-=t)}}isSpotlightActive(){return"inactive"!==this.spotlightState}isSpotlightSetupComplete(){return"active"===this.spotlightState||"teardown"===this.spotlightState}getSpotlightStateCode(){switch(this.spotlightState){case"setup":return 1;case"active":return 2;case"teardown":return 3;default:return 0}}setSpotlightRangePx(t){this.spotlightRangePx=t}canFireSpotlight(){return this.isSpotlightSetupComplete()&&this.spotlightFireCooldownSec<=0}fireSpotlightAtTargets(t,e){const n=[],r=1/s.SPOTLIGHT_FIRE_RATE_PER_SEC;this.spotlightFireCooldownSec=r;for(const r of t){const t=r.position.x-this.position.x,a=r.position.y-this.position.y,l=t*t+a*a;if(l<=1e-4)continue;const h=1/Math.sqrt(l),c=new i(t*h*s.SPOTLIGHT_BULLET_SPEED,a*h*s.SPOTLIGHT_BULLET_SPEED),d=new o(new i(this.position.x,this.position.y),c,this.owner,s.SPOTLIGHT_BULLET_DAMAGE);d.maxLifetime=s.SPOTLIGHT_BULLET_LIFETIME_SEC,d.maxRange=e,d.isSpotlightBullet=!0,d.renderWidthPx=s.SPOTLIGHT_BULLET_WIDTH_PX,d.renderLengthPx=s.SPOTLIGHT_BULLET_LENGTH_PX,d.hitRadiusPx=s.SPOTLIGHT_BULLET_HIT_RADIUS_PX,n.push(d)}return n}}}})({Unit:ya,Vector2D:i,Constants:e,AbilityBullet:oa}),{Tank:Ka,CrescentWave:ja}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class o{constructor(t,e,i,s){this.position=t,this.direction=e,this.angle=i,this.owner=s,this.lifetime=0,this.distanceTraveled=0,this.affectedUnits=new Set}update(t){const e=s.TANK_WAVE_SPEED*t;this.position.x+=this.direction.x*e,this.position.y+=this.direction.y*e,this.distanceTraveled+=e,this.lifetime+=t}shouldDespawn(){return this.distanceTraveled>=s.TANK_WAVE_RANGE}isPointInWave(t){const e=t.x-this.position.x,i=t.y-this.position.y;if(Math.sqrt(e*e+i*i)>s.TANK_WAVE_WIDTH)return!1;const o=Math.atan2(i,e),n=this.normalizeAngle(o-this.angle);return Math.abs(n)<=s.TANK_WAVE_ANGLE/2}normalizeAngle(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}}return{Tank:class extends e{constructor(t,e){super(t,e,s.TANK_MAX_HEALTH,s.TANK_ATTACK_RANGE,s.TANK_ATTACK_DAMAGE,s.TANK_ATTACK_SPEED,s.TANK_ABILITY_COOLDOWN,s.TANK_COLLISION_RADIUS_PX),this.crescentWave=null,this.isHero=!0}attack(t){}update(t,e,i,o=[]){if(this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.stunDuration>0)this.stunDuration-=t;else{if(this.moveTowardRallyPoint(t,s.UNIT_MOVE_SPEED,i,o),this.rallyPoint){const e=this.rallyPoint.x-this.position.x,i=this.rallyPoint.y-this.position.y;if(Math.abs(e)>.1||Math.abs(i)>.1){const o=Math.atan2(i,e)+Math.PI/2,n=this.getShortestAngleDelta(this.rotation,o),r=s.UNIT_TURN_SPEED_RAD_PER_SEC*t;Math.abs(n)<=r?this.rotation=o:this.rotation+=Math.sign(n)*r,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}else{const i=this.findNearestEnemy(e);if(i&&!this.isTargetDead(i)){const e=i.position.x-this.position.x,o=i.position.y-this.position.y,n=Math.atan2(o,e)+Math.PI/2,r=this.getShortestAngleDelta(this.rotation,n),a=s.UNIT_TURN_SPEED_RAD_PER_SEC*t;Math.abs(r)<=a?this.rotation=n:this.rotation+=Math.sign(r)*a,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}this.crescentWave&&(this.crescentWave.update(t),this.crescentWave.shouldDespawn()&&(this.crescentWave=null))}}useAbility(t){if(!super.useAbility(t))return!1;const e=Math.atan2(t.y,t.x);return this.crescentWave=new o(new i(this.position.x,this.position.y),t.normalize(),e,this.owner),!0}getCrescentWave(){return this.crescentWave}isPositionInShield(t){return this.position.distanceTo(t)<=s.TANK_SHIELD_RADIUS}},CrescentWave:o}})({Unit:ya,Vector2D:i,Constants:e}),{Nova:qa,NovaBomb:Ja,NovaScatterBullet:Qa}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:o}=t;class n{constructor(t,e,i,s){this.position=t,this.owner=i,this.lifetime=0,this.bounceCount=0,this.isArmed=!1,this.scatterDirection=null,this.velocity=e,this.novaUnit=s}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const e=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(e>s.NOVA_BOMB_MIN_SPEED){const i=s.NOVA_BOMB_DECELERATION*t,o=Math.max(s.NOVA_BOMB_MIN_SPEED,e-i)/e;this.velocity.x*=o,this.velocity.y*=o}this.lifetime+=t,this.lifetime>=s.NOVA_BOMB_ARMING_TIME&&(this.isArmed=!0)}bounce(t,e){if(this.bounceCount>=s.NOVA_BOMB_MAX_BOUNCES)return;const i=this.velocity.x*t+this.velocity.y*e;this.velocity.x=this.velocity.x-2*i*t,this.velocity.y=this.velocity.y-2*i*e,this.velocity.x*=s.NOVA_BOMB_BOUNCE_DAMPING,this.velocity.y*=s.NOVA_BOMB_BOUNCE_DAMPING,this.bounceCount++}trigger(t){this.isArmed&&(this.scatterDirection=t.normalize())}shouldExplode(){return null!==this.scatterDirection}getScatterDirection(){return this.scatterDirection}takeDamage(){if(this.isArmed){if(null===this.scatterDirection){const t=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(t>0)this.scatterDirection=new i(this.velocity.x/t,this.velocity.y/t);else{const t=Math.random()*Math.PI*2;this.scatterDirection=new i(Math.cos(t),Math.sin(t))}}}else{const t=Math.random()*Math.PI*2;this.scatterDirection=new i(Math.cos(t),Math.sin(t))}}}return{Nova:class extends e{constructor(t,e){super(t,e,s.NOVA_MAX_HEALTH,s.NOVA_ATTACK_RANGE,s.NOVA_ATTACK_DAMAGE,s.NOVA_ATTACK_SPEED,s.NOVA_ABILITY_COOLDOWN),this.activeBomb=null,this.bombToCreate=null,this.isHero=!0}useAbility(t){if(null!==this.activeBomb&&this.activeBomb.isArmed)return this.activeBomb.trigger(t),!0;if(!super.useAbility(t))return!1;const e=new i(t.x*s.NOVA_BOMB_INITIAL_SPEED,t.y*s.NOVA_BOMB_INITIAL_SPEED);return this.bombToCreate=new n(new i(this.position.x,this.position.y),e,this.owner,this),!0}getAndClearBomb(){const t=this.bombToCreate;return this.bombToCreate=null,t&&(this.activeBomb=t),t}clearActiveBomb(){this.activeBomb=null}getActiveBomb(){return this.activeBomb}},NovaBomb:n,NovaScatterBullet:class{constructor(t,e,i,o=s.NOVA_BOMB_SCATTER_BULLET_DAMAGE,n=s.NOVA_BOMB_SCATTER_BULLET_LIFETIME){this.position=t,this.velocity=e,this.owner=i,this.damage=o,this.maxLifetime=n,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}checkHit(t){return this.position.distanceTo(t.position)<15}}}})({Unit:ya,Vector2D:i,Constants:e,AbilityBullet:oa}),{Velaris:Za,StickyBomb:tl,StickyLaser:el,DisintegrationParticle:il}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class o{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.maxLifetime=s.STICKY_BOMB_DISINTEGRATE_PARTICLE_LIFETIME,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class n{constructor(t,e,i,o,n,r){this.startPosition=t,this.direction=e,this.owner=i,this.damage=o,this.width=n,this.range=r,this.lifetime=0,this.maxLifetime=s.STICKY_BOMB_LASER_DURATION}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}getEndPosition(){return new i(this.startPosition.x+this.direction.x*this.range,this.startPosition.y+this.direction.y*this.range)}checkHit(t){const e=this.getEndPosition(),i=e.x-this.startPosition.x,s=e.y-this.startPosition.y,o=i*i+s*s;if(0===o)return this.startPosition.distanceTo(t.position)<this.width/2;const n=Math.max(0,Math.min(1,((t.position.x-this.startPosition.x)*i+(t.position.y-this.startPosition.y)*s)/o)),r=this.startPosition.x+n*i,a=this.startPosition.y+n*s,l=t.position.x-r,h=t.position.y-a;return Math.sqrt(l*l+h*h)<this.width/2}}class r{constructor(t,e,i,s){this.position=t,this.owner=i,this.velarisOwner=s,this.lifetime=0,this.isStuck=!1,this.stuckTo=null,this.stuckSurface=null,this.surfaceNormal=null,this.isArmed=!1,this.armedTime=0,this.hasTriggered=!1,this.bounceCount=0,this.velocity=e}update(t){if(this.lifetime+=t,this.isArmed||(this.armedTime+=t,this.armedTime>=s.STICKY_BOMB_ARM_TIME&&(this.isArmed=!0)),this.isStuck)return;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>s.STICKY_BOMB_MIN_SPEED){const i=s.STICKY_BOMB_DECELERATION*t,o=Math.max(s.STICKY_BOMB_MIN_SPEED,e-i)/e;this.velocity.x*=o,this.velocity.y*=o}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}stickToSurface(t,e,s=null){this.isStuck=!0,this.stuckSurface=t,this.stuckTo=s;const o=Math.sqrt(e.x*e.x+e.y*e.y);this.surfaceNormal=o>.001?new i(e.x/o,e.y/o):new i(0,-1),this.velocity=new i(0,0)}shouldDisintegrate(){return!this.isStuck&&this.lifetime>=s.STICKY_BOMB_MAX_LIFETIME}shouldDespawn(){return this.hasTriggered||this.shouldDisintegrate()}triggerLasers(){if(!this.isArmed||!this.isStuck||this.hasTriggered||!this.surfaceNormal)return[];this.hasTriggered=!0;const t=[];t.push(new n(new i(this.position.x,this.position.y),new i(this.surfaceNormal.x,this.surfaceNormal.y),this.owner,s.STICKY_BOMB_WIDE_LASER_DAMAGE,s.STICKY_BOMB_WIDE_LASER_WIDTH,s.STICKY_BOMB_LASER_RANGE));const e=Math.atan2(this.surfaceNormal.y,this.surfaceNormal.x),o=e+s.STICKY_BOMB_LASER_ANGLE;t.push(new n(new i(this.position.x,this.position.y),new i(Math.cos(o),Math.sin(o)),this.owner,s.STICKY_BOMB_DIAGONAL_LASER_DAMAGE,s.STICKY_BOMB_DIAGONAL_LASER_WIDTH,s.STICKY_BOMB_LASER_RANGE));const r=e-s.STICKY_BOMB_LASER_ANGLE;return t.push(new n(new i(this.position.x,this.position.y),new i(Math.cos(r),Math.sin(r)),this.owner,s.STICKY_BOMB_DIAGONAL_LASER_DAMAGE,s.STICKY_BOMB_DIAGONAL_LASER_WIDTH,s.STICKY_BOMB_LASER_RANGE)),t}createDisintegrationParticles(){const t=[],e=s.STICKY_BOMB_DISINTEGRATE_PARTICLE_COUNT;for(let n=0;n<e;n++){const e=2*Math.random()*Math.PI,n=s.STICKY_BOMB_DISINTEGRATE_PARTICLE_SPEED*(.5+.5*Math.random()),r=new i(Math.cos(e)*n,Math.sin(e)*n);t.push(new o(new i(this.position.x,this.position.y),r,this.owner))}return t}}return{Velaris:class extends e{constructor(t,e){super(t,e,s.VELARIS_MAX_HEALTH,s.VELARIS_ATTACK_RANGE,s.VELARIS_ATTACK_DAMAGE,s.VELARIS_ATTACK_SPEED,s.VELARIS_ABILITY_COOLDOWN),this.activeBomb=null,this.bombToCreate=null,this.lasersToCreate=[],this.particlesToCreate=[],this.isHero=!0}useAbility(t){if(null!==this.activeBomb&&this.activeBomb.isArmed&&this.activeBomb.isStuck){const t=this.activeBomb.triggerLasers();return this.lasersToCreate.push(...t),this.activeBomb=null,!0}if(null===this.activeBomb){const e=t.normalize(),o=s.STICKY_BOMB_INITIAL_SPEED,n=new i(e.x*o,e.y*o),a=new r(new i(this.position.x,this.position.y),n,this.owner,this);return this.bombToCreate=a,this.activeBomb=a,!0}return!1}getAndClearBombToCreate(){const t=this.bombToCreate;return this.bombToCreate=null,t}getAndClearLasersToCreate(){const t=this.lasersToCreate;return this.lasersToCreate=[],t}getAndClearParticlesToCreate(){const t=this.particlesToCreate;return this.particlesToCreate=[],t}onBombDestroyed(t){this.activeBomb===t&&(this.particlesToCreate.push(...t.createDisintegrationParticles()),this.activeBomb=null)}},StickyBomb:r,StickyLaser:n,DisintegrationParticle:o}})({Unit:ya,Vector2D:i,Constants:e});class sl{constructor(t){this.particles=[],this.attractionMatrix=[],this.animationFrameId=null,this.isActive=!1,this.lastColorChangeMs=0,this.edgeGlows={top:[0,0,0],right:[0,0,0],bottom:[0,0,0],left:[0,0,0]},this.gradientColors=[[138,43,226],[147,51,234],[219,39,119],[236,72,153],[59,130,246],[14,165,233],[168,85,247],[192,132,252]],this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="-1";const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to create background particle canvas context. This may be due to browser compatibility or system limitations.");this.context=e,t.appendChild(this.canvas),this.resize(),this.initializeParticles(),this.initializeAttractionMatrix(),this.start()}initializeParticles(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1),i=this.getParticleRadiusPx();this.particles=[];for(let s=0;s<sl.PARTICLE_COUNT;s++){const o=this.gradientColors[s%this.gradientColors.length],n={x:Math.random()*t,y:Math.random()*e,velocityX:.5*(Math.random()-.5),velocityY:.5*(Math.random()-.5),colorR:o[0],colorG:o[1],colorB:o[2],targetColorR:o[0],targetColorG:o[1],targetColorB:o[2],radius:i};this.particles.push(n)}}initializeAttractionMatrix(){this.attractionMatrix=[];for(let t=0;t<sl.PARTICLE_COUNT;t++){this.attractionMatrix[t]=[];for(let e=0;e<sl.PARTICLE_COUNT;e++)this.attractionMatrix[t][e]=t===e?0:(Math.random()-.5)*sl.ATTRACTION_STRENGTH}}resize(){const t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.canvas.width=Math.round(e*t),this.canvas.height=Math.round(i*t),this.context.setTransform(t,0,0,t,0,0),this.updateParticleRadii()}start(){this.isActive||(this.isActive=!0,this.lastColorChangeMs=performance.now(),this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animate(){if(!this.isActive)return;const t=performance.now();t-this.lastColorChangeMs>=sl.COLOR_CHANGE_INTERVAL_MS&&(this.updateTargetColors(),this.lastColorChangeMs=t),this.updateParticles(),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.animate())}updateTargetColors(){for(let t=0;t<this.particles.length;t++){const e=Math.floor(Math.random()*this.gradientColors.length),i=this.gradientColors[e];this.particles[t].targetColorR=i[0],this.particles[t].targetColorG=i[1],this.particles[t].targetColorB=i[2]}}updateParticles(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);this.edgeGlows.top=[0,0,0],this.edgeGlows.right=[0,0,0],this.edgeGlows.bottom=[0,0,0],this.edgeGlows.left=[0,0,0];for(let i=0;i<this.particles.length;i++){const s=this.particles[i];for(let t=0;t<this.particles.length;t++){if(i===t)continue;const e=this.particles[t],o=e.x-s.x,n=e.y-s.y,r=Math.sqrt(o*o+n*n);if(r>0){const e=this.attractionMatrix[i][t],a=o/r*e,l=n/r*e;s.velocityX+=a,s.velocityY+=l}}const o=sl.EDGE_REPULSION_DISTANCE,n=sl.EDGE_REPULSION_STRENGTH;if(s.x<o){const t=(1-s.x/o)*n;s.velocityX+=t}if(s.x>t-o){const e=(1-(t-s.x)/o)*n;s.velocityX-=e}if(s.y<o){const t=(1-s.y/o)*n;s.velocityY+=t}if(s.y>e-o){const t=(1-(e-s.y)/o)*n;s.velocityY-=t}s.velocityX*=sl.FRICTION,s.velocityY*=sl.FRICTION;const r=Math.sqrt(s.velocityX*s.velocityX+s.velocityY*s.velocityY);if(r>sl.MAX_VELOCITY&&(s.velocityX=s.velocityX/r*sl.MAX_VELOCITY,s.velocityY=s.velocityY/r*sl.MAX_VELOCITY),r<sl.MIN_VELOCITY){const t=Math.random()*Math.PI*2;s.velocityX=Math.cos(t)*sl.MIN_VELOCITY,s.velocityY=Math.sin(t)*sl.MIN_VELOCITY}s.x+=s.velocityX,s.y+=s.velocityY,s.x<0&&(s.x=0,s.velocityX=Math.abs(s.velocityX)),s.x>t&&(s.x=t,s.velocityX=-Math.abs(s.velocityX)),s.y<0&&(s.y=0,s.velocityY=Math.abs(s.velocityY)),s.y>e&&(s.y=e,s.velocityY=-Math.abs(s.velocityY));const a=sl.EDGE_GLOW_DISTANCE,l=Math.round(s.colorR),h=Math.round(s.colorG),c=Math.round(s.colorB);if(s.y<a){const t=1-s.y/a;this.edgeGlows.top[0]+=l*t,this.edgeGlows.top[1]+=h*t,this.edgeGlows.top[2]+=c*t}if(s.y>e-a){const t=1-(e-s.y)/a;this.edgeGlows.bottom[0]+=l*t,this.edgeGlows.bottom[1]+=h*t,this.edgeGlows.bottom[2]+=c*t}if(s.x<a){const t=1-s.x/a;this.edgeGlows.left[0]+=l*t,this.edgeGlows.left[1]+=h*t,this.edgeGlows.left[2]+=c*t}if(s.x>t-a){const e=1-(t-s.x)/a;this.edgeGlows.right[0]+=l*e,this.edgeGlows.right[1]+=h*e,this.edgeGlows.right[2]+=c*e}s.colorR+=(s.targetColorR-s.colorR)*sl.COLOR_TRANSITION_SPEED,s.colorG+=(s.targetColorG-s.colorG)*sl.COLOR_TRANSITION_SPEED,s.colorB+=(s.targetColorB-s.colorB)*sl.COLOR_TRANSITION_SPEED}}updateParticleRadii(){const t=this.getParticleRadiusPx();for(let e=0;e<this.particles.length;e++)this.particles[e].radius=t}getParticleRadiusPx(){return window.matchMedia("(min-width: 768px)").matches?sl.PARTICLE_RADIUS_DESKTOP_PX:sl.PARTICLE_RADIUS_MOBILE_PX}render(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);this.context.fillStyle="#000000",this.context.fillRect(0,0,t,e),this.context.globalCompositeOperation="screen",this.context.filter="blur(40px)";const i=sl.EDGE_GLOW_NORMALIZATION,s=Math.min(255,Math.round(this.edgeGlows.top[0]/i*255)),o=Math.min(255,Math.round(this.edgeGlows.top[1]/i*255)),n=Math.min(255,Math.round(this.edgeGlows.top[2]/i*255));if(s+o+n>0){const e=this.context.createLinearGradient(0,0,0,60);e.addColorStop(0,`rgba(${s}, ${o}, ${n}, 0.6)`),e.addColorStop(1,`rgba(${s}, ${o}, ${n}, 0)`),this.context.fillStyle=e,this.context.fillRect(0,0,t,60)}const r=Math.min(255,Math.round(this.edgeGlows.bottom[0]/i*255)),a=Math.min(255,Math.round(this.edgeGlows.bottom[1]/i*255)),l=Math.min(255,Math.round(this.edgeGlows.bottom[2]/i*255));if(r+a+l>0){const i=this.context.createLinearGradient(0,e-60,0,e);i.addColorStop(0,`rgba(${r}, ${a}, ${l}, 0)`),i.addColorStop(1,`rgba(${r}, ${a}, ${l}, 0.6)`),this.context.fillStyle=i,this.context.fillRect(0,e-60,t,60)}const h=Math.min(255,Math.round(this.edgeGlows.left[0]/i*255)),c=Math.min(255,Math.round(this.edgeGlows.left[1]/i*255)),d=Math.min(255,Math.round(this.edgeGlows.left[2]/i*255));if(h+c+d>0){const t=this.context.createLinearGradient(0,0,60,0);t.addColorStop(0,`rgba(${h}, ${c}, ${d}, 0.6)`),t.addColorStop(1,`rgba(${h}, ${c}, ${d}, 0)`),this.context.fillStyle=t,this.context.fillRect(0,0,60,e)}const g=Math.min(255,Math.round(this.edgeGlows.right[0]/i*255)),u=Math.min(255,Math.round(this.edgeGlows.right[1]/i*255)),p=Math.min(255,Math.round(this.edgeGlows.right[2]/i*255));if(g+u+p>0){const i=this.context.createLinearGradient(t-60,0,t,0);i.addColorStop(0,`rgba(${g}, ${u}, ${p}, 0)`),i.addColorStop(1,`rgba(${g}, ${u}, ${p}, 0.6)`),this.context.fillStyle=i,this.context.fillRect(t-60,0,60,e)}this.context.filter="blur(60px)",this.context.globalCompositeOperation="screen";for(const t of this.particles){const e=this.context.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius),i=Math.round(t.colorR),s=Math.round(t.colorG),o=Math.round(t.colorB);e.addColorStop(0,`rgba(${i}, ${s}, ${o}, 0.4)`),e.addColorStop(1,`rgba(${i}, ${s}, ${o}, 0)`),this.context.fillStyle=e,this.context.beginPath(),this.context.arc(t.x,t.y,t.radius,0,2*Math.PI),this.context.fill()}this.context.filter="none",this.context.globalCompositeOperation="source-over"}destroy(){this.stop(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas)}}sl.PARTICLE_COUNT=8,sl.PARTICLE_RADIUS_MOBILE_PX=37.5,sl.PARTICLE_RADIUS_DESKTOP_PX=75,sl.MAX_VELOCITY=.3,sl.MIN_VELOCITY=.02,sl.FRICTION=.98,sl.COLOR_TRANSITION_SPEED=.002,sl.ATTRACTION_STRENGTH=.15,sl.COLOR_CHANGE_INTERVAL_MS=8e3,sl.EDGE_REPULSION_DISTANCE=300,sl.EDGE_REPULSION_STRENGTH=.05,sl.EDGE_GLOW_DISTANCE=400,sl.EDGE_GLOW_NORMALIZATION=350*sl.PARTICLE_COUNT;class ol{constructor(t,e){this.asteroids=[],this.animationFrameId=null,this.isActive=!1,this.widthPx=0,this.heightPx=0,this.container=t,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="0",this.canvas.style.opacity="0.2";const i=this.canvas.getContext("2d");if(!i)throw new Error("Unable to create menu atmosphere canvas context.");this.context=i,this.sunSprite=new Image,this.sunSprite.src=e,this.container.appendChild(this.canvas),this.resize(),this.initializeAsteroids(),this.start()}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resize(){const t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.widthPx=e,this.heightPx=i,this.canvas.width=Math.round(e*t),this.canvas.height=Math.round(i*t),this.context.setTransform(t,0,0,t,0,0)}destroy(){this.stop(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas)}initializeAsteroids(){this.asteroids=[];for(let t=0;t<ol.ASTEROID_COUNT;t++)this.asteroids.push(this.createAsteroid())}createAsteroid(){const t=this.randomRange(ol.ASTEROID_MIN_RADIUS_PX,ol.ASTEROID_MAX_RADIUS_PX),e=this.createSpawnPosition(),i=this.createVelocity(),s=this.randomRange(ol.ASTEROID_ROTATION_MIN_RAD,ol.ASTEROID_ROTATION_MAX_RAD),o=[],n=7+Math.floor(4*Math.random());for(let t=0;t<n;t++)o.push({angleRad:2*Math.PI*t/n,radiusScale:.7+.5*Math.random()});return{x:e.x,y:e.y,radiusPx:t,velocityX:i.x,velocityY:i.y,rotationRad:Math.random()*Math.PI*2,rotationSpeedRad:s*(Math.random()>.5?1:-1),points:o}}createSpawnPosition(){const t=ol.BOUNDS_MARGIN_PX;return Math.random()<.5?{x:this.randomRange(-t,this.widthPx+t),y:this.randomRange(.6*-t,.7*this.heightPx)}:{x:this.randomRange(-t,.7*this.widthPx),y:this.randomRange(-t,this.heightPx+t)}}createVelocity(){const t=this.randomRange(ol.ASTEROID_SPEED_MIN,ol.ASTEROID_SPEED_MAX),e=Math.random()*Math.PI*2;return{x:Math.cos(e)*t,y:Math.sin(e)*t}}animate(){this.isActive&&(this.updateAsteroids(),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.animate()))}updateAsteroids(){const t=ol.BOUNDS_MARGIN_PX,e=-t,i=-t,s=this.widthPx+t,o=this.heightPx+t;for(const t of this.asteroids)if(t.x+=t.velocityX,t.y+=t.velocityY,t.rotationRad+=t.rotationSpeedRad,t.x<e||t.x>s||t.y<i||t.y>o){const e=this.createSpawnPosition(),i=this.createVelocity();t.x=e.x,t.y=e.y,t.velocityX=i.x,t.velocityY=i.y}}render(){this.context.clearRect(0,0,this.widthPx,this.heightPx),this.renderSunGlow(),this.renderAsteroids()}renderSunGlow(){const t=this.getSunCenter(),e=this.context.createRadialGradient(t.x,t.y,.35*ol.SUN_RADIUS_PX,t.x,t.y,ol.SUN_GLOW_RADIUS_PX);if(e.addColorStop(0,"rgba(255, 240, 200, 0.9)"),e.addColorStop(.4,"rgba(255, 200, 120, 0.5)"),e.addColorStop(.7,"rgba(255, 150, 80, 0.25)"),e.addColorStop(1,"rgba(255, 120, 40, 0)"),this.context.fillStyle=e,this.context.beginPath(),this.context.arc(t.x,t.y,ol.SUN_GLOW_RADIUS_PX,0,2*Math.PI),this.context.fill(),this.sunSprite.complete&&this.sunSprite.naturalWidth>0){const e=2*ol.SUN_RADIUS_PX;this.context.drawImage(this.sunSprite,t.x-ol.SUN_RADIUS_PX,t.y-ol.SUN_RADIUS_PX,e,e)}else this.context.fillStyle="rgba(255, 215, 120, 0.95)",this.context.beginPath(),this.context.arc(t.x,t.y,ol.SUN_RADIUS_PX,0,2*Math.PI),this.context.fill()}renderAsteroids(){this.getSunCenter();for(const t of this.asteroids){const e=this.getAsteroidPoints(t);this.renderAsteroidBody(t,e)}}renderAsteroidShadow(t,e,i){const s=this.getShadowOffset(t,i),o=ol.SHADOW_LENGTH_BASE_PX+t.radiusPx*ol.SHADOW_LENGTH_MULTIPLIER;this.context.fillStyle="rgba(20, 14, 12, 0.45)",this.context.beginPath();for(let t=0;t<e.length;t++){const i=e[t];0===t?this.context.moveTo(i.x,i.y):this.context.lineTo(i.x,i.y)}for(let t=e.length-1;t>=0;t--){const i=e[t];this.context.lineTo(i.x+s.x*o,i.y+s.y*o)}this.context.closePath(),this.context.fill()}renderAsteroidBody(t,e){this.context.fillStyle="rgba(170, 160, 140, 0.8)",this.context.beginPath();for(let t=0;t<e.length;t++){const i=e[t];0===t?this.context.moveTo(i.x,i.y):this.context.lineTo(i.x,i.y)}this.context.closePath(),this.context.fill(),this.context.strokeStyle="rgba(120, 105, 90, 0.65)",this.context.lineWidth=1,this.context.stroke()}getSunCenter(){return{x:ol.SUN_RADIUS_PX+ol.SUN_OFFSET_X_PX,y:ol.SUN_RADIUS_PX+ol.SUN_OFFSET_Y_PX}}getShadowOffset(t,e){const i=t.x-e.x,s=t.y-e.y,o=Math.max(1,Math.hypot(i,s));return{x:i/o,y:s/o}}getAsteroidPoints(t){const e=[],i=t.points;for(let s=0;s<i.length;s++){const o=i[s],n=o.angleRad+t.rotationRad,r=t.radiusPx*o.radiusScale;e.push({x:t.x+Math.cos(n)*r,y:t.y+Math.sin(n)*r})}return e}randomRange(t,e){return t+Math.random()*(e-t)}}ol.ASTEROID_COUNT=14,ol.ASTEROID_MIN_RADIUS_PX=6,ol.ASTEROID_MAX_RADIUS_PX=16,ol.ASTEROID_SPEED_MIN=.06,ol.ASTEROID_SPEED_MAX=.18,ol.ASTEROID_ROTATION_MIN_RAD=.004,ol.ASTEROID_ROTATION_MAX_RAD=.014,ol.SUN_RADIUS_PX=120,ol.SUN_GLOW_RADIUS_PX=320,ol.SUN_OFFSET_X_PX=-28,ol.SUN_OFFSET_Y_PX=-22,ol.SHADOW_LENGTH_BASE_PX=120,ol.SHADOW_LENGTH_MULTIPLIER=7.5,ol.BOUNDS_MARGIN_PX=80;class nl{constructor(t){this.particles=[],this.animationFrameId=null,this.isActive=!1,this.needsTargetRefresh=!1,this.lastTargetRefreshMs=0,this.targetRefreshContainer=null,this.densityMultiplier=1,this.desiredParticleCount=0,this.menuContentElement=null,this.particleOpacity=nl.BASE_PARTICLE_OPACITY,this.menuOpacity=1,this.transitionStartMs=null,this.container=t,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="2";const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to create menu particle canvas context.");this.context=e,this.offscreenCanvas=document.createElement("canvas");const i=this.offscreenCanvas.getContext("2d");if(!i)throw new Error("Unable to create offscreen particle canvas context.");this.offscreenContext=i,this.container.appendChild(this.canvas),requestAnimationFrame(()=>{try{this.resize()}catch(t){console.error("Failed to resize particle canvas:",t)}}),this.start()}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resize(){const t=this.container.getBoundingClientRect(),e=window.devicePixelRatio||1,i=t.width||window.innerWidth,s=t.height||window.innerHeight;this.canvas.width=Math.round(i*e),this.canvas.height=Math.round(s*e),this.context.setTransform(e,0,0,e,0,0)}setMenuContentElement(t){this.menuContentElement=t,this.applyMenuOpacity()}requestTargetRefresh(t){this.needsTargetRefresh=!0,this.targetRefreshContainer=t}clearTargets(){this.setTargets([])}setDensityMultiplier(t){this.densityMultiplier=Math.max(.5,t)}startTransition(){this.transitionStartMs=performance.now()}animate(){if(!this.isActive)return;const t=performance.now();this.needsTargetRefresh&&this.targetRefreshContainer&&t-this.lastTargetRefreshMs>=nl.REFRESH_INTERVAL_MS&&(this.updateTargetsFromElements(this.targetRefreshContainer),this.lastTargetRefreshMs=t,this.needsTargetRefresh=!1),this.updateParticles(t),this.renderParticles(),this.animationFrameId=requestAnimationFrame(()=>this.animate())}updateTargetsFromElements(t){const e=this.collectTargets(t);this.setTargets(e)}setTargets(t){const e=[],i=t.length;if(0===i)return this.particles=e,void(this.desiredParticleCount=0);this.desiredParticleCount=i;const s=this.desiredParticleCount,o=this.particles.slice();for(o.length>s&&(o.length=s);o.length<s;){const e=t[o.length%i];o.push(this.createParticle(e.x,e.y,e.color))}for(let n=0;n<s;n++){const s=t[n%i],r=o[n],a=this.getRelocatedTarget(s);r.targetX=a.x,r.targetY=a.y,r.baseTargetX=a.x,r.baseTargetY=a.y;const l=this.parseColor(s.color);r.targetColorR=l.r,r.targetColorG=l.g,r.targetColorB=l.b,r.sizePx=nl.PARTICLE_SIZE_PX,e.push(r)}this.particles=e}createParticle(t,e,i){const s=Math.random()*Math.PI*2,o=nl.DRIFT_RADIUS_MIN_PX+Math.random()*(nl.DRIFT_RADIUS_MAX_PX-nl.DRIFT_RADIUS_MIN_PX),n=.8+.4*Math.random(),r=this.parseColor(i);return{x:t,y:e,velocityX:0,velocityY:0,targetX:t,targetY:e,baseTargetX:t,baseTargetY:e,colorR:r.r,colorG:r.g,colorB:r.b,targetColorR:r.r,targetColorG:r.g,targetColorB:r.b,sizePx:nl.PARTICLE_SIZE_PX,driftPhase:s,driftRadiusPx:o,speedMultiplier:n}}getRelocatedTarget(t){const e=nl.RELOCATE_MIN_DISTANCE_PX,i=nl.RELOCATE_MAX_DISTANCE_PX,s=e+Math.random()*(i-e),o=Math.random()*Math.PI*2;return{x:t.x+Math.cos(o)*s,y:t.y+Math.sin(o)*s}}updateParticles(t){this.updateTransition(t);const e=t*nl.DRIFT_SPEED;for(const t of this.particles){const i=e*t.speedMultiplier,s=Math.cos(t.driftPhase+i)*t.driftRadiusPx,o=Math.sin(t.driftPhase+i)*t.driftRadiusPx;t.baseTargetX=t.targetX+s,t.baseTargetY=t.targetY+o;const n=t.baseTargetX-t.x,r=t.baseTargetY-t.y,a=nl.POSITION_SMOOTHING*t.speedMultiplier;t.velocityX+=n*a,t.velocityY+=r*a,t.velocityX*=.82,t.velocityY*=.82,t.x+=t.velocityX,t.y+=t.velocityY,t.colorR+=(t.targetColorR-t.colorR)*nl.COLOR_SMOOTHING,t.colorG+=(t.targetColorG-t.colorG)*nl.COLOR_SMOOTHING,t.colorB+=(t.targetColorB-t.colorB)*nl.COLOR_SMOOTHING}}updateTransition(t){if(null===this.transitionStartMs)return this.particleOpacity=nl.BASE_PARTICLE_OPACITY,this.menuOpacity=1,void this.applyMenuOpacity();const e=t-this.transitionStartMs,i=nl.TRANSITION_DURATION_MS,s=i/2;if(e>=i)return this.transitionStartMs=null,this.particleOpacity=nl.BASE_PARTICLE_OPACITY,this.menuOpacity=1,void this.applyMenuOpacity();if(e<=s){const t=e/s;this.particleOpacity=nl.BASE_PARTICLE_OPACITY+(nl.PEAK_PARTICLE_OPACITY-nl.BASE_PARTICLE_OPACITY)*t,this.menuOpacity=1-t}else{const t=(e-s)/s;this.particleOpacity=nl.PEAK_PARTICLE_OPACITY+(nl.BASE_PARTICLE_OPACITY-nl.PEAK_PARTICLE_OPACITY)*t,this.menuOpacity=t}this.applyMenuOpacity()}applyMenuOpacity(){this.menuContentElement&&(this.menuContentElement.style.opacity=this.menuOpacity.toFixed(3))}renderParticles(){const t=this.container.getBoundingClientRect(),e=t.width||window.innerWidth,i=t.height||window.innerHeight;this.context.clearRect(0,0,e,i),this.context.globalCompositeOperation="lighter",this.context.globalAlpha=this.particleOpacity;for(const t of this.particles){const e=Math.min(255,Math.max(0,Math.round(t.colorR))),i=Math.min(255,Math.max(0,Math.round(t.colorG))),s=Math.min(255,Math.max(0,Math.round(t.colorB)));this.context.fillStyle=`rgb(${e}, ${i}, ${s})`,this.context.beginPath(),this.context.arc(t.x,t.y,t.sizePx,0,2*Math.PI),this.context.fill()}this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over"}collectTargets(t){const e=Array.from(t.querySelectorAll("[data-particle-text], [data-particle-box]")),i=[];for(const t of e)void 0!==t.dataset.particleText&&i.push(...this.collectTextTargets(t)),void 0!==t.dataset.particleBox&&i.push(...this.collectBoxTargets(t));return i}collectTextTargets(t){var e;const i=null===(e=t.textContent)||void 0===e?void 0:e.trim();if(!i)return[];const s=t.getBoundingClientRect();if(s.width<=0||s.height<=0)return[];const o=window.getComputedStyle(t),n=Number.parseFloat(o.fontSize)||16,r=o.fontFamily||"Arial, sans-serif",a=o.fontWeight||"600",l=t.dataset.particleColor||"#FFFFFF",h=Math.max(3,Math.round(n/7.5)),c=Math.max(2,Math.round(h/this.densityMultiplier));this.offscreenCanvas.width=Math.ceil(s.width),this.offscreenCanvas.height=Math.ceil(s.height),this.offscreenContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.offscreenContext.font=`${a} ${n}px ${r}`,this.offscreenContext.textAlign="center",this.offscreenContext.textBaseline="middle",this.offscreenContext.fillStyle="#FFFFFF",this.offscreenContext.fillText(i,this.offscreenCanvas.width/2,this.offscreenCanvas.height/2);const d=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height).data,g=[],u=c/2;for(let t=c/2;t<this.offscreenCanvas.height;t+=c)for(let e=u;e<this.offscreenCanvas.width;e+=c)d[4*(Math.floor(t)*this.offscreenCanvas.width+Math.floor(e))+3]>80&&g.push({x:s.left+e,y:s.top+t,color:l});return g}collectBoxTargets(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return[];const i=t.dataset.particleColor||"#FFFFFF",s=Math.max(6,Math.round(Math.min(e.width,e.height)/12)),o=Math.max(3,Math.round(s/this.densityMultiplier)),n=[],r=e.left,a=e.right,l=e.top,h=e.bottom;for(let t=r;t<=a;t+=o)n.push({x:t,y:l,color:i}),n.push({x:t,y:h,color:i});for(let t=l;t<=h;t+=o)n.push({x:r,y:t,color:i}),n.push({x:a,y:t,color:i});return n}parseColor(t){const e=t.trim();if(e.startsWith("#")){const t=e.slice(1);if(3===t.length)return{r:Number.parseInt(t[0]+t[0],16),g:Number.parseInt(t[1]+t[1],16),b:Number.parseInt(t[2]+t[2],16)};if(6===t.length)return{r:Number.parseInt(t.slice(0,2),16),g:Number.parseInt(t.slice(2,4),16),b:Number.parseInt(t.slice(4,6),16)}}return{r:255,g:255,b:255}}}nl.REFRESH_INTERVAL_MS=140,nl.POSITION_SMOOTHING=.08/14,nl.DRIFT_SPEED=7e-4/6,nl.DRIFT_RADIUS_MIN_PX=.03,nl.DRIFT_RADIUS_MAX_PX=.11,nl.COLOR_SMOOTHING=.08,nl.PARTICLE_SIZE_PX=1.6,nl.RELOCATE_MIN_DISTANCE_PX=4,nl.RELOCATE_MAX_DISTANCE_PX=12,nl.BASE_PARTICLE_OPACITY=.15,nl.PEAK_PARTICLE_OPACITY=.4,nl.TRANSITION_DURATION_MS=600;const rl={SpaceBlack:{id:"SpaceBlack",name:"Space Black",background:"#000000",asteroidColors:{fillStart:"#878787",fillEnd:"#505050",strokeStart:"#9B9B9B",strokeEnd:"#646464"},spaceDustPalette:{neutral:["#5a5a5a","#6c6c6c","#7f7f7f","#8f8f8f"],accent:["#5b6c8f","#6a5f8f","#7a6aa6"]},sunCore:{inner:"rgba(255, 255, 255, 1)",mid:"rgba(255, 230, 120, 1)",outer:"rgba(255, 180, 50, 0.9)"},sunGlow:{outerGlow1:"rgba(255, 220, 100, 0.8)",outerGlow2:"rgba(255, 180, 50, 0.4)",outerGlow3:"rgba(255, 140, 30, 0.2)",outerGlow4:"rgba(255, 100, 0, 0)"},sunLightRays:{nearCenter:"rgba(255, 245, 215, 0.35)",mid:"rgba(255, 220, 170, 0.18)",edge:"rgba(255, 200, 140, 0)"},lensFlareHalo:"rgba(255, 240, 200, 0.15)"},ColdIce:{id:"ColdIce",name:"Cold Ice",background:"#0B1426",asteroidColors:{fillStart:"#4A3B6E",fillEnd:"#7B63A6",strokeStart:"#6A52A0",strokeEnd:"#B39DE6"},spaceDustPalette:{neutral:["#6D717B","#7C808A","#8A8D97","#9A9EB0"],accent:["#6C5A91","#7B66A8","#8B75C3","#9A82D6"]},sunCore:{inner:"rgba(230, 245, 255, 1)",mid:"rgba(190, 220, 255, 0.95)",outer:"rgba(150, 200, 255, 0.85)"},sunGlow:{outerGlow1:"rgba(200, 230, 255, 0.75)",outerGlow2:"rgba(160, 210, 255, 0.45)",outerGlow3:"rgba(120, 190, 255, 0.25)",outerGlow4:"rgba(80, 170, 255, 0)"},sunLightRays:{nearCenter:"rgba(220, 240, 255, 0.35)",mid:"rgba(170, 215, 255, 0.18)",edge:"rgba(130, 190, 255, 0)"},lensFlareHalo:"rgba(210, 235, 255, 0.18)"},DeepSpace:{id:"DeepSpace",name:"Deep Space",background:"#0A0A1E",asteroidColors:{fillStart:"#4A4A7E",fillEnd:"#2E2E5A",strokeStart:"#6A6A9E",strokeEnd:"#4A4A7A"},spaceDustPalette:{neutral:["#3A3A5E","#4A4A6E","#5A5A7E","#6A6A8E"],accent:["#5A4A8F","#6A5A9F","#7A6AAF","#8A7ABF"]},sunCore:{inner:"rgba(220, 200, 255, 1)",mid:"rgba(180, 150, 230, 0.95)",outer:"rgba(140, 100, 200, 0.85)"},sunGlow:{outerGlow1:"rgba(170, 140, 230, 0.75)",outerGlow2:"rgba(140, 110, 200, 0.45)",outerGlow3:"rgba(110, 80, 170, 0.25)",outerGlow4:"rgba(80, 50, 140, 0)"},sunLightRays:{nearCenter:"rgba(200, 180, 240, 0.35)",mid:"rgba(160, 130, 210, 0.18)",edge:"rgba(120, 90, 180, 0)"},lensFlareHalo:"rgba(190, 170, 230, 0.18)"},RedGiant:{id:"RedGiant",name:"Red Giant",background:"#1A0A0A",asteroidColors:{fillStart:"#8A5A5A",fillEnd:"#5A3030",strokeStart:"#AA7A7A",strokeEnd:"#7A4A4A"},spaceDustPalette:{neutral:["#6A4A4A","#7A5A5A","#8A6A6A","#9A7A7A"],accent:["#8F5A4A","#9F6A5A","#AF7A6A","#BF8A7A"]},sunCore:{inner:"rgba(255, 240, 200, 1)",mid:"rgba(255, 160, 80, 0.95)",outer:"rgba(255, 100, 60, 0.85)"},sunGlow:{outerGlow1:"rgba(255, 140, 80, 0.75)",outerGlow2:"rgba(240, 100, 60, 0.45)",outerGlow3:"rgba(220, 60, 40, 0.25)",outerGlow4:"rgba(200, 40, 20, 0)"},sunLightRays:{nearCenter:"rgba(255, 200, 150, 0.35)",mid:"rgba(255, 140, 90, 0.18)",edge:"rgba(240, 100, 60, 0)"},lensFlareHalo:"rgba(255, 180, 120, 0.18)"},Nebula:{id:"Nebula",name:"Nebula",background:"#150A1A",asteroidColors:{fillStart:"#7A4A7A",fillEnd:"#5A2A5A",strokeStart:"#9A6A9A",strokeEnd:"#7A4A7A"},spaceDustPalette:{neutral:["#6A4A6A","#7A5A7A","#8A6A8A","#9A7A9A"],accent:["#8F4A7A","#9F5A8A","#AF6A9A","#BF7AAA"]},sunCore:{inner:"rgba(255, 220, 255, 1)",mid:"rgba(240, 150, 220, 0.95)",outer:"rgba(200, 100, 180, 0.85)"},sunGlow:{outerGlow1:"rgba(230, 140, 210, 0.75)",outerGlow2:"rgba(200, 100, 180, 0.45)",outerGlow3:"rgba(170, 70, 150, 0.25)",outerGlow4:"rgba(140, 50, 120, 0)"},sunLightRays:{nearCenter:"rgba(240, 180, 230, 0.35)",mid:"rgba(210, 130, 190, 0.18)",edge:"rgba(180, 90, 160, 0)"},lensFlareHalo:"rgba(230, 160, 210, 0.18)"},GreenAurora:{id:"GreenAurora",name:"Green Aurora",background:"#0A1A14",asteroidColors:{fillStart:"#4A7A5A",fillEnd:"#2A5A3A",strokeStart:"#6A9A7A",strokeEnd:"#4A7A5A"},spaceDustPalette:{neutral:["#4A6A5A","#5A7A6A","#6A8A7A","#7A9A8A"],accent:["#4A8F6A","#5A9F7A","#6AAF8A","#7ABF9A"]},sunCore:{inner:"rgba(220, 255, 230, 1)",mid:"rgba(160, 240, 180, 0.95)",outer:"rgba(100, 200, 140, 0.85)"},sunGlow:{outerGlow1:"rgba(140, 230, 170, 0.75)",outerGlow2:"rgba(100, 200, 140, 0.45)",outerGlow3:"rgba(70, 170, 110, 0.25)",outerGlow4:"rgba(50, 140, 80, 0)"},sunLightRays:{nearCenter:"rgba(180, 240, 210, 0.35)",mid:"rgba(130, 210, 170, 0.18)",edge:"rgba(90, 180, 130, 0)"},lensFlareHalo:"rgba(160, 230, 190, 0.18)"}};var al=function(t,e,i,s){return new(i||(i=Promise))(function(o,n){function r(t){try{l(s.next(t))}catch(t){n(t)}}function a(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}l((s=s.apply(t,e||[])).next())})};const ll="sol-lan-lobbies";class hl{constructor(){this.backgroundParticleLayer=null,this.atmosphereLayer=null,this.menuParticleLayer=null,this.resizeHandler=null,this.onStartCallback=null,this.currentScreen="main",this.carouselMenu=null,this.factionCarousel=null,this.testLevelButton=null,this.ladButton=null,this.lanServerListTimeout=null,this.lanLobbyHeartbeatTimeout=null,this.networkManager=null,this.mainScreenRenderToken=0,this.onlineMode="ranked",this.visibilityHandler=null,this.heroUnits=[{id:"radiant-marine",name:"Marine",description:"Rapid-fire ranged specialist",faction:Jr.RADIANT,maxHealth:jt,attackDamage:Jt,attackSpeed:Qt,attackRange:qt,attackIgnoresDefense:!1,defense:10,regen:4,abilityDescription:"Bullet storm: fires a spread of shots toward a target direction"},{id:"velaris-grave",name:"Grave",description:"Gravitic sentinel with orbiting projectiles",faction:Jr.VELARIS,maxHealth:Zt,attackDamage:ie,attackSpeed:se,attackRange:te*ee,attackIgnoresDefense:!1,defense:18,regen:3,abilityDescription:"Particle storm: flings all large particles at once using accumulated energy"},{id:"velaris-nova",name:"Nova",description:"Remote bomb specialist with bouncing projectile",faction:Jr.VELARIS,maxHealth:hr,attackDamage:dr,attackSpeed:gr,attackRange:cr,attackIgnoresDefense:!1,defense:10,regen:5,abilityDescription:"Remote bomb: throws a bouncing bomb that explodes in a directional scatter when triggered"},{id:"velaris-velaris",name:"Velaris",description:"Sticky laser bomb specialist",faction:Jr.VELARIS,maxHealth:Rr,attackDamage:br,attackSpeed:Lr,attackRange:wr,attackIgnoresDefense:!1,defense:8,regen:4,abilityDescription:"Sticky bomb: throws a bomb that sticks to surfaces and fires 3 lasers (1 wide center, 2 diagonal)"},{id:"radiant-ray",name:"Ray",description:"Bouncing beam marks targets",faction:Jr.RADIANT,maxHealth:no,attackDamage:ao,attackSpeed:lo,attackRange:ro,attackIgnoresDefense:!0,defense:8,regen:5,abilityDescription:"Solar ricochet: beam bounces between multiple enemies"},{id:"radiant-influence-ball",name:"Influence Ball",description:"Deploys temporary influence zones",faction:Jr.RADIANT,maxHealth:po,attackDamage:yo,attackSpeed:mo,attackRange:xo,attackIgnoresDefense:!1,defense:12,regen:6,abilityDescription:"Influence surge: expand an influence zone at target location"},{id:"radiant-turret-deployer",name:"Turret Deployer",description:"Deploys automated turrets on asteroids",faction:Jr.RADIANT,maxHealth:Eo,attackDamage:Po,attackSpeed:Io,attackRange:_o,attackIgnoresDefense:!1,defense:14,regen:4,abilityDescription:"Deploy turret: places a turret on a nearby asteroid"},{id:"radiant-driller",name:"Driller",description:"Burrows through asteroids to flank",faction:Jr.RADIANT,maxHealth:No,attackDamage:ko,attackSpeed:Go,attackRange:Bo,attackIgnoresDefense:!1,defense:16,regen:3,abilityDescription:"Drill charge: tunnels through an asteroid toward the target"},{id:"radiant-dagger",name:"Dagger",description:"Cloaked assassin with burst damage",faction:Jr.RADIANT,maxHealth:Xo,attackDamage:$o,attackSpeed:Ko,attackRange:Yo,attackIgnoresDefense:!1,defense:5,regen:3,abilityDescription:"Shadow strike: short-range burst attack, reveals Dagger for 8 seconds"},{id:"radiant-beam",name:"Beam",description:"Sniper with distance-based damage multiplier",faction:Jr.RADIANT,maxHealth:tn,attackDamage:sn,attackSpeed:on,attackRange:en,attackIgnoresDefense:!0,defense:6,regen:3,abilityDescription:"Precision shot: long-range beam that does more damage at greater distances"},{id:"radiant-spotlight",name:"Spotlight",description:"Reveals enemies in a razor-thin cone",faction:Jr.RADIANT,maxHealth:hn,attackDamage:dn,attackSpeed:0,attackRange:cn,attackIgnoresDefense:!1,defense:8,regen:4,abilityDescription:"Spotlight sweep: 5 cone reveals and rapidly fires at enemies (1s setup, 5s teardown)"},{id:"radiant-mortar",name:"Mortar",description:"Siege unit with splash damage",faction:Jr.RADIANT,maxHealth:In,attackDamage:Mn,attackSpeed:Rn,attackRange:Cn,attackIgnoresDefense:!1,defense:14,regen:2,abilityDescription:"Siege mode: temporarily becomes immobile but gains increased range and damage"},{id:"radiant-preist",name:"Preist",description:"Support healer with dual beams",faction:Jr.RADIANT,maxHealth:vn,attackDamage:0,attackSpeed:0,attackRange:Gn,attackIgnoresDefense:!1,defense:18,regen:4,abilityDescription:"Healing bomb: launches a projectile that explodes into healing particles"},{id:"radiant-tank",name:"Tank",description:"Extremely tough defensive unit with projectile shield",faction:Jr.RADIANT,maxHealth:qn,attackDamage:0,attackSpeed:0,attackRange:0,attackIgnoresDefense:!1,defense:tr,regen:3,abilityDescription:"Crescent wave: sends a slow 90-degree wave that stuns all units and erases projectiles"}],this.availableMaps=[{id:"standard",name:"Standard Battle",description:"Classic 1v1 map with a single sun at the center. Balanced gameplay with moderate obstacles.",numSuns:1,numAsteroids:10,mapSize:2e3},{id:"test-level",name:"Test Level",description:"Minimal layout for AI testing with a single sun, mirrored bases, and no asteroids.",numSuns:1,numAsteroids:0,mapSize:2e3},{id:"twin-suns",name:"Twin Suns",description:"Two suns create complex lighting patterns. Control multiple light sources for economic dominance.",numSuns:2,numAsteroids:12,mapSize:2500},{id:"asteroid-field",name:"Asteroid Field",description:"Dense asteroid field creates tactical challenges. Careful mirror placement is crucial.",numSuns:1,numAsteroids:20,mapSize:2e3},{id:"open-space",name:"Open Space",description:"Minimal obstacles in a vast arena. Pure strategic combat with fewer terrain advantages.",numSuns:1,numAsteroids:5,mapSize:3e3},{id:"lad",name:"LaD",description:'Light and Dark - A split battlefield with a dual sun. White light on one side, black "light" on the other. Units are invisible until they cross into enemy territory.',numSuns:1,numAsteroids:8,mapSize:2e3}],this.baseLoadouts=[{id:"radiant-standard",name:"Standard Forge",description:"Balanced base with standard production",faction:Jr.RADIANT},{id:"aurum-standard",name:"Standard Vault",description:"Balanced base with standard production",faction:Jr.AURUM},{id:"velaris-standard",name:"Standard Temple",description:"Balanced base with standard production",faction:Jr.VELARIS}],this.spawnLoadouts=[{id:"radiant-standard",name:"Standard Starlings",description:"Balanced minions with standard stats",faction:Jr.RADIANT},{id:"aurum-standard",name:"Standard Drones",description:"Balanced minions with standard stats",faction:Jr.AURUM},{id:"velaris-standard",name:"Standard Zealots",description:"Balanced minions with standard stats",faction:Jr.VELARIS}],this.settings={selectedMap:this.availableMaps[0],difficulty:"normal",soundEnabled:!0,musicEnabled:!0,isBattleStatsInfoEnabled:!1,selectedFaction:Jr.RADIANT,selectedHeroes:["radiant-marine"],selectedHeroNames:[],playerColor:"#66B3FF",enemyColor:"#FF6B6B",selectedBaseLoadout:null,selectedSpawnLoadout:null,colorScheme:"SpaceBlack",damageDisplayMode:"damage",healthDisplayMode:"bar",graphicsQuality:"high",username:this.getOrGenerateUsername(),gameMode:"ai"},this.ensureDefaultHeroSelection(),this.menuElement=this.createMenuElement(),document.body.appendChild(this.menuElement),this.visibilityHandler=()=>{document.hidden?this.pauseMenuAnimations():this.resumeMenuAnimations()},document.addEventListener("visibilitychange",this.visibilityHandler)}createMenuElement(){const t=document.createElement("div");t.id="mainMenu",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.boxSizing="border-box",t.style.backgroundColor="transparent",t.style.zIndex="1000",t.style.fontFamily='"Doto", Arial, sans-serif',t.style.fontWeight="300",t.style.fontSize="24px",t.style.color="#FFFFFF",t.style.overflowY="auto",t.style.overflowX="hidden",t.style.isolation="isolate";const e=document.createElement("div");return e.style.position="relative",e.style.zIndex="1",e.style.width="100%",e.style.minHeight="100%",e.style.padding="24px 16px",e.style.boxSizing="border-box",e.style.display="flex",e.style.flexDirection="column",e.style.justifyContent="center",e.style.alignItems="center",t.appendChild(e),this.contentElement=e,this.backgroundParticleLayer=new sl(t),this.atmosphereLayer=new ol(t,this.resolveAssetPath("ASSETS/sprites/environment/centralSun.svg")),this.menuParticleLayer=new nl(t),this.menuParticleLayer.setMenuContentElement(e),t.appendChild(this.createBuildNumberLabel()),this.testLevelButton=this.createTestLevelButton(),t.appendChild(this.testLevelButton),this.ladButton=this.createLadButton(),t.appendChild(this.ladButton),this.renderMainScreenContent(e),this.resizeHandler=()=>{var t,e;null===(t=this.backgroundParticleLayer)||void 0===t||t.resize(),null===(e=this.atmosphereLayer)||void 0===e||e.resize(),this.menuParticleLayer&&(this.menuParticleLayer.resize(),this.menuParticleLayer.requestTargetRefresh(this.contentElement))},window.addEventListener("resize",this.resizeHandler),t.addEventListener("scroll",()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),t}pauseMenuAnimations(){var t,e,i,s,o;null===(t=this.backgroundParticleLayer)||void 0===t||t.stop(),null===(e=this.atmosphereLayer)||void 0===e||e.stop(),null===(i=this.menuParticleLayer)||void 0===i||i.stop(),null===(s=this.carouselMenu)||void 0===s||s.pauseAnimation(),null===(o=this.factionCarousel)||void 0===o||o.pauseAnimation()}resumeMenuAnimations(){var t,e,i,s,o,n;"none"!==this.menuElement.style.display&&(null===(t=this.backgroundParticleLayer)||void 0===t||t.start(),null===(e=this.atmosphereLayer)||void 0===e||e.start(),null===(i=this.menuParticleLayer)||void 0===i||i.start(),null===(s=this.menuParticleLayer)||void 0===s||s.requestTargetRefresh(this.contentElement),null===(o=this.carouselMenu)||void 0===o||o.resumeAnimation(),null===(n=this.factionCarousel)||void 0===n||n.resumeAnimation())}createBuildNumberLabel(){const t=document.createElement("div");return t.textContent="BUILD 31",t.style.position="absolute",t.style.top="16px",t.style.left="16px",t.style.padding="6px 10px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.4)",t.style.backgroundColor="rgba(10, 10, 10, 0.6)",t.style.color="#FFFFFF",t.style.fontFamily='"Doto", Arial, sans-serif',t.style.fontWeight="500",t.style.fontSize="12px",t.style.letterSpacing="0.18em",t.style.textTransform="uppercase",t.style.zIndex="2",t.style.pointerEvents="none",t}createTestLevelButton(){const t=document.createElement("button");return t.textContent="TEST LEVEL",t.type="button",t.style.position="absolute",t.style.top="20px",t.style.right="20px",t.style.padding="10px 16px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.6)",t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.color="#FFFFFF",t.style.fontFamily="Arial, sans-serif",t.style.fontWeight="500",t.style.fontSize="14px",t.style.letterSpacing="0.08em",t.style.cursor="pointer",t.style.zIndex="2",t.style.transition="background-color 0.2s ease, border-color 0.2s ease",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="rgba(60, 60, 60, 0.85)",t.style.borderColor="#FFD700"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.borderColor="rgba(255, 255, 255, 0.6)"}),t.addEventListener("click",()=>{const t=this.availableMaps.find(t=>"test-level"===t.id);t&&(this.settings.selectedMap=t,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings)))}),t}createLadButton(){const t=document.createElement("button");return t.textContent="LaD",t.type="button",t.style.position="absolute",t.style.top="20px",t.style.right="140px",t.style.padding="10px 16px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.6)",t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.color="#FFFFFF",t.style.fontFamily="Arial, sans-serif",t.style.fontWeight="500",t.style.fontSize="14px",t.style.letterSpacing="0.08em",t.style.cursor="pointer",t.style.zIndex="2",t.style.transition="background-color 0.2s ease, border-color 0.2s ease",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="rgba(60, 60, 60, 0.85)",t.style.borderColor="#FFD700"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.borderColor="rgba(255, 255, 255, 0.6)"}),t.addEventListener("click",()=>{const t=this.availableMaps.find(t=>"lad"===t.id);t&&(this.settings.selectedMap=t,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings)))}),t}setTestLevelButtonVisible(t){this.testLevelButton&&(this.testLevelButton.style.display=t?"block":"none")}setLadButtonVisible(t){this.ladButton&&(this.ladButton.style.display=t?"block":"none")}getSelectedHeroNames(){return this.heroUnits.filter(t=>this.settings.selectedHeroes.includes(t.id)).map(t=>t.name)}getDefaultHeroIdsForFaction(t){if(!t)return[];const e=this.heroUnits.find(e=>e.faction===t);return e?[e.id]:[]}getFactionLabelAndColor(t){switch(t){case Jr.RADIANT:return{label:"Radiant",color:"#FF5722"};case Jr.AURUM:return{label:"Aurum",color:"#FFD700"};case Jr.VELARIS:return{label:"Velaris",color:"#9C27B0"};default:return{label:"Unselected",color:"#999999"}}}ensureDefaultHeroSelection(){if(0===this.settings.selectedHeroes.length){const t=this.getDefaultHeroIdsForFaction(this.settings.selectedFaction);t.length>0&&(this.settings.selectedHeroes=[...t])}this.settings.selectedHeroNames=this.getSelectedHeroNames()}generateRandomUsername(){return`player#${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}getOrGenerateUsername(){const t=localStorage.getItem("sol_username");if(t&&""!==t.trim())return t;const e=this.generateRandomUsername();return localStorage.setItem("sol_username",e),e}saveUsername(t){localStorage.setItem("sol_username",t),this.settings.username=t}clearPlayerDataAndCache(){return al(this,void 0,void 0,function*(){if(localStorage.clear(),sessionStorage.clear(),"undefined"!=typeof caches){const t=yield caches.keys();yield Promise.all(t.map(t=>caches.delete(t)))}const t=indexedDB;if(t.databases){const e=yield t.databases();yield Promise.all(e.map(t=>{const e=t.name;return e?new Promise(t=>{const i=indexedDB.deleteDatabase(e);i.addEventListener("success",()=>t()),i.addEventListener("error",()=>t()),i.addEventListener("blocked",()=>t())}):Promise.resolve()}))}})}resolveAssetPath(t){return t.startsWith("ASSETS/")&&window.location.pathname.includes("/dist/")?`../${t}`:t}clearMenu(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.factionCarousel&&(this.factionCarousel.destroy(),this.factionCarousel=null),this.contentElement&&(this.contentElement.innerHTML="",this.contentElement.style.justifyContent="center"),null!==this.lanServerListTimeout&&(clearTimeout(this.lanServerListTimeout),this.lanServerListTimeout=null),null!==this.lanLobbyHeartbeatTimeout&&(clearTimeout(this.lanLobbyHeartbeatTimeout),this.lanLobbyHeartbeatTimeout=null),this.setTestLevelButtonVisible(!1),this.setLadButtonVisible(!1)}setMenuParticleDensity(t){var e;const i=Math.SQRT2;null===(e=this.menuParticleLayer)||void 0===e||e.setDensityMultiplier(t*i)}startMenuTransition(){var t;null===(t=this.menuParticleLayer)||void 0===t||t.startTransition()}loadLanLobbyEntries(){const t=localStorage.getItem(ll);if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.warn("Failed to parse LAN lobby list from storage:",t),[]}}persistLanLobbyEntries(t){localStorage.setItem(ll,JSON.stringify(t))}pruneLanLobbyEntries(t,e){const i=t.filter(t=>e-t.lastSeenMs<=15e3);return i.length!==t.length&&this.persistLanLobbyEntries(i),i}registerLanLobbyEntry(t){var e;const i=Date.now(),s=this.loadLanLobbyEntries(),o=s.filter(e=>e.hostPlayerId!==t.hostPlayerId),n=s.find(e=>e.hostPlayerId===t.hostPlayerId);o.push(Object.assign(Object.assign({},t),{createdMs:null!==(e=null==n?void 0:n.createdMs)&&void 0!==e?e:i,lastSeenMs:i})),this.persistLanLobbyEntries(o)}unregisterLanLobbyEntry(t){const e=this.loadLanLobbyEntries(),i=e.filter(e=>e.hostPlayerId!==t);i.length!==e.length&&this.persistLanLobbyEntries(i)}startLanLobbyHeartbeat(t){null!==this.lanLobbyHeartbeatTimeout&&(clearTimeout(this.lanLobbyHeartbeatTimeout),this.lanLobbyHeartbeatTimeout=null);const e=()=>{this.registerLanLobbyEntry(t),this.lanLobbyHeartbeatTimeout=window.setTimeout(e,5e3)};e()}stopLanLobbyHeartbeat(){null!==this.lanLobbyHeartbeatTimeout&&(clearTimeout(this.lanLobbyHeartbeatTimeout),this.lanLobbyHeartbeatTimeout=null)}renderLanLobbyList(t){t.innerHTML="";const e=Date.now(),i=this.pruneLanLobbyEntries(this.loadLanLobbyEntries(),e).sort((t,e)=>e.lastSeenMs-t.lastSeenMs);if(0===i.length){const e=document.createElement("p");return e.textContent="No LAN lobbies detected yet. Host a game to make it appear here.",e.style.color="#888888",e.style.fontSize="16px",e.style.textAlign="center",e.style.margin="0",void t.appendChild(e)}for(const e of i){const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="row",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.gap="16px",i.style.padding="14px 18px",i.style.borderRadius="8px",i.style.backgroundColor="rgba(0, 0, 0, 0.4)",i.style.border="1px solid rgba(255, 215, 0, 0.3)",i.style.cursor="pointer",i.style.transition="transform 0.15s ease, border-color 0.15s ease",i.addEventListener("mouseenter",()=>{i.style.transform="translateY(-2px)",i.style.borderColor="rgba(255, 215, 0, 0.6)"}),i.addEventListener("mouseleave",()=>{i.style.transform="translateY(0)",i.style.borderColor="rgba(255, 215, 0, 0.3)"});const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.gap="4px",s.style.flex="1";const o=document.createElement("div");o.textContent=e.lobbyName,o.style.color="#FFD700",o.style.fontSize="18px",o.style.fontWeight="600",s.appendChild(o);const n=document.createElement("div");n.textContent=`${e.hostUsername}  ${e.playerCount}/${e.maxPlayerCount} players`,n.style.color="#CCCCCC",n.style.fontSize="14px",s.appendChild(n);const r=this.createButton("JOIN",()=>{this.joinLanLobbyWithCode(e.connectionCode)},"#00AAFF");r.style.padding="8px 18px",r.style.fontSize="14px",r.addEventListener("click",t=>{t.stopPropagation()}),i.addEventListener("click",()=>{this.joinLanLobbyWithCode(e.connectionCode)}),i.appendChild(s),i.appendChild(r),t.appendChild(i)}}scheduleLanLobbyListRefresh(t){null!==this.lanServerListTimeout&&clearTimeout(this.lanServerListTimeout),this.lanServerListTimeout=window.setTimeout(()=>{this.renderLanLobbyList(t),this.scheduleLanLobbyListRefresh(t)},2e3)}joinLanLobbyWithCode(t){return al(this,void 0,void 0,function*(){if(t)try{this.renderClientWaitingScreen();const{offer:e,playerId:i,username:s}=Ia.parseHostCode(t),o=`player_${Date.now()}`;this.networkManager=new Pa(o);const n=yield this.networkManager.connectToPeer(i,e),r=yield Ia.generateAnswerCode(n,o,this.settings.username);this.renderClientAnswerScreen(r,s)}catch(t){console.error("Failed to join lobby:",t),alert(`Failed to join lobby: ${t instanceof Error?t.message:"Unknown error"}`),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)}})}renderMainScreen(t){this.clearMenu(),this.renderMainScreenWhenReady(t)}renderMainScreenWhenReady(t){const e=++this.mainScreenRenderToken;"main"===this.currentScreen&&e===this.mainScreenRenderToken&&this.renderMainScreenContent(t)}renderMainScreenContent(t){var e;this.setTestLevelButtonVisible(!0),this.setLadButtonVisible(!0),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;t.style.justifyContent="flex-start";const s=document.createElement("img");s.src=this.resolveAssetPath("ASSETS/SPRITES/menu/titleGraphic.png"),s.alt="Speed of Light RTS",s.style.width=i?"300px":"480px",s.style.maxWidth="90%",s.style.height="auto",s.style.marginBottom=i?"6px":"12px",s.style.alignSelf="center",t.appendChild(s);const o=document.createElement("div");o.style.width="100%",o.style.maxWidth=i?"100%":"900px",o.style.padding=i?"0 10px":"0",o.style.marginTop="0",o.style.marginBottom=i?"18px":"20px",t.appendChild(o);const{label:n,color:r}=this.getFactionLabelAndColor(this.settings.selectedFaction),a=[{id:"loadout",name:"LOADOUT",description:"Select faction & heroes",subLabel:n,subLabelColor:r},{id:"start",name:"START",description:"Begin game"},{id:"maps",name:"MAPS",description:"Select map"},{id:"settings",name:"SETTINGS",description:"Configure game"}];this.carouselMenu=new dl(o,a,1,"rgba(0, 0, 0, 0.5)"),this.carouselMenu.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onNavigate(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onSelect(t=>{switch(t.id){case"loadout":this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement);break;case"start":this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement);break;case"maps":this.currentScreen="maps",this.startMenuTransition(),this.renderMapSelectionScreen(this.contentElement);break;case"settings":this.currentScreen="settings",this.startMenuTransition(),this.renderSettingsScreen(this.contentElement)}}),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderMapSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Map",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.display="grid",o.style.gridTemplateColumns=`repeat(auto-fit, minmax(${i?220:300}px, 1fr))`,o.style.gap="20px",o.style.maxWidth="900px",o.style.padding="20px",o.style.marginBottom="30px";for(const t of this.availableMaps){const e=document.createElement("div");e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.border="2px solid transparent",e.style.borderRadius="10px",e.style.padding="20px",e.style.cursor="pointer",e.style.transition="all 0.3s",e.dataset.particleBox="true",e.dataset.particleColor=t.id===this.settings.selectedMap.id?"#FFD700":"#66B3FF",e.addEventListener("mouseenter",()=>{t.id!==this.settings.selectedMap.id&&(e.style.backgroundColor="rgba(255, 255, 255, 0.1)",e.style.transform="scale(1.02)")}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.transform="scale(1)"}),e.addEventListener("click",()=>{this.settings.selectedMap=t,this.renderMapSelectionScreen(this.contentElement)});const i=document.createElement("h3");i.textContent=t.name,i.style.fontSize="28px",i.style.marginBottom="10px",i.style.color=t.id===this.settings.selectedMap.id?"#FFD700":"#FFFFFF",i.style.fontWeight="300",i.dataset.particleText="true",i.dataset.particleColor=t.id===this.settings.selectedMap.id?"#FFF2B3":"#E0F2FF",e.appendChild(i);const s=document.createElement("p");s.textContent=t.description,s.style.fontSize="24px",s.style.lineHeight="1.5",s.style.marginBottom="15px",s.style.color="#CCCCCC",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#CCCCCC",e.appendChild(s);const n=document.createElement("div");n.style.fontSize="24px",n.style.color="#888888",n.innerHTML=`\n                <div> Suns: ${t.numSuns}</div>\n                <div> Asteroids: ${t.numAsteroids}</div>\n                <div> Size: ${t.mapSize}px</div>\n            `,e.appendChild(n),o.appendChild(e)}t.appendChild(o);const n=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");t.appendChild(n),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderLANScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="LAN Play",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=this.createButton("HOST SERVER",()=>{this.showHostLobbyDialog()},"#00AA00");o.style.marginBottom="20px",o.style.padding="15px 40px",o.style.fontSize="28px",t.appendChild(o);const n=this.createButton("JOIN SERVER",()=>{this.showJoinLobbyDialog()},"#0088FF");n.style.marginBottom="40px",n.style.padding="15px 40px",n.style.fontSize="28px",t.appendChild(n);const r=document.createElement("div");r.style.maxWidth="720px",r.style.width="100%",r.style.padding="20px",r.style.backgroundColor="rgba(0, 0, 0, 0.35)",r.style.borderRadius="12px",r.style.border="2px solid rgba(255, 215, 0, 0.25)",r.style.marginBottom="30px",r.style.display="flex",r.style.flexDirection="column",r.style.gap="14px";const a=document.createElement("h3");a.textContent="Available LAN Lobbies",a.style.fontSize="22px",a.style.margin="0",a.style.color="#FFD700",a.style.textAlign="center",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="12px",r.appendChild(l),this.renderLanLobbyList(l),this.scheduleLanLobbyListRefresh(l),t.appendChild(r);const h=document.createElement("div");h.style.maxWidth="600px",h.style.width="100%",h.style.padding="20px",h.style.backgroundColor="rgba(0, 0, 0, 0.3)",h.style.borderRadius="10px",h.style.border="2px solid rgba(255, 255, 255, 0.2)",h.style.marginBottom="30px";const c=document.createElement("h3");c.textContent="How LAN Play Works",c.style.fontSize="24px",c.style.marginBottom="15px",c.style.color="#FFD700",c.style.textAlign="center",h.appendChild(c);const d=document.createElement("p");d.innerHTML='\n            <strong>For Host:</strong><br>\n            1. Click "HOST SERVER" to create a lobby<br>\n            2. Share the connection code with other players<br>\n            3. Wait for players to join<br>\n            4. Start the game when ready<br><br>\n            <strong>For Client:</strong><br>\n            1. Click "JOIN SERVER"<br>\n            2. Enter the connection code from the host<br>\n            3. Wait in lobby for host to start the game\n        ',d.style.color="#CCCCCC",d.style.fontSize="16px",d.style.lineHeight="1.6",h.appendChild(d),t.appendChild(h);const g=this.createButton("BACK",()=>{this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement)},"#666666");t.appendChild(g),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}showHostLobbyDialog(){return al(this,void 0,void 0,function*(){const t=`player_${Date.now()}`;this.networkManager=new Pa(t);const e=`${this.settings.username}'s lobby`,i=this.networkManager.createLobby(e,this.settings.username,2);try{const e=yield this.networkManager.createOfferForPeer("client"),s=yield Ia.generateHostCode(e,t,this.settings.username);this.renderHostLobbyScreen(i,s,t)}catch(t){console.error("Failed to create lobby:",t),alert("Failed to create lobby. Please try again.")}})}showJoinLobbyDialog(){return al(this,void 0,void 0,function*(){const t=prompt("Enter the connection code from the host:");t&&(yield this.joinLanLobbyWithCode(t.trim()))})}renderHostLobbyScreen(t,e,i){var s,o,n;this.clearMenu(),this.setMenuParticleDensity(1.6);const r=window.innerWidth<600;this.startLanLobbyHeartbeat({hostPlayerId:i,lobbyName:t.name,hostUsername:null!==(o=null===(s=t.players.find(t=>t.isHost))||void 0===s?void 0:s.username)&&void 0!==o?o:this.settings.username,connectionCode:e,maxPlayerCount:t.maxPlayers,playerCount:t.players.length});const a=document.createElement("h2");a.textContent="Lobby: "+t.name,a.style.fontSize=r?"28px":"36px",a.style.marginBottom="20px",a.style.color="#FFD700",a.style.textAlign="center",a.dataset.particleText="true",a.dataset.particleColor="#FFD700",this.contentElement.appendChild(a);const l=document.createElement("div");l.style.maxWidth="600px",l.style.width="100%",l.style.padding="20px",l.style.backgroundColor="rgba(0, 100, 0, 0.3)",l.style.borderRadius="10px",l.style.border="2px solid rgba(0, 255, 0, 0.3)",l.style.marginBottom="20px";const h=document.createElement("p");h.textContent="Share this connection code:",h.style.color="#CCCCCC",h.style.fontSize="18px",h.style.marginBottom="10px",l.appendChild(h);const c=document.createElement("textarea");c.value=e,c.readOnly=!0,c.style.width="100%",c.style.height="80px",c.style.padding="10px",c.style.backgroundColor="rgba(0, 0, 0, 0.5)",c.style.color="#00FF00",c.style.border="1px solid rgba(255, 255, 255, 0.3)",c.style.borderRadius="5px",c.style.fontSize="14px",c.style.fontFamily="monospace",c.style.resize="none",l.appendChild(c);const d=this.createButton("COPY CODE",()=>al(this,void 0,void 0,function*(){try{yield navigator.clipboard.writeText(c.value),alert("Connection code copied to clipboard!")}catch(t){c.select(),document.execCommand("copy"),alert("Connection code copied to clipboard!")}}),"#008800");d.style.marginTop="10px",d.style.padding="10px 20px",d.style.fontSize="16px",l.appendChild(d),this.contentElement.appendChild(l);const g=document.createElement("div");g.style.maxWidth="600px",g.style.width="100%",g.style.padding="20px",g.style.backgroundColor="rgba(0, 0, 100, 0.3)",g.style.borderRadius="10px",g.style.border="2px solid rgba(0, 100, 255, 0.3)",g.style.marginBottom="30px";const u=document.createElement("p");u.textContent="Paste the answer code from the client:",u.style.color="#CCCCCC",u.style.fontSize="18px",u.style.marginBottom="10px",g.appendChild(u);const p=document.createElement("textarea");p.placeholder="Paste answer code here...",p.style.width="100%",p.style.height="80px",p.style.padding="10px",p.style.backgroundColor="rgba(0, 0, 0, 0.5)",p.style.color="#FFFFFF",p.style.border="1px solid rgba(255, 255, 255, 0.3)",p.style.borderRadius="5px",p.style.fontSize="14px",p.style.fontFamily="monospace",p.style.resize="none",g.appendChild(p);const x=this.createButton("CONNECT",()=>al(this,void 0,void 0,function*(){var t,s;const o=p.value.trim();if(o)try{const{answer:n,playerId:r,username:a}=Ia.parseAnswerCode(o);if(yield null===(t=this.networkManager)||void 0===t?void 0:t.completeConnection(r,n),this.networkManager&&this.networkManager.getLobby()){const t=this.networkManager.getLobby();t.players.push({id:r,username:a,isHost:!1,isReady:!0}),this.networkManager.broadcast({type:Aa.LOBBY_UPDATE,senderId:i,timestamp:Date.now(),data:t});const o=t.players.find(t=>t.isHost);this.registerLanLobbyEntry({hostPlayerId:i,lobbyName:t.name,hostUsername:null!==(s=null==o?void 0:o.username)&&void 0!==s?s:this.settings.username,connectionCode:e,maxPlayerCount:t.maxPlayers,playerCount:t.players.length})}alert(`${a} connected! You can now start the game.`)}catch(t){console.error("Failed to connect client:",t),alert(`Failed to connect: ${t instanceof Error?t.message:"Invalid answer code"}`)}else alert("Please paste the answer code from the client.")}),"#0088FF");x.style.marginTop="10px",x.style.padding="10px 20px",x.style.fontSize="16px",g.appendChild(x),this.contentElement.appendChild(g);const y=this.createButton("START GAME",()=>{this.networkManager?0!==this.networkManager.getPeerCount()?(this.networkManager.startGame(),this.unregisterLanLobbyEntry(i),this.stopLanLobbyHeartbeat(),this.settings.gameMode="lan",this.settings.networkManager=this.networkManager,this.onStartCallback&&(this.hide(),this.onStartCallback(this.settings))):alert("Please wait for at least one player to connect before starting."):alert("Network manager not initialized.")},"#FF8800");y.style.marginBottom="20px",y.style.padding="15px 40px",y.style.fontSize="24px",this.contentElement.appendChild(y);const m=this.createButton("CANCEL",()=>{this.networkManager&&(this.networkManager.disconnect(),this.networkManager=null),this.unregisterLanLobbyEntry(i),this.stopLanLobbyHeartbeat(),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)},"#666666");this.contentElement.appendChild(m),null===(n=this.menuParticleLayer)||void 0===n||n.requestTargetRefresh(this.contentElement)}renderClientAnswerScreen(t,e){var i,s;this.clearMenu(),this.setMenuParticleDensity(1.6);const o=document.createElement("h2");o.textContent=`Joining ${e}'s Lobby`,o.style.fontSize="32px",o.style.marginBottom="20px",o.style.color="#FFD700",o.style.textAlign="center",o.dataset.particleText="true",o.dataset.particleColor="#FFD700",this.contentElement.appendChild(o);const n=document.createElement("p");n.textContent="Send this answer code to the host:",n.style.color="#CCCCCC",n.style.fontSize="18px",n.style.textAlign="center",n.style.marginBottom="20px",this.contentElement.appendChild(n);const r=document.createElement("div");r.style.maxWidth="600px",r.style.width="100%",r.style.padding="20px",r.style.backgroundColor="rgba(0, 0, 100, 0.3)",r.style.borderRadius="10px",r.style.border="2px solid rgba(0, 100, 255, 0.3)",r.style.marginBottom="30px";const a=document.createElement("textarea");a.value=t,a.readOnly=!0,a.style.width="100%",a.style.height="80px",a.style.padding="10px",a.style.backgroundColor="rgba(0, 0, 0, 0.5)",a.style.color="#0088FF",a.style.border="1px solid rgba(255, 255, 255, 0.3)",a.style.borderRadius="5px",a.style.fontSize="14px",a.style.fontFamily="monospace",a.style.resize="none",r.appendChild(a);const l=this.createButton("COPY CODE",()=>al(this,void 0,void 0,function*(){try{yield navigator.clipboard.writeText(a.value),alert("Answer code copied to clipboard!")}catch(t){a.select(),document.execCommand("copy"),alert("Answer code copied to clipboard!")}}),"#0088FF");l.style.marginTop="10px",l.style.padding="10px 20px",l.style.fontSize="16px",r.appendChild(l),this.contentElement.appendChild(r);const h=document.createElement("p");h.textContent="Waiting for host to complete connection...",h.style.color="#888888",h.style.fontSize="18px",h.style.textAlign="center",h.style.marginBottom="30px",this.contentElement.appendChild(h),null===(i=this.networkManager)||void 0===i||i.on(Ta.MESSAGE_RECEIVED,t=>{t&&t.type===Aa.GAME_START&&this.onStartCallback&&(this.settings.gameMode="lan",this.settings.networkManager=this.networkManager,this.hide(),this.onStartCallback(this.settings))});const c=this.createButton("CANCEL",()=>{this.networkManager&&(this.networkManager.disconnect(),this.networkManager=null),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)},"#666666");this.contentElement.appendChild(c),null===(s=this.menuParticleLayer)||void 0===s||s.requestTargetRefresh(this.contentElement)}renderClientWaitingScreen(){var t;this.clearMenu(),this.setMenuParticleDensity(1.6);const e=document.createElement("h2");e.textContent="Connecting to Host...",e.style.fontSize="36px",e.style.marginBottom="30px",e.style.color="#FFD700",e.style.textAlign="center",e.dataset.particleText="true",e.dataset.particleColor="#FFD700",this.contentElement.appendChild(e);const i=document.createElement("p");i.textContent="Waiting for host to complete the connection...",i.style.color="#CCCCCC",i.style.fontSize="20px",i.style.textAlign="center",i.style.marginBottom="30px",this.contentElement.appendChild(i);const s=this.createButton("CANCEL",()=>{this.networkManager&&(this.networkManager.disconnect(),this.networkManager=null),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)},"#666666");this.contentElement.appendChild(s),null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}renderOnlinePlaceholderScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Online Play",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.display="flex",o.style.gap="20px",o.style.marginBottom="30px",o.style.justifyContent="center";const n=this.createButton("UNRANKED",()=>{this.onlineMode="unranked",this.renderOnlinePlaceholderScreen(this.contentElement)},"unranked"===this.onlineMode?"#FF8800":"#666666");n.style.padding="12px 24px",n.style.fontSize="18px","unranked"===this.onlineMode&&(n.style.border="2px solid #FF8800",n.style.boxShadow="0 0 15px rgba(255, 136, 0, 0.5)"),o.appendChild(n);const r=this.createButton("RANKED",()=>{this.onlineMode="ranked",this.renderOnlinePlaceholderScreen(this.contentElement)},"ranked"===this.onlineMode?"#FF8800":"#666666");r.style.padding="12px 24px",r.style.fontSize="18px","ranked"===this.onlineMode&&(r.style.border="2px solid #FF8800",r.style.boxShadow="0 0 15px rgba(255, 136, 0, 0.5)"),o.appendChild(r),t.appendChild(o);const a=document.createElement("div");a.style.maxWidth="600px",a.style.padding="40px",a.style.backgroundColor="rgba(0, 0, 0, 0.3)",a.style.borderRadius="10px",a.style.border="2px solid rgba(255, 215, 0, 0.3)",a.style.marginBottom="30px";const l=document.createElement("h3");l.textContent="Coming Soon!",l.style.fontSize="32px",l.style.color="#FFD700",l.style.textAlign="center",l.style.marginBottom="20px",l.style.fontWeight="300",a.appendChild(l);const h=document.createElement("p");h.innerHTML="\n            Online multiplayer is currently in development.<br><br>\n            <strong>Features:</strong><br>\n             Simple, efficient data transmission<br>\n             Prioritized for speed and minimal data size<br>\n             Cross-platform matchmaking<br>\n             Ranked and casual modes\n        ",h.style.fontSize="20px",h.style.color="#CCCCCC",h.style.textAlign="center",h.style.lineHeight="1.6",a.appendChild(h),t.appendChild(a);const c=this.createButton("BACK",()=>{this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement)},"#666666");t.appendChild(c),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderSettingsScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Settings",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.maxWidth="500px",o.style.width="100%",o.style.padding="20px";const n=this.createSettingSection("Difficulty",this.createSelect(["easy","normal","hard"],this.settings.difficulty,t=>{this.settings.difficulty=t}));o.appendChild(n);const r=this.createSettingSection("Username",this.createTextInput(this.settings.username,t=>{this.saveUsername(t)},"Enter your username"));o.appendChild(r);const a=this.createSettingSection("Sound Effects",this.createToggle(this.settings.soundEnabled,t=>{this.settings.soundEnabled=t}));o.appendChild(a);const l=this.createSettingSection("Music",this.createToggle(this.settings.musicEnabled,t=>{this.settings.musicEnabled=t}));o.appendChild(l);const h=this.createSettingSection("Battle Stats Info",this.createToggle(this.settings.isBattleStatsInfoEnabled,t=>{this.settings.isBattleStatsInfoEnabled=t}));o.appendChild(h);const c=this.createSettingSection("Player Color",this.createColorPicker(this.settings.playerColor,t=>{this.settings.playerColor=t}));o.appendChild(c);const d=this.createSettingSection("Enemy Color",this.createColorPicker(this.settings.enemyColor,t=>{this.settings.enemyColor=t}));o.appendChild(d);const g=this.createSettingSection("Graphics Quality",this.createSelect(["low","medium","high"],this.settings.graphicsQuality,t=>{this.settings.graphicsQuality=t}));o.appendChild(g);const u=this.createSettingSection("Color Scheme",this.createSelect(Object.keys(rl),this.settings.colorScheme,t=>{this.settings.colorScheme=t}));o.appendChild(u);const p=this.createButton("DELETE DATA",()=>al(this,void 0,void 0,function*(){window.confirm("Delete all player data and cached files? This will reload the game and start fresh.")&&(yield this.clearPlayerDataAndCache(),window.location.reload())}),"#FF6666");p.style.fontSize="18px",p.style.padding="10px 20px";const x=this.createSettingSection("Reset Player Data",p);o.appendChild(x),t.appendChild(o);const y=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");y.style.marginTop="30px",t.appendChild(y),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderGameModeSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Game Mode",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.width="100%",o.style.maxWidth=i?"100%":"900px",o.style.padding=i?"0 10px":"0",o.style.marginBottom=i?"18px":"20px",t.appendChild(o),this.carouselMenu=new dl(o,[{id:"ai",name:"AI",description:"Play against computer opponent"},{id:"online",name:"ONLINE",description:"Play against players worldwide"},{id:"lan",name:"LAN",description:"Play on local network"}],0),this.carouselMenu.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onNavigate(()=>{var t;this.startMenuTransition(),null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onSelect(t=>{switch(this.settings.gameMode=t.id,t.id){case"ai":this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings));break;case"online":this.currentScreen="online",this.startMenuTransition(),this.renderOnlinePlaceholderScreen(this.contentElement);break;case"lan":this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)}});const n=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");n.style.marginTop="30px",t.appendChild(n),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderFactionSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Your Faction",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"8px":"12px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.width="100%",o.style.maxWidth=i?"100%":"900px",o.style.padding=i?"0 10px":"0",o.style.marginBottom="12px",t.appendChild(o);const n=[{id:Jr.RADIANT,name:"Radiant",description:"Well-Balanced, Ranged-Focused",color:"#FF5722"},{id:Jr.AURUM,name:"Aurum",description:"Fast-Paced, Melee-Focused",color:"#FFD700"},{id:Jr.VELARIS,name:"Velaris",description:"Strategic, Ability-Heavy. Particles from Nebulae",color:"#9C27B0"}],r=n.findIndex(t=>t.id===this.settings.selectedFaction),a=r>=0?r:0;!this.settings.selectedFaction&&n.length>0&&(this.settings.selectedFaction=n[a].id),this.factionCarousel=new cl(o,n,a),this.factionCarousel.onSelectionChange(t=>{var e;this.settings.selectedFaction!==t.id&&(this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection()),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}),this.factionCarousel.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)});const l=document.createElement("div");if(l.style.display="flex",l.style.gap="20px",l.style.marginTop="8px",l.style.flexWrap="wrap",l.style.justifyContent="center",i&&(l.style.flexDirection="column",l.style.alignItems="center"),this.settings.selectedFaction){const t=this.createButton("CUSTOMIZE LOADOUT",()=>{this.currentScreen="loadout-customization",this.startMenuTransition(),this.renderLoadoutCustomizationScreen(this.contentElement)},"#00FF88");l.appendChild(t)}const h=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");l.appendChild(h),t.appendChild(l),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderLoadoutCustomizationScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;if(!this.settings.selectedFaction)return this.currentScreen="faction-select",void this.renderFactionSelectionScreen(t);const s=document.createElement("h2");s.textContent="Customize Loadout",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="bold",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=this.baseLoadouts.filter(t=>t.faction===this.settings.selectedFaction),n=this.spawnLoadouts.filter(t=>t.faction===this.settings.selectedFaction);!this.settings.selectedBaseLoadout&&o.length>0&&(this.settings.selectedBaseLoadout=o[0].id),!this.settings.selectedSpawnLoadout&&n.length>0&&(this.settings.selectedSpawnLoadout=n[0].id);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="40px",r.style.width="100%",r.style.maxWidth=i?"100%":"800px",r.style.padding=i?"0 10px":"0 20px",t.appendChild(r),this.createLoadoutSection(r,"Base Loadout",o,this.settings.selectedBaseLoadout,t=>{this.settings.selectedBaseLoadout=t},i),this.createLoadoutSection(r,"Spawn Loadout",n,this.settings.selectedSpawnLoadout,t=>{this.settings.selectedSpawnLoadout=t},i);const a=document.createElement("div");a.style.marginTop="20px";const l=document.createElement("h3");l.textContent="Hero Loadout",l.style.fontSize=i?"24px":"32px",l.style.color="#00AAFF",l.style.marginBottom="15px",l.style.fontWeight="bold",l.dataset.particleText="true",l.dataset.particleColor="#00AAFF",a.appendChild(l);const h=document.createElement("div");h.textContent=this.settings.selectedHeroes.length>0?`Selected: ${this.settings.selectedHeroNames.join(", ")}`:"No heroes selected yet",h.style.fontSize="20px",h.style.color="#CCCCCC",h.style.marginBottom="15px",a.appendChild(h);const c=this.createButton("SELECT HEROES",()=>{this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement)},"#00FF88");a.appendChild(c),r.appendChild(a);const d=document.createElement("div");d.style.display="flex",d.style.gap="20px",d.style.marginTop="30px",d.style.flexWrap="wrap",d.style.justifyContent="center",i&&(d.style.flexDirection="column",d.style.alignItems="center");const g=this.createButton("BACK",()=>{this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement)},"#666666");d.appendChild(g),t.appendChild(d),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}createLoadoutSection(t,e,i,s,o,n){const r=document.createElement("div"),a=document.createElement("h3");a.textContent=e,a.style.fontSize=n?"24px":"32px",a.style.color="#00AAFF",a.style.marginBottom="15px",a.style.fontWeight="bold",a.dataset.particleText="true",a.dataset.particleColor="#00AAFF",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="10px",i.forEach(t=>{const e=t.id===s,i=document.createElement("div");i.style.padding="15px",i.style.backgroundColor=e?"rgba(0, 170, 255, 0.2)":"rgba(0, 0, 0, 0.3)",i.style.border=e?"2px solid #00AAFF":"2px solid rgba(255, 255, 255, 0.2)",i.style.borderRadius="8px",i.style.cursor="pointer",i.style.transition="all 0.2s";const n=document.createElement("div");n.textContent=t.name,n.style.fontSize="22px",n.style.color=e?"#00AAFF":"#FFFFFF",n.style.fontWeight="bold",n.style.marginBottom="5px",n.dataset.particleText="true",n.dataset.particleColor=e?"#00AAFF":"#FFFFFF",i.appendChild(n);const r=document.createElement("div");r.textContent=t.description,r.style.fontSize="18px",r.style.color="#CCCCCC",i.appendChild(r),i.addEventListener("click",()=>{o(t.id),this.renderLoadoutCustomizationScreen(this.contentElement)}),i.addEventListener("mouseenter",()=>{e||(i.style.backgroundColor="rgba(0, 170, 255, 0.1)",i.style.borderColor="#00AAFF")}),i.addEventListener("mouseleave",()=>{e||(i.style.backgroundColor="rgba(0, 0, 0, 0.3)",i.style.borderColor="rgba(255, 255, 255, 0.2)")}),l.appendChild(i)}),r.appendChild(l),t.appendChild(r)}renderLoadoutSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;t.style.justifyContent="flex-start";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="flex-start",s.style.width="100%",s.style.maxWidth=i?"100%":"900px",s.style.padding=i?"10px":"10px 0",s.style.alignSelf="center";const o=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");o.style.fontSize="18px",o.style.padding="8px 18px",s.appendChild(o),t.appendChild(s);const n=document.createElement("div");n.style.width="100%",n.style.maxWidth=i?"100%":"900px",n.style.padding=i?"0 10px":"0",n.style.marginBottom=i?"10px":"12px",t.appendChild(n);const r=[{id:Jr.RADIANT,name:"Radiant",description:"Well-Balanced, Ranged-Focused",color:"#FF5722"},{id:Jr.AURUM,name:"Aurum",description:"Fast-Paced, Melee-Focused",color:"#FFD700"},{id:Jr.VELARIS,name:"Velaris",description:"Strategic, Ability-Heavy. Particles from Nebulae",color:"#9C27B0"}],a=r.findIndex(t=>t.id===this.settings.selectedFaction),l=a>=0?a:0;!this.settings.selectedFaction&&r.length>0&&(this.settings.selectedFaction=r[l].id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection()),this.factionCarousel=new cl(n,r,l),this.factionCarousel.onSelectionChange(t=>{var e;if(this.settings.selectedFaction!==t.id)return this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection(),void this.renderLoadoutSelectionScreen(this.contentElement);null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}),this.factionCarousel.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)});const h=document.createElement("h2");h.textContent="Select 4 Heroes",h.style.fontSize=i?"26px":"36px",h.style.marginBottom=i?"8px":"12px",h.style.color="#FFD700",h.style.textAlign="center",h.style.maxWidth="100%",h.style.fontWeight="300",h.dataset.particleText="true",h.dataset.particleColor="#FFD700",t.appendChild(h),this.settings.selectedHeroNames=this.getSelectedHeroNames();const c=document.createElement("div");c.textContent=`Selected: ${this.settings.selectedHeroes.length} / 4`,c.style.fontSize=i?"24px":"26px",c.style.marginBottom=i?"20px":"30px",c.style.color=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",c.style.fontWeight="300",c.dataset.particleText="true",c.dataset.particleColor=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",t.appendChild(c);const d=document.createElement("div");d.style.display="grid",d.style.gridTemplateColumns=i?"repeat(2, minmax(0, 1fr))":"repeat(auto-fit, minmax(280px, 1fr))",d.style.gap="15px",d.style.maxWidth="1200px",d.style.padding="20px",d.style.marginBottom="20px",d.style.maxHeight=i?"none":"600px",d.style.overflowY=i?"visible":"auto";const g=this.heroUnits.filter(t=>t.faction===this.settings.selectedFaction);for(const t of g){const e=this.settings.selectedHeroes.includes(t.id),i=e||this.settings.selectedHeroes.length<4,s=document.createElement("div");s.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.border="2px solid transparent",s.style.borderRadius="10px",s.style.padding="15px",s.style.cursor=i?"pointer":"not-allowed",s.style.transition="all 0.3s",s.style.opacity=i?"1":"0.5",s.style.minHeight="300px",s.dataset.particleBox="true",s.dataset.particleColor=e?"#00FF88":"#66B3FF",i&&(s.addEventListener("mouseenter",()=>{e||(s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.transform="scale(1.02)")}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.transform="scale(1)"}),s.addEventListener("click",()=>{e?this.settings.selectedHeroes=this.settings.selectedHeroes.filter(e=>e!==t.id):this.settings.selectedHeroes.length<4&&this.settings.selectedHeroes.push(t.id),this.settings.selectedHeroNames=this.getSelectedHeroNames(),this.renderLoadoutSelectionScreen(this.contentElement)}));const o=document.createElement("h4");o.textContent=t.name,o.style.fontSize="24px",o.style.marginBottom="8px",o.style.color=e?"#00FF88":"#E0F2FF",o.style.fontWeight="300",o.dataset.particleText="true",o.dataset.particleColor=e?"#00FF88":"#E0F2FF",s.appendChild(o);const n=document.createElement("p");n.textContent=t.description,n.style.fontSize="24px",n.style.lineHeight="1.4",n.style.color="#AAAAAA",n.style.marginBottom="10px",n.style.fontWeight="300",n.dataset.particleText="true",n.dataset.particleColor="#AAAAAA",s.appendChild(n);const r=document.createElement("div");r.style.fontSize="24px",r.style.lineHeight="1.6",r.style.color="#CCCCCC",r.style.marginBottom="8px",r.style.padding="8px",r.style.backgroundColor="rgba(0, 0, 0, 0.3)",r.style.borderRadius="5px",r.style.fontWeight="300";const a=document.createElement("div");a.textContent=`HP: ${t.maxHealth}`,a.style.color="#CCCCCC",a.style.fontWeight="bold",a.dataset.particleText="true",a.dataset.particleColor="#CCCCCC",r.appendChild(a);const l=document.createElement("div");l.textContent=`RGN: ${t.regen}%`,l.style.color="#CCCCCC",l.style.fontWeight="bold",l.dataset.particleText="true",l.dataset.particleColor="#CCCCCC",r.appendChild(l);const h=document.createElement("div");h.textContent=`DEF: ${t.defense}%`,h.style.color="#CCCCCC",h.style.fontWeight="bold",h.dataset.particleText="true",h.dataset.particleColor="#CCCCCC",r.appendChild(h);const c=document.createElement("div"),g=t.attackIgnoresDefense?" (ignores defense)":"";c.textContent=`ATK: ${t.attackDamage}${g}`,c.style.color="#CCCCCC",c.style.fontWeight="bold",c.dataset.particleText="true",c.dataset.particleColor="#CCCCCC",r.appendChild(c);const u=document.createElement("div");u.textContent=`SPD: ${t.attackSpeed}/s`,u.style.color="#CCCCCC",u.style.fontWeight="bold",u.dataset.particleText="true",u.dataset.particleColor="#CCCCCC",r.appendChild(u);const p=document.createElement("div");p.textContent=`RNG: ${t.attackRange}`,p.style.color="#CCCCCC",p.style.fontWeight="bold",p.dataset.particleText="true",p.dataset.particleColor="#CCCCCC",r.appendChild(p),s.appendChild(r);const x=document.createElement("div");if(x.style.fontSize="24px",x.style.lineHeight="1.4",x.style.color="#FFD700",x.style.marginBottom="8px",x.style.fontStyle="italic",x.style.fontWeight="bold",x.textContent=`${t.abilityDescription}`,x.dataset.particleText="true",x.dataset.particleColor="#FFD700",s.appendChild(x),e){const t=document.createElement("div");t.textContent=" Selected",t.style.fontSize="24px",t.style.marginTop="8px",t.style.color="#00FF88",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#00FF88",s.appendChild(t)}d.appendChild(s)}t.appendChild(d);const u=document.createElement("div");u.style.display="flex",u.style.gap="20px",u.style.marginTop="20px",u.style.flexWrap="wrap",u.style.justifyContent="center",i&&(u.style.flexDirection="column",u.style.alignItems="center");const p=this.createButton("CUSTOMIZE LOADOUT",()=>{this.currentScreen="loadout-customization",this.startMenuTransition(),this.renderLoadoutCustomizationScreen(this.contentElement)},"#00AAFF");if(u.appendChild(p),4===this.settings.selectedHeroes.length){const t=this.createButton("CONFIRM LOADOUT",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#00FF88");u.appendChild(t)}t.appendChild(u),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}createButton(t,e,i="#FFD700"){const s=document.createElement("button");return s.textContent=t,s.style.fontSize="24px",s.style.padding="15px 40px",s.style.backgroundColor="rgba(0, 0, 0, 0.35)",s.style.color="#666666"===i?"#FFFFFF":i,s.style.border="2px solid transparent",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontWeight="300",s.style.fontFamily="inherit",s.style.transition="all 0.3s",s.dataset.particleBox="true",s.dataset.particleColor=i,s.addEventListener("mouseenter",()=>{s.style.backgroundColor="rgba(255, 255, 255, 0.12)",s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor="rgba(0, 0, 0, 0.35)",s.style.transform="scale(1)"}),s.addEventListener("click",e),s}createSettingSection(t,e){const i=document.createElement("div");i.style.marginBottom="30px",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center";const s=document.createElement("label");return s.textContent=t,s.style.fontSize="24px",s.style.color="#FFFFFF",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFFFFF",i.appendChild(s),i.appendChild(e),i}createSelect(t,e,i){const s=document.createElement("select");s.style.fontSize="24px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontFamily="inherit",s.style.fontWeight="300";for(const i of t){const t=document.createElement("option");t.value=i,t.textContent=i.charAt(0).toUpperCase()+i.slice(1),t.selected=i===e,t.style.backgroundColor=$s,s.appendChild(t)}return s.addEventListener("change",()=>{i(s.value)}),s}createToggle(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="60px",s.style.height="30px",s.style.backgroundColor=t?"#00FF88":"#666666",s.style.borderRadius="15px",s.style.position="relative",s.style.cursor="pointer",s.style.transition="all 0.3s";const o=document.createElement("div");return o.style.width="26px",o.style.height="26px",o.style.backgroundColor="#FFFFFF",o.style.borderRadius="50%",o.style.position="absolute",o.style.top="2px",o.style.left=t?"32px":"2px",o.style.transition="all 0.3s",s.appendChild(o),s.addEventListener("click",()=>{const i=!t;t=i,s.style.backgroundColor=i?"#00FF88":"#666666",o.style.left=i?"32px":"2px",e(i)}),i.appendChild(s),i}createColorPicker(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="40px",s.style.height="40px",s.style.backgroundColor=t,s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer";const o=document.createElement("input");return o.type="color",o.value=t,o.style.opacity="0",o.style.width="0",o.style.height="0",o.style.position="absolute",o.addEventListener("change",()=>{s.style.backgroundColor=o.value,e(o.value)}),s.addEventListener("click",()=>{o.click()}),i.appendChild(s),i.appendChild(o),i}validateUsername(t){let e=t.trim().substring(0,20);return e.length<1?this.generateRandomUsername():e}createTextInput(t,e,i=""){const s=document.createElement("input");return s.type="text",s.value=t,s.placeholder=i,s.style.fontSize="20px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.fontFamily="inherit",s.style.fontWeight="300",s.style.minWidth="200px",s.maxLength=20,s.style.outline="none",s.addEventListener("blur",()=>{const t=this.validateUsername(s.value);s.value=t,s.style.borderColor="rgba(255, 255, 255, 0.3)",e(t)}),s.addEventListener("focus",()=>{s.style.borderColor="rgba(255, 255, 255, 0.6)"}),s}onStart(t){this.onStartCallback=t}showMatchLoadingScreen(){const t=document.createElement("div");t.id="match-loading-screen",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.backgroundColor="#000011",t.style.zIndex="2000",t.style.display="flex",t.style.flexDirection="column",t.style.justifyContent="flex-start",t.style.alignItems="flex-start",t.style.padding="40px";const e=document.createElement("div");e.style.position="absolute",e.style.top="40px",e.style.left="40px",e.style.fontSize="36px",e.style.color="#FFD700",e.style.fontWeight="300";const i=document.createElement("div");let s="ai"===this.settings.gameMode?"Vs. AI":"lan"===this.settings.gameMode?"LAN":"online"===this.settings.gameMode?"ranked"===this.onlineMode?"Ranked":"Unranked":"Vs. AI";if(i.textContent=s,e.appendChild(i),"online"===this.settings.gameMode&&"ranked"===this.onlineMode){const t=document.createElement("div");t.textContent="MMR: 1000",t.style.fontSize="24px",t.style.marginTop="10px",t.style.color="#D0D0D0",e.appendChild(t);const i=document.createElement("div");i.textContent="Win: +16",i.style.fontSize="20px",i.style.marginTop="8px",i.style.color="#00FF00",e.appendChild(i);const s=document.createElement("div");s.textContent="Loss: -37",s.style.fontSize="20px",s.style.marginTop="4px",s.style.color="#FF6666",e.appendChild(s)}t.appendChild(e);const o=document.createElement("div");o.style.position="absolute",o.style.bottom="40px",o.style.left="40px",o.style.display="flex",o.style.alignItems="center",o.style.gap="20px";const n=document.createElement("img");n.id="match-loading-animation",n.src=this.resolveAssetPath("ASSETS/sprites/loadingScreen/loadingAnimation/frame (1).png"),n.style.width="60px",n.style.height="auto",o.appendChild(n);const r=document.createElement("div");r.textContent="Loading...",r.style.fontSize="24px",r.style.color="#D0D0D0",r.style.fontWeight="300",o.appendChild(r),t.appendChild(o),document.body.appendChild(t);const a=1e3/60;let l=0,h=performance.now(),c=0;const d=t=>{if(!n.parentElement)return;const e=t-h;for(h=t,c+=e;c>=a;)l=(l+1)%25,c-=a;const i=l+1;n.src=this.resolveAssetPath(`ASSETS/sprites/loadingScreen/loadingAnimation/frame (${i}).png`),requestAnimationFrame(d)};requestAnimationFrame(d),setTimeout(()=>{t.remove()},1500)}hide(){this.menuElement.style.display="none",this.pauseMenuAnimations(),this.showMatchLoadingScreen()}show(){this.menuElement.style.display="block",this.currentScreen="main",this.renderMainScreen(this.contentElement),this.resumeMenuAnimations()}destroy(){var t,e,i;this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.factionCarousel&&(this.factionCarousel.destroy(),this.factionCarousel=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),null===(t=this.backgroundParticleLayer)||void 0===t||t.destroy(),null===(e=this.atmosphereLayer)||void 0===e||e.destroy(),null===(i=this.menuParticleLayer)||void 0===i||i.stop(),this.menuElement.parentNode&&this.menuElement.parentNode.removeChild(this.menuElement)}getSettings(){return this.settings}}class cl{constructor(t,e,i){this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.lastDragDeltaX=0,this.velocity=0,this.hasDragged=!1,this.isCompactLayout=!1,this.resizeHandler=null,this.keydownHandler=null,this.onSelectionChangeCallback=null,this.onRenderCallback=null,this.animationFrameId=null,this.isAnimationActive=!1,this.container=t,this.options=e,this.currentIndex=Math.max(0,Math.min(e.length-1,i)),this.targetIndex=this.currentIndex,this.setupContainer(),this.setupEventHandlers(),this.scrollOffset=-this.currentIndex*this.getItemSpacingPx(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.updateLayoutMetrics(),this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.resizeHandler=()=>{this.updateLayoutMetrics()},window.addEventListener("resize",this.resizeHandler),this.keydownHandler=t=>{const e=t.target;if(e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName))return;const i=t.key.toLowerCase();"arrowleft"!==i&&"a"!==i||(this.moveSelection(-1),t.preventDefault()),"arrowright"!==i&&"d"!==i||(this.moveSelection(1),t.preventDefault())},window.addEventListener("keydown",this.keydownHandler),this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.lastDragDeltaX=0,this.container.style.cursor="grabbing"}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.lastDragDeltaX=e,this.scrollOffset=this.dragStartOffset+e,this.velocity=e*cl.VELOCITY_MULTIPLIER,Math.abs(e)>Ks&&(this.hasDragged=!0)}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=this.getItemSpacingPx(),i=this.lastDragDeltaX;if(Math.abs(i)>=cl.SWIPE_THRESHOLD_PX){const t=i<0?1:-1;return void this.setCurrentIndex(this.currentIndex+t)}const s=-this.scrollOffset/e,o=Math.round(s+this.velocity*cl.VELOCITY_FACTOR);this.setCurrentIndex(o)}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,o=this.currentIndex+Math.round(s/this.getItemSpacingPx());this.setCurrentIndex(o)}moveSelection(t){this.setCurrentIndex(this.currentIndex+t)}setCurrentIndex(t){const e=Math.max(0,Math.min(this.options.length-1,t));e!==this.currentIndex?(this.targetIndex=e,this.currentIndex=e,this.onSelectionChangeCallback&&this.onSelectionChangeCallback(this.options[this.currentIndex])):this.targetIndex=e}startAnimation(){if(this.isAnimationActive)return;this.isAnimationActive=!0;const t=()=>{this.isAnimationActive&&(this.update(),this.render(),this.animationFrameId=requestAnimationFrame(t))};this.animationFrameId=requestAnimationFrame(t)}pauseAnimation(){this.isAnimationActive&&(this.isAnimationActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}resumeAnimation(){this.startAnimation()}updateLayoutMetrics(){this.isCompactLayout=window.innerWidth<600;const t=this.isCompactLayout?"300px":"380px";this.container.style.height!==t&&(this.container.style.height=t)}getLayoutScale(){return this.isCompactLayout?.6:.9}getItemSpacingPx(){return cl.ITEM_SPACING_PX*this.getLayoutScale()}update(){this.updateLayoutMetrics();const t=-this.currentIndex*this.getItemSpacingPx()-this.scrollOffset;this.scrollOffset+=t*cl.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=cl.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0}render(){this.container.innerHTML="";const t=this.container.getBoundingClientRect(),e=t.width/2,i=t.height/2,s=this.getLayoutScale(),o=this.getItemSpacingPx(),n=cl.BASE_SIZE_PX*s,r=cl.TEXT_SCALE*s;for(let t=0;t<this.options.length;t++){const a=this.options[t],l=t-this.currentIndex,h=Math.abs(l),c=e+this.scrollOffset+t*o;let d=1,g=1;0===h?(d=1,g=1):1===h?(d=.72,g=.85):2===h?(d=.5,g=.55):(d=Math.max(.3,1-.25*h),g=Math.max(.3,1-.25*h));const u=n*d,p=document.createElement("div");p.style.position="absolute",p.style.left=c-u/2+"px",p.style.top=i-u/2+"px",p.style.width=`${u}px`,p.style.height=`${u}px`,p.style.backgroundColor=0===h?"rgba(12, 14, 22, 0.98)":"rgba(12, 14, 22, 0.85)",p.style.border=0===h?`2px solid ${a.color}`:"2px solid rgba(255, 255, 255, 0.2)",p.style.borderRadius="10px",p.style.opacity=g.toString(),p.style.display="flex",p.style.flexDirection="column",p.style.justifyContent="center",p.style.alignItems="center",p.style.pointerEvents="none",p.style.color="#FFFFFF",p.style.fontWeight="300",p.style.textAlign="center",p.style.padding=24*s+"px",p.style.boxSizing="border-box",p.style.zIndex=(100-h).toString(),p.style.overflow="hidden",p.dataset.particleBox="true",p.dataset.particleColor=0===h?a.color:"#66B3FF";const x=document.createElement("div");if(x.textContent=a.name.toUpperCase(),x.style.fontSize=Math.max(16,20*d)*r+"px",x.style.marginBottom=0===h?"14px":"0",x.style.color=0===h?"#FFFFFF":"#E0F2FF",x.style.fontWeight="300",x.dataset.particleText="true",x.dataset.particleColor=0===h?"#FFFFFF":"#E0F2FF",p.appendChild(x),0===h){const t=document.createElement("div");t.textContent=a.description,t.style.fontSize=Math.max(10,12*d)*r+"px",t.style.color="#D0D0D0",t.style.lineHeight="1.4",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#D0D0D0",p.appendChild(t)}this.container.appendChild(p)}this.onRenderCallback&&this.onRenderCallback()}onSelectionChange(t){this.onSelectionChangeCallback=t}onRender(t){this.onRenderCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler)}}cl.ITEM_SPACING_PX=210,cl.BASE_SIZE_PX=224,cl.TEXT_SCALE=2.4,cl.VELOCITY_MULTIPLIER=.1,cl.VELOCITY_FACTOR=.001,cl.SMOOTH_INTERPOLATION_FACTOR=.15,cl.VELOCITY_DECAY_FACTOR=.9,cl.SWIPE_THRESHOLD_PX=50;class dl{constructor(t,e,i=0,s="transparent"){this.currentIndex=0,this.targetIndex=0,this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.lastDragDeltaX=0,this.velocity=0,this.onSelectCallback=null,this.onRenderCallback=null,this.onNavigateCallback=null,this.animationFrameId=null,this.isAnimationActive=!1,this.hasDragged=!1,this.isCompactLayout=!1,this.resizeHandler=null,this.container=t,this.options=e,this.optionBackgroundColor=s;const o=Math.max(0,Math.min(i,e.length-1));this.currentIndex=o,this.targetIndex=o,this.setupContainer(),this.setupEventHandlers(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.updateLayoutMetrics(),this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.resizeHandler=()=>{this.updateLayoutMetrics()},window.addEventListener("resize",this.resizeHandler),this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.lastDragDeltaX=0,this.container.style.cursor="grabbing"}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.lastDragDeltaX=e,this.scrollOffset=this.dragStartOffset+e,this.velocity=e*dl.VELOCITY_MULTIPLIER,Math.abs(e)>Ks&&(this.hasDragged=!0)}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=this.getItemWidthPx(),i=this.lastDragDeltaX;if(Math.abs(i)>=dl.SWIPE_THRESHOLD_PX){const t=i<0?1:-1,e=Math.max(0,Math.min(this.options.length-1,this.currentIndex+t));return void this.setCurrentIndex(e)}const s=-this.scrollOffset/e;let o=Math.round(s+this.velocity*dl.VELOCITY_FACTOR);o=Math.max(0,Math.min(this.options.length-1,o)),this.setCurrentIndex(o)}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,o=this.currentIndex+Math.round(s/this.getItemWidthPx()),n=Math.max(0,Math.min(this.options.length-1,o));n===this.currentIndex?this.onSelectCallback&&this.onSelectCallback(this.options[this.currentIndex]):this.setCurrentIndex(n)}setCurrentIndex(t){t!==this.currentIndex?(this.targetIndex=t,this.currentIndex=t,this.onNavigateCallback&&this.onNavigateCallback(t)):this.targetIndex=t}startAnimation(){if(this.isAnimationActive)return;this.isAnimationActive=!0;const t=()=>{this.isAnimationActive&&(this.update(),this.render(),this.animationFrameId=requestAnimationFrame(t))};this.animationFrameId=requestAnimationFrame(t)}pauseAnimation(){this.isAnimationActive&&(this.isAnimationActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}resumeAnimation(){this.startAnimation()}updateLayoutMetrics(){const t=window.innerWidth<600;this.isCompactLayout=t;const e=this.getLayoutScale(),i=dl.BASE_SIZE*e,s=120*e,o=`${Math.round(i+s)}px`;this.container.style.height!==o&&(this.container.style.height=o)}getLayoutScale(){return this.isCompactLayout?.5:1}getItemWidthPx(){return dl.ITEM_WIDTH*this.getLayoutScale()}update(){this.updateLayoutMetrics();const t=-this.currentIndex*this.getItemWidthPx()-this.scrollOffset;this.scrollOffset+=t*dl.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=dl.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0}render(){var t,e;this.container.innerHTML="";const i=this.container.getBoundingClientRect(),s=i.width/2,o=i.height/2,n=this.getLayoutScale(),r=this.getItemWidthPx(),a=dl.BASE_SIZE*n,l=dl.TEXT_SCALE*n;for(let i=0;i<this.options.length;i++){const n=this.options[i],h=i-this.currentIndex,c=Math.abs(h),d=s+this.scrollOffset+i*r;let g=1,u=1;0===c?(g=1,u=1):1===c?(g=.75,u=.75):2===c?(g=.5,u=.5):(g=Math.max(.25,1-.25*c),u=Math.max(.25,1-.25*c));const p=a*g,x=document.createElement("div");x.style.position="absolute",x.style.left=d-p/2+"px",x.style.top=o-p/2+"px",x.style.width=`${p}px`,x.style.height=`${p}px`,x.style.backgroundColor=this.optionBackgroundColor,x.style.border="2px solid transparent",x.style.borderRadius="10px",x.style.opacity=u.toString(),x.style.transition="background-color 0.2s",x.style.display="flex",x.style.flexDirection="column",x.style.justifyContent="center",x.style.alignItems="center",x.style.pointerEvents="none",x.style.color="#000000",x.style.fontWeight="300",x.style.textAlign="center",x.style.padding="30px",x.style.boxSizing="border-box",x.dataset.particleBox="true",x.dataset.particleColor=0===c?"#FFD700":"#00AAFF";const y=document.createElement("div");if(y.textContent=n.name,y.style.fontSize=Math.max(14,18*g)*l+"px",y.style.marginBottom=n.subLabel?"6px":"15px",y.style.color=0===c?"#FFF5C2":"#E2F4FF",y.style.fontWeight="300",y.dataset.particleText="true",y.dataset.particleColor=0===c?"#FFF5C2":"#E2F4FF",x.appendChild(y),n.subLabel){const i=document.createElement("div");i.textContent=n.subLabel,i.style.fontSize=Math.max(10,12*g)*l+"px",i.style.marginBottom="10px",i.style.color=null!==(t=n.subLabelColor)&&void 0!==t?t:"#D0D0D0",i.style.fontWeight="300",i.dataset.particleText="true",i.dataset.particleColor=null!==(e=n.subLabelColor)&&void 0!==e?e:"#D0D0D0",x.appendChild(i)}if(0===c){const t=document.createElement("div");t.textContent=n.description,t.style.fontSize=Math.max(10,12*g)*l+"px",t.style.color="#D0D0D0",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#D0D0D0",x.appendChild(t)}this.container.appendChild(x)}this.onRenderCallback&&this.onRenderCallback()}onSelect(t){this.onSelectCallback=t}onRender(t){this.onRenderCallback=t}onNavigate(t){this.onNavigateCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler)}}dl.ITEM_WIDTH=260,dl.BASE_SIZE=220,dl.TEXT_SCALE=2,dl.VELOCITY_MULTIPLIER=.1,dl.VELOCITY_FACTOR=.001,dl.SMOOTH_INTERPOLATION_FACTOR=.15,dl.VELOCITY_DECAY_FACTOR=.9,dl.SWIPE_THRESHOLD_PX=50;const gl=[{key:"centralSun",label:"Central Sun",svgPath:"ASSETS/sprites/environment/centralSun.svg",pngPath:"ASSETS/sprites/environment/centralSun.png"},{key:"stellarForge",label:"Stellar Forge Base",svgPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantBaseType1.svg",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantBaseType1.png"},{key:"forgeFlameHot",label:"Forge Flame (Hot)",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantForgeFlame.png"},{key:"forgeFlameCold",label:"Forge Flame (Cold)",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantForgeFlameCold.png"},{key:"solarMirror",label:"Solar Mirror",svgPath:"ASSETS/sprites/RADIANT/solarMirrors/radiantSolarMirror.svg",pngPath:"ASSETS/sprites/RADIANT/solarMirrors/radiantSolarMirror.png"},{key:"starling",label:"Starling",svgPath:"ASSETS/sprites/RADIANT/starlings/starlingLevel (1).svg",pngPath:"ASSETS/sprites/RADIANT/starlings/starlingLevel (1).png"},{key:"heroMarine",label:"Hero: Marine",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Marine.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Marine.png"},{key:"heroGrave",label:"Hero: Grave",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Grave.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Grave.png"},{key:"heroRay",label:"Hero: Ray",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Ray.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Ray.png"},{key:"heroNova",label:"Hero: Nova",svgPath:"ASSETS/sprites/VELARIS/heroUnits/Nova.svg",pngPath:"ASSETS/sprites/VELARIS/heroUnits/Nova.png"},{key:"heroInfluenceBall",label:"Hero: Influence Ball",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Uniter.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Uniter.png"},{key:"heroTurretDeployer",label:"Hero: Turret Deployer",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Engineer.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Engineer.png"},{key:"heroDriller",label:"Hero: Driller",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Drill.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Drill.png"},{key:"heroDagger",label:"Hero: Dagger",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Dagger.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Dagger.png"},{key:"heroBeam",label:"Hero: Beam",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Beam.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Beam.png"},{key:"heroPreist",label:"Hero: Preist",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Preist.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Preist.png"},{key:"heroTank",label:"Hero: Tank",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Tank.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Tank.png"}];class ul{constructor(t){this.camera=new i(0,0),this.parallaxCamera=new i(0,0),this.zoom=1,this.selectionStart=null,this.selectionEnd=null,this.abilityArrowStarts=[],this.abilityArrowEnd=null,this.buildingAbilityArrowStart=null,this.buildingAbilityArrowEnd=null,this.highlightedButtonIndex=-1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedWarpGate=null,this.pathPreviewForge=null,this.pathPreviewPoints=[],this.pathPreviewEnd=null,this.selectedHeroNames=[],this.hasSeenFoundry=!1,this.hasActiveFoundry=!1,this.tapEffects=[],this.swipeEffects=[],this.warpGateShockwaves=[],this.productionButtonWaves=[],this.viewingPlayer=null,this.showInfo=!1,this.showInGameMenu=!1,this.isPaused=!1,this.playerColor=r,this.enemyColor=a,this.colorScheme=rl.SpaceBlack,this.inGameMenuTab="main",this.damageDisplayMode="damage",this.healthDisplayMode="bar",this.graphicsQuality="high",this.isFancyGraphicsEnabled=!1,this.HERO_SPRITE_SCALE=4.2,this.FORGE_SPRITE_SCALE=2.64,this.VELARIS_FORGE_PARTICLE_COUNT=180,this.VELARIS_FORGE_PARTICLE_SPEED_UNITS_PER_SEC=.28,this.VELARIS_FORGE_PARTICLE_RADIUS_PX=1.6,this.VELARIS_FORGE_SCRIPT_SCALE=1.15,this.VELARIS_FORGE_GRAPHEME_SPRITE_SCALE=.35,this.VELARIS_FORGE_GRAPHEME_OUTER_RADIUS=1,this.VELARIS_FORGE_GRAPHEME_INNER_RADIUS=.55,this.VELARIS_FORGE_GRAPHEME_START_ANGLE_RAD=.25*Math.PI,this.VELARIS_FORGE_GRAPHEME_END_ANGLE_RAD=1.75*Math.PI,this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS=["ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-A.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-B.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-C.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-D.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-E.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-F.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-G.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-H.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-I.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-J.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-K.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-L.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-M.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-N.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-O.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-P.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-Q.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-R.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-S.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-T.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-U.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-V.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-W.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-X.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-Y.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-Z.png"],this.VELARIS_MIRROR_GLYPHS="",this.VELARIS_MIRROR_WORD="",this.VELARIS_MIRROR_CLOUD_GLYPH_COUNT=18,this.VELARIS_MIRROR_CLOUD_PARTICLE_COUNT=12,this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT=10,this.VELARIS_MIRROR_PARTICLE_TIME_SCALE=.35,this.VELARIS_MIRROR_PARTICLE_DRIFT_SPEED=.7,this.VELARIS_STARLING_CLOUD_PARTICLE_COUNT=20,this.VELARIS_STARLING_TRIANGLE_PARTICLE_COUNT=24,this.VELARIS_STARLING_PARTICLE_RADIUS_PX=1.2,this.VELARIS_STARLING_CLOUD_RADIUS_SCALE=2.1,this.VELARIS_STARLING_TRIANGLE_RADIUS_SCALE=2.5,this.VELARIS_STARLING_TRIANGLE_WOBBLE_SCALE=.08,this.VELARIS_STARLING_CLOUD_SWIRL_SCALE=.45,this.VELARIS_STARLING_TRIANGLE_FLOW_SPEED=.08,this.VELARIS_STARLING_TRIANGLE_WOBBLE_SPEED=2.2,this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_BASE=.35,this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_VARIANCE=.55,this.VELARIS_STARLING_CLOUD_PULL_SPEED=.6,this.VELARIS_STARLING_CLOUD_TIME_SCALE=.28,this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_BASE=.35,this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_RANGE=.25,this.spriteImageCache=new Map,this.tintedSpriteCache=new Map,this.forgeFlameStates=new Map,this.velarisForgeScriptStates=new Map,this.solEnergyIcon=null,this.viewMinX=0,this.viewMaxX=0,this.viewMinY=0,this.viewMaxY=0,this.graphicsOptionByKey=new Map,this.graphicsVariantByKey=new Map,this.graphicsMenuScrollOffset=0,this.graphicsOptions=gl,this.MOVE_ORDER_DOT_RADIUS=6,this.MOVE_ORDER_FRAME_DURATION_MS=1e3/Tt,this.MOVE_ORDER_FALLBACK_SPRITE_PATH="ASSETS/sprites/interface/movementPoint.png",this.FORGE_MAX_HEALTH=1e3,this.MIRROR_MAX_HEALTH=$t,this.starLayers=[],this.movementPointFramePaths=[],this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context from canvas");this.ctx=e,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.initializeStarLayers();const s=["stellarForge","solarMirror"];for(const t of this.graphicsOptions){this.graphicsOptionByKey.set(t.key,t);const e=t.svgPath?"svg":t.pngPath?"png":"stub",i=s.includes(t.key)&&t.pngPath;this.graphicsVariantByKey.set(t.key,i?"png":e)}for(let t=1;t<=At;t++)this.movementPointFramePaths.push(`ASSETS/sprites/interface/movementPointAnimation/movementPoint_frame${t}.png`)}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t)}initializeStarLayers(){let t=42;const e=()=>(t=(9301*t+49297)%233280,t/233280);for(const t of Ft){const i=[];for(let s=0;s<t.count;s++)i.push({x:e()*Lt-Lt/2,y:e()*Lt-Lt/2,size:t.sizeRange[0]+e()*(t.sizeRange[1]-t.sizeRange[0]),brightness:.3+.7*e()});this.starLayers.push({stars:i,parallaxFactor:t.parallaxFactor})}}worldToScreen(t){const e=window.devicePixelRatio||1,s=this.canvas.width/e/2,o=this.canvas.height/e/2;return new i(s+(t.x-this.camera.x)*this.zoom,o+(t.y-this.camera.y)*this.zoom)}isWithinRenderBounds(t,e,i=0){const s=e/2;return t.x>=-s-i&&t.x<=s+i&&t.y>=-s-i&&t.y<=s+i}updateViewBounds(){const t=window.devicePixelRatio||1,e=this.canvas.width/t/(2*this.zoom),i=this.canvas.height/t/(2*this.zoom);this.viewMinX=this.camera.x-e,this.viewMaxX=this.camera.x+e,this.viewMinY=this.camera.y-i,this.viewMaxY=this.camera.y+i}isWithinViewBounds(t,e=0){return t.x>=this.viewMinX-e&&t.x<=this.viewMaxX+e&&t.y>=this.viewMinY-e&&t.y<=this.viewMaxY+e}screenToWorld(t,e){const s=window.devicePixelRatio||1,o=this.canvas.width/s/2,n=this.canvas.height/s/2;return new i(this.camera.x+(t-o)/this.zoom,this.camera.y+(e-n)/this.zoom)}getFactionColor(t){switch(t){case Jr.RADIANT:return"#FFD700";case Jr.AURUM:return"#DAA520";case Jr.VELARIS:return"#9C27B0";default:return"#FFFFFF"}}getLadPlayerColor(t,e,i){return e&&t.stellarForge?"light"===i.getLadSide(t.stellarForge.position,e)?"#FFFFFF":"#000000":null!==this.viewingPlayer&&t!==this.viewingPlayer?this.enemyColor:this.playerColor}getSpriteImage(t){const e=this.resolveAssetPath(t),i=this.spriteImageCache.get(e);if(i)return i;const s=new Image;return s.src=e,this.spriteImageCache.set(e,s),s}getSolEnergyIcon(){return this.solEnergyIcon||(this.solEnergyIcon=this.getSpriteImage("ASSETS/sprites/interface/SoL_icon.png")),this.solEnergyIcon}getTintedSprite(t,e){const i=this.resolveAssetPath(t),s=`${i}|${e}`,o=this.tintedSpriteCache.get(s);if(o)return o;const n=this.getSpriteImage(i);if(!n.complete||0===n.naturalWidth||0===n.naturalHeight)return null;const r=document.createElement("canvas");r.width=n.naturalWidth,r.height=n.naturalHeight;const a=r.getContext("2d");return a?(a.drawImage(n,0,0),a.globalCompositeOperation="multiply",a.fillStyle=e,a.fillRect(0,0,r.width,r.height),a.globalCompositeOperation="destination-in",a.drawImage(n,0,0),a.globalCompositeOperation="source-over",this.tintedSpriteCache.set(s,r),r):null}resolveAssetPath(t){return t.startsWith("ASSETS/")&&window.location.pathname.includes("/dist/")?`../${t}`:t}getGraphicVariant(t){var e;return null!==(e=this.graphicsVariantByKey.get(t))&&void 0!==e?e:"stub"}setGraphicsVariant(t,e){this.graphicsVariantByKey.set(t,e)}setInGameMenuTab(t){this.inGameMenuTab=t}getGraphicAssetPath(t){var e,i;const s=this.graphicsOptionByKey.get(t);if(!s)return null;const o=this.getGraphicVariant(t);return"svg"===o?null!==(e=s.svgPath)&&void 0!==e?e:null:"png"===o&&null!==(i=s.pngPath)&&void 0!==i?i:null}getForgeSpritePath(t){return t.owner.faction===Jr.RADIANT?this.getGraphicAssetPath("stellarForge"):null}getSolarMirrorSpritePath(t){return t.owner.faction===Jr.RADIANT?this.getGraphicAssetPath("solarMirror"):null}getStarlingSpritePath(t){return t.owner.faction===Jr.RADIANT?`ASSETS/sprites/RADIANT/starlings/starlingLevel (${Math.min(4,Math.max(1,t.spriteLevel))}).png`:null}getStarlingFacingRotationRad(t){if(t.rallyPoint&&t.position.distanceTo(t.rallyPoint)>_s)return t.rotation;if(t.target&&"position"in t.target&&(!("health"in t.target)||t.target.health>0)){const e=t.target.position,i=e.x-t.position.x,s=e.y-t.position.y;if(0!==i||0!==s)return Math.atan2(s,i)+Math.PI/2}return t.rotation}getForgeFlameState(t,e){let i=this.forgeFlameStates.get(t);if(!i)return i={warmth:t.isReceivingLight?1:0,rotationRad:t.rotation,lastGameTime:e},this.forgeFlameStates.set(t,i),i;const s=Math.max(0,e-i.lastGameTime);i.lastGameTime=e;const o=t.isReceivingLight?1:0;if(o>i.warmth?i.warmth=Math.min(1,i.warmth+ke*s):o<i.warmth&&(i.warmth=Math.max(0,i.warmth-ke*s)),t.isReceivingLight){const e=t.getCurrentCrunch(),o=e&&e.isActive()?2:1;i.rotationRad+=Be*o*s,i.rotationRad>=2*Math.PI&&(i.rotationRad-=2*Math.PI)}return i}isPointInsideGraphemeC(t,e){const i=Math.sqrt(t*t+e*e);if(i<this.VELARIS_FORGE_GRAPHEME_INNER_RADIUS||i>this.VELARIS_FORGE_GRAPHEME_OUTER_RADIUS)return!1;let s=Math.atan2(e,t);return s<0&&(s+=2*Math.PI),s>=this.VELARIS_FORGE_GRAPHEME_START_ANGLE_RAD&&s<=this.VELARIS_FORGE_GRAPHEME_END_ANGLE_RAD}getVelarisForgeScriptState(t,e){let i=this.velarisForgeScriptStates.get(t);if(i)return i;const s=this.VELARIS_FORGE_PARTICLE_COUNT,o=new Float32Array(s),n=new Float32Array(s),r=new Float32Array(s),a=new Float32Array(s),l=new Uint8Array(s);for(let t=0;t<s;t++){let e=0,i=0,s=0;for(;e<40&&(i=(2*Math.random()-1)*this.VELARIS_FORGE_GRAPHEME_OUTER_RADIUS,s=(2*Math.random()-1)*this.VELARIS_FORGE_GRAPHEME_OUTER_RADIUS,!this.isPointInsideGraphemeC(i,s));)e++;o[t]=i,n[t]=s;const h=Math.random()*Math.PI*2,c=this.VELARIS_FORGE_PARTICLE_SPEED_UNITS_PER_SEC*(.6+.8*Math.random());r[t]=Math.cos(h)*c,a[t]=Math.sin(h)*c,l[t]=Math.floor(Math.random()*this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS.length)}return i={positionsX:o,positionsY:n,velocitiesX:r,velocitiesY:a,glyphIndices:l,lastGameTime:e},this.velarisForgeScriptStates.set(t,i),i}updateVelarisForgeParticles(t,e){if(e<=0)return;const i=t.positionsX.length;for(let s=0;s<i;s++){const i=t.positionsX[s],o=t.positionsY[s];let n=i+t.velocitiesX[s]*e,r=o+t.velocitiesY[s]*e;this.isPointInsideGraphemeC(n,r)||(t.velocitiesX[s]=-t.velocitiesX[s],t.velocitiesY[s]=-t.velocitiesY[s],n=i+t.velocitiesX[s]*e,r=o+t.velocitiesY[s]*e,this.isPointInsideGraphemeC(n,r)||(n=i,r=o)),t.positionsX[s]=n,t.positionsY[s]=r}}drawVelarisForgeScript(t,e,i,s,o,n){const r=i*this.VELARIS_FORGE_SCRIPT_SCALE,a=this.getVelarisForgeScriptState(t,o),l=Math.min(.05,Math.max(0,o-a.lastGameTime));a.lastGameTime=o,this.updateVelarisForgeParticles(a,l);const h=Math.max(1,this.VELARIS_FORGE_PARTICLE_RADIUS_PX*this.zoom),c=n?.45:.75,d=n?.5:.8,g=r*this.VELARIS_FORGE_GRAPHEME_SPRITE_SCALE,u=this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS.length;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.beginPath(),this.ctx.arc(0,0,r*this.VELARIS_FORGE_GRAPHEME_OUTER_RADIUS,this.VELARIS_FORGE_GRAPHEME_START_ANGLE_RAD,this.VELARIS_FORGE_GRAPHEME_END_ANGLE_RAD,!0),this.ctx.arc(0,0,r*this.VELARIS_FORGE_GRAPHEME_INNER_RADIUS,this.VELARIS_FORGE_GRAPHEME_END_ANGLE_RAD,this.VELARIS_FORGE_GRAPHEME_START_ANGLE_RAD,!1),this.ctx.closePath(),this.ctx.strokeStyle=s,this.ctx.globalAlpha=d,this.ctx.lineWidth=Math.max(1.5,2*this.zoom),this.ctx.stroke(),this.ctx.restore(),this.ctx.save(),this.ctx.globalAlpha=c,this.ctx.fillStyle=s;const p=a.positionsX.length;for(let t=0;t<p;t++){const i=e.x+a.positionsX[t]*r,o=e.y+a.positionsY[t]*r,n=a.glyphIndices[t]%u,l=this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS[n],c=this.getTintedSprite(l,s);if(c){const t=g/Math.max(c.width,c.height),e=c.width*t,s=c.height*t;this.ctx.drawImage(c,i-e/2,o-s/2,e,s)}else this.ctx.beginPath(),this.ctx.arc(i,o,h,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}getHeroSpritePath(t){return t.owner.faction!==Jr.RADIANT?null:t instanceof wa?this.getGraphicAssetPath("heroMarine"):t instanceof ba?this.getGraphicAssetPath("heroGrave"):t instanceof Ha?this.getGraphicAssetPath("heroDagger"):t instanceof Wa?this.getGraphicAssetPath("heroBeam"):t instanceof za?this.getGraphicAssetPath("heroMortar"):t instanceof Da?this.getGraphicAssetPath("heroRay"):t instanceof qa?this.getGraphicAssetPath("heroNova"):t instanceof Oa?this.getGraphicAssetPath("heroInfluenceBall"):t instanceof ka?this.getGraphicAssetPath("heroTurretDeployer"):t instanceof Ua?this.getGraphicAssetPath("heroDriller"):t instanceof Xa?this.getGraphicAssetPath("heroPreist"):t instanceof Ka?this.getGraphicAssetPath("heroTank"):t instanceof $a?this.getGraphicAssetPath("heroBeam"):null}darkenColor(t,e){const i=Math.max(0,Math.min(1,e));let s=t.replace("#","");3===s.length&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]);const o=parseInt(s.substring(0,2),16)||0,n=parseInt(s.substring(2,4),16)||0,r=parseInt(s.substring(4,6),16)||0,a=Math.floor(Math.min(255,o*i)),l=Math.floor(Math.min(255,n*i)),h=Math.floor(Math.min(255,r*i));return"#"+a.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+h.toString(16).padStart(2,"0")}adjustColorBrightness(t,e){let i=t.replace("#","");3===i.length&&(i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]);const s=parseInt(i.substring(0,2),16)||0,o=parseInt(i.substring(2,4),16)||0,n=parseInt(i.substring(4,6),16)||0,r=Math.floor(Math.min(255,s*e)),a=Math.floor(Math.min(255,o*e)),l=Math.floor(Math.min(255,n*e));return"#"+r.toString(16).padStart(2,"0")+a.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")}brightenAndPaleColor(t){let e=t.replace("#","");3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);const i=parseInt(e.substring(0,2),16)||0,s=parseInt(e.substring(2,4),16)||0,o=parseInt(e.substring(4,6),16)||0,n=i+.2*(255-i),r=s+.2*(255-s),a=o+.2*(255-o),l=(n+r+a)/3,h=.15,c=Math.floor(n+(l-n)*h),d=Math.floor(r+(l-r)*h),g=Math.floor(a+(l-a)*h);return"#"+c.toString(16).padStart(2,"0")+d.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")}drawLadAura(t,e,i,s){this.ctx.save();let o=i;o="light"===s?this.darkenColor(i,.7):this.adjustColorBrightness(i,1.3);const n=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,1.8*e);n.addColorStop(0,o+"80"),n.addColorStop(.5,o+"60"),n.addColorStop(.8,o+"30"),n.addColorStop(1,o+"00"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1.8*e,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawFancyBloom(t,e,i,s){this.ctx.save(),this.ctx.globalCompositeOperation="screen",this.ctx.globalAlpha=Math.max(0,Math.min(1,s)),this.ctx.shadowColor=i,this.ctx.shadowBlur=.9*e,this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBuildingSelectionIndicator(t,e){this.ctx.strokeStyle="#00FF00",this.ctx.lineWidth=3,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e+5,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([])}drawSun(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom;if("lad"===t.type)return void this.drawLadSun(t,e,i);if(this.isFancyGraphicsEnabled){const t=1.35*i;this.drawFancyBloom(e,t,this.colorScheme.sunGlow.outerGlow1,.7)}const s=this.getGraphicAssetPath("centralSun"),o=s?this.getSpriteImage(s):null,n=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);if(n.addColorStop(0,this.colorScheme.sunGlow.outerGlow1),n.addColorStop(.5,this.colorScheme.sunGlow.outerGlow2),n.addColorStop(.8,this.colorScheme.sunGlow.outerGlow3),n.addColorStop(1,this.colorScheme.sunGlow.outerGlow4),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),o&&o.complete&&o.naturalWidth>0){const t=2*i;return void this.ctx.drawImage(o,e.x-i,e.y-i,t,t)}this.ctx.strokeStyle=this.colorScheme.sunGlow.outerGlow1,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.8*i,0,2*Math.PI),this.ctx.stroke()}drawLadSun(t,e,i){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,Math.PI/2,-Math.PI/2),this.ctx.closePath(),this.ctx.clip(),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(e.x-i,e.y-i,i,2*i),this.ctx.restore(),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,-Math.PI/2,Math.PI/2),this.ctx.closePath(),this.ctx.clip(),this.ctx.fillStyle="#000000",this.ctx.fillRect(e.x,e.y-i,i,2*i),this.ctx.restore(),this.ctx.strokeStyle="#666666",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y+i),this.ctx.stroke(),this.ctx.strokeStyle=l,this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke()}drawForgeFlames(t,e,i,s,o){const n=this.getForgeFlameState(t,s.gameTime),r=this.getGraphicAssetPath("forgeFlameHot"),a=this.getGraphicAssetPath("forgeFlameCold");if(!r||!a)return;const l=this.getSpriteImage(r),h=this.getSpriteImage(a);if(!l.complete||0===l.naturalWidth||!h.complete||0===h.naturalWidth)return;const c=i*Ne,d=Oe*(o?1-Bt:1),g=d*n.warmth,u=d*(1-n.warmth),p=[0,0];for(let t=0;t<p.length;t++){const i=p[t],s=0===t?n.rotationRad:-n.rotationRad;this.ctx.save(),this.ctx.translate(e.x+i,e.y),this.ctx.rotate(s),u>0&&(this.ctx.globalAlpha=u,this.ctx.drawImage(h,-c/2,-c/2,c,c)),g>0&&(this.ctx.globalAlpha=g,this.ctx.drawImage(l,-c/2,-c/2,c,c)),this.ctx.restore()}this.ctx.globalAlpha=1}drawLensFlare(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=window.devicePixelRatio||1,o=this.canvas.width/s,n=this.canvas.height/s,r=o/2,a=n/2,l=e.x-r,h=e.y-a;if(Math.sqrt(l*l+h*h)>Math.sqrt(o*o+n*n)/2+i)return;const c=this.colorScheme.lensFlareHalo.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/),d=c?`rgba(${c[1]}, ${c[2]}, ${c[3]}, `:"rgba(255, 240, 200, ",g=[{offset:-.3,size:.4,alpha:.15},{offset:-.5,size:.25,alpha:.12},{offset:.4,size:.3,alpha:.1},{offset:.7,size:.2,alpha:.08}];for(const t of g){const e=r+l*t.offset,s=a+h*t.offset,o=i*t.size,n=this.ctx.createRadialGradient(e,s,0,e,s,o);n.addColorStop(0,`${d}${t.alpha})`),n.addColorStop(.5,`${d}${.5*t.alpha})`),n.addColorStop(1,`${d}0)`),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(e,s,o,0,2*Math.PI),this.ctx.fill()}this.ctx.save(),this.ctx.globalAlpha=.2,this.ctx.strokeStyle=this.colorScheme.lensFlareHalo,this.ctx.lineWidth=2;for(let t=0;t<6;t++){const s=Math.PI/3*t,o=1.5*i,n=e.x+Math.cos(s)*i*.7,r=e.y+Math.sin(s)*i*.7,a=e.x+Math.cos(s)*o,l=e.y+Math.sin(s)*o,h=this.ctx.createLinearGradient(n,r,a,l),c=d+"0.4)";h.addColorStop(0,c),h.addColorStop(1,`${d}0)`),this.ctx.strokeStyle=h,this.ctx.beginPath(),this.ctx.moveTo(n,r),this.ctx.lineTo(a,l),this.ctx.stroke()}this.ctx.restore()}drawStellarForge(t,e,i,s){const o=this.worldToScreen(t.position),n=40*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&(a=i.getLadSide(t.position,r),l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,Bt))}if(t.isSelected){if(this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,1.5*n,0,2*Math.PI),this.ctx.stroke(),t.minionPath.length>0){this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.setLineDash([10,5]),this.ctx.beginPath();const e=this.worldToScreen(t.position);this.ctx.moveTo(e.x,e.y);for(const e of t.minionPath){const t=this.worldToScreen(e);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="#FFFF00";for(let e=0;e<t.minionPath.length;e++){const i=t.minionPath[e],s=this.worldToScreen(i);this.ctx.beginPath(),this.ctx.arc(s.x,s.y,5,0,2*Math.PI),this.ctx.fill(),e===t.minionPath.length-1&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,8,0,2*Math.PI),this.ctx.stroke())}}this.pathPreviewForge===t&&(this.pathPreviewPoints.length>0||this.pathPreviewEnd)&&this.drawMinionPathPreview(t.position,this.pathPreviewPoints,this.pathPreviewEnd),t.isSelected&&this.selectedHeroNames.length>0&&this.drawHeroButtons(t,o,this.selectedHeroNames),s||this.drawForgeUpgradeButtons(t,o)}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(o,n,t,a)}const d=h?this.darkenColor(l,Bt):l,g=t.owner.faction===Jr.VELARIS,u=this.getForgeSpritePath(t),p=u?this.getTintedSprite(u,d):null;if(g)this.drawVelarisForgeScript(t,o,n,c,i.gameTime,h);else if(p){const e=n*this.FORGE_SPRITE_SCALE;this.ctx.drawImage(p,o.x-e/2,o.y-e/2,e,e),this.drawForgeFlames(t,o,e,i,h)}else{this.ctx.fillStyle=c;const e=c;this.ctx.strokeStyle=h?this.darkenColor(e,Bt):e,this.ctx.lineWidth=2,this.ctx.beginPath();for(let e=0;e<6;e++){const i=Math.PI/3*e+t.rotation,s=o.x+n*Math.cos(i),r=o.y+n*Math.sin(i);0===e?this.ctx.moveTo(s,r):this.ctx.lineTo(s,r)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}if(this.drawHealthDisplay(o,t.health,this.FORGE_MAX_HEALTH,n,-n-15),t.heroProductionUnitType&&t.heroProductionDurationSec>0){const e=2*n,i=6,s=o.x-e/2,r=o.y+n+10,a=Math.max(0,Math.min(1,1-t.heroProductionRemainingSec/t.heroProductionDurationSec));this.ctx.fillStyle="#222",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#00FF88",this.ctx.fillRect(s,r,e*a,i)}t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,h?c:e)}drawHeroButtons(t,e,i){const s=rs*this.zoom,o=as*this.zoom,n=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],r=i.slice(0,n.length);for(let i=0;i<r.length;i++){const a=r[i],l=n[i],h=e.x+l.x*o,c=e.y+l.y*o,d=this.getHeroUnitType(a),g=!!d&&this.isHeroUnitAlive(t.owner,d),u=!!d&&this.isHeroUnitQueuedOrProducing(t,d),p=!!d&&!g&&!u,x=this.highlightedButtonIndex===i;this.ctx.fillStyle=x?"rgba(0, 255, 136, 0.7)":p?"rgba(0, 255, 136, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=x||p?"#00FF88":"#888888",this.ctx.lineWidth=x?4:2,this.ctx.beginPath(),this.ctx.arc(h,c,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=p?"#FFFFFF":"#666666",this.ctx.font=14*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,h,c),u?this.drawHeroHourglass(h,c,s):g&&this.drawHeroCheckmark(h,c,s)}}drawForgeUpgradeButtons(t,e){if(t.owner.hasBlinkUpgrade)return;const i=ls*this.zoom,s=hs*this.zoom,o=e.x,n=e.y+s,r=t.owner.energy>=Ni;this.ctx.fillStyle=r?"rgba(0, 180, 255, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=r?"#00B4FF":"#888888",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o,n,i,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=r?"#FFFFFF":"#666666",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Blink",o,n-5*this.zoom),this.ctx.font=10*this.zoom+"px Doto",this.ctx.fillText(`${Ni}`,o,n+8*this.zoom)}getHeroUnitType(t){switch(t){case"Marine":case"Grave":case"Ray":case"Dagger":case"Beam":case"Driller":case"Spotlight":return t;case"Influence Ball":return"InfluenceBall";case"Turret Deployer":return"TurretDeployer";default:return null}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof wa;case"Grave":return t instanceof ba;case"Ray":return t instanceof Da;case"Nova":return t instanceof qa;case"InfluenceBall":return t instanceof Oa;case"TurretDeployer":return t instanceof ka;case"Driller":return t instanceof Ua;case"Dagger":return t instanceof Ha;case"Beam":return t instanceof Wa;case"Spotlight":return t instanceof $a;case"Mortar":return t instanceof za;case"Preist":return t instanceof Xa;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}drawHeroHourglass(t,e,i){const s=.7*i,o=.8*i,n=t-.5*s,r=t+.5*s,a=e-.5*o,l=e+.5*o,h=e;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.moveTo(n,a),this.ctx.lineTo(r,a),this.ctx.lineTo(t,h),this.ctx.closePath(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n,l),this.ctx.lineTo(r,l),this.ctx.lineTo(t,h),this.ctx.closePath(),this.ctx.stroke()}drawHeroCheckmark(t,e,i){const s=.7*i,o=.6*i,n=t-.45*s,r=e+.05*o,a=t-.1*s,l=e+.35*o,h=t+.5*s,c=e-.35*o;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.moveTo(n,r),this.ctx.lineTo(a,l),this.ctx.lineTo(h,c),this.ctx.stroke()}drawFoundryButtons(t,e){const i=rs*this.zoom,s=as*this.zoom,o=[{x:-1,y:0,label:"Strafe",available:t.canQueueStrafeUpgrade(),index:0},{x:1,y:0,label:"Regen",available:t.canQueueRegenUpgrade(),index:1}];for(const t of o){const o=e.x+t.x*s,n=e.y+t.y*s,r=this.highlightedButtonIndex===t.index;this.ctx.fillStyle=r?"rgba(255, 215, 0, 0.7)":t.available?"rgba(255, 215, 0, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=r||t.available?"#FFD700":"#888888",this.ctx.lineWidth=r?4:2,this.ctx.beginPath(),this.ctx.arc(o,n,i,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=t.available?"#FFFFFF":"#666666",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.label,o,n)}}getPseudoRandom(t){const e=43758.5453*Math.sin(t);return e-Math.floor(e)}drawSolarMirror(t,e,s,o,r){const a=s.suns.find(t=>"lad"===t.type);let l,h=e;a&&t.owner&&(l=t.owner.stellarForge?s.getLadSide(t.owner.stellarForge.position,a):"light",h="light"===l?"#FFFFFF":"#000000");let c=!1,d=h;if(o&&this.viewingPlayer){if(!s.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;a||s.isPointInShadow(t.position)&&(c=!0,d=this.darkenColor(h,Bt))}const g=this.worldToScreen(t.position),u=14*this.zoom;this.ctx.save();const p=Math.max(0,Math.min(1,1-t.closestSunDistance/Gs)),x=t.owner.faction===Jr.VELARIS,y=t.hasLineOfSightToLight(s.suns,s.asteroids)&&p>.1&&t.closestSunDistance!==1/0;if(this.isFancyGraphicsEnabled){const t=this.brightenAndPaleColor(d),e=.25+.5*p;this.drawFancyBloom(g,1.6*u,t,e)}if(p>.1&&t.closestSunDistance!==1/0){const e=Bs*this.zoom*(1+p),o=this.ctx.createRadialGradient(g.x,g.y,0,g.x,g.y,e);o.addColorStop(0,`rgba(255, 255, 150, ${.8*p})`),o.addColorStop(.5,`rgba(255, 255, 100, ${.4*p})`),o.addColorStop(1,"rgba(255, 255, 50, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(g.x,g.y,e,0,2*Math.PI),this.ctx.fill();const n=t.getClosestVisibleSun(s.suns,s.asteroids);if(n){const e=t.owner.stellarForge,o=t.getLinkedStructure(e);let r=null;if(o&&t.hasLineOfSightToStructure(o,s.asteroids,s.players))r=new i(o.position.x-t.position.x,o.position.y-t.position.y).normalize();else{const e=new i(n.position.x-t.position.x,n.position.y-t.position.y).normalize();r=new i(-e.x,-e.y)}const a=100,l=x&&y?new i(t.position.x-6.3*Math.sin(t.reflectionAngle),t.position.y+6.3*Math.cos(t.reflectionAngle)):t.position,h=new i(l.x+r.x*a,l.y+r.y*a),c=this.worldToScreen(l),d=this.worldToScreen(h),g=this.ctx.createLinearGradient(c.x,c.y,d.x,d.y);g.addColorStop(0,`rgba(255, 255, 200, ${1*p})`),g.addColorStop(.7,`rgba(255, 255, 150, ${.6*p})`),g.addColorStop(1,"rgba(255, 255, 100, 0)"),this.ctx.strokeStyle=g,this.ctx.lineWidth=15*this.zoom*p,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(d.x,d.y),this.ctx.stroke();const u=20*this.zoom*p,m=this.ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,u);m.addColorStop(0,`rgba(255, 255, 255, ${.9*p})`),m.addColorStop(.5,`rgba(255, 255, 200, ${.5*p})`),m.addColorStop(1,"rgba(255, 255, 150, 0)"),this.ctx.fillStyle=m,this.ctx.beginPath(),this.ctx.arc(d.x,d.y,u,0,2*Math.PI),this.ctx.fill()}}if(this.ctx.translate(g.x,g.y),this.ctx.rotate(t.reflectionAngle),a&&l){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0);const t=o?this.enemyColor:this.playerColor;this.drawLadAura(g,u,t,l),this.ctx.restore()}const m=2*u,f=.3*u;let S=m,A=f,T=!1;if(x){const e=this.brightenAndPaleColor(d),i=.55*u,s=.7*i,o=.17*t.position.x+.23*t.position.y+3.1*t.reflectionAngle,n=r*this.VELARIS_MIRROR_PARTICLE_TIME_SCALE;if(this.ctx.fillStyle=e,this.ctx.font=`${i}px Doto`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",y){const t=this.VELARIS_MIRROR_WORD,e=t.length,r=s*(e-1),a=.1*-u;for(let i=0;i<e;i++){const o=(i-(e-1)/2)*s;this.ctx.fillText(t.charAt(i),o,a)}const l=.45*u,h=r+.6*i,c=Math.max(1,.08*u);this.ctx.fillStyle="rgba(255, 255, 220, 0.85)";for(let t=0;t<this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT;t++){const e=o+2.7*t,i=((this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT>1?t/(this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT-1):.5)-.5)*h+Math.sin(n*this.VELARIS_MIRROR_PARTICLE_DRIFT_SPEED+e)*c*.6,s=l+Math.cos(n*(.8*this.VELARIS_MIRROR_PARTICLE_DRIFT_SPEED)+e)*c*.4;this.ctx.beginPath(),this.ctx.arc(i,s,c,0,2*Math.PI),this.ctx.fill()}S=h+i,A=1.4*u}else{const t=.9*u,e=Math.max(1,.12*u),i=2*Math.PI;for(let s=0;s<this.VELARIS_MIRROR_CLOUD_GLYPH_COUNT;s++){const r=o+12.7*s,a=this.getPseudoRandom(r)*i,l=this.getPseudoRandom(r+7.3)*t,h=.2*n+this.getPseudoRandom(r+5.1)*i,c=Math.cos(a)*l+Math.cos(h)*e,d=Math.sin(a)*l+Math.sin(h)*e,g=this.VELARIS_MIRROR_GLYPHS.charAt(s%this.VELARIS_MIRROR_GLYPHS.length);this.ctx.fillText(g,c,d)}const s=Math.max(1,.07*u);this.ctx.fillStyle="rgba(255, 255, 210, 0.6)";for(let r=0;r<this.VELARIS_MIRROR_CLOUD_PARTICLE_COUNT;r++){const a=o+9.4*r,l=this.getPseudoRandom(a+1.1)*i,h=this.getPseudoRandom(a+4.7)*t,c=.25*n+this.getPseudoRandom(a+6.4)*i,d=.75*e,g=Math.cos(l)*h+Math.cos(c)*d,u=Math.sin(l)*h+Math.sin(c)*d;this.ctx.beginPath(),this.ctx.arc(g,u,s,0,2*Math.PI),this.ctx.fill()}S=2*u,A=1.6*u}T=!0}const E=this.getSolarMirrorSpritePath(t);if(E){const t=this.brightenAndPaleColor(d),e=this.getTintedSprite(E,t);if(e){const t=2.4*u/Math.max(e.width,e.height),i=e.width*t,s=e.height*t;S=i,A=s,this.ctx.drawImage(e,-i/2,-s/2,i,s),T=!0}}if(!T){const t=this.ctx.createLinearGradient(0,-f/2,0,f/2);t.addColorStop(0,"#FFFFFF"),t.addColorStop(.5,"#E0E0E0"),t.addColorStop(1,"#C0C0C0"),this.ctx.fillStyle=t,this.ctx.fillRect(-m/2,-f/2,m,f);const e=d;this.ctx.strokeStyle=c?this.darkenColor(e,Bt):e,this.ctx.lineWidth=2,this.ctx.strokeRect(-m/2,-f/2,m,f),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(-m/2,0,3,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(m/2,0,3,0,2*Math.PI),this.ctx.fill()}t.isSelected&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.strokeRect(-S/2-3,-A/2-3,S+6,A+6)),this.ctx.restore(),t.efficiency<1&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(g.x,g.y,.3*u,0,2*Math.PI),this.ctx.fill()),t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,d);const _=t.owner.stellarForge,P=!!(_&&t.health<this.MIRROR_MAX_HEALTH&&t.position.distanceTo(_.position)<=n),I=this.viewingPlayer&&t.owner===this.viewingPlayer?this.playerColor:this.enemyColor;if(this.drawHealthDisplay(g,t.health,this.MIRROR_MAX_HEALTH,u,-u-10,P,P?I:void 0),t.isSelected){const e=t.hasLineOfSightToLight(s.suns,s.asteroids),i=t.owner.stellarForge,o=t.getLinkedStructure(i),n=!!o&&t.hasLineOfSightToStructure(o,s.asteroids,s.players),r=o instanceof ha&&e&&n?t.getEnergyRatePerSec():0,a=this.getSolEnergyIcon(),l=16*this.zoom,h=g.y+u+16*this.zoom;this.ctx.font=12*this.zoom+"px Doto";const c=`+${r.toFixed(0)}/s`,d=this.ctx.measureText(c).width,p=Js*this.zoom,x=l+p+d,y=g.x-x/2;a.complete&&a.naturalWidth>0&&this.ctx.drawImage(a,y,h-l/2,l,l),this.ctx.fillStyle="#FFFFAA",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(c,y+l+p,h)}}drawSpaceDust(t,e,i){const s=this.worldToScreen(t.position),o=H*this.zoom,n=e.suns.find(t=>"lad"===t.type),r=e.isPointInShadow(t.position);if(null!==i&&r){const s=e.players[i];if(!e.isObjectVisibleToPlayer(t.position,s))return}if(e.suns.length>0&&!n){const i=Math.max(.4,dt*this.zoom);this.ctx.strokeStyle=`rgba(0, 0, 20, ${ct})`,this.ctx.lineWidth=i;for(const i of e.suns){const e=t.position.x-i.position.x,o=t.position.y-i.position.y,n=Math.sqrt(e*e+o*o);if(n>0&&n<lt){const t=ht*(1-n/lt);if(t>0){const i=1/n,r=e*i,a=o*i,l=s.x+r*t*this.zoom,h=s.y+a*t*this.zoom;this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(l,h),this.ctx.stroke()}}}}let a=t.glowState;t.glowTransition>0&&t.glowState!==t.targetGlowState&&(a=t.glowState+(t.targetGlowState-t.glowState)*t.glowTransition);const l=!!n&&t.position.x<n.position.x,h=n?l?"#000000":"#FFFFFF":t.currentColor;n&&(a=0);const c=t.velocity.x,d=t.velocity.y,g=Math.sqrt(c*c+d*d);if(g>gt){const t=1/g,e=c*t,i=d*t,n=-i,r=e,a=Math.min(pt,Math.max(ut,g*xt))*this.zoom,l=n*o,u=r*o,p=e*a,x=i*a,y=s.x+l,m=s.y+u,f=s.x-l,S=s.y-u,A=y-p,T=m-x,E=f-p,_=S-x;if(this.ctx.lineWidth=Math.max(.2,yt*this.zoom),this.isFancyGraphicsEnabled&&h.startsWith("#")){let t=h.slice(1);3===t.length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);const e=parseInt(t,16),i=e>>16&255,s=e>>8&255,o=255&e,n=.6,r=this.ctx.createLinearGradient(y,m,A,T);r.addColorStop(0,`rgba(${i}, ${s}, ${o}, ${n})`),r.addColorStop(1,`rgba(${i}, ${s}, ${o}, 0)`),this.ctx.strokeStyle=r,this.ctx.beginPath(),this.ctx.moveTo(y,m),this.ctx.lineTo(A,T),this.ctx.stroke();const a=this.ctx.createLinearGradient(f,S,E,_);a.addColorStop(0,`rgba(${i}, ${s}, ${o}, ${n})`),a.addColorStop(1,`rgba(${i}, ${s}, ${o}, 0)`),this.ctx.strokeStyle=a,this.ctx.beginPath(),this.ctx.moveTo(f,S),this.ctx.lineTo(E,_),this.ctx.stroke()}else this.ctx.strokeStyle=h,this.ctx.globalAlpha=.45,this.ctx.beginPath(),this.ctx.moveTo(y,m),this.ctx.lineTo(A,T),this.ctx.moveTo(f,S),this.ctx.lineTo(E,_),this.ctx.stroke(),this.ctx.globalAlpha=1}if(a>0){const t=o*(1.2+.35*a);this.ctx.fillStyle=h,this.ctx.globalAlpha=.15+.1*a,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,t,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}if(this.isFancyGraphicsEnabled){const t=o*(1.6+.6*a),e=.25+.2*a;this.drawFancyBloom(s,t,h,e)}this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.fill()}getClosestInfluenceOwnerIndex(t,e){let i=1/0,s=null;for(let o=0;o<e.players.length;o++){const r=e.players[o];if(r.stellarForge&&!r.isDefeated()){const e=t.distanceTo(r.stellarForge.position);e<n&&e<i&&(i=e,s=o)}}return s}drawAsteroid(t){const e=t.getWorldVertices();if(0===e.length)return;const i=e.map(t=>this.worldToScreen(t)),s=Ht-Ut,o=s>0?Math.min(1,Math.max(0,(t.size-Ut)/s)):0,n=this.interpolateHexColor(this.colorScheme.asteroidColors.fillStart,this.colorScheme.asteroidColors.fillEnd,o),r=this.interpolateHexColor(this.colorScheme.asteroidColors.strokeStart,this.colorScheme.asteroidColors.strokeEnd,o);this.ctx.fillStyle=n,this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)this.ctx.lineTo(i[t].x,i[t].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}drawSunRays(t){const e=t.suns.find(t=>"lad"===t.type);e?this.drawLadSunRays(t,e):this.drawNormalSunRays(t)}drawNormalSunRays(t){for(const e of t.suns){const t=this.worldToScreen(e.position),i=2*Math.max(this.canvas.width,this.canvas.height),s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,i);if(s.addColorStop(0,this.colorScheme.sunLightRays.nearCenter),s.addColorStop(.5,this.colorScheme.sunLightRays.mid),s.addColorStop(1,this.colorScheme.sunLightRays.edge),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.isFancyGraphicsEnabled){const e=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,1.1*i);e.addColorStop(0,"rgba(255, 255, 220, 0.35)"),e.addColorStop(.4,"rgba(255, 230, 160, 0.18)"),e.addColorStop(1,"rgba(255, 220, 120, 0)"),this.ctx.save(),this.ctx.globalCompositeOperation="screen",this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}}for(const e of t.suns){this.ctx.save(),this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="rgba(0, 0, 20, 0.5)";let s=!1;this.ctx.beginPath();for(const o of t.asteroids){const t=o.getWorldVertices();for(let o=0;o<t.length;o++){const n=t[o],r=t[(o+1)%t.length],a=new i((n.x+r.x)/2,(n.y+r.y)/2),l=new i(e.position.x-a.x,e.position.y-a.y),h=new i(-(r.y-n.y),r.x-n.x);if(l.x*h.x+l.y*h.y<0){const t=new i(n.x-e.position.x,n.y-e.position.y).normalize(),o=new i(r.x-e.position.x,r.y-e.position.y).normalize(),a=new i(n.x+t.x*Ot,n.y+t.y*Ot),l=new i(r.x+o.x*Ot,r.y+o.y*Ot),h=this.worldToScreen(n),c=this.worldToScreen(r),d=this.worldToScreen(a),g=this.worldToScreen(l);this.ctx.moveTo(h.x,h.y),this.ctx.lineTo(c.x,c.y),this.ctx.lineTo(g.x,g.y),this.ctx.lineTo(d.x,d.y),this.ctx.closePath(),s=!0}}}s&&this.ctx.fill(),this.ctx.restore()}}drawLadSunRays(t,e){const s=this.worldToScreen(e.position);this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(0,0,s.x,this.canvas.height),this.ctx.clip(),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(s.x,0,this.canvas.width-s.x,this.canvas.height),this.ctx.clip(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.fillStyle="#000000",this.ctx.beginPath();let o=!1;for(const s of t.asteroids){const t=s.getWorldVertices();for(let s=0;s<t.length;s++){const n=t[s],r=t[(s+1)%t.length],a=new i((n.x+r.x)/2,(n.y+r.y)/2),l=new i(e.position.x-a.x,e.position.y-a.y),h=new i(-(r.y-n.y),r.x-n.x);if(l.x*h.x+l.y*h.y<0){const t=new i(n.x-e.position.x,n.y-e.position.y).normalize(),s=new i(r.x-e.position.x,r.y-e.position.y).normalize(),a=new i(n.x+t.x*Ot,n.y+t.y*Ot),l=new i(r.x+s.x*Ot,r.y+s.y*Ot);if((a.x+l.x)/2<e.position.x){const t=this.worldToScreen(n),e=this.worldToScreen(r),i=this.worldToScreen(a),s=this.worldToScreen(l);this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.lineTo(i.x,i.y),this.ctx.closePath(),o=!0}}}}o&&this.ctx.fill(),this.ctx.restore(),this.ctx.save(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath();let n=!1;for(const s of t.asteroids){const t=s.getWorldVertices();for(let s=0;s<t.length;s++){const o=t[s],r=t[(s+1)%t.length],a=new i((o.x+r.x)/2,(o.y+r.y)/2),l=new i(e.position.x-a.x,e.position.y-a.y),h=new i(-(r.y-o.y),r.x-o.x);if(l.x*h.x+l.y*h.y<0){const t=new i(o.x-e.position.x,o.y-e.position.y).normalize(),s=new i(r.x-e.position.x,r.y-e.position.y).normalize(),a=new i(o.x+t.x*Ot,o.y+t.y*Ot),l=new i(r.x+s.x*Ot,r.y+s.y*Ot);if(!((a.x+l.x)/2<e.position.x)){const t=this.worldToScreen(o),e=this.worldToScreen(r),i=this.worldToScreen(a),s=this.worldToScreen(l);this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.lineTo(i.x,i.y),this.ctx.closePath(),n=!0}}}}n&&this.ctx.fill(),this.ctx.restore()}drawInfluenceCircle(t,e,i){const s=this.worldToScreen(t),o=e*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}drawWarpGate(t,e,i){const s=this.worldToScreen(t.position),o=y*this.zoom,n=t.chargeTime/h,r=Math.min(o,n*o),a=this.selectedWarpGate===t;if(t.isComplete){const n=this.getLadPlayerColor(t.owner,i,e);this.drawWarpGateProductionEffect(s,o,e,n),a&&this.drawBuildingSelectionIndicator(s,o);const r=t.completionRemainingSec/_;if(r>0){const t=o+12*this.zoom;this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,t,-Math.PI/2,-Math.PI/2+r*Math.PI*2),this.ctx.stroke()}if(a){const t=m*this.zoom,e=o+f*this.zoom,i=[{x:0,y:-1,label:"Foundry",index:0},{x:1,y:0,label:"Cannon",index:1},{x:0,y:1,label:"Gatling",index:2},{x:-1,y:0,label:"Cyclone",index:3}];for(const o of i){const i=s.x+o.x*e,n=s.y+o.y*e,r=t+14*this.zoom,a=this.highlightedButtonIndex===o.index;this.ctx.fillStyle=a?"rgba(0, 255, 255, 0.6)":"#444444",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=a?4:2,this.ctx.beginPath(),this.ctx.arc(i,n,t,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=11*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(o.label,i+o.x*r,n+o.y*r)}}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}else{this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.globalAlpha=.5+.2*Math.sin(5*t.chargeTime),this.ctx.beginPath(),this.ctx.arc(s.x,s.y,r,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=5,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,r+5,0,n*Math.PI*2),this.ctx.stroke();const e=`${t.accumulatedEnergy.toFixed(0)}/${c}`;this.ctx.fillStyle="#FFFFFF",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e,s.x,s.y+o+20*this.zoom),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}}drawStarlingMergeGate(t){const e=this.worldToScreen(t.position),i=Gi*this.zoom,s=ki,o=s>0?t.remainingSec/s:0,n=.18+.06*Math.sin(4*(s-t.remainingSec)),r=.35+.1*Math.sin(5*(s-t.remainingSec));this.ctx.fillStyle=`rgba(0, 255, 255, ${Math.max(.1,n)})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle=`rgba(0, 255, 255, ${Math.max(.2,r)})`,this.ctx.lineWidth=2.5*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke(),this.ctx.strokeStyle=`rgba(255, 255, 255, ${Math.max(.3,r)})`,this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.65*i,0,2*Math.PI),this.ctx.stroke();const a=i+7*this.zoom;this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,a,-Math.PI/2,-Math.PI/2+o*Math.PI*2),this.ctx.stroke();const l=e.y+i+10*this.zoom;this.ctx.fillStyle="#FFD700",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText(`${t.absorbedCount}/${Bi}`,e.x,l),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawMirrorCommandButtons(t){if(0===t.size)return;const e=Array.from(t)[0],i=this.worldToScreen(e.position),s=this.hasSeenFoundry,o=this.hasActiveFoundry,n=m*this.zoom,r=50*this.zoom,a=s,l=i.x,h=i.y-r,c=i.x-r,d=i.y,g=i.x+r,u=i.y,p=0===this.highlightedButtonIndex;this.ctx.fillStyle=p?"rgba(255, 215, 0, 0.4)":"#444444",this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=p?4:2,this.ctx.beginPath(),this.ctx.arc(c,d,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=11*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Forge",c,d);const x=1===this.highlightedButtonIndex;if(this.ctx.fillStyle=x?"rgba(0, 255, 255, 0.4)":"#444444",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=x?4:2,this.ctx.beginPath(),this.ctx.arc(l,h,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=9*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Warp",l,h-6*this.zoom),this.ctx.fillText("Gate",l,h+6*this.zoom),a){const t=o&&2===this.highlightedButtonIndex,e=o?t?"rgba(160, 160, 160, 0.4)":"#444444":"#2C2C2C",i=o?"#B0B0B0":"#666666",s=o?"#FFFFFF":"#8A8A8A";this.ctx.fillStyle=e,this.ctx.strokeStyle=i,this.ctx.lineWidth=t?4:2,this.ctx.beginPath(),this.ctx.arc(g,u,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=s,this.ctx.font=9*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Found",g,u-5*this.zoom),this.ctx.fillText("ry",g,u+6*this.zoom)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawUnit(t,e,i,s,o=1){const n=this.worldToScreen(t.position),r=8*this.zoom*o,a=this.selectedUnits.has(t),l=i.suns.find(t=>"lad"===t.type);let h,c=e;l&&t.owner&&(h=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,l):"light",c="light"===h?"#FFFFFF":"#000000");let d=c;if(s&&this.viewingPlayer&&!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;if(a&&t.isHero&&!s){const e=t.attackRange*this.zoom;this.ctx.strokeStyle=c,this.ctx.lineWidth=1,this.ctx.globalAlpha=qs,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,e,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}if(l&&h){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,r,t,h)}const g=t.isHero?this.getHeroSpritePath(t):null,u=l?c:s?this.enemyColor:this.playerColor,p=g?this.getTintedSprite(g,u):null;if(p){const e=r*this.HERO_SPRITE_SCALE,i=t.rotation;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(i),this.ctx.drawImage(p,-e/2,-e/2,e,e),this.ctx.restore()}else this.ctx.fillStyle=d,this.ctx.strokeStyle=d,this.ctx.lineWidth=a?3:1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();if(this.isFancyGraphicsEnabled){const t=d,e=r*(a?1.9:1.5),i=a?.45:.3;this.drawFancyBloom(n,e,t,i)}if(this.drawHealthDisplay(n,t.health,t.maxHealth,r,-r-8),t.isStunned()){this.ctx.fillStyle="#FFFF00",this.ctx.globalAlpha=.7;const t=6*this.zoom;for(let e=0;e<3;e++){const s=(3*i.gameTime+e*(2*Math.PI/3))%(2*Math.PI),o=n.x+Math.cos(s)*(1.8*r),a=n.y+Math.sin(s)*(1.8*r);this.ctx.beginPath();for(let e=0;e<5;e++){const i=e*(2*Math.PI/5)-Math.PI/2,s=o+Math.cos(i)*t*.5,n=a+Math.sin(i)*t*.5;0===e?this.ctx.moveTo(s,n):this.ctx.lineTo(s,n)}this.ctx.closePath(),this.ctx.fill()}this.ctx.globalAlpha=1}if(!t.isHero&&t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y,s=Math.atan2(i,e);this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(n.x+Math.cos(s)*r*1.5,n.y+Math.sin(s)*r*1.5),this.ctx.stroke()}t.moveOrder>0&&t.rallyPoint&&this.drawMoveOrderIndicator(t.position,t.rallyPoint,t.moveOrder,e)}drawMoveOrderIndicator(t,e,i,s){const o=this.worldToScreen(t),n=this.worldToScreen(e);this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.globalAlpha=.5,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(n.x,n.y),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=1;const r=this.MOVE_ORDER_DOT_RADIUS;this.drawMovementPointMarker(n,r,s)||(this.ctx.fillStyle=s,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke())}getMoveOrderFrameIndex(){return Math.floor(performance.now()/this.MOVE_ORDER_FRAME_DURATION_MS)%At}drawMovementPointMarker(t,e,i){const s=this.getMoveOrderFrameIndex(),o=this.movementPointFramePaths[s],n=this.getTintedSprite(o,i);if(n)return this.drawMovementPointSprite(n,t,e),!0;const r=this.getTintedSprite(this.MOVE_ORDER_FALLBACK_SPRITE_PATH,i);return!!r&&(this.drawMovementPointSprite(r,t,e),!0)}drawMovementPointSprite(t,e,i){const s=2*i/Math.max(t.width,t.height),o=t.width*s,n=t.height*s;this.ctx.drawImage(t,e.x-o/2,e.y-n/2,o,n)}drawMuzzleFlash(t){const e=this.worldToScreen(t.position),i=5*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.angle),this.ctx.fillStyle=`rgba(255, 255, 100, ${s})`,this.ctx.beginPath(),this.ctx.ellipse(0,0,2*i,i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBulletCasing(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=5*this.zoom,o=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.rotation),this.ctx.fillStyle=`rgba(255, 215, 0, ${o})`,this.ctx.fillRect(-i/2,-s/2,i,s),this.ctx.restore()}drawBouncingBullet(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=`rgba(255, 255, 0, ${s})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill()}drawAbilityBullet(t){var e,i;const s=this.worldToScreen(t.position),o=4*this.zoom,n=t.lifetime/t.maxLifetime,r=this.getFactionColor(t.owner.faction);if(this.ctx.fillStyle=`${r}`,this.ctx.globalAlpha=n,t.isSpotlightBullet){const o=Math.atan2(t.velocity.y,t.velocity.x),n=(null!==(e=t.renderLengthPx)&&void 0!==e?e:8)*this.zoom,r=(null!==(i=t.renderWidthPx)&&void 0!==i?i:2)*this.zoom;this.ctx.save(),this.ctx.translate(s.x,s.y),this.ctx.rotate(o),this.ctx.fillRect(.5*-n,.5*-r,n,r),this.ctx.restore()}else this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.fill();this.ctx.globalAlpha=1}drawMinionProjectile(t){const e=this.worldToScreen(t.position),i=2.5*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.globalAlpha=.9,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawMortarProjectile(t){const e=this.worldToScreen(t.position),i=6*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.5,this.ctx.beginPath(),this.ctx.arc(e.x-.2*i,e.y-.2*i,.4*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawNovaBomb(t){const e=this.worldToScreen(t.position),i=Mr*this.zoom,s=this.getFactionColor(t.owner.faction);if(t.isArmed){const o=.5+.5*Math.sin(8*t.lifetime);this.ctx.fillStyle=s,this.ctx.globalAlpha=.2*o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,2*i,0,2*Math.PI),this.ctx.fill()}if(this.ctx.fillStyle=s,this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.4*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),t.isArmed){const s=5*t.lifetime,o=e.x+Math.cos(s)*i*.6,n=e.y+Math.sin(s)*i*.6;this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(o,n,.3*i,0,2*Math.PI),this.ctx.fill()}else this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(e.x-.3*i,e.y-.3*i,.4*i,0,2*Math.PI),this.ctx.fill();this.ctx.globalAlpha=1}drawNovaScatterBullet(t){const e=this.worldToScreen(t.position),i=4*this.zoom,s=this.getFactionColor(t.owner.faction),o=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=s,this.ctx.globalAlpha=.3*o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=o,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.6*o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.4*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawStickyBomb(t){const e=this.worldToScreen(t.position),i=Gr*this.zoom,s=this.getFactionColor(t.owner.faction);if(t.isArmed&&t.isStuck){const o=.5+.5*Math.sin(10*t.lifetime);this.ctx.fillStyle=s,this.ctx.globalAlpha=.3*o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,2.5*i,0,2*Math.PI),this.ctx.fill()}if(this.ctx.fillStyle=s,this.ctx.globalAlpha=t.isStuck?.5:.3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),t.isStuck&&(this.ctx.fillStyle="#000000",this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.6*i,0,2*Math.PI),this.ctx.fill()),t.isArmed&&t.isStuck){const s=6*t.lifetime,o=e.x+Math.cos(s)*i*.4,n=e.y+Math.sin(s)*i*.4;this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.9,this.ctx.beginPath(),this.ctx.arc(o,n,.3*i,0,2*Math.PI),this.ctx.fill()}else this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.arc(e.x-.3*i,e.y-.3*i,.3*i,0,2*Math.PI),this.ctx.fill();if(t.isStuck&&t.surfaceNormal){this.ctx.strokeStyle=s,this.ctx.globalAlpha=.5,this.ctx.lineWidth=2*this.zoom;const o=1.5*i;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x+t.surfaceNormal.x*o,e.y+t.surfaceNormal.y*o),this.ctx.stroke()}this.ctx.globalAlpha=1}drawStickyLaser(t){const e=this.worldToScreen(t.startPosition),i=t.getEndPosition(),s=this.worldToScreen(i),o=this.getFactionColor(t.owner.faction),n=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=o,this.ctx.globalAlpha=.2*n,this.ctx.lineWidth=t.width*this.zoom*2.5,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.globalAlpha=.5*n,this.ctx.lineWidth=t.width*this.zoom*1.5,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.globalAlpha=.9*n,this.ctx.lineWidth=t.width*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.strokeStyle="#FFFFFF",this.ctx.globalAlpha=.7*n,this.ctx.lineWidth=t.width*this.zoom*.3,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.globalAlpha=1}drawDisintegrationParticle(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=this.getFactionColor(t.owner.faction),o=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=s,this.ctx.globalAlpha=.3*o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.8*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=.8*o,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),Math.random()>.7&&(this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.5*o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.5*i,0,2*Math.PI),this.ctx.fill()),this.ctx.globalAlpha=1}drawLaserBeam(t){const e=this.worldToScreen(t.startPos),i=this.worldToScreen(t.endPos),s=this.getFactionColor(t.owner.faction),o=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=s,this.ctx.globalAlpha=.8*o,this.ctx.lineWidth=t.widthPx,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=.3*o,this.ctx.lineWidth=2*t.widthPx,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=1}drawImpactParticle(t){const e=this.worldToScreen(t.position),i=this.getFactionColor(t.faction),s=1-t.lifetime/t.maxLifetime,o=1*this.zoom;this.ctx.fillStyle=i,this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawSparkleParticle(t){const e=this.worldToScreen(t.position),i=t.getOpacity(),s=t.size*this.zoom;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.globalAlpha=i,this.ctx.strokeStyle=t.color,this.ctx.lineWidth=Math.max(1,.4*s),this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(-s,0),this.ctx.lineTo(s,0),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,-s),this.ctx.lineTo(0,s),this.ctx.stroke();const o=this.ctx.createRadialGradient(0,0,0,0,0,s);o.addColorStop(0,t.color),o.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(0,0,s,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawDeathParticle(t){const e=this.worldToScreen(t.position);if(t.spriteFragment){this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.rotation),this.ctx.globalAlpha=t.opacity;const i=t.spriteFragment.width*this.zoom;this.ctx.drawImage(t.spriteFragment,-i/2,-i/2,i,i),this.ctx.restore()}}drawInfluenceZone(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=Math.max(.1,1-t.lifetime/t.duration),o=this.getFactionColor(t.owner.faction);this.ctx.strokeStyle=o,this.ctx.globalAlpha=.6*s,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);n.addColorStop(0,`${o}40`),n.addColorStop(1,`${o}10`),this.ctx.fillStyle=n,this.ctx.globalAlpha=.3*s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawInfluenceBallProjectile(t){const e=this.worldToScreen(t.position),i=12*this.zoom,s=this.getFactionColor(t.owner.faction),o=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);o.addColorStop(0,s),o.addColorStop(.5,`${s}AA`),o.addColorStop(1,`${s}00`),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.3*i,0,2*Math.PI),this.ctx.fill()}drawCrescentWave(t){const e=this.worldToScreen(t.position),i=this.getFactionColor(t.owner.faction);this.ctx.save();const s=rr*this.zoom,o=sr/2,n=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,1.5*s);n.addColorStop(0,`${i}00`),n.addColorStop(.5,`${i}88`),n.addColorStop(1,`${i}00`),this.ctx.strokeStyle=i,this.ctx.lineWidth=.5*s,this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,s,t.angle-o,t.angle+o),this.ctx.stroke(),this.ctx.fillStyle=n,this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.arc(e.x,e.y,1.5*s,t.angle-o,t.angle+o),this.ctx.closePath(),this.ctx.fill();for(let i=0;i<10;i++){const n=t.angle-o+sr*i/10,r=s*(.8+.2*Math.sin(5*t.lifetime+i)),a=e.x+Math.cos(n)*r,l=e.y+Math.sin(n)*r;this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(a,l,3*this.zoom,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawDeployedTurret(t,e){const i=this.worldToScreen(t.position),s=e.suns.find(t=>"lad"===t.type);let o=this.getFactionColor(t.owner.faction);s&&t.owner&&(o="light"===(t.owner.stellarForge?e.getLadSide(t.owner.stellarForge.position,s):"light")?"#FFFFFF":"#000000");const n=Do*this.zoom,r=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_bottom.png",o);if(r){const t=r.width*n,e=r.height*n;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.drawImage(r,-t/2,-e/2,t,e),this.ctx.restore()}let a=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;a=Math.atan2(i,e)}let l=null;if(t.isFiring){const e=Math.floor(t.firingAnimationProgress*vo),i=`ASSETS/sprites/RADIANT/structures/radiantCannonAnimation/radiantCannonFrame (${Math.min(e,vo-1)+1}).png`;l=this.getTintedSprite(i,o)}else l=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_top_outline.png",o);if(l){const t=l.width*n,e=l.height*n;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(a+Math.PI/2),this.ctx.drawImage(l,-t/2,-e/2,t,e),this.ctx.restore()}const h=Oo*this.zoom;this.drawHealthDisplay(i,t.health,t.maxHealth,h,-h-10)}drawGrave(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=16*this.zoom;this.ctx.font=`bold ${l}px Arial`,this.ctx.fillStyle=n?this.darkenColor("#FFFFFF",Bt):"#FFFFFF",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("G",a.x,a.y);for(const e of t.getProjectiles())this.drawGraveProjectile(e,r);for(const e of t.getSmallParticles())this.drawGraveSmallParticle(e,r)}drawMergedStarlingRanges(t){const e=[];for(const t of this.selectedUnits)t instanceof ma&&this.viewingPlayer&&t.owner===this.viewingPlayer&&e.push(t);if(0===e.length)return;const i=this.getFactionColor(this.viewingPlayer.faction);this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.globalAlpha=qs,this.ctx.beginPath();const s=2*Math.PI,o=5e-4;for(let t=0;t<e.length;t++){const i=e[t];if(!this.isWithinViewBounds(i.position,i.attackRange))continue;const n=this.worldToScreen(i.position),r=i.attackRange*this.zoom,a=Math.min(.08,2/Math.max(r,1)),l=[],h=[];let c=!1;for(let n=0;n<e.length;n++){if(t===n)continue;const r=e[n],a=r.position.x-i.position.x,d=r.position.y-i.position.y,g=a*a+d*d,u=r.attackRange;if(g<=1e-4){if(i.attackRange<=u){c=!0;break}continue}const p=Math.sqrt(g);if(p+i.attackRange<=u+o){c=!0;break}if(p>=i.attackRange+u-o)continue;const x=Math.atan2(d,a),y=(g+i.attackRange*i.attackRange-u*u)/(2*p*i.attackRange),m=Math.max(-1,Math.min(1,y)),f=Math.acos(m);if(f<=o)continue;let S=x-f,A=x+f;S<0&&(l.push(S+s),h.push(s),S=0),A>s&&(l.push(0),h.push(A-s),A=s),l.push(S),h.push(A)}if(c)continue;if(0===l.length){this.ctx.moveTo(n.x+r,n.y),this.ctx.arc(n.x,n.y,r,0,s);continue}const d=l.length,g=new Array(d);for(let t=0;t<d;t++)g[t]=t;g.sort((t,e)=>l[t]-l[e]);const u=[],p=[];let x=l[g[0]],y=h[g[0]];for(let t=1;t<d;t++){const e=l[g[t]],i=h[g[t]];e<=y+o?i>y&&(y=i):(u.push(x),p.push(y),x=e,y=i)}u.push(x),p.push(y);let m=0;for(let t=0;t<u.length;t++)m+=p[t]-u[t];if(!(m>=s-a))for(let t=0;t<u.length;t++){const e=p[t],i=t+1<u.length?u[t+1]:u[0]+s;this.drawVisibleArcSegment(n,r,e,i,a)}}this.ctx.stroke(),this.ctx.globalAlpha=1}drawVisibleArcSegment(t,e,i,s,o){if(s<=i)return;const n=2*Math.PI;if(s-i<=o)return;const r=i%n,a=s%n;return s-i>=n?(this.ctx.moveTo(t.x+e,t.y),void this.ctx.arc(t.x,t.y,e,0,n)):a<r?(this.ctx.moveTo(t.x+Math.cos(r)*e,t.y+Math.sin(r)*e),this.ctx.arc(t.x,t.y,e,r,n),this.ctx.moveTo(t.x+e,t.y),void this.ctx.arc(t.x,t.y,e,0,a)):(this.ctx.moveTo(t.x+Math.cos(r)*e,t.y+Math.sin(r)*e),void this.ctx.arc(t.x,t.y,e,r,a))}drawStarling(t,e,i,s){const o=this.worldToScreen(t.position),n=8*this.zoom*.3,r=this.selectedUnits.has(t),a=i.suns.find(t=>"lad"===t.type),l=t.owner.faction===Jr.VELARIS;let h=!1,c=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;a||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(e,Bt))}const d=this.getStarlingSpritePath(t);let g,u=s?this.enemyColor:this.playerColor;a&&t.owner&&(g=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,a):"light",u="light"===g?"#FFFFFF":"#000000");const p=h?this.darkenColor(u,Bt):u;if(c=p,a&&g){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(o,n,t,g)}if(l)this.drawVelarisStarlingParticles(o,n,t,c,i.gameTime);else{const e=d?this.getTintedSprite(d,p):null;if(e){const i=n*ft,s=this.getStarlingFacingRotationRad(t);null!==s?(this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(s),this.ctx.drawImage(e,-i/2,-i/2,i,i),this.ctx.restore()):this.ctx.drawImage(e,o.x-i/2,o.y-i/2,i,i)}else{this.ctx.fillStyle=c;const t=c;this.ctx.strokeStyle=r?t:h?this.darkenColor(t,Bt):t,this.ctx.lineWidth=r?3:1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke()}}if(this.drawHealthDisplay(o,t.health,t.maxHealth,n,6*-n-10),!s&&t.owner.hasBlinkUpgrade&&t.abilityCooldownTime>0){const e=8*n,i=Math.max(2,3*this.zoom),s=o.x-e/2,r=o.y+3.5*n,a=Math.max(0,Math.min(1,1-t.abilityCooldown/t.abilityCooldownTime));this.ctx.fillStyle="#222",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#00B4FF",this.ctx.fillRect(s,r,e*a,i)}}drawVelarisStarlingParticles(t,e,i,s,o){var n;const r=i.velocity.x,a=i.velocity.y,l=r*r+a*a,h=l>4;let c=!1;if(i.target&&"position"in i.target&&(!("health"in i.target)||i.target.health>0)){const t=i.target.position,e=t.x-i.position.x,s=t.y-i.position.y;e*e+s*s<=i.attackRange*i.attackRange&&(c=!0)}const d=h||c,g=Math.max(1,this.VELARIS_STARLING_PARTICLE_RADIUS_PX*this.zoom),u=this.brightenAndPaleColor(s),p=.31*i.position.x+.47*i.position.y+9.1*i.spriteLevel,x=2*Math.PI,y=Math.sqrt(l),m=d?Math.min(1,y/80):0,f=this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_BASE+m*this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_RANGE,S=o*(d?f:this.VELARIS_STARLING_CLOUD_TIME_SCALE);if(this.ctx.save(),this.ctx.fillStyle=u,this.ctx.globalAlpha=d?.9:.7,this.ctx.beginPath(),d){const s=null!==(n=this.getStarlingFacingRotationRad(i))&&void 0!==n?n:i.rotation,o=Math.cos(s),r=Math.sin(s),a=e*this.VELARIS_STARLING_TRIANGLE_RADIUS_SCALE,l=.8660254*a,h=.5*a,c=a*r,d=-a*o,u=l*o-h*r,y=l*r+h*o,m=-l*o-h*r,f=-l*r+h*o,A=u-c,T=y-d,E=m-u,_=f-y,P=c-m,I=d-f,C=Math.sqrt(A*A+T*T)||1,M=Math.sqrt(E*E+_*_)||1,R=Math.sqrt(P*P+I*I)||1,w=-T/C,b=A/C,L=-_/M,F=E/M,D=-I/R,v=P/R,O=this.VELARIS_STARLING_TRIANGLE_PARTICLE_COUNT,N=e*this.VELARIS_STARLING_TRIANGLE_WOBBLE_SCALE;for(let e=0;e<O;e++){const i=p+13.3*e,s=(e/O+S*this.VELARIS_STARLING_TRIANGLE_FLOW_SPEED+.2*this.getPseudoRandom(i+5.9))%1*3,o=Math.floor(s),n=s-o;let r=c,a=d,l=A,h=T,C=w,M=b;1===o?(r=u,a=y,l=E,h=_,C=L,M=F):2===o&&(r=m,a=f,l=P,h=I,C=D,M=v);const R=r+l*n,B=a+h*n,k=Math.sin(S*this.VELARIS_STARLING_TRIANGLE_WOBBLE_SPEED+i)*N,G=R+C*k,U=B+M*k,H=t.x+G,W=t.y+U;this.ctx.moveTo(H+g,W),this.ctx.arc(H,W,g,0,x)}}else{const i=e*this.VELARIS_STARLING_CLOUD_RADIUS_SCALE,s=i*this.VELARIS_STARLING_CLOUD_SWIRL_SCALE,o=this.VELARIS_STARLING_CLOUD_PARTICLE_COUNT;for(let e=0;e<o;e++){const o=p+8.7*e,n=this.getPseudoRandom(o)*x,r=this.getPseudoRandom(o+1.3)*i,a=S*(this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_BASE+this.getPseudoRandom(o+2.1)*this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_VARIANCE)+this.getPseudoRandom(o+3.4)*x,l=.7+.2*Math.sin(S*this.VELARIS_STARLING_CLOUD_PULL_SPEED+o),h=Math.cos(n)*r*l+Math.cos(a)*s*.3,c=Math.sin(n)*r*l+Math.sin(a)*s*.3,d=t.x+h,u=t.y+c;this.ctx.moveTo(d+g,u),this.ctx.arc(d,u,g,0,x)}}this.ctx.fill(),this.ctx.restore()}drawStarlingMoveLines(t){if(!this.viewingPlayer)return;const e=new Map;for(const t of this.selectedUnits)if(t instanceof ma&&t.owner===this.viewingPlayer&&t.rallyPoint&&t.moveOrder>0){const i=`${t.rallyPoint.x},${t.rallyPoint.y}`;e.has(i)||e.set(i,{rallyPoint:t.rallyPoint,starlings:[]}),e.get(i).starlings.push(t)}const i=this.getFactionColor(this.viewingPlayer.faction);for(const[t,s]of e){if(0===s.starlings.length)continue;let t=s.starlings[0],e=1/0;for(const i of s.starlings){const o=s.rallyPoint.x-i.position.x,n=s.rallyPoint.y-i.position.y,r=o*o+n*n;r<e&&(e=r,t=i)}this.drawMoveOrderIndicator(t.position,s.rallyPoint,t.moveOrder,i)}}drawRay(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y-l),this.ctx.lineTo(a.x-.3*l,a.y),this.ctx.lineTo(a.x+.3*l,a.y),this.ctx.lineTo(a.x,a.y+l),this.ctx.stroke();const h=t.getBeamSegments();for(const t of h){const e=this.worldToScreen(t.startPos),i=this.worldToScreen(t.endPos),s=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=r,this.ctx.globalAlpha=s,this.ctx.lineWidth=uo*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}this.ctx.globalAlpha=1}drawNova(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom;for(let t=0;t<4;t++){const e=Math.PI/4+t*Math.PI/2,i=a.x+Math.cos(e)*l*.3,s=a.y+Math.sin(e)*l*.3,o=a.x+Math.cos(e)*l,n=a.y+Math.sin(e)*l;this.ctx.beginPath(),this.ctx.moveTo(i,s),this.ctx.lineTo(o,n),this.ctx.stroke()}this.ctx.globalAlpha=1}drawInfluenceBall(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=12*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,l,0,2*Math.PI),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(a.x,a.y,.6*l,0,2*Math.PI),this.ctx.stroke()}drawTurretDeployer(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.fillStyle=r,this.ctx.fillRect(a.x-.5*l,a.y-.3*l,l,.6*l),this.ctx.fillRect(a.x-.2*l,a.y-l,.4*l,l)}drawDriller(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);if(t.isHiddenInAsteroid())return;let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(a.x-l,a.y),this.ctx.lineTo(a.x,a.y-.5*l),this.ctx.lineTo(a.x+l,a.y),this.ctx.lineTo(a.x,a.y+.5*l),this.ctx.closePath(),this.ctx.stroke()}drawDagger(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}let a=!1;if(!s&&t.isCloakedToEnemies()&&(a=!0,this.ctx.globalAlpha=Zo),this.drawUnit(t,a?e:r,i,s),a){const i=this.worldToScreen(t.position),s=8*this.zoom;this.ctx.strokeStyle=e,this.ctx.lineWidth=1.5*this.zoom,this.ctx.setLineDash([3*this.zoom,3*this.zoom]),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s+6,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([])}if(!t.isCloakedToEnemies()&&!s){const e=this.worldToScreen(t.position),i=8*this.zoom;this.ctx.strokeStyle=n?this.darkenColor("#FF6600",Bt):"#FF6600",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x-.7*i,e.y-.7*i),this.ctx.lineTo(e.x+.7*i,e.y+.7*i),this.ctx.stroke()}a&&(this.ctx.globalAlpha=1)}drawBeam(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}if(this.drawUnit(t,r,i,s),!s){const e=this.worldToScreen(t.position),i=10*this.zoom;this.ctx.strokeStyle=n?this.darkenColor("#FF0000",Bt):"#FF0000",this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x-i,e.y),this.ctx.lineTo(e.x+i,e.y),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y+i),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.3*i,0,2*Math.PI),this.ctx.stroke()}if(i.gameTime-t.lastBeamTime<2&&t.lastBeamMultiplier>0){const e=this.worldToScreen(t.position),s=-20*this.zoom,o=`(${rn}x${t.lastBeamMultiplier.toFixed(1)})`,n=10*this.zoom;this.ctx.font=`${n}px Doto`,this.ctx.fillStyle="#FFAA00",this.ctx.textAlign="center",this.ctx.textBaseline="bottom";const r=i.gameTime-t.lastBeamTime,a=Math.max(0,1-r/2);this.ctx.globalAlpha=a,this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeText(o,e.x,e.y+s),this.ctx.fillText(o,e.x,e.y+s)}this.ctx.globalAlpha=1}drawSpotlight(t,e,s,o){const n=s.suns.find(t=>"lad"===t.type);let r=!1,a=e;if(o&&this.viewingPlayer){if(!s.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;n||s.isPointInShadow(t.position)&&(r=!0,a=this.darkenColor(e,Bt))}this.drawUnit(t,a,s,o);const l=this.worldToScreen(t.position),h=10*this.zoom;if(this.ctx.strokeStyle=a,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y-.6*h),this.ctx.lineTo(l.x+.6*h,l.y),this.ctx.lineTo(l.x,l.y+.6*h),this.ctx.stroke(),t.spotlightDirection&&t.spotlightLengthFactor>0){const e=t.spotlightRangePx*t.spotlightLengthFactor;if(e>0){const s=Math.atan2(t.spotlightDirection.y,t.spotlightDirection.x),o=mn/2,n=s-o,h=s+o,c=new i(t.position.x+Math.cos(n)*e,t.position.y+Math.sin(n)*e),d=new i(t.position.x+Math.cos(h)*e,t.position.y+Math.sin(h)*e),g=l,u=this.worldToScreen(c),p=this.worldToScreen(d),x=r?.12:.18;this.ctx.fillStyle=a,this.ctx.globalAlpha=x,this.ctx.beginPath(),this.ctx.moveTo(g.x,g.y),this.ctx.lineTo(u.x,u.y),this.ctx.lineTo(p.x,p.y),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=.6,this.ctx.strokeStyle=a,this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(g.x,g.y),this.ctx.lineTo(u.x,u.y),this.ctx.moveTo(g.x,g.y),this.ctx.lineTo(p.x,p.y),this.ctx.stroke(),this.ctx.globalAlpha=1}}}drawMortar(t,e,i,s){const o=i.suns.find(t=>"lad"===t.type);let n=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;o||i.isPointInShadow(t.position)&&(n=!0,r=this.darkenColor(e,Bt))}if(!s&&t.isSetup&&t.facingDirection){const i=this.worldToScreen(t.position),s=Math.atan2(t.facingDirection.y,t.facingDirection.x),o=bn/2,r=Cn*this.zoom;this.ctx.fillStyle=n?this.darkenColor(e,.5*Bt):e,this.ctx.globalAlpha=.15,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.arc(i.x,i.y,r,s-o,s+o),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.strokeStyle=n?this.darkenColor(e,Bt):e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.arc(i.x,i.y,r,s-o,s+o),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=1}if(this.drawUnit(t,r,i,s),!s&&t.isSetup&&t.facingDirection){const e=this.worldToScreen(t.position),i=Math.atan2(t.facingDirection.y,t.facingDirection.x),s=15*this.zoom;this.ctx.strokeStyle=n?this.darkenColor("#888888",Bt):"#888888",this.ctx.lineWidth=4*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x+Math.cos(i)*s,e.y+Math.sin(i)*s),this.ctx.stroke()}else if(!s&&!t.isSetup){const e=this.worldToScreen(t.position),i=12*this.zoom;this.ctx.strokeStyle=n?this.darkenColor("#FFAA00",Bt):"#FFAA00",this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y-.3*i),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y-.1*i,1.5*this.zoom,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}}drawPreist(t,e,i,s){if(this.drawUnit(t,e,i,s),s)return;const o=t.getHealingBeamTargets(),n=this.worldToScreen(t.position);this.ctx.save();for(const t of o){if(!t)continue;const e=this.worldToScreen(t.position);this.ctx.strokeStyle="#00FF88",this.ctx.lineWidth=3*this.zoom,this.ctx.globalAlpha=.6+.2*Math.sin(5*i.gameTime),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke();const s=5;for(let t=0;t<s;t++){const o=(t/s+.5*i.gameTime)%1,r=n.x+(e.x-n.x)*o,a=n.y+(e.y-n.y)*o;this.ctx.fillStyle="#00FF88",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(r,a,2*this.zoom,0,2*Math.PI),this.ctx.fill()}}const r=t.getHealingBombParticles();for(const t of r){const e=this.worldToScreen(t.position);this.ctx.fillStyle="#00FF88",this.ctx.globalAlpha=.8*(1-t.lifetime/t.maxLifetime),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,3*this.zoom,0,2*Math.PI),this.ctx.fill();const i=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,8*this.zoom);i.addColorStop(0,"rgba(0, 255, 136, 0.4)"),i.addColorStop(1,"rgba(0, 255, 136, 0)"),this.ctx.fillStyle=i,this.ctx.globalAlpha=.6*(1-t.lifetime/t.maxLifetime),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,8*this.zoom,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawTank(t,e,i,s){this.drawUnit(t,e,i,s);const o=this.worldToScreen(t.position);this.ctx.save();const n=ir*this.zoom,r=.2+.1*Math.sin(3*i.gameTime);this.ctx.strokeStyle=e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=r,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.stroke();const a=this.ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,n);a.addColorStop(0,"rgba(100, 150, 255, 0)"),a.addColorStop(.7,`rgba(100, 150, 255, ${.3*r})`),a.addColorStop(1,"rgba(100, 150, 255, 0)"),this.ctx.fillStyle=a,this.ctx.globalAlpha=1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawWarpGateProductionEffect(t,e,i,s){const o=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/warpGate_bottom.png",s),n=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/warpGate_top.png",s),r=o||n;if(!r)return this.ctx.fillStyle="rgba(0, 255, 255, 0.2)",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.fill(),void this.ctx.stroke();const a=2*e/r.width,l=i.gameTime,h=.9*l,c=(e,i)=>{if(!e)return;const s=e.width*a,o=e.height*a;this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(i),this.ctx.drawImage(e,-s/2,-o/2,s,o),this.ctx.restore()};c(o,.9*-l),c(n,h)}drawMinigun(t,e,i,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,Bt))}if(!t.isComplete){this.drawWarpGateProductionEffect(o,n,i,c),t.isSelected&&this.drawBuildingSelectionIndicator(o,n);const e=2*n,s=4,r=o.x-e/2,a=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(r,a,e,s),this.ctx.fillStyle="#00FF00",this.ctx.fillRect(r,a,e*t.buildProgress,s),void(h&&(this.ctx.globalAlpha=1))}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(o,n,t,a)}const d=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_bottom.png",c),g=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_top_outline.png",c);if(d&&g){const e=2*n/d.width,i=d.width*e,s=d.height*e;this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.drawImage(d,-i/2,-s/2,i,s),this.ctx.restore(),t.isSelected&&this.drawBuildingSelectionIndicator(o,n);let r=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;r=Math.atan2(i,e)}const a=g.width*e,l=g.height*e;this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(r+Math.PI/2),this.ctx.drawImage(g,-a/2,-l/2,a,l),this.ctx.restore()}else{this.ctx.fillStyle=c;const e=c;this.ctx.strokeStyle=h?this.darkenColor(e,Bt):e,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isSelected&&this.drawBuildingSelectionIndicator(o,n);const i=.6*n;this.ctx.fillStyle=h?this.darkenColor("#666666",Bt):"#666666",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,i,0,2*Math.PI),this.ctx.fill();let s=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;s=Math.atan2(i,e)}const r=1.2*n,a=4*this.zoom;this.ctx.strokeStyle=h?this.darkenColor("#333333",Bt):"#333333",this.ctx.lineWidth=a,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(o.x+Math.cos(s)*r,o.y+Math.sin(s)*r),this.ctx.stroke()}this.drawHealthDisplay(o,t.health,t.maxHealth,n,-n-10)}drawSpaceDustSwirler(t,e,i,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,Bt))}if(!t.isComplete){this.drawWarpGateProductionEffect(o,n,i,c),t.isSelected&&this.drawBuildingSelectionIndicator(o,n);const e=2*n,s=4,r=o.x-e/2,a=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(r,a,e,s),this.ctx.fillStyle="#8A2BE2",this.ctx.fillRect(r,a,e*t.buildProgress,s),void(h&&(this.ctx.globalAlpha=1))}const d=t.currentInfluenceRadius*this.zoom;if(this.ctx.strokeStyle=c,this.ctx.globalAlpha=.15,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,d,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(o,n,t,a)}const g=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCyclone_bottom.png",c),u=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCyclone_middle.png",c),p=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCyclone_top.png",c),x=g||u||p;if(x){const e=2*n/x.width,s=i.gameTime,r=.6*-s,a=.8*s,l=(t,i)=>{if(!t)return;const s=t.width*e,n=t.height*e;this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(i),this.ctx.drawImage(t,-s/2,-n/2,s,n),this.ctx.restore()};l(g,0),t.isSelected&&this.drawBuildingSelectionIndicator(o,n),l(u,r),l(p,a)}this.drawHealthDisplay(o,t.health,t.maxHealth,n,-n-10)}drawSubsidiaryFactory(t,e,i,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,Bt))}if(!t.isComplete){this.drawWarpGateProductionEffect(o,n,i,c),t.isSelected&&this.drawBuildingSelectionIndicator(o,n);const e=2*n,s=4,r=o.x-e/2,a=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(r,a,e,s),this.ctx.fillStyle="#FFD700",this.ctx.fillRect(r,a,e*t.buildProgress,s),void(h&&(this.ctx.globalAlpha=1))}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(o,n,t,a)}const d=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantFoundry_bottom.png",c),g=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantFoundry_middle.png",c),u=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantFoundry_top.png",c),p=d||g||u;if(p){const e=2*n/p.width,s=i.gameTime,r=.2,a=2.5,l=.2;let h=1;if(Boolean(t.currentProduction))if(t.productionProgress<l){const e=t.productionProgress/l;h=1+(a-1)*(.5-.5*Math.cos(e*Math.PI))}else h=a;const c=r*h,x=-s*c,y=(t,i)=>{if(!t)return;const s=t.width*e,n=t.height*e;this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(i),this.ctx.drawImage(t,-s/2,-n/2,s,n),this.ctx.restore()};y(d,s*c),t.isSelected&&(this.drawBuildingSelectionIndicator(o,n),this.drawFoundryButtons(t,o)),y(g,0),y(u,x)}if(t.currentProduction){const e=2*n,i=4,s=o.x-e/2,r=o.y+n+5;this.ctx.fillStyle="#333333",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#4CAF50",this.ctx.fillRect(s,r,e*t.productionProgress,i)}this.drawHealthDisplay(o,t.health,t.maxHealth,n,-n-10)}drawGraveProjectile(t,e){const i=this.worldToScreen(t.position),s=4*this.zoom;if(t.isAttacking&&t.trail.length>1){this.ctx.strokeStyle=e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath();for(let e=0;e<t.trail.length;e++){const i=this.worldToScreen(t.trail[e]);0===e?this.ctx.moveTo(i.x,i.y):this.ctx.lineTo(i.x,i.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle=e,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isAttacking&&(this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,1.5*s,0,2*Math.PI),this.ctx.fill())}drawGraveSmallParticle(t,e){const i=this.worldToScreen(t.position),s=xe*this.zoom;this.ctx.fillStyle=e,this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawConnections(t,e,i,s){if(t.stellarForge&&(!this.viewingPlayer||t===this.viewingPlayer))for(const o of t.solarMirrors){if(!this.isWithinViewBounds(o.position,120))continue;const n=this.worldToScreen(o.position),r=o.getLinkedStructure(t.stellarForge),a=o.hasLineOfSightToLight(e,i),l=a?o.getClosestVisibleSun(e,i):o.getClosestSun(e),h=!!r&&o.hasLineOfSightToStructure(r,i,s);if(l&&!a){const t=this.worldToScreen(l.position);this.ctx.strokeStyle="rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}if(r&&!h){const t=this.worldToScreen(r.position);this.ctx.strokeStyle="rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}a&&h&&(this.ctx.fillStyle="rgba(255, 255, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(n.x,n.y,Bs*this.zoom,0,2*Math.PI),this.ctx.fill())}}drawUI(t){if(this.showInfo){const e=window.devicePixelRatio||1,i=this.canvas.width/e,s=this.canvas.height/e,o=i<600,n=o?13:16,r=n+4,a=Math.min(300,i-20),l=20+5*r+60*t.players.length;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,10,a,l),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${n}px Doto`;let h=30;this.ctx.fillText("SoL - Speed of Light RTS",20,h),h+=r,this.ctx.fillText(`Game Time: ${t.gameTime.toFixed(1)}s`,20,h),h+=r,this.ctx.fillText(`Dust Particles: ${t.spaceDust.length}`,20,h),h+=r,this.ctx.fillText(`Asteroids: ${t.asteroids.length}`,20,h),h+=r,this.ctx.fillText(`Warp Gates: ${t.warpGates.length}`,20,h);let c=h+r;for(const e of t.players){const t=this.getFactionColor(e.faction);if(this.ctx.fillStyle=t,this.ctx.fillText(`${e.name} (${e.faction})`,20,c),this.ctx.fillStyle="#FFFFFF",this.ctx.fillText(`Energy: ${e.energy.toFixed(1)}`,20,c+20),e.stellarForge){const t=e.stellarForge.isReceivingLight?" Light":" No Light";this.ctx.fillText(`${t} | HP: ${e.stellarForge.health.toFixed(0)}`,20,c+40)}c+=60}const d=o?ul.CONTROL_LINES_COMPACT:ul.CONTROL_LINES_FULL,g=o?12:14,u=g+4,p=Math.min(450,i-20),x=u*d.length+14,y=10,m=s-x-10;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(y,m,p,x),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${g}px Doto`;let f=m+u;for(const t of d)this.ctx.fillText(t,20,f),f+=u}}drawSelectionRectangle(){if(!this.selectionStart||!this.selectionEnd)return;const t=Math.min(this.selectionStart.x,this.selectionEnd.x),e=Math.min(this.selectionStart.y,this.selectionEnd.y),i=Math.abs(this.selectionEnd.x-this.selectionStart.x),s=Math.abs(this.selectionEnd.y-this.selectionStart.y);this.ctx.strokeStyle="rgba(0, 255, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="rgba(0, 255, 0, 0.1)",this.ctx.fillRect(t,e,i,s),this.ctx.setLineDash([])}drawAbilityArrow(){if(this.abilityArrowEnd&&0!==this.abilityArrowStarts.length){this.ctx.strokeStyle="rgba(255, 215, 0, 0.9)",this.ctx.lineWidth=4,this.ctx.setLineDash([]);for(const t of this.abilityArrowStarts){const e=this.abilityArrowEnd.x-t.x,i=this.abilityArrowEnd.y-t.y;if(Math.sqrt(e*e+i*i)<Qs)continue;this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(this.abilityArrowEnd.x,this.abilityArrowEnd.y),this.ctx.stroke();const s=Math.atan2(i,e),o=20,n=Math.PI/6;this.ctx.beginPath(),this.ctx.moveTo(this.abilityArrowEnd.x,this.abilityArrowEnd.y),this.ctx.lineTo(this.abilityArrowEnd.x-o*Math.cos(s-n),this.abilityArrowEnd.y-o*Math.sin(s-n)),this.ctx.lineTo(this.abilityArrowEnd.x-o*Math.cos(s+n),this.abilityArrowEnd.y-o*Math.sin(s+n)),this.ctx.closePath(),this.ctx.fillStyle="rgba(255, 215, 0, 0.9)",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,8,0,2*Math.PI),this.ctx.fillStyle="rgba(255, 215, 0, 0.5)",this.ctx.fill()}}}drawBuildingAbilityArrow(){if(!this.buildingAbilityArrowEnd||!this.buildingAbilityArrowStart)return;const t=this.buildingAbilityArrowEnd.x-this.buildingAbilityArrowStart.x,e=this.buildingAbilityArrowEnd.y-this.buildingAbilityArrowStart.y;if(Math.sqrt(t*t+e*e)<Qs)return;this.ctx.strokeStyle="rgba(0, 255, 136, 0.9)",this.ctx.lineWidth=4,this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(this.buildingAbilityArrowStart.x,this.buildingAbilityArrowStart.y),this.ctx.lineTo(this.buildingAbilityArrowEnd.x,this.buildingAbilityArrowEnd.y),this.ctx.stroke();const i=Math.atan2(e,t),s=Math.PI/6;this.ctx.beginPath(),this.ctx.moveTo(this.buildingAbilityArrowEnd.x,this.buildingAbilityArrowEnd.y),this.ctx.lineTo(this.buildingAbilityArrowEnd.x-20*Math.cos(i-s),this.buildingAbilityArrowEnd.y-20*Math.sin(i-s)),this.ctx.lineTo(this.buildingAbilityArrowEnd.x-20*Math.cos(i+s),this.buildingAbilityArrowEnd.y-20*Math.sin(i+s)),this.ctx.closePath(),this.ctx.fillStyle="rgba(0, 255, 136, 0.9)",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(this.buildingAbilityArrowStart.x,this.buildingAbilityArrowStart.y,8,0,2*Math.PI),this.ctx.fillStyle="rgba(0, 255, 136, 0.5)",this.ctx.fill()}drawUnitPathPreview(){if(!this.pathPreviewForge&&this.pathPreviewPoints.length>0){let t=0,e=0,s=0;if(this.selectedUnits.size>0)for(const i of this.selectedUnits)t+=i.position.x,e+=i.position.y,s++;else if(this.selectedMirrors.size>0)for(const i of this.selectedMirrors)t+=i.position.x,e+=i.position.y,s++;if(s>0){const o=new i(t/s,e/s);this.drawMinionPathPreview(o,this.pathPreviewPoints,this.pathPreviewEnd)}}}drawMinionPathPreview(t,e,i){this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=3,this.ctx.setLineDash([6,6]),this.ctx.beginPath();const s=this.worldToScreen(t);this.ctx.moveTo(s.x,s.y);for(let t=0;t<e.length;t++){const i=this.worldToScreen(e[t]);this.ctx.lineTo(i.x,i.y)}if(i){const t=this.worldToScreen(i);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(255, 255, 0, 0.9)";for(let t=0;t<e.length;t++){const i=this.worldToScreen(e[t]);this.ctx.beginPath(),this.ctx.arc(i.x,i.y,4,0,2*Math.PI),this.ctx.fill()}if(i){const t=this.worldToScreen(i);this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,6,0,2*Math.PI),this.ctx.stroke()}}createTapEffect(t,e){this.tapEffects.push({position:new i(t,e),progress:0})}createSwipeEffect(t,e,s,o){this.swipeEffects.push({start:new i(t,e),end:new i(s,o),progress:0})}createWarpGateShockwave(t){this.warpGateShockwaves.push({position:new i(t.x,t.y),progress:0})}createProductionButtonWave(t){this.productionButtonWaves.push({position:new i(t.x,t.y),progress:0})}updateAndDrawTapEffects(){for(let t=this.tapEffects.length-1;t>=0;t--){const e=this.tapEffects[t];if(e.progress+=Zs,e.progress>=1){this.tapEffects.splice(t,1);continue}const i=to*e.progress,s=1-e.progress;this.ctx.strokeStyle=`rgba(100, 200, 255, ${s})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,i,0,2*Math.PI),this.ctx.stroke();const o=this.ctx.createRadialGradient(e.position.x,e.position.y,0,e.position.x,e.position.y,.5*i);o.addColorStop(0,`rgba(100, 200, 255, ${.5*s})`),o.addColorStop(1,"rgba(100, 200, 255, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,.5*i,0,2*Math.PI),this.ctx.fill()}}updateAndDrawSwipeEffects(){for(let t=this.swipeEffects.length-1;t>=0;t--){const e=this.swipeEffects[t];if(e.progress+=eo,e.progress>=1){this.swipeEffects.splice(t,1);continue}const i=e.end.x-e.start.x,s=e.end.y-e.start.y,o=Math.sqrt(i*i+s*s);if(o<5)continue;const n=1-e.progress,r=o*e.progress;this.ctx.strokeStyle=`rgba(255, 200, 100, ${.7*n})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(e.start.x,e.start.y);const a=e.start.x+i/o*r,l=e.start.y+s/o*r;if(this.ctx.lineTo(a,l),this.ctx.stroke(),e.progress>.3){const t=Math.atan2(s,i);this.ctx.fillStyle=`rgba(255, 200, 100, ${n})`,this.ctx.beginPath(),this.ctx.moveTo(a,l),this.ctx.lineTo(a-oo*Math.cos(t-Math.PI/6),l-oo*Math.sin(t-Math.PI/6)),this.ctx.lineTo(a-oo*Math.cos(t+Math.PI/6),l-oo*Math.sin(t+Math.PI/6)),this.ctx.closePath(),this.ctx.fill()}for(let t=0;t<5;t++){const a=t/5,l=e.start.x+i/o*r*a,h=e.start.y+s/o*r*a,c=n*(1-a)*.3,d=this.ctx.createRadialGradient(l,h,0,l,h,10);d.addColorStop(0,`rgba(255, 200, 100, ${c})`),d.addColorStop(1,"rgba(255, 200, 100, 0)"),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(l,h,10,0,2*Math.PI),this.ctx.fill()}}}updateAndDrawWarpGateShockwaves(){for(let t=this.warpGateShockwaves.length-1;t>=0;t--){const e=this.warpGateShockwaves[t];if(e.progress+=T,e.progress>=1){this.warpGateShockwaves.splice(t,1);continue}const i=this.worldToScreen(e.position),s=A*e.progress*this.zoom,o=.8*(1-e.progress);this.ctx.strokeStyle=`rgba(0, 255, 255, ${o})`,this.ctx.lineWidth=Math.max(2,3*this.zoom),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.stroke()}}updateAndDrawProductionButtonWaves(){for(let t=this.productionButtonWaves.length-1;t>=0;t--){const e=this.productionButtonWaves[t];if(e.progress+=so,e.progress>=1){this.productionButtonWaves.splice(t,1);continue}const i=this.worldToScreen(e.position),s=io*e.progress*this.zoom,o=.9*(1-e.progress);this.ctx.strokeStyle=`rgba(255, 215, 0, ${o})`,this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,s);n.addColorStop(0,`rgba(255, 215, 0, ${.35*o})`),n.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,.6*s,0,2*Math.PI),this.ctx.fill()}}drawDamageNumbers(t){for(const e of t.damageNumbers){const i=this.worldToScreen(e.position),s=e.getOpacity(t.gameTime),o="remaining-life"===this.damageDisplayMode?e.remainingHealth:e.damage,n=e.damage/e.maxHealth,r=Math.max(8,Math.min(24,8+80*n));if(this.ctx.font=`bold ${r}px Doto`,"remaining-life"===this.damageDisplayMode){const t=e.remainingHealth/e.maxHealth,i=this.getHealthColor(t);this.ctx.fillStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${s})`}else this.ctx.fillStyle=`rgba(255, 100, 100, ${s})`;this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeStyle=`rgba(0, 0, 0, ${.8*s})`,this.ctx.lineWidth=2,this.ctx.strokeText(o.toString(),i.x,i.y),this.ctx.fillText(o.toString(),i.x,i.y)}}getHealthColor(t){if(t>.6){const e=(t-.6)/.4;return{r:Math.round(255*(1-e)),g:255,b:0}}if(t>.3){const e=(t-.3)/.3;return{r:255,g:Math.round(165+90*e),b:0}}{const e=t/.3;return{r:Math.round(180+75*e),g:Math.round(165*e),b:0}}}drawHealthDisplay(t,e,i,s,o,n=!1,r){if(e>=i)return;const a=e/i;if("bar"===this.healthDisplayMode){const e=3*s,i=3,l=t.x-e/2,h=t.y+o;if(this.ctx.fillStyle="#333",this.ctx.fillRect(l,h,e,i),this.ctx.fillStyle=a>.5?"#00FF00":a>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(l,h,e*a,i),n){const t=8,s=l+e+5,o=h+i/2;this.ctx.strokeStyle=r||"#00FF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(s-t/2,o),this.ctx.lineTo(s+t/2,o),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(s,o-t/2),this.ctx.lineTo(s,o+t/2),this.ctx.stroke()}}else{const i=this.getHealthColor(a),l=Math.max(10,1.5*s);if(this.ctx.font=`bold ${l}px Doto`,this.ctx.fillStyle=`rgb(${i.r}, ${i.g}, ${i.b})`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeText(Math.round(e).toString(),t.x,t.y+o),this.ctx.fillText(Math.round(e).toString(),t.x,t.y+o),n){const e=.6*l,i=t.x+.8*l,s=t.y+o-l/2;this.ctx.strokeStyle=r||"#00FF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i-e/2,s),this.ctx.lineTo(i+e/2,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(i,s-e/2),this.ctx.lineTo(i,s+e/2),this.ctx.stroke()}}}render(t){this.ctx.fillStyle=this.colorScheme.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.updateViewBounds();const e=t.suns.find(t=>"lad"===t.type);if(e&&this.drawLadSunRays(t,e),!e)for(const t of this.starLayers){this.ctx.fillStyle="#FFFFFF";const e=window.devicePixelRatio||1;for(const i of t.stars){const s=this.parallaxCamera.x*t.parallaxFactor,o=this.parallaxCamera.y*t.parallaxFactor,n=this.canvas.width/e/2,r=this.canvas.height/e/2,a=n+(i.x-s),l=r+(i.y-o),h=(a+n)%(2*n+Lt)-n,c=(l+r)%(2*r+Lt)-r;h>=-100&&h<=this.canvas.width/e+100&&c>=-100&&c<=this.canvas.height/e+100&&(this.ctx.globalAlpha=i.brightness,this.ctx.fillRect(h,c,i.size,i.size))}this.ctx.globalAlpha=1}const i=this.viewingPlayer?t.players.indexOf(this.viewingPlayer):null;for(const e of t.spaceDust)this.isWithinRenderBounds(e.position,t.mapSize,10)&&this.isWithinViewBounds(e.position,60)&&this.drawSpaceDust(e,t,i);for(const e of t.suns)this.isWithinViewBounds(e.position,2*e.radius)&&this.drawSun(e);e||this.drawSunRays(t);for(const e of t.suns)this.drawLensFlare(e);for(const e of t.asteroids)this.isWithinRenderBounds(e.position,t.mapSize,e.size)&&this.isWithinViewBounds(e.position,2*e.size)&&this.drawAsteroid(e);const s=[];for(let e=0;e<t.players.length;e++){const o=t.players[e];if((null===i||e===i)&&o.stellarForge&&!o.isDefeated()){const t=0===e?this.playerColor:this.enemyColor;s.push({position:o.stellarForge.position,radius:n,color:t})}}const o=new Map;for(const t of s)o.has(t.color)||o.set(t.color,[]),o.get(t.color).push({position:t.position,radius:t.radius});for(const[t,e]of o)if(1===e.length)this.isWithinViewBounds(e[0].position,e[0].radius)&&this.drawInfluenceCircle(e[0].position,e[0].radius,t);else{this.ctx.save(),this.ctx.beginPath();for(const t of e){if(!this.isWithinViewBounds(t.position,t.radius))continue;const e=this.worldToScreen(t.position),i=t.radius*this.zoom;this.ctx.moveTo(e.x+i,e.y),this.ctx.arc(e.x,e.y,i,0,2*Math.PI)}this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle=t,this.ctx.globalAlpha=.05,this.ctx.fill(),this.ctx.globalAlpha=.3,this.ctx.strokeStyle=t,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}for(const e of t.players)e.isDefeated()||this.drawConnections(e,t.suns,t.asteroids,t.players);for(const i of t.players){if(i.isDefeated())continue;const s=this.getLadPlayerColor(i,e,t),o=null!==this.viewingPlayer&&i!==this.viewingPlayer;for(const e of i.solarMirrors)this.isWithinViewBounds(e.position,120)&&this.drawSolarMirror(e,s,t,o,t.gameTime);i.stellarForge&&this.isWithinViewBounds(i.stellarForge.position,3*i.stellarForge.radius)&&this.drawStellarForge(i.stellarForge,s,t,o)}for(const i of t.warpGates)this.isWithinViewBounds(i.position,2*y)&&this.drawWarpGate(i,t,e);for(const e of t.starlingMergeGates)this.isWithinViewBounds(e.position,4*Gi)&&this.drawStarlingMergeGate(e);this.updateAndDrawWarpGateShockwaves(),this.drawMergedStarlingRanges(t);for(const i of t.players){if(i.isDefeated())continue;const s=this.getLadPlayerColor(i,e,t),o=null!==this.viewingPlayer&&i!==this.viewingPlayer;for(const e of i.units){const i=e.isHero?120:60;this.isWithinViewBounds(e.position,i)&&(e instanceof ba?this.drawGrave(e,s,t,o):e instanceof ma?this.drawStarling(e,s,t,o):e instanceof Da?this.drawRay(e,s,t,o):e instanceof qa?this.drawNova(e,s,t,o):e instanceof Oa?this.drawInfluenceBall(e,s,t,o):e instanceof ka?this.drawTurretDeployer(e,s,t,o):e instanceof Ua?this.drawDriller(e,s,t,o):e instanceof Ha?this.drawDagger(e,s,t,o):e instanceof Wa?this.drawBeam(e,s,t,o):e instanceof $a?this.drawSpotlight(e,s,t,o):e instanceof za?this.drawMortar(e,s,t,o):e instanceof Xa?this.drawPreist(e,s,t,o):e instanceof Ka?this.drawTank(e,s,t,o):this.drawUnit(e,s,t,o))}}this.drawStarlingMoveLines(t);for(const i of t.players){if(i.isDefeated())continue;const s=this.getLadPlayerColor(i,e,t),o=null!==this.viewingPlayer&&i!==this.viewingPlayer;for(const e of i.buildings)this.isWithinViewBounds(e.position,2*e.radius)&&(e instanceof da||e instanceof ga?this.drawMinigun(e,s,t,o):e instanceof ua?this.drawSpaceDustSwirler(e,s,t,o):e instanceof pa&&this.drawSubsidiaryFactory(e,s,t,o))}for(const e of t.muzzleFlashes)this.isWithinViewBounds(e.position,80)&&this.drawMuzzleFlash(e);for(const e of t.bulletCasings)this.isWithinViewBounds(e.position,60)&&this.drawBulletCasing(e);for(const e of t.bouncingBullets)this.isWithinViewBounds(e.position,60)&&this.drawBouncingBullet(e);for(const e of t.abilityBullets)this.isWithinViewBounds(e.position,80)&&this.drawAbilityBullet(e);for(const e of t.minionProjectiles)this.isWithinViewBounds(e.position,80)&&this.drawMinionProjectile(e);for(const e of t.mortarProjectiles)this.isWithinViewBounds(e.position,100)&&this.drawMortarProjectile(e);for(const e of t.laserBeams)(this.isWithinViewBounds(e.startPos,200)||this.isWithinViewBounds(e.endPos,200))&&this.drawLaserBeam(e);if("high"===this.graphicsQuality)for(const e of t.impactParticles)this.isWithinViewBounds(e.position,120)&&this.drawImpactParticle(e);for(const e of t.sparkleParticles)this.isWithinViewBounds(e.position,50)&&this.drawSparkleParticle(e);for(const e of t.deathParticles)this.isWithinViewBounds(e.position,100)&&this.drawDeathParticle(e);for(const e of t.influenceZones)this.isWithinViewBounds(e.position,e.radius)&&this.drawInfluenceZone(e);for(const e of t.influenceBallProjectiles)this.isWithinViewBounds(e.position,100)&&this.drawInfluenceBallProjectile(e);for(const e of t.crescentWaves)this.isWithinViewBounds(e.position,2*rr)&&this.drawCrescentWave(e);for(const e of t.novaBombs)this.isWithinViewBounds(e.position,100)&&this.drawNovaBomb(e);for(const e of t.novaScatterBullets)this.isWithinViewBounds(e.position,100)&&this.drawNovaScatterBullet(e);for(const e of t.stickyBombs)this.isWithinViewBounds(e.position,100)&&this.drawStickyBomb(e);for(const e of t.stickyLasers)this.isWithinViewBounds(e.startPosition,600)&&this.drawStickyLaser(e);for(const e of t.disintegrationParticles)this.isWithinViewBounds(e.position,50)&&this.drawDisintegrationParticle(e);for(const e of t.deployedTurrets)this.isWithinViewBounds(e.position,2*Oo)&&this.drawDeployedTurret(e,t);this.drawDamageNumbers(t),this.drawBorderFade(t.mapSize),this.drawMirrorCommandButtons(this.selectedMirrors),this.drawUI(t),this.drawSelectionRectangle(),this.drawAbilityArrow(),this.drawBuildingAbilityArrow(),this.drawUnitPathPreview(),this.updateAndDrawProductionButtonWaves(),this.updateAndDrawTapEffects(),this.updateAndDrawSwipeEffects();const r=t.checkVictoryConditions();if(r&&this.drawEndGameStatsScreen(t,r),t.isCountdownActive){this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFD700",this.ctx.font="bold 120px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const e=Math.ceil(t.countdownTime),i=e>0?e.toString():"Go!";this.ctx.fillText(i,this.canvas.width/2,this.canvas.height/2),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}t.isCountdownActive||r||this.drawMenuButton(),t.isCountdownActive||r||this.drawProductionProgress(t),this.showInGameMenu&&!r&&this.drawInGameMenuOverlay()}drawMenuButton(){window.devicePixelRatio;this.ctx.fillStyle="rgba(50, 50, 50, 0.8)",this.ctx.fillRect(10,10,50,50),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(10,10,50,50),this.ctx.fillStyle="#FFFFFF";this.ctx.fillRect(20,22.5,30,3),this.ctx.fillRect(20,33.5,30,3),this.ctx.fillRect(20,44.5,30,3)}drawProductionProgress(t){var e;const i=window.devicePixelRatio||1,s=200,o=60,n=this.canvas.width/i-s-10;let r=10;const a=t.players.find(t=>!t.isAi);if(!a)return;if(a.stellarForge){const t=a.stellarForge,e=t.incomingLightPerSec;this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(n,r,s,30),this.ctx.strokeStyle=t.isReceivingLight?"#00FF00":"#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,s,30);const i=this.getSolEnergyIcon(),o=22,l=n+4,h=r+4;i.complete&&i.naturalWidth>0&&this.ctx.drawImage(i,l,h,o,o),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(`${e.toFixed(1)}/s`,n+8+o+4,r+15),r+=35}const l=a.units.filter(t=>t instanceof ma).length,h=a.stellarForge,c=null!==(e=null==h?void 0:h.pendingEnergy)&&void 0!==e?e:0,d=(null==h?void 0:h.isReceivingLight)?c+h.incomingLightPerSec*Math.max(0,h.crunchTimer):c,g=Math.floor(d/Ke);this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(n,r,s,30),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,s,30),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="middle";const u=h?` (+${g})`:"";if(this.ctx.fillText(`Starlings: ${l}${u}`,n+8,r+15),r+=38,a.stellarForge&&a.stellarForge.heroProductionUnitType){const t=a.stellarForge;this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(n,r,s,o),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,s,o),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const e=this.getProductionDisplayName(t.heroProductionUnitType);this.ctx.fillText(e,n+8,r+8);const i=t.heroProductionDurationSec>0?1-t.heroProductionRemainingSec/t.heroProductionDurationSec:0;this.drawProgressBar(n+8,r+32,184,16,i),r+=68}const p=a.buildings.find(t=>t instanceof pa);if(null==p?void 0:p.currentProduction){this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(n,r,s,o),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,s,o),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const t=this.getProductionDisplayName(p.currentProduction);this.ctx.fillText(`Foundry ${t}`,n+8,r+8),this.drawProgressBar(n+8,r+32,184,16,p.productionProgress),r+=68}const x=a.buildings.find(t=>!t.isComplete);if(x){this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(n,r,s,o),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,s,o),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const t=this.getBuildingDisplayName(x);this.ctx.fillText(`Building ${t}`,n+8,r+8),this.drawProgressBar(n+8,r+32,184,16,x.buildProgress)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawProgressBar(t,e,i,s,o){this.ctx.fillStyle="rgba(100, 100, 100, 0.8)",this.ctx.fillRect(t,e,i,s),this.ctx.fillStyle="#4CAF50",this.ctx.fillRect(t,e,i*o,s),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=1,this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`${Math.floor(100*o)}%`,t+i/2,e+s/2)}getBuildingDisplayName(t){return t instanceof ga?"Gatling Tower":t instanceof da?"Cannon":t instanceof ua?"Cyclone":t instanceof pa?"Foundry":"Building"}getProductionDisplayName(t){return{marine:"Marine",grave:"Grave",ray:"Ray",influenceball:"Influence Ball",turretdeployer:"Turret Deployer",driller:"Driller",dagger:"Dagger",beam:"Beam",spotlight:"Spotlight","solar-mirror":"Solar Mirror","strafe-upgrade":"Strafe Upgrade","regen-upgrade":"Regen Upgrade"}[t.toLowerCase()]||t}getInGameMenuLayout(){return function(t,e){const i=window.devicePixelRatio||1,s=t/i,o=e/i,n=s<600,r=Math.min(480,s-40),a=Math.min(460,o-40),l=(s-r)/2,h=(o-a)/2,c=n?14:20,d=h+(n?34:42),g=n?30:34,u=(r-2*c-24)/3,p=d+(n?16:18),x=l+c,y=[{tab:"main",x,y:p,width:u,height:g},{tab:"options",x:x+u+12,y:p,width:u,height:g},{tab:"graphics",x:x+2*(u+12),y:p,width:u,height:g}],m=p+g+(n?16:20),f=h+a-(n?16:20),S=Math.min(300,r-2*c);return{screenWidth:s,screenHeight:o,panelX:l,panelY:h,panelWidth:r,panelHeight:a,isCompactLayout:n,titleY:d,tabs:y,contentTopY:m,contentBottomY:f,buttonWidth:S,buttonHeight:n?44:50,buttonX:l+(r-S)/2,buttonSpacing:n?14:20,graphicsListX:l+c,graphicsListY:m,graphicsListWidth:r-2*c,graphicsListHeight:Math.max(0,f-m),graphicsRowHeight:n?44:48,graphicsButtonWidth:n?54:60,graphicsButtonHeight:n?26:30,graphicsButtonGap:8}}(this.canvas.width,this.canvas.height)}getGraphicsMenuMaxScroll(t){return function(t,e){const i=t*e.graphicsRowHeight;return Math.max(0,i-e.graphicsListHeight)}(this.graphicsOptions.length,t)}handleInGameMenuScroll(t,e,i){if(!this.showInGameMenu||"graphics"!==this.inGameMenuTab)return!1;const s=this.getInGameMenuLayout();if(!(t>=s.graphicsListX&&t<=s.graphicsListX+s.graphicsListWidth&&e>=s.graphicsListY&&e<=s.graphicsListY+s.graphicsListHeight))return!1;const o=this.getGraphicsMenuMaxScroll(s);return 0===o||(this.graphicsMenuScrollOffset=Math.min(o,Math.max(0,this.graphicsMenuScrollOffset+i))),!0}getInGameMenuAction(t,e){if(!this.showInGameMenu)return null;const i=this.getInGameMenuLayout();for(const s of i.tabs)if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return{type:"tab",tab:s.tab};if("main"===this.inGameMenuTab){let s=i.contentTopY;const o=[{action:{type:"resume"}},{action:{type:"toggleInfo"}},{action:{type:"surrender"}}];for(const n of o){if(t>=i.buttonX&&t<=i.buttonX+i.buttonWidth&&e>=s&&e<=s+i.buttonHeight)return n.action;s+=i.buttonHeight+i.buttonSpacing}return null}if("options"===this.inGameMenuTab){let s=i.contentTopY;const o=i.buttonHeight,n=i.buttonSpacing,r=i.buttonX,a=i.buttonWidth,l=.35*a,h=10,c=r+a-2*l-h,d=r+a-l;if(e>=s&&e<=s+o){if(t>=c&&t<=c+l)return{type:"damageDisplayMode",mode:"damage"};if(t>=d&&t<=d+l)return{type:"damageDisplayMode",mode:"remaining-life"}}s+=o+n;const g=r+a-2*l-h,u=r+a-l;if(e>=s&&e<=s+o){if(t>=g&&t<=g+l)return{type:"healthDisplayMode",mode:"bar"};if(t>=u&&t<=u+l)return{type:"healthDisplayMode",mode:"number"}}s+=o+n;const p=r+a-2*l-h,x=r+a-l;if(e>=s&&e<=s+o){if(t>=p&&t<=p+l)return{type:"fancyGraphics",isEnabled:!0};if(t>=x&&t<=x+l)return{type:"fancyGraphics",isEnabled:!1}}return null}if(!(t>=i.graphicsListX&&t<=i.graphicsListX+i.graphicsListWidth&&e>=i.graphicsListY&&e<=i.graphicsListY+i.graphicsListHeight))return null;const s=this.graphicsOptions.length*i.graphicsRowHeight,o=e-i.graphicsListY+this.graphicsMenuScrollOffset;if(o<0||o>s)return null;const n=Math.floor(o/i.graphicsRowHeight),r=this.graphicsOptions[n];if(!r)return null;const a=3*i.graphicsButtonWidth+2*i.graphicsButtonGap,l=i.graphicsListX+i.graphicsListWidth-a-8,h=i.graphicsListY+n*i.graphicsRowHeight-this.graphicsMenuScrollOffset+(i.graphicsRowHeight-i.graphicsButtonHeight)/2,c=["svg","png","stub"];for(let s=0;s<c.length;s+=1){const o=l+s*(i.graphicsButtonWidth+i.graphicsButtonGap);if(t>=o&&t<=o+i.graphicsButtonWidth&&e>=h&&e<=h+i.graphicsButtonHeight)return{type:"graphicsVariant",key:r.key,variant:c[s]}}return null}drawInGameMenuOverlay(){const t=this.getInGameMenuLayout(),e=t.screenWidth,i=t.screenHeight,s=t.isCompactLayout;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(0,0,e,i);const o=t.panelWidth,n=t.panelHeight,r=t.panelX,a=t.panelY;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(r,a,o,n),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(r,a,o,n),this.ctx.fillStyle="#FFD700",this.ctx.font=`bold ${s?22:30}px Doto`,this.ctx.textAlign="center",this.ctx.fillText("GAME MENU",e/2,t.titleY);for(const e of t.tabs){const t=this.inGameMenuTab===e.tab;this.ctx.fillStyle=t?"rgba(255, 215, 0, 0.3)":"rgba(60, 60, 60, 0.9)",this.ctx.fillRect(e.x,e.y,e.width,e.height),this.ctx.strokeStyle=t?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(e.x,e.y,e.width,e.height),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto";const i="main"===e.tab?"Main":"options"===e.tab?"Options":"Graphics";this.ctx.fillText(i,e.x+e.width/2,e.y+.68*e.height)}if("main"===this.inGameMenuTab){let i=t.contentTopY;const o=t.buttonWidth,n=t.buttonHeight,r=t.buttonX,a=t.buttonSpacing,l=(t,i)=>{this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(r,i,o,n),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(r,i,o,n),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?18:20)+"px Doto",this.ctx.fillText(t,e/2,i+.65*n)};l("Resume",i),i+=n+a,l(this.showInfo?"Hide Info":"Show Info",i),i+=n+a,l("Surrender",i)}else if("options"===this.inGameMenuTab){let e=t.contentTopY;const i=t.buttonHeight,o=t.buttonSpacing,n=t.buttonX,r=t.buttonWidth;this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Damage Display:",n,e+.4*i);const a={button1X:n+r-.35*r*2-10,button2X:n+r-.35*r,buttonWidth:.35*r},l="damage"===this.damageDisplayMode;this.ctx.fillStyle=l?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(a.button1X,e,a.buttonWidth,i),this.ctx.strokeStyle=l?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(a.button1X,e,a.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Dmg #",a.button1X+a.buttonWidth/2,e+.65*i);const h="remaining-life"===this.damageDisplayMode;this.ctx.fillStyle=h?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(a.button2X,e,a.buttonWidth,i),this.ctx.strokeStyle=h?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(a.button2X,e,a.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("HP Left",a.button2X+a.buttonWidth/2,e+.65*i),e+=i+o,this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Health Display:",n,e+.4*i);const c={button1X:n+r-.35*r*2-10,button2X:n+r-.35*r,buttonWidth:.35*r},d="bar"===this.healthDisplayMode;this.ctx.fillStyle=d?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c.button1X,e,c.buttonWidth,i),this.ctx.strokeStyle=d?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c.button1X,e,c.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Bar",c.button1X+c.buttonWidth/2,e+.65*i);const g="number"===this.healthDisplayMode;this.ctx.fillStyle=g?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c.button2X,e,c.buttonWidth,i),this.ctx.strokeStyle=g?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c.button2X,e,c.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Number",c.button2X+c.buttonWidth/2,e+.65*i),e+=i+o,this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Fancy Graphics:",n,e+.4*i);const u={button1X:n+r-.35*r*2-10,button2X:n+r-.35*r,buttonWidth:.35*r},p=this.isFancyGraphicsEnabled;this.ctx.fillStyle=p?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(u.button1X,e,u.buttonWidth,i),this.ctx.strokeStyle=p?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(u.button1X,e,u.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("On",u.button1X+u.buttonWidth/2,e+.65*i);const x=!this.isFancyGraphicsEnabled;this.ctx.fillStyle=x?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(u.button2X,e,u.buttonWidth,i),this.ctx.strokeStyle=x?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(u.button2X,e,u.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Off",u.button2X+u.buttonWidth/2,e+.65*i)}else{const e=this.getGraphicsMenuMaxScroll(t);this.graphicsMenuScrollOffset>e&&(this.graphicsMenuScrollOffset=e),this.ctx.fillStyle="rgba(20, 20, 20, 0.85)",this.ctx.fillRect(t.graphicsListX,t.graphicsListY,t.graphicsListWidth,t.graphicsListHeight),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(t.graphicsListX,t.graphicsListY,t.graphicsListWidth,t.graphicsListHeight),this.ctx.clip();const i=t.graphicsListX+8,o=3*t.graphicsButtonWidth+2*t.graphicsButtonGap,n=t.graphicsListX+t.graphicsListWidth-o-8,r=[{variant:"svg",label:"SVG"},{variant:"png",label:"PNG"},{variant:"stub",label:"Stub"}];for(let e=0;e<this.graphicsOptions.length;e+=1){const o=this.graphicsOptions[e],a=t.graphicsListY+e*t.graphicsRowHeight-this.graphicsMenuScrollOffset;if(a+t.graphicsRowHeight<t.graphicsListY||a>t.graphicsListY+t.graphicsListHeight)continue;this.ctx.fillStyle=e%2==0?"rgba(40, 40, 40, 0.6)":"rgba(55, 55, 55, 0.6)",this.ctx.fillRect(t.graphicsListX,a,t.graphicsListWidth,t.graphicsRowHeight),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?13:15)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText(o.label,i,a+.65*t.graphicsRowHeight);const l=this.getGraphicVariant(o.key),h=a+(t.graphicsRowHeight-t.graphicsButtonHeight)/2;for(let e=0;e<r.length;e+=1){const i=r[e],a=n+e*(t.graphicsButtonWidth+t.graphicsButtonGap),c=l===i.variant,d="stub"===i.variant||"svg"===i.variant&&o.svgPath||"png"===i.variant&&o.pngPath;this.ctx.fillStyle=c?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",d||(this.ctx.fillStyle="rgba(50, 50, 50, 0.5)"),this.ctx.fillRect(a,h,t.graphicsButtonWidth,t.graphicsButtonHeight),this.ctx.strokeStyle=c?"#FFD700":"#FFFFFF",this.ctx.lineWidth=1.5,this.ctx.strokeRect(a,h,t.graphicsButtonWidth,t.graphicsButtonHeight),this.ctx.fillStyle=d?"#FFFFFF":"#888888",this.ctx.font=(s?11:12)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText(i.label,a+t.graphicsButtonWidth/2,h+.68*t.graphicsButtonHeight)}}this.ctx.restore()}this.ctx.textAlign="left"}drawEndGameStatsScreen(t,e){const i=window.devicePixelRatio||1,s=this.canvas.width/i,o=this.canvas.height/i,n=s<700;this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.fillRect(0,0,s,o),this.ctx.fillStyle=this.getFactionColor(e.faction);const r=Math.max(28,Math.min(48,.12*s));this.ctx.font=`bold ${r}px Doto`,this.ctx.textAlign="center",this.ctx.fillText(`${e.name} WINS!`,s/2,80);const a=Math.min(700,s-40),l=Math.min(450,o-200),h=(s-a)/2;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(h,130,a,l),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(h,130,a,l),this.ctx.fillStyle="#FFD700";const c=Math.max(18,Math.min(28,.07*s));this.ctx.font=`bold ${c}px Doto`,this.ctx.fillText("MATCH STATISTICS",s/2,180);const d=Math.max(14,Math.min(20,.045*s));this.ctx.font=`${d}px Doto`;let g=230;const u=Math.max(100,Math.min(200,.4*a)),p=t.players.length,x=a-48-u,y=Math.max(50,x/p),m=h+24,f=m+u;this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText("Statistic",m,g),this.ctx.textAlign="right";for(let e=0;e<t.players.length;e++){const i=t.players[e],s=this.getFactionColor(i.faction);this.ctx.fillStyle=s;const o=f+y*(e+1);this.ctx.fillText(i.name,o,g)}g+=n?32:40;const S=[{label:"Units Created",key:"unitsCreated"},{label:"Units Lost",key:"unitsLost"},{label:"Energy Gathered",key:"energyGathered"}];for(const e of S){this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText(e.label,m,g),this.ctx.textAlign="right";for(let i=0;i<t.players.length;i++){const s=t.players[i],o="energyGathered"===e.key?Math.round(s[e.key]):s[e.key],n=f+y*(i+1);this.ctx.fillText(String(o),n,g)}g+=n?28:35}const A=Math.min(300,s-60),T=n?50:60,E=(s-A)/2,_=Math.min(130+l+30,o-T-20);this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(E,_,A,T),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(E,_,A,T),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`bold ${n?20:24}px Doto`,this.ctx.textAlign="center",this.ctx.fillText("Continue",s/2,_+.65*T),this.ctx.textAlign="left"}drawBorderFade(t){const e=window.devicePixelRatio||1,s=this.canvas.width/e,o=this.canvas.height/e,n=150,r=t/2,a=this.worldToScreen(new i(-r,-r)),l=this.worldToScreen(new i(r,-r)),h=this.worldToScreen(new i(-r,r)),c=this.worldToScreen(new i(-r+n,0)),d=(this.worldToScreen(new i(r-n,0)),this.worldToScreen(new i(0,-r+n))),g=(this.worldToScreen(new i(0,r-n)),Math.abs(c.x-a.x)),u=Math.abs(d.y-a.y);if(this.ctx.save(),a.x<s){const t=this.ctx.createLinearGradient(a.x,0,a.x+g,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,a.x+g,o)}if(l.x>0){const t=this.ctx.createLinearGradient(l.x,0,l.x-g,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(l.x-g,0,s-(l.x-g),o)}if(a.y<o){const t=this.ctx.createLinearGradient(0,a.y,0,a.y+u);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,s,a.y+u)}if(h.y>0){const t=this.ctx.createLinearGradient(0,h.y,0,h.y-u);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,h.y-u,s,o-(h.y-u))}this.ctx.restore()}setZoom(t){const e=this.getMinZoomForBounds();this.zoom=Math.max(e,Math.min(2,t));const s=this.clampCameraToLevelBounds(this.camera);this.camera=new i(s.x,s.y),this.parallaxCamera=new i(s.x,s.y)}setCameraPosition(t){const e=this.clampCameraToLevelBounds(t);this.camera=new i(e.x,e.y),this.parallaxCamera=new i(e.x,e.y)}setCameraPositionWithoutParallax(t){const e=this.clampCameraToLevelBounds(t);this.camera=new i(e.x,e.y)}clampCameraToLevelBounds(t){const e=window.devicePixelRatio||1,s=this.canvas.width/e/this.zoom,o=this.canvas.height/e/this.zoom,n=Wt/2,r=n-s/2,a=n-o/2,l=-r,h=-a,c=Math.max(l,Math.min(r,t.x)),d=Math.max(h,Math.min(a,t.y));return new i(c,d)}getMinZoomForBounds(){const t=window.devicePixelRatio||1,e=this.canvas.width/t,i=this.canvas.height/t,s=e/Wt,o=i/Wt;return Math.max(.5,s,o)}interpolateHexColor(t,e,i){const s=Number.parseInt(t.replace("#",""),16),o=Number.parseInt(e.replace("#",""),16),n=s>>16&255,r=s>>8&255,a=255&s,l=o>>16&255,h=o>>8&255,c=255&o;return`#${(Math.round(n+(l-n)*i)<<16|Math.round(r+(h-r)*i)<<8|Math.round(a+(c-a)*i)).toString(16).padStart(6,"0")}`}}ul.CONTROL_LINES_FULL=["Controls: Drag to select units","Pan: WASD/Arrows or mouse edge or two-finger drag","Zoom: Scroll/Pinch (zooms toward cursor)","Hold still 6 seconds in influence to open warp gate"],ul.CONTROL_LINES_COMPACT=["Controls: Drag to select units","Pan: WASD/Arrows or two-finger drag","Zoom: Scroll/Pinch toward cursor","Hold still 6s in influence to open warp gate"];class pl{hasHeroUnitsSelected(){if(0===this.selectedUnits.size)return!1;for(const t of this.selectedUnits)if(t.isHero)return!0;return!1}getSelectedStarlings(t){const e=[];for(const i of this.selectedUnits)i instanceof ma&&i.owner===t&&e.push(i);return e}tryStartStarlingMerge(t,e,i){if(!this.game)return!1;if(e.length<Bi)return!1;if(!t.buildings.some(t=>t instanceof pa))return!1;const s=e.slice(0,Bi).map(t=>this.game.getUnitNetworkId(t));this.game.applyStarlingMerge(t,s,i),this.sendNetworkCommand("starling_merge",{unitIds:s,targetX:i.x,targetY:i.y});for(const t of this.selectedUnits)t.isSelected=!1;return this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits,!0}getClosestSelectedStarling(t){let e=null,i=1/0;for(const s of this.selectedUnits){if(!(s instanceof ma))continue;const o=s.position.x-t.x,n=s.position.y-t.y,r=o*o+n*n;r<=Wi*Wi&&r<i&&(i=r,e=s)}return e}updateAbilityArrowStarts(){this.abilityArrowStarts.length=0,this.selectionStartScreen&&this.abilityArrowStarts.push(this.selectionStartScreen);for(const t of this.selectedUnits)t.isHero&&this.abilityArrowStarts.push(this.renderer.worldToScreen(t.position));this.renderer.abilityArrowStarts=this.abilityArrowStarts}isDragStartNearSelectedUnits(t){if(0===this.selectedUnits.size)return!1;for(const e of this.selectedUnits)if(e.position.distanceTo(t)<=Os)return!0;return!1}isDragStartNearSelectedMirrors(t){if(0===this.selectedMirrors.size)return!1;for(const e of this.selectedMirrors)if(e.containsPoint(t))return!0;return!1}getHeroUnitType(t){switch(t){case"Marine":case"Grave":case"Ray":case"Dagger":case"Beam":case"Driller":case"Nova":return t;case"Influence Ball":return"InfluenceBall";case"Turret Deployer":return"TurretDeployer";default:return null}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof wa;case"Grave":return t instanceof ba;case"Ray":return t instanceof Da;case"InfluenceBall":return t instanceof Oa;case"TurretDeployer":return t instanceof ka;case"Driller":return t instanceof Ua;case"Dagger":return t instanceof Ha;case"Beam":return t instanceof Wa;case"Nova":return t instanceof qa;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}getClosestSelectedMirror(t,e){let i=null,s=-1,o=1/0;for(let n=0;n<t.solarMirrors.length;n++){const r=t.solarMirrors[n];if(!r.isSelected)continue;const a=r.position.x-e.x,l=r.position.y-e.y,h=a*a+l*l;h<o&&(o=h,i=r,s=n)}return{mirror:i,mirrorIndex:s}}getTargetableStructureAtPosition(t,e){if(!this.game)return null;for(let i=0;i<this.game.players.length;i++){const s=this.game.players[i];if(s&&s!==e){if(s.stellarForge&&s.stellarForge.containsPoint(t))return{target:s.stellarForge,targetPlayerIndex:i,structureType:"forge",structureIndex:-1};for(let e=0;e<s.solarMirrors.length;e++){const o=s.solarMirrors[e];if(o.containsPoint(t))return{target:o,targetPlayerIndex:i,structureType:"mirror",structureIndex:e}}for(let e=0;e<s.buildings.length;e++){const o=s.buildings[e];if(o.containsPoint(t))return{target:o,targetPlayerIndex:i,structureType:"building",structureIndex:e}}}}return null}getTargetStructureRadiusPx(t){return t instanceof Qr?ks:t.radius}handleFoundryButtonPress(t,e,i){if(!this.game)return;const s=t.buildings.indexOf(e);s<0?console.error("Foundry not found in player buildings array"):0===i?e.canQueueStrafeUpgrade()&&t.spendEnergy(Li)?(e.enqueueProduction(Di),console.log("Queued foundry Strafe upgrade"),this.sendNetworkCommand("foundry_strafe_upgrade",{buildingId:s}),e.isSelected=!1,this.selectedBuildings.clear()):console.log("Cannot queue Strafe upgrade or not enough energy"):1===i&&(e.canQueueRegenUpgrade()&&t.spendEnergy(Fi)?(e.enqueueProduction(vi),console.log("Queued foundry Regen upgrade"),this.sendNetworkCommand("foundry_regen_upgrade",{buildingId:s}),e.isSelected=!1,this.selectedBuildings.clear()):console.log("Cannot queue Regen upgrade or not enough energy"))}isDoubleTap(t,e){const s=Date.now();return s-this.lastTapTime>this.DOUBLE_TAP_THRESHOLD_MS?(this.lastTapTime=s,this.lastTapPosition=new i(t,e),!1):this.lastTapPosition&&Math.pow(t-this.lastTapPosition.x,2)+Math.pow(e-this.lastTapPosition.y,2)<=this.DOUBLE_TAP_POSITION_THRESHOLD*this.DOUBLE_TAP_POSITION_THRESHOLD?(this.lastTapTime=0,this.lastTapPosition=null,!0):(this.lastTapTime=s,this.lastTapPosition=new i(t,e),!1)}clearWarpGateSelection(){this.selectedWarpGate=null,this.renderer.selectedWarpGate=null,this.renderer.highlightedButtonIndex=-1}getWarpGateAtPosition(t,e){if(!this.game)return null;for(const i of this.game.warpGates)if(i.isComplete&&i.owner===e&&i.position.distanceTo(t)<=y)return i;return null}getWarpGateButtonIndexFromClick(t,e,i){const s=this.renderer.worldToScreen(t.position),o=y*this.renderer.zoom,n=m*this.renderer.zoom,r=o+f*this.renderer.zoom,a=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];for(let t=0;t<a.length;t++){const o=a[t],l=e-(s.x+o.x*r),h=i-(s.y+o.y*r);if(Math.sqrt(l*l+h*h)<=n)return t}return-1}getWarpGateButtonDirection(t){var e;return null!==(e=[new i(0,-1),new i(1,0),new i(0,1),new i(-1,0)][t])&&void 0!==e?e:null}getWarpGateButtonWorldPosition(t,e){const s=this.getWarpGateButtonDirection(e);if(!s)return null;const o=y+f;return new i(t.position.x+s.x*o,t.position.y+s.y*o)}buildFromWarpGate(t,e,s){if(!e.isComplete||e.owner!==t)return;const o=new i(e.position.x,e.position.y),n=t.buildings.some(t=>t instanceof pa);if(0===s){if(n)return void console.log("Only one Foundry can exist at a time");if(!t.spendEnergy(Ri))return void console.log("Not enough energy to build Foundry");const i=new pa(o,t);t.buildings.push(i),console.log(`Foundry building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"SubsidiaryFactory",positionX:e.position.x,positionY:e.position.y})}else if(1===s){if(!t.spendEnergy(Ii))return void console.log("Not enough energy to build Cannon");const i=new da(o,t);t.buildings.push(i),console.log(`Cannon building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"Minigun",positionX:e.position.x,positionY:e.position.y})}else if(2===s){if(!t.spendEnergy(Ci))return void console.log("Not enough energy to build Gatling Tower");const i=new ga(o,t);t.buildings.push(i),console.log(`Gatling Tower building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"Gatling",positionX:e.position.x,positionY:e.position.y})}else{if(3!==s)return;{if(!t.spendEnergy(Mi))return void console.log("Not enough energy to build Cyclone");const i=new ua(o,t);t.buildings.push(i),console.log(`Cyclone building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"SpaceDustSwirler",positionX:e.position.x,positionY:e.position.y})}}this.scatterParticles(e.position),this.removeWarpGate(e)}removeWarpGate(t){if(!this.game)return;const e=this.game.warpGates.indexOf(t);e>-1&&this.game.warpGates.splice(e,1),this.currentWarpGate===t&&(this.currentWarpGate=null),this.selectedWarpGate===t&&this.clearWarpGateSelection(),this.implodeParticles(t.position)}clearAllSelections(){const t=this.getLocalPlayer();if(t){this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.selectedBuildings.clear(),this.clearWarpGateSelection(),t.stellarForge&&(t.stellarForge.isSelected=!1);for(const e of t.solarMirrors)e.isSelected=!1;for(const e of t.buildings)e.isSelected=!1;this.renderer.selectedUnits=this.selectedUnits,this.renderer.selectedMirrors=this.selectedMirrors}}selectAllStarlings(){if(!this.game)return;const t=this.getLocalPlayer();if(t){this.clearAllSelections();for(const e of t.units)e instanceof ma&&this.selectedUnits.add(e);this.renderer.selectedUnits=this.selectedUnits,console.log(`Double-tap: Selected all ${this.selectedUnits.size} starlings`)}}selectAllBuildingsOfType(t){if(!this.game)return;const e=this.getLocalPlayer();if(!e)return;this.clearAllSelections();const i=t.constructor;for(const t of e.buildings)t.constructor===i&&(t.isSelected=!0,this.selectedBuildings.add(t));console.log(`Double-tap: Selected all ${this.selectedBuildings.size} buildings of type ${i.name}`)}getClickedHeroButton(t,e,i,s){const o=this.renderer.worldToScreen(i.position),n=rs*this.renderer.zoom,r=as*this.renderer.zoom,a=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],l=s.slice(0,a.length);for(let i=0;i<l.length;i++){const s=a[i],h=o.x+s.x*r,c=o.y+s.y*r,d=t-h,g=e-c;if(Math.sqrt(d*d+g*g)<=n){const t=this.renderer.screenToWorld(h,c);return{heroName:l[i],buttonPos:t}}}return null}getClickedBlinkUpgradeButton(t,e,i){const s=this.renderer.worldToScreen(i.position),o=ls*this.renderer.zoom,n=hs*this.renderer.zoom,r=s.x,a=s.y+n,l=t-r,h=e-a;return Math.sqrt(l*l+h*h)<=o?this.renderer.screenToWorld(r,a):null}getNearestButtonIndexFromAngle(t,e){if(4===e){let e=(t%(2*Math.PI)+2*Math.PI)%(2*Math.PI);return e+=Math.PI/2,e>=2*Math.PI&&(e-=2*Math.PI),Math.floor((e+Math.PI/4)/(Math.PI/2))%4}if(2===e){const e=Math.atan2(Math.sin(t),Math.cos(t));return e<-Math.PI/2||e>Math.PI/2?0:1}if(3===e){const e=Math.atan2(Math.sin(t),Math.cos(t)),i=[Math.PI,-Math.PI/2,0];let s=0,o=1/0;for(let t=0;t<i.length;t++){const n=Math.atan2(Math.sin(e-i[t]),Math.cos(e-i[t])),r=Math.abs(n);r<o&&(o=r,s=t)}return s}return 1===e?0:-1}getNearestMirrorButtonIndexFromCursor(t,e,i){let s=null;for(const t of this.selectedMirrors){s=t;break}if(!s)return-1;const o=this.renderer.worldToScreen(s.position),n=Math.atan2(e-o.y,t-o.x),r=50*this.renderer.zoom,a=Math.atan2(0,-r),l=Math.atan2(-r,0),h=Math.atan2(0,r);let c=0,d=1/0;const g=Math.atan2(Math.sin(n-a),Math.cos(n-a)),u=Math.abs(g);u<d&&(d=u,c=0);const p=Math.atan2(Math.sin(n-l),Math.cos(n-l)),x=Math.abs(p);if(x<d&&(d=x,c=1),i){const t=Math.atan2(Math.sin(n-h),Math.cos(n-h)),e=Math.abs(t);e<d&&(d=e,c=2)}return c}clearPathPreview(){this.pathPoints=[],this.isDrawingPath=!1,this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=null}toggleInGameMenu(){this.showInGameMenu=!this.showInGameMenu,this.isPaused=this.showInGameMenu,this.renderer.showInGameMenu=this.showInGameMenu,this.renderer.isPaused=this.isPaused}toggleInfo(){this.showInfo=!this.showInfo,this.renderer.showInfo=this.showInfo}getLocalPlayer(){var t;return this.game&&null!==(t=this.game.players[this.localPlayerIndex])&&void 0!==t?t:null}sendNetworkCommand(t,e){this.game&&this.game.networkManager&&this.game.sendGameCommand(t,e)}surrender(){if(!this.game)return;const t=this.getLocalPlayer();t&&(t.stellarForge&&(t.stellarForge.health=0),this.showInGameMenu=!1,this.isPaused=!1,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,console.log("Player surrendered"))}returnToMainMenu(){this.stop(),this.game=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.selectedBuildings.clear(),this.clearWarpGateSelection(),this.renderer.selectedUnits=this.selectedUnits,this.renderer.selectedMirrors=this.selectedMirrors,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,this.renderer.showInfo=this.showInfo,this.menu.show()}constructor(){this.game=null,this.lastTime=0,this.isRunning=!1,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=!1,this.holdStartTime=null,this.holdStarlingForMerge=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.mirrorCommandMode=null,this.shouldSkipMoveOrderThisTap=!1,this.hasSeenFoundry=!1,this.hasActiveFoundry=!1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedBase=null,this.selectedBuildings=new Set,this.selectedWarpGate=null,this.isSelecting=!1,this.selectionStartScreen=null,this.isDraggingHeroArrow=!1,this.isDraggingBuildingArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.moveOrderCounter=0,this.localPlayerIndex=0,this.lastTapTime=0,this.lastTapPosition=null,this.DOUBLE_TAP_THRESHOLD_MS=300,this.DOUBLE_TAP_POSITION_THRESHOLD=30,this.abilityArrowStarts=[];const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element not found");this.renderer=new ul(t),this.menu=new hl,this.menu.onStart(t=>this.startNewGame(t)),this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.setupInputHandlers(t)}startNewGame(t){this.game=this.createGameFromSettings(t),this.renderer.selectedHeroNames=t.selectedHeroNames,this.renderer.playerColor=t.playerColor,this.renderer.enemyColor=t.enemyColor;const e=rl[t.colorScheme];if(e&&(this.renderer.colorScheme=e),this.renderer.damageDisplayMode=t.damageDisplayMode,this.renderer.healthDisplayMode=t.healthDisplayMode,this.game.damageDisplayMode=t.damageDisplayMode,this.renderer.graphicsQuality=t.graphicsQuality,this.localPlayerIndex=0,"lan"===t.gameMode&&t.networkManager){const e=t.networkManager.isLobbyHost(),i=e?0:1;this.localPlayerIndex=i,this.game.players[0]&&(this.game.players[0].isAi=!1),this.game.players[1]&&(this.game.players[1].isAi=!1),this.game.setupNetworkManager(t.networkManager,i),console.log(`LAN mode: Local player is Player ${i+1} (${e?"Host":"Client"})`)}const i=this.getLocalPlayer();i&&(this.renderer.viewingPlayer=i,i.stellarForge&&(this.renderer.setCameraPosition(i.stellarForge.position),this.renderer.setZoom(.5))),this.showInfo=t.isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.start()}createGameFromSettings(t){var e,s,n;const r=null!==(e=t.selectedFaction)&&void 0!==e?e:Jr.RADIANT,a=Jr.RADIANT,l=rl[t.colorScheme],h=function(t,e){const s=new Ra;s.suns.push(new o(new i(0,0),1,100));const n=new i(-700,700),r=new i(700,-700),a=Math.random()<.5?[n,r]:[r,n];for(let e=0;e<t.length&&!(e>=a.length);e++){const[o,n]=t[e],r=new xa(o,n);if(r.isAi=0!==e,r.isAi){const t=[qr.ECONOMIC,qr.DEFENSIVE,qr.AGGRESSIVE,qr.WAVES];r.aiStrategy=t[Math.floor(Math.random()*t.length)]}const l=a[e],h=Yt,c=[new i(l.x-h,l.y),new i(l.x+h,l.y)];s.initializePlayer(r,l,c),s.players.push(r)}if(s.players.length>=2)for(let t=0;t<s.players.length;t++){const e=s.players[t],i=(t+1)%s.players.length,o=s.players[i];e.stellarForge&&o.stellarForge&&e.stellarForge.initializeDefaultPath(o.stellarForge.position)}s.initializeSpaceDust(z,2e3,2e3,e),s.initializeAsteroids(10,2e3,2e3);const l=-Math.PI/4,h=new i(Math.cos(l)*Gt,Math.sin(l)*Gt);s.asteroids.push(new Ca(h,6,kt));const c=3*Math.PI/4,d=new i(Math.cos(c)*Gt,Math.sin(c)*Gt);return s.asteroids.push(new Ca(d,6,kt)),s.isRunning=!0,s}([["Player 1",r],["Player 2",a]],null==l?void 0:l.spaceDustPalette),c=t.selectedMap;if(h.mapSize=c.mapSize,h.suns=[],"twin-suns"===c.id?(h.suns.push(new o(new i(-300,-300),1,100)),h.suns.push(new o(new i(300,300),1,100))):"test-level"===c.id?h.suns.push(new o(new i(0,0),1,100)):"lad"===c.id?h.suns.push(new o(new i(0,0),1,100,"lad")):h.suns.push(new o(new i(0,0),1,100)),"test-level"===c.id){const t=new i(-700,0),e=new i(700,0),o=Yt,r=[new i(t.x,t.y-o),new i(t.x,t.y+o)],a=[t,e],l=[r,[new i(e.x,e.y-o),new i(e.x,e.y+o)]];for(let e=0;e<h.players.length;e++){const i=h.players[e],o=null!==(s=a[e])&&void 0!==s?s:t,c=null!==(n=l[e])&&void 0!==n?n:r;i.stellarForge=null,i.solarMirrors=[],h.initializePlayer(i,o,c)}if(h.players.length>=2){const t=h.players[0],e=h.players[1];t.stellarForge&&e.stellarForge&&(t.stellarForge.initializeDefaultPath(e.stellarForge.position),e.stellarForge.initializeDefaultPath(t.stellarForge.position))}return h.asteroids=[],h.spaceDust=[],h}const d=h.asteroids.slice(-2);h.asteroids=[],h.initializeAsteroids(c.numAsteroids,c.mapSize,c.mapSize),"standard"===c.id&&h.asteroids.push(...d),h.spaceDust=[];const g="test-level"===c.id?3e3:z;return h.initializeSpaceDust(g,c.mapSize,c.mapSize,null==l?void 0:l.spaceDustPalette),h}setupInputHandlers(t){const e=(e,i)=>{const s=t.getBoundingClientRect();return{x:e-s.left,y:i-s.top}};let s=!1,o=!1,n=0,r=0,a=0,l=0,h=0;const c=20,d=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window,g=new Set;t.addEventListener("wheel",t=>{if(t.preventDefault(),this.showInGameMenu){const i=e(t.clientX,t.clientY);if(this.renderer.handleInGameMenuScroll(i.x,i.y,t.deltaY))return}const s=e(t.clientX,t.clientY),o=this.renderer.screenToWorld(s.x,s.y),n=t.deltaY>0?.9:1.1,r=this.renderer.zoom;this.renderer.setZoom(r*n);const a=this.renderer.screenToWorld(s.x,s.y),l=this.renderer.camera;this.renderer.setCameraPositionWithoutParallax(new i(l.x+(o.x-a.x),l.y+(o.y-a.y)))});const u=(t,e)=>{n=t,r=e,this.selectionStartScreen=new i(t,e),this.isSelecting=!1;const s=this.renderer.screenToWorld(t,e);this.startHold(s)},p=(t,e,a=!1)=>{var l;if(!o)return n=t,void(r=e);const h=t-n,c=e-r,d=Math.sqrt(h*h+c*c);if(a){s||(s=!0,this.cancelHold(),this.renderer.selectionStart=null,this.renderer.selectionEnd=null);const t=this.renderer.camera;this.renderer.setCameraPosition(new i(t.x-h/this.renderer.zoom,t.y-c/this.renderer.zoom))}else if(d>Ks){const t=this.hasHeroUnitsSelected(),e=this.selectionStartScreen?this.renderer.screenToWorld(this.selectionStartScreen.x,this.selectionStartScreen.y):null;if(!(this.isSelecting||s||this.isDraggingHeroArrow||this.isDraggingBuildingArrow||this.isDrawingPath)){const i=Boolean(this.selectedBase&&this.selectedBase.isSelected&&e&&this.selectedBase.containsPoint(e)),s=Boolean(e&&this.isDragStartNearSelectedMirrors(e)),o=Boolean(this.selectedWarpGate&&e&&e.distanceTo(this.selectedWarpGate.position)<=y);if(i)this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=this.selectedBase,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold();else if(s)this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold();else if(o)this.isDraggingBuildingArrow=!0,this.cancelHold();else if(1===this.selectedBuildings.size){const t=Array.from(this.selectedBuildings)[0];t instanceof pa&&t.isComplete&&(this.isDraggingBuildingArrow=!0,this.cancelHold())}else(this.selectedBase||this.selectedMirrors.size>0||this.selectedWarpGate)&&0===this.selectedUnits.size?(this.isDraggingBuildingArrow=!0,this.cancelHold()):this.selectedUnits.size>0&&this.selectionStartScreen&&e&&this.isDragStartNearSelectedUnits(e)?(this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold()):t?(this.isDraggingHeroArrow=!0,this.cancelHold()):(this.isSelecting=!0,this.cancelHold())}}if(this.isSelecting)this.renderer.selectionStart=this.selectionStartScreen,this.renderer.selectionEnd=new i(t,e);else if(this.isDraggingHeroArrow)this.updateAbilityArrowStarts(),this.renderer.abilityArrowEnd=new i(t,e);else if(this.isDraggingBuildingArrow){const s=this.getLocalPlayer();if(this.selectionStartScreen){this.renderer.buildingAbilityArrowStart=this.selectionStartScreen,this.renderer.buildingAbilityArrowEnd=new i(t,e);const o=t-this.selectionStartScreen.x,n=e-this.selectionStartScreen.y,r=Math.atan2(n,o);s&&s.stellarForge&&s.stellarForge.isSelected?this.renderer.highlightedButtonIndex=this.getNearestButtonIndexFromAngle(r,4):this.selectedMirrors.size>0?this.renderer.highlightedButtonIndex=this.getNearestMirrorButtonIndexFromCursor(t,e,this.hasSeenFoundry):this.selectedWarpGate?this.renderer.highlightedButtonIndex=this.getNearestButtonIndexFromAngle(r,4):1===this.selectedBuildings.size&&Array.from(this.selectedBuildings)[0]instanceof pa&&(this.renderer.highlightedButtonIndex=this.getNearestButtonIndexFromAngle(r,2))}}else if(this.isDrawingPath){const s=this.renderer.screenToWorld(t,e);(0===this.pathPoints.length||this.pathPoints[this.pathPoints.length-1].distanceTo(s)>vs)&&((null===(l=this.game)||void 0===l?void 0:l.checkCollision(s,0))||this.pathPoints.push(new i(s.x,s.y))),this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=new i(s.x,s.y)}n=t,r=e},x=()=>{const t=this.selectionStartScreen&&Math.abs(n-this.selectionStartScreen.x)<Ks&&Math.abs(r-this.selectionStartScreen.y)<Ks;if(t&&this.game){const t=this.game.checkVictoryConditions();if(!t&&!this.game.isCountdownActive&&n<=70&&r<=70)return this.toggleInGameMenu(),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(this.showInGameMenu&&!t){const t=this.renderer.getInGameMenuAction(n,r);if(t){switch(t.type){case"resume":this.toggleInGameMenu();break;case"toggleInfo":this.toggleInfo();break;case"surrender":this.surrender();break;case"tab":this.renderer.setInGameMenuTab(t.tab);break;case"graphicsVariant":this.renderer.setGraphicsVariant(t.key,t.variant);break;case"damageDisplayMode":this.renderer.damageDisplayMode=t.mode,this.game&&(this.game.damageDisplayMode=t.mode);break;case"healthDisplayMode":this.renderer.healthDisplayMode=t.mode;break;case"fancyGraphics":this.renderer.isFancyGraphicsEnabled=t.isEnabled}return s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t){const t=window.devicePixelRatio||1,e=this.renderer.canvas.width/t,i=(this.renderer.canvas.height,300),a=(e-i)/2,l=610;if(n>=a&&n<=a+i&&r>=l&&r<=l+60)return this.returnToMainMenu(),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t&&this.selectionStartScreen&&this.renderer.createTapEffect(n,r),this.game&&t){const t=this.renderer.screenToWorld(n,r),e=this.getLocalPlayer();if(!e)return;if(this.shouldSkipMoveOrderThisTap)return this.shouldSkipMoveOrderThisTap=!1,s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(this.selectedWarpGate){const t=this.getWarpGateButtonIndexFromClick(this.selectedWarpGate,n,r);if(t>=0){const i=this.getWarpGateButtonWorldPosition(this.selectedWarpGate,t);return i&&this.renderer.createProductionButtonWave(i),console.log(`Warp gate button clicked: index ${t} | energy=${e.energy.toFixed(1)}`),this.buildFromWarpGate(e,this.selectedWarpGate,t),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}const i=this.getWarpGateAtPosition(t,e);if(i)return this.selectedWarpGate===i?this.clearWarpGateSelection():(this.clearAllSelections(),this.selectedWarpGate=i,this.renderer.selectedWarpGate=i),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();const a=this.getTargetableStructureAtPosition(t,e);if(this.selectedUnits.size>0&&a){this.moveOrderCounter++;const t=this.getTargetStructureRadiusPx(a.target);for(const e of this.selectedUnits){const i=e.getStructureStandoffPoint(a.target.position,t);e.setManualTarget(a.target,i),e.moveOrder=this.moveOrderCounter}const e=this.game?Array.from(this.selectedUnits).map(t=>this.game.getUnitNetworkId(t)):[];return this.sendNetworkCommand("unit_target_structure",{unitIds:e,targetPlayerIndex:a.targetPlayerIndex,structureType:a.structureType,structureIndex:a.structureIndex,moveOrder:this.moveOrderCounter}),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits,this.clearPathPreview(),console.log("Units targeting structure",a.structureType),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(e.stellarForge&&e.stellarForge.containsPoint(t)){if(this.clearWarpGateSelection(),this.selectedMirrors.size>0){for(const t of this.selectedMirrors)t.setLinkedStructure(e.stellarForge),t.isSelected=!1;const t=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0);this.sendNetworkCommand("mirror_link",{mirrorIndices:t,structureType:"forge"}),this.selectedMirrors.clear()}if(e.stellarForge.isSelected)e.stellarForge.isSelected=!1,this.selectedBase=null,this.clearPathPreview(),console.log("Stellar Forge deselected");else{e.stellarForge.isSelected=!0,this.selectedBase=e.stellarForge,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t.isSelected=!1;for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear(),this.clearPathPreview(),console.log("Stellar Forge selected")}return s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let l=null;for(const i of e.solarMirrors)if(i.containsPoint(t)){l=i;break}if(l){if(this.clearWarpGateSelection(),l.isSelected)l.isSelected=!1,this.selectedMirrors.delete(l),this.clearPathPreview(),console.log("Solar Mirror deselected");else{l.isSelected=!0,this.selectedMirrors.clear(),this.selectedMirrors.add(l),e.stellarForge&&(e.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t!==l&&(t.isSelected=!1);for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear(),this.clearPathPreview(),console.log("Solar Mirror selected")}return s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let h=null;for(const i of e.buildings)if(i.containsPoint(t)){h=i;break}if(h){if(this.clearWarpGateSelection(),(h instanceof da||h instanceof ga||h instanceof ua||h instanceof pa)&&this.selectedMirrors.size>0){for(const t of this.selectedMirrors)t.setLinkedStructure(h),t.isSelected=!1;const t=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0),i=e.buildings.indexOf(h);i>=0&&this.sendNetworkCommand("mirror_link",{mirrorIndices:t,structureType:"building",buildingIndex:i}),this.selectedMirrors.clear()}if(this.isDoubleTap(n,r))this.selectAllBuildingsOfType(h);else if(h.isSelected)h.isSelected=!1,this.selectedBuildings.delete(h),console.log("Building deselected");else{h.isSelected=!0,this.selectedBuildings.clear(),this.selectedBuildings.add(h),e.stellarForge&&(e.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t.isSelected=!1;this.selectedMirrors.clear(),this.clearPathPreview(),console.log("Building selected")}return s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(this.selectedMirrors.size>0){const t=Array.from(this.selectedMirrors)[0],i=this.renderer.worldToScreen(t.position),a=m*this.renderer.zoom,l=50*this.renderer.zoom,h=this.hasSeenFoundry,c=i.x,d=i.y-l,g=i.x-l,u=i.y,p=i.x+l,x=i.y;let y=n-g,f=r-u;if(Math.sqrt(y*y+f*f)<=a){if(console.log("Mirror command: Link to Forge"),e.stellarForge){for(const t of this.selectedMirrors)t.setLinkedStructure(e.stellarForge);const t=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0);this.sendNetworkCommand("mirror_link",{mirrorIndices:t,structureType:"forge"}),console.log("Mirrors linked to forge")}for(const t of this.selectedMirrors)t.isSelected=!1;return this.selectedMirrors.clear(),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,void(this.renderer.selectionEnd=null)}if(y=n-c,f=r-d,Math.sqrt(y*y+f*f)<=a)return console.log("Mirror command: Create Warp Gate"),this.mirrorCommandMode="warpgate",s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,void(this.renderer.selectionEnd=null);if(h&&(y=n-p,f=r-x,Math.sqrt(y*y+f*f)<=a)){if(this.hasActiveFoundry){const t=e.buildings.find(t=>t instanceof pa);if(t){for(const e of this.selectedMirrors)e.setLinkedStructure(t);const i=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0),s=e.buildings.indexOf(t);s>=0&&this.sendNetworkCommand("mirror_link",{mirrorIndices:i,structureType:"building",buildingIndex:s}),console.log("Mirrors linked to foundry")}}for(const t of this.selectedMirrors)t.isSelected=!1;return this.selectedMirrors.clear(),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,void(this.renderer.selectionEnd=null)}}if(e.stellarForge&&e.stellarForge.isSelected){const t=this.getClickedBlinkUpgradeButton(n,r,e.stellarForge);if(t)return void(!e.hasBlinkUpgrade&&e.spendEnergy(Ni)?(e.hasBlinkUpgrade=!0,this.renderer.createProductionButtonWave(t),console.log("Purchased Blink upgrade at forge"),this.sendNetworkCommand("forge_blink_upgrade",{})):console.log("Cannot purchase Blink upgrade or not enough energy"))}if(e.stellarForge&&e.stellarForge.isSelected&&this.renderer.selectedHeroNames.length>0){const t=this.getClickedHeroButton(n,r,e.stellarForge,this.renderer.selectedHeroNames);if(t){const i=t.heroName;this.renderer.createProductionButtonWave(t.buttonPos);const n=this.getHeroUnitType(i);let r=!1;if(n){const t=this.isHeroUnitAlive(e,n),s=this.isHeroUnitQueuedOrProducing(e.stellarForge,n);console.log(`Hero button clicked: ${i} | unitType=${n} | alive=${t} | producing=${s} | energy=${e.energy.toFixed(1)}`),t?console.log(`${i} is already active`):s?console.log(`${i} is already being produced`):e.spendEnergy(wi)?(e.stellarForge.enqueueHeroUnit(n),e.stellarForge.startHeroProductionIfIdle(),console.log(`Queued hero ${i} for forging`),r=!0,this.sendNetworkCommand("hero_purchase",{heroType:n})):console.log("Not enough energy to forge hero")}if(r){e.stellarForge.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear(),this.clearPathPreview()}return s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(this.selectedBuildings.size>0){for(const t of this.selectedBuildings)t.isSelected=!1;return this.selectedBuildings.clear(),this.clearPathPreview(),console.log("Buildings deselected"),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(e.stellarForge&&e.stellarForge.isSelected){e.stellarForge.setTarget(t),this.moveOrderCounter++,e.stellarForge.moveOrder=this.moveOrderCounter,this.sendNetworkCommand("forge_move",{targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter}),e.stellarForge.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.buildings)t.isSelected=!1;return this.selectedBuildings.clear(),console.log(`Stellar Forge moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}const{mirror:c,mirrorIndex:d}=this.getClosestSelectedMirror(e,t);if(c&&"warpgate"!==this.mirrorCommandMode){c.setTarget(t),this.moveOrderCounter++,c.moveOrder=this.moveOrderCounter,this.sendNetworkCommand("mirror_move",{mirrorIndices:d>=0?[d]:[],targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter}),c.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear();for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.buildings)t.isSelected=!1;return this.selectedBuildings.clear(),console.log(`Solar Mirror moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),s=!1,o=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(this.isSelecting&&this.selectionStartScreen&&this.game){const t=new i(n,r);this.selectUnitsInRectangle(this.selectionStartScreen,t)}else if(this.isDrawingPath&&this.pathPoints.length>0&&this.game){if(this.selectedBase&&this.selectedBase.isSelected)this.selectedBase.setMinionPath(this.pathPoints),console.log(`Base path set with ${this.pathPoints.length} waypoints`),this.sendNetworkCommand("set_rally_path",{waypoints:this.pathPoints.map(t=>({x:t.x,y:t.y}))});else if(this.selectedMirrors.size>0){const t=this.getLocalPlayer(),e=this.pathPoints[this.pathPoints.length-1];if(t){console.log(`Solar mirror movement path set to (${e.x.toFixed(0)}, ${e.y.toFixed(0)})`),this.moveOrderCounter++;const i=[];for(const s of this.selectedMirrors){s.setTarget(e),s.moveOrder=this.moveOrderCounter,s.isSelected=!1;const o=t.solarMirrors.indexOf(s);o>=0&&i.push(o)}this.sendNetworkCommand("mirror_move",{mirrorIndices:i,targetX:e.x,targetY:e.y,moveOrder:this.moveOrderCounter})}this.selectedMirrors.clear();const i=this.getLocalPlayer();if(i){for(const t of i.buildings)t.isSelected=!1;this.selectedBuildings.clear()}}else if(this.selectedUnits.size>0){console.log(`Unit movement path set with ${this.pathPoints.length} waypoints for ${this.selectedUnits.size} unit(s)`),this.moveOrderCounter++;for(const t of this.selectedUnits)t.clearManualTarget(),t.setPath(this.pathPoints),t.moveOrder=this.moveOrderCounter;const t=this.game?Array.from(this.selectedUnits).map(t=>this.game.getUnitNetworkId(t)):[];this.sendNetworkCommand("unit_path",{unitIds:t,waypoints:this.pathPoints.map(t=>({x:t.x,y:t.y})),moveOrder:this.moveOrderCounter}),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;const e=this.getLocalPlayer();if(e){for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear()}}this.clearPathPreview()}else if(!this.isSelecting&&(this.selectedUnits.size>0||this.selectedMirrors.size>0||this.selectedBase||this.selectedWarpGate)&&this.selectionStartScreen&&this.game){const t=new i(n,r),e=this.selectionStartScreen.distanceTo(t),s=Math.max(Ks,Qs),o=this.hasHeroUnitsSelected();if(this.selectedUnits.size>0&&(!o&&e>=Ks||o&&this.isDraggingHeroArrow&&e>=s)){o||this.renderer.createSwipeEffect(this.selectionStartScreen.x,this.selectionStartScreen.y,t.x,t.y);const e=t.x-this.selectionStartScreen.x,s=t.y-this.selectionStartScreen.y,n=Math.sqrt(e*e+s*s),r=new i(e/n,s/n);let a=!1;if(!o){const t=this.getLocalPlayer();if(t&&r.y<-.5){const e=this.getSelectedStarlings(t);if(e.length>=Bi){const s=e.reduce((t,e)=>t+e.position.x,0)/e.length,o=e.reduce((t,e)=>t+e.position.y,0)/e.length,n=new i(s,o);a=this.tryStartStarlingMerge(t,e,n)}}}if(!a){let t=!1;for(const e of this.selectedUnits)e.useAbility(r)&&(t=!0,this.game&&this.sendNetworkCommand("unit_ability",{unitId:this.game.getUnitNetworkId(e),directionX:r.x,directionY:r.y}));t&&console.log(`Ability activated in direction (${r.x.toFixed(2)}, ${r.y.toFixed(2)})`),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits}}else if(this.isDraggingBuildingArrow&&e>=s){const t=this.getLocalPlayer();if(t&&this.renderer.highlightedButtonIndex>=0)if(t.stellarForge&&t.stellarForge.isSelected&&this.renderer.selectedHeroNames.length>0){const e=this.renderer.selectedHeroNames;if(this.renderer.highlightedButtonIndex<e.length){const i=e[this.renderer.highlightedButtonIndex],s=this.getHeroUnitType(i);if(s){const e=this.isHeroUnitAlive(t,s),o=this.isHeroUnitQueuedOrProducing(t.stellarForge,s);e||o||!t.spendEnergy(wi)||(t.stellarForge.enqueueHeroUnit(s),t.stellarForge.startHeroProductionIfIdle(),console.log(`Radial selection: Queued hero ${i} for forging`),this.sendNetworkCommand("hero_purchase",{heroType:s}),t.stellarForge.isSelected=!1,this.selectedBase=null)}}}else if(this.selectedMirrors.size>0){if(0===this.renderer.highlightedButtonIndex){if(t.stellarForge){for(const e of this.selectedMirrors)e.setLinkedStructure(t.stellarForge);const e=Array.from(this.selectedMirrors).map(e=>t.solarMirrors.indexOf(e)).filter(t=>t>=0);this.sendNetworkCommand("mirror_link",{mirrorIndices:e,structureType:"forge"}),console.log("Radial selection: Mirrors linked to forge")}for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear()}else if(1===this.renderer.highlightedButtonIndex)this.mirrorCommandMode="warpgate",console.log("Radial selection: Mirror command mode set to warpgate");else if(2===this.renderer.highlightedButtonIndex&&this.hasActiveFoundry){const e=t.buildings.find(t=>t instanceof pa);if(e){for(const t of this.selectedMirrors)t.setLinkedStructure(e);const i=Array.from(this.selectedMirrors).map(e=>t.solarMirrors.indexOf(e)).filter(t=>t>=0),s=t.buildings.indexOf(e);s>=0&&this.sendNetworkCommand("mirror_link",{mirrorIndices:i,structureType:"building",buildingIndex:s}),console.log("Radial selection: Mirrors linked to foundry")}for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear()}}else if(this.selectedWarpGate)this.buildFromWarpGate(t,this.selectedWarpGate,this.renderer.highlightedButtonIndex);else if(1===this.selectedBuildings.size){const e=Array.from(this.selectedBuildings)[0];e instanceof pa&&this.handleFoundryButtonPress(t,e,this.renderer.highlightedButtonIndex)}}else if(this.isDraggingHeroArrow&&o);else if(this.shouldSkipMoveOrderThisTap)this.shouldSkipMoveOrderThisTap=!1;else if(this.selectedWarpGate&&0===this.selectedUnits.size&&0===this.selectedMirrors.size&&!this.selectedBase);else{const t=this.renderer.screenToWorld(n,r);this.moveOrderCounter++;for(const e of this.selectedUnits){const s=new i(t.x,t.y);e.clearManualTarget(),e instanceof ma?e.setManualRallyPoint(s):e.rallyPoint=s,e.moveOrder=this.moveOrderCounter}const e=this.game?Array.from(this.selectedUnits).map(t=>this.game.getUnitNetworkId(t)):[];this.sendNetworkCommand("unit_move",{unitIds:e,targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter});const s=this.getLocalPlayer();if(s){const{mirror:e,mirrorIndex:o}=this.getClosestSelectedMirror(s,t);e&&o>=0&&(e.setTarget(new i(t.x,t.y)),e.moveOrder=this.moveOrderCounter,e.isSelected=!1,this.sendNetworkCommand("mirror_move",{mirrorIndices:[o],targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter}))}this.selectedBase&&(this.selectedBase.setTarget(new i(t.x,t.y)),this.selectedBase.moveOrder=this.moveOrderCounter,this.selectedBase.isSelected=!1,this.sendNetworkCommand("forge_move",{targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter})),this.selectedUnits.clear();for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,console.log(`Movement target set at (${t.x.toFixed(0)}, ${t.y.toFixed(0)}) - Move order #${this.moveOrderCounter}`)}}s=!1,o=!1,this.isSelecting=!1,this.isDraggingHeroArrow=!1,this.isDraggingBuildingArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,this.abilityArrowStarts.length=0,this.renderer.abilityArrowStarts=this.abilityArrowStarts,this.renderer.abilityArrowEnd=null,this.renderer.buildingAbilityArrowStart=null,this.renderer.buildingAbilityArrowEnd=null,this.renderer.highlightedButtonIndex=-1,this.endHold()};t.addEventListener("mousedown",t=>{o=!0;const i=e(t.clientX,t.clientY);u(i.x,i.y)}),t.addEventListener("mousemove",t=>{const i=e(t.clientX,t.clientY);a=i.x,l=i.y,p(i.x,i.y,!1)}),t.addEventListener("mouseup",()=>{x()}),t.addEventListener("mouseleave",()=>{x()}),t.addEventListener("touchstart",t=>{if(1===t.touches.length){t.preventDefault(),o=!0;const i=e(t.touches[0].clientX,t.touches[0].clientY);u(i.x,i.y)}else if(2===t.touches.length){t.preventDefault(),o=!0,s=!1;const i=e(t.touches[0].clientX,t.touches[0].clientY),a=e(t.touches[1].clientX,t.touches[1].clientY);n=(i.x+a.x)/2,r=(i.y+a.y)/2;const l=a.x-i.x,c=a.y-i.y;h=Math.sqrt(l*l+c*c),this.cancelHold()}},{passive:!1}),t.addEventListener("touchmove",t=>{if(1===t.touches.length&&o){t.preventDefault();const i=e(t.touches[0].clientX,t.touches[0].clientY);p(i.x,i.y,!1)}else if(2===t.touches.length){t.preventDefault();const s=e(t.touches[0].clientX,t.touches[0].clientY),o=e(t.touches[1].clientX,t.touches[1].clientY),n=(s.x+o.x)/2,r=(s.y+o.y)/2,a=o.x-s.x,l=o.y-s.y,c=Math.sqrt(a*a+l*l);if(Math.abs(c-h)>1){const t=this.renderer.screenToWorld(n,r),e=c/h,s=this.renderer.zoom;this.renderer.setZoom(s*e);const o=this.renderer.screenToWorld(n,r),a=this.renderer.camera;this.renderer.setCameraPositionWithoutParallax(new i(a.x+(t.x-o.x),a.y+(t.y-o.y))),h=c}p(n,r,!0)}},{passive:!1}),t.addEventListener("touchend",t=>{if(1===t.touches.length){const i=e(t.touches[0].clientX,t.touches[0].clientY);n=i.x,r=i.y,a=i.x,l=i.y}else if(t.changedTouches.length>0){const i=e(t.changedTouches[0].clientX,t.changedTouches[0].clientY);n=i.x,r=i.y,a=i.x,l=i.y}0===t.touches.length?(x(),h=0):1===t.touches.length&&(s=!1,h=0)}),t.addEventListener("touchcancel",()=>{x(),h=0}),window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();if("escape"===e&&this.game&&!this.game.isCountdownActive&&!this.game.checkVictoryConditions())return t.preventDefault(),void this.toggleInGameMenu();["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(e)&&(t.preventDefault(),g.add(e))}),window.addEventListener("keyup",t=>{const e=t.key.toLowerCase();g.delete(e)});const f=()=>{if(!this.game)return void requestAnimationFrame(f);const e=g.size>0,n=window.devicePixelRatio||1,r=t.width/n,h=t.height/n,u=!d&&!o&&!s&&(a<c||a>r-c||l<c||l>h-c);if(e||u){const t=this.renderer.camera;let e=0,s=0;(g.has("w")||g.has("arrowup"))&&(s-=10),(g.has("s")||g.has("arrowdown"))&&(s+=10),(g.has("a")||g.has("arrowleft"))&&(e-=10),(g.has("d")||g.has("arrowright"))&&(e+=10),u&&(a<c&&(e-=5),a>r-c&&(e+=5),l<c&&(s-=5),l>h-c&&(s+=5)),0===e&&0===s||this.renderer.setCameraPosition(new i(t.x+e/this.renderer.zoom,t.y+s/this.renderer.zoom))}requestAnimationFrame(f)};f()}startHold(t){if(!this.game)return;const e=this.getLocalPlayer();if(!e)return;if(!e.stellarForge)return;if(this.holdStartTime=null,this.holdStarlingForMerge=null,Array.from(this.selectedBuildings).some(t=>t.canShoot())){for(const i of this.selectedBuildings)if(i.canShoot()){const s=[];for(const t of this.game.players)t!==e&&(s.push(...t.units),s.push(...t.buildings),t.stellarForge&&s.push(t.stellarForge));let o=null,n=1/0;for(const e of s){const i=t.distanceTo(e.position);i<n&&(n=i,o=e)}o&&(i.target=o,console.log(`Building targeting enemy at (${o.position.x.toFixed(0)}, ${o.position.y.toFixed(0)})`))}return}if(this.selectedMirrors.size>0&&"warpgate"===this.mirrorCommandMode){let o=!1;for(const e of this.selectedMirrors){if(!e.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const n=new s(e.position,new i(t.x-e.position.x,t.y-e.position.y).normalize(),1);let r=!0;for(const t of this.game.asteroids)if(n.intersectsPolygon(t.getWorldVertices())){r=!1;break}if(r){o=!0;break}}if(o){const i=new Sa(t,e);i.startCharging(),this.game.warpGates.push(i),this.currentWarpGate=i,this.shouldSkipMoveOrderThisTap=!0;for(const t of this.selectedMirrors)t.setLinkedStructure(i),t.isSelected=!1;this.selectedMirrors.clear(),this.renderer.selectedMirrors=this.selectedMirrors,console.log("Mirror-based warp gate created at",t),this.mirrorCommandMode=null}return}const o=this.getSelectedStarlings(e);if(e.buildings.some(t=>t instanceof pa)&&o.length>=Bi){const e=this.getClosestSelectedStarling(t);e&&(this.holdStartTime=performance.now(),this.holdStarlingForMerge=e)}}selectUnitsInRectangle(t,e){if(!this.game)return;const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y),o=i<js&&s<js&&this.isDoubleTap(e.x,e.y),n=this.renderer.screenToWorld(t.x,t.y),r=this.renderer.screenToWorld(e.x,e.y),a=Math.min(n.x,r.x),l=Math.max(n.x,r.x),h=Math.min(n.y,r.y),c=Math.max(n.y,r.y),d=this.getLocalPlayer();if(d&&!d.isDefeated()){if(o)for(const t of d.units)if(t instanceof ma&&t.position.x>=a&&t.position.x<=l&&t.position.y>=h&&t.position.y<=c)return void this.selectAllStarlings();this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.clearWarpGateSelection();for(const t of d.buildings)t.isSelected=!1;this.selectedBuildings.clear();for(const t of d.units)t.position.x>=a&&t.position.x<=l&&t.position.y>=h&&t.position.y<=c&&this.selectedUnits.add(t);for(const t of d.solarMirrors)t.position.x>=a&&t.position.x<=l&&t.position.y>=h&&t.position.y<=c?(this.selectedMirrors.add(t),t.isSelected=!0):t.isSelected=!1;d.stellarForge&&d.stellarForge.position.x>=a&&d.stellarForge.position.x<=l&&d.stellarForge.position.y>=h&&d.stellarForge.position.y<=c&&0===this.selectedUnits.size?(this.selectedBase=d.stellarForge,d.stellarForge.isSelected=!0):d.stellarForge&&(d.stellarForge.isSelected=!1),this.renderer.selectedUnits=this.selectedUnits,this.renderer.selectedMirrors=this.selectedMirrors,console.log(`Selected ${this.selectedUnits.size} units, ${this.selectedMirrors.size} mirrors, ${this.selectedBase?"1 base":"0 bases"}`)}}cancelHold(){this.holdStartTime=null,this.holdStarlingForMerge=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.mirrorCommandMode=null}endHold(){this.holdStartTime=null,this.holdStarlingForMerge=null,this.isUsingMirrorsForWarpGate=!1,this.mirrorCommandMode=null}updateStarlingMergeHold(){if(!this.game)return;if(!this.holdStartTime||!this.holdStarlingForMerge)return;const t=this.getLocalPlayer();if(!t)return void this.cancelHold();if(!this.selectedUnits.has(this.holdStarlingForMerge))return void this.cancelHold();const e=this.getSelectedStarlings(t);if(e.length<Bi)return void this.cancelHold();if(!t.buildings.some(t=>t instanceof pa))return void this.cancelHold();if(performance.now()-this.holdStartTime<Hi)return;const s=new i(this.holdStarlingForMerge.position.x,this.holdStarlingForMerge.position.y);this.tryStartStarlingMerge(t,e,s)&&(this.shouldSkipMoveOrderThisTap=!0),this.cancelHold()}applyRadialForceToParticles(t,e){if(this.game)for(const s of this.game.spaceDust)if(s.position.distanceTo(t)<P){const o=new i(e?s.position.x-t.x:t.x-s.position.x,e?s.position.y-t.y:t.y-s.position.y).normalize();s.applyForce(new i(o.x*I,o.y*I))}}scatterParticles(t){this.applyRadialForceToParticles(t,!0)}implodeParticles(t){this.applyRadialForceToParticles(t,!1)}unlinkMirrorsFromWarpGate(t){if(this.game)for(const e of this.game.players)for(const i of e.solarMirrors)i.linkedStructure===t&&i.setLinkedStructure(null)}updateFoundryButtonState(){const t=this.getLocalPlayer();if(!t)return this.hasActiveFoundry=!1,this.renderer.hasActiveFoundry=!1,void(this.renderer.hasSeenFoundry=this.hasSeenFoundry);const e=t.buildings.some(t=>t instanceof pa);e&&(this.hasSeenFoundry=!0),this.hasActiveFoundry=e,this.renderer.hasSeenFoundry=this.hasSeenFoundry,this.renderer.hasActiveFoundry=e}update(t){if(this.game&&!this.isPaused){this.updateStarlingMergeHold(),this.game.checkVictoryConditions()&&this.game.isRunning&&(this.game.isRunning=!1),this.game.isRunning&&this.game.update(t);for(let e=this.game.warpGates.length-1;e>=0;e--){const i=this.game.warpGates[e];i.update(t),!i.isComplete&&i.isCharging&&!i.isCancelling&&i.shouldEmitShockwave()&&(this.scatterParticles(i.position),this.renderer.createWarpGateShockwave(i.position)),i.hasDissipated&&(this.unlinkMirrorsFromWarpGate(i),this.scatterParticles(i.position),this.renderer.createWarpGateShockwave(i.position),this.selectedWarpGate===i&&this.clearWarpGateSelection(),this.game.warpGates.splice(e,1))}for(const t of this.game.starlingMergeGateExplosions)this.scatterParticles(t),this.renderer.createWarpGateShockwave(t)}}render(){this.game&&(this.updateFoundryButtonState(),this.renderer.render(this.game))}gameLoop(t){if(!this.isRunning)return;const e=0===this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,this.update(Math.min(e,.1)),this.render(),requestAnimationFrame(t=>this.gameLoop(t))}start(){this.game&&(this.isRunning=!0,this.lastTime=0,requestAnimationFrame(t=>this.gameLoop(t)))}stop(){this.isRunning=!1}}document.addEventListener("DOMContentLoaded",()=>{const t=new pl;window.gameController=t})})();