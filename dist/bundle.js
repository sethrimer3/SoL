(()=>{"use strict";const t=300,e="#0066FF",i="#FF0000",s=.08,o=Math.PI/2,n=4e3,r=[{count:200,parallaxFactor:.1,sizeRange:[.5,1]},{count:150,parallaxFactor:.2,sizeRange:[.8,1.5]},{count:100,parallaxFactor:.35,sizeRange:[1,2]},{count:50,parallaxFactor:.5,sizeRange:[1.5,2.5]}],a=1500,l=.3,h=250,c=150,d=100,g=Math.PI,u=1e3,p=400,x=(Math.PI,150),y=200,f=400,m=.6,S=Math.PI/4,w=1e3,F=10*Math.PI/180,P=10;var C,M;!function(t){t.ECONOMIC="economic",t.DEFENSIVE="defensive",t.AGGRESSIVE="aggressive",t.WAVES="waves"}(C||(C={})),function(t){t.RADIANT="Radiant",t.AURUM="Aurum",t.SOLARI="Solari"}(M||(M={}));class v{constructor(t,e){this.x=t,this.y=e}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}normalize(){const t=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return 0===t?new v(0,0):new v(this.x/t,this.y/t)}}class b{constructor(t,e,i=1){this.origin=t,this.direction=e,this.intensity=i}intersects(t,e){const i=new v(this.origin.x-t.x,this.origin.y-t.y),s=this.direction.x*this.direction.x+this.direction.y*this.direction.y,o=2*(i.x*this.direction.x+i.y*this.direction.y);return o*o-4*s*(i.x*i.x+i.y*i.y-e*e)>=0}intersectsPolygon(t){for(let e=0;e<t.length;e++){const i=t[e],s=t[(e+1)%t.length];if(null!==this.intersectsLineSegment(i,s))return!0}return!1}getIntersectionDistance(t){let e=null;for(let i=0;i<t.length;i++){const s=t[i],o=t[(i+1)%t.length],n=this.intersectsLineSegment(s,o);null!==n&&(null===e||n<e)&&(e=n)}return e}intersectsLineSegment(t,e){const i=new v(e.x-t.x,e.y-t.y),s=new v(t.x-this.origin.x,t.y-this.origin.y),o=this.direction.x*i.y-this.direction.y*i.x;if(Math.abs(o)<1e-4)return null;const n=(s.x*i.y-s.y*i.x)/o,r=(s.x*this.direction.y-s.y*this.direction.x)/o;return n>=0&&r>=0&&r<=1?n:null}}class T{constructor(t,e,i){this.position=t,this.sides=e,this.size=i,this.vertices=[],this.rotation=0,this.generateVertices(),this.rotationSpeed=.5*(Math.random()-.5)}generateVertices(){this.vertices=[];for(let t=0;t<this.sides;t++){const e=2*Math.PI*t/this.sides,i=.8+.4*Math.random(),s=this.size*i;this.vertices.push(new v(Math.cos(e)*s,Math.sin(e)*s))}}getWorldVertices(){return this.vertices.map(t=>{const e=Math.cos(this.rotation),i=Math.sin(this.rotation);return new v(this.position.x+t.x*e-t.y*i,this.position.y+t.x*i+t.y*e)})}update(t){this.rotation+=this.rotationSpeed*t}containsPoint(t){const e=this.getWorldVertices();let i=!1;for(let s=0,o=e.length-1;s<e.length;o=s++){const n=e[s].x,r=e[s].y,a=e[o].x,l=e[o].y;r>t.y!=l>t.y&&t.x<(a-n)*(t.y-r)/(l-r)+n&&(i=!i)}return i}}class A{constructor(t,e){this.position=t,this.owner=e,this.health=d,this.efficiency=1,this.isSelected=!1,this.targetPosition=null,this.velocity=new v(0,0),this.reflectionAngle=0,this.closestSunDistance=1/0,this.moveOrder=0,this.MAX_SPEED=50,this.ACCELERATION=25,this.DECELERATION=50,this.ARRIVAL_THRESHOLD=2,this.SLOW_RADIUS_PX=60,this.AVOIDANCE_BLEND_FACTOR=.6,this.ROTATION_SPEED_RAD_PER_SEC=Math.PI,this.ROTATION_SNAP_THRESHOLD_RAD=.01}isPathClear(t,e=[]){const i=new v(t.x-this.position.x,t.y-this.position.y).normalize(),s=new b(this.position,i),o=this.position.distanceTo(t);for(const t of e){const e=s.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<o)return!1}return!0}isCircleBlockingRay(t,e,i,s){const o=i.x-this.position.x,n=i.y-this.position.y,r=o*t.x+n*t.y;if(r<=0||r>=e)return!1;const a=this.position.x+t.x*r,l=this.position.y+t.y*r,h=i.x-a,c=i.y-l;return h*h+c*c<=s*s}hasLineOfSightToLight(t,e=[]){for(const i of t)if(this.isPathClear(i.position,e))return!0;return!1}hasLineOfSightToForge(t,e=[],i=[]){const s=new v(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),o=this.position.distanceTo(t.position),n=new b(this.position,s);for(const t of e){const e=n.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<o)return!1}for(const e of i){for(const t of e.solarMirrors)if(t!==this&&this.isCircleBlockingRay(s,o,t.position,20))return!1;for(const t of e.buildings)if(this.isCircleBlockingRay(s,o,t.position,t.radius))return!1;if(e.stellarForge&&e.stellarForge!==t&&this.isCircleBlockingRay(s,o,e.stellarForge.position,e.stellarForge.radius))return!1}return!0}getClosestVisibleSun(t,e=[]){let i=null,s=1/0;for(const o of t)if(this.isPathClear(o.position,e)){const t=this.position.distanceTo(o.position);t<s&&(i=o,s=t)}return i}getClosestSun(t){let e=null,i=1/0;for(const s of t){const t=this.position.distanceTo(s.position);t<i&&(e=s,i=t)}return e}generateEnergy(t){return this.getEnergyRatePerSec()*t}getEnergyRatePerSec(){const t=Math.max(1,2-this.closestSunDistance/w);return 10*this.efficiency*t}setTarget(t){this.targetPosition=t}updateReflectionAngle(t,e,i=[],s){if(!t)return;const o=this.getClosestVisibleSun(e,i);if(!o)return void(this.closestSunDistance=1/0);this.closestSunDistance=this.position.distanceTo(o.position);const n=new v(o.position.x-this.position.x,o.position.y-this.position.y).normalize(),r=new v(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),a=n.x+r.x,l=n.y+r.y,h=(Math.sqrt(a*a+l*l)>0?Math.atan2(l,a):Math.atan2(n.y,n.x))+Math.PI/2,c=this.getShortestAngleDelta(this.reflectionAngle,h),d=this.ROTATION_SPEED_RAD_PER_SEC*s;Math.abs(c)<=Math.max(this.ROTATION_SNAP_THRESHOLD_RAD,d)?this.reflectionAngle=h:this.reflectionAngle+=Math.sign(c)*d}getShortestAngleDelta(t,e){let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(t,e=null){if(!this.targetPosition)return;const i=this.targetPosition.x-this.position.x,s=this.targetPosition.y-this.position.y,o=Math.sqrt(i*i+s*s);if(o<this.ARRIVAL_THRESHOLD)return this.position=this.targetPosition,this.targetPosition=null,void(this.velocity=new v(0,0));let n=i/o,r=s/o;if(e){const t=this.calculateObstacleAvoidance(e);if(t){n+=t.x*this.AVOIDANCE_BLEND_FACTOR,r+=t.y*this.AVOIDANCE_BLEND_FACTOR;const e=Math.sqrt(n*n+r*r);e>0&&(n/=e,r/=e)}}if(o<=this.SLOW_RADIUS_PX){const t=Math.max(0,o/this.SLOW_RADIUS_PX),e=this.MAX_SPEED*t;this.velocity.x=n*e,this.velocity.y=r*e}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(o>e*e/(2*this.DECELERATION)&&e<this.MAX_SPEED)this.velocity.x+=n*this.ACCELERATION*t,this.velocity.y+=r*this.ACCELERATION*t;else if(e>.1){const i=this.DECELERATION*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0;const i=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));i>this.MAX_SPEED&&(this.velocity.x=this.velocity.x/i*this.MAX_SPEED,this.velocity.y=this.velocity.y/i*this.MAX_SPEED)}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let e=0,i=0,s=0;const o=60;for(const n of t.suns){const t=this.position.x-n.position.x,r=this.position.y-n.position.y,a=Math.sqrt(t*t+r*r),l=n.radius+30;if(a<l+o){const n=(l+o-a)/o;e+=t/a*n,i+=r/a*n,s++}}for(const n of t.players){for(const t of n.solarMirrors){if(t===this)continue;const n=this.position.x-t.position.x,r=this.position.y-t.position.y,a=Math.sqrt(n*n+r*r),l=40;if(a<l+o&&a>0){const t=(l+o-a)/o;e+=n/a*t,i+=r/a*t,s++}}if(n.stellarForge){const t=n.stellarForge,r=this.position.x-t.position.x,a=this.position.y-t.position.y,l=Math.sqrt(r*r+a*a),h=t.radius+30;if(l<h+o){const t=(h+o-l)/o;e+=r/l*t,i+=a/l*t,s++}}}if(s>0){const t=Math.sqrt(e*e+i*i);if(t>0)return new v(e/t,i/t)}return null}containsPoint(t){return this.position.distanceTo(t)<20}}class D{constructor(t,e){this.position=t,this.owner=e,this.health=1e3,this.isReceivingLight=!1,this.unitQueue=[],this.heroProductionUnitType=null,this.heroProductionRemainingSec=0,this.heroProductionDurationSec=0,this.isSelected=!1,this.targetPosition=null,this.velocity=new v(0,0),this.maxSpeed=50,this.acceleration=30,this.deceleration=50,this.slowRadiusPx=80,this.AVOIDANCE_BLEND_FACTOR=.6,this.radius=40,this.crunchTimer=0,this.currentCrunch=null,this.pendingEnergy=0,this.minionPath=[],this.moveOrder=0,this.rotation=0,this.crunchTimer=10*Math.random()}setMinionPath(t){this.minionPath=t.map(t=>new v(t.x,t.y))}initializeDefaultPath(t){this.minionPath=[new v(t.x,t.y)]}canProduceUnits(){return this.isReceivingLight&&this.health>0}produceUnit(t,e,i){return!(this.health<=0||i<e||(this.unitQueue.push(t),0))}enqueueHeroUnit(t){this.unitQueue.push(t)}startHeroProductionIfIdle(){if(this.heroProductionUnitType||0===this.unitQueue.length)return;const t=this.unitQueue.shift();t&&(this.heroProductionUnitType=t,this.heroProductionDurationSec=8,this.heroProductionRemainingSec=8)}advanceHeroProduction(t){if(this.startHeroProductionIfIdle(),!this.heroProductionUnitType)return null;if(!this.canProduceUnits())return null;if(this.heroProductionRemainingSec=Math.max(0,this.heroProductionRemainingSec-t),this.heroProductionRemainingSec>0)return null;const e=this.heroProductionUnitType;return this.heroProductionUnitType=null,this.heroProductionDurationSec=0,this.heroProductionRemainingSec=0,e}updateLightStatus(t,e,i=[],s=[]){this.isReceivingLight=!1;for(const o of t)if(o.hasLineOfSightToLight(e,i)&&o.hasLineOfSightToForge(this,i,s)){this.isReceivingLight=!0;break}}update(t,e=null){if(this.health>0&&this.isReceivingLight&&(this.crunchTimer-=t),this.currentCrunch&&(this.currentCrunch.update(t),this.currentCrunch.isActive()||(this.currentCrunch=null)),this.targetPosition){const i=this.targetPosition.x-this.position.x,s=this.targetPosition.y-this.position.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(s,2));if(o<5)this.position.x=this.targetPosition.x,this.position.y=this.targetPosition.y,this.velocity.x=0,this.velocity.y=0,this.targetPosition=null;else{let n=i/o,r=s/o;if(e){const t=this.calculateObstacleAvoidance(e);if(t){n+=t.x*this.AVOIDANCE_BLEND_FACTOR,r+=t.y*this.AVOIDANCE_BLEND_FACTOR;const e=Math.sqrt(n*n+r*r);e>0&&(n/=e,r/=e)}}if(o<=this.slowRadiusPx){const t=Math.max(0,o/this.slowRadiusPx),e=this.maxSpeed*t;this.velocity.x=n*e,this.velocity.y=r*e}else{this.velocity.x+=n*this.acceleration*t,this.velocity.y+=r*this.acceleration*t;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));e>this.maxSpeed&&(this.velocity.x=this.velocity.x/e*this.maxSpeed,this.velocity.y=this.velocity.y/e*this.maxSpeed)}}}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>.1){const i=this.deceleration*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let e=0,i=0,s=0;const o=80;for(const n of t.suns){const t=this.position.x-n.position.x,r=this.position.y-n.position.y,a=Math.sqrt(t*t+r*r),l=n.radius+this.radius+10;if(a<l+o){const n=(l+o-a)/o;e+=t/a*n,i+=r/a*n,s++}}for(const n of t.players){if(n.stellarForge&&n.stellarForge!==this){const t=n.stellarForge,r=this.position.x-t.position.x,a=this.position.y-t.position.y,l=Math.sqrt(r*r+a*a),h=this.radius+t.radius+10;if(l<h+o&&l>0){const t=(h+o-l)/o;e+=r/l*t,i+=a/l*t,s++}}for(const t of n.solarMirrors){const n=this.position.x-t.position.x,r=this.position.y-t.position.y,a=Math.sqrt(n*n+r*r),l=this.radius+30;if(a<l+o){const t=(l+o-a)/o;e+=n/a*t,i+=r/a*t,s++}}}if(s>0){const t=Math.sqrt(e*e+i*i);if(t>0)return new v(e/t,i/t)}return null}shouldCrunch(){if(this.crunchTimer<=0&&this.health>0&&this.isReceivingLight){this.crunchTimer=10,this.currentCrunch=new B(new v(this.position.x,this.position.y)),this.currentCrunch.start(),this.rotation+=Math.PI/3,this.rotation>=2*Math.PI&&(this.rotation-=2*Math.PI);const t=this.pendingEnergy;return this.pendingEnergy=0,t}return 0}addPendingEnergy(t){this.pendingEnergy+=t}getCurrentCrunch(){return this.currentCrunch}setTarget(t){this.targetPosition=new v(t.x,t.y)}toggleSelection(){this.isSelected=!this.isSelected}containsPoint(t){return this.position.distanceTo(t)<=this.radius}}class I{constructor(t,e,i,s,o,n,r){this.position=t,this.owner=e,this.radius=s,this.attackRange=o,this.attackDamage=n,this.attackSpeed=r,this.attackCooldown=0,this.target=null,this.buildProgress=0,this.isComplete=!1,this.health=i,this.maxHealth=i}update(t,e,i,s=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.isComplete&&(this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0)&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=this.attackDamage)}takeDamage(t){this.health-=t}isDestroyed(){return this.health<=0}addBuildProgress(t){this.isComplete||(this.buildProgress+=t,this.buildProgress>=1&&(this.buildProgress=1,this.isComplete=!0))}}class E extends I{constructor(t,e){super(t,e,200,30,350,12,6),this.lastShotEffects={}}attack(t){super.attack(t);const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.atan2(i,e);this.lastShotEffects.muzzleFlash=new W(new v(this.position.x,this.position.y),s);const o=s+Math.PI/2+.5*(Math.random()-.5),n=100+50*Math.random();this.lastShotEffects.casing=new _(new v(this.position.x,this.position.y),new v(Math.cos(o)*n,Math.sin(o)*n));const r=s+Math.PI+1*(Math.random()-.5),a=150+100*Math.random();this.lastShotEffects.bouncingBullet=new z(new v(t.position.x,t.position.y),new v(Math.cos(r)*a,Math.sin(r)*a))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}}class R extends I{constructor(t,e){super(t,e,250,35,0,0,0)}applyDustSwirl(t,e){if(this.isComplete)for(const e of t){const t=e.position.x-this.position.x,i=e.position.y-this.position.y,s=Math.sqrt(t*t+i*i);if(s>p||s<1)continue;const o=i/s,n=-t/s,r=80*(1+2.5*(1-s/p));e.velocity.x=o*r,e.velocity.y=n*r}}deflectProjectile(t){if(!this.isComplete)return!1;const e=t.position.x-this.position.x,i=t.position.y-this.position.y;if(Math.sqrt(e*e+i*i)>p)return!1;const s=t.velocity.x,o=t.velocity.y;return t.velocity.x=-o,t.velocity.y=s,!0}}class k extends I{constructor(t,e){super(t,e,500,40,0,0,0),this.productionTimer=0,this.productionQueue=[],this.currentProduction=null,this.productionProgress=0}update(t,e,i){if(this.isComplete&&(!this.currentProduction&&this.productionQueue.length>0&&(this.currentProduction=this.productionQueue.shift()||null,this.productionProgress=0),this.currentProduction)){const e=this.getProductionTime(this.currentProduction);this.productionProgress+=t/e,this.productionProgress>=1&&(this.productionProgress=0,this.currentProduction=null)}}enqueueProduction(t){this.productionQueue.push(t)}getCompletedProduction(){if(this.currentProduction&&this.productionProgress>=1){const t=this.currentProduction;return this.currentProduction=null,this.productionProgress=0,t}return null}getProductionTime(t){return"solar-mirror"===t?5:15}}class L{constructor(t,e=1,i=100){this.position=t,this.intensity=e,this.radius=i,this.voronoiSegments=[],this.initializeVoronoiSegments()}initializeVoronoiSegments(){const t=[],e=.25*this.radius;for(t.push(new v(this.position.x,this.position.y));t.length<80;){let i=!1;for(let s=0;s<30&&!i;s++){const s=Math.random()*Math.PI*2,o=Math.sqrt(Math.random())*this.radius*.9,n=new v(this.position.x+Math.cos(s)*o,this.position.y+Math.sin(s)*o);let r=!1;for(const i of t){const t=n.x-i.x,s=n.y-i.y;if(Math.sqrt(t*t+s*s)<e){r=!0;break}}r||(t.push(n),i=!0)}if(!i&&t.length<80){const e=Math.random()*Math.PI*2,i=Math.sqrt(Math.random())*this.radius*.9;t.push(new v(this.position.x+Math.cos(e)*i,this.position.y+Math.sin(e)*i))}}for(const e of t){const t=this.getWeightedRandomColor();this.voronoiSegments.push({seedPoint:e,startColor:Object.assign({},t),currentColor:Object.assign({},t),targetColor:Object.assign({},t),transitionProgress:1,transitionSpeed:8e-4+.0015*Math.random()})}}getWeightedRandomColor(){const t=Math.random();return t<.25?{r:255,g:220+35*Math.random(),b:100+50*Math.random()}:t<.5?{r:255,g:140+40*Math.random(),b:50+30*Math.random()}:t<.7?{r:220+35*Math.random(),g:50+40*Math.random(),b:30+30*Math.random()}:t<.85?{r:255,g:80+60*Math.random(),b:20+30*Math.random()}:t<.95?{r:150+50*Math.random(),g:20+30*Math.random(),b:10+20*Math.random()}:{r:60+40*Math.random(),g:50+30*Math.random(),b:45+30*Math.random()}}updateVoronoiSegments(t){for(const e of this.voronoiSegments)if(e.transitionProgress+=e.transitionSpeed*t,e.transitionProgress>=1)e.transitionProgress=0,e.startColor=Object.assign({},e.targetColor),e.currentColor=Object.assign({},e.targetColor),e.targetColor=this.getWeightedRandomColor(),e.transitionSpeed=8e-4+.0015*Math.random();else{const t=e.transitionProgress;e.currentColor.r=e.startColor.r+(e.targetColor.r-e.startColor.r)*t,e.currentColor.g=e.startColor.g+(e.targetColor.g-e.startColor.g)*t,e.currentColor.b=e.startColor.b+(e.targetColor.b-e.startColor.b)*t}}emitLight(t){return new b(this.position,t,this.intensity)}}class O{constructor(t,e){this.name=t,this.faction=e,this.energy=100,this.stellarForge=null,this.solarMirrors=[],this.units=[],this.buildings=[],this.isAi=!1,this.aiNextMirrorCommandSec=0,this.aiNextDefenseCommandSec=0,this.aiNextHeroCommandSec=0,this.aiNextStructureCommandSec=0,this.aiNextMirrorPurchaseCommandSec=0,this.aiStrategy=C.ECONOMIC,this.unitsCreated=0,this.unitsLost=0,this.energyGathered=0}isDefeated(){return null===this.stellarForge||this.stellarForge.health<=0}addEnergy(t){this.energy+=t,this.energyGathered+=t}spendEnergy(t){return this.energy>=t&&(this.energy-=t,!0)}}class H{constructor(t,e,i){this.position=t,this.glowState=0,this.glowTransition=0,this.targetGlowState=0,this.lastMovementTime=0,this.baseColor=H.generateBaseColor(i),this.currentColor=this.baseColor,this.velocity=e||new v(2*(Math.random()-.5),2*(Math.random()-.5))}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>5)this.targetGlowState=2,this.lastMovementTime=Date.now();else if(e>1)this.glowState<1&&(this.targetGlowState=1),this.lastMovementTime=Date.now();else{const t=Date.now()-this.lastMovementTime;t>2e3?this.targetGlowState=0:t>1e3&&2===this.glowState&&(this.targetGlowState=1)}const i=this.glowState<this.targetGlowState?3:.5;(this.glowState<this.targetGlowState||this.glowState>this.targetGlowState)&&(this.glowTransition+=t*i,this.glowTransition>=1&&(this.glowState=this.targetGlowState,this.glowTransition=0)),this.velocity.x*=.98,this.velocity.y*=.98;const o=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(o<s)if(0===o)this.velocity.x=s,this.velocity.y=0;else{const t=s/o;this.velocity.x*=t,this.velocity.y*=t}}applyForce(t){this.velocity.x+=t.x,this.velocity.y+=t.y}updateColor(t,e){this.currentColor=t&&e>0?this.blendColors(this.baseColor,t,e):this.baseColor}blendColors(t,e,i){if(!(t&&e&&t.startsWith("#")&&e.startsWith("#")))return this.baseColor;const s=parseInt(t.slice(1),16),o=parseInt(e.slice(1),16);if(isNaN(s)||isNaN(o))return this.baseColor;const n=s>>16&255,r=s>>8&255,a=255&s,l=o>>16&255,h=o>>8&255,c=255&o;return`#${(Math.round(n+(l-n)*i)<<16|Math.round(r+(h-r)*i)<<8|Math.round(a+(c-a)*i)).toString(16).padStart(6,"0")}`}static generateBaseColor(t){if(t&&t.neutral.length>0){const e=Math.random()>.7&&t.accent.length>0?t.accent:t.neutral;return e[Math.floor(Math.random()*e.length)]}const e=85+110*Math.random();let i=e,s=e,o=e;const n=Math.random();n<.18?(i=e-8,s=e-4,o=e+14):n<.28&&(i=e+10,s=e-10,o=e+12);const r=t=>Math.max(0,Math.min(255,Math.round(t)));return`#${(r(i)<<16|r(s)<<8|r(o)).toString(16).padStart(6,"0")}`}}class B{constructor(t){this.position=t,this.phase="idle",this.phaseTimer=0}start(){this.phase="suck",this.phaseTimer=.8}update(t){"idle"!==this.phase&&(this.phaseTimer-=t,this.phaseTimer<=0&&("suck"===this.phase?(this.phase="wave",this.phaseTimer=1.2):"wave"===this.phase&&(this.phase="idle",this.phaseTimer=0)))}isActive(){return"idle"!==this.phase}getPhaseProgress(){if("idle"===this.phase)return 0;const t="suck"===this.phase?.8:1.2;return 1-this.phaseTimer/t}}class _{constructor(t,e){this.position=t,this.rotation=0,this.lifetime=0,this.maxLifetime=2,this.velocity=e,this.rotationSpeed=10*(Math.random()-.5)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=.95,this.velocity.y*=.95,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}applyCollision(t){this.velocity.x+=.3*t.x,this.velocity.y+=.3*t.y}}class W{constructor(t,e){this.position=t,this.angle=e,this.lifetime=0,this.maxLifetime=.05}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class z{constructor(t,e){this.position=t,this.lifetime=0,this.maxLifetime=.5,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.y+=100*t,this.velocity.x*=.98,this.velocity.y*=.98,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class N{constructor(t,e,i,s=5){this.position=t,this.owner=i,this.damage=s,this.lifetime=0,this.maxLifetime=1,this.maxRange=1/0,this.velocity=e,this.startPosition=new v(t.x,t.y)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime||this.startPosition.distanceTo(this.position)>=this.maxRange}checkHit(t){return this.position.distanceTo(t.position)<10}}class G{constructor(t,e,i,s){this.startPos=t,this.endPos=e,this.owner=i,this.damage=s,this.lifetime=0,this.maxLifetime=.1}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}class U{constructor(t,e,i,s){this.position=t,this.velocity=e,this.maxLifetime=i,this.faction=s,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class ${constructor(t,e,i,s,o,n,r=5,a=10){this.position=t,this.owner=e,this.attackRange=s,this.attackDamage=o,this.attackSpeed=n,this.abilityCooldownTime=r,this.attackCooldown=0,this.abilityCooldown=0,this.target=null,this.rallyPoint=null,this.lastAbilityEffects=[],this.isHero=!1,this.moveOrder=0,this.rotation=0,this.velocity=new v(0,0),this.health=i,this.maxHealth=i,this.collisionRadiusPx=a}update(t,e,i,s=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.moveTowardRallyPoint(t,100,i,s),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}moveTowardRallyPoint(t,e,i,s=[]){if(!this.rallyPoint)return this.velocity.x=0,void(this.velocity.y=0);const o=this.rallyPoint.x-this.position.x,n=this.rallyPoint.y-this.position.y,r=Math.sqrt(o*o+n*n);if(r<=5)return this.rallyPoint=null,this.velocity.x=0,void(this.velocity.y=0);let a=o/r,l=n/r,h=0,c=0;for(let t=0;t<i.length;t++){const e=i[t];if(e===this||e.isDead())continue;const s=this.position.x-e.position.x,o=this.position.y-e.position.y,n=s*s+o*o;if(n>0&&n<1600){const t=Math.sqrt(n);let i=(40-t)/40;this.isHero&&!e.isHero?i*=.3:!this.isHero&&e.isHero&&(i*=1.4),h+=s/t*i,c+=o/t*i}}const d=Math.sqrt(h*h+c*c);d>0&&(h/=d,c/=d);let g=0,u=0;for(let t=0;t<s.length;t++){const e=s[t],i=e.position.x-this.position.x,o=e.position.y-this.position.y,n=i*a+o*l,r=e.size+this.collisionRadiusPx+12,h=r*r;if(n>0&&n<140){const t=i-a*n,e=o-l*n,s=t*t+e*e;if(s<h){const t=a*o-l*i,e=t>0?l:-l,n=t>0?-a:a,h=(r-Math.sqrt(s))/r;g+=e*h,u+=n*h}}const c=this.position.x-e.position.x,d=this.position.y-e.position.y,p=c*c+d*d;if(p<h){const t=Math.sqrt(p);if(t>0){const e=(r-t)/r;g+=c/t*e,u+=d/t*e}}}const p=Math.sqrt(g*g+u*u);p>0&&(g/=p,u/=p),a+=.7*h,l+=.7*c,a+=1.1*g,l+=1.1*u;const x=Math.sqrt(a*a+l*l);if(x>0&&(a/=x,l/=x),x>0){const e=Math.atan2(l,a),i=this.getShortestAngleDelta(this.rotation,e),s=8*t;Math.abs(i)<=s?this.rotation=e:this.rotation+=Math.sign(i)*s,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}const y=e*t,f=a*y,m=l*y;this.position.x+=f,this.position.y+=m,this.velocity.x=a*e,this.velocity.y=l*e;this.position.x=Math.max(-850,Math.min(850,this.position.x)),this.position.y=Math.max(-850,Math.min(850,this.position.y))}getShortestAngleDelta(t,e){let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=this.attackDamage)}useAbility(t){return!(this.abilityCooldown>0||(this.abilityCooldown=this.abilityCooldownTime,0))}getAndClearLastAbilityEffects(){const t=this.lastAbilityEffects;return this.lastAbilityEffects=[],t}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class X extends ${constructor(t,e){super(t,e,100,300,10,5,5),this.lastShotEffects={},this.isHero=!0}attack(t){super.attack(t);const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.atan2(i,e);this.lastShotEffects.muzzleFlash=new W(new v(this.position.x,this.position.y),s);const o=s+Math.PI/2+.5*(Math.random()-.5),n=100+50*Math.random();this.lastShotEffects.casing=new _(new v(this.position.x,this.position.y),new v(Math.cos(o)*n,Math.sin(o)*n));const r=s+Math.PI+1*(Math.random()-.5),a=150+100*Math.random();this.lastShotEffects.bouncingBullet=new z(new v(t.position.x,t.position.y),new v(Math.cos(r)*a,Math.sin(r)*a))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}useAbility(t){if(!super.useAbility(t))return!1;const e=Math.atan2(t.y,t.x),i=F;for(let t=0;t<15;t++){const s=e+(t/Math.max(14,1)-.5)*i*2,o=500,n=new v(Math.cos(s)*o,Math.sin(s)*o),r=new N(new v(this.position.x,this.position.y),n,this.owner);this.lastAbilityEffects.push(r)}return!0}}class V{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.velocity=e}update(t,e){if(!this.isAttacking){const i=e.x-this.position.x,s=e.y-this.position.y,o=Math.sqrt(i*i+s*s);if(o>0){const e=i/o,n=s/o,r=300;this.velocity.x+=e*r*t,this.velocity.y+=n*r*t;const a=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(a<80){const t=80/a;this.velocity.x*=t,this.velocity.y*=t}}}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.isAttacking&&(this.trail.push(new v(this.position.x,this.position.y)),this.trail.length>15&&this.trail.shift(),this.lifetime+=t),this.isAttacking&&this.targetEnemy&&this.position.distanceTo(this.targetEnemy.position)<10&&("health"in this.targetEnemy&&(this.targetEnemy.health-=15),this.isAttacking=!1,this.trail=[],this.targetEnemy=null)}launchAtTarget(t){this.isAttacking=!0,this.targetEnemy=t,this.trail=[],this.lifetime=0;const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s>0){const t=e/s,o=i/s;this.velocity.x=400*t,this.velocity.y=400*o}}returnToOrbit(){this.isAttacking=!1,this.trail=[],this.targetEnemy=null}}class q extends ${constructor(t,e){super(t,e,150,100,15,2,5),this.projectiles=[],this.projectileLaunchCooldown=0,this.isHero=!0;for(let i=0;i<5;i++){const s=i/5*Math.PI*2,o=50*Math.cos(s),n=50*Math.sin(s),r=80*-Math.sin(s),a=80*Math.cos(s);this.projectiles.push(new V(new v(t.x+o,t.y+n),new v(r,a),e))}}update(t,e,i,s=[]){super.update(t,e,i,s),this.projectileLaunchCooldown>0&&(this.projectileLaunchCooldown-=t);for(const e of this.projectiles)e.update(t,this.position);if(this.target&&this.projectileLaunchCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange){const t=this.projectiles.find(t=>!t.isAttacking);t&&(t.launchAtTarget(this.target),this.projectileLaunchCooldown=1/this.attackSpeed)}}attack(t){}getProjectiles(){return this.projectiles}}class Y extends ${constructor(t,e,i=[]){super(t,e,50,120,5,2,0,3),this.explorationTarget=null,this.explorationTimer=0,this.currentPathWaypointIndex=0,this.assignedPath=[],this.hasManualOrder=!1,this.lastShotLasers=[],this.pathHash="",this.hasReachedFinalWaypoint=!1,this.assignedPath=i.map(t=>new v(t.x,t.y)),this.pathHash=this.generatePathHash(this.assignedPath)}generatePathHash(t){return 0===t.length?"no-path":t.map(t=>`${Math.round(t.x)},${Math.round(t.y)}`).join("|")}setManualRallyPoint(t){this.rallyPoint=t,this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1}setPath(t){this.assignedPath=t.map(t=>new v(t.x,t.y)),this.pathHash=this.generatePathHash(this.assignedPath),this.currentPathWaypointIndex=0,this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1,this.rallyPoint=null}getAssignedPathLength(){return this.assignedPath.length}getPathHash(){return this.pathHash}getHasReachedFinalWaypoint(){return this.hasReachedFinalWaypoint}getCurrentPathWaypointIndex(){return this.currentPathWaypointIndex}hasActiveManualOrder(){return this.hasManualOrder}getAndClearLastShotProjectiles(){return[]}getAndClearLastShotLasers(){const t=this.lastShotLasers;return this.lastShotLasers=[],t}updateAI(t,e){var i,s;if(!this.hasManualOrder)if(this.assignedPath.length>0){const e=this.assignedPath[this.currentPathWaypointIndex],o=null!==(i=this.getStandoffPointForWaypoint(t,e))&&void 0!==i?i:e;if(this.position.distanceTo(o)<10){if(!(this.currentPathWaypointIndex<this.assignedPath.length-1))return this.rallyPoint=o,void(this.hasReachedFinalWaypoint=!0);{this.currentPathWaypointIndex++;const e=this.assignedPath[this.currentPathWaypointIndex];this.rallyPoint=null!==(s=this.getStandoffPointForWaypoint(t,e))&&void 0!==s?s:e}}else this.rallyPoint=o}else{let i=null,s=null;for(const o of e)if(o instanceof D&&o.owner!==this.owner&&t.isObjectVisibleToPlayer(o.position,this.owner)){i=o.position,s=o.radius;break}if(!i)for(const e of t.players)if(e!==this.owner){for(const s of e.solarMirrors)if(t.isObjectVisibleToPlayer(s.position,this.owner)){i=s.position;break}if(i)break}if(!i){if(this.explorationTimer<=0||!this.explorationTarget||this.position.distanceTo(this.explorationTarget)<5){const t=Math.random()*Math.PI*2,e=300+500*Math.random();this.explorationTarget=new v(this.position.x+Math.cos(t)*e,this.position.y+Math.sin(t)*e),this.explorationTimer=5}i=this.explorationTarget}i&&(this.rallyPoint=s?this.getStructureStandoffPoint(i,s):i)}}getStandoffPointForWaypoint(t,e){for(const i of t.players){if(i.stellarForge&&e.distanceTo(i.stellarForge.position)<i.stellarForge.radius+this.collisionRadiusPx)return this.getStructureStandoffPoint(i.stellarForge.position,i.stellarForge.radius);for(const t of i.buildings)if(e.distanceTo(t.position)<t.radius+this.collisionRadiusPx)return this.getStructureStandoffPoint(t.position,t.radius)}return null}getStructureStandoffPoint(t,e){const i=this.position.x-t.x,s=this.position.y-t.y,o=Math.sqrt(i*i+s*s),n=e+this.collisionRadiusPx+4;if(o<=0)return new v(t.x+n,t.y);const r=n/o;return new v(t.x+i*r,t.y+s*r)}moveTowardRallyPoint(t,e,i,s=[]){if(this.assignedPath.length>0&&this.currentPathWaypointIndex===this.assignedPath.length-1&&!this.hasReachedFinalWaypoint&&null!==this.rallyPoint){const t=40;for(let e=0;e<i.length;e++){const s=i[e];if(!(s instanceof Y)||s===this||s.isDead()||s.owner!==this.owner)continue;if(s.pathHash!==this.pathHash)continue;if(!s.hasReachedFinalWaypoint)continue;const o=this.position.x-s.position.x,n=this.position.y-s.position.y;if(o*o+n*n<t*t)return this.rallyPoint=null,this.velocity.x=0,this.velocity.y=0,void(this.hasReachedFinalWaypoint=!0)}}super.moveTowardRallyPoint(t,e,i,s)}update(t,e,i=[],s=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.explorationTimer-=t,this.moveTowardRallyPoint(t,50,i,s),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}attack(t){const e=t.position.x-this.position.x,i=t.position.y-this.position.y;if(Math.sqrt(e*e+i*i)<=0)return;const s=new G(new v(this.position.x,this.position.y),new v(t.position.x,t.position.y),this.owner,this.attackDamage);this.lastShotLasers.push(s),"takeDamage"in t&&t.takeDamage(this.attackDamage)}}class j{constructor(t,e){this.position=t,this.owner=e,this.chargeTime=0,this.isCharging=!1,this.isComplete=!1,this.health=100,this.hasEmittedShockwave=!1}update(t,e,i=1){this.isCharging&&!this.isComplete&&(e?(this.chargeTime+=t*i,this.chargeTime>=6&&(this.isComplete=!0,this.isCharging=!1)):this.cancel())}startCharging(){this.isCharging=!0,this.chargeTime=0}takeDamage(t){return this.health-=t,this.health<=0&&(this.cancel(),!0)}cancel(){this.isCharging=!1,this.isComplete=!1}shouldEmitShockwave(){return!this.hasEmittedShockwave&&this.chargeTime>=1&&(this.hasEmittedShockwave=!0,!0)}}class Q{constructor(t,e,i){this.startPos=t,this.endPos=e,this.owner=i,this.lifetime=0,this.maxLifetime=.5}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}class Z extends ${constructor(t,e){super(t,e,120,250,8,3,8),this.beamSegments=[],this.drillDirection=null,this.isHero=!0}useAbility(t){return!!super.useAbility(t)&&(this.drillDirection=t,!0)}getBeamSegments(){return this.beamSegments}setBeamSegments(t){this.beamSegments=t}updateBeamSegments(t){this.beamSegments=this.beamSegments.filter(e=>!e.update(t))}}class K{constructor(t,e,i=150,s=10){this.position=t,this.owner=e,this.radius=i,this.duration=s,this.lifetime=0}update(t){return this.lifetime+=t,this.lifetime>=this.duration}isExpired(){return this.lifetime>=this.duration}}class J{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.maxLifetime=5,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldExplode(){return this.lifetime>=this.maxLifetime}}class tt extends ${constructor(t,e){super(t,e,100,200,5,1.5,15),this.projectileToCreate=null,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const e=new v(300*t.x,300*t.y);return this.projectileToCreate=new J(new v(this.position.x,this.position.y),e,this.owner),!0}getAndClearProjectile(){const t=this.projectileToCreate;return this.projectileToCreate=null,t}}class et{constructor(t,e,i=null){this.position=t,this.owner=e,this.attachedToAsteroid=i,this.maxHealth=150,this.attackCooldown=0,this.target=null,this.health=this.maxHealth}update(t,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=300&&(this.attack(this.target),this.attackCooldown=1/3)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=12)}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class it extends ${constructor(t,e){super(t,e,90,180,6,2,12),this.isHero=!0}useAbility(t){return!!super.useAbility(t)}}class st extends ${constructor(t,e){super(t,e,140,0,0,0,5),this.isDrilling=!1,this.isHidden=!1,this.drillDirection=null,this.drillVelocity=new v(0,0),this.hiddenInAsteroid=null,this.isHero=!0}attack(t){}useAbility(t){return!this.isDrilling&&!!super.useAbility(t)&&(this.isDrilling=!0,this.isHidden=!1,this.drillDirection=t.normalize(),this.drillVelocity=new v(500*this.drillDirection.x,500*this.drillDirection.y),!0)}updateDrilling(t){this.isDrilling&&this.drillVelocity&&(this.position.x+=this.drillVelocity.x*t,this.position.y+=this.drillVelocity.y*t)}stopDrilling(){this.isDrilling=!1,this.drillVelocity=new v(0,0)}hideInAsteroid(t){this.isHidden=!0,this.hiddenInAsteroid=t,this.position=new v(t.position.x,t.position.y)}isHiddenInAsteroid(){return this.isHidden}}class ot extends ${constructor(t,e){super(t,e,80,100,35,1.5,6),this.isCloaked=!0,this.visibilityTimer=0,this.canSeeEnemies=!1,this.enemyVisionTimer=0,this.isHero=!0}updateTimers(t){this.visibilityTimer>0&&(this.visibilityTimer-=t,this.visibilityTimer<=0&&(this.visibilityTimer=0,this.isCloaked=!0)),this.enemyVisionTimer>0&&(this.enemyVisionTimer-=t,this.enemyVisionTimer<=0&&(this.enemyVisionTimer=0,this.canSeeEnemies=!1))}useAbility(t){if(!super.useAbility(t))return!1;this.isCloaked=!1,this.visibilityTimer=8,this.canSeeEnemies=!0,this.enemyVisionTimer=8;const e=t.normalize(),i=Math.atan2(e.y,e.x),s=new v(400*Math.cos(i),400*Math.sin(i)),o=new N(new v(this.position.x,this.position.y),s,this.owner,50);return o.maxRange=150,this.lastAbilityEffects.push(o),!0}update(t,e,i,s=[]){let o=e;this.canSeeEnemies||(o=[]),super.update(t,o,i,s)}isCloakedToEnemies(){return this.isCloaked}hasEnemyVision(){return this.canSeeEnemies}}class nt extends ${constructor(t,e){super(t,e,70,150,20,1,8),this.lastBeamDamage=0,this.lastBeamDistance=0,this.lastBeamMultiplier=0,this.lastBeamTime=0,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const e=t.normalize(),i=new v(1e3*e.x,1e3*e.y),s=new N(new v(this.position.x,this.position.y),i,this.owner,30);return s.maxRange=600,s.isBeamProjectile=!0,s.beamOwner=this,this.lastAbilityEffects.push(s),!0}}class rt{constructor(t,e,i,s=100,o=0,n=null){this.position=new v(t.x,t.y),this.damage=Math.round(e),this.remainingHealth=Math.round(o),this.creationTime=i,this.maxHealth=s,this.unitId=n,this.velocity=new v(20*(Math.random()-.5),-50)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}isExpired(t){return t-this.creationTime>2}getOpacity(t){const e=t-this.creationTime;return Math.max(0,1-e/2)}}class at{constructor(){this.players=[],this.suns=[],this.spaceDust=[],this.warpGates=[],this.asteroids=[],this.muzzleFlashes=[],this.bulletCasings=[],this.bouncingBullets=[],this.abilityBullets=[],this.minionProjectiles=[],this.laserBeams=[],this.impactParticles=[],this.influenceZones=[],this.influenceBallProjectiles=[],this.deployedTurrets=[],this.damageNumbers=[],this.gameTime=0,this.stateHash=0,this.stateHashTickCounter=0,this.isRunning=!1,this.countdownTime=3,this.isCountdownActive=!0,this.mirrorsMovedToSun=!1,this.mapSize=2e3,this.damageDisplayMode="damage",this.MAX_PUSH_DISTANCE=10,this.PUSH_MULTIPLIER=15,this.dustSpatialHash=new Map,this.dustSpatialHashKeys=[]}update(e){var i,s;this.gameTime+=e,this.isCountdownActive&&(this.countdownTime-=e,this.mirrorsMovedToSun||(this.initializeMirrorMovement(),this.mirrorsMovedToSun=!0),this.countdownTime<=0&&(this.isCountdownActive=!1,this.countdownTime=0));for(const t of this.suns)t.updateVoronoiSegments(e);for(const t of this.asteroids)t.update(e);this.isCountdownActive||this.updateAi(e);for(const o of this.players)if(!o.isDefeated()){if(o.solarMirrors.length>0&&(o.solarMirrors=o.solarMirrors.filter(t=>t.health>0)),o.stellarForge){const t=new v(o.stellarForge.position.x,o.stellarForge.position.y);if(o.stellarForge.updateLightStatus(o.solarMirrors,this.suns,this.asteroids,this.players),this.isCountdownActive||(o.stellarForge.update(e,this),this.checkCollision(o.stellarForge.position,o.stellarForge.radius,o.stellarForge)&&(o.stellarForge.position=t,o.stellarForge.targetPosition=null,o.stellarForge.velocity=new v(0,0)),this.applyDustPushFromMovingEntity(o.stellarForge.position,o.stellarForge.velocity,160,.9,e)),!this.isCountdownActive){const t=o.stellarForge.shouldCrunch();if(t>0){const e=Math.floor(t/50);for(let t=0;t<e;t++){const n=2*Math.PI*t/e,r=210,a=new v(o.stellarForge.position.x+Math.cos(n)*r,o.stellarForge.position.y+Math.sin(n)*r),l=new Y(a,o,null!==(s=null===(i=o.stellarForge)||void 0===i?void 0:i.minionPath)&&void 0!==s?s:[]);o.units.push(l),o.unitsCreated++}e>0&&console.log(`${o.name} forge crunch spawned ${e} Starlings with ${t.toFixed(0)} energy`)}}if(!this.isCountdownActive){const t=o.stellarForge.advanceHeroProduction(e);if(t){const e=o.unitsCreated%8*(Math.PI/4),i=o.stellarForge.radius+10+5,s=new v(o.stellarForge.position.x+Math.cos(e)*i,o.stellarForge.position.y+Math.sin(e)*i),n=this.createHeroUnit(t,s,o);n&&(o.units.push(n),o.unitsCreated++,console.log(`${o.name} forged hero ${t}`))}}}for(const i of o.solarMirrors){const s=new v(i.position.x,i.position.y);if(i.update(e,this),this.checkCollision(i.position,20,i)&&(i.position=s,i.targetPosition=null,i.velocity=new v(0,0)),this.applyDustPushFromMovingEntity(i.position,i.velocity,110,1.1,e),i.updateReflectionAngle(o.stellarForge,this.suns,this.asteroids,e),i.hasLineOfSightToLight(this.suns,this.asteroids)&&o.stellarForge&&i.hasLineOfSightToForge(o.stellarForge,this.asteroids,this.players)){const t=i.generateEnergy(e);o.addEnergy(t),o.stellarForge.addPendingEnergy(t)}o.stellarForge&&i.health<d&&o.stellarForge.position.distanceTo(i.position)<=t&&(i.health=Math.min(d,i.health+2*e))}}this.updateSpaceDust(e);const o=[],n=[];for(const t of this.players)t.isDefeated()||(o.push(...t.units),t.stellarForge&&n.push(t.stellarForge));for(const i of this.players){if(i.isDefeated())continue;const s=[];for(const t of this.players)if(t!==i&&!t.isDefeated()){s.push(...t.units),s.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&s.push(e);t.stellarForge&&s.push(t.stellarForge)}if(!this.isCountdownActive)for(const t of i.units){if(t instanceof Y&&t.updateAI(this,s),t.update(e,s,o,this.asteroids),t instanceof Y&&this.applyDustPushFromMovingEntity(t.position,t.velocity,50,.5,e),t instanceof q)for(const i of t.getProjectiles())if(i.isAttacking){const t=Math.sqrt(Math.pow(i.velocity.x,2)+Math.pow(i.velocity.y,2));this.applyFluidForceFromMovingObject(i.position,i.velocity,20,.4*t,e)}if(t instanceof X){const e=t.getAndClearLastShotEffects();e.muzzleFlash&&this.muzzleFlashes.push(e.muzzleFlash),e.casing&&this.bulletCasings.push(e.casing),e.bouncingBullet&&this.bouncingBullets.push(e.bouncingBullet)}const i=t.getAndClearLastAbilityEffects();if(this.abilityBullets.push(...i),t instanceof Y){const e=t.getAndClearLastShotLasers();if(e.length>0){this.laserBeams.push(...e);for(const t of e)for(let e=0;e<3;e++){const i=2*Math.PI*e/3,s=new v(30*Math.cos(i),30*Math.sin(i));this.impactParticles.push(new U(new v(t.endPos.x,t.endPos.y),s,.3,t.owner.faction))}}}if(t instanceof tt){const e=t.getAndClearProjectile();e&&this.influenceBallProjectiles.push(e)}if(t instanceof Z){t.updateBeamSegments(e);for(const i of t.getBeamSegments())this.applyFluidForceFromBeam(i.startPos,i.endPos,40,300,e);t.abilityCooldown>t.abilityCooldownTime-.1&&t.drillDirection&&(this.processRayBeamAbility(t),t.drillDirection=null)}if(t instanceof it&&t.abilityCooldown>t.abilityCooldownTime-.1&&this.processTurretDeployment(t),t instanceof st&&t.isDrilling&&(t.updateDrilling(e),this.processDrillerCollisions(t,e)),t instanceof ot&&t.updateTimers(e),t instanceof q)for(const e of t.getProjectiles())if(e.isAttacking)for(const t of this.players)for(const i of t.buildings)i instanceof R&&i.deflectProjectile(e)}const n=i.units.filter(t=>t.isDead());if(i.unitsLost+=n.length,i.units=i.units.filter(t=>!t.isDead()),!this.isCountdownActive)for(const t of i.buildings){if(t.update(e,s,o),t instanceof E){const e=t.getAndClearLastShotEffects();e.muzzleFlash&&this.muzzleFlashes.push(e.muzzleFlash),e.casing&&this.bulletCasings.push(e.casing),e.bouncingBullet&&this.bouncingBullets.push(e.bouncingBullet)}if(t instanceof k&&"solar-mirror"===t.getCompletedProduction()){const e=Math.random()*Math.PI*2,s=80,o=new v(t.position.x+Math.cos(e)*s,t.position.y+Math.sin(e)*s),n=new A(o,i);i.solarMirrors.push(n)}}if(!this.isCountdownActive)for(const s of i.buildings)if(!s.isComplete)if(i.stellarForge&&s.position.distanceTo(i.stellarForge.position)<=t&&i.stellarForge){const t=.2*e;s.addBuildProgress(t)}else{let t=0;for(const e of i.solarMirrors){if(!e.hasLineOfSightToLight(this.suns,this.asteroids))continue;const i=new b(e.position,new v(s.position.x-e.position.x,s.position.y-e.position.y).normalize(),1);let o=!0;for(const t of this.asteroids)if(i.intersectsPolygon(t.getWorldVertices())){o=!1;break}if(o){const i=this.suns.reduce((t,i)=>e.position.distanceTo(i.position)<(t?e.position.distanceTo(t.position):1/0)?i:t,null);if(i){const s=e.position.distanceTo(i.position);t+=Math.max(1,2*(1-Math.min(1,s/w)))}}}if(t>0){const i=t/10*.2*e;s.addBuildProgress(i)}}i.buildings=i.buildings.filter(t=>!t.isDestroyed())}this.isCountdownActive||(this.resolveUnitCollisions(o),this.resolveUnitObstacleCollisions(o)),this.stateHashTickCounter+=1,this.stateHashTickCounter%30==0&&this.updateStateHash();for(const t of this.muzzleFlashes)t.update(e);this.muzzleFlashes=this.muzzleFlashes.filter(t=>!t.shouldDespawn());for(const t of this.bulletCasings){t.update(e);for(const e of this.spaceDust)if(t.position.distanceTo(e.position)<5){const i=new v(e.position.x-t.position.x,e.position.y-t.position.y).normalize();e.applyForce(new v(50*i.x,50*i.y)),t.applyCollision(new v(50*-i.x,50*-i.y))}}this.bulletCasings=this.bulletCasings.filter(t=>!t.shouldDespawn());for(const t of this.bouncingBullets)t.update(e);this.bouncingBullets=this.bouncingBullets.filter(t=>!t.shouldDespawn());for(const t of this.abilityBullets){t.update(e);const i=Math.sqrt(Math.pow(t.velocity.x,2)+Math.pow(t.velocity.y,2));this.applyFluidForceFromMovingObject(t.position,t.velocity,30,.5*i,e);for(const e of this.players)if(e!==t.owner){for(const i of e.units)if(t.checkHit(i)){let e=t.damage;if(t.isBeamProjectile&&t.beamOwner){const s=t.beamOwner,o=s.position.distanceTo(i.position),n=1+.1*o;e=Math.round(30*n),s.lastBeamDamage=e,s.lastBeamDistance=o,s.lastBeamMultiplier=n,s.lastBeamTime=this.gameTime}i.takeDamage(e);const s=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,e,i.maxHealth,i.health,s),t.lifetime=t.maxLifetime;break}if(!t.shouldDespawn()){for(const i of e.solarMirrors)if(!(i.health<=0)&&t.checkHit(i)){i.health-=t.damage;const s=`mirror_${i.position.x}_${i.position.y}_${e.name}`;this.addDamageNumber(i.position,t.damage,d,i.health,s),t.lifetime=t.maxLifetime;break}if(!t.shouldDespawn()&&e.stellarForge&&t.checkHit(e.stellarForge)){let i=t.damage;if(t.isBeamProjectile&&t.beamOwner){const s=t.beamOwner,o=s.position.distanceTo(e.stellarForge.position),n=1+.1*o;i=Math.round(30*n),s.lastBeamDamage=i,s.lastBeamDistance=o,s.lastBeamMultiplier=n,s.lastBeamTime=this.gameTime}e.stellarForge.health-=i;const s=`forge_${e.stellarForge.position.x}_${e.stellarForge.position.y}_${e.name}`;this.addDamageNumber(e.stellarForge.position,i,u,e.stellarForge.health,s),t.lifetime=t.maxLifetime}}}}this.abilityBullets=this.abilityBullets.filter(t=>!t.shouldDespawn());for(const t of this.minionProjectiles){t.update(e);const i=Math.sqrt(Math.pow(t.velocity.x,2)+Math.pow(t.velocity.y,2));this.applyFluidForceFromMovingObject(t.position,t.velocity,25,.4*i,e);for(const e of this.players)for(const i of e.buildings)i instanceof R&&i.deflectProjectile(t);let s=!1;for(const e of this.players)if(e!==t.owner){for(const i of e.units)if(t.checkHit(i)){i.takeDamage(t.damage);const e=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,t.damage,i.maxHealth,i.health,e),s=!0;break}if(s)break;for(const i of e.solarMirrors)if(!(i.health<=0)&&t.checkHit(i)){i.health-=t.damage;const o=`mirror_${i.position.x}_${i.position.y}_${e.name}`;this.addDamageNumber(i.position,t.damage,d,i.health,o),s=!0;break}if(s)break;for(const i of e.buildings)if(t.checkHit(i)){i.health-=t.damage;const o=`building_${i.position.x}_${i.position.y}_${e.name}`;this.addDamageNumber(i.position,t.damage,i.maxHealth,i.health,o),s=!0;break}if(s)break;if(e.stellarForge&&t.checkHit(e.stellarForge)){e.stellarForge.health-=t.damage;const i=`forge_${e.stellarForge.position.x}_${e.stellarForge.position.y}_${e.name}`;this.addDamageNumber(e.stellarForge.position,t.damage,u,e.stellarForge.health,i),s=!0;break}}s&&(t.distanceTraveledPx=t.maxRangePx)}this.minionProjectiles=this.minionProjectiles.filter(t=>!t.shouldDespawn()),this.laserBeams=this.laserBeams.filter(t=>!t.update(e));for(const t of this.impactParticles)t.update(e);this.impactParticles=this.impactParticles.filter(t=>!t.shouldDespawn()),this.influenceZones=this.influenceZones.filter(t=>!t.update(e));for(const t of this.influenceBallProjectiles){t.update(e);const i=Math.sqrt(Math.pow(t.velocity.x,2)+Math.pow(t.velocity.y,2));this.applyFluidForceFromMovingObject(t.position,t.velocity,35,.5*i,e);for(const e of this.players)for(const i of e.buildings)i instanceof R&&i.deflectProjectile(t);if(t.shouldExplode()){const e=new K(new v(t.position.x,t.position.y),t.owner);this.influenceZones.push(e)}}this.influenceBallProjectiles=this.influenceBallProjectiles.filter(t=>!t.shouldExplode());const r=[];for(const t of this.players)if(!t.isDefeated()){r.push(...t.units),r.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&r.push(e);t.stellarForge&&r.push(t.stellarForge)}for(const t of this.deployedTurrets){const i=r.filter(e=>e.owner!==t.owner);t.update(e,i)}this.deployedTurrets=this.deployedTurrets.filter(t=>!t.isDead());for(const t of this.damageNumbers)t.update(e);this.damageNumbers=this.damageNumbers.filter(t=>!t.isExpired(this.gameTime))}updateSpaceDust(s){this.applyDustRepulsion(s);for(const o of this.spaceDust){o.update(s);let n=null;for(let s=0;s<this.players.length;s++){const r=this.players[s];if(r.stellarForge&&!r.isDefeated()){const a=o.position.distanceTo(r.stellarForge.position);if(a<t){const t=0===s?e:i;(!n||a<n.distance)&&(n={color:t,distance:a})}}}if(n){const e=1-n.distance/t;o.updateColor(n.color,e)}else o.updateColor(null,0)}for(const t of this.warpGates)if(t.isCharging&&t.chargeTime>=1)for(const e of this.spaceDust){const i=e.position.distanceTo(t.position);if(i<200&&i>5){const o=new v(t.position.x-e.position.x,t.position.y-e.position.y).normalize(),n=new v(-o.y,o.x),r=new v(50*o.x+20*n.x,50*o.y+20*n.y);e.applyForce(new v(r.x*s/i,r.y*s/i))}}for(const t of this.players)if(t.stellarForge&&!t.isDefeated()){const e=t.stellarForge.getCurrentCrunch();if(e&&e.isActive())for(const t of this.spaceDust){const i=t.position.distanceTo(e.position);if("suck"===e.phase&&i<250){if(i>5){const o=new v(e.position.x-t.position.x,e.position.y-t.position.y).normalize(),n=150/Math.sqrt(i);t.applyForce(new v(o.x*n*s,o.y*n*s))}}else if("wave"===e.phase&&i<300&&i>5){const o=new v(t.position.x-e.position.x,t.position.y-e.position.y).normalize(),n=300*e.getPhaseProgress(),r=Math.abs(i-n),a=50,l=100*Math.exp(-r/a);t.applyForce(new v(o.x*l*s,o.y*l*s))}}}for(const t of this.players)for(const e of t.buildings)e instanceof R&&e.applyDustSwirl(this.spaceDust,s)}applyDustRepulsion(t){for(let t=0;t<this.dustSpatialHashKeys.length;t++){const e=this.dustSpatialHashKeys[t],i=this.dustSpatialHash.get(e);i&&(i.length=0)}this.dustSpatialHashKeys.length=0;for(let t=0;t<this.spaceDust.length;t++){const e=this.spaceDust[t],i=Math.floor(e.position.x/32)<<16^65535&Math.floor(e.position.y/32);let s=this.dustSpatialHash.get(i);s||(s=[],this.dustSpatialHash.set(i,s)),0===s.length&&this.dustSpatialHashKeys.push(i),s.push(t)}for(let e=0;e<this.spaceDust.length;e++){const i=this.spaceDust[e],s=Math.floor(i.position.x/32),o=Math.floor(i.position.y/32);let n=0,r=0;for(let t=-1;t<=1;t++)for(let a=-1;a<=1;a++){const l=s+a<<16^o+t&65535,h=this.dustSpatialHash.get(l);if(h)for(let t=0;t<h.length;t++){const s=h[t];if(s===e)continue;const o=this.spaceDust[s],a=i.position.x-o.position.x,l=i.position.y-o.position.y,c=a*a+l*l;if(c>0&&c<784){const t=Math.sqrt(c),e=14*(1-t/28);n+=a/t*e,r+=l/t*e}}}0===n&&0===r||(i.velocity.x+=n*t,i.velocity.y+=r*t)}}updateAi(t){for(const t of this.players){if(!t.isAi||t.isDefeated())continue;const e=this.getEnemiesForPlayer(t);this.updateAiMirrorsForPlayer(t),this.updateAiMirrorPurchaseForPlayer(t),this.updateAiDefenseForPlayer(t,e),this.updateAiHeroProductionForPlayer(t),this.updateAiStructuresForPlayer(t,e)}}getEnemiesForPlayer(t){const e=[];for(const i of this.players)if(i!==t&&!i.isDefeated()){e.push(...i.units),e.push(...i.buildings);for(const t of i.solarMirrors)t.health>0&&e.push(t);i.stellarForge&&e.push(i.stellarForge)}return e}updateAiMirrorsForPlayer(t){if(this.gameTime<t.aiNextMirrorCommandSec)return;if(t.aiNextMirrorCommandSec=this.gameTime+2,!t.stellarForge||0===t.solarMirrors.length)return;const e=this.getClosestSunToPoint(t.stellarForge.position);if(!e)return;const i=t.solarMirrors.length,s=Math.atan2(t.stellarForge.position.y-e.position.y,t.stellarForge.position.x-e.position.x)-m*(i-1)/2,o=e.radius+220;for(let n=0;n<i;n++){const i=t.solarMirrors[n],r=s+m*n,a=new v(e.position.x+Math.cos(r)*o,e.position.y+Math.sin(r)*o);i.position.distanceTo(a)>40&&i.setTarget(a)}}updateAiMirrorPurchaseForPlayer(t){if(this.gameTime<t.aiNextMirrorPurchaseCommandSec)return;if(t.aiNextMirrorPurchaseCommandSec=this.gameTime+8,!t.stellarForge)return;const e=t.solarMirrors.length;let i=2;switch(t.aiStrategy){case C.ECONOMIC:i=6;break;case C.DEFENSIVE:i=4;break;case C.AGGRESSIVE:i=3;break;case C.WAVES:i=4}if(e>=i)return;if(t.energy<50)return;const s=this.getClosestSunToPoint(t.stellarForge.position);if(!s)return;const o=Math.atan2(t.stellarForge.position.y-s.position.y,t.stellarForge.position.x-s.position.x)-m*i/2+m*e,n=s.radius+220,r=new v(s.position.x+Math.cos(o)*n,s.position.y+Math.sin(o)*n);if(t.spendEnergy(50)){const e=new A(r,t);t.solarMirrors.push(e)}}updateAiDefenseForPlayer(t,e){if(this.gameTime<t.aiNextDefenseCommandSec)return;t.aiNextDefenseCommandSec=this.gameTime+1;const i=this.findAiThreat(t,e);if(i){const e=i.enemy.position;for(const i of t.units)i.isHero?i.rallyPoint=new v(e.x,e.y):i instanceof Y&&i.setManualRallyPoint(new v(e.x,e.y));return}if(!t.stellarForge)return;if(t.aiStrategy===C.WAVES){if(!(t.units.length>=8)){for(const e of t.units)e.isHero?e.rallyPoint=new v(t.stellarForge.position.x,t.stellarForge.position.y):e instanceof Y&&e.setManualRallyPoint(new v(t.stellarForge.position.x,t.stellarForge.position.y));return}{const e=this.getEnemyForgeForPlayer(t);if(e){for(const i of t.units)(i.isHero||i instanceof Y)&&(i.rallyPoint=new v(e.position.x,e.position.y),i instanceof Y&&i.setManualRallyPoint(new v(e.position.x,e.position.y)));return}}}else if(t.aiStrategy===C.AGGRESSIVE){const e=this.getEnemyForgeForPlayer(t);if(e){for(const i of t.units)i.isHero?i.rallyPoint=new v(e.position.x,e.position.y):i instanceof Y&&i.setManualRallyPoint(new v(e.position.x,e.position.y));return}}const s=t.solarMirrors.length;let o=0;for(const e of t.units)if(e.isHero)e.rallyPoint=new v(t.stellarForge.position.x,t.stellarForge.position.y);else if(e instanceof Y)if(o<s){const i=t.solarMirrors[o];e.setManualRallyPoint(new v(i.position.x,i.position.y)),o+=1}else e.setManualRallyPoint(new v(t.stellarForge.position.x,t.stellarForge.position.y))}getEnemyForgeForPlayer(t){for(const e of this.players)if(e!==t&&!e.isDefeated()&&e.stellarForge)return e.stellarForge;return null}updateAiHeroProductionForPlayer(t){if(this.gameTime<t.aiNextHeroCommandSec)return;let e=3;switch(t.aiStrategy){case C.AGGRESSIVE:e=3*.7;break;case C.ECONOMIC:e=4.5;break;case C.WAVES:e=3*1.2;break;default:e=3}if(t.aiNextHeroCommandSec=this.gameTime+e,!t.stellarForge||!t.stellarForge.canProduceUnits())return;const i=this.getAiHeroTypesForFaction(t.faction);for(const e of i)if(!this.isHeroUnitAlive(t,e)&&!this.isHeroUnitQueuedOrProducing(t.stellarForge,e)){if(!t.spendEnergy(300))return;return t.stellarForge.enqueueHeroUnit(e),void t.stellarForge.startHeroProductionIfIdle()}}updateAiStructuresForPlayer(t,e){var i;if(this.gameTime<t.aiNextStructureCommandSec)return;if(t.aiNextStructureCommandSec=this.gameTime+5,!t.stellarForge)return;const s=t.buildings.filter(t=>t instanceof E).length,o=t.buildings.filter(t=>t instanceof R).length,n=t.buildings.some(t=>t instanceof k);let r=null;switch(t.aiStrategy){case C.ECONOMIC:!n&&t.energy>=f?r="subsidiaryFactory":s<1&&t.energy>=x?r="minigun":o<1&&t.energy>=y&&(r="swirler");break;case C.DEFENSIVE:o<2&&t.energy>=y?r="swirler":s<3&&t.energy>=x?r="minigun":!n&&t.energy>=f?r="subsidiaryFactory":s<5&&t.energy>=x&&(r="minigun");break;case C.AGGRESSIVE:!n&&t.energy>=f?r="subsidiaryFactory":s<1&&t.energy>=x&&(r="minigun");break;case C.WAVES:!n&&t.energy>=f?r="subsidiaryFactory":s<2&&t.energy>=x?r="minigun":o<1&&t.energy>=y?r="swirler":s<3&&t.energy>=x&&(r="minigun")}if(!r)return;const a=this.findAiThreat(t,e),l=null!==(i=null==a?void 0:a.guardPoint)&&void 0!==i?i:this.getAiStructureAnchor(t);if(!l)return;let h=null;switch(r){case"subsidiaryFactory":h=this.findAiStructurePlacement(l,40,t),h&&t.spendEnergy(f)&&t.buildings.push(new k(h,t));break;case"swirler":h=this.findAiStructurePlacement(l,35,t),h&&t.spendEnergy(y)&&t.buildings.push(new R(h,t));break;case"minigun":h=this.findAiStructurePlacement(l,30,t),h&&t.spendEnergy(x)&&t.buildings.push(new E(h,t))}}getAiStructureAnchor(t){if(!t.stellarForge)return null;if(0===t.solarMirrors.length||0===this.suns.length)return t.stellarForge.position;let e=null,i=1/0;for(const s of t.solarMirrors){const t=s.getClosestSun(this.suns);if(!t)continue;const o=s.position.distanceTo(t.position);o<i&&(i=o,e=s)}return e?e.position:t.stellarForge.position}findAiStructurePlacement(t,e,i){const s=i.buildings.length*S,o=140+e;for(let i=0;i<8;i++){const n=s+S*i,r=new v(t.x+Math.cos(n)*o,t.y+Math.sin(n)*o);if(!this.checkCollision(r,e))return r}return null}findAiThreat(t,e){if(!t.stellarForge)return null;const i=[t.stellarForge.position];for(const e of t.solarMirrors)i.push(e.position);let s=null,o=null,n=1/0;for(const t of i)for(const i of e){if("health"in i&&i.health<=0)continue;const e=i.position.x-t.x,r=i.position.y-t.y,a=e*e+r*r;a<=122500&&a<n&&(n=a,s=i,o=t)}return s&&o?{enemy:s,guardPoint:o}:null}getClosestSunToPoint(t){let e=null,i=1/0;for(const s of this.suns){const o=t.distanceTo(s.position);o<i&&(i=o,e=s)}return e}getAiHeroTypesForFaction(t){switch(t){case M.RADIANT:return["Marine","Dagger","Beam"];case M.AURUM:return["Grave","Driller"];case M.SOLARI:return["Ray","InfluenceBall","TurretDeployer"];default:return[]}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof X;case"Grave":return t instanceof q;case"Ray":return t instanceof Z;case"InfluenceBall":return t instanceof tt;case"TurretDeployer":return t instanceof it;case"Driller":return t instanceof st;case"Dagger":return t instanceof ot;case"Beam":return t instanceof nt;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}applyDustPushFromMovingEntity(t,e,i,s,o){const n=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));if(n<=0)return;const r=Math.max(n,3);this.applyFluidForceFromMovingObject(t,e,i,r*s,o)}applyFluidForceFromMovingObject(t,e,i,s,o){for(const n of this.spaceDust){const r=n.position.distanceTo(t);if(r<i&&r>.1){const a=new v(n.position.x-t.x,n.position.y-t.y).normalize(),l=e.normalize(),h=.6,c=.4,d=new v(l.x*h+a.x*c,l.y*h+a.y*c),g=1-r/i,u=s*g*g;n.applyForce(new v(d.x*u*o,d.y*u*o))}}}applyFluidForceFromBeam(t,e,i,s,o){const n=t.distanceTo(e);if(n<.1)return;const r=new v(e.x-t.x,e.y-t.y).normalize();for(const e of this.spaceDust){const a=new v(e.position.x-t.x,e.position.y-t.y),l=a.x*r.x+a.y*r.y,h=Math.max(0,Math.min(n,l)),c=new v(t.x+r.x*h,t.y+r.y*h),d=e.position.distanceTo(c);if(d<i&&d>.1){const t=new v(e.position.x-c.x,e.position.y-c.y).normalize(),n=.7,a=.3,l=new v(r.x*n+t.x*a,r.y*n+t.y*a),h=1-d/i,g=s*h*h;e.applyForce(new v(l.x*g*o,l.y*g*o))}}}initializeMirrorMovement(){if(0===this.suns.length)return;const t=this.suns[0];for(const e of this.players){if(!e.stellarForge||e.solarMirrors.length<2)continue;const i=e.stellarForge.position,s=i.x-t.position.x,o=i.y-t.position.y,n=Math.atan2(o,s),r=n+Math.PI/2,a=n-Math.PI/2;if(e.solarMirrors.length>=1){const t=new v(i.x+Math.cos(r)*c,i.y+Math.sin(r)*c);e.solarMirrors[0].setTarget(t)}if(e.solarMirrors.length>=2){const t=new v(i.x+Math.cos(a)*c,i.y+Math.sin(a)*c);e.solarMirrors[1].setTarget(t)}}}isPointInShadow(t){if(0===this.suns.length)return!0;for(const e of this.suns){const i=new v(e.position.x-t.x,e.position.y-t.y).normalize(),s=new b(t,i),o=t.distanceTo(e.position);let n=!0;for(const t of this.asteroids){const e=s.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<o){n=!1;break}}if(n)return!1}return!0}isObjectVisibleToPlayer(e,i,s){if(s&&s instanceof ot&&s.isCloakedToEnemies()&&s.owner!==i)return!1;if(!this.isPointInShadow(e))return!0;for(const t of i.units)if(t.position.distanceTo(e)<=150)return!0;return!!(i.stellarForge&&i.stellarForge.position.distanceTo(e)<=t)}processRayBeamAbility(t){if(!t.drillDirection)return;const e=[];let i=new v(t.position.x,t.position.y),s=t.drillDirection.normalize(),o=0;const n=2e3;for(;o<5;){let r=null,a=n;for(const t of this.asteroids){const e=this.rayIntersectsAsteroid(i,s,t);if(e){const t=i.distanceTo(e);t<a&&(a=t,r={pos:e,type:"asteroid"})}}for(const e of this.players)if(e!==t.owner){for(const t of e.units){const e=this.rayIntersectsUnit(i,s,t.position);if(e){const s=i.distanceTo(e);s<a&&(a=s,r={pos:e,type:"unit",target:t})}}if(e.stellarForge){const t=this.rayIntersectsUnit(i,s,e.stellarForge.position,e.stellarForge.radius);if(t){const s=i.distanceTo(t);s<a&&(a=s,r={pos:t,type:"forge",target:e.stellarForge})}}}for(const t of this.suns){const e=this.rayIntersectsUnit(i,s,t.position,t.radius);if(e){const t=i.distanceTo(e);t<a&&(a=t,r={pos:e,type:"sun"})}}const l=this.rayIntersectsEdge(i,s);if(l&&i.distanceTo(l)<a&&(a=i.distanceTo(l),r={pos:l,type:"edge"}),!r){const o=new v(i.x+s.x*n,i.y+s.y*n);e.push(new Q(i,o,t.owner));break}if(e.push(new Q(i,r.pos,t.owner)),"unit"===r.type||"forge"===r.type){if(r.target){r.target.takeDamage(25);const t="forge"===r.type?u:r.target.maxHealth,e="forge"===r.type?`forge_${r.target.position.x}_${r.target.position.y}_${r.target.owner.name}`:`unit_${r.target.position.x}_${r.target.position.y}_${r.target.owner.name}`;this.addDamageNumber(r.target.position,25,t,r.target.health,e)}break}if("sun"===r.type||"edge"===r.type)break;"asteroid"===r.type&&(o++,i=r.pos,s=new v(-s.x,-s.y))}t.setBeamSegments(e)}rayIntersectsAsteroid(t,e,i){const s=new v(i.position.x-t.x,i.position.y-t.y),o=s.x*e.x+s.y*e.y;if(o<0)return null;const n=new v(t.x+e.x*o,t.y+e.y*o);return n.distanceTo(i.position)<60?n:null}rayIntersectsUnit(t,e,i,s=8){const o=new v(i.x-t.x,i.y-t.y),n=o.x*e.x+o.y*e.y;if(n<0)return null;const r=new v(t.x+e.x*n,t.y+e.y*n);return r.distanceTo(i)<s?r:null}rayIntersectsEdge(t,e){const i=this.mapSize;let s=null,o=1/0;const n=[{x:0,normal:new v(1,0)},{x:i,normal:new v(-1,0)},{y:0,normal:new v(0,1)},{y:i,normal:new v(0,-1)}];for(const i of n){let n=null;if("x"in i&&void 0!==i.x){if(Math.abs(e.x)>.001){const s=(i.x-t.x)/e.x;s>0&&(n=new v(i.x,t.y+e.y*s))}}else if("y"in i&&void 0!==i.y&&Math.abs(e.y)>.001){const s=(i.y-t.y)/e.y;s>0&&(n=new v(t.x+e.x*s,i.y))}if(n){const e=t.distanceTo(n);e<o&&(o=e,s=n)}}return s}processTurretDeployment(t){let e=null,i=1/0;for(const s of this.asteroids){const o=t.position.distanceTo(s.position);o<i&&o<200&&(i=o,e=s)}if(e){const i=new et(new v(e.position.x,e.position.y),t.owner,e);this.deployedTurrets.push(i)}}processDrillerCollisions(t,e){for(const e of this.suns)if(t.position.distanceTo(e.position)<e.radius+10)return t.health=0,void t.stopDrilling();for(const e of this.asteroids)if(e.containsPoint(t.position))return t.hideInAsteroid(e),void t.stopDrilling();for(const e of this.players)if(e!==t.owner){for(const i of e.units)if(t.position.distanceTo(i.position)<15){i.takeDamage(30);const t=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,30,i.maxHealth,i.health,t)}for(const i of e.buildings)if(t.position.distanceTo(i.position)<40){const t=60;i.takeDamage(t);const s=`building_${i.position.x}_${i.position.y}_${e.name}`;this.addDamageNumber(i.position,t,i.maxHealth,i.health,s)}if(e.stellarForge&&t.position.distanceTo(e.stellarForge.position)<e.stellarForge.radius+10){const t=60;e.stellarForge.health-=t;const i=`forge_${e.stellarForge.position.x}_${e.stellarForge.position.y}_${e.name}`;this.addDamageNumber(e.stellarForge.position,t,u,e.stellarForge.health,i)}}const i=this.mapSize;if(t.position.x<0||t.position.x>i||t.position.y<0||t.position.y>i){const s=Math.sqrt(Math.pow(t.drillVelocity.x,2)+Math.pow(t.drillVelocity.y,2));if(s>0){const i=200*e,o=Math.max(0,s-i);0===o?t.stopDrilling():(t.drillVelocity.x=t.drillVelocity.x/s*o,t.drillVelocity.y=t.drillVelocity.y/s*o)}t.position.x=Math.max(0,Math.min(i,t.position.x)),t.position.y=Math.max(0,Math.min(i,t.position.y))}}resolveUnitCollisions(t){for(let e=0;e<t.length;e++){const i=t[e];if(!i.isDead())for(let s=e+1;s<t.length;s++){const o=t[s];if(o.isDead())continue;let n=o.position.x-i.position.x,r=o.position.y-i.position.y,a=n*n+r*r;0===a&&(n=e%2==0?1:-1,r=0,a=1);const l=i.collisionRadiusPx+o.collisionRadiusPx;if(a<l*l){const t=Math.sqrt(a),e=l-t,s=n/t*e,h=r/t*e;i.isHero&&!o.isHero?(o.position.x+=s,o.position.y+=h):!i.isHero&&o.isHero?(i.position.x-=s,i.position.y-=h):(i.position.x-=.5*s,i.position.y-=.5*h,o.position.x+=.5*s,o.position.y+=.5*h)}}}}resolveUnitObstacleCollisions(t){for(const e of t){if(e.isDead())continue;const t=new v(e.position.x,e.position.y);if(this.checkCollision(e.position,e.collisionRadiusPx)){let i=0,s=0,o=0;for(const t of this.asteroids){const n=e.position.x-t.position.x,r=e.position.y-t.position.y,a=n*n+r*r,l=t.size+e.collisionRadiusPx+12;if(a<l*l||t.containsPoint(e.position)){const t=Math.sqrt(a)||1,e=(l-t)/l;i+=n/t*e,s+=r/t*e,o++}}for(const t of this.players)if(t.stellarForge){const n=t.stellarForge,r=e.position.x-n.position.x,a=e.position.y-n.position.y,l=Math.sqrt(r*r+a*a),h=n.radius+e.collisionRadiusPx;if(l<h){const t=(h-l)/h;i+=r/l*t,s+=a/l*t,o++}}for(const t of this.players)for(const n of t.solarMirrors){if(n.owner===e.owner)continue;const t=e.position.x-n.position.x,r=e.position.y-n.position.y,a=Math.sqrt(t*t+r*r),l=20+e.collisionRadiusPx;if(a<l){const e=(l-a)/l;i+=t/a*e,s+=r/a*e,o++}}for(const t of this.players)for(const n of t.buildings){const t=e.position.x-n.position.x,r=e.position.y-n.position.y,a=Math.sqrt(t*t+r*r),l=n.radius+e.collisionRadiusPx;if(a<l){const e=(l-a)/l;i+=t/a*e,s+=r/a*e,o++}}if(o>0){const o=Math.sqrt(i*i+s*s);if(o>0){const n=Math.min(this.MAX_PUSH_DISTANCE,o*this.PUSH_MULTIPLIER);e.position.x=t.x+i/o*n,e.position.y=t.y+s/o*n}}this.checkCollision(e.position,e.collisionRadiusPx)&&(e.position=t,e.rallyPoint&&this.checkCollision(e.rallyPoint,e.collisionRadiusPx)&&(e.rallyPoint=null))}this.clampUnitOutsideStructures(e)}}clampUnitOutsideStructures(t){for(const e of this.players){e.stellarForge&&this.pushUnitOutsideCircle(t,e.stellarForge.position,e.stellarForge.radius);for(const i of e.buildings)this.pushUnitOutsideCircle(t,i.position,i.radius)}}pushUnitOutsideCircle(t,e,i){const s=i+t.collisionRadiusPx+4,o=t.position.x-e.x,n=t.position.y-e.y,r=o*o+n*n;if(r<s*s){const i=Math.sqrt(r);if(i>0){const r=s/i;t.position.x=e.x+o*r,t.position.y=e.y+n*r}else t.position.x=e.x+s,t.position.y=e.y}}createHeroUnit(t,e,i){switch(t){case"Marine":return new X(e,i);case"Grave":return new q(e,i);case"Ray":return new Z(e,i);case"InfluenceBall":return new tt(e,i);case"TurretDeployer":return new it(e,i);case"Driller":return new st(e,i);case"Dagger":return new ot(e,i);case"Beam":return new nt(e,i);default:return null}}checkCollision(t,e=10,i=null){for(const e of this.asteroids)if(e.containsPoint(t))return!0;for(const s of this.players){if(s.stellarForge){if(s.stellarForge===i)continue;if(t.distanceTo(s.stellarForge.position)<s.stellarForge.radius+e)return!0}for(const o of s.solarMirrors)if(o!==i&&t.distanceTo(o.position)<20+e)return!0;for(const o of s.buildings)if(o!==i&&t.distanceTo(o.position)<o.radius+e)return!0}return!1}updateStateHash(){var t;let e=2166136261;const i=t=>{const i=Math.floor(100*t);e=Math.imul(e^i,16777619)},s=t=>{e=Math.imul(e^t,16777619)},o=t=>{s(t.length);for(let e=0;e<t.length;e++)s(t.charCodeAt(e))};i(this.gameTime),i(this.suns.length),i(this.asteroids.length),s(this.spaceDust.length);for(const t of this.spaceDust)i(t.position.x),i(t.position.y),i(t.velocity.x),i(t.velocity.y),i(t.glowTransition),s(t.glowState),s(t.targetGlowState),o(t.baseColor);for(const e of this.players){if(i(e.energy),s(e.isAi?1:0),i(e.aiNextMirrorCommandSec),i(e.aiNextDefenseCommandSec),i(e.aiNextHeroCommandSec),i(e.aiNextStructureCommandSec),i(e.aiNextMirrorPurchaseCommandSec),o(e.aiStrategy),e.stellarForge){i(e.stellarForge.position.x),i(e.stellarForge.position.y),i(e.stellarForge.health),s(e.stellarForge.unitQueue.length);for(const t of e.stellarForge.unitQueue)o(t);o(null!==(t=e.stellarForge.heroProductionUnitType)&&void 0!==t?t:""),i(e.stellarForge.heroProductionRemainingSec),i(e.stellarForge.heroProductionDurationSec),i(e.stellarForge.crunchTimer),i(e.stellarForge.rotation),e.stellarForge.targetPosition?(i(e.stellarForge.targetPosition.x),i(e.stellarForge.targetPosition.y)):(i(-1),i(-1)),i(e.stellarForge.velocity.x),i(e.stellarForge.velocity.y)}else i(-1);for(const t of e.solarMirrors)i(t.position.x),i(t.position.y),i(t.health),i(t.efficiency),i(t.reflectionAngle),t.targetPosition?(i(t.targetPosition.x),i(t.targetPosition.y)):(i(-1),i(-1)),i(t.velocity.x),i(t.velocity.y);for(const t of e.units)i(t.position.x),i(t.position.y),i(t.velocity.x),i(t.velocity.y),i(t.health),i(t.isHero?1:0),i(t.collisionRadiusPx),s(t.moveOrder),t.rallyPoint?(i(t.rallyPoint.x),i(t.rallyPoint.y)):(i(-1),i(-1)),t instanceof Y&&(s(t.getAssignedPathLength()),s(t.getCurrentPathWaypointIndex()),s(t.hasActiveManualOrder()?1:0));for(const t of e.buildings)i(t.position.x),i(t.position.y),i(t.health),i(t.isComplete?1:0)}s(this.minionProjectiles.length);for(const t of this.minionProjectiles)i(t.position.x),i(t.position.y),i(t.velocity.x),i(t.velocity.y),i(t.damage),i(t.distanceTraveledPx),i(t.maxRangePx),s(this.players.indexOf(t.owner));this.stateHash=e>>>0}initializeSpaceDust(t,e,i,s){this.spaceDust=[];for(let o=0;o<t;o++){const t=(Math.random()-.5)*e,o=(Math.random()-.5)*i;this.spaceDust.push(new H(new v(t,o),void 0,s))}}initializeAsteroids(t,e,i){this.asteroids=[];for(let s=0;s<t;s++){let t=!1,s=0,o=0,n=0,r=0;for(;!t&&s<50;){const a=Math.random()*Math.PI*2,l=200+Math.random()*(Math.min(e,i)/2-300);o=Math.cos(a)*l,n=Math.sin(a)*l,r=30+50*Math.random(),t=!0;for(const e of this.asteroids){const i=o-e.position.x,s=n-e.position.y;if(Math.sqrt(i*i+s*s)<r+e.size){t=!1;break}}s++}if(t){const t=3+Math.floor(7*Math.random());this.asteroids.push(new T(new v(o,n),t,r))}}}checkVictoryConditions(){const t=this.players.filter(t=>!t.isDefeated());return 1===t.length?t[0]:null}initializePlayer(t,e,i){t.stellarForge=new D(e,t);for(const e of i){const i=new A(e,t);t.solarMirrors.push(i)}}addDamageNumber(t,e,i,s,o=null){const n=Math.max(0,s);"remaining-life"===this.damageDisplayMode&&null!==o&&(this.damageNumbers=this.damageNumbers.filter(t=>t.unitId!==o)),this.damageNumbers.push(new rt(t,e,this.gameTime,i,n,o))}}class lt{constructor(t){this.particles=[],this.attractionMatrix=[],this.animationFrameId=null,this.isActive=!1,this.lastColorChangeMs=0,this.gradientColors=[[138,43,226],[147,51,234],[219,39,119],[236,72,153],[59,130,246],[14,165,233],[168,85,247],[192,132,252]],this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="-1";const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to create background particle canvas context. This may be due to browser compatibility or system limitations.");this.context=e,t.appendChild(this.canvas),this.resize(),this.initializeParticles(),this.initializeAttractionMatrix(),this.start()}initializeParticles(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);this.particles=[];for(let i=0;i<lt.PARTICLE_COUNT;i++){const s=this.gradientColors[i%this.gradientColors.length],o={x:Math.random()*t,y:Math.random()*e,velocityX:.5*(Math.random()-.5),velocityY:.5*(Math.random()-.5),colorR:s[0],colorG:s[1],colorB:s[2],targetColorR:s[0],targetColorG:s[1],targetColorB:s[2],radius:lt.PARTICLE_RADIUS};this.particles.push(o)}}initializeAttractionMatrix(){this.attractionMatrix=[];for(let t=0;t<lt.PARTICLE_COUNT;t++){this.attractionMatrix[t]=[];for(let e=0;e<lt.PARTICLE_COUNT;e++)this.attractionMatrix[t][e]=t===e?0:(Math.random()-.5)*lt.ATTRACTION_STRENGTH}}resize(){const t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.canvas.width=Math.round(e*t),this.canvas.height=Math.round(i*t),this.context.setTransform(t,0,0,t,0,0)}start(){this.isActive||(this.isActive=!0,this.lastColorChangeMs=performance.now(),this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animate(){if(!this.isActive)return;const t=performance.now();t-this.lastColorChangeMs>=lt.COLOR_CHANGE_INTERVAL_MS&&(this.updateTargetColors(),this.lastColorChangeMs=t),this.updateParticles(),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.animate())}updateTargetColors(){for(let t=0;t<this.particles.length;t++){const e=Math.floor(Math.random()*this.gradientColors.length),i=this.gradientColors[e];this.particles[t].targetColorR=i[0],this.particles[t].targetColorG=i[1],this.particles[t].targetColorB=i[2]}}updateParticles(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);for(let i=0;i<this.particles.length;i++){const s=this.particles[i];for(let t=0;t<this.particles.length;t++){if(i===t)continue;const e=this.particles[t],o=e.x-s.x,n=e.y-s.y,r=Math.sqrt(o*o+n*n);if(r>0){const e=this.attractionMatrix[i][t],a=o/r*e,l=n/r*e;s.velocityX+=a,s.velocityY+=l}}s.velocityX*=lt.FRICTION,s.velocityY*=lt.FRICTION;const o=Math.sqrt(s.velocityX*s.velocityX+s.velocityY*s.velocityY);o>lt.MAX_VELOCITY&&(s.velocityX=s.velocityX/o*lt.MAX_VELOCITY,s.velocityY=s.velocityY/o*lt.MAX_VELOCITY),s.x+=s.velocityX,s.y+=s.velocityY,s.x<-s.radius&&(s.x=t+s.radius),s.x>t+s.radius&&(s.x=-s.radius),s.y<-s.radius&&(s.y=e+s.radius),s.y>e+s.radius&&(s.y=-s.radius),s.colorR+=(s.targetColorR-s.colorR)*lt.COLOR_TRANSITION_SPEED,s.colorG+=(s.targetColorG-s.colorG)*lt.COLOR_TRANSITION_SPEED,s.colorB+=(s.targetColorB-s.colorB)*lt.COLOR_TRANSITION_SPEED}}render(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);this.context.fillStyle="#000000",this.context.fillRect(0,0,t,e),this.context.filter="blur(60px)",this.context.globalCompositeOperation="screen";for(const t of this.particles){const e=this.context.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius),i=Math.round(t.colorR),s=Math.round(t.colorG),o=Math.round(t.colorB);e.addColorStop(0,`rgba(${i}, ${s}, ${o}, 0.4)`),e.addColorStop(1,`rgba(${i}, ${s}, ${o}, 0)`),this.context.fillStyle=e,this.context.beginPath(),this.context.arc(t.x,t.y,t.radius,0,2*Math.PI),this.context.fill()}this.context.filter="none",this.context.globalCompositeOperation="source-over"}destroy(){this.stop(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas)}}lt.PARTICLE_COUNT=8,lt.PARTICLE_RADIUS=250,lt.MAX_VELOCITY=.3,lt.FRICTION=.98,lt.COLOR_TRANSITION_SPEED=.002,lt.ATTRACTION_STRENGTH=.15,lt.COLOR_CHANGE_INTERVAL_MS=8e3;class ht{constructor(t,e){this.asteroids=[],this.animationFrameId=null,this.isActive=!1,this.widthPx=0,this.heightPx=0,this.container=t,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="0",this.canvas.style.opacity="0.2";const i=this.canvas.getContext("2d");if(!i)throw new Error("Unable to create menu atmosphere canvas context.");this.context=i,this.sunSprite=new Image,this.sunSprite.src=e,this.container.appendChild(this.canvas),this.resize(),this.initializeAsteroids(),this.start()}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resize(){const t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.widthPx=e,this.heightPx=i,this.canvas.width=Math.round(e*t),this.canvas.height=Math.round(i*t),this.context.setTransform(t,0,0,t,0,0)}destroy(){this.stop(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas)}initializeAsteroids(){this.asteroids=[];for(let t=0;t<ht.ASTEROID_COUNT;t++)this.asteroids.push(this.createAsteroid())}createAsteroid(){const t=this.randomRange(ht.ASTEROID_MIN_RADIUS_PX,ht.ASTEROID_MAX_RADIUS_PX),e=this.createSpawnPosition(),i=this.createVelocity(),s=this.randomRange(ht.ASTEROID_ROTATION_MIN_RAD,ht.ASTEROID_ROTATION_MAX_RAD),o=[],n=7+Math.floor(4*Math.random());for(let t=0;t<n;t++)o.push({angleRad:2*Math.PI*t/n,radiusScale:.7+.5*Math.random()});return{x:e.x,y:e.y,radiusPx:t,velocityX:i.x,velocityY:i.y,rotationRad:Math.random()*Math.PI*2,rotationSpeedRad:s*(Math.random()>.5?1:-1),points:o}}createSpawnPosition(){const t=ht.BOUNDS_MARGIN_PX;return Math.random()<.5?{x:this.randomRange(-t,this.widthPx+t),y:this.randomRange(.6*-t,.7*this.heightPx)}:{x:this.randomRange(-t,.7*this.widthPx),y:this.randomRange(-t,this.heightPx+t)}}createVelocity(){const t=this.randomRange(ht.ASTEROID_SPEED_MIN,ht.ASTEROID_SPEED_MAX),e=Math.random()*Math.PI*2;return{x:Math.cos(e)*t,y:Math.sin(e)*t}}animate(){this.isActive&&(this.updateAsteroids(),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.animate()))}updateAsteroids(){const t=ht.BOUNDS_MARGIN_PX,e=-t,i=-t,s=this.widthPx+t,o=this.heightPx+t;for(const t of this.asteroids)if(t.x+=t.velocityX,t.y+=t.velocityY,t.rotationRad+=t.rotationSpeedRad,t.x<e||t.x>s||t.y<i||t.y>o){const e=this.createSpawnPosition(),i=this.createVelocity();t.x=e.x,t.y=e.y,t.velocityX=i.x,t.velocityY=i.y}}render(){this.context.clearRect(0,0,this.widthPx,this.heightPx),this.renderSunGlow(),this.renderAsteroids()}renderSunGlow(){const t=this.getSunCenter(),e=this.context.createRadialGradient(t.x,t.y,.35*ht.SUN_RADIUS_PX,t.x,t.y,ht.SUN_GLOW_RADIUS_PX);if(e.addColorStop(0,"rgba(255, 240, 200, 0.9)"),e.addColorStop(.4,"rgba(255, 200, 120, 0.5)"),e.addColorStop(.7,"rgba(255, 150, 80, 0.25)"),e.addColorStop(1,"rgba(255, 120, 40, 0)"),this.context.fillStyle=e,this.context.beginPath(),this.context.arc(t.x,t.y,ht.SUN_GLOW_RADIUS_PX,0,2*Math.PI),this.context.fill(),this.sunSprite.complete&&this.sunSprite.naturalWidth>0){const e=2*ht.SUN_RADIUS_PX;this.context.drawImage(this.sunSprite,t.x-ht.SUN_RADIUS_PX,t.y-ht.SUN_RADIUS_PX,e,e)}else this.context.fillStyle="rgba(255, 215, 120, 0.95)",this.context.beginPath(),this.context.arc(t.x,t.y,ht.SUN_RADIUS_PX,0,2*Math.PI),this.context.fill()}renderAsteroids(){const t=this.getSunCenter();for(const e of this.asteroids){const i=this.getAsteroidPoints(e);this.renderAsteroidShadow(e,i,t),this.renderAsteroidBody(e,i)}}renderAsteroidShadow(t,e,i){const s=this.getShadowOffset(t,i),o=ht.SHADOW_LENGTH_BASE_PX+t.radiusPx*ht.SHADOW_LENGTH_MULTIPLIER;this.context.fillStyle="rgba(20, 14, 12, 0.45)",this.context.beginPath();for(let t=0;t<e.length;t++){const i=e[t];0===t?this.context.moveTo(i.x,i.y):this.context.lineTo(i.x,i.y)}for(let t=e.length-1;t>=0;t--){const i=e[t];this.context.lineTo(i.x+s.x*o,i.y+s.y*o)}this.context.closePath(),this.context.fill()}renderAsteroidBody(t,e){this.context.fillStyle="rgba(170, 160, 140, 0.8)",this.context.beginPath();for(let t=0;t<e.length;t++){const i=e[t];0===t?this.context.moveTo(i.x,i.y):this.context.lineTo(i.x,i.y)}this.context.closePath(),this.context.fill(),this.context.strokeStyle="rgba(120, 105, 90, 0.65)",this.context.lineWidth=1,this.context.stroke()}getSunCenter(){return{x:ht.SUN_RADIUS_PX+ht.SUN_OFFSET_X_PX,y:ht.SUN_RADIUS_PX+ht.SUN_OFFSET_Y_PX}}getShadowOffset(t,e){const i=t.x-e.x,s=t.y-e.y,o=Math.max(1,Math.hypot(i,s));return{x:i/o,y:s/o}}getAsteroidPoints(t){const e=[],i=t.points;for(let s=0;s<i.length;s++){const o=i[s],n=o.angleRad+t.rotationRad,r=t.radiusPx*o.radiusScale;e.push({x:t.x+Math.cos(n)*r,y:t.y+Math.sin(n)*r})}return e}randomRange(t,e){return t+Math.random()*(e-t)}}ht.ASTEROID_COUNT=14,ht.ASTEROID_MIN_RADIUS_PX=6,ht.ASTEROID_MAX_RADIUS_PX=16,ht.ASTEROID_SPEED_MIN=.06,ht.ASTEROID_SPEED_MAX=.18,ht.ASTEROID_ROTATION_MIN_RAD=.004,ht.ASTEROID_ROTATION_MAX_RAD=.014,ht.SUN_RADIUS_PX=120,ht.SUN_GLOW_RADIUS_PX=320,ht.SUN_OFFSET_X_PX=-28,ht.SUN_OFFSET_Y_PX=-22,ht.SHADOW_LENGTH_BASE_PX=120,ht.SHADOW_LENGTH_MULTIPLIER=7.5,ht.BOUNDS_MARGIN_PX=80;class ct{constructor(t){this.particles=[],this.animationFrameId=null,this.isActive=!1,this.needsTargetRefresh=!1,this.lastTargetRefreshMs=0,this.targetRefreshContainer=null,this.densityMultiplier=1,this.desiredParticleCount=0,this.menuContentElement=null,this.particleOpacity=ct.BASE_PARTICLE_OPACITY,this.menuOpacity=1,this.transitionStartMs=null,this.container=t,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="2";const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to create menu particle canvas context.");this.context=e,this.offscreenCanvas=document.createElement("canvas");const i=this.offscreenCanvas.getContext("2d");if(!i)throw new Error("Unable to create offscreen particle canvas context.");this.offscreenContext=i,this.container.appendChild(this.canvas),requestAnimationFrame(()=>{try{this.resize()}catch(t){console.error("Failed to resize particle canvas:",t)}}),this.start()}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resize(){const t=this.container.getBoundingClientRect(),e=window.devicePixelRatio||1,i=t.width||window.innerWidth,s=t.height||window.innerHeight;this.canvas.width=Math.round(i*e),this.canvas.height=Math.round(s*e),this.context.setTransform(e,0,0,e,0,0)}setMenuContentElement(t){this.menuContentElement=t,this.applyMenuOpacity()}requestTargetRefresh(t){this.needsTargetRefresh=!0,this.targetRefreshContainer=t}clearTargets(){this.setTargets([])}setDensityMultiplier(t){this.densityMultiplier=Math.max(.5,t)}startTransition(){this.transitionStartMs=performance.now()}animate(){if(!this.isActive)return;const t=performance.now();this.needsTargetRefresh&&this.targetRefreshContainer&&t-this.lastTargetRefreshMs>=ct.REFRESH_INTERVAL_MS&&(this.updateTargetsFromElements(this.targetRefreshContainer),this.lastTargetRefreshMs=t,this.needsTargetRefresh=!1),this.updateParticles(t),this.renderParticles(),this.animationFrameId=requestAnimationFrame(()=>this.animate())}updateTargetsFromElements(t){const e=this.collectTargets(t);this.setTargets(e)}setTargets(t){const e=[],i=t.length;if(0===i)return this.particles=e,void(this.desiredParticleCount=0);this.desiredParticleCount=i;const s=this.desiredParticleCount,o=this.particles.slice();for(o.length>s&&(o.length=s);o.length<s;){const e=t[o.length%i];o.push(this.createParticle(e.x,e.y,e.color))}for(let n=0;n<s;n++){const s=t[n%i],r=o[n],a=this.getRelocatedTarget(s);r.targetX=a.x,r.targetY=a.y,r.baseTargetX=a.x,r.baseTargetY=a.y;const l=this.parseColor(s.color);r.targetColorR=l.r,r.targetColorG=l.g,r.targetColorB=l.b,r.sizePx=ct.PARTICLE_SIZE_PX,e.push(r)}this.particles=e}createParticle(t,e,i){const s=Math.random()*Math.PI*2,o=ct.DRIFT_RADIUS_MIN_PX+Math.random()*(ct.DRIFT_RADIUS_MAX_PX-ct.DRIFT_RADIUS_MIN_PX),n=.8+.4*Math.random(),r=this.parseColor(i);return{x:t,y:e,velocityX:0,velocityY:0,targetX:t,targetY:e,baseTargetX:t,baseTargetY:e,colorR:r.r,colorG:r.g,colorB:r.b,targetColorR:r.r,targetColorG:r.g,targetColorB:r.b,sizePx:ct.PARTICLE_SIZE_PX,driftPhase:s,driftRadiusPx:o,speedMultiplier:n}}getRelocatedTarget(t){const e=ct.RELOCATE_MIN_DISTANCE_PX,i=ct.RELOCATE_MAX_DISTANCE_PX,s=e+Math.random()*(i-e),o=Math.random()*Math.PI*2;return{x:t.x+Math.cos(o)*s,y:t.y+Math.sin(o)*s}}updateParticles(t){this.updateTransition(t);const e=t*ct.DRIFT_SPEED;for(const t of this.particles){const i=e*t.speedMultiplier,s=Math.cos(t.driftPhase+i)*t.driftRadiusPx,o=Math.sin(t.driftPhase+i)*t.driftRadiusPx;t.baseTargetX=t.targetX+s,t.baseTargetY=t.targetY+o;const n=t.baseTargetX-t.x,r=t.baseTargetY-t.y,a=ct.POSITION_SMOOTHING*t.speedMultiplier;t.velocityX+=n*a,t.velocityY+=r*a,t.velocityX*=.82,t.velocityY*=.82,t.x+=t.velocityX,t.y+=t.velocityY,t.colorR+=(t.targetColorR-t.colorR)*ct.COLOR_SMOOTHING,t.colorG+=(t.targetColorG-t.colorG)*ct.COLOR_SMOOTHING,t.colorB+=(t.targetColorB-t.colorB)*ct.COLOR_SMOOTHING}}updateTransition(t){if(null===this.transitionStartMs)return this.particleOpacity=ct.BASE_PARTICLE_OPACITY,this.menuOpacity=1,void this.applyMenuOpacity();const e=t-this.transitionStartMs,i=ct.TRANSITION_DURATION_MS,s=i/2;if(e>=i)return this.transitionStartMs=null,this.particleOpacity=ct.BASE_PARTICLE_OPACITY,this.menuOpacity=1,void this.applyMenuOpacity();if(e<=s){const t=e/s;this.particleOpacity=ct.BASE_PARTICLE_OPACITY+(ct.PEAK_PARTICLE_OPACITY-ct.BASE_PARTICLE_OPACITY)*t,this.menuOpacity=1-t}else{const t=(e-s)/s;this.particleOpacity=ct.PEAK_PARTICLE_OPACITY+(ct.BASE_PARTICLE_OPACITY-ct.PEAK_PARTICLE_OPACITY)*t,this.menuOpacity=t}this.applyMenuOpacity()}applyMenuOpacity(){this.menuContentElement&&(this.menuContentElement.style.opacity=this.menuOpacity.toFixed(3))}renderParticles(){const t=this.container.getBoundingClientRect(),e=t.width||window.innerWidth,i=t.height||window.innerHeight;this.context.clearRect(0,0,e,i),this.context.globalCompositeOperation="lighter",this.context.globalAlpha=this.particleOpacity;for(const t of this.particles){const e=Math.min(255,Math.max(0,Math.round(t.colorR))),i=Math.min(255,Math.max(0,Math.round(t.colorG))),s=Math.min(255,Math.max(0,Math.round(t.colorB)));this.context.fillStyle=`rgb(${e}, ${i}, ${s})`,this.context.beginPath(),this.context.arc(t.x,t.y,t.sizePx,0,2*Math.PI),this.context.fill()}this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over"}collectTargets(t){const e=Array.from(t.querySelectorAll("[data-particle-text], [data-particle-box]")),i=[];for(const t of e)void 0!==t.dataset.particleText&&i.push(...this.collectTextTargets(t)),void 0!==t.dataset.particleBox&&i.push(...this.collectBoxTargets(t));return i}collectTextTargets(t){var e;const i=null===(e=t.textContent)||void 0===e?void 0:e.trim();if(!i)return[];const s=t.getBoundingClientRect();if(s.width<=0||s.height<=0)return[];const o=window.getComputedStyle(t),n=Number.parseFloat(o.fontSize)||16,r=o.fontFamily||"Arial, sans-serif",a=o.fontWeight||"600",l=t.dataset.particleColor||"#FFFFFF",h=Math.max(3,Math.round(n/7.5)),c=Math.max(2,Math.round(h/this.densityMultiplier));this.offscreenCanvas.width=Math.ceil(s.width),this.offscreenCanvas.height=Math.ceil(s.height),this.offscreenContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.offscreenContext.font=`${a} ${n}px ${r}`,this.offscreenContext.textAlign="center",this.offscreenContext.textBaseline="middle",this.offscreenContext.fillStyle="#FFFFFF",this.offscreenContext.fillText(i,this.offscreenCanvas.width/2,this.offscreenCanvas.height/2);const d=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height).data,g=[],u=c/2;for(let t=c/2;t<this.offscreenCanvas.height;t+=c)for(let e=u;e<this.offscreenCanvas.width;e+=c)d[4*(Math.floor(t)*this.offscreenCanvas.width+Math.floor(e))+3]>80&&g.push({x:s.left+e,y:s.top+t,color:l});return g}collectBoxTargets(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return[];const i=t.dataset.particleColor||"#FFFFFF",s=Math.max(6,Math.round(Math.min(e.width,e.height)/12)),o=Math.max(3,Math.round(s/this.densityMultiplier)),n=[],r=e.left,a=e.right,l=e.top,h=e.bottom;for(let t=r;t<=a;t+=o)n.push({x:t,y:l,color:i}),n.push({x:t,y:h,color:i});for(let t=l;t<=h;t+=o)n.push({x:r,y:t,color:i}),n.push({x:a,y:t,color:i});return n}parseColor(t){const e=t.trim();if(e.startsWith("#")){const t=e.slice(1);if(3===t.length)return{r:Number.parseInt(t[0]+t[0],16),g:Number.parseInt(t[1]+t[1],16),b:Number.parseInt(t[2]+t[2],16)};if(6===t.length)return{r:Number.parseInt(t.slice(0,2),16),g:Number.parseInt(t.slice(2,4),16),b:Number.parseInt(t.slice(4,6),16)}}return{r:255,g:255,b:255}}}ct.REFRESH_INTERVAL_MS=140,ct.POSITION_SMOOTHING=.08/14,ct.DRIFT_SPEED=7e-4/6,ct.DRIFT_RADIUS_MIN_PX=.03,ct.DRIFT_RADIUS_MAX_PX=.11,ct.COLOR_SMOOTHING=.08,ct.PARTICLE_SIZE_PX=1.6,ct.RELOCATE_MIN_DISTANCE_PX=4,ct.RELOCATE_MAX_DISTANCE_PX=12,ct.BASE_PARTICLE_OPACITY=.15,ct.PEAK_PARTICLE_OPACITY=.4,ct.TRANSITION_DURATION_MS=600;const dt={SpaceBlack:{id:"SpaceBlack",name:"Space Black",background:"#000000",asteroidColors:{fillStart:"#878787",fillEnd:"#505050",strokeStart:"#9B9B9B",strokeEnd:"#646464"},spaceDustPalette:{neutral:["#5a5a5a","#6c6c6c","#7f7f7f","#8f8f8f"],accent:["#5b6c8f","#6a5f8f","#7a6aa6"]},sunCore:{inner:"rgba(255, 255, 255, 1)",mid:"rgba(255, 230, 120, 1)",outer:"rgba(255, 180, 50, 0.9)"},sunGlow:{outerGlow1:"rgba(255, 220, 100, 0.8)",outerGlow2:"rgba(255, 180, 50, 0.4)",outerGlow3:"rgba(255, 140, 30, 0.2)",outerGlow4:"rgba(255, 100, 0, 0)"},sunLightRays:{nearCenter:"rgba(255, 245, 215, 0.35)",mid:"rgba(255, 220, 170, 0.18)",edge:"rgba(255, 200, 140, 0)"},lensFlareHalo:"rgba(255, 240, 200, 0.15)"},ColdIce:{id:"ColdIce",name:"Cold Ice",background:"#0B1426",asteroidColors:{fillStart:"#4A3B6E",fillEnd:"#7B63A6",strokeStart:"#6A52A0",strokeEnd:"#B39DE6"},spaceDustPalette:{neutral:["#6D717B","#7C808A","#8A8D97","#9A9EB0"],accent:["#6C5A91","#7B66A8","#8B75C3","#9A82D6"]},sunCore:{inner:"rgba(230, 245, 255, 1)",mid:"rgba(190, 220, 255, 0.95)",outer:"rgba(150, 200, 255, 0.85)"},sunGlow:{outerGlow1:"rgba(200, 230, 255, 0.75)",outerGlow2:"rgba(160, 210, 255, 0.45)",outerGlow3:"rgba(120, 190, 255, 0.25)",outerGlow4:"rgba(80, 170, 255, 0)"},sunLightRays:{nearCenter:"rgba(220, 240, 255, 0.35)",mid:"rgba(170, 215, 255, 0.18)",edge:"rgba(130, 190, 255, 0)"},lensFlareHalo:"rgba(210, 235, 255, 0.18)"}};class gt{constructor(){this.backgroundParticleLayer=null,this.atmosphereLayer=null,this.menuParticleLayer=null,this.resizeHandler=null,this.onStartCallback=null,this.currentScreen="main",this.carouselMenu=null,this.factionCarousel=null,this.testLevelButton=null,this.heroUnits=[{id:"radiant-marine",name:"Marine",description:"Rapid-fire ranged specialist",faction:M.RADIANT,maxHealth:100,attackDamage:10,attackSpeed:5,attackRange:300,attackIgnoresDefense:!1,defense:10,regen:4,abilityDescription:"Bullet storm: fires a spread of shots toward a target direction"},{id:"radiant-grave",name:"Grave",description:"Gravitic sentinel with orbiting projectiles",faction:M.RADIANT,maxHealth:150,attackDamage:15,attackSpeed:2,attackRange:100,attackIgnoresDefense:!1,defense:18,regen:3,abilityDescription:"Orbits gravitic shards that launch at targets and return"},{id:"radiant-ray",name:"Ray",description:"Bouncing beam marks targets",faction:M.RADIANT,maxHealth:120,attackDamage:8,attackSpeed:3,attackRange:250,attackIgnoresDefense:!0,defense:8,regen:5,abilityDescription:"Solar ricochet: beam bounces between multiple enemies"},{id:"radiant-influence-ball",name:"Influence Ball",description:"Deploys temporary influence zones",faction:M.RADIANT,maxHealth:100,attackDamage:5,attackSpeed:1.5,attackRange:200,attackIgnoresDefense:!1,defense:12,regen:6,abilityDescription:"Influence surge: expand an influence zone at target location"},{id:"radiant-turret-deployer",name:"Turret Deployer",description:"Deploys automated turrets on asteroids",faction:M.RADIANT,maxHealth:90,attackDamage:6,attackSpeed:2,attackRange:180,attackIgnoresDefense:!1,defense:14,regen:4,abilityDescription:"Deploy turret: places a turret on a nearby asteroid"},{id:"radiant-driller",name:"Driller",description:"Burrows through asteroids to flank",faction:M.RADIANT,maxHealth:140,attackDamage:0,attackSpeed:0,attackRange:0,attackIgnoresDefense:!1,defense:16,regen:3,abilityDescription:"Drill charge: tunnels through an asteroid toward the target"},{id:"radiant-dagger",name:"Dagger",description:"Cloaked assassin with burst damage",faction:M.RADIANT,maxHealth:80,attackDamage:35,attackSpeed:1.5,attackRange:100,attackIgnoresDefense:!1,defense:5,regen:3,abilityDescription:"Shadow strike: short-range burst attack, reveals Dagger for 8 seconds"},{id:"radiant-beam",name:"Beam",description:"Sniper with distance-based damage multiplier",faction:M.RADIANT,maxHealth:70,attackDamage:20,attackSpeed:1,attackRange:150,attackIgnoresDefense:!0,defense:6,regen:3,abilityDescription:"Precision shot: long-range beam that does more damage at greater distances"}],this.availableMaps=[{id:"standard",name:"Standard Battle",description:"Classic 1v1 map with a single sun at the center. Balanced gameplay with moderate obstacles.",numSuns:1,numAsteroids:10,mapSize:2e3},{id:"test-level",name:"Test Level",description:"Minimal layout for AI testing with a single sun, mirrored bases, and no asteroids.",numSuns:1,numAsteroids:0,mapSize:2e3},{id:"twin-suns",name:"Twin Suns",description:"Two suns create complex lighting patterns. Control multiple light sources for economic dominance.",numSuns:2,numAsteroids:12,mapSize:2500},{id:"asteroid-field",name:"Asteroid Field",description:"Dense asteroid field creates tactical challenges. Careful mirror placement is crucial.",numSuns:1,numAsteroids:20,mapSize:2e3},{id:"open-space",name:"Open Space",description:"Minimal obstacles in a vast arena. Pure strategic combat with fewer terrain advantages.",numSuns:1,numAsteroids:5,mapSize:3e3}],this.baseLoadouts=[{id:"radiant-standard",name:"Standard Forge",description:"Balanced base with standard production",faction:M.RADIANT},{id:"radiant-fortified",name:"Fortified Forge",description:"Enhanced defensive capabilities with thicker armor",faction:M.RADIANT},{id:"radiant-rapid",name:"Rapid Forge",description:"Faster production speed at the cost of durability",faction:M.RADIANT},{id:"aurum-standard",name:"Standard Vault",description:"Balanced base with standard production",faction:M.AURUM},{id:"aurum-wealth",name:"Wealth Vault",description:"Increased resource generation capacity",faction:M.AURUM},{id:"aurum-compact",name:"Compact Vault",description:"Smaller footprint, easier to defend",faction:M.AURUM},{id:"solari-standard",name:"Standard Temple",description:"Balanced base with standard production",faction:M.SOLARI},{id:"solari-solar",name:"Solar Temple",description:"Enhanced solar collection efficiency",faction:M.SOLARI},{id:"solari-titan",name:"Titan Temple",description:"Massive health pool, slower to build",faction:M.SOLARI}],this.spawnLoadouts=[{id:"radiant-standard",name:"Standard Starlings",description:"Balanced minions with standard stats",faction:M.RADIANT},{id:"radiant-swarm",name:"Swarm Starlings",description:"More units but weaker individually",faction:M.RADIANT},{id:"radiant-elite",name:"Elite Starlings",description:"Fewer units but stronger and more durable",faction:M.RADIANT},{id:"aurum-standard",name:"Standard Drones",description:"Balanced minions with standard stats",faction:M.AURUM},{id:"aurum-harvester",name:"Harvester Drones",description:"Gather resources more efficiently",faction:M.AURUM},{id:"aurum-assault",name:"Assault Drones",description:"Higher damage output for aggressive play",faction:M.AURUM},{id:"solari-standard",name:"Standard Zealots",description:"Balanced minions with standard stats",faction:M.SOLARI},{id:"solari-guardian",name:"Guardian Zealots",description:"Tankier units focused on defense",faction:M.SOLARI},{id:"solari-blazing",name:"Blazing Zealots",description:"Fast-moving units with fire damage",faction:M.SOLARI}],this.settings={selectedMap:this.availableMaps[0],difficulty:"normal",soundEnabled:!0,musicEnabled:!0,isBattleStatsInfoEnabled:!1,selectedFaction:M.RADIANT,selectedHeroes:["radiant-marine"],selectedHeroNames:[],playerColor:"#66B3FF",enemyColor:"#FF6B6B",selectedBaseLoadout:null,selectedSpawnLoadout:null,colorScheme:"SpaceBlack",damageDisplayMode:"damage",healthDisplayMode:"bar",graphicsQuality:"high"},this.ensureDefaultHeroSelection(),this.menuElement=this.createMenuElement(),document.body.appendChild(this.menuElement)}createMenuElement(){const t=document.createElement("div");t.id="mainMenu",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.boxSizing="border-box",t.style.backgroundColor="transparent",t.style.zIndex="1000",t.style.fontFamily='"Doto", Arial, sans-serif',t.style.fontWeight="300",t.style.fontSize="24px",t.style.color="#FFFFFF",t.style.overflowY="auto",t.style.overflowX="hidden",t.style.isolation="isolate";const e=document.createElement("div");return e.style.position="relative",e.style.zIndex="1",e.style.width="100%",e.style.minHeight="100%",e.style.padding="24px 16px",e.style.boxSizing="border-box",e.style.display="flex",e.style.flexDirection="column",e.style.justifyContent="center",e.style.alignItems="center",t.appendChild(e),this.contentElement=e,this.backgroundParticleLayer=new lt(t),this.atmosphereLayer=new ht(t,this.resolveAssetPath("ASSETS/sprites/environment/centralSun.svg")),this.menuParticleLayer=new ct(t),this.menuParticleLayer.setMenuContentElement(e),this.testLevelButton=this.createTestLevelButton(),t.appendChild(this.testLevelButton),this.renderMainScreenContent(e),this.resizeHandler=()=>{var t,e;null===(t=this.backgroundParticleLayer)||void 0===t||t.resize(),null===(e=this.atmosphereLayer)||void 0===e||e.resize(),this.menuParticleLayer&&(this.menuParticleLayer.resize(),this.menuParticleLayer.requestTargetRefresh(this.contentElement))},window.addEventListener("resize",this.resizeHandler),t.addEventListener("scroll",()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),t}createTestLevelButton(){const t=document.createElement("button");return t.textContent="TEST LEVEL",t.type="button",t.style.position="absolute",t.style.top="20px",t.style.right="20px",t.style.padding="10px 16px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.6)",t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.color="#FFFFFF",t.style.fontFamily="Arial, sans-serif",t.style.fontWeight="500",t.style.fontSize="14px",t.style.letterSpacing="0.08em",t.style.cursor="pointer",t.style.zIndex="2",t.style.transition="background-color 0.2s ease, border-color 0.2s ease",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="rgba(60, 60, 60, 0.85)",t.style.borderColor="#FFD700"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.borderColor="rgba(255, 255, 255, 0.6)"}),t.addEventListener("click",()=>{const t=this.availableMaps.find(t=>"test-level"===t.id);t&&(this.settings.selectedMap=t,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings)))}),t}setTestLevelButtonVisible(t){this.testLevelButton&&(this.testLevelButton.style.display=t?"block":"none")}getSelectedHeroNames(){return this.heroUnits.filter(t=>this.settings.selectedHeroes.includes(t.id)).map(t=>t.name)}getDefaultHeroIdsForFaction(t){return["radiant-marine"]}ensureDefaultHeroSelection(){if(0===this.settings.selectedHeroes.length){const t=this.getDefaultHeroIdsForFaction(this.settings.selectedFaction);t.length>0&&(this.settings.selectedHeroes=[...t])}this.settings.selectedHeroNames=this.getSelectedHeroNames()}resolveAssetPath(t){return t.startsWith("ASSETS/")&&window.location.pathname.includes("/dist/")?`../${t}`:t}clearMenu(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.factionCarousel&&(this.factionCarousel.destroy(),this.factionCarousel=null),this.contentElement&&(this.contentElement.innerHTML=""),this.setTestLevelButtonVisible(!1)}setMenuParticleDensity(t){var e;null===(e=this.menuParticleLayer)||void 0===e||e.setDensityMultiplier(2*t)}startMenuTransition(){var t;null===(t=this.menuParticleLayer)||void 0===t||t.startTransition()}renderMainScreen(t){this.clearMenu(),this.renderMainScreenContent(t)}renderMainScreenContent(t){var e;this.setTestLevelButtonVisible(!0),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("img");s.src=this.resolveAssetPath("ASSETS/sprites/menu/titleGraphic.svg"),s.alt="Speed of Light RTS",s.style.width=i?"300px":"480px",s.style.maxWidth="90%",s.style.height="auto",s.style.marginBottom=i?"6px":"8px",s.style.alignSelf="center",t.appendChild(s);const o=document.createElement("div");o.style.width="100%",o.style.maxWidth=i?"100%":"900px",o.style.padding=i?"0 10px":"0",o.style.marginTop=i?"4px":"6px",o.style.marginBottom=i?"18px":"20px",t.appendChild(o),this.carouselMenu=new pt(o,[{id:"loadout",name:"LOADOUT",description:"Select faction & heroes"},{id:"start",name:"START",description:"Begin game"},{id:"maps",name:"MAPS",description:"Select map"},{id:"settings",name:"SETTINGS",description:"Configure game"}],1),this.carouselMenu.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onNavigate(()=>{var t;this.startMenuTransition(),null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onSelect(t=>{switch(t.id){case"loadout":this.currentScreen="faction-select",this.startMenuTransition(),this.renderFactionSelectionScreen(this.contentElement);break;case"start":this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings));break;case"maps":this.currentScreen="maps",this.startMenuTransition(),this.renderMapSelectionScreen(this.contentElement);break;case"settings":this.currentScreen="settings",this.startMenuTransition(),this.renderSettingsScreen(this.contentElement)}}),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderMapSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Map",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.display="grid",o.style.gridTemplateColumns=`repeat(auto-fit, minmax(${i?220:300}px, 1fr))`,o.style.gap="20px",o.style.maxWidth="900px",o.style.padding="20px",o.style.marginBottom="30px";for(const t of this.availableMaps){const e=document.createElement("div");e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.border="2px solid transparent",e.style.borderRadius="10px",e.style.padding="20px",e.style.cursor="pointer",e.style.transition="all 0.3s",e.dataset.particleBox="true",e.dataset.particleColor=t.id===this.settings.selectedMap.id?"#FFD700":"#66B3FF",e.addEventListener("mouseenter",()=>{t.id!==this.settings.selectedMap.id&&(e.style.backgroundColor="rgba(255, 255, 255, 0.1)",e.style.transform="scale(1.02)")}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.transform="scale(1)"}),e.addEventListener("click",()=>{this.settings.selectedMap=t,this.renderMapSelectionScreen(this.contentElement)});const i=document.createElement("h3");i.textContent=t.name,i.style.fontSize="28px",i.style.marginBottom="10px",i.style.color=t.id===this.settings.selectedMap.id?"#FFD700":"#FFFFFF",i.style.fontWeight="300",i.dataset.particleText="true",i.dataset.particleColor=t.id===this.settings.selectedMap.id?"#FFF2B3":"#E0F2FF",e.appendChild(i);const s=document.createElement("p");s.textContent=t.description,s.style.fontSize="24px",s.style.lineHeight="1.5",s.style.marginBottom="15px",s.style.color="#CCCCCC",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#CCCCCC",e.appendChild(s);const n=document.createElement("div");n.style.fontSize="24px",n.style.color="#888888",n.innerHTML=`\n                <div> Suns: ${t.numSuns}</div>\n                <div> Asteroids: ${t.numAsteroids}</div>\n                <div> Size: ${t.mapSize}px</div>\n            `,e.appendChild(n),o.appendChild(e)}t.appendChild(o);const n=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");t.appendChild(n),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderSettingsScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Settings",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.maxWidth="500px",o.style.width="100%",o.style.padding="20px";const n=this.createSettingSection("Difficulty",this.createSelect(["easy","normal","hard"],this.settings.difficulty,t=>{this.settings.difficulty=t}));o.appendChild(n);const r=this.createSettingSection("Sound Effects",this.createToggle(this.settings.soundEnabled,t=>{this.settings.soundEnabled=t}));o.appendChild(r);const a=this.createSettingSection("Music",this.createToggle(this.settings.musicEnabled,t=>{this.settings.musicEnabled=t}));o.appendChild(a);const l=this.createSettingSection("Battle Stats Info",this.createToggle(this.settings.isBattleStatsInfoEnabled,t=>{this.settings.isBattleStatsInfoEnabled=t}));o.appendChild(l);const h=this.createSettingSection("Player Color",this.createColorPicker(this.settings.playerColor,t=>{this.settings.playerColor=t}));o.appendChild(h);const c=this.createSettingSection("Enemy Color",this.createColorPicker(this.settings.enemyColor,t=>{this.settings.enemyColor=t}));o.appendChild(c);const d=this.createSettingSection("Graphics Quality",this.createSelect(["low","medium","high"],this.settings.graphicsQuality,t=>{this.settings.graphicsQuality=t}));o.appendChild(d);const g=this.createSettingSection("Color Scheme",this.createSelect(Object.keys(dt),this.settings.colorScheme,t=>{this.settings.colorScheme=t}));o.appendChild(g),t.appendChild(o);const u=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");u.style.marginTop="30px",t.appendChild(u),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderFactionSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Your Faction",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.style.width="100%",o.style.maxWidth=i?"100%":"900px",o.style.padding=i?"0 10px":"0",o.style.marginBottom="30px",t.appendChild(o);const n=[{id:M.RADIANT,name:"Radiant",description:"Masters of light manipulation. Enhanced mirror efficiency and faster light-based attacks.",color:"#00AAFF"},{id:M.AURUM,name:"Aurum",description:"Wealth-oriented civilization. Economic bonuses and resource multiplication.",color:"#FFD700"},{id:M.SOLARI,name:"Solari",description:"Sun-worshipping empire. Stronger structures and enhanced solar collection.",color:"#FF6600"}],r=n.findIndex(t=>t.id===this.settings.selectedFaction),a=r>=0?r:0;!this.settings.selectedFaction&&n.length>0&&(this.settings.selectedFaction=n[a].id),this.factionCarousel=new ut(o,n,a),this.factionCarousel.onSelectionChange(t=>{var e;this.settings.selectedFaction!==t.id&&(this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection()),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}),this.factionCarousel.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)});const l=document.createElement("div");if(l.style.display="flex",l.style.gap="20px",l.style.marginTop="20px",l.style.flexWrap="wrap",l.style.justifyContent="center",i&&(l.style.flexDirection="column",l.style.alignItems="center"),this.settings.selectedFaction){const t=this.createButton("CUSTOMIZE LOADOUT",()=>{this.currentScreen="loadout-customization",this.startMenuTransition(),this.renderLoadoutCustomizationScreen(this.contentElement)},"#00FF88");l.appendChild(t)}const h=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");l.appendChild(h),t.appendChild(l),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderLoadoutCustomizationScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;if(!this.settings.selectedFaction)return this.currentScreen="faction-select",void this.renderFactionSelectionScreen(t);const s=document.createElement("h2");s.textContent="Customize Loadout",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="bold",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=this.baseLoadouts.filter(t=>t.faction===this.settings.selectedFaction),n=this.spawnLoadouts.filter(t=>t.faction===this.settings.selectedFaction);!this.settings.selectedBaseLoadout&&o.length>0&&(this.settings.selectedBaseLoadout=o[0].id),!this.settings.selectedSpawnLoadout&&n.length>0&&(this.settings.selectedSpawnLoadout=n[0].id);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="40px",r.style.width="100%",r.style.maxWidth=i?"100%":"800px",r.style.padding=i?"0 10px":"0 20px",t.appendChild(r),this.createLoadoutSection(r,"Base Loadout",o,this.settings.selectedBaseLoadout,t=>{this.settings.selectedBaseLoadout=t},i),this.createLoadoutSection(r,"Spawn Loadout",n,this.settings.selectedSpawnLoadout,t=>{this.settings.selectedSpawnLoadout=t},i);const a=document.createElement("div");a.style.marginTop="20px";const l=document.createElement("h3");l.textContent="Hero Loadout",l.style.fontSize=i?"24px":"32px",l.style.color="#00AAFF",l.style.marginBottom="15px",l.style.fontWeight="bold",l.dataset.particleText="true",l.dataset.particleColor="#00AAFF",a.appendChild(l);const h=document.createElement("div");h.textContent=this.settings.selectedHeroes.length>0?`Selected: ${this.settings.selectedHeroNames.join(", ")}`:"No heroes selected yet",h.style.fontSize="20px",h.style.color="#CCCCCC",h.style.marginBottom="15px",a.appendChild(h);const c=this.createButton("SELECT HEROES",()=>{this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement)},"#00FF88");a.appendChild(c),r.appendChild(a);const d=document.createElement("div");d.style.display="flex",d.style.gap="20px",d.style.marginTop="30px",d.style.flexWrap="wrap",d.style.justifyContent="center",i&&(d.style.flexDirection="column",d.style.alignItems="center");const g=this.createButton("BACK",()=>{this.currentScreen="faction-select",this.startMenuTransition(),this.renderFactionSelectionScreen(this.contentElement)},"#666666");d.appendChild(g),t.appendChild(d),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}createLoadoutSection(t,e,i,s,o,n){const r=document.createElement("div"),a=document.createElement("h3");a.textContent=e,a.style.fontSize=n?"24px":"32px",a.style.color="#00AAFF",a.style.marginBottom="15px",a.style.fontWeight="bold",a.dataset.particleText="true",a.dataset.particleColor="#00AAFF",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="10px",i.forEach(t=>{const e=t.id===s,i=document.createElement("div");i.style.padding="15px",i.style.backgroundColor=e?"rgba(0, 170, 255, 0.2)":"rgba(0, 0, 0, 0.3)",i.style.border=e?"2px solid #00AAFF":"2px solid rgba(255, 255, 255, 0.2)",i.style.borderRadius="8px",i.style.cursor="pointer",i.style.transition="all 0.2s";const n=document.createElement("div");n.textContent=t.name,n.style.fontSize="22px",n.style.color=e?"#00AAFF":"#FFFFFF",n.style.fontWeight="bold",n.style.marginBottom="5px",n.dataset.particleText="true",n.dataset.particleColor=e?"#00AAFF":"#FFFFFF",i.appendChild(n);const r=document.createElement("div");r.textContent=t.description,r.style.fontSize="18px",r.style.color="#CCCCCC",i.appendChild(r),i.addEventListener("click",()=>{o(t.id),this.renderLoadoutCustomizationScreen(this.contentElement)}),i.addEventListener("mouseenter",()=>{e||(i.style.backgroundColor="rgba(0, 170, 255, 0.1)",i.style.borderColor="#00AAFF")}),i.addEventListener("mouseleave",()=>{e||(i.style.backgroundColor="rgba(0, 0, 0, 0.3)",i.style.borderColor="rgba(255, 255, 255, 0.2)")}),l.appendChild(i)}),r.appendChild(l),t.appendChild(r)}renderLoadoutSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;if(!this.settings.selectedFaction)return void this.renderFactionSelectionScreen(t);const s=document.createElement("h2");s.textContent=`Select 4 Heroes - ${this.settings.selectedFaction}`,s.style.fontSize=i?"28px":"42px",s.style.marginBottom=i?"15px":"20px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const o=document.createElement("div");o.textContent=`Selected: ${this.settings.selectedHeroes.length} / 4`,o.style.fontSize=i?"24px":"26px",o.style.marginBottom=i?"20px":"30px",o.style.color=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",o.style.fontWeight="300",o.dataset.particleText="true",o.dataset.particleColor=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",t.appendChild(o);const n=document.createElement("div");n.style.display="grid",n.style.gridTemplateColumns=i?"repeat(2, minmax(0, 1fr))":"repeat(auto-fit, minmax(280px, 1fr))",n.style.gap="15px",n.style.maxWidth="1200px",n.style.padding="20px",n.style.marginBottom="20px",n.style.maxHeight=i?"none":"600px",n.style.overflowY=i?"visible":"auto";const r=this.heroUnits.filter(t=>t.faction===this.settings.selectedFaction);for(const t of r){const e=this.settings.selectedHeroes.includes(t.id),i=e||this.settings.selectedHeroes.length<4,s=document.createElement("div");s.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.border="2px solid transparent",s.style.borderRadius="10px",s.style.padding="15px",s.style.cursor=i?"pointer":"not-allowed",s.style.transition="all 0.3s",s.style.opacity=i?"1":"0.5",s.style.minHeight="300px",s.dataset.particleBox="true",s.dataset.particleColor=e?"#00FF88":"#66B3FF",i&&(s.addEventListener("mouseenter",()=>{e||(s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.transform="scale(1.02)")}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.transform="scale(1)"}),s.addEventListener("click",()=>{e?this.settings.selectedHeroes=this.settings.selectedHeroes.filter(e=>e!==t.id):this.settings.selectedHeroes.length<4&&this.settings.selectedHeroes.push(t.id),this.renderLoadoutSelectionScreen(this.contentElement)}));const o=document.createElement("h4");o.textContent=t.name,o.style.fontSize="24px",o.style.marginBottom="8px",o.style.color=e?"#00FF88":"#E0F2FF",o.style.fontWeight="300",o.dataset.particleText="true",o.dataset.particleColor=e?"#00FF88":"#E0F2FF",s.appendChild(o);const r=document.createElement("p");r.textContent=t.description,r.style.fontSize="24px",r.style.lineHeight="1.4",r.style.color="#AAAAAA",r.style.marginBottom="10px",r.style.fontWeight="300",r.dataset.particleText="true",r.dataset.particleColor="#AAAAAA",s.appendChild(r);const a=document.createElement("div");a.style.fontSize="24px",a.style.lineHeight="1.6",a.style.color="#CCCCCC",a.style.marginBottom="8px",a.style.padding="8px",a.style.backgroundColor="rgba(0, 0, 0, 0.3)",a.style.borderRadius="5px",a.style.fontWeight="300";const l=document.createElement("div");l.textContent=`HP: ${t.maxHealth}`,l.style.color="#CCCCCC",l.style.fontWeight="bold",l.dataset.particleText="true",l.dataset.particleColor="#CCCCCC",a.appendChild(l);const h=document.createElement("div");h.textContent=`RGN: ${t.regen}%`,h.style.color="#CCCCCC",h.style.fontWeight="bold",h.dataset.particleText="true",h.dataset.particleColor="#CCCCCC",a.appendChild(h);const c=document.createElement("div");c.textContent=`DEF: ${t.defense}%`,c.style.color="#CCCCCC",c.style.fontWeight="bold",c.dataset.particleText="true",c.dataset.particleColor="#CCCCCC",a.appendChild(c);const d=document.createElement("div"),g=t.attackIgnoresDefense?" (ignores defense)":"";d.textContent=`ATK: ${t.attackDamage}${g}`,d.style.color="#CCCCCC",d.style.fontWeight="bold",d.dataset.particleText="true",d.dataset.particleColor="#CCCCCC",a.appendChild(d);const u=document.createElement("div");u.textContent=`SPD: ${t.attackSpeed}/s`,u.style.color="#CCCCCC",u.style.fontWeight="bold",u.dataset.particleText="true",u.dataset.particleColor="#CCCCCC",a.appendChild(u);const p=document.createElement("div");p.textContent=`RNG: ${t.attackRange}`,p.style.color="#CCCCCC",p.style.fontWeight="bold",p.dataset.particleText="true",p.dataset.particleColor="#CCCCCC",a.appendChild(p),s.appendChild(a);const x=document.createElement("div");if(x.style.fontSize="24px",x.style.lineHeight="1.4",x.style.color="#FFD700",x.style.marginBottom="8px",x.style.fontStyle="italic",x.style.fontWeight="bold",x.textContent=`${t.abilityDescription}`,x.dataset.particleText="true",x.dataset.particleColor="#FFD700",s.appendChild(x),e){const t=document.createElement("div");t.textContent=" Selected",t.style.fontSize="24px",t.style.marginTop="8px",t.style.color="#00FF88",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#00FF88",s.appendChild(t)}n.appendChild(s)}t.appendChild(n);const a=document.createElement("div");if(a.style.display="flex",a.style.gap="20px",a.style.marginTop="20px",a.style.flexWrap="wrap",a.style.justifyContent="center",i&&(a.style.flexDirection="column",a.style.alignItems="center"),4===this.settings.selectedHeroes.length){const t=this.createButton("CONFIRM LOADOUT",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#00FF88");a.appendChild(t)}const l=this.createButton("BACK",()=>{this.currentScreen="loadout-customization",this.startMenuTransition(),this.renderLoadoutCustomizationScreen(this.contentElement)},"#666666");a.appendChild(l),t.appendChild(a),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}createButton(t,e,i="#FFD700"){const s=document.createElement("button");return s.textContent=t,s.style.fontSize="24px",s.style.padding="15px 40px",s.style.backgroundColor="rgba(0, 0, 0, 0.35)",s.style.color="#666666"===i?"#FFFFFF":i,s.style.border="2px solid transparent",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontWeight="300",s.style.fontFamily="inherit",s.style.transition="all 0.3s",s.dataset.particleBox="true",s.dataset.particleColor=i,s.addEventListener("mouseenter",()=>{s.style.backgroundColor="rgba(255, 255, 255, 0.12)",s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor="rgba(0, 0, 0, 0.35)",s.style.transform="scale(1)"}),s.addEventListener("click",e),s}createSettingSection(t,e){const i=document.createElement("div");i.style.marginBottom="30px",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center";const s=document.createElement("label");return s.textContent=t,s.style.fontSize="24px",s.style.color="#FFFFFF",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFFFFF",i.appendChild(s),i.appendChild(e),i}createSelect(t,e,i){const s=document.createElement("select");s.style.fontSize="24px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontFamily="inherit",s.style.fontWeight="300";for(const i of t){const t=document.createElement("option");t.value=i,t.textContent=i.charAt(0).toUpperCase()+i.slice(1),t.selected=i===e,t.style.backgroundColor="#000011",s.appendChild(t)}return s.addEventListener("change",()=>{i(s.value)}),s}createToggle(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="60px",s.style.height="30px",s.style.backgroundColor=t?"#00FF88":"#666666",s.style.borderRadius="15px",s.style.position="relative",s.style.cursor="pointer",s.style.transition="all 0.3s";const o=document.createElement("div");return o.style.width="26px",o.style.height="26px",o.style.backgroundColor="#FFFFFF",o.style.borderRadius="50%",o.style.position="absolute",o.style.top="2px",o.style.left=t?"32px":"2px",o.style.transition="all 0.3s",s.appendChild(o),s.addEventListener("click",()=>{const i=!t;t=i,s.style.backgroundColor=i?"#00FF88":"#666666",o.style.left=i?"32px":"2px",e(i)}),i.appendChild(s),i}createColorPicker(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="40px",s.style.height="40px",s.style.backgroundColor=t,s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer";const o=document.createElement("input");return o.type="color",o.value=t,o.style.opacity="0",o.style.width="0",o.style.height="0",o.style.position="absolute",o.addEventListener("change",()=>{s.style.backgroundColor=o.value,e(o.value)}),s.addEventListener("click",()=>{o.click()}),i.appendChild(s),i.appendChild(o),i}onStart(t){this.onStartCallback=t}hide(){var t,e,i;this.menuElement.style.display="none",null===(t=this.backgroundParticleLayer)||void 0===t||t.stop(),null===(e=this.atmosphereLayer)||void 0===e||e.stop(),null===(i=this.menuParticleLayer)||void 0===i||i.stop()}show(){var t,e,i;this.menuElement.style.display="block",this.currentScreen="main",this.renderMainScreen(this.contentElement),null===(t=this.backgroundParticleLayer)||void 0===t||t.start(),null===(e=this.atmosphereLayer)||void 0===e||e.start(),null===(i=this.menuParticleLayer)||void 0===i||i.start()}destroy(){var t,e,i;this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.factionCarousel&&(this.factionCarousel.destroy(),this.factionCarousel=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),null===(t=this.backgroundParticleLayer)||void 0===t||t.destroy(),null===(e=this.atmosphereLayer)||void 0===e||e.destroy(),null===(i=this.menuParticleLayer)||void 0===i||i.stop(),this.menuElement.parentNode&&this.menuElement.parentNode.removeChild(this.menuElement)}getSettings(){return this.settings}}class ut{constructor(t,e,i){this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.lastDragDeltaX=0,this.velocity=0,this.hasDragged=!1,this.isCompactLayout=!1,this.resizeHandler=null,this.keydownHandler=null,this.onSelectionChangeCallback=null,this.onRenderCallback=null,this.animationFrameId=null,this.container=t,this.options=e,this.currentIndex=Math.max(0,Math.min(e.length-1,i)),this.targetIndex=this.currentIndex,this.setupContainer(),this.setupEventHandlers(),this.scrollOffset=-this.currentIndex*this.getItemSpacingPx(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.updateLayoutMetrics(),this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.resizeHandler=()=>{this.updateLayoutMetrics()},window.addEventListener("resize",this.resizeHandler),this.keydownHandler=t=>{const e=t.target;if(e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName))return;const i=t.key.toLowerCase();"arrowleft"!==i&&"a"!==i||(this.moveSelection(-1),t.preventDefault()),"arrowright"!==i&&"d"!==i||(this.moveSelection(1),t.preventDefault())},window.addEventListener("keydown",this.keydownHandler),this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.lastDragDeltaX=0,this.container.style.cursor="grabbing"}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.lastDragDeltaX=e,this.scrollOffset=this.dragStartOffset+e,this.velocity=e*ut.VELOCITY_MULTIPLIER,Math.abs(e)>P&&(this.hasDragged=!0)}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=this.getItemSpacingPx(),i=this.lastDragDeltaX;if(Math.abs(i)>=ut.SWIPE_THRESHOLD_PX){const t=i<0?1:-1;return void this.setCurrentIndex(this.currentIndex+t)}const s=-this.scrollOffset/e,o=Math.round(s+this.velocity*ut.VELOCITY_FACTOR);this.setCurrentIndex(o)}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,o=this.currentIndex+Math.round(s/this.getItemSpacingPx());this.setCurrentIndex(o)}moveSelection(t){this.setCurrentIndex(this.currentIndex+t)}setCurrentIndex(t){const e=Math.max(0,Math.min(this.options.length-1,t));e!==this.currentIndex?(this.targetIndex=e,this.currentIndex=e,this.onSelectionChangeCallback&&this.onSelectionChangeCallback(this.options[this.currentIndex])):this.targetIndex=e}startAnimation(){const t=()=>{this.update(),this.render(),this.animationFrameId=requestAnimationFrame(t)};t()}updateLayoutMetrics(){this.isCompactLayout=window.innerWidth<600;const t=this.isCompactLayout?"360px":"480px";this.container.style.height!==t&&(this.container.style.height=t)}getLayoutScale(){return this.isCompactLayout?.6:.9}getItemSpacingPx(){return ut.ITEM_SPACING_PX*this.getLayoutScale()}update(){this.updateLayoutMetrics();const t=-this.currentIndex*this.getItemSpacingPx()-this.scrollOffset;this.scrollOffset+=t*ut.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=ut.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0}render(){this.container.innerHTML="";const t=this.container.getBoundingClientRect(),e=t.width/2,i=t.height/2,s=this.getLayoutScale(),o=this.getItemSpacingPx(),n=ut.BASE_SIZE_PX*s,r=ut.TEXT_SCALE*s;for(let t=0;t<this.options.length;t++){const a=this.options[t],l=t-this.currentIndex,h=Math.abs(l),c=e+this.scrollOffset+t*o;let d=1,g=1;0===h?(d=1,g=1):1===h?(d=.72,g=.85):2===h?(d=.5,g=.55):(d=Math.max(.3,1-.25*h),g=Math.max(.3,1-.25*h));const u=n*d,p=document.createElement("div");p.style.position="absolute",p.style.left=c-u/2+"px",p.style.top=i-u/2+"px",p.style.width=`${u}px`,p.style.height=`${u}px`,p.style.backgroundColor=0===h?"rgba(12, 14, 22, 0.98)":"rgba(12, 14, 22, 0.85)",p.style.border=0===h?`2px solid ${a.color}`:"2px solid rgba(255, 255, 255, 0.2)",p.style.borderRadius="10px",p.style.opacity=g.toString(),p.style.display="flex",p.style.flexDirection="column",p.style.justifyContent="center",p.style.alignItems="center",p.style.pointerEvents="none",p.style.color="#FFFFFF",p.style.fontWeight="300",p.style.textAlign="center",p.style.padding=24*s+"px",p.style.boxSizing="border-box",p.style.zIndex=(100-h).toString(),p.style.overflow="hidden",p.dataset.particleBox="true",p.dataset.particleColor=0===h?a.color:"#66B3FF";const x=document.createElement("div");if(x.textContent=a.name.toUpperCase(),x.style.fontSize=Math.max(16,20*d)*r+"px",x.style.marginBottom=0===h?"14px":"0",x.style.color=0===h?"#FFFFFF":"#E0F2FF",x.style.fontWeight="300",x.dataset.particleText="true",x.dataset.particleColor=0===h?"#FFFFFF":"#E0F2FF",p.appendChild(x),0===h){const t=document.createElement("div");t.textContent=a.description,t.style.fontSize=Math.max(10,12*d)*r+"px",t.style.color="#D0D0D0",t.style.lineHeight="1.4",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#D0D0D0",p.appendChild(t)}this.container.appendChild(p)}const a=document.createElement("div");a.textContent="Swipe, drag, or use / (A/D)  Tap side tiles to browse",a.style.position="absolute",a.style.bottom="20px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.color="#AAAAAA",a.style.fontSize=22*s+"px",a.style.fontWeight="300",a.style.pointerEvents="none",a.dataset.particleText="true",a.dataset.particleColor="#AAAAAA",this.container.appendChild(a),this.onRenderCallback&&this.onRenderCallback()}onSelectionChange(t){this.onSelectionChangeCallback=t}onRender(t){this.onRenderCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler)}}ut.ITEM_SPACING_PX=220,ut.BASE_SIZE_PX=320,ut.TEXT_SCALE=2.4,ut.VELOCITY_MULTIPLIER=.1,ut.VELOCITY_FACTOR=.001,ut.SMOOTH_INTERPOLATION_FACTOR=.15,ut.VELOCITY_DECAY_FACTOR=.9,ut.SWIPE_THRESHOLD_PX=50;class pt{constructor(t,e,i=0){this.currentIndex=0,this.targetIndex=0,this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.lastDragDeltaX=0,this.velocity=0,this.onSelectCallback=null,this.onRenderCallback=null,this.onNavigateCallback=null,this.animationFrameId=null,this.hasDragged=!1,this.isCompactLayout=!1,this.resizeHandler=null,this.container=t,this.options=e;const s=Math.max(0,Math.min(i,e.length-1));this.currentIndex=s,this.targetIndex=s,this.setupContainer(),this.setupEventHandlers(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.updateLayoutMetrics(),this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.resizeHandler=()=>{this.updateLayoutMetrics()},window.addEventListener("resize",this.resizeHandler),this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.lastDragDeltaX=0,this.container.style.cursor="grabbing"}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.lastDragDeltaX=e,this.scrollOffset=this.dragStartOffset+e,this.velocity=e*pt.VELOCITY_MULTIPLIER,Math.abs(e)>P&&(this.hasDragged=!0)}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=this.getItemWidthPx(),i=this.lastDragDeltaX;if(Math.abs(i)>=pt.SWIPE_THRESHOLD_PX){const t=i<0?1:-1,e=Math.max(0,Math.min(this.options.length-1,this.currentIndex+t));return void this.setCurrentIndex(e)}const s=-this.scrollOffset/e;let o=Math.round(s+this.velocity*pt.VELOCITY_FACTOR);o=Math.max(0,Math.min(this.options.length-1,o)),this.setCurrentIndex(o)}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,o=this.currentIndex+Math.round(s/this.getItemWidthPx()),n=Math.max(0,Math.min(this.options.length-1,o));n===this.currentIndex?this.onSelectCallback&&this.onSelectCallback(this.options[this.currentIndex]):this.setCurrentIndex(n)}setCurrentIndex(t){t!==this.currentIndex?(this.targetIndex=t,this.currentIndex=t,this.onNavigateCallback&&this.onNavigateCallback(t)):this.targetIndex=t}startAnimation(){const t=()=>{this.update(),this.render(),this.animationFrameId=requestAnimationFrame(t)};t()}updateLayoutMetrics(){const t=window.innerWidth<600;this.isCompactLayout=t;const e=this.getLayoutScale(),i=pt.BASE_SIZE*e,s=120*e,o=`${Math.round(i+s)}px`;this.container.style.height!==o&&(this.container.style.height=o)}getLayoutScale(){return this.isCompactLayout?.5:1}getItemWidthPx(){return pt.ITEM_WIDTH*this.getLayoutScale()}update(){this.updateLayoutMetrics();const t=-this.currentIndex*this.getItemWidthPx()-this.scrollOffset;this.scrollOffset+=t*pt.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=pt.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0}render(){this.container.innerHTML="";const t=this.container.getBoundingClientRect(),e=t.width/2,i=t.height/2,s=this.getLayoutScale(),o=this.getItemWidthPx(),n=pt.BASE_SIZE*s,r=pt.TEXT_SCALE*s;for(let t=0;t<this.options.length;t++){const s=this.options[t],a=t-this.currentIndex,l=Math.abs(a),h=e+this.scrollOffset+t*o;let c=1,d=1;0===l?(c=1,d=1):1===l?(c=.75,d=.75):2===l?(c=.5,d=.5):(c=Math.max(.25,1-.25*l),d=Math.max(.25,1-.25*l));const g=n*c,u=document.createElement("div");u.style.position="absolute",u.style.left=h-g/2+"px",u.style.top=i-g/2+"px",u.style.width=`${g}px`,u.style.height=`${g}px`,u.style.backgroundColor="transparent",u.style.border="2px solid transparent",u.style.borderRadius="10px",u.style.opacity=d.toString(),u.style.transition="background-color 0.2s",u.style.display="flex",u.style.flexDirection="column",u.style.justifyContent="center",u.style.alignItems="center",u.style.pointerEvents="none",u.style.color="#000000",u.style.fontWeight="300",u.style.textAlign="center",u.style.padding="30px",u.style.boxSizing="border-box",u.dataset.particleBox="true",u.dataset.particleColor=0===l?"#FFD700":"#00AAFF";const p=document.createElement("div");if(p.textContent=s.name,p.style.fontSize=Math.max(14,18*c)*r+"px",p.style.marginBottom="15px",p.style.color=0===l?"#FFF5C2":"#E2F4FF",p.style.fontWeight="300",p.dataset.particleText="true",p.dataset.particleColor=0===l?"#FFF5C2":"#E2F4FF",u.appendChild(p),0===l){const t=document.createElement("div");t.textContent=s.description,t.style.fontSize=Math.max(10,12*c)*r+"px",t.style.color="#D0D0D0",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#D0D0D0",u.appendChild(t)}this.container.appendChild(u)}const a=document.createElement("div");a.textContent="Swipe or drag to browse  Tap center to select",a.style.position="absolute",a.style.bottom="20px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.color="#AAAAAA",a.style.fontSize=24*s+"px",a.style.fontWeight="300",a.style.pointerEvents="none",a.dataset.particleText="true",a.dataset.particleColor="#AAAAAA",this.container.appendChild(a),this.onRenderCallback&&this.onRenderCallback()}onSelect(t){this.onSelectCallback=t}onRender(t){this.onRenderCallback=t}onNavigate(t){this.onNavigateCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler)}}pt.ITEM_WIDTH=260,pt.BASE_SIZE=220,pt.TEXT_SCALE=2,pt.VELOCITY_MULTIPLIER=.1,pt.VELOCITY_FACTOR=.001,pt.SMOOTH_INTERPOLATION_FACTOR=.15,pt.VELOCITY_DECAY_FACTOR=.9,pt.SWIPE_THRESHOLD_PX=50;class xt{constructor(t){this.camera=new v(0,0),this.parallaxCamera=new v(0,0),this.zoom=1,this.selectionStart=null,this.selectionEnd=null,this.abilityArrowStart=null,this.abilityArrowEnd=null,this.selectedUnits=new Set,this.pathPreviewForge=null,this.pathPreviewPoints=[],this.pathPreviewEnd=null,this.selectedHeroNames=[],this.tapEffects=[],this.swipeEffects=[],this.warpGateShockwaves=[],this.productionButtonWaves=[],this.viewingPlayer=null,this.showInfo=!1,this.showInGameMenu=!1,this.isPaused=!1,this.playerColor=e,this.enemyColor=i,this.colorScheme=dt.SpaceBlack,this.inGameMenuTab="main",this.damageDisplayMode="damage",this.healthDisplayMode="bar",this.graphicsQuality="high",this.HERO_SPRITE_SCALE=6,this.FORGE_SPRITE_SCALE=2.2,this.spriteImageCache=new Map,this.tintedSpriteCache=new Map,this.outlinedSpriteCache=new Map,this.forgeFlameStates=new Map,this.graphicsOptionByKey=new Map,this.graphicsVariantByKey=new Map,this.graphicsMenuScrollOffset=0,this.graphicsOptions=[{key:"centralSun",label:"Central Sun",svgPath:"ASSETS/sprites/environment/centralSun.svg",pngPath:"ASSETS/sprites/environment/centralSun.png"},{key:"stellarForge",label:"Stellar Forge Base",svgPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantBaseType1.svg",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantBaseType1.png"},{key:"forgeFlameHot",label:"Forge Flame (Hot)",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantForgeFlame.png"},{key:"forgeFlameCold",label:"Forge Flame (Cold)",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantForgeFlameCold.png"},{key:"solarMirror",label:"Solar Mirror",svgPath:"ASSETS/sprites/RADIANT/solarMirrors/radiantSolarMirror.svg",pngPath:"ASSETS/sprites/RADIANT/solarMirrors/radiantSolarMirror.png"},{key:"starling",label:"Starling",svgPath:"ASSETS/sprites/RADIANT/starlings/starlingLevel (1).svg",pngPath:"ASSETS/sprites/RADIANT/starlings/starlingLevel (1).png"},{key:"heroMarine",label:"Hero: Marine",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Marine.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Marine.png"},{key:"heroGrave",label:"Hero: Grave",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Grave.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Grave.png"},{key:"heroRay",label:"Hero: Ray",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Ray.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Ray.png"},{key:"heroInfluenceBall",label:"Hero: Influence Ball",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Uniter.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Uniter.png"},{key:"heroTurretDeployer",label:"Hero: Turret Deployer",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Engineer.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Engineer.png"},{key:"heroDriller",label:"Hero: Driller",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Drill.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Drill.png"},{key:"heroDagger",label:"Hero: Dagger",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Dagger.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Dagger.png"},{key:"heroBeam",label:"Hero: Beam",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Beam.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Beam.png"}],this.MOVE_ORDER_DOT_RADIUS=12,this.FORGE_MAX_HEALTH=1e3,this.MIRROR_MAX_HEALTH=d,this.starLayers=[],this.canvas=t;const s=t.getContext("2d");if(!s)throw new Error("Could not get 2D context from canvas");this.ctx=s,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.initializeStarLayers();const o=["stellarForge","solarMirror"];for(const t of this.graphicsOptions){this.graphicsOptionByKey.set(t.key,t);const e=t.svgPath?"svg":t.pngPath?"png":"stub",i=o.includes(t.key)&&t.pngPath;this.graphicsVariantByKey.set(t.key,i?"png":e)}}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t)}initializeStarLayers(){let t=42;const e=()=>(t=(9301*t+49297)%233280,t/233280);for(const t of r){const i=[];for(let s=0;s<t.count;s++)i.push({x:e()*n-2e3,y:e()*n-2e3,size:t.sizeRange[0]+e()*(t.sizeRange[1]-t.sizeRange[0]),brightness:.3+.7*e()});this.starLayers.push({stars:i,parallaxFactor:t.parallaxFactor})}}worldToScreen(t){const e=window.devicePixelRatio||1,i=this.canvas.width/e/2,s=this.canvas.height/e/2;return new v(i+(t.x-this.camera.x)*this.zoom,s+(t.y-this.camera.y)*this.zoom)}isWithinRenderBounds(t,e,i=0){const s=e/2;return t.x>=-s-i&&t.x<=s+i&&t.y>=-s-i&&t.y<=s+i}screenToWorld(t,e){const i=window.devicePixelRatio||1,s=this.canvas.width/i/2,o=this.canvas.height/i/2;return new v(this.camera.x+(t-s)/this.zoom,this.camera.y+(e-o)/this.zoom)}getFactionColor(t){switch(t){case M.RADIANT:return"#FFD700";case M.AURUM:return"#DAA520";case M.SOLARI:return"#FF8C00";default:return"#FFFFFF"}}getSpriteImage(t){const e=this.resolveAssetPath(t),i=this.spriteImageCache.get(e);if(i)return i;const s=new Image;return s.src=e,this.spriteImageCache.set(e,s),s}getTintedSprite(t,e){const i=this.resolveAssetPath(t),s=`${i}|${e}`,o=this.tintedSpriteCache.get(s);if(o)return o;const n=this.getSpriteImage(i);if(!n.complete||0===n.naturalWidth||0===n.naturalHeight)return null;const r=document.createElement("canvas");r.width=n.naturalWidth,r.height=n.naturalHeight;const a=r.getContext("2d");return a?(a.drawImage(n,0,0),a.globalCompositeOperation="multiply",a.fillStyle=e,a.fillRect(0,0,r.width,r.height),a.globalCompositeOperation="destination-in",a.drawImage(n,0,0),a.globalCompositeOperation="source-over",this.tintedSpriteCache.set(s,r),r):null}getOutlinedTintedSprite(t,e){const i=this.resolveAssetPath(t),s=`${i}|${e}|outlined`,o=this.outlinedSpriteCache.get(s);if(o)return o;const n=this.getSpriteImage(i);if(!n.complete||0===n.naturalWidth||0===n.naturalHeight)return null;const r=document.createElement("canvas");r.width=n.naturalWidth+4,r.height=n.naturalHeight+4;const a=r.getContext("2d");if(!a)return null;a.globalCompositeOperation="source-over",a.fillStyle="white";for(let t=0;t<2*Math.PI;t+=Math.PI/4){const e=2*Math.cos(t)+2,i=2*Math.sin(t)+2;a.drawImage(n,e,i)}return a.globalCompositeOperation="source-in",a.fillRect(0,0,r.width,r.height),a.globalCompositeOperation="source-over",a.drawImage(n,2,2),a.globalCompositeOperation="multiply",a.fillStyle=e,a.fillRect(2,2,n.naturalWidth,n.naturalHeight),a.globalCompositeOperation="destination-in",a.drawImage(n,2,2),a.globalCompositeOperation="source-over",this.outlinedSpriteCache.set(s,r),r}resolveAssetPath(t){return t.startsWith("ASSETS/")&&window.location.pathname.includes("/dist/")?`../${t}`:t}getGraphicVariant(t){var e;return null!==(e=this.graphicsVariantByKey.get(t))&&void 0!==e?e:"stub"}setGraphicsVariant(t,e){this.graphicsVariantByKey.set(t,e)}setInGameMenuTab(t){this.inGameMenuTab=t}getGraphicAssetPath(t){var e,i;const s=this.graphicsOptionByKey.get(t);if(!s)return null;const o=this.getGraphicVariant(t);return"svg"===o?null!==(e=s.svgPath)&&void 0!==e?e:null:"png"===o&&null!==(i=s.pngPath)&&void 0!==i?i:null}getForgeSpritePath(t){return t.owner.faction===M.RADIANT?this.getGraphicAssetPath("stellarForge"):null}getSolarMirrorSpritePath(t){return t.owner.faction===M.RADIANT?this.getGraphicAssetPath("solarMirror"):null}getStarlingSpritePath(t){return t.owner.faction===M.RADIANT?this.getGraphicAssetPath("starling"):null}getStarlingFacingRotationRad(t){if(t.rallyPoint&&t.position.distanceTo(t.rallyPoint)>5)return t.rotation+o;if(t.target&&"position"in t.target&&(!("health"in t.target)||t.target.health>0)){const e=t.target.position,i=e.x-t.position.x,s=e.y-t.position.y;if(0!==i||0!==s)return Math.atan2(s,i)+o}return t.rotation+o}getForgeFlameState(t,e){let i=this.forgeFlameStates.get(t);if(!i)return i={warmth:t.isReceivingLight?1:0,rotationRad:t.rotation,lastGameTime:e},this.forgeFlameStates.set(t,i),i;const s=Math.max(0,e-i.lastGameTime);i.lastGameTime=e;const o=t.isReceivingLight?1:0;if(o>i.warmth?i.warmth=Math.min(1,i.warmth+2*s):o<i.warmth&&(i.warmth=Math.max(0,i.warmth-2*s)),t.isReceivingLight){const e=t.getCurrentCrunch(),o=e&&e.isActive()?2:1;i.rotationRad+=g*o*s,i.rotationRad>=2*Math.PI&&(i.rotationRad-=2*Math.PI)}return i}getHeroSpritePath(t){return t.owner.faction!==M.RADIANT?null:t instanceof X?this.getGraphicAssetPath("heroMarine"):t instanceof q?this.getGraphicAssetPath("heroGrave"):t instanceof ot?this.getGraphicAssetPath("heroDagger"):t instanceof nt?this.getGraphicAssetPath("heroBeam"):t instanceof Z?this.getGraphicAssetPath("heroRay"):t instanceof tt?this.getGraphicAssetPath("heroInfluenceBall"):t instanceof it?this.getGraphicAssetPath("heroTurretDeployer"):t instanceof st?this.getGraphicAssetPath("heroDriller"):null}darkenColor(t,e){const i=Math.max(0,Math.min(1,e));let s=t.replace("#","");3===s.length&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]);const o=parseInt(s.substring(0,2),16)||0,n=parseInt(s.substring(2,4),16)||0,r=parseInt(s.substring(4,6),16)||0,a=Math.floor(Math.min(255,o*i)),l=Math.floor(Math.min(255,n*i)),h=Math.floor(Math.min(255,r*i));return"#"+a.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+h.toString(16).padStart(2,"0")}brightenAndPaleColor(t){let e=t.replace("#","");3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);const i=parseInt(e.substring(0,2),16)||0,s=parseInt(e.substring(2,4),16)||0,o=parseInt(e.substring(4,6),16)||0,n=i+.2*(255-i),r=s+.2*(255-s),a=o+.2*(255-o),l=(n+r+a)/3,h=.15,c=Math.floor(n+(l-n)*h),d=Math.floor(r+(l-r)*h),g=Math.floor(a+(l-a)*h);return"#"+c.toString(16).padStart(2,"0")+d.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")}drawSun(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=this.getGraphicAssetPath("centralSun"),o=(s&&this.getSpriteImage(s),this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i));o.addColorStop(0,this.colorScheme.sunGlow.outerGlow1),o.addColorStop(.5,this.colorScheme.sunGlow.outerGlow2),o.addColorStop(.8,this.colorScheme.sunGlow.outerGlow3),o.addColorStop(1,this.colorScheme.sunGlow.outerGlow4),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.drawVoronoiSegments(t,e,i)}drawVoronoiSegments(t,e,i){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.85*i,0,2*Math.PI),this.ctx.clip();const s=Math.floor(e.x-i),o=Math.ceil(e.x+i),n=Math.floor(e.y-i),r=Math.ceil(e.y+i),a=Math.ceil((o-s)/1),l=Math.ceil((r-n)/1),h=this.ctx.createImageData(a,l),c=h.data;for(let o=0;o<l;o++){const r=n+1*o;for(let n=0;n<a;n++){const l=s+1*n,h=l-e.x,d=r-e.y;if(Math.sqrt(h*h+d*d)>.85*i){c[4*(o*a+n)+3]=0;continue}const g=this.screenToWorld(l,r);let u=t.voronoiSegments[0],p=1/0;for(const e of t.voronoiSegments){const t=g.x-e.seedPoint.x,i=g.y-e.seedPoint.y,s=t*t+i*i;s<p&&(p=s,u=e)}const x=4*(o*a+n);c[x]=Math.round(u.currentColor.r),c[x+1]=Math.round(u.currentColor.g),c[x+2]=Math.round(u.currentColor.b),c[x+3]=230}}this.ctx.putImageData(h,s,n),this.ctx.restore()}drawForgeFlames(t,e,i,s,o){const n=this.getForgeFlameState(t,s.gameTime),r=this.getGraphicAssetPath("forgeFlameHot"),a=this.getGraphicAssetPath("forgeFlameCold");if(!r||!a)return;const l=this.getSpriteImage(r),h=this.getSpriteImage(a);if(!l.complete||0===l.naturalWidth||!h.complete||0===h.naturalWidth)return;const c=.3*i,d=.3*(o?.7:1),g=d*n.warmth,u=d*(1-n.warmth),p=[0,0];for(let t=0;t<p.length;t++){const i=p[t],s=0===t?n.rotationRad:-n.rotationRad;this.ctx.save(),this.ctx.translate(e.x+i,e.y),this.ctx.rotate(s),u>0&&(this.ctx.globalAlpha=u,this.ctx.drawImage(h,-c/2,-c/2,c,c)),g>0&&(this.ctx.globalAlpha=g,this.ctx.drawImage(l,-c/2,-c/2,c,c)),this.ctx.restore()}this.ctx.globalAlpha=1}drawLensFlare(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=window.devicePixelRatio||1,o=this.canvas.width/s,n=this.canvas.height/s,r=o/2,a=n/2,l=e.x-r,h=e.y-a;if(Math.sqrt(l*l+h*h)>Math.sqrt(o*o+n*n)/2+i)return;const c=this.colorScheme.lensFlareHalo.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/),d=c?`rgba(${c[1]}, ${c[2]}, ${c[3]}, `:"rgba(255, 240, 200, ",g=[{offset:-.3,size:.4,alpha:.15},{offset:-.5,size:.25,alpha:.12},{offset:.4,size:.3,alpha:.1},{offset:.7,size:.2,alpha:.08}];for(const t of g){const e=r+l*t.offset,s=a+h*t.offset,o=i*t.size,n=this.ctx.createRadialGradient(e,s,0,e,s,o);n.addColorStop(0,`${d}${t.alpha})`),n.addColorStop(.5,`${d}${.5*t.alpha})`),n.addColorStop(1,`${d}0)`),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(e,s,o,0,2*Math.PI),this.ctx.fill()}this.ctx.save(),this.ctx.globalAlpha=.2,this.ctx.strokeStyle=this.colorScheme.lensFlareHalo,this.ctx.lineWidth=2;for(let t=0;t<6;t++){const s=Math.PI/3*t,o=1.5*i,n=e.x+Math.cos(s)*i*.7,r=e.y+Math.sin(s)*i*.7,a=e.x+Math.cos(s)*o,l=e.y+Math.sin(s)*o,h=this.ctx.createLinearGradient(n,r,a,l),c=d+"0.4)";h.addColorStop(0,c),h.addColorStop(1,`${d}0)`),this.ctx.strokeStyle=h,this.ctx.beginPath(),this.ctx.moveTo(n,r),this.ctx.lineTo(a,l),this.ctx.stroke()}this.ctx.restore()}drawStellarForge(t,e,i,s){const o=this.worldToScreen(t.position),n=40*this.zoom;let r=!1,a=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(r=!0,a=this.darkenColor(e,l))}if(t.isSelected){if(this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,1.5*n,0,2*Math.PI),this.ctx.stroke(),t.minionPath.length>0){this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.setLineDash([10,5]),this.ctx.beginPath();const e=this.worldToScreen(t.position);this.ctx.moveTo(e.x,e.y);for(const e of t.minionPath){const t=this.worldToScreen(e);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="#FFFF00";for(let e=0;e<t.minionPath.length;e++){const i=t.minionPath[e],s=this.worldToScreen(i);this.ctx.beginPath(),this.ctx.arc(s.x,s.y,5,0,2*Math.PI),this.ctx.fill(),e===t.minionPath.length-1&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,8,0,2*Math.PI),this.ctx.stroke())}}this.pathPreviewForge===t&&(this.pathPreviewPoints.length>0||this.pathPreviewEnd)&&this.drawMinionPathPreview(t.position,this.pathPreviewPoints,this.pathPreviewEnd),t.isSelected&&this.selectedHeroNames.length>0&&this.drawHeroButtons(t,o,this.selectedHeroNames)}const h=r?this.darkenColor(s?this.enemyColor:this.playerColor,l):s?this.enemyColor:this.playerColor,c=this.getForgeSpritePath(t),d=c?this.getTintedSprite(c,h):null;if(d){const e=n*this.FORGE_SPRITE_SCALE;this.ctx.drawImage(d,o.x-e/2,o.y-e/2,e,e),this.drawForgeFlames(t,o,e,i,r),this.ctx.strokeStyle=t.isReceivingLight?r?this.darkenColor("#00FF00",l):"#00FF00":r?this.darkenColor("#FF0000",l):"#FF0000",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,.52*e,0,2*Math.PI),this.ctx.stroke()}else{this.ctx.fillStyle=a,this.ctx.strokeStyle=t.isReceivingLight?r?this.darkenColor("#00FF00",l):"#00FF00":r?this.darkenColor("#FF0000",l):"#FF0000",this.ctx.lineWidth=3,this.ctx.beginPath();for(let e=0;e<6;e++){const i=Math.PI/3*e+t.rotation,s=o.x+n*Math.cos(i),r=o.y+n*Math.sin(i);0===e?this.ctx.moveTo(s,r):this.ctx.lineTo(s,r)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}if(this.drawHealthDisplay(o,t.health,this.FORGE_MAX_HEALTH,n,-n-15),t.heroProductionUnitType&&t.heroProductionDurationSec>0){const e=2*n,i=6,s=o.x-e/2,r=o.y+n+10,a=Math.max(0,Math.min(1,1-t.heroProductionRemainingSec/t.heroProductionDurationSec));this.ctx.fillStyle="#222",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#00FF88",this.ctx.fillRect(s,r,e*a,i)}t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,r?a:e)}drawHeroButtons(t,e,i){const s=28*this.zoom,o=100*this.zoom,n=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],r=i.slice(0,n.length);for(let i=0;i<r.length;i++){const a=r[i],l=n[i],h=e.x+l.x*o,c=e.y+l.y*o,d=this.getHeroUnitType(a),g=!!d&&this.isHeroUnitAlive(t.owner,d),u=!!d&&this.isHeroUnitQueuedOrProducing(t,d),p=!!d&&!g&&!u;this.ctx.fillStyle=p?"rgba(0, 255, 136, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=p?"#00FF88":"#888888",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(h,c,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=p?"#FFFFFF":"#666666",this.ctx.font=14*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,h,c),u?this.drawHeroHourglass(h,c,s):g&&this.drawHeroCheckmark(h,c,s)}}getHeroUnitType(t){switch(t){case"Marine":case"Grave":case"Ray":case"Dagger":case"Beam":case"Driller":return t;case"Influence Ball":return"InfluenceBall";case"Turret Deployer":return"TurretDeployer";default:return null}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof X;case"Grave":return t instanceof q;case"Ray":return t instanceof Z;case"InfluenceBall":return t instanceof tt;case"TurretDeployer":return t instanceof it;case"Driller":return t instanceof st;case"Dagger":return t instanceof ot;case"Beam":return t instanceof nt;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}drawHeroHourglass(t,e,i){const s=.7*i,o=.8*i,n=t-.5*s,r=t+.5*s,a=e-.5*o,l=e+.5*o,h=e;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.moveTo(n,a),this.ctx.lineTo(r,a),this.ctx.lineTo(t,h),this.ctx.closePath(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n,l),this.ctx.lineTo(r,l),this.ctx.lineTo(t,h),this.ctx.closePath(),this.ctx.stroke()}drawHeroCheckmark(t,e,i){const s=.7*i,o=.6*i,n=t-.45*s,r=e+.05*o,a=t-.1*s,l=e+.35*o,h=t+.5*s,c=e-.35*o;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.moveTo(n,r),this.ctx.lineTo(a,l),this.ctx.lineTo(h,c),this.ctx.stroke()}drawSolarMirror(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}const r=this.worldToScreen(t.position),a=20*this.zoom;this.ctx.save();const h=Math.max(0,Math.min(1,1-t.closestSunDistance/w));if(h>.1&&t.closestSunDistance!==1/0){const e=15*this.zoom*(1+h),s=this.ctx.createRadialGradient(r.x,r.y,0,r.x,r.y,e);s.addColorStop(0,`rgba(255, 255, 150, ${.8*h})`),s.addColorStop(.5,`rgba(255, 255, 100, ${.4*h})`),s.addColorStop(1,"rgba(255, 255, 50, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(r.x,r.y,e,0,2*Math.PI),this.ctx.fill();const o=t.getClosestVisibleSun(i.suns,i.asteroids);if(o){const e=t.owner.stellarForge;let s=null;if(e&&t.hasLineOfSightToForge(e,i.asteroids,i.players))s=new v(e.position.x-t.position.x,e.position.y-t.position.y).normalize();else{const e=new v(o.position.x-t.position.x,o.position.y-t.position.y).normalize();s=new v(-e.x,-e.y)}const n=100,a=new v(t.position.x+s.x*n,t.position.y+s.y*n),l=this.worldToScreen(a),c=this.ctx.createLinearGradient(r.x,r.y,l.x,l.y);c.addColorStop(0,`rgba(255, 255, 200, ${1*h})`),c.addColorStop(.7,`rgba(255, 255, 150, ${.6*h})`),c.addColorStop(1,"rgba(255, 255, 100, 0)"),this.ctx.strokeStyle=c,this.ctx.lineWidth=15*this.zoom*h,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y),this.ctx.lineTo(l.x,l.y),this.ctx.stroke();const d=20*this.zoom*h,g=this.ctx.createRadialGradient(l.x,l.y,0,l.x,l.y,d);g.addColorStop(0,`rgba(255, 255, 255, ${.9*h})`),g.addColorStop(.5,`rgba(255, 255, 200, ${.5*h})`),g.addColorStop(1,"rgba(255, 255, 150, 0)"),this.ctx.fillStyle=g,this.ctx.beginPath(),this.ctx.arc(l.x,l.y,d,0,2*Math.PI),this.ctx.fill()}}this.ctx.translate(r.x,r.y),this.ctx.rotate(t.reflectionAngle);const c=2*a,d=.3*a;let g=c,u=d,p=!1;const x=this.getSolarMirrorSpritePath(t);if(x){const t=this.brightenAndPaleColor(n),e=this.getTintedSprite(x,t);if(e){const t=2.4*a/Math.max(e.width,e.height),i=e.width*t,s=e.height*t;g=i,u=s,this.ctx.drawImage(e,-i/2,-s/2,i,s),p=!0}}if(!p){const t=this.ctx.createLinearGradient(0,-d/2,0,d/2);t.addColorStop(0,"#FFFFFF"),t.addColorStop(.5,"#E0E0E0"),t.addColorStop(1,"#C0C0C0"),this.ctx.fillStyle=t,this.ctx.fillRect(-c/2,-d/2,c,d),this.ctx.strokeStyle=n,this.ctx.lineWidth=2,this.ctx.strokeRect(-c/2,-d/2,c,d),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(-c/2,0,3,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(c/2,0,3,0,2*Math.PI),this.ctx.fill()}if(t.isSelected&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.strokeRect(-g/2-3,-u/2-3,g+6,u+6)),this.ctx.restore(),t.efficiency<1&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(r.x,r.y,.3*a,0,2*Math.PI),this.ctx.fill()),t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,e),this.drawHealthDisplay(r,t.health,this.MIRROR_MAX_HEALTH,a,-a-10),t.isSelected){const e=t.hasLineOfSightToLight(i.suns,i.asteroids),s=t.owner.stellarForge,o=!!s&&t.hasLineOfSightToForge(s,i.asteroids,i.players),n=e&&o?t.getEnergyRatePerSec():0,l=r.y+a+16*this.zoom;this.ctx.fillStyle="#FFFFAA",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`+${n.toFixed(0)}/s`,r.x,l)}}drawSpaceDust(t,e,i){const s=this.worldToScreen(t.position),o=1*this.zoom,n=e.isPointInShadow(t.position);if(null!==i&&n){const s=e.players[i];if(!e.isObjectVisibleToPlayer(t.position,s))return}let r=t.glowState;if(t.glowTransition>0&&t.glowState!==t.targetGlowState&&(r=t.glowState+(t.targetGlowState-t.glowState)*t.glowTransition),r>0){const e=o*(1.2+.35*r);this.ctx.fillStyle=t.currentColor,this.ctx.globalAlpha=.15+.1*r,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}this.ctx.fillStyle=t.currentColor,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.fill()}getClosestInfluenceOwnerIndex(e,i){let s=1/0,o=null;for(let n=0;n<i.players.length;n++){const r=i.players[n];if(r.stellarForge&&!r.isDefeated()){const i=e.distanceTo(r.stellarForge.position);i<t&&i<s&&(s=i,o=n)}}return o}drawAsteroid(t){const e=t.getWorldVertices();if(0===e.length)return;const i=e.map(t=>this.worldToScreen(t)),s=Math.min(1,Math.max(0,(t.size-30)/90)),o=this.interpolateHexColor(this.colorScheme.asteroidColors.fillStart,this.colorScheme.asteroidColors.fillEnd,s),n=this.interpolateHexColor(this.colorScheme.asteroidColors.strokeStart,this.colorScheme.asteroidColors.strokeEnd,s);this.ctx.fillStyle=o,this.ctx.strokeStyle=n,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)this.ctx.lineTo(i[t].x,i[t].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}drawSunRays(t){for(const e of t.suns){const t=this.worldToScreen(e.position),i=2*Math.max(this.canvas.width,this.canvas.height),s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,i);s.addColorStop(0,this.colorScheme.sunLightRays.nearCenter),s.addColorStop(.5,this.colorScheme.sunLightRays.mid),s.addColorStop(1,this.colorScheme.sunLightRays.edge),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}for(const e of t.suns){this.ctx.save(),this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="rgba(0, 0, 20, 0.5)";let i=!1;this.ctx.beginPath();for(const s of t.asteroids){const t=s.getWorldVertices();for(let s=0;s<t.length;s++){const o=t[s],n=t[(s+1)%t.length],r=new v((o.x+n.x)/2,(o.y+n.y)/2),l=new v(e.position.x-r.x,e.position.y-r.y),h=new v(-(n.y-o.y),n.x-o.x);if(l.x*h.x+l.y*h.y<0){const t=new v(o.x-e.position.x,o.y-e.position.y).normalize(),s=new v(n.x-e.position.x,n.y-e.position.y).normalize(),r=new v(o.x+t.x*a,o.y+t.y*a),l=new v(n.x+s.x*a,n.y+s.y*a),h=this.worldToScreen(o),c=this.worldToScreen(n),d=this.worldToScreen(r),g=this.worldToScreen(l);this.ctx.moveTo(h.x,h.y),this.ctx.lineTo(c.x,c.y),this.ctx.lineTo(g.x,g.y),this.ctx.lineTo(d.x,d.y),this.ctx.closePath(),i=!0}}}i&&this.ctx.fill(),this.ctx.restore()}}drawInfluenceCircle(t,e,i){const s=this.worldToScreen(t),o=e*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}drawWarpGate(t){const e=this.worldToScreen(t.position),i=50*this.zoom,s=t.chargeTime/6,o=Math.min(i,s*i);if(t.isComplete){this.ctx.fillStyle="rgba(0, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke();const t=28*this.zoom,s=i+30*this.zoom,o=[0,Math.PI/2,Math.PI,3*Math.PI/2],n=["Minigun","Swirler","Sub Factory","Locked"];for(let i=0;i<4;i++){const r=o[i],a=e.x+Math.cos(r)*s,l=e.y+Math.sin(r)*s,h=t+14*this.zoom;this.ctx.fillStyle=3===i?"#2A2A2A":"#444444",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(a,l,t,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=3===i?"rgba(255, 255, 255, 0.6)":"#FFFFFF",this.ctx.font=11*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(n[i],a+Math.cos(r)*h,l+Math.sin(r)*h)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}else this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.globalAlpha=.5+.2*Math.sin(5*t.chargeTime),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,o,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=5,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,o+5,0,s*Math.PI*2),this.ctx.stroke()}drawUnit(t,e,i,s,o=1){const n=this.worldToScreen(t.position),r=8*this.zoom*o,a=this.selectedUnits.has(t);let h=!1,c=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(e,l))}if(a&&t.isHero&&!s){const i=t.attackRange*this.zoom;this.ctx.strokeStyle=e,this.ctx.lineWidth=1,this.ctx.globalAlpha=.2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,i,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}const d=t.isHero?this.getHeroSpritePath(t):null,g=h?this.darkenColor(s?this.enemyColor:this.playerColor,l):s?this.enemyColor:this.playerColor,u=d?a&&!s?this.getOutlinedTintedSprite(d,g):this.getTintedSprite(d,g):null;if(u){const e=r*this.HERO_SPRITE_SCALE,i=t.rotation;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(i),this.ctx.drawImage(u,-e/2,-e/2,e,e),this.ctx.restore()}else this.ctx.fillStyle=c,this.ctx.strokeStyle=a?"#FFFFFF":h?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=a?3:1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();if(this.drawHealthDisplay(n,t.health,t.maxHealth,r,-r-8),!t.isHero&&t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y,s=Math.atan2(i,e);this.ctx.strokeStyle=h?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(n.x+Math.cos(s)*r*1.5,n.y+Math.sin(s)*r*1.5),this.ctx.stroke()}t.moveOrder>0&&t.rallyPoint&&this.drawMoveOrderIndicator(t.position,t.rallyPoint,t.moveOrder,h?c:e)}drawMoveOrderIndicator(t,e,i,s){const o=this.worldToScreen(t),n=this.worldToScreen(e);this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.globalAlpha=.5,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(n.x,n.y),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=1;const r=this.MOVE_ORDER_DOT_RADIUS;this.ctx.fillStyle=s,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i.toString(),n.x,n.y)}drawMuzzleFlash(t){const e=this.worldToScreen(t.position),i=5*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.angle),this.ctx.fillStyle=`rgba(255, 255, 100, ${s})`,this.ctx.beginPath(),this.ctx.ellipse(0,0,2*i,i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBulletCasing(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=5*this.zoom,o=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.rotation),this.ctx.fillStyle=`rgba(255, 215, 0, ${o})`,this.ctx.fillRect(-i/2,-s/2,i,s),this.ctx.restore()}drawBouncingBullet(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=`rgba(255, 255, 0, ${s})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill()}drawAbilityBullet(t){const e=this.worldToScreen(t.position),i=4*this.zoom,s=t.lifetime/t.maxLifetime,o=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=`${o}`,this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawMinionProjectile(t){const e=this.worldToScreen(t.position),i=2.5*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.globalAlpha=.9,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawLaserBeam(t){const e=this.worldToScreen(t.startPos),i=this.worldToScreen(t.endPos),s=this.getFactionColor(t.owner.faction),o=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=s,this.ctx.globalAlpha=.8*o,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=.3*o,this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=1}drawImpactParticle(t){const e=this.worldToScreen(t.position),i=this.getFactionColor(t.faction),s=1-t.lifetime/t.maxLifetime,o=1*this.zoom;this.ctx.fillStyle=i,this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawInfluenceZone(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=Math.max(.1,1-t.lifetime/t.duration),o=this.getFactionColor(t.owner.faction);this.ctx.strokeStyle=o,this.ctx.globalAlpha=.6*s,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);n.addColorStop(0,`${o}40`),n.addColorStop(1,`${o}10`),this.ctx.fillStyle=n,this.ctx.globalAlpha=.3*s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawInfluenceBallProjectile(t){const e=this.worldToScreen(t.position),i=12*this.zoom,s=this.getFactionColor(t.owner.faction),o=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);o.addColorStop(0,s),o.addColorStop(.5,`${s}AA`),o.addColorStop(1,`${s}00`),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.3*i,0,2*Math.PI),this.ctx.fill()}drawDeployedTurret(t){const e=this.worldToScreen(t.position),i=15*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.fillRect(e.x-.6*i,e.y-.4*i,1.2*i,.8*i),this.ctx.fillStyle=s,this.ctx.fillRect(e.x-.3*i,e.y-i,.6*i,i),this.drawHealthDisplay(e,t.health,t.maxHealth,i,i)}drawGrave(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}this.drawUnit(t,n,i,s);const r=this.worldToScreen(t.position),a=10*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y-a),this.ctx.lineTo(r.x,r.y+a),this.ctx.moveTo(r.x-.7*a,r.y-.3*a),this.ctx.lineTo(r.x+.7*a,r.y-.3*a),this.ctx.stroke();for(const e of t.getProjectiles())this.drawGraveProjectile(e,n)}drawMergedStarlingRanges(t){const e=[];for(const t of this.selectedUnits)t instanceof Y&&this.viewingPlayer&&t.owner===this.viewingPlayer&&e.push(t);if(0===e.length)return;const i=this.getFactionColor(this.viewingPlayer.faction);this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.globalAlpha=.2,this.ctx.beginPath();for(let t=0;t<e.length;t++){const i=e[t],s=(this.worldToScreen(i.position),i.attackRange,this.zoom,Math.PI/32);let o=!1;for(let n=0;n<2*Math.PI;n+=s){const s=i.position.x+Math.cos(n)*i.attackRange,r=i.position.y+Math.sin(n)*i.attackRange;let a=!0;for(let i=0;i<e.length;i++){if(t===i)continue;const o=e[i],n=s-o.position.x,l=r-o.position.y;if(n*n+l*l<o.attackRange*o.attackRange){a=!1;break}}const l=this.worldToScreen({x:s,y:r}).x,h=this.worldToScreen({x:s,y:r}).y;a?o?this.ctx.lineTo(l,h):(this.ctx.moveTo(l,h),o=!0):o=!1}}this.ctx.stroke(),this.ctx.globalAlpha=1}drawStarling(t,e,i,s){const o=this.worldToScreen(t.position),n=8*this.zoom*.3,r=this.selectedUnits.has(t);let a=!1,h=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(a=!0,h=this.darkenColor(e,l))}const c=this.getStarlingSpritePath(t),d=a?this.darkenColor(s?this.enemyColor:this.playerColor,l):s?this.enemyColor:this.playerColor,g=c?r&&!s?this.getOutlinedTintedSprite(c,d):this.getTintedSprite(c,d):null;if(g){const e=6*n,i=this.getStarlingFacingRotationRad(t);null!==i?(this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(i),this.ctx.drawImage(g,-e/2,-e/2,e,e),this.ctx.restore()):this.ctx.drawImage(g,o.x-e/2,o.y-e/2,e,e)}else this.ctx.fillStyle=h,this.ctx.strokeStyle=r?"#FFFFFF":a?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=r?3:1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();this.drawHealthDisplay(o,t.health,t.maxHealth,n,6*-n-10)}drawStarlingMoveLines(t){if(!this.viewingPlayer)return;const e=new Map;for(const t of this.selectedUnits)if(t instanceof Y&&t.owner===this.viewingPlayer&&t.rallyPoint&&t.moveOrder>0){const i=`${t.rallyPoint.x},${t.rallyPoint.y}`;e.has(i)||e.set(i,{rallyPoint:t.rallyPoint,starlings:[]}),e.get(i).starlings.push(t)}const i=this.getFactionColor(this.viewingPlayer.faction);for(const[t,s]of e){if(0===s.starlings.length)continue;let t=s.starlings[0],e=1/0;for(const i of s.starlings){const o=s.rallyPoint.x-i.position.x,n=s.rallyPoint.y-i.position.y,r=o*o+n*n;r<e&&(e=r,t=i)}this.drawMoveOrderIndicator(t.position,s.rallyPoint,t.moveOrder,i)}}drawRay(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}this.drawUnit(t,n,i,s);const r=this.worldToScreen(t.position),a=10*this.zoom;this.ctx.strokeStyle=n,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y-a),this.ctx.lineTo(r.x-.3*a,r.y),this.ctx.lineTo(r.x+.3*a,r.y),this.ctx.lineTo(r.x,r.y+a),this.ctx.stroke();const h=t.getBeamSegments();for(const t of h){const e=this.worldToScreen(t.startPos),i=this.worldToScreen(t.endPos),s=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=n,this.ctx.globalAlpha=s,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}this.ctx.globalAlpha=1}drawInfluenceBall(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}this.drawUnit(t,n,i,s);const r=this.worldToScreen(t.position),a=12*this.zoom;this.ctx.strokeStyle=n,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.arc(r.x,r.y,a,0,2*Math.PI),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(r.x,r.y,.6*a,0,2*Math.PI),this.ctx.stroke()}drawTurretDeployer(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}this.drawUnit(t,n,i,s);const r=this.worldToScreen(t.position),a=10*this.zoom;this.ctx.fillStyle=n,this.ctx.fillRect(r.x-.5*a,r.y-.3*a,a,.6*a),this.ctx.fillRect(r.x-.2*a,r.y-a,.4*a,a)}drawDriller(t,e,i,s){if(t.isHiddenInAsteroid())return;let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}this.drawUnit(t,n,i,s);const r=this.worldToScreen(t.position),a=10*this.zoom;this.ctx.strokeStyle=n,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(r.x-a,r.y),this.ctx.lineTo(r.x,r.y-.5*a),this.ctx.lineTo(r.x+a,r.y),this.ctx.lineTo(r.x,r.y+.5*a),this.ctx.closePath(),this.ctx.stroke()}drawDagger(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}let r=!1;if(!s&&t.isCloakedToEnemies()&&(r=!0,this.ctx.globalAlpha=.4),this.drawUnit(t,r?e:n,i,s),r){const i=this.worldToScreen(t.position),s=8*this.zoom;this.ctx.strokeStyle=e,this.ctx.lineWidth=1.5*this.zoom,this.ctx.setLineDash([3*this.zoom,3*this.zoom]),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s+6,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([])}if(!t.isCloakedToEnemies()&&!s){const e=this.worldToScreen(t.position),i=8*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#FF6600",l):"#FF6600",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x-.7*i,e.y-.7*i),this.ctx.lineTo(e.x+.7*i,e.y+.7*i),this.ctx.stroke()}r&&(this.ctx.globalAlpha=1)}drawBeam(t,e,i,s){let o=!1,n=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;i.isPointInShadow(t.position)&&(o=!0,n=this.darkenColor(e,l))}if(this.drawUnit(t,n,i,s),!s){const e=this.worldToScreen(t.position),i=10*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#FF0000",l):"#FF0000",this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x-i,e.y),this.ctx.lineTo(e.x+i,e.y),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y+i),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.3*i,0,2*Math.PI),this.ctx.stroke()}if(i.gameTime-t.lastBeamTime<2&&t.lastBeamMultiplier>0){const e=this.worldToScreen(t.position),s=-20*this.zoom,o=`(30x${t.lastBeamMultiplier.toFixed(1)})`,n=10*this.zoom;this.ctx.font=`${n}px Doto`,this.ctx.fillStyle="#FFAA00",this.ctx.textAlign="center",this.ctx.textBaseline="bottom";const r=i.gameTime-t.lastBeamTime,a=Math.max(0,1-r/2);this.ctx.globalAlpha=a,this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeText(o,e.x,e.y+s),this.ctx.fillText(o,e.x,e.y+s),this.ctx.globalAlpha=1}}drawMinigun(t,e,i,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom;let r=!1,a=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(r=!0,a=this.darkenColor(e,l))}if(!t.isComplete){this.ctx.fillStyle="rgba(0, 255, 255, 0.2)",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const e=2*n,i=4,s=o.x-e/2,a=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,a,e,i),this.ctx.fillStyle="#00FF00",this.ctx.fillRect(s,a,e*t.buildProgress,i),void(r&&(this.ctx.globalAlpha=1))}this.ctx.fillStyle=a,this.ctx.strokeStyle=r?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const h=.6*n;this.ctx.fillStyle=r?this.darkenColor("#666666",l):"#666666",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,h,0,2*Math.PI),this.ctx.fill();let c=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;c=Math.atan2(i,e)}const d=1.2*n,g=4*this.zoom;this.ctx.strokeStyle=r?this.darkenColor("#333333",l):"#333333",this.ctx.lineWidth=g,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(o.x+Math.cos(c)*d,o.y+Math.sin(c)*d),this.ctx.stroke(),this.drawHealthDisplay(o,t.health,t.maxHealth,n,-n-10)}drawSpaceDustSwirler(t,e,i,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom;let r=!1,a=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(r=!0,a=this.darkenColor(e,l))}if(!t.isComplete){this.ctx.fillStyle="rgba(138, 43, 226, 0.2)",this.ctx.strokeStyle="#8A2BE2",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const e=2*n,i=4,s=o.x-e/2,a=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,a,e,i),this.ctx.fillStyle="#8A2BE2",this.ctx.fillRect(s,a,e*t.buildProgress,i),void(r&&(this.ctx.globalAlpha=1))}const h=p*this.zoom;this.ctx.strokeStyle=a,this.ctx.globalAlpha=.15,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,h,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,this.ctx.fillStyle=a,this.ctx.strokeStyle=r?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const c=.7*n;this.ctx.strokeStyle=r?this.darkenColor("#8A2BE2",l):"#8A2BE2",this.ctx.lineWidth=3*this.zoom,this.ctx.lineCap="round";for(let t=0;t<3;t++){const e=(Date.now()/500+t*Math.PI*2/3)%(2*Math.PI);this.ctx.beginPath(),this.ctx.arc(o.x,o.y,c,e,e+Math.PI/2),this.ctx.stroke()}const d=.25*n;this.ctx.fillStyle=r?this.darkenColor("#DDA0DD",l):"#DDA0DD",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,d,0,2*Math.PI),this.ctx.fill(),this.drawHealthDisplay(o,t.health,t.maxHealth,n,-n-10)}drawSubsidiaryFactory(t,e,i,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom;let r=!1,a=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(r=!0,a=this.darkenColor(e,l))}if(!t.isComplete){this.ctx.fillStyle="rgba(255, 215, 0, 0.2)",this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const e=2*n,i=4,s=o.x-e/2,a=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,a,e,i),this.ctx.fillStyle="#FFD700",this.ctx.fillRect(s,a,e*t.buildProgress,i),void(r&&(this.ctx.globalAlpha=1))}this.ctx.fillStyle=a,this.ctx.strokeStyle=r?this.darkenColor("#FFFFFF",l):"#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath();for(let t=0;t<6;t++){const e=Math.PI/3*t,i=o.x+Math.cos(e)*n,s=o.y+Math.sin(e)*n;0===t?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();const h=.6*n,c=Date.now()/1e3%(2*Math.PI);this.ctx.strokeStyle=r?this.darkenColor("#FFD700",l):"#FFD700",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath();for(let t=0;t<6;t++){const e=Math.PI/3*t+c,i=o.x+Math.cos(e)*h,s=o.y+Math.sin(e)*h;0===t?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}this.ctx.closePath(),this.ctx.stroke();const d=.3*n;this.ctx.fillStyle=r?this.darkenColor("#FFD700",l):"#FFD700",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,d,0,2*Math.PI),this.ctx.fill(),this.drawHealthDisplay(o,t.health,t.maxHealth,n,-n-10)}drawGraveProjectile(t,e){const i=this.worldToScreen(t.position),s=4*this.zoom;if(t.isAttacking&&t.trail.length>1){this.ctx.strokeStyle=e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath();for(let e=0;e<t.trail.length;e++){const i=this.worldToScreen(t.trail[e]);0===e?this.ctx.moveTo(i.x,i.y):this.ctx.lineTo(i.x,i.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle=e,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isAttacking&&(this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,1.5*s,0,2*Math.PI),this.ctx.fill())}drawConnections(t,e,i,s){if(!t.stellarForge)return;if(this.viewingPlayer&&t!==this.viewingPlayer)return;const o=this.worldToScreen(t.stellarForge.position);for(const n of t.solarMirrors){const r=this.worldToScreen(n.position),a=n.hasLineOfSightToLight(e,i),l=a?n.getClosestVisibleSun(e,i):n.getClosestSun(e),h=n.hasLineOfSightToForge(t.stellarForge,i,s);if(l&&!a){const t=this.worldToScreen(l.position);this.ctx.strokeStyle="rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}h||(this.ctx.strokeStyle="rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y),this.ctx.lineTo(o.x,o.y),this.ctx.stroke(),this.ctx.setLineDash([])),a&&h&&(this.ctx.fillStyle="rgba(255, 255, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(r.x,r.y,15*this.zoom,0,2*Math.PI),this.ctx.fill())}}drawUI(t){if(this.showInfo){const e=window.devicePixelRatio||1,i=this.canvas.width/e,s=this.canvas.height/e,o=i<600,n=o?13:16,r=n+4,a=Math.min(300,i-20),l=20+5*r+60*t.players.length;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,10,a,l),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${n}px Doto`;let h=30;this.ctx.fillText("SoL - Speed of Light RTS",20,h),h+=r,this.ctx.fillText(`Game Time: ${t.gameTime.toFixed(1)}s`,20,h),h+=r,this.ctx.fillText(`Dust Particles: ${t.spaceDust.length}`,20,h),h+=r,this.ctx.fillText(`Asteroids: ${t.asteroids.length}`,20,h),h+=r,this.ctx.fillText(`Warp Gates: ${t.warpGates.length}`,20,h);let c=h+r;for(const e of t.players){const t=this.getFactionColor(e.faction);if(this.ctx.fillStyle=t,this.ctx.fillText(`${e.name} (${e.faction})`,20,c),this.ctx.fillStyle="#FFFFFF",this.ctx.fillText(`Energy: ${e.energy.toFixed(1)}`,20,c+20),e.stellarForge){const t=e.stellarForge.isReceivingLight?" Light":" No Light";this.ctx.fillText(`${t} | HP: ${e.stellarForge.health.toFixed(0)}`,20,c+40)}c+=60}const d=o?xt.CONTROL_LINES_COMPACT:xt.CONTROL_LINES_FULL,g=o?12:14,u=g+4,p=Math.min(450,i-20),x=u*d.length+14,y=10,f=s-x-10;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(y,f,p,x),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${g}px Doto`;let m=f+u;for(const t of d)this.ctx.fillText(t,20,m),m+=u}}drawSelectionRectangle(){if(!this.selectionStart||!this.selectionEnd)return;const t=Math.min(this.selectionStart.x,this.selectionEnd.x),e=Math.min(this.selectionStart.y,this.selectionEnd.y),i=Math.abs(this.selectionEnd.x-this.selectionStart.x),s=Math.abs(this.selectionEnd.y-this.selectionStart.y);this.ctx.strokeStyle="rgba(0, 255, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="rgba(0, 255, 0, 0.1)",this.ctx.fillRect(t,e,i,s),this.ctx.setLineDash([])}drawAbilityArrow(){if(!this.abilityArrowStart||!this.abilityArrowEnd)return;const t=this.abilityArrowEnd.x-this.abilityArrowStart.x,e=this.abilityArrowEnd.y-this.abilityArrowStart.y;if(Math.sqrt(t*t+e*e)<10)return;this.ctx.strokeStyle="rgba(255, 215, 0, 0.9)",this.ctx.lineWidth=4,this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(this.abilityArrowStart.x,this.abilityArrowStart.y),this.ctx.lineTo(this.abilityArrowEnd.x,this.abilityArrowEnd.y),this.ctx.stroke();const i=Math.atan2(e,t),s=Math.PI/6;this.ctx.fillStyle="rgba(255, 215, 0, 0.9)",this.ctx.beginPath(),this.ctx.moveTo(this.abilityArrowEnd.x,this.abilityArrowEnd.y),this.ctx.lineTo(this.abilityArrowEnd.x-20*Math.cos(i-s),this.abilityArrowEnd.y-20*Math.sin(i-s)),this.ctx.lineTo(this.abilityArrowEnd.x-20*Math.cos(i+s),this.abilityArrowEnd.y-20*Math.sin(i+s)),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 215, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(this.abilityArrowStart.x,this.abilityArrowStart.y,8,0,2*Math.PI),this.ctx.fill()}drawUnitPathPreview(){if(!this.pathPreviewForge&&this.pathPreviewPoints.length>0){let t=0,e=0,i=0;for(const s of this.selectedUnits)t+=s.position.x,e+=s.position.y,i++;if(i>0){const s=new v(t/i,e/i);this.drawMinionPathPreview(s,this.pathPreviewPoints,this.pathPreviewEnd)}}}drawMinionPathPreview(t,e,i){this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=3,this.ctx.setLineDash([6,6]),this.ctx.beginPath();const s=this.worldToScreen(t);this.ctx.moveTo(s.x,s.y);for(let t=0;t<e.length;t++){const i=this.worldToScreen(e[t]);this.ctx.lineTo(i.x,i.y)}if(i){const t=this.worldToScreen(i);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(255, 255, 0, 0.9)";for(let t=0;t<e.length;t++){const i=this.worldToScreen(e[t]);this.ctx.beginPath(),this.ctx.arc(i.x,i.y,4,0,2*Math.PI),this.ctx.fill()}if(i){const t=this.worldToScreen(i);this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,6,0,2*Math.PI),this.ctx.stroke()}}createTapEffect(t,e){this.tapEffects.push({position:new v(t,e),progress:0})}createSwipeEffect(t,e,i,s){this.swipeEffects.push({start:new v(t,e),end:new v(i,s),progress:0})}createWarpGateShockwave(t){this.warpGateShockwaves.push({position:new v(t.x,t.y),progress:0})}createProductionButtonWave(t){this.productionButtonWaves.push({position:new v(t.x,t.y),progress:0})}updateAndDrawTapEffects(){for(let t=this.tapEffects.length-1;t>=0;t--){const e=this.tapEffects[t];if(e.progress+=.05,e.progress>=1){this.tapEffects.splice(t,1);continue}const i=40*e.progress,s=1-e.progress;this.ctx.strokeStyle=`rgba(100, 200, 255, ${s})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,i,0,2*Math.PI),this.ctx.stroke();const o=this.ctx.createRadialGradient(e.position.x,e.position.y,0,e.position.x,e.position.y,.5*i);o.addColorStop(0,`rgba(100, 200, 255, ${.5*s})`),o.addColorStop(1,"rgba(100, 200, 255, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,.5*i,0,2*Math.PI),this.ctx.fill()}}updateAndDrawSwipeEffects(){for(let t=this.swipeEffects.length-1;t>=0;t--){const e=this.swipeEffects[t];if(e.progress+=.08,e.progress>=1){this.swipeEffects.splice(t,1);continue}const i=e.end.x-e.start.x,s=e.end.y-e.start.y,o=Math.sqrt(i*i+s*s);if(o<5)continue;const n=1-e.progress,r=o*e.progress;this.ctx.strokeStyle=`rgba(255, 200, 100, ${.7*n})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(e.start.x,e.start.y);const a=e.start.x+i/o*r,l=e.start.y+s/o*r;if(this.ctx.lineTo(a,l),this.ctx.stroke(),e.progress>.3){const t=Math.atan2(s,i);this.ctx.fillStyle=`rgba(255, 200, 100, ${n})`,this.ctx.beginPath(),this.ctx.moveTo(a,l),this.ctx.lineTo(a-15*Math.cos(t-Math.PI/6),l-15*Math.sin(t-Math.PI/6)),this.ctx.lineTo(a-15*Math.cos(t+Math.PI/6),l-15*Math.sin(t+Math.PI/6)),this.ctx.closePath(),this.ctx.fill()}for(let t=0;t<5;t++){const a=t/5,l=e.start.x+i/o*r*a,h=e.start.y+s/o*r*a,c=n*(1-a)*.3,d=this.ctx.createRadialGradient(l,h,0,l,h,10);d.addColorStop(0,`rgba(255, 200, 100, ${c})`),d.addColorStop(1,"rgba(255, 200, 100, 0)"),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(l,h,10,0,2*Math.PI),this.ctx.fill()}}}updateAndDrawWarpGateShockwaves(){for(let t=this.warpGateShockwaves.length-1;t>=0;t--){const e=this.warpGateShockwaves[t];if(e.progress+=.06,e.progress>=1){this.warpGateShockwaves.splice(t,1);continue}const i=this.worldToScreen(e.position),s=220*e.progress*this.zoom,o=.8*(1-e.progress);this.ctx.strokeStyle=`rgba(0, 255, 255, ${o})`,this.ctx.lineWidth=Math.max(2,3*this.zoom),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.stroke()}}updateAndDrawProductionButtonWaves(){for(let t=this.productionButtonWaves.length-1;t>=0;t--){const e=this.productionButtonWaves[t];if(e.progress+=.12,e.progress>=1){this.productionButtonWaves.splice(t,1);continue}const i=this.worldToScreen(e.position),s=48*e.progress*this.zoom,o=.9*(1-e.progress);this.ctx.strokeStyle=`rgba(255, 215, 0, ${o})`,this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,s);n.addColorStop(0,`rgba(255, 215, 0, ${.35*o})`),n.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,.6*s,0,2*Math.PI),this.ctx.fill()}}drawDamageNumbers(t){for(const e of t.damageNumbers){const i=this.worldToScreen(e.position),s=e.getOpacity(t.gameTime),o="remaining-life"===this.damageDisplayMode?e.remainingHealth:e.damage,n=e.damage/e.maxHealth,r=Math.max(8,Math.min(24,8+80*n));if(this.ctx.font=`bold ${r}px Doto`,"remaining-life"===this.damageDisplayMode){const t=e.remainingHealth/e.maxHealth,i=this.getHealthColor(t);this.ctx.fillStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${s})`}else this.ctx.fillStyle=`rgba(255, 100, 100, ${s})`;this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeStyle=`rgba(0, 0, 0, ${.8*s})`,this.ctx.lineWidth=2,this.ctx.strokeText(o.toString(),i.x,i.y),this.ctx.fillText(o.toString(),i.x,i.y)}}getHealthColor(t){if(t>.6){const e=(t-.6)/.4;return{r:Math.round(255*(1-e)),g:255,b:0}}if(t>.3){const e=(t-.3)/.3;return{r:255,g:Math.round(165+90*e),b:0}}{const e=t/.3;return{r:Math.round(180+75*e),g:Math.round(165*e),b:0}}}drawHealthDisplay(t,e,i,s,o){if(e>=i)return;const n=e/i;if("bar"===this.healthDisplayMode){const e=3*s,i=3,r=t.x-e/2,a=t.y+o;this.ctx.fillStyle="#333",this.ctx.fillRect(r,a,e,i),this.ctx.fillStyle=n>.5?"#00FF00":n>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(r,a,e*n,i)}else{const i=this.getHealthColor(n),r=Math.max(10,1.5*s);this.ctx.font=`bold ${r}px Doto`,this.ctx.fillStyle=`rgb(${i.r}, ${i.g}, ${i.b})`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeText(Math.round(e).toString(),t.x,t.y+o),this.ctx.fillText(Math.round(e).toString(),t.x,t.y+o)}}render(e){this.ctx.fillStyle=this.colorScheme.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.starLayers){this.ctx.fillStyle="#FFFFFF";const e=window.devicePixelRatio||1;for(const i of t.stars){const s=this.parallaxCamera.x*t.parallaxFactor,o=this.parallaxCamera.y*t.parallaxFactor,r=this.canvas.width/e/2,a=this.canvas.height/e/2,l=r+(i.x-s),h=a+(i.y-o),c=(l+r)%(2*r+n)-r,d=(h+a)%(2*a+n)-a;c>=-100&&c<=this.canvas.width/e+100&&d>=-100&&d<=this.canvas.height/e+100&&(this.ctx.globalAlpha=i.brightness,this.ctx.fillRect(c,d,i.size,i.size))}this.ctx.globalAlpha=1}const i=this.viewingPlayer?e.players.indexOf(this.viewingPlayer):null;for(const t of e.spaceDust)this.isWithinRenderBounds(t.position,e.mapSize,10)&&this.drawSpaceDust(t,e,i);for(const t of e.suns)this.drawSun(t);this.drawSunRays(e);for(const t of e.suns)this.drawLensFlare(t);for(const t of e.asteroids)this.isWithinRenderBounds(t.position,e.mapSize,t.size)&&this.drawAsteroid(t);const s=[];for(let o=0;o<e.players.length;o++){const n=e.players[o];if((null===i||o===i)&&n.stellarForge&&!n.isDefeated()){const e=0===o?this.playerColor:this.enemyColor;s.push({position:n.stellarForge.position,radius:t,color:e})}}const o=new Map;for(const t of s)o.has(t.color)||o.set(t.color,[]),o.get(t.color).push({position:t.position,radius:t.radius});for(const[t,e]of o)if(1===e.length)this.drawInfluenceCircle(e[0].position,e[0].radius,t);else{this.ctx.save(),this.ctx.beginPath();for(const t of e){const e=this.worldToScreen(t.position),i=t.radius*this.zoom;this.ctx.moveTo(e.x+i,e.y),this.ctx.arc(e.x,e.y,i,0,2*Math.PI)}this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle=t,this.ctx.globalAlpha=.05,this.ctx.fill(),this.ctx.globalAlpha=.3,this.ctx.strokeStyle=t,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}for(const t of e.players)t.isDefeated()||this.drawConnections(t,e.suns,e.asteroids,e.players);for(const t of e.players){if(t.isDefeated())continue;const i=this.getFactionColor(t.faction),s=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const o of t.solarMirrors)this.drawSolarMirror(o,i,e,s);t.stellarForge&&this.drawStellarForge(t.stellarForge,i,e,s)}for(const t of e.warpGates)this.drawWarpGate(t);this.updateAndDrawWarpGateShockwaves(),this.drawMergedStarlingRanges(e);for(const t of e.players){if(t.isDefeated())continue;const i=this.getFactionColor(t.faction),s=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const o of t.units)o instanceof q?this.drawGrave(o,i,e,s):o instanceof Y?this.drawStarling(o,i,e,s):o instanceof Z?this.drawRay(o,i,e,s):o instanceof tt?this.drawInfluenceBall(o,i,e,s):o instanceof it?this.drawTurretDeployer(o,i,e,s):o instanceof st?this.drawDriller(o,i,e,s):o instanceof ot?this.drawDagger(o,i,e,s):o instanceof nt?this.drawBeam(o,i,e,s):this.drawUnit(o,i,e,s)}this.drawStarlingMoveLines(e);for(const t of e.players){if(t.isDefeated())continue;const i=this.getFactionColor(t.faction),s=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const o of t.buildings)o instanceof E?this.drawMinigun(o,i,e,s):o instanceof R?this.drawSpaceDustSwirler(o,i,e,s):o instanceof k&&this.drawSubsidiaryFactory(o,i,e,s)}for(const t of e.muzzleFlashes)this.drawMuzzleFlash(t);for(const t of e.bulletCasings)this.drawBulletCasing(t);for(const t of e.bouncingBullets)this.drawBouncingBullet(t);for(const t of e.abilityBullets)this.drawAbilityBullet(t);for(const t of e.minionProjectiles)this.drawMinionProjectile(t);for(const t of e.laserBeams)this.drawLaserBeam(t);if("high"===this.graphicsQuality)for(const t of e.impactParticles)this.drawImpactParticle(t);for(const t of e.influenceZones)this.drawInfluenceZone(t);for(const t of e.influenceBallProjectiles)this.drawInfluenceBallProjectile(t);for(const t of e.deployedTurrets)this.drawDeployedTurret(t);this.drawDamageNumbers(e),this.drawBorderFade(e.mapSize),this.drawUI(e),this.drawSelectionRectangle(),this.drawAbilityArrow(),this.drawUnitPathPreview(),this.updateAndDrawProductionButtonWaves(),this.updateAndDrawTapEffects(),this.updateAndDrawSwipeEffects();const r=e.checkVictoryConditions();if(r&&this.drawEndGameStatsScreen(e,r),e.isCountdownActive){this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFD700",this.ctx.font="bold 120px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=Math.ceil(e.countdownTime),i=t>0?t.toString():"Go!";this.ctx.fillText(i,this.canvas.width/2,this.canvas.height/2),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}e.isCountdownActive||r||this.drawMenuButton(),e.isCountdownActive||r||this.drawProductionProgress(e),this.showInGameMenu&&!r&&this.drawInGameMenuOverlay()}drawMenuButton(){window.devicePixelRatio;this.ctx.fillStyle="rgba(50, 50, 50, 0.8)",this.ctx.fillRect(10,10,50,50),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(10,10,50,50),this.ctx.fillStyle="#FFFFFF";this.ctx.fillRect(20,22.5,30,3),this.ctx.fillRect(20,33.5,30,3),this.ctx.fillRect(20,44.5,30,3)}drawProductionProgress(t){const e=window.devicePixelRatio||1,i=200,s=this.canvas.width/e-i-10;let o=10;const n=t.players.find(t=>!t.isAi);if(!n)return;if(n.stellarForge&&n.stellarForge.heroProductionUnitType){const t=n.stellarForge;this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(s,o,i,60),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(s,o,i,60),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const e=this.getProductionDisplayName(t.heroProductionUnitType);this.ctx.fillText(e,s+8,o+8);const r=t.heroProductionDurationSec>0?1-t.heroProductionRemainingSec/t.heroProductionDurationSec:0;this.drawProgressBar(s+8,o+32,184,16,r),o+=68}const r=n.buildings.find(t=>!t.isComplete);if(r){this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(s,o,i,60),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(s,o,i,60),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const t=this.getBuildingDisplayName(r);this.ctx.fillText(`Building ${t}`,s+8,o+8),this.drawProgressBar(s+8,o+32,184,16,r.buildProgress)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawProgressBar(t,e,i,s,o){this.ctx.fillStyle="rgba(100, 100, 100, 0.8)",this.ctx.fillRect(t,e,i,s),this.ctx.fillStyle="#4CAF50",this.ctx.fillRect(t,e,i*o,s),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=1,this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`${Math.floor(100*o)}%`,t+i/2,e+s/2)}getBuildingDisplayName(t){return t instanceof E?"Minigun":t instanceof R?"Space Dust Swirler":t instanceof k?"Subsidiary Factory":"Building"}getProductionDisplayName(t){return{marine:"Marine",grave:"Grave",ray:"Ray",influenceball:"Influence Ball",turretdeployer:"Turret Deployer",driller:"Driller",dagger:"Dagger",beam:"Beam"}[t.toLowerCase()]||t}getInGameMenuLayout(){const t=window.devicePixelRatio||1,e=this.canvas.width/t,i=this.canvas.height/t,s=e<600,o=Math.min(480,e-40),n=Math.min(460,i-40),r=(e-o)/2,a=(i-n)/2,l=s?14:20,h=a+(s?34:42),c=s?30:34,d=(o-2*l-24)/3,g=h+(s?16:18),u=r+l,p=[{tab:"main",x:u,y:g,width:d,height:c},{tab:"options",x:u+d+12,y:g,width:d,height:c},{tab:"graphics",x:u+2*(d+12),y:g,width:d,height:c}],x=g+c+(s?16:20),y=a+n-(s?16:20),f=Math.min(300,o-2*l);return{screenWidth:e,screenHeight:i,panelX:r,panelY:a,panelWidth:o,panelHeight:n,isCompactLayout:s,titleY:h,tabs:p,contentTopY:x,contentBottomY:y,buttonWidth:f,buttonHeight:s?44:50,buttonX:r+(o-f)/2,buttonSpacing:s?14:20,graphicsListX:r+l,graphicsListY:x,graphicsListWidth:o-2*l,graphicsListHeight:Math.max(0,y-x),graphicsRowHeight:s?44:48,graphicsButtonWidth:s?54:60,graphicsButtonHeight:s?26:30,graphicsButtonGap:8}}getGraphicsMenuMaxScroll(t){const e=this.graphicsOptions.length*t.graphicsRowHeight;return Math.max(0,e-t.graphicsListHeight)}handleInGameMenuScroll(t,e,i){if(!this.showInGameMenu||"graphics"!==this.inGameMenuTab)return!1;const s=this.getInGameMenuLayout();if(!(t>=s.graphicsListX&&t<=s.graphicsListX+s.graphicsListWidth&&e>=s.graphicsListY&&e<=s.graphicsListY+s.graphicsListHeight))return!1;const o=this.getGraphicsMenuMaxScroll(s);return 0===o||(this.graphicsMenuScrollOffset=Math.min(o,Math.max(0,this.graphicsMenuScrollOffset+i))),!0}getInGameMenuAction(t,e){if(!this.showInGameMenu)return null;const i=this.getInGameMenuLayout();for(const s of i.tabs)if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return{type:"tab",tab:s.tab};if("main"===this.inGameMenuTab){let s=i.contentTopY;const o=[{action:{type:"resume"}},{action:{type:"toggleInfo"}},{action:{type:"surrender"}}];for(const n of o){if(t>=i.buttonX&&t<=i.buttonX+i.buttonWidth&&e>=s&&e<=s+i.buttonHeight)return n.action;s+=i.buttonHeight+i.buttonSpacing}return null}if("options"===this.inGameMenuTab){let s=i.contentTopY;const o=i.buttonHeight,n=i.buttonSpacing,r=i.buttonX,a=i.buttonWidth,l=.35*a,h=10,c=r+a-2*l-h,d=r+a-l;if(e>=s&&e<=s+o){if(t>=c&&t<=c+l)return{type:"damageDisplayMode",mode:"damage"};if(t>=d&&t<=d+l)return{type:"damageDisplayMode",mode:"remaining-life"}}s+=o+n;const g=r+a-2*l-h,u=r+a-l;if(e>=s&&e<=s+o){if(t>=g&&t<=g+l)return{type:"healthDisplayMode",mode:"bar"};if(t>=u&&t<=u+l)return{type:"healthDisplayMode",mode:"number"}}return null}if(!(t>=i.graphicsListX&&t<=i.graphicsListX+i.graphicsListWidth&&e>=i.graphicsListY&&e<=i.graphicsListY+i.graphicsListHeight))return null;const s=this.graphicsOptions.length*i.graphicsRowHeight,o=e-i.graphicsListY+this.graphicsMenuScrollOffset;if(o<0||o>s)return null;const n=Math.floor(o/i.graphicsRowHeight),r=this.graphicsOptions[n];if(!r)return null;const a=3*i.graphicsButtonWidth+2*i.graphicsButtonGap,l=i.graphicsListX+i.graphicsListWidth-a-8,h=i.graphicsListY+n*i.graphicsRowHeight-this.graphicsMenuScrollOffset+(i.graphicsRowHeight-i.graphicsButtonHeight)/2,c=["svg","png","stub"];for(let s=0;s<c.length;s+=1){const o=l+s*(i.graphicsButtonWidth+i.graphicsButtonGap);if(t>=o&&t<=o+i.graphicsButtonWidth&&e>=h&&e<=h+i.graphicsButtonHeight)return{type:"graphicsVariant",key:r.key,variant:c[s]}}return null}drawInGameMenuOverlay(){const t=this.getInGameMenuLayout(),e=t.screenWidth,i=t.screenHeight,s=t.isCompactLayout;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(0,0,e,i);const o=t.panelWidth,n=t.panelHeight,r=t.panelX,a=t.panelY;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(r,a,o,n),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(r,a,o,n),this.ctx.fillStyle="#FFD700",this.ctx.font=`bold ${s?22:30}px Doto`,this.ctx.textAlign="center",this.ctx.fillText("GAME MENU",e/2,t.titleY);for(const e of t.tabs){const t=this.inGameMenuTab===e.tab;this.ctx.fillStyle=t?"rgba(255, 215, 0, 0.3)":"rgba(60, 60, 60, 0.9)",this.ctx.fillRect(e.x,e.y,e.width,e.height),this.ctx.strokeStyle=t?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(e.x,e.y,e.width,e.height),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto";const i="main"===e.tab?"Main":"options"===e.tab?"Options":"Graphics";this.ctx.fillText(i,e.x+e.width/2,e.y+.68*e.height)}if("main"===this.inGameMenuTab){let i=t.contentTopY;const o=t.buttonWidth,n=t.buttonHeight,r=t.buttonX,a=t.buttonSpacing,l=(t,i)=>{this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(r,i,o,n),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(r,i,o,n),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?18:20)+"px Doto",this.ctx.fillText(t,e/2,i+.65*n)};l("Resume",i),i+=n+a,l(this.showInfo?"Hide Info":"Show Info",i),i+=n+a,l("Surrender",i)}else if("options"===this.inGameMenuTab){let e=t.contentTopY;const i=t.buttonHeight,o=t.buttonSpacing,n=t.buttonX,r=t.buttonWidth;this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Damage Display:",n,e+.4*i);const a={button1X:n+r-.35*r*2-10,button2X:n+r-.35*r,buttonWidth:.35*r},l="damage"===this.damageDisplayMode;this.ctx.fillStyle=l?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(a.button1X,e,a.buttonWidth,i),this.ctx.strokeStyle=l?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(a.button1X,e,a.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Dmg #",a.button1X+a.buttonWidth/2,e+.65*i);const h="remaining-life"===this.damageDisplayMode;this.ctx.fillStyle=h?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(a.button2X,e,a.buttonWidth,i),this.ctx.strokeStyle=h?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(a.button2X,e,a.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("HP Left",a.button2X+a.buttonWidth/2,e+.65*i),e+=i+o,this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Health Display:",n,e+.4*i);const c={button1X:n+r-.35*r*2-10,button2X:n+r-.35*r,buttonWidth:.35*r},d="bar"===this.healthDisplayMode;this.ctx.fillStyle=d?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c.button1X,e,c.buttonWidth,i),this.ctx.strokeStyle=d?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c.button1X,e,c.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Bar",c.button1X+c.buttonWidth/2,e+.65*i);const g="number"===this.healthDisplayMode;this.ctx.fillStyle=g?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c.button2X,e,c.buttonWidth,i),this.ctx.strokeStyle=g?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c.button2X,e,c.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Number",c.button2X+c.buttonWidth/2,e+.65*i)}else{const e=this.getGraphicsMenuMaxScroll(t);this.graphicsMenuScrollOffset>e&&(this.graphicsMenuScrollOffset=e),this.ctx.fillStyle="rgba(20, 20, 20, 0.85)",this.ctx.fillRect(t.graphicsListX,t.graphicsListY,t.graphicsListWidth,t.graphicsListHeight),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(t.graphicsListX,t.graphicsListY,t.graphicsListWidth,t.graphicsListHeight),this.ctx.clip();const i=t.graphicsListX+8,o=3*t.graphicsButtonWidth+2*t.graphicsButtonGap,n=t.graphicsListX+t.graphicsListWidth-o-8,r=[{variant:"svg",label:"SVG"},{variant:"png",label:"PNG"},{variant:"stub",label:"Stub"}];for(let e=0;e<this.graphicsOptions.length;e+=1){const o=this.graphicsOptions[e],a=t.graphicsListY+e*t.graphicsRowHeight-this.graphicsMenuScrollOffset;if(a+t.graphicsRowHeight<t.graphicsListY||a>t.graphicsListY+t.graphicsListHeight)continue;this.ctx.fillStyle=e%2==0?"rgba(40, 40, 40, 0.6)":"rgba(55, 55, 55, 0.6)",this.ctx.fillRect(t.graphicsListX,a,t.graphicsListWidth,t.graphicsRowHeight),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?13:15)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText(o.label,i,a+.65*t.graphicsRowHeight);const l=this.getGraphicVariant(o.key),h=a+(t.graphicsRowHeight-t.graphicsButtonHeight)/2;for(let e=0;e<r.length;e+=1){const i=r[e],a=n+e*(t.graphicsButtonWidth+t.graphicsButtonGap),c=l===i.variant,d="stub"===i.variant||"svg"===i.variant&&o.svgPath||"png"===i.variant&&o.pngPath;this.ctx.fillStyle=c?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",d||(this.ctx.fillStyle="rgba(50, 50, 50, 0.5)"),this.ctx.fillRect(a,h,t.graphicsButtonWidth,t.graphicsButtonHeight),this.ctx.strokeStyle=c?"#FFD700":"#FFFFFF",this.ctx.lineWidth=1.5,this.ctx.strokeRect(a,h,t.graphicsButtonWidth,t.graphicsButtonHeight),this.ctx.fillStyle=d?"#FFFFFF":"#888888",this.ctx.font=(s?11:12)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText(i.label,a+t.graphicsButtonWidth/2,h+.68*t.graphicsButtonHeight)}}this.ctx.restore()}this.ctx.textAlign="left"}drawEndGameStatsScreen(t,e){const i=window.devicePixelRatio||1,s=this.canvas.width/i,o=this.canvas.height/i,n=s<700;this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.fillRect(0,0,s,o),this.ctx.fillStyle=this.getFactionColor(e.faction);const r=Math.max(28,Math.min(48,.12*s));this.ctx.font=`bold ${r}px Doto`,this.ctx.textAlign="center",this.ctx.fillText(`${e.name} WINS!`,s/2,80);const a=Math.min(700,s-40),l=Math.min(450,o-200),h=(s-a)/2;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(h,130,a,l),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(h,130,a,l),this.ctx.fillStyle="#FFD700";const c=Math.max(18,Math.min(28,.07*s));this.ctx.font=`bold ${c}px Doto`,this.ctx.fillText("MATCH STATISTICS",s/2,180);const d=Math.max(14,Math.min(20,.045*s));this.ctx.font=`${d}px Doto`;let g=230;const u=Math.max(100,Math.min(200,.4*a)),p=t.players.length,x=a-48-u,y=Math.max(50,x/p),f=h+24,m=f+u;this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText("Statistic",f,g),this.ctx.textAlign="right";for(let e=0;e<t.players.length;e++){const i=t.players[e],s=this.getFactionColor(i.faction);this.ctx.fillStyle=s;const o=m+y*(e+1);this.ctx.fillText(i.name,o,g)}g+=n?32:40;const S=[{label:"Units Created",key:"unitsCreated"},{label:"Units Lost",key:"unitsLost"},{label:"Energy Gathered",key:"energyGathered"}];for(const e of S){this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText(e.label,f,g),this.ctx.textAlign="right";for(let i=0;i<t.players.length;i++){const s=t.players[i],o="energy"===e.key?s[e.key].toFixed(1):s[e.key],n=m+y*(i+1);this.ctx.fillText(String(o),n,g)}g+=n?28:35}const w=Math.min(300,s-60),F=n?50:60,P=(s-w)/2,C=Math.min(130+l+30,o-F-20);this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(P,C,w,F),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(P,C,w,F),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`bold ${n?20:24}px Doto`,this.ctx.textAlign="center",this.ctx.fillText("Continue",s/2,C+.65*F),this.ctx.textAlign="left"}drawBorderFade(t){const e=window.devicePixelRatio||1,i=this.canvas.width/e,s=this.canvas.height/e,o=150,n=t/2,r=this.worldToScreen(new v(-n,-n)),a=this.worldToScreen(new v(n,-n)),l=this.worldToScreen(new v(-n,n)),h=this.worldToScreen(new v(-n+o,0)),c=(this.worldToScreen(new v(n-o,0)),this.worldToScreen(new v(0,-n+o))),d=(this.worldToScreen(new v(0,n-o)),Math.abs(h.x-r.x)),g=Math.abs(c.y-r.y);if(this.ctx.save(),r.x<i){const t=this.ctx.createLinearGradient(r.x,0,r.x+d,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,r.x+d,s)}if(a.x>0){const t=this.ctx.createLinearGradient(a.x,0,a.x-d,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(a.x-d,0,i-(a.x-d),s)}if(r.y<s){const t=this.ctx.createLinearGradient(0,r.y,0,r.y+g);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,i,r.y+g)}if(l.y>0){const t=this.ctx.createLinearGradient(0,l.y,0,l.y-g);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,l.y-g,i,s-(l.y-g))}this.ctx.restore()}setZoom(t){this.zoom=Math.max(.5,Math.min(2,t))}setCameraPosition(t){const e=this.clampCameraToLevelBounds(t);this.camera=new v(e.x,e.y),this.parallaxCamera=new v(e.x,e.y)}setCameraPositionWithoutParallax(t){const e=this.clampCameraToLevelBounds(t);this.camera=new v(e.x,e.y)}clampCameraToLevelBounds(t){const e=window.devicePixelRatio||1,i=1e3-this.canvas.width/e/this.zoom/2,s=1e3-this.canvas.height/e/this.zoom/2,o=-i,n=-s,r=Math.max(o,Math.min(i,t.x)),a=Math.max(n,Math.min(s,t.y));return new v(r,a)}interpolateHexColor(t,e,i){const s=Number.parseInt(t.replace("#",""),16),o=Number.parseInt(e.replace("#",""),16),n=s>>16&255,r=s>>8&255,a=255&s,l=o>>16&255,h=o>>8&255,c=255&o;return`#${(Math.round(n+(l-n)*i)<<16|Math.round(r+(h-r)*i)<<8|Math.round(a+(c-a)*i)).toString(16).padStart(6,"0")}`}}xt.CONTROL_LINES_FULL=["Controls: Drag to select units","Pan: WASD/Arrows or mouse edge or two-finger drag","Zoom: Scroll/Pinch (zooms toward cursor)","Hold still 6 seconds in influence to open warp gate"],xt.CONTROL_LINES_COMPACT=["Controls: Drag to select units","Pan: WASD/Arrows or two-finger drag","Zoom: Scroll/Pinch toward cursor","Hold still 6s in influence to open warp gate"];class yt{hasOnlyHeroUnitsSelected(){return this.selectedUnits.size>0&&Array.from(this.selectedUnits).every(t=>t.isHero)}isDragStartNearSelectedUnits(t){if(0===this.selectedUnits.size)return!1;for(const e of this.selectedUnits)if(e.position.distanceTo(t)<=50)return!0;return!1}getHeroUnitType(t){switch(t){case"Marine":case"Grave":case"Ray":case"Dagger":case"Beam":case"Driller":return t;case"Influence Ball":return"InfluenceBall";case"Turret Deployer":return"TurretDeployer";default:return null}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof X;case"Grave":return t instanceof q;case"Ray":return t instanceof Z;case"InfluenceBall":return t instanceof tt;case"TurretDeployer":return t instanceof it;case"Driller":return t instanceof st;case"Dagger":return t instanceof ot;case"Beam":return t instanceof nt;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}getClickedHeroButton(t,e,i,s){const o=this.renderer.worldToScreen(i.position),n=28*this.renderer.zoom,r=100*this.renderer.zoom,a=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}],l=s.slice(0,a.length);for(let i=0;i<l.length;i++){const s=a[i],h=o.x+s.x*r,c=o.y+s.y*r,d=t-h,g=e-c;if(Math.sqrt(d*d+g*g)<=n){const t=this.renderer.screenToWorld(h,c);return{heroName:l[i],buttonPos:t}}}return null}clearPathPreview(){this.pathPoints=[],this.isDrawingPath=!1,this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=null}toggleInGameMenu(){this.showInGameMenu=!this.showInGameMenu,this.isPaused=this.showInGameMenu,this.renderer.showInGameMenu=this.showInGameMenu,this.renderer.isPaused=this.isPaused}toggleInfo(){this.showInfo=!this.showInfo,this.renderer.showInfo=this.showInfo}surrender(){if(!this.game)return;const t=this.game.players[0];t.stellarForge&&(t.stellarForge.health=0),this.showInGameMenu=!1,this.isPaused=!1,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,console.log("Player surrendered")}returnToMainMenu(){this.stop(),this.game=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,this.renderer.showInfo=this.showInfo,this.menu.show()}constructor(){this.game=null,this.lastTime=0,this.isRunning=!1,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=!1,this.holdStartTime=null,this.holdPosition=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedBase=null,this.isSelecting=!1,this.selectionStartScreen=null,this.isDraggingHeroArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.moveOrderCounter=0;const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element not found");this.renderer=new xt(t),this.menu=new gt,this.menu.onStart(t=>this.startNewGame(t)),this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.setupInputHandlers(t)}startNewGame(t){this.game=this.createGameFromSettings(t),this.renderer.selectedHeroNames=t.selectedHeroNames,this.renderer.playerColor=t.playerColor,this.renderer.enemyColor=t.enemyColor;const e=dt[t.colorScheme];if(e&&(this.renderer.colorScheme=e),this.renderer.damageDisplayMode=t.damageDisplayMode,this.renderer.healthDisplayMode=t.healthDisplayMode,this.game.damageDisplayMode=t.damageDisplayMode,this.renderer.graphicsQuality=t.graphicsQuality,this.game.players.length>0){this.renderer.viewingPlayer=this.game.players[0];const t=this.game.players[0];t.stellarForge&&(this.renderer.setCameraPosition(t.stellarForge.position),this.renderer.setZoom(.5))}this.showInfo=t.isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.start()}createGameFromSettings(t){var e,i,s;const o=null!==(e=t.selectedFaction)&&void 0!==e?e:M.RADIANT,n=M.RADIANT,r=dt[t.colorScheme],a=function(t,e){const i=new at;i.suns.push(new L(new v(0,0),1,100));const s=new v(-700,700),o=new v(700,-700),n=Math.random()<.5?[s,o]:[o,s];for(let e=0;e<t.length&&!(e>=n.length);e++){const[s,o]=t[e],r=new O(s,o);if(r.isAi=0!==e,r.isAi){const t=[C.ECONOMIC,C.DEFENSIVE,C.AGGRESSIVE,C.WAVES];r.aiStrategy=t[Math.floor(Math.random()*t.length)]}const a=n[e],l=c,h=[new v(a.x-l,a.y),new v(a.x+l,a.y)];i.initializePlayer(r,a,h),i.players.push(r)}if(i.players.length>=2)for(let t=0;t<i.players.length;t++){const e=i.players[t],s=(t+1)%i.players.length,o=i.players[s];e.stellarForge&&o.stellarForge&&e.stellarForge.initializeDefaultPath(o.stellarForge.position)}i.initializeSpaceDust(3e3,2e3,2e3,e),i.initializeAsteroids(10,2e3,2e3);const r=-Math.PI/4,a=new v(Math.cos(r)*h,Math.sin(r)*h);i.asteroids.push(new T(a,6,120));const l=3*Math.PI/4,d=new v(Math.cos(l)*h,Math.sin(l)*h);return i.asteroids.push(new T(d,6,120)),i.isRunning=!0,i}([["Player 1",o],["Player 2",n]],null==r?void 0:r.spaceDustPalette),l=t.selectedMap;if(a.mapSize=l.mapSize,a.suns=[],"twin-suns"===l.id?(a.suns.push(new L(new v(-300,-300),1,100)),a.suns.push(new L(new v(300,300),1,100))):(l.id,a.suns.push(new L(new v(0,0),1,100))),"test-level"===l.id){const t=new v(-700,0),e=new v(700,0),o=c,n=[new v(t.x,t.y-o),new v(t.x,t.y+o)],r=[t,e],l=[n,[new v(e.x,e.y-o),new v(e.x,e.y+o)]];for(let e=0;e<a.players.length;e++){const o=a.players[e],h=null!==(i=r[e])&&void 0!==i?i:t,c=null!==(s=l[e])&&void 0!==s?s:n;o.stellarForge=null,o.solarMirrors=[],a.initializePlayer(o,h,c)}if(a.players.length>=2){const t=a.players[0],e=a.players[1];t.stellarForge&&e.stellarForge&&(t.stellarForge.initializeDefaultPath(e.stellarForge.position),e.stellarForge.initializeDefaultPath(t.stellarForge.position))}return a.asteroids=[],a.spaceDust=[],a}const d=a.asteroids.slice(-2);a.asteroids=[],a.initializeAsteroids(l.numAsteroids,l.mapSize,l.mapSize),"standard"===l.id&&a.asteroids.push(...d),a.spaceDust=[];const g=(l.id,3e3);return a.initializeSpaceDust(g,l.mapSize,l.mapSize,null==r?void 0:r.spaceDustPalette),a}setupInputHandlers(t){const e=(e,i)=>{const s=t.getBoundingClientRect();return{x:e-s.left,y:i-s.top}};let i=!1,s=!1,o=0,n=0,r=0,a=0,l=0;const h=20,c=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window,d=new Set;t.addEventListener("wheel",t=>{if(t.preventDefault(),this.showInGameMenu){const i=e(t.clientX,t.clientY);if(this.renderer.handleInGameMenuScroll(i.x,i.y,t.deltaY))return}const i=e(t.clientX,t.clientY),s=this.renderer.screenToWorld(i.x,i.y),o=t.deltaY>0?.9:1.1,n=this.renderer.zoom;this.renderer.setZoom(n*o);const r=this.renderer.screenToWorld(i.x,i.y),a=this.renderer.camera;this.renderer.setCameraPositionWithoutParallax(new v(a.x+(s.x-r.x),a.y+(s.y-r.y)))});const g=(t,e)=>{o=t,n=e,this.selectionStartScreen=new v(t,e),this.isSelecting=!1;const i=this.renderer.screenToWorld(t,e);this.startHold(i)},u=(t,e,r=!1)=>{if(!s)return o=t,void(n=e);const a=t-o,l=e-n,h=Math.sqrt(a*a+l*l);if(r){i||(i=!0,this.cancelHold(),this.renderer.selectionStart=null,this.renderer.selectionEnd=null);const t=this.renderer.camera;this.renderer.setCameraPosition(new v(t.x-a/this.renderer.zoom,t.y-l/this.renderer.zoom))}else if(h>P){const t=this.hasOnlyHeroUnitsSelected();if(!(this.isSelecting||i||this.isDraggingHeroArrow||this.isDrawingPath))if(this.selectedBase&&this.selectedBase.isSelected)this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=this.selectedBase,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold();else if(this.selectedUnits.size>0&&this.selectionStartScreen){const e=this.renderer.screenToWorld(this.selectionStartScreen.x,this.selectionStartScreen.y);this.isDragStartNearSelectedUnits(e)?(this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold()):t?(this.isDraggingHeroArrow=!0,this.cancelHold()):(this.isSelecting=!0,this.cancelHold())}else t?(this.isDraggingHeroArrow=!0,this.cancelHold()):(this.isSelecting=!0,this.cancelHold())}if(this.isSelecting)this.renderer.selectionStart=this.selectionStartScreen,this.renderer.selectionEnd=new v(t,e);else if(this.isDraggingHeroArrow)this.renderer.abilityArrowStart=this.selectionStartScreen,this.renderer.abilityArrowEnd=new v(t,e);else if(this.isDrawingPath){const i=this.renderer.screenToWorld(t,e);(0===this.pathPoints.length||this.pathPoints[this.pathPoints.length-1].distanceTo(i)>50)&&this.pathPoints.push(new v(i.x,i.y)),this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=new v(i.x,i.y)}o=t,n=e},p=()=>{const t=this.selectionStartScreen&&Math.abs(o-this.selectionStartScreen.x)<P&&Math.abs(n-this.selectionStartScreen.y)<P;if(t&&this.game){const t=this.game.checkVictoryConditions();if(!t&&!this.game.isCountdownActive&&o<=70&&n<=70)return this.toggleInGameMenu(),i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(this.showInGameMenu&&!t){const t=this.renderer.getInGameMenuAction(o,n);if(t){switch(t.type){case"resume":this.toggleInGameMenu();break;case"toggleInfo":this.toggleInfo();break;case"surrender":this.surrender();break;case"tab":this.renderer.setInGameMenuTab(t.tab);break;case"graphicsVariant":this.renderer.setGraphicsVariant(t.key,t.variant);break;case"damageDisplayMode":this.renderer.damageDisplayMode=t.mode,this.game&&(this.game.damageDisplayMode=t.mode);break;case"healthDisplayMode":this.renderer.healthDisplayMode=t.mode}return i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t){const t=window.devicePixelRatio||1,e=this.renderer.canvas.width/t,r=(this.renderer.canvas.height,300),a=(e-r)/2,l=610;if(o>=a&&o<=a+r&&n>=l&&n<=l+60)return this.returnToMainMenu(),i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t&&this.selectionStartScreen&&this.renderer.createTapEffect(o,n),this.game&&t){const t=this.renderer.screenToWorld(o,n),e=this.game.players[0];if(e.stellarForge&&e.stellarForge.containsPoint(t)){if(e.stellarForge.isSelected)e.stellarForge.isSelected=!1,this.selectedBase=null,this.clearPathPreview(),console.log("Stellar Forge deselected");else{e.stellarForge.isSelected=!0,this.selectedBase=e.stellarForge,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t.isSelected=!1;this.clearPathPreview(),console.log("Stellar Forge selected")}return i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let r=null;for(const i of e.solarMirrors)if(i.containsPoint(t)){r=i;break}if(r){if(r.isSelected)r.isSelected=!1,this.selectedMirrors.delete(r),this.clearPathPreview(),console.log("Solar Mirror deselected");else{r.isSelected=!0,this.selectedMirrors.clear(),this.selectedMirrors.add(r),e.stellarForge&&(e.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t!==r&&(t.isSelected=!1);this.clearPathPreview(),console.log("Solar Mirror selected")}return i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}for(const t of this.game.warpGates){if(!t.isComplete)continue;if(t.owner!==e)continue;const r=this.renderer.worldToScreen(t.position),a=50*this.renderer.zoom,l=28*this.renderer.zoom,h=a+30*this.renderer.zoom,c=[0,Math.PI/2,Math.PI,3*Math.PI/2],d=["Minigun","Swirler","Sub Factory","Locked"];for(let a=0;a<4;a++){const g=c[a],u=r.x+Math.cos(g)*h,p=r.y+Math.sin(g)*h,m=o-u,S=n-p;if(Math.sqrt(m*m+S*S)<=l){const o=this.renderer.screenToWorld(u,p);if(this.renderer.createProductionButtonWave(o),console.log(`Warp gate button clicked: ${d[a]} (index ${a}) | energy=${e.energy.toFixed(1)}`),0===a)if(e.spendEnergy(x)){const i=new E(new v(t.position.x,t.position.y),e);e.buildings.push(i),console.log(`Minigun building queued at warp gate (${t.position.x.toFixed(0)}, ${t.position.y.toFixed(0)})`),this.scatterParticles(t.position);const s=this.game.warpGates.indexOf(t);s>-1&&this.game.warpGates.splice(s,1),this.implodeParticles(t.position)}else console.log("Not enough energy to build Minigun");else if(1===a)if(e.spendEnergy(y)){const i=new R(new v(t.position.x,t.position.y),e);e.buildings.push(i),console.log(`Space Dust Swirler building queued at warp gate (${t.position.x.toFixed(0)}, ${t.position.y.toFixed(0)})`),this.scatterParticles(t.position);const s=this.game.warpGates.indexOf(t);s>-1&&this.game.warpGates.splice(s,1),this.implodeParticles(t.position)}else console.log("Not enough energy to build Space Dust Swirler");else if(2===a)if(e.buildings.some(t=>t instanceof k))console.log("Only one Subsidiary Factory can exist at a time");else if(e.spendEnergy(f)){const i=new k(new v(t.position.x,t.position.y),e);e.buildings.push(i),console.log(`Subsidiary Factory building queued at warp gate (${t.position.x.toFixed(0)}, ${t.position.y.toFixed(0)})`),this.scatterParticles(t.position);const s=this.game.warpGates.indexOf(t);s>-1&&this.game.warpGates.splice(s,1),this.implodeParticles(t.position)}else console.log("Not enough energy to build Subsidiary Factory");return i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}}if(e.stellarForge&&e.stellarForge.isSelected&&this.renderer.selectedHeroNames.length>0){const t=this.getClickedHeroButton(o,n,e.stellarForge,this.renderer.selectedHeroNames);if(t){const o=t.heroName;this.renderer.createProductionButtonWave(t.buttonPos);const n=this.getHeroUnitType(o);let r=!1;if(n){const t=this.isHeroUnitAlive(e,n),i=this.isHeroUnitQueuedOrProducing(e.stellarForge,n);console.log(`Hero button clicked: ${o} | unitType=${n} | alive=${t} | producing=${i} | energy=${e.energy.toFixed(1)}`),t?console.log(`${o} is already active`):i?console.log(`${o} is already being produced`):e.spendEnergy(300)?(e.stellarForge.enqueueHeroUnit(n),e.stellarForge.startHeroProductionIfIdle(),console.log(`Queued hero ${o} for forging`),r=!0):console.log("Not enough energy to forge hero")}return r&&(e.stellarForge.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits,this.clearPathPreview()),i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(e.stellarForge&&e.stellarForge.isSelected)return e.stellarForge.setTarget(t),e.stellarForge.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits,console.log(`Stellar Forge moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();const a=e.solarMirrors.find(t=>t.isSelected);if(a)return a.setTarget(t),a.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits,console.log(`Solar Mirror moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),i=!1,s=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(this.isSelecting&&this.selectionStartScreen&&this.game){const t=new v(o,n);this.selectUnitsInRectangle(this.selectionStartScreen,t)}else if(this.isDrawingPath&&this.pathPoints.length>0&&this.game){if(this.selectedBase&&this.selectedBase.isSelected)this.selectedBase.setMinionPath(this.pathPoints),console.log(`Base path set with ${this.pathPoints.length} waypoints`);else if(this.selectedUnits.size>0){console.log(`Unit movement path set with ${this.pathPoints.length} waypoints for ${this.selectedUnits.size} unit(s)`),this.moveOrderCounter++;for(const t of this.selectedUnits){if(t instanceof Y)t.setPath(this.pathPoints);else{const e=this.pathPoints[this.pathPoints.length-1];t.rallyPoint=new v(e.x,e.y)}t.moveOrder=this.moveOrderCounter}this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits}this.clearPathPreview()}else if(!this.isSelecting&&(this.selectedUnits.size>0||this.selectedMirrors.size>0||this.selectedBase)&&this.selectionStartScreen&&this.game){const t=new v(o,n),e=this.selectionStartScreen.distanceTo(t),i=Math.max(P,10),s=this.hasOnlyHeroUnitsSelected();if(this.selectedUnits.size>0&&(!s&&e>=P||s&&this.isDraggingHeroArrow&&e>=i)){s||this.renderer.createSwipeEffect(this.selectionStartScreen.x,this.selectionStartScreen.y,t.x,t.y);const e=t.x-this.selectionStartScreen.x,i=t.y-this.selectionStartScreen.y,o=Math.sqrt(e*e+i*i),n=new v(e/o,i/o);let r=!1;for(const t of this.selectedUnits)t.useAbility(n)&&(r=!0);r&&console.log(`Ability activated in direction (${n.x.toFixed(2)}, ${n.y.toFixed(2)})`),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits}else{const t=this.renderer.screenToWorld(o,n);this.moveOrderCounter++;for(const e of this.selectedUnits){const i=new v(t.x,t.y);e instanceof Y?e.setManualRallyPoint(i):e.rallyPoint=i,e.moveOrder=this.moveOrderCounter}for(const e of this.selectedMirrors)e.setTarget(new v(t.x,t.y)),e.moveOrder=this.moveOrderCounter,e.isSelected=!1;this.selectedBase&&(this.selectedBase.setTarget(new v(t.x,t.y)),this.selectedBase.moveOrder=this.moveOrderCounter,this.selectedBase.isSelected=!1),this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,console.log(`Movement target set at (${t.x.toFixed(0)}, ${t.y.toFixed(0)}) - Move order #${this.moveOrderCounter}`)}}i=!1,s=!1,this.isSelecting=!1,this.isDraggingHeroArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,this.renderer.abilityArrowStart=null,this.renderer.abilityArrowEnd=null,this.endHold()};t.addEventListener("mousedown",t=>{s=!0;const i=e(t.clientX,t.clientY);g(i.x,i.y)}),t.addEventListener("mousemove",t=>{const i=e(t.clientX,t.clientY);r=i.x,a=i.y,u(i.x,i.y,!1)}),t.addEventListener("mouseup",()=>{p()}),t.addEventListener("mouseleave",()=>{p()}),t.addEventListener("touchstart",t=>{if(1===t.touches.length){t.preventDefault(),s=!0;const i=e(t.touches[0].clientX,t.touches[0].clientY);g(i.x,i.y)}else if(2===t.touches.length){t.preventDefault(),s=!0,i=!1;const r=e(t.touches[0].clientX,t.touches[0].clientY),a=e(t.touches[1].clientX,t.touches[1].clientY);o=(r.x+a.x)/2,n=(r.y+a.y)/2;const h=a.x-r.x,c=a.y-r.y;l=Math.sqrt(h*h+c*c),this.cancelHold()}},{passive:!1}),t.addEventListener("touchmove",t=>{if(1===t.touches.length&&s){t.preventDefault();const i=e(t.touches[0].clientX,t.touches[0].clientY);u(i.x,i.y,!1)}else if(2===t.touches.length){t.preventDefault();const i=e(t.touches[0].clientX,t.touches[0].clientY),s=e(t.touches[1].clientX,t.touches[1].clientY),o=(i.x+s.x)/2,n=(i.y+s.y)/2,r=s.x-i.x,a=s.y-i.y,h=Math.sqrt(r*r+a*a);if(Math.abs(h-l)>1){const t=this.renderer.screenToWorld(o,n),e=h/l,i=this.renderer.zoom;this.renderer.setZoom(i*e);const s=this.renderer.screenToWorld(o,n),r=this.renderer.camera;this.renderer.setCameraPositionWithoutParallax(new v(r.x+(t.x-s.x),r.y+(t.y-s.y))),l=h}u(o,n,!0)}},{passive:!1}),t.addEventListener("touchend",t=>{if(1===t.touches.length){const i=e(t.touches[0].clientX,t.touches[0].clientY);o=i.x,n=i.y,r=i.x,a=i.y}else if(t.changedTouches.length>0){const i=e(t.changedTouches[0].clientX,t.changedTouches[0].clientY);o=i.x,n=i.y,r=i.x,a=i.y}0===t.touches.length?(p(),l=0):1===t.touches.length&&(i=!1,l=0)}),t.addEventListener("touchcancel",()=>{p(),l=0}),window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();if("escape"===e&&this.game&&!this.game.isCountdownActive&&!this.game.checkVictoryConditions())return t.preventDefault(),void this.toggleInGameMenu();["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(e)&&(t.preventDefault(),d.add(e))}),window.addEventListener("keyup",t=>{const e=t.key.toLowerCase();d.delete(e)});const m=()=>{if(!this.game)return void requestAnimationFrame(m);const e=d.size>0,o=window.devicePixelRatio||1,n=t.width/o,l=t.height/o,g=!c&&!s&&!i&&(r<h||r>n-h||a<h||a>l-h);if(e||g){const t=this.renderer.camera;let e=0,i=0;(d.has("w")||d.has("arrowup"))&&(i-=10),(d.has("s")||d.has("arrowdown"))&&(i+=10),(d.has("a")||d.has("arrowleft"))&&(e-=10),(d.has("d")||d.has("arrowright"))&&(e+=10),g&&(r<h&&(e-=5),r>n-h&&(e+=5),a<h&&(i-=5),a>l-h&&(i+=5)),0===e&&0===i||this.renderer.setCameraPosition(new v(t.x+e/this.renderer.zoom,t.y+i/this.renderer.zoom))}requestAnimationFrame(m)};m()}startHold(e){if(!this.game)return;const i=this.game.players[0];if(i.stellarForge)if(this.selectedMirrors.size>0){let t=!1;for(const i of this.selectedMirrors){if(!i.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const s=new b(i.position,new v(e.x-i.position.x,e.y-i.position.y).normalize(),1);let o=!0;for(const t of this.game.asteroids)if(s.intersectsPolygon(t.getWorldVertices())){o=!1;break}if(o){t=!0;break}}t&&(this.holdStartTime=Date.now(),this.holdPosition=e,this.isUsingMirrorsForWarpGate=!0,console.log("Starting mirror-based warp gate at",e))}else e.distanceTo(i.stellarForge.position)<t&&(this.holdStartTime=Date.now(),this.holdPosition=e,this.isUsingMirrorsForWarpGate=!1)}selectUnitsInRectangle(t,e){if(!this.game)return;const i=this.renderer.screenToWorld(t.x,t.y),s=this.renderer.screenToWorld(e.x,e.y),o=Math.min(i.x,s.x),n=Math.max(i.x,s.x),r=Math.min(i.y,s.y),a=Math.max(i.y,s.y);this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null;const l=this.game.players[0];if(l&&!l.isDefeated()){for(const t of l.units)t.position.x>=o&&t.position.x<=n&&t.position.y>=r&&t.position.y<=a&&this.selectedUnits.add(t);for(const t of l.solarMirrors)t.position.x>=o&&t.position.x<=n&&t.position.y>=r&&t.position.y<=a?(this.selectedMirrors.add(t),t.isSelected=!0):t.isSelected=!1;l.stellarForge&&l.stellarForge.position.x>=o&&l.stellarForge.position.x<=n&&l.stellarForge.position.y>=r&&l.stellarForge.position.y<=a&&0===this.selectedUnits.size?(this.selectedBase=l.stellarForge,l.stellarForge.isSelected=!0):l.stellarForge&&(l.stellarForge.isSelected=!1),this.renderer.selectedUnits=this.selectedUnits,console.log(`Selected ${this.selectedUnits.size} units, ${this.selectedMirrors.size} mirrors, ${this.selectedBase?"1 base":"0 bases"}`)}}cancelHold(){if(this.game){if(this.currentWarpGate){this.currentWarpGate.cancel(),this.implodeParticles(this.currentWarpGate.position);const t=this.game.warpGates.indexOf(this.currentWarpGate);t>-1&&this.game.warpGates.splice(t,1)}this.holdStartTime=null,this.holdPosition=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1}}endHold(){this.holdStartTime=null,this.holdPosition=null,this.isUsingMirrorsForWarpGate=!1}applyRadialForceToParticles(t,e){if(this.game)for(const i of this.game.spaceDust)if(i.position.distanceTo(t)<150){const s=new v(e?i.position.x-t.x:t.x-i.position.x,e?i.position.y-t.y:t.y-i.position.y).normalize();i.applyForce(new v(200*s.x,200*s.y))}}scatterParticles(t){this.applyRadialForceToParticles(t,!0)}implodeParticles(t){this.applyRadialForceToParticles(t,!1)}update(t){if(this.game&&!this.isPaused){if(this.game.isRunning&&this.game.update(t),this.holdStartTime&&this.holdPosition&&(Date.now()-this.holdStartTime)/1e3>=1&&!this.currentWarpGate){const t=this.game.players[0];this.currentWarpGate=new j(this.holdPosition,t),this.currentWarpGate.startCharging(),this.game.warpGates.push(this.currentWarpGate)}if(this.currentWarpGate){const e=null!==this.holdStartTime&&null!==this.holdPosition;let i=1;if(this.isUsingMirrorsForWarpGate&&e){this.game.players[0];let t=0;for(const e of this.selectedMirrors){if(!e.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const i=new b(e.position,new v(this.currentWarpGate.position.x-e.position.x,this.currentWarpGate.position.y-e.position.y).normalize(),1);let s=!0;for(const t of this.game.asteroids)if(i.intersectsPolygon(t.getWorldVertices())){s=!1;break}if(s){const i=this.game.suns.reduce((t,i)=>e.position.distanceTo(i.position)<(t?e.position.distanceTo(t.position):1/0)?i:t,null);if(i){const s=e.position.distanceTo(i.position);t+=Math.max(1,2*(1-Math.min(1,s/w)))}}}i=.5+.5*t}this.currentWarpGate.update(t,e,i),this.currentWarpGate.shouldEmitShockwave()&&(this.scatterParticles(this.currentWarpGate.position),this.renderer.createWarpGateShockwave(this.currentWarpGate.position))}}}render(){this.game&&this.renderer.render(this.game)}gameLoop(t){if(!this.isRunning)return;const e=0===this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,this.update(Math.min(e,.1)),this.render(),requestAnimationFrame(t=>this.gameLoop(t))}start(){this.game&&(this.isRunning=!0,this.lastTime=0,requestAnimationFrame(t=>this.gameLoop(t)))}stop(){this.isRunning=!1}}document.addEventListener("DOMContentLoaded",()=>{const t=new yt;window.gameController=t})})();