(()=>{"use strict";const t=300,e="#0066FF",i="#FF0000",s=1500,n=.3,o=250,a=150,r=1e3,l=10*Math.PI/180;var c;!function(t){t.RADIANT="Radiant",t.AURUM="Aurum",t.SOLARI="Solari"}(c||(c={}));class h{constructor(t,e){this.x=t,this.y=e}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}normalize(){const t=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return 0===t?new h(0,0):new h(this.x/t,this.y/t)}}class d{constructor(t,e,i=1){this.origin=t,this.direction=e,this.intensity=i}intersects(t,e){const i=new h(this.origin.x-t.x,this.origin.y-t.y),s=this.direction.x*this.direction.x+this.direction.y*this.direction.y,n=2*(i.x*this.direction.x+i.y*this.direction.y);return n*n-4*s*(i.x*i.x+i.y*i.y-e*e)>=0}intersectsPolygon(t){for(let e=0;e<t.length;e++){const i=t[e],s=t[(e+1)%t.length];if(null!==this.intersectsLineSegment(i,s))return!0}return!1}getIntersectionDistance(t){let e=null;for(let i=0;i<t.length;i++){const s=t[i],n=t[(i+1)%t.length],o=this.intersectsLineSegment(s,n);null!==o&&(null===e||o<e)&&(e=o)}return e}intersectsLineSegment(t,e){const i=new h(e.x-t.x,e.y-t.y),s=new h(t.x-this.origin.x,t.y-this.origin.y),n=this.direction.x*i.y-this.direction.y*i.x;if(Math.abs(n)<1e-4)return null;const o=(s.x*i.y-s.y*i.x)/n,a=(s.x*this.direction.y-s.y*this.direction.x)/n;return o>=0&&a>=0&&a<=1?o:null}}class p{constructor(t,e,i){this.position=t,this.sides=e,this.size=i,this.vertices=[],this.rotation=0,this.generateVertices(),this.rotationSpeed=.5*(Math.random()-.5)}generateVertices(){this.vertices=[];for(let t=0;t<this.sides;t++){const e=2*Math.PI*t/this.sides,i=.8+.4*Math.random(),s=this.size*i;this.vertices.push(new h(Math.cos(e)*s,Math.sin(e)*s))}}getWorldVertices(){return this.vertices.map(t=>{const e=Math.cos(this.rotation),i=Math.sin(this.rotation);return new h(this.position.x+t.x*e-t.y*i,this.position.y+t.x*i+t.y*e)})}update(t){this.rotation+=this.rotationSpeed*t}containsPoint(t){const e=this.getWorldVertices();let i=!1;for(let s=0,n=e.length-1;s<e.length;n=s++){const o=e[s].x,a=e[s].y,r=e[n].x,l=e[n].y;a>t.y!=l>t.y&&t.x<(r-o)*(t.y-a)/(l-a)+o&&(i=!i)}return i}}class g{constructor(t,e){this.position=t,this.owner=e,this.health=100,this.efficiency=1,this.isSelected=!1,this.targetPosition=null,this.velocity=new h(0,0),this.reflectionAngle=0,this.closestSunDistance=1/0,this.MAX_SPEED=50,this.ACCELERATION=25,this.DECELERATION=50}isPathClear(t,e=[]){const i=new h(t.x-this.position.x,t.y-this.position.y).normalize(),s=new d(this.position,i),n=this.position.distanceTo(t);for(const t of e){const e=s.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<n)return!1}return!0}hasLineOfSightToLight(t,e=[]){for(const i of t)if(this.isPathClear(i.position,e))return!0;return!1}hasLineOfSightToForge(t,e=[]){return this.isPathClear(t.position,e)}getClosestVisibleSun(t,e=[]){let i=null,s=1/0;for(const n of t)if(this.isPathClear(n.position,e)){const t=this.position.distanceTo(n.position);t<s&&(i=n,s=t)}return i}generateSolarium(t){const e=Math.max(1,2-this.closestSunDistance/r);return 10*this.efficiency*e*t}setTarget(t){this.targetPosition=t}updateReflectionAngle(t,e,i=[]){if(!t)return;const s=this.getClosestVisibleSun(e,i);if(!s)return void(this.closestSunDistance=1/0);this.closestSunDistance=this.position.distanceTo(s.position);const n=new h(s.position.x-this.position.x,s.position.y-this.position.y).normalize(),o=new h(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),a=n.x+o.x,r=n.y+o.y;this.reflectionAngle=Math.atan2(r,a)}update(t){if(!this.targetPosition)return;const e=this.targetPosition.x-this.position.x,i=this.targetPosition.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s<5)return this.position=this.targetPosition,this.targetPosition=null,void(this.velocity=new h(0,0));const n=e/s,o=i/s,a=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(s>a*a/(2*this.DECELERATION)&&a<this.MAX_SPEED)this.velocity.x+=n*this.ACCELERATION*t,this.velocity.y+=o*this.ACCELERATION*t;else{const e=Math.max(0,1-this.DECELERATION*t/a);this.velocity.x*=e,this.velocity.y*=e}const r=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));r>this.MAX_SPEED&&(this.velocity.x=this.velocity.x/r*this.MAX_SPEED,this.velocity.y=this.velocity.y/r*this.MAX_SPEED),this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}containsPoint(t){return this.position.distanceTo(t)<20}}class x{constructor(t,e){this.position=t,this.owner=e,this.health=1e3,this.isReceivingLight=!1,this.unitQueue=[],this.isSelected=!1,this.targetPosition=null,this.velocity=new h(0,0),this.maxSpeed=50,this.acceleration=30,this.deceleration=50,this.radius=40,this.starlingSpawnTimer=0,this.starlingSpawnTimer=10*Math.random()}canProduceUnits(){return this.isReceivingLight&&this.health>0}produceUnit(t,e,i){return!(!this.canProduceUnits()||i<e||(this.unitQueue.push(t),0))}updateLightStatus(t,e,i=[]){this.isReceivingLight=!1;for(const s of t)if(s.hasLineOfSightToLight(e,i)&&s.hasLineOfSightToForge(this,i)){this.isReceivingLight=!0;break}}update(t){if(this.health>0&&this.isReceivingLight&&(this.starlingSpawnTimer-=t),this.targetPosition){const e=this.targetPosition.x-this.position.x,i=this.targetPosition.y-this.position.y,s=Math.sqrt(Math.pow(e,2)+Math.pow(i,2));if(s<5)this.position.x=this.targetPosition.x,this.position.y=this.targetPosition.y,this.velocity.x=0,this.velocity.y=0,this.targetPosition=null;else{const n=e/s,o=i/s;this.velocity.x+=n*this.acceleration*t,this.velocity.y+=o*this.acceleration*t;const a=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));a>this.maxSpeed&&(this.velocity.x=this.velocity.x/a*this.maxSpeed,this.velocity.y=this.velocity.y/a*this.maxSpeed)}}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>.1){const i=this.deceleration*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}shouldSpawnStarling(){return!!(this.starlingSpawnTimer<=0&&this.health>0&&this.isReceivingLight)&&(this.starlingSpawnTimer=10,!0)}setTarget(t){this.targetPosition=new h(t.x,t.y)}toggleSelection(){this.isSelected=!this.isSelected}containsPoint(t){return this.position.distanceTo(t)<=this.radius}}class u{constructor(t,e,i,s,n,o,a){this.position=t,this.owner=e,this.radius=s,this.attackRange=n,this.attackDamage=o,this.attackSpeed=a,this.attackCooldown=0,this.target=null,this.buildProgress=0,this.isComplete=!1,this.health=i,this.maxHealth=i}update(t,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.isComplete&&(this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0)&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=this.attackDamage)}takeDamage(t){this.health-=t}isDestroyed(){return this.health<=0}addBuildProgress(t){this.isComplete||(this.buildProgress+=t,this.buildProgress>=1&&(this.buildProgress=1,this.isComplete=!0))}}class f extends u{constructor(t,e){super(t,e,200,30,350,12,6),this.lastShotEffects={}}attack(t){super.attack(t);const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.atan2(i,e);this.lastShotEffects.muzzleFlash=new F(new h(this.position.x,this.position.y),s);const n=s+Math.PI/2+.5*(Math.random()-.5),o=100+50*Math.random();this.lastShotEffects.casing=new w(new h(this.position.x,this.position.y),new h(Math.cos(n)*o,Math.sin(n)*o));const a=s+Math.PI+1*(Math.random()-.5),r=150+100*Math.random();this.lastShotEffects.bouncingBullet=new b(new h(t.position.x,t.position.y),new h(Math.cos(a)*r,Math.sin(a)*r))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}}class y{constructor(t,e=1,i=100){this.position=t,this.intensity=e,this.radius=i}emitLight(t){return new d(this.position,t,this.intensity)}}class m{constructor(t,e){this.name=t,this.faction=e,this.solarium=100,this.stellarForge=null,this.solarMirrors=[],this.units=[],this.buildings=[]}isDefeated(){return null===this.stellarForge||this.stellarForge.health<=0}addSolarium(t){this.solarium+=t}spendSolarium(t){return this.solarium>=t&&(this.solarium-=t,!0)}}class S{constructor(t,e){this.position=t,this.baseColor="#888888",this.currentColor="#888888",this.velocity=e||new h(2*(Math.random()-.5),2*(Math.random()-.5))}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.x*=.98,this.velocity.y*=.98}applyForce(t){this.velocity.x+=t.x,this.velocity.y+=t.y}updateColor(t,e){this.currentColor=t&&e>0?this.blendColors(this.baseColor,t,e):this.baseColor}blendColors(t,e,i){if(!(t&&e&&t.startsWith("#")&&e.startsWith("#")))return this.baseColor;const s=parseInt(t.slice(1),16),n=parseInt(e.slice(1),16);if(isNaN(s)||isNaN(n))return this.baseColor;const o=s>>16&255,a=s>>8&255,r=255&s,l=n>>16&255,c=n>>8&255,h=255&n;return`#${(Math.round(o+(l-o)*i)<<16|Math.round(a+(c-a)*i)<<8|Math.round(r+(h-r)*i)).toString(16).padStart(6,"0")}`}}class w{constructor(t,e){this.position=t,this.rotation=0,this.lifetime=0,this.maxLifetime=2,this.velocity=e,this.rotationSpeed=10*(Math.random()-.5)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=.95,this.velocity.y*=.95,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}applyCollision(t){this.velocity.x+=.3*t.x,this.velocity.y+=.3*t.y}}class F{constructor(t,e){this.position=t,this.angle=e,this.lifetime=0,this.maxLifetime=.05}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class b{constructor(t,e){this.position=t,this.lifetime=0,this.maxLifetime=.5,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.y+=100*t,this.velocity.x*=.98,this.velocity.y*=.98,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class M{constructor(t,e,i,s=5){this.position=t,this.owner=i,this.damage=s,this.lifetime=0,this.maxLifetime=1,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}checkHit(t){return this.position.distanceTo(t.position)<10}}class v{constructor(t,e,i,s,n,o,a=5){this.position=t,this.owner=e,this.attackRange=s,this.attackDamage=n,this.attackSpeed=o,this.abilityCooldownTime=a,this.attackCooldown=0,this.abilityCooldown=0,this.target=null,this.rallyPoint=null,this.lastAbilityEffects=[],this.isHero=!1,this.health=i,this.maxHealth=i}update(t,e){if(this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.rallyPoint){const e=this.position.distanceTo(this.rallyPoint);if(e>5){const i=this.rallyPoint.x-this.position.x,s=this.rallyPoint.y-this.position.y,n=100*t;this.position.x+=i/e*n,this.position.y+=s/e*n}else this.rallyPoint=null}this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=this.attackDamage)}useAbility(t){return!(this.abilityCooldown>0||(this.abilityCooldown=this.abilityCooldownTime,0))}getAndClearLastAbilityEffects(){const t=this.lastAbilityEffects;return this.lastAbilityEffects=[],t}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class C extends v{constructor(t,e){super(t,e,100,300,10,5,5),this.lastShotEffects={},this.isHero=!0}attack(t){super.attack(t);const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.atan2(i,e);this.lastShotEffects.muzzleFlash=new F(new h(this.position.x,this.position.y),s);const n=s+Math.PI/2+.5*(Math.random()-.5),o=100+50*Math.random();this.lastShotEffects.casing=new w(new h(this.position.x,this.position.y),new h(Math.cos(n)*o,Math.sin(n)*o));const a=s+Math.PI+1*(Math.random()-.5),r=150+100*Math.random();this.lastShotEffects.bouncingBullet=new b(new h(t.position.x,t.position.y),new h(Math.cos(a)*r,Math.sin(a)*r))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}useAbility(t){if(!super.useAbility(t))return!1;const e=Math.atan2(t.y,t.x),i=l;for(let t=0;t<15;t++){const s=e+(t/Math.max(14,1)-.5)*i*2,n=500,o=new h(Math.cos(s)*n,Math.sin(s)*n),a=new M(new h(this.position.x,this.position.y),o,this.owner);this.lastAbilityEffects.push(a)}return!0}}class k{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.velocity=e}update(t,e){if(!this.isAttacking){const i=e.x-this.position.x,s=e.y-this.position.y,n=Math.sqrt(i*i+s*s);if(n>0){const e=i/n,o=s/n,a=300;this.velocity.x+=e*a*t,this.velocity.y+=o*a*t;const r=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(r<80){const t=80/r;this.velocity.x*=t,this.velocity.y*=t}}}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.isAttacking&&(this.trail.push(new h(this.position.x,this.position.y)),this.trail.length>15&&this.trail.shift(),this.lifetime+=t),this.isAttacking&&this.targetEnemy&&this.position.distanceTo(this.targetEnemy.position)<10&&("health"in this.targetEnemy&&(this.targetEnemy.health-=15),this.isAttacking=!1,this.trail=[],this.targetEnemy=null)}launchAtTarget(t){this.isAttacking=!0,this.targetEnemy=t,this.trail=[],this.lifetime=0;const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s>0){const t=e/s,n=i/s;this.velocity.x=400*t,this.velocity.y=400*n}}returnToOrbit(){this.isAttacking=!1,this.trail=[],this.targetEnemy=null}}class T extends v{constructor(t,e){super(t,e,150,100,15,2,5),this.projectiles=[],this.projectileLaunchCooldown=0,this.isHero=!0;for(let i=0;i<5;i++){const s=i/5*Math.PI*2,n=50*Math.cos(s),o=50*Math.sin(s),a=80*-Math.sin(s),r=80*Math.cos(s);this.projectiles.push(new k(new h(t.x+n,t.y+o),new h(a,r),e))}}update(t,e){super.update(t,e),this.projectileLaunchCooldown>0&&(this.projectileLaunchCooldown-=t);for(const e of this.projectiles)e.update(t,this.position);if(this.target&&this.projectileLaunchCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange){const t=this.projectiles.find(t=>!t.isAttacking);t&&(t.launchAtTarget(this.target),this.projectileLaunchCooldown=1/this.attackSpeed)}}attack(t){}getProjectiles(){return this.projectiles}}class D extends v{constructor(t,e){super(t,e,50,150,5,2,0),this.explorationTarget=null,this.explorationTimer=0}updateAI(t,e){let i=null;for(const s of e)if(s instanceof x&&s.owner!==this.owner&&t.isObjectVisibleToPlayer(s.position,this.owner)){i=s.position;break}if(!i)for(const e of t.players)if(e!==this.owner){for(const s of e.solarMirrors)if(t.isObjectVisibleToPlayer(s.position,this.owner)){i=s.position;break}if(i)break}if(!i){if(this.explorationTimer<=0||!this.explorationTarget||this.position.distanceTo(this.explorationTarget)<5){const t=Math.random()*Math.PI*2,e=300+500*Math.random();this.explorationTarget=new h(this.position.x+Math.cos(t)*e,this.position.y+Math.sin(t)*e),this.explorationTimer=5}i=this.explorationTarget}i&&(this.rallyPoint=i)}update(t,e){if(this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.explorationTimer-=t,this.rallyPoint){const e=this.position.distanceTo(this.rallyPoint);if(e>5){const i=this.rallyPoint.x-this.position.x,s=this.rallyPoint.y-this.position.y,n=120*t;this.position.x+=i/e*n,this.position.y+=s/e*n}else this.rallyPoint=null}this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}}class A{constructor(t,e){this.position=t,this.owner=e,this.chargeTime=0,this.isCharging=!1,this.isComplete=!1,this.health=100,this.hasEmittedShockwave=!1}update(t,e,i=1){this.isCharging&&!this.isComplete&&(e?(this.chargeTime+=t*i,this.chargeTime>=6&&(this.isComplete=!0,this.isCharging=!1)):this.cancel())}startCharging(){this.isCharging=!0,this.chargeTime=0}takeDamage(t){return this.health-=t,this.health<=0&&(this.cancel(),!0)}cancel(){this.isCharging=!1,this.isComplete=!1}shouldEmitShockwave(){return!this.hasEmittedShockwave&&this.chargeTime>=1&&(this.hasEmittedShockwave=!0,!0)}}class E{constructor(){this.players=[],this.suns=[],this.spaceDust=[],this.warpGates=[],this.asteroids=[],this.muzzleFlashes=[],this.bulletCasings=[],this.bouncingBullets=[],this.abilityBullets=[],this.gameTime=0,this.isRunning=!1,this.countdownTime=3,this.isCountdownActive=!0,this.mirrorsMovedToSun=!1}update(e){this.gameTime+=e,this.isCountdownActive&&(this.countdownTime-=e,this.mirrorsMovedToSun||(this.initializeMirrorMovement(),this.mirrorsMovedToSun=!0),this.countdownTime<=0&&(this.isCountdownActive=!1,this.countdownTime=0));for(const t of this.asteroids)t.update(e);for(const t of this.players)if(!t.isDefeated()){if(t.stellarForge){const i=new h(t.stellarForge.position.x,t.stellarForge.position.y);if(t.stellarForge.updateLightStatus(t.solarMirrors,this.suns,this.asteroids),this.isCountdownActive||(t.stellarForge.update(e),this.checkCollision(t.stellarForge.position,t.stellarForge.radius)&&(t.stellarForge.position=i,t.stellarForge.targetPosition=null,t.stellarForge.velocity=new h(0,0))),!this.isCountdownActive&&t.stellarForge.shouldSpawnStarling()){const e=60,i=Math.random()*Math.PI*2,s=new h(t.stellarForge.position.x+Math.cos(i)*e,t.stellarForge.position.y+Math.sin(i)*e),n=new D(s,t);t.units.push(n),console.log(`${t.name} spawned a Starling at (${s.x.toFixed(0)}, ${s.y.toFixed(0)})`)}}for(const i of t.solarMirrors){const s=new h(i.position.x,i.position.y);if(i.update(e),this.checkCollision(i.position,20)&&(i.position=s,i.targetPosition=null,i.velocity=new h(0,0)),i.updateReflectionAngle(t.stellarForge,this.suns,this.asteroids),i.hasLineOfSightToLight(this.suns,this.asteroids)&&t.stellarForge&&i.hasLineOfSightToForge(t.stellarForge,this.asteroids)){const s=i.generateSolarium(e);t.addSolarium(s)}}}this.updateSpaceDust(e);const i=[],s=[];for(const t of this.players)t.isDefeated()||(i.push(...t.units),t.stellarForge&&s.push(t.stellarForge));for(const i of this.players){if(i.isDefeated())continue;const s=[];for(const t of this.players)t===i||t.isDefeated()||(s.push(...t.units),s.push(...t.buildings),t.stellarForge&&s.push(t.stellarForge));if(!this.isCountdownActive)for(const t of i.units){if(t instanceof D&&t.updateAI(this,s),t.update(e,s),t instanceof C){const e=t.getAndClearLastShotEffects();e.muzzleFlash&&this.muzzleFlashes.push(e.muzzleFlash),e.casing&&this.bulletCasings.push(e.casing),e.bouncingBullet&&this.bouncingBullets.push(e.bouncingBullet)}const i=t.getAndClearLastAbilityEffects();this.abilityBullets.push(...i)}if(!this.isCountdownActive)for(const t of i.units){const e=new h(t.position.x,t.position.y);if(this.checkCollision(t.position)){let i=!1;const s=15,n=8;for(let o=0;o<n;o++){const a=o/n*Math.PI*2,r=e.x+Math.cos(a)*s,l=e.y+Math.sin(a)*s,c=new h(r,l);if(!this.checkCollision(c)){t.position=c,i=!0;break}}i||(t.rallyPoint=null)}}if(i.units=i.units.filter(t=>!t.isDead()),!this.isCountdownActive)for(const t of i.buildings)if(t.update(e,s),t instanceof f){const e=t.getAndClearLastShotEffects();e.muzzleFlash&&this.muzzleFlashes.push(e.muzzleFlash),e.casing&&this.bulletCasings.push(e.casing),e.bouncingBullet&&this.bouncingBullets.push(e.bouncingBullet)}if(!this.isCountdownActive)for(const s of i.buildings)if(!s.isComplete)if(i.stellarForge&&s.position.distanceTo(i.stellarForge.position)<=t&&i.stellarForge){const t=.2*e;s.addBuildProgress(t)}else{let t=0;for(const e of i.solarMirrors){if(!e.hasLineOfSightToLight(this.suns,this.asteroids))continue;const i=new d(e.position,new h(s.position.x-e.position.x,s.position.y-e.position.y).normalize(),1);let n=!0;for(const t of this.asteroids)if(i.intersectsPolygon(t.getWorldVertices())){n=!1;break}if(n){const i=this.suns.reduce((t,i)=>e.position.distanceTo(i.position)<(t?e.position.distanceTo(t.position):1/0)?i:t,null);if(i){const s=e.position.distanceTo(i.position);t+=Math.max(1,2*(1-Math.min(1,s/r)))}}}if(t>0){const i=t/10*.2*e;s.addBuildProgress(i)}}i.buildings=i.buildings.filter(t=>!t.isDestroyed())}for(const t of this.muzzleFlashes)t.update(e);this.muzzleFlashes=this.muzzleFlashes.filter(t=>!t.shouldDespawn());for(const t of this.bulletCasings){t.update(e);for(const e of this.spaceDust)if(t.position.distanceTo(e.position)<5){const i=new h(e.position.x-t.position.x,e.position.y-t.position.y).normalize();e.applyForce(new h(50*i.x,50*i.y)),t.applyCollision(new h(50*-i.x,50*-i.y))}}this.bulletCasings=this.bulletCasings.filter(t=>!t.shouldDespawn());for(const t of this.bouncingBullets)t.update(e);this.bouncingBullets=this.bouncingBullets.filter(t=>!t.shouldDespawn());for(const t of this.abilityBullets){t.update(e);for(const e of this.players)if(e!==t.owner){for(const i of e.units)if(t.checkHit(i)){i.takeDamage(t.damage),t.lifetime=t.maxLifetime;break}e.stellarForge&&t.checkHit(e.stellarForge)&&(e.stellarForge.health-=t.damage,t.lifetime=t.maxLifetime)}}this.abilityBullets=this.abilityBullets.filter(t=>!t.shouldDespawn())}updateSpaceDust(s){for(const n of this.spaceDust){n.update(s);let o=null;for(let s=0;s<this.players.length;s++){const a=this.players[s];if(a.stellarForge&&!a.isDefeated()){const r=n.position.distanceTo(a.stellarForge.position);if(r<t){const t=0===s?e:i;(!o||r<o.distance)&&(o={color:t,distance:r})}}}if(o){const e=1-o.distance/t;n.updateColor(o.color,e)}else n.updateColor(null,0)}for(const t of this.warpGates)if(t.isCharging&&t.chargeTime>=1)for(const e of this.spaceDust){const i=e.position.distanceTo(t.position);if(i<200&&i>5){const n=new h(t.position.x-e.position.x,t.position.y-e.position.y).normalize(),o=new h(-n.y,n.x),a=new h(50*n.x+20*o.x,50*n.y+20*o.y);e.applyForce(new h(a.x*s/i,a.y*s/i))}}}initializeMirrorMovement(){if(0===this.suns.length)return;const t=this.suns[0];for(const e of this.players){if(!e.stellarForge||e.solarMirrors.length<2)continue;const i=e.stellarForge.position,s=i.x-t.position.x,n=i.y-t.position.y,o=Math.atan2(n,s),r=o+Math.PI/2,l=o-Math.PI/2;if(e.solarMirrors.length>=1){const t=new h(i.x+Math.cos(r)*a,i.y+Math.sin(r)*a);e.solarMirrors[0].setTarget(t)}if(e.solarMirrors.length>=2){const t=new h(i.x+Math.cos(l)*a,i.y+Math.sin(l)*a);e.solarMirrors[1].setTarget(t)}}}isPointInShadow(t){if(0===this.suns.length)return!0;for(const e of this.suns){const i=new h(e.position.x-t.x,e.position.y-t.y).normalize(),s=new d(t,i),n=t.distanceTo(e.position);let o=!0;for(const t of this.asteroids){const e=s.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<n){o=!1;break}}if(o)return!1}return!0}isObjectVisibleToPlayer(e,i){if(!this.isPointInShadow(e))return!0;for(const t of i.units)if(t.position.distanceTo(e)<=150)return!0;return!!(i.stellarForge&&i.stellarForge.position.distanceTo(e)<=t)}checkCollision(t,e=8){for(const i of this.suns)if(t.distanceTo(i.position)<i.radius+e)return!0;for(const e of this.asteroids)if(e.containsPoint(t))return!0;for(const i of this.players){if(i.stellarForge&&t.distanceTo(i.stellarForge.position)<i.stellarForge.radius+e)return!0;for(const s of i.solarMirrors)if(t.distanceTo(s.position)<20+e)return!0;for(const s of i.buildings)if(t.distanceTo(s.position)<s.radius+e)return!0}return!1}initializeSpaceDust(t,e,i){this.spaceDust=[];for(let s=0;s<t;s++){const t=(Math.random()-.5)*e,s=(Math.random()-.5)*i;this.spaceDust.push(new S(new h(t,s)))}}initializeAsteroids(t,e,i){this.asteroids=[];for(let s=0;s<t;s++){let t=!1,s=0,n=0,o=0,a=0;for(;!t&&s<50;){const r=Math.random()*Math.PI*2,l=200+Math.random()*(Math.min(e,i)/2-300);n=Math.cos(r)*l,o=Math.sin(r)*l,a=30+50*Math.random(),t=!0;for(const e of this.asteroids){const i=n-e.position.x,s=o-e.position.y;if(Math.sqrt(i*i+s*s)<100+a+e.size){t=!1;break}}s++}if(t){const t=3+Math.floor(7*Math.random());this.asteroids.push(new p(new h(n,o),t,a))}}}checkVictoryConditions(){const t=this.players.filter(t=>!t.isDefeated());return 1===t.length?t[0]:null}initializePlayer(t,e,i){t.stellarForge=new x(e,t);for(const e of i){const i=new g(e,t);t.solarMirrors.push(i)}}}class P{constructor(t){this.camera=new h(0,0),this.zoom=1,this.selectionStart=null,this.selectionEnd=null,this.selectedUnits=new Set,this.tapEffects=[],this.swipeEffects=[],this.viewingPlayer=null,this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context from canvas");this.ctx=e,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t)}worldToScreen(t){const e=this.canvas.width/2,i=this.canvas.height/2;return new h(e+(t.x-this.camera.x)*this.zoom,i+(t.y-this.camera.y)*this.zoom)}screenToWorld(t,e){const i=this.canvas.width/2,s=this.canvas.height/2;return new h(this.camera.x+(t-i)/this.zoom,this.camera.y+(e-s)/this.zoom)}getFactionColor(t){switch(t){case c.RADIANT:return"#FFD700";case c.AURUM:return"#DAA520";case c.SOLARI:return"#FF8C00";default:return"#FFFFFF"}}drawSun(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);s.addColorStop(0,"rgba(255, 255, 150, 1)"),s.addColorStop(.5,"rgba(255, 200, 50, 0.5)"),s.addColorStop(1,"rgba(255, 150, 0, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFF00",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.6*i,0,2*Math.PI),this.ctx.fill()}drawLensFlare(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=window.devicePixelRatio||1,n=this.canvas.width/s,o=this.canvas.height/s,a=n/2,r=o/2,l=e.x-a,c=e.y-r;if(Math.sqrt(l*l+c*c)>Math.sqrt(n*n+o*o)/2+i)return;const h=[{offset:-.3,size:.4,alpha:.15,color:"rgba(255, 200, 100, "},{offset:-.5,size:.25,alpha:.12,color:"rgba(100, 150, 255, "},{offset:.4,size:.3,alpha:.1,color:"rgba(255, 150, 150, "},{offset:.7,size:.2,alpha:.08,color:"rgba(150, 255, 200, "}];for(const t of h){const e=a+l*t.offset,s=r+c*t.offset,n=i*t.size,o=this.ctx.createRadialGradient(e,s,0,e,s,n);o.addColorStop(0,`${t.color}${t.alpha})`),o.addColorStop(.5,`${t.color}${.5*t.alpha})`),o.addColorStop(1,`${t.color}0)`),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,s,n,0,2*Math.PI),this.ctx.fill()}this.ctx.save(),this.ctx.globalAlpha=.2,this.ctx.strokeStyle="rgba(255, 255, 200, 0.3)",this.ctx.lineWidth=2;for(let t=0;t<6;t++){const s=Math.PI/3*t,n=1.5*i,o=e.x+Math.cos(s)*i*.7,a=e.y+Math.sin(s)*i*.7,r=e.x+Math.cos(s)*n,l=e.y+Math.sin(s)*n,c=this.ctx.createLinearGradient(o,a,r,l);c.addColorStop(0,"rgba(255, 255, 200, 0.4)"),c.addColorStop(1,"rgba(255, 255, 200, 0)"),this.ctx.strokeStyle=c,this.ctx.beginPath(),this.ctx.moveTo(o,a),this.ctx.lineTo(r,l),this.ctx.stroke()}this.ctx.restore()}drawStellarForge(t,e,i,s){const o=this.worldToScreen(t.position),a=40*this.zoom;let r=!1;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(r=!0,this.ctx.globalAlpha=n)}t.isSelected&&(this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,1.5*a,0,2*Math.PI),this.ctx.stroke(),this.drawHeroButtons(t,o,a)),this.ctx.fillStyle=e,this.ctx.strokeStyle=t.isReceivingLight?"#00FF00":"#FF0000",this.ctx.lineWidth=3,this.ctx.beginPath();for(let t=0;t<6;t++){const e=Math.PI/3*t,i=o.x+a*Math.cos(e),s=o.y+a*Math.sin(e);0===t?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();const l=2*a,c=o.x-l/2,h=o.y-a-15;this.ctx.fillStyle="#333",this.ctx.fillRect(c,h,l,6);const d=t.health/1e3;this.ctx.fillStyle=d>.5?"#00FF00":d>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(c,h,l*d,6),r&&(this.ctx.globalAlpha=1)}drawHeroButtons(t,e,i){const s=20*this.zoom,n=2.5*i,o=[{x:0,y:-1,label:"H1"},{x:1,y:0,label:"H2"},{x:0,y:1,label:"H3"},{x:-1,y:0,label:"H4"}];for(let t=0;t<o.length;t++){const i=o[t],a=e.x+i.x*n,r=e.y+i.y*n,l=!0;this.ctx.fillStyle=l?"rgba(0, 255, 136, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=l?"#00FF88":"#888888",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(a,r,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=l?"#FFFFFF":"#666666",this.ctx.font=12*this.zoom+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i.label,a,r)}this.ctx.fillStyle="#AAAAAA",this.ctx.font=10*this.zoom+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText("Hero Production (Stub)",e.x,e.y+2.5*i)}drawSolarMirror(t,e){const i=this.worldToScreen(t.position),s=20*this.zoom;this.ctx.save();const n=Math.max(0,Math.min(1,1-t.closestSunDistance/r));if(n>.1&&t.closestSunDistance!==1/0){const t=15*this.zoom*(1+n),e=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,t);e.addColorStop(0,`rgba(255, 255, 150, ${.8*n})`),e.addColorStop(.5,`rgba(255, 255, 100, ${.4*n})`),e.addColorStop(1,"rgba(255, 255, 50, 0)"),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,t,0,2*Math.PI),this.ctx.fill()}this.ctx.translate(i.x,i.y),this.ctx.rotate(t.reflectionAngle);const o=2*s,a=.3*s,l=this.ctx.createLinearGradient(0,-a/2,0,a/2);l.addColorStop(0,"#FFFFFF"),l.addColorStop(.5,"#E0E0E0"),l.addColorStop(1,"#C0C0C0"),this.ctx.fillStyle=l,this.ctx.fillRect(-o/2,-a/2,o,a),this.ctx.strokeStyle=e,this.ctx.lineWidth=2,this.ctx.strokeRect(-o/2,-a/2,o,a),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(-o/2,0,3,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(o/2,0,3,0,2*Math.PI),this.ctx.fill(),t.isSelected&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.strokeRect(-o/2-3,-a/2-3,o+6,a+6)),this.ctx.restore(),t.efficiency<1&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,.3*s,0,2*Math.PI),this.ctx.fill())}drawSpaceDust(t){const e=this.worldToScreen(t.position),i=2*this.zoom;this.ctx.fillStyle=t.currentColor,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill()}drawAsteroid(t){const e=t.getWorldVertices();if(0===e.length)return;const i=e.map(t=>this.worldToScreen(t));this.ctx.fillStyle="#666666",this.ctx.strokeStyle="#888888",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)this.ctx.lineTo(i[t].x,i[t].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}drawSunRays(t){const e=this.ctx.createRadialGradient(this.canvas.width/2,this.canvas.height/2,0,this.canvas.width/2,this.canvas.height/2,Math.max(this.canvas.width,this.canvas.height));e.addColorStop(0,"rgba(255, 255, 200, 0.1)"),e.addColorStop(1,"rgba(255, 255, 200, 0)"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(const e of t.suns)for(const i of t.asteroids){const t=i.getWorldVertices();for(let i=0;i<t.length;i++){const n=t[i],o=t[(i+1)%t.length],a=new h((n.x+o.x)/2,(n.y+o.y)/2),r=new h(e.position.x-a.x,e.position.y-a.y),l=new h(-(o.y-n.y),o.x-n.x);if(r.x*l.x+r.y*l.y<0){const t=new h(n.x-e.position.x,n.y-e.position.y).normalize(),i=new h(o.x-e.position.x,o.y-e.position.y).normalize(),a=new h(n.x+t.x*s,n.y+t.y*s),r=new h(o.x+i.x*s,o.y+i.y*s),l=this.worldToScreen(n),c=this.worldToScreen(o),d=this.worldToScreen(a),p=this.worldToScreen(r);this.ctx.fillStyle="rgba(0, 0, 20, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y),this.ctx.lineTo(c.x,c.y),this.ctx.lineTo(p.x,p.y),this.ctx.lineTo(d.x,d.y),this.ctx.closePath(),this.ctx.fill()}}}}drawInfluenceCircle(t,e,i){const s=this.worldToScreen(t),n=e*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,n,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}drawWarpGate(t){const e=this.worldToScreen(t.position),i=50*this.zoom,s=t.chargeTime/6,n=Math.min(i,s*i);if(t.isComplete){this.ctx.fillStyle="rgba(0, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke();const t=20*this.zoom,s=i+30*this.zoom,n=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(let i=0;i<4;i++){const o=n[i],a=e.x+Math.cos(o)*s,r=e.y+Math.sin(o)*s;this.ctx.fillStyle="#444444",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(a,r,t,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=12*this.zoom+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`B${i+1}`,a,r)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}else this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.globalAlpha=.5+.2*Math.sin(5*t.chargeTime),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,n,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=5,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,n+5,0,s*Math.PI*2),this.ctx.stroke()}drawUnit(t,e,i,s){const o=this.worldToScreen(t.position),a=8*this.zoom,r=this.selectedUnits.has(t);let l=!1;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(l=!0,this.ctx.globalAlpha=n)}if(r&&t.isHero&&!s){const i=t.attackRange*this.zoom;this.ctx.strokeStyle=e,this.ctx.lineWidth=1,this.ctx.globalAlpha=.2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,i,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=l?n:1}r&&(this.ctx.strokeStyle="#00FF00",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,a+4,0,2*Math.PI),this.ctx.stroke()),this.ctx.fillStyle=e,this.ctx.strokeStyle=r?"#00FF00":"#FFFFFF",this.ctx.lineWidth=r?2:1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,a,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const c=3*a,h=o.x-c/2,d=o.y-a-8;this.ctx.fillStyle="#333",this.ctx.fillRect(h,d,c,3);const p=t.health/t.maxHealth;if(this.ctx.fillStyle=p>.5?"#00FF00":p>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(h,d,c*p,3),t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y,s=Math.atan2(i,e);this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(o.x+Math.cos(s)*a*1.5,o.y+Math.sin(s)*a*1.5),this.ctx.stroke()}l&&(this.ctx.globalAlpha=1)}drawMuzzleFlash(t){const e=this.worldToScreen(t.position),i=5*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.angle),this.ctx.fillStyle=`rgba(255, 255, 100, ${s})`,this.ctx.beginPath(),this.ctx.ellipse(0,0,2*i,i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBulletCasing(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=5*this.zoom,n=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.rotation),this.ctx.fillStyle=`rgba(255, 215, 0, ${n})`,this.ctx.fillRect(-i/2,-s/2,i,s),this.ctx.restore()}drawBouncingBullet(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=`rgba(255, 255, 0, ${s})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill()}drawAbilityBullet(t){const e=this.worldToScreen(t.position),i=4*this.zoom,s=t.lifetime/t.maxLifetime,n=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=`${n}`,this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawGrave(t,e,i,s){let o=!1;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=n)}this.drawUnit(t,e,i,s);const a=this.worldToScreen(t.position),r=10*this.zoom;this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y-r),this.ctx.lineTo(a.x,a.y+r),this.ctx.moveTo(a.x-.7*r,a.y-.3*r),this.ctx.lineTo(a.x+.7*r,a.y-.3*r),this.ctx.stroke();for(const i of t.getProjectiles())this.drawGraveProjectile(i,e);o&&(this.ctx.globalAlpha=1)}drawStarling(t,e,i,s){let o=!1;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=n)}this.drawUnit(t,e,i,s);const a=this.worldToScreen(t.position),r=6*this.zoom;this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(a.x-r,a.y),this.ctx.lineTo(a.x-.3*r,a.y-.5*r),this.ctx.lineTo(a.x,a.y),this.ctx.lineTo(a.x+.3*r,a.y-.5*r),this.ctx.lineTo(a.x+r,a.y),this.ctx.stroke(),o&&(this.ctx.globalAlpha=1)}drawMinigun(t,e,i,s){const o=this.worldToScreen(t.position),a=t.radius*this.zoom;let r=!1;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;i.isPointInShadow(t.position)&&(r=!0,this.ctx.globalAlpha=n)}if(!t.isComplete){this.ctx.fillStyle="rgba(0, 255, 255, 0.2)",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,a,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const e=2*a,i=4,s=o.x-e/2,n=o.y+a+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,n,e,i),this.ctx.fillStyle="#00FF00",this.ctx.fillRect(s,n,e*t.buildProgress,i),void(r&&(this.ctx.globalAlpha=1))}this.ctx.fillStyle=e,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,a,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const l=.6*a;this.ctx.fillStyle="#666666",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,l,0,2*Math.PI),this.ctx.fill();let c=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;c=Math.atan2(i,e)}const h=1.2*a,d=4*this.zoom;this.ctx.strokeStyle="#333333",this.ctx.lineWidth=d,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(o.x+Math.cos(c)*h,o.y+Math.sin(c)*h),this.ctx.stroke();const p=2*a,g=o.x-p/2,x=o.y-a-10;this.ctx.fillStyle="#FF0000",this.ctx.fillRect(g,x,p,4);const u=t.health/t.maxHealth;this.ctx.fillStyle="#00FF00",this.ctx.fillRect(g,x,p*u,4),r&&(this.ctx.globalAlpha=1)}drawGraveProjectile(t,e){const i=this.worldToScreen(t.position),s=4*this.zoom;if(t.isAttacking&&t.trail.length>1){this.ctx.strokeStyle=e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath();for(let e=0;e<t.trail.length;e++){const i=this.worldToScreen(t.trail[e]);0===e?this.ctx.moveTo(i.x,i.y):this.ctx.lineTo(i.x,i.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle=e,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isAttacking&&(this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,1.5*s,0,2*Math.PI),this.ctx.fill())}drawConnections(t,e,i){if(!t.stellarForge)return;const s=this.worldToScreen(t.stellarForge.position);for(const n of t.solarMirrors){const o=this.worldToScreen(n.position),a=n.hasLineOfSightToLight(e,i),r=n.getClosestVisibleSun(e,i),l=n.hasLineOfSightToForge(t.stellarForge,i);if(r){const t=this.worldToScreen(r.position);this.ctx.strokeStyle=a?"rgba(0, 255, 0, 0.4)":"rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}this.ctx.strokeStyle=l?"rgba(0, 150, 255, 0.4)":"rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.setLineDash([]),a&&l&&(this.ctx.fillStyle="rgba(255, 255, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,15*this.zoom,0,2*Math.PI),this.ctx.fill())}}drawUI(t){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,10,300,200),this.ctx.fillStyle="#FFFFFF",this.ctx.font="16px Arial",this.ctx.fillText("SoL - Speed of Light RTS",20,30),this.ctx.fillText(`Game Time: ${t.gameTime.toFixed(1)}s`,20,50),this.ctx.fillText(`Dust Particles: ${t.spaceDust.length}`,20,70),this.ctx.fillText(`Asteroids: ${t.asteroids.length}`,20,90),this.ctx.fillText(`Warp Gates: ${t.warpGates.length}`,20,110);let e=140;for(const i of t.players){const t=this.getFactionColor(i.faction);if(this.ctx.fillStyle=t,this.ctx.fillText(`${i.name} (${i.faction})`,20,e),this.ctx.fillStyle="#FFFFFF",this.ctx.fillText(`Solarium: ${i.solarium.toFixed(1)}`,20,e+20),i.stellarForge){const t=i.stellarForge.isReceivingLight?"✓ Light":"✗ No Light";this.ctx.fillText(`${t} | HP: ${i.stellarForge.health.toFixed(0)}`,20,e+40)}e+=60}this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,this.canvas.height-100,450,90),this.ctx.fillStyle="#FFFFFF",this.ctx.font="14px Arial",this.ctx.fillText("Controls: Drag to select units",20,this.canvas.height-75),this.ctx.fillText("Pan: WASD/Arrows or mouse edge or two-finger drag",20,this.canvas.height-55),this.ctx.fillText("Zoom: Scroll/Pinch (zooms toward cursor)",20,this.canvas.height-35),this.ctx.fillText("Hold still 6 seconds in influence to open warp gate",20,this.canvas.height-15)}drawSelectionRectangle(){if(!this.selectionStart||!this.selectionEnd)return;const t=Math.min(this.selectionStart.x,this.selectionEnd.x),e=Math.min(this.selectionStart.y,this.selectionEnd.y),i=Math.abs(this.selectionEnd.x-this.selectionStart.x),s=Math.abs(this.selectionEnd.y-this.selectionStart.y);this.ctx.strokeStyle="rgba(0, 255, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="rgba(0, 255, 0, 0.1)",this.ctx.fillRect(t,e,i,s),this.ctx.setLineDash([])}createTapEffect(t,e){this.tapEffects.push({position:new h(t,e),progress:0})}createSwipeEffect(t,e,i,s){this.swipeEffects.push({start:new h(t,e),end:new h(i,s),progress:0})}updateAndDrawTapEffects(){for(let t=this.tapEffects.length-1;t>=0;t--){const e=this.tapEffects[t];if(e.progress+=.05,e.progress>=1){this.tapEffects.splice(t,1);continue}const i=40*e.progress,s=1-e.progress;this.ctx.strokeStyle=`rgba(100, 200, 255, ${s})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,i,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(e.position.x,e.position.y,0,e.position.x,e.position.y,.5*i);n.addColorStop(0,`rgba(100, 200, 255, ${.5*s})`),n.addColorStop(1,"rgba(100, 200, 255, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,.5*i,0,2*Math.PI),this.ctx.fill()}}updateAndDrawSwipeEffects(){for(let t=this.swipeEffects.length-1;t>=0;t--){const e=this.swipeEffects[t];if(e.progress+=.08,e.progress>=1){this.swipeEffects.splice(t,1);continue}const i=e.end.x-e.start.x,s=e.end.y-e.start.y,n=Math.sqrt(i*i+s*s);if(n<5)continue;const o=1-e.progress,a=n*e.progress;this.ctx.strokeStyle=`rgba(255, 200, 100, ${.7*o})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(e.start.x,e.start.y);const r=e.start.x+i/n*a,l=e.start.y+s/n*a;if(this.ctx.lineTo(r,l),this.ctx.stroke(),e.progress>.3){const t=Math.atan2(s,i);this.ctx.fillStyle=`rgba(255, 200, 100, ${o})`,this.ctx.beginPath(),this.ctx.moveTo(r,l),this.ctx.lineTo(r-15*Math.cos(t-Math.PI/6),l-15*Math.sin(t-Math.PI/6)),this.ctx.lineTo(r-15*Math.cos(t+Math.PI/6),l-15*Math.sin(t+Math.PI/6)),this.ctx.closePath(),this.ctx.fill()}for(let t=0;t<5;t++){const r=t/5,l=e.start.x+i/n*a*r,c=e.start.y+s/n*a*r,h=o*(1-r)*.3,d=this.ctx.createRadialGradient(l,c,0,l,c,10);d.addColorStop(0,`rgba(255, 200, 100, ${h})`),d.addColorStop(1,"rgba(255, 200, 100, 0)"),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(l,c,10,0,2*Math.PI),this.ctx.fill()}}}render(s){this.ctx.fillStyle="#000011",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFFFFF";for(let t=0;t<100;t++){const e=137.5*t%this.canvas.width,i=217.3*t%this.canvas.height,s=t%3*.5+.5;this.ctx.fillRect(e,i,s,s)}for(const t of s.spaceDust)this.drawSpaceDust(t);for(const t of s.suns)this.drawSun(t);this.drawSunRays(s);for(const t of s.suns)this.drawLensFlare(t);for(const t of s.asteroids)this.drawAsteroid(t);const n=[];for(let o=0;o<s.players.length;o++){const a=s.players[o];if(a.stellarForge&&!a.isDefeated()){const s=0===o?e:i;n.push({position:a.stellarForge.position,radius:t,color:s})}}const o=new Map;for(const t of n)o.has(t.color)||o.set(t.color,[]),o.get(t.color).push({position:t.position,radius:t.radius});for(const[t,e]of o)if(1===e.length)this.drawInfluenceCircle(e[0].position,e[0].radius,t);else{this.ctx.save(),this.ctx.beginPath();for(const t of e){const e=this.worldToScreen(t.position),i=t.radius*this.zoom;this.ctx.moveTo(e.x+i,e.y),this.ctx.arc(e.x,e.y,i,0,2*Math.PI)}this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle=t,this.ctx.globalAlpha=.05,this.ctx.fill(),this.ctx.globalAlpha=.3,this.ctx.strokeStyle=t,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}for(const t of s.players)t.isDefeated()||this.drawConnections(t,s.suns,s.asteroids);for(const t of s.players){if(t.isDefeated())continue;const e=this.getFactionColor(t.faction),i=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const i of t.solarMirrors)this.drawSolarMirror(i,e);t.stellarForge&&this.drawStellarForge(t.stellarForge,e,s,i)}for(const t of s.warpGates)this.drawWarpGate(t);for(const t of s.players){if(t.isDefeated())continue;const e=this.getFactionColor(t.faction),i=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const n of t.units)n instanceof T?this.drawGrave(n,e,s,i):n instanceof D?this.drawStarling(n,e,s,i):this.drawUnit(n,e,s,i)}for(const t of s.players){if(t.isDefeated())continue;const e=this.getFactionColor(t.faction),i=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const n of t.buildings)n instanceof f&&this.drawMinigun(n,e,s,i)}for(const t of s.muzzleFlashes)this.drawMuzzleFlash(t);for(const t of s.bulletCasings)this.drawBulletCasing(t);for(const t of s.bouncingBullets)this.drawBouncingBullet(t);for(const t of s.abilityBullets)this.drawAbilityBullet(t);this.drawUI(s),this.drawSelectionRectangle(),this.updateAndDrawTapEffects(),this.updateAndDrawSwipeEffects();const a=s.checkVictoryConditions();if(a&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.getFactionColor(a.faction),this.ctx.font="bold 48px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${a.name} WINS!`,this.canvas.width/2,this.canvas.height/2),this.ctx.textAlign="left"),s.isCountdownActive){this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFD700",this.ctx.font="bold 120px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=Math.ceil(s.countdownTime),e=t>0?t.toString():"Go!";this.ctx.fillText(e,this.canvas.width/2,this.canvas.height/2),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}}setZoom(t){this.zoom=Math.max(.5,Math.min(2,t))}setCameraPosition(t){this.camera=t}}class I{constructor(){this.onStartCallback=null,this.currentScreen="main",this.carouselMenu=null,this.heroUnits=[{id:"radiant-1",name:"Luminar",description:"Master of light manipulation",faction:c.RADIANT,maxHealth:120,attackDamage:12,attackSpeed:2.5,attackRange:350,attackIgnoresDefense:!1,defense:15,regen:3,abilityDescription:"Bends light rays to blind and confuse enemies"},{id:"radiant-2",name:"Prismara",description:"Rainbow warrior",faction:c.RADIANT,maxHealth:100,attackDamage:15,attackSpeed:3,attackRange:300,attackIgnoresDefense:!1,defense:10,regen:4,abilityDescription:"Splits attacks into multiple colored beams"},{id:"radiant-3",name:"Solstice",description:"Sun-caller",faction:c.RADIANT,maxHealth:110,attackDamage:18,attackSpeed:1.5,attackRange:400,attackIgnoresDefense:!1,defense:12,regen:5,abilityDescription:"Calls down focused sunlight on enemies"},{id:"radiant-4",name:"Beamforge",description:"Laser specialist",faction:c.RADIANT,maxHealth:90,attackDamage:20,attackSpeed:2,attackRange:450,attackIgnoresDefense:!0,defense:8,regen:2,abilityDescription:"Fires piercing laser that ignores defense"},{id:"radiant-5",name:"Photonix",description:"Speed of light incarnate",faction:c.RADIANT,maxHealth:80,attackDamage:10,attackSpeed:5,attackRange:250,attackIgnoresDefense:!1,defense:5,regen:6,abilityDescription:"Rapidly teleports in combat, dodging attacks"},{id:"radiant-6",name:"Glowbringer",description:"Illumination support",faction:c.RADIANT,maxHealth:130,attackDamage:8,attackSpeed:2,attackRange:300,attackIgnoresDefense:!1,defense:20,regen:8,abilityDescription:"Heals nearby allies with radiant energy"},{id:"radiant-7",name:"Radiance",description:"Pure light entity",faction:c.RADIANT,maxHealth:85,attackDamage:22,attackSpeed:1.8,attackRange:350,attackIgnoresDefense:!0,defense:0,regen:10,abilityDescription:"Becomes pure energy, immune to physical damage"},{id:"radiant-8",name:"Stellaris",description:"Star-born warrior",faction:c.RADIANT,maxHealth:140,attackDamage:14,attackSpeed:2.2,attackRange:320,attackIgnoresDefense:!1,defense:18,regen:4,abilityDescription:"Creates stellar shields for nearby units"},{id:"radiant-9",name:"Luxarion",description:"Light shield bearer",faction:c.RADIANT,maxHealth:160,attackDamage:10,attackSpeed:1.5,attackRange:280,attackIgnoresDefense:!1,defense:30,regen:3,abilityDescription:"Deploys hard-light barrier blocking attacks"},{id:"radiant-10",name:"Dawnbringer",description:"Herald of morning",faction:c.RADIANT,maxHealth:115,attackDamage:16,attackSpeed:2.5,attackRange:340,attackIgnoresDefense:!1,defense:12,regen:5,abilityDescription:"Dawn pulse damages and slows enemies"},{id:"radiant-11",name:"Shimmerwind",description:"Swift light dancer",faction:c.RADIANT,maxHealth:70,attackDamage:12,attackSpeed:4.5,attackRange:220,attackIgnoresDefense:!1,defense:8,regen:7,abilityDescription:"Dashes rapidly, leaving afterimages"},{id:"radiant-12",name:"Eclipsar",description:"Master of light and shadow",faction:c.RADIANT,maxHealth:105,attackDamage:18,attackSpeed:2,attackRange:360,attackIgnoresDefense:!1,defense:15,regen:4,abilityDescription:"Toggles between light and shadow forms"},{id:"aurum-1",name:"Goldhart",description:"Golden commander",faction:c.AURUM,maxHealth:130,attackDamage:14,attackSpeed:2,attackRange:320,attackIgnoresDefense:!1,defense:20,regen:4,abilityDescription:"Rallies allies, boosting their stats"},{id:"aurum-2",name:"Wealthweaver",description:"Economic mastermind",faction:c.AURUM,maxHealth:90,attackDamage:8,attackSpeed:1.5,attackRange:280,attackIgnoresDefense:!1,defense:10,regen:6,abilityDescription:"Generates bonus solarium per crunch"},{id:"aurum-3",name:"Coinforge",description:"Resource multiplier",faction:c.AURUM,maxHealth:100,attackDamage:10,attackSpeed:2,attackRange:300,attackIgnoresDefense:!1,defense:12,regen:5,abilityDescription:"Converts damage dealt into solarium"},{id:"aurum-4",name:"Gilded Guardian",description:"Defensive specialist",faction:c.AURUM,maxHealth:180,attackDamage:8,attackSpeed:1.2,attackRange:260,attackIgnoresDefense:!1,defense:35,regen:2,abilityDescription:"Forms golden barrier absorbing damage"},{id:"aurum-5",name:"Treasureheart",description:"Loot collector",faction:c.AURUM,maxHealth:110,attackDamage:12,attackSpeed:2.5,attackRange:310,attackIgnoresDefense:!1,defense:15,regen:5,abilityDescription:"Collects resources from defeated enemies"},{id:"aurum-6",name:"Aurumancer",description:"Gold magic user",faction:c.AURUM,maxHealth:95,attackDamage:20,attackSpeed:1.8,attackRange:380,attackIgnoresDefense:!1,defense:8,regen:4,abilityDescription:"Transmutes enemies into golden statues"},{id:"aurum-7",name:"Mintmaster",description:"Economy booster",faction:c.AURUM,maxHealth:85,attackDamage:10,attackSpeed:2,attackRange:290,attackIgnoresDefense:!1,defense:10,regen:7,abilityDescription:"Mints golden coins that boost production"},{id:"aurum-8",name:"Goldstrike",description:"Heavy hitter",faction:c.AURUM,maxHealth:125,attackDamage:25,attackSpeed:1.5,attackRange:340,attackIgnoresDefense:!0,defense:15,regen:3,abilityDescription:"Delivers devastating golden hammer blow"},{id:"aurum-9",name:"Vaultkeeper",description:"Resource protector",faction:c.AURUM,maxHealth:150,attackDamage:11,attackSpeed:1.8,attackRange:300,attackIgnoresDefense:!1,defense:25,regen:4,abilityDescription:"Creates vault shield protecting structures"},{id:"aurum-10",name:"Prosperion",description:"Wealth incarnate",faction:c.AURUM,maxHealth:140,attackDamage:16,attackSpeed:2.2,attackRange:350,attackIgnoresDefense:!1,defense:18,regen:5,abilityDescription:"Radiates prosperity, buffing nearby units"},{id:"aurum-11",name:"Opulence",description:"Luxury warrior",faction:c.AURUM,maxHealth:120,attackDamage:18,attackSpeed:2,attackRange:330,attackIgnoresDefense:!1,defense:22,regen:4,abilityDescription:"Summons golden minions to fight"},{id:"aurum-12",name:"Bullionaire",description:"Market dominator",faction:c.AURUM,maxHealth:110,attackDamage:15,attackSpeed:2.5,attackRange:320,attackIgnoresDefense:!1,defense:12,regen:6,abilityDescription:"Manipulates market, disrupting enemy economy"},{id:"solari-1",name:"Sunwarden",description:"Solar defender",faction:c.SOLARI,maxHealth:150,attackDamage:12,attackSpeed:1.8,attackRange:300,attackIgnoresDefense:!1,defense:25,regen:5,abilityDescription:"Solar shield blocks incoming attacks"},{id:"solari-2",name:"Flareborn",description:"Fire warrior",faction:c.SOLARI,maxHealth:100,attackDamage:22,attackSpeed:2.5,attackRange:280,attackIgnoresDefense:!1,defense:10,regen:6,abilityDescription:"Ignites enemies with solar flares"},{id:"solari-3",name:"Heliarch",description:"Sun priest",faction:c.SOLARI,maxHealth:110,attackDamage:14,attackSpeed:2,attackRange:340,attackIgnoresDefense:!1,defense:15,regen:8,abilityDescription:"Channels sun energy to heal and empower"},{id:"solari-4",name:"Coronax",description:"Solar storm bringer",faction:c.SOLARI,maxHealth:95,attackDamage:18,attackSpeed:2.8,attackRange:360,attackIgnoresDefense:!1,defense:8,regen:5,abilityDescription:"Summons solar storm damaging area"},{id:"solari-5",name:"Pyroclast",description:"Lava manipulator",faction:c.SOLARI,maxHealth:105,attackDamage:20,attackSpeed:2,attackRange:320,attackIgnoresDefense:!0,defense:12,regen:4,abilityDescription:"Creates lava pools that damage over time"},{id:"solari-6",name:"Solarion",description:"Sun champion",faction:c.SOLARI,maxHealth:135,attackDamage:16,attackSpeed:2.2,attackRange:330,attackIgnoresDefense:!1,defense:20,regen:5,abilityDescription:"Empowered by sun, gains strength in light"},{id:"solari-7",name:"Infernova",description:"Supernova wielder",faction:c.SOLARI,maxHealth:80,attackDamage:28,attackSpeed:1.5,attackRange:400,attackIgnoresDefense:!0,defense:5,regen:3,abilityDescription:"Unleashes supernova explosion"},{id:"solari-8",name:"Dawnkeeper",description:"Morning guardian",faction:c.SOLARI,maxHealth:125,attackDamage:13,attackSpeed:2,attackRange:310,attackIgnoresDefense:!1,defense:18,regen:6,abilityDescription:"Dawn light revitalizes allies"},{id:"solari-9",name:"Sunscorch",description:"Burning blade",faction:c.SOLARI,maxHealth:90,attackDamage:24,attackSpeed:3,attackRange:250,attackIgnoresDefense:!1,defense:8,regen:5,abilityDescription:"Blade burns with solar fire"},{id:"solari-10",name:"Heliorax",description:"Solar dragon",faction:c.SOLARI,maxHealth:160,attackDamage:20,attackSpeed:1.8,attackRange:380,attackIgnoresDefense:!1,defense:22,regen:4,abilityDescription:"Breathes solar flames in wide arc"},{id:"solari-11",name:"Blazeheart",description:"Fire soul",faction:c.SOLARI,maxHealth:100,attackDamage:16,attackSpeed:2.8,attackRange:300,attackIgnoresDefense:!1,defense:10,regen:7,abilityDescription:"Burns hotter when health is low"},{id:"solari-12",name:"Solarflare",description:"Burst specialist",faction:c.SOLARI,maxHealth:85,attackDamage:14,attackSpeed:4,attackRange:290,attackIgnoresDefense:!1,defense:6,regen:6,abilityDescription:"Releases rapid bursts of solar energy"}],this.availableMaps=[{id:"standard",name:"Standard Battle",description:"Classic 1v1 map with a single sun at the center. Balanced gameplay with moderate obstacles.",numSuns:1,numAsteroids:10,mapSize:2e3},{id:"twin-suns",name:"Twin Suns",description:"Two suns create complex lighting patterns. Control multiple light sources for economic dominance.",numSuns:2,numAsteroids:12,mapSize:2500},{id:"asteroid-field",name:"Asteroid Field",description:"Dense asteroid field creates tactical challenges. Careful mirror placement is crucial.",numSuns:1,numAsteroids:20,mapSize:2e3},{id:"open-space",name:"Open Space",description:"Minimal obstacles in a vast arena. Pure strategic combat with fewer terrain advantages.",numSuns:1,numAsteroids:5,mapSize:3e3}],this.settings={selectedMap:this.availableMaps[0],difficulty:"normal",soundEnabled:!0,musicEnabled:!0,selectedFaction:null,selectedHeroes:[]},this.menuElement=this.createMenuElement(),document.body.appendChild(this.menuElement)}createMenuElement(){const t=document.createElement("div");return t.id="mainMenu",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 10, 0.95)",t.style.display="flex",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",t.style.fontFamily="Arial, sans-serif",t.style.color="#FFFFFF",t.style.overflowY="auto",this.renderMainScreenContent(t),t}clearMenu(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.menuElement&&(this.menuElement.innerHTML="")}renderMainScreen(t){this.clearMenu(),this.renderMainScreenContent(t)}renderMainScreenContent(t){const e=document.createElement("h1");e.textContent="SoL",e.style.fontSize="72px",e.style.marginBottom="10px",e.style.color="#FFD700",e.style.textShadow="0 0 20px rgba(255, 215, 0, 0.5)",t.appendChild(e);const i=document.createElement("h2");i.textContent="Speed of Light RTS",i.style.fontSize="24px",i.style.marginBottom="30px",i.style.color="#AAAAAA",t.appendChild(i);const s=document.createElement("p");s.textContent="Select a menu option below",s.style.fontSize="16px",s.style.marginBottom="40px",s.style.maxWidth="500px",s.style.textAlign="center",s.style.lineHeight="1.5",t.appendChild(s);const n=document.createElement("div");n.style.width="100%",n.style.maxWidth="900px",n.style.marginBottom="40px",t.appendChild(n),this.carouselMenu=new R(n,[{id:"loadout",name:"LOADOUT",description:"Select faction & heroes"},{id:"start",name:"START",description:"Begin game"},{id:"maps",name:"MAPS",description:"Select map"},{id:"settings",name:"SETTINGS",description:"Configure game"}]),this.carouselMenu.onSelect(t=>{switch(t.id){case"loadout":this.currentScreen="faction-select",this.renderFactionSelectionScreen(this.menuElement);break;case"start":this.hide(),this.onStartCallback&&this.onStartCallback(this.settings);break;case"maps":this.currentScreen="maps",this.renderMapSelectionScreen(this.menuElement);break;case"settings":this.currentScreen="settings",this.renderSettingsScreen(this.menuElement)}});const o=document.createElement("div");o.style.marginTop="20px",o.style.fontSize="14px",o.style.color="#AAAAAA";let a="Not configured";this.settings.selectedFaction&&4===this.settings.selectedHeroes.length?a=`<span style="color: #00FF88;">${this.settings.selectedFaction} - 4 heroes</span>`:this.settings.selectedFaction&&(a=`<span style="color: #FFA500;">${this.settings.selectedFaction} - ${this.settings.selectedHeroes.length}/4 heroes</span>`),o.innerHTML=`\n            <div style="text-align: center;">\n                <div>Loadout: ${a}</div>\n                <div style="margin-top: 5px;">Map: <span style="color: #FFD700;">${this.settings.selectedMap.name}</span></div>\n            </div>\n        `,t.appendChild(o);const r=document.createElement("div");r.style.marginTop="40px",r.style.fontSize="14px",r.style.color="#888888",r.innerHTML='\n            <div style="text-align: center;">\n                <div>✨ Ray-traced lighting and shadows</div>\n                <div style="margin-top: 5px;">🌌 Asteroid obstacles with dynamic polygons</div>\n                <div style="margin-top: 5px;">⭐ Solar mirrors with line-of-sight visualization</div>\n                <div style="margin-top: 5px;">🎮 Touch and mouse controls</div>\n            </div>\n        ',t.appendChild(r)}renderMapSelectionScreen(t){this.clearMenu();const e=document.createElement("h2");e.textContent="Select Map",e.style.fontSize="48px",e.style.marginBottom="30px",e.style.color="#FFD700",t.appendChild(e);const i=document.createElement("div");i.style.display="grid",i.style.gridTemplateColumns="repeat(auto-fit, minmax(300px, 1fr))",i.style.gap="20px",i.style.maxWidth="900px",i.style.padding="20px",i.style.marginBottom="30px";for(const t of this.availableMaps){const e=document.createElement("div");e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.border=t.id===this.settings.selectedMap.id?"3px solid #FFD700":"2px solid rgba(255, 255, 255, 0.2)",e.style.borderRadius="10px",e.style.padding="20px",e.style.cursor="pointer",e.style.transition="all 0.3s",e.addEventListener("mouseenter",()=>{t.id!==this.settings.selectedMap.id&&(e.style.backgroundColor="rgba(255, 255, 255, 0.1)",e.style.transform="scale(1.02)")}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.transform="scale(1)"}),e.addEventListener("click",()=>{this.settings.selectedMap=t,this.renderMapSelectionScreen(this.menuElement)});const s=document.createElement("h3");s.textContent=t.name,s.style.fontSize="24px",s.style.marginBottom="10px",s.style.color=t.id===this.settings.selectedMap.id?"#FFD700":"#FFFFFF",e.appendChild(s);const n=document.createElement("p");n.textContent=t.description,n.style.fontSize="14px",n.style.lineHeight="1.5",n.style.marginBottom="15px",n.style.color="#CCCCCC",e.appendChild(n);const o=document.createElement("div");o.style.fontSize="12px",o.style.color="#888888",o.innerHTML=`\n                <div>⭐ Suns: ${t.numSuns}</div>\n                <div>🌑 Asteroids: ${t.numAsteroids}</div>\n                <div>📏 Size: ${t.mapSize}px</div>\n            `,e.appendChild(o),i.appendChild(e)}t.appendChild(i);const s=this.createButton("BACK",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#666666");t.appendChild(s)}renderSettingsScreen(t){this.clearMenu();const e=document.createElement("h2");e.textContent="Settings",e.style.fontSize="48px",e.style.marginBottom="30px",e.style.color="#FFD700",t.appendChild(e);const i=document.createElement("div");i.style.maxWidth="500px",i.style.width="100%",i.style.padding="20px";const s=this.createSettingSection("Difficulty",this.createSelect(["easy","normal","hard"],this.settings.difficulty,t=>{this.settings.difficulty=t}));i.appendChild(s);const n=this.createSettingSection("Sound Effects",this.createToggle(this.settings.soundEnabled,t=>{this.settings.soundEnabled=t}));i.appendChild(n);const o=this.createSettingSection("Music",this.createToggle(this.settings.musicEnabled,t=>{this.settings.musicEnabled=t}));i.appendChild(o),t.appendChild(i);const a=this.createButton("BACK",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#666666");a.style.marginTop="30px",t.appendChild(a)}renderFactionSelectionScreen(t){this.clearMenu();const e=document.createElement("h2");e.textContent="Select Your Faction",e.style.fontSize="48px",e.style.marginBottom="30px",e.style.color="#FFD700",t.appendChild(e);const i=document.createElement("div");i.style.display="grid",i.style.gridTemplateColumns="repeat(auto-fit, minmax(280px, 1fr))",i.style.gap="20px",i.style.maxWidth="900px",i.style.padding="20px",i.style.marginBottom="30px";const s=[{id:c.RADIANT,name:"Radiant",description:"Masters of light manipulation. Enhanced mirror efficiency and faster light-based attacks.",color:"#00AAFF"},{id:c.AURUM,name:"Aurum",description:"Wealth-oriented civilization. Economic bonuses and resource multiplication.",color:"#FFD700"},{id:c.SOLARI,name:"Solari",description:"Sun-worshipping empire. Stronger structures and enhanced solar collection.",color:"#FF6600"}];for(const t of s){const e=document.createElement("div");e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.border=this.settings.selectedFaction===t.id?`3px solid ${t.color}`:"2px solid rgba(255, 255, 255, 0.2)",e.style.borderRadius="10px",e.style.padding="20px",e.style.cursor="pointer",e.style.transition="all 0.3s",e.style.minHeight="200px",e.addEventListener("mouseenter",()=>{this.settings.selectedFaction!==t.id&&(e.style.backgroundColor="rgba(255, 255, 255, 0.1)",e.style.transform="scale(1.02)")}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.transform="scale(1)"}),e.addEventListener("click",()=>{this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.renderFactionSelectionScreen(this.menuElement)});const s=document.createElement("h3");s.textContent=t.name,s.style.fontSize="28px",s.style.marginBottom="15px",s.style.color=this.settings.selectedFaction===t.id?t.color:"#FFFFFF",e.appendChild(s);const n=document.createElement("p");n.textContent=t.description,n.style.fontSize="14px",n.style.lineHeight="1.5",n.style.color="#CCCCCC",e.appendChild(n),i.appendChild(e)}t.appendChild(i);const n=document.createElement("div");if(n.style.display="flex",n.style.gap="20px",n.style.marginTop="20px",this.settings.selectedFaction){const t=this.createButton("SELECT HEROES",()=>{this.currentScreen="loadout-select",this.renderLoadoutSelectionScreen(this.menuElement)},"#00FF88");n.appendChild(t)}const o=this.createButton("BACK",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#666666");n.appendChild(o),t.appendChild(n)}renderLoadoutSelectionScreen(t){if(this.clearMenu(),!this.settings.selectedFaction)return void this.renderFactionSelectionScreen(t);const e=document.createElement("h2");e.textContent=`Select 4 Heroes - ${this.settings.selectedFaction}`,e.style.fontSize="42px",e.style.marginBottom="20px",e.style.color="#FFD700",t.appendChild(e);const i=document.createElement("div");i.textContent=`Selected: ${this.settings.selectedHeroes.length} / 4`,i.style.fontSize="18px",i.style.marginBottom="30px",i.style.color=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",t.appendChild(i);const s=document.createElement("div");s.style.display="grid",s.style.gridTemplateColumns="repeat(auto-fit, minmax(280px, 1fr))",s.style.gap="15px",s.style.maxWidth="1200px",s.style.padding="20px",s.style.marginBottom="20px",s.style.maxHeight="600px",s.style.overflowY="auto";const n=this.heroUnits.filter(t=>t.faction===this.settings.selectedFaction);for(const t of n){const e=this.settings.selectedHeroes.includes(t.id),i=e||this.settings.selectedHeroes.length<4,n=document.createElement("div");n.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",n.style.border=e?"3px solid #00FF88":"2px solid rgba(255, 255, 255, 0.2)",n.style.borderRadius="10px",n.style.padding="15px",n.style.cursor=i?"pointer":"not-allowed",n.style.transition="all 0.3s",n.style.opacity=i?"1":"0.5",n.style.minHeight="300px",i&&(n.addEventListener("mouseenter",()=>{e||(n.style.backgroundColor="rgba(255, 255, 255, 0.1)",n.style.transform="scale(1.02)")}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",n.style.transform="scale(1)"}),n.addEventListener("click",()=>{e?this.settings.selectedHeroes=this.settings.selectedHeroes.filter(e=>e!==t.id):this.settings.selectedHeroes.length<4&&this.settings.selectedHeroes.push(t.id),this.renderLoadoutSelectionScreen(this.menuElement)}));const o=document.createElement("h4");o.textContent=t.name,o.style.fontSize="18px",o.style.marginBottom="8px",o.style.color=e?"#00FF88":"#FFFFFF",n.appendChild(o);const a=document.createElement("p");a.textContent=t.description,a.style.fontSize="12px",a.style.lineHeight="1.4",a.style.color="#AAAAAA",a.style.marginBottom="10px",n.appendChild(a);const r=document.createElement("div");r.style.fontSize="11px",r.style.lineHeight="1.6",r.style.color="#CCCCCC",r.style.marginBottom="8px",r.style.padding="8px",r.style.backgroundColor="rgba(0, 0, 0, 0.3)",r.style.borderRadius="5px";const l=document.createElement("div");l.textContent=`❤ Health: ${t.maxHealth}`,r.appendChild(l);const c=document.createElement("div");c.textContent=`♻ Regen: ${t.regen}%`,r.appendChild(c);const h=document.createElement("div");h.textContent=`🛡 Defense: ${t.defense}%`,r.appendChild(h);const d=document.createElement("div"),p=t.attackIgnoresDefense?"⚡":"⚔",g=t.attackIgnoresDefense?" (ignores defense)":"";d.textContent=`${p} Attack: ${t.attackDamage}${g}`,r.appendChild(d);const x=document.createElement("div");x.textContent=`⏱ Speed: ${t.attackSpeed}/s`,r.appendChild(x);const u=document.createElement("div");u.textContent=`🎯 Range: ${t.attackRange}`,r.appendChild(u),n.appendChild(r);const f=document.createElement("div");if(f.style.fontSize="11px",f.style.lineHeight="1.4",f.style.color="#FFD700",f.style.marginBottom="8px",f.style.fontStyle="italic",f.textContent=`✨ ${t.abilityDescription}`,n.appendChild(f),e){const t=document.createElement("div");t.textContent="✓ Selected",t.style.fontSize="12px",t.style.marginTop="8px",t.style.color="#00FF88",t.style.fontWeight="bold",n.appendChild(t)}s.appendChild(n)}t.appendChild(s);const o=document.createElement("div");if(o.style.display="flex",o.style.gap="20px",o.style.marginTop="20px",4===this.settings.selectedHeroes.length){const t=this.createButton("CONFIRM LOADOUT",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#00FF88");o.appendChild(t)}const a=this.createButton("BACK",()=>{this.currentScreen="faction-select",this.renderFactionSelectionScreen(this.menuElement)},"#666666");o.appendChild(a),t.appendChild(o)}createButton(t,e,i="#FFD700"){const s=document.createElement("button");return s.textContent=t,s.style.fontSize="24px",s.style.padding="15px 40px",s.style.backgroundColor=i,s.style.color="#666666"===i?"#FFFFFF":"#000000",s.style.border="none",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontWeight="bold",s.style.transition="all 0.3s",s.addEventListener("mouseenter",()=>{const t="#FFD700"===i?"#FFA500":"#00AAFF"===i?"#0088DD":"#00FF88"===i?"#00DD66":"#888888";s.style.backgroundColor=t,s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor=i,s.style.transform="scale(1)"}),s.addEventListener("click",e),s}createSettingSection(t,e){const i=document.createElement("div");i.style.marginBottom="30px",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center";const s=document.createElement("label");return s.textContent=t,s.style.fontSize="18px",s.style.color="#FFFFFF",i.appendChild(s),i.appendChild(e),i}createSelect(t,e,i){const s=document.createElement("select");s.style.fontSize="16px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer";for(const i of t){const t=document.createElement("option");t.value=i,t.textContent=i.charAt(0).toUpperCase()+i.slice(1),t.selected=i===e,t.style.backgroundColor="#000011",s.appendChild(t)}return s.addEventListener("change",()=>{i(s.value)}),s}createToggle(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="60px",s.style.height="30px",s.style.backgroundColor=t?"#00FF88":"#666666",s.style.borderRadius="15px",s.style.position="relative",s.style.cursor="pointer",s.style.transition="all 0.3s";const n=document.createElement("div");return n.style.width="26px",n.style.height="26px",n.style.backgroundColor="#FFFFFF",n.style.borderRadius="50%",n.style.position="absolute",n.style.top="2px",n.style.left=t?"32px":"2px",n.style.transition="all 0.3s",s.appendChild(n),s.addEventListener("click",()=>{const i=!t;t=i,s.style.backgroundColor=i?"#00FF88":"#666666",n.style.left=i?"32px":"2px",e(i)}),i.appendChild(s),i}onStart(t){this.onStartCallback=t}hide(){this.menuElement.style.display="none"}show(){this.menuElement.style.display="flex",this.currentScreen="main",this.renderMainScreen(this.menuElement)}destroy(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.menuElement.parentNode&&this.menuElement.parentNode.removeChild(this.menuElement)}getSettings(){return this.settings}}class R{constructor(t,e){this.currentIndex=0,this.targetIndex=0,this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.velocity=0,this.onSelectCallback=null,this.animationFrameId=null,this.hasDragged=!1,this.container=t,this.options=e,this.setupContainer(),this.setupEventHandlers(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="400px",this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.container.style.cursor="grabbing"}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.scrollOffset=this.dragStartOffset+e,this.velocity=e*R.VELOCITY_MULTIPLIER,Math.abs(e)>5&&(this.hasDragged=!0)}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=-this.scrollOffset/R.ITEM_WIDTH;let i=Math.round(e+this.velocity*R.VELOCITY_FACTOR);i=Math.max(0,Math.min(this.options.length-1,i)),this.targetIndex=i,this.currentIndex=i}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,n=this.currentIndex+Math.round(s/R.ITEM_WIDTH),o=Math.max(0,Math.min(this.options.length-1,n));o===this.currentIndex?this.onSelectCallback&&this.onSelectCallback(this.options[this.currentIndex]):(this.targetIndex=o,this.currentIndex=o)}startAnimation(){const t=()=>{this.update(),this.render(),this.animationFrameId=requestAnimationFrame(t)};t()}update(){const t=-this.currentIndex*R.ITEM_WIDTH-this.scrollOffset;this.scrollOffset+=t*R.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=R.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0}render(){this.container.innerHTML="";const t=this.container.getBoundingClientRect(),e=t.width/2,i=t.height/2;for(let t=0;t<this.options.length;t++){const s=this.options[t],n=t-this.currentIndex,o=Math.abs(n),a=e+this.scrollOffset+t*R.ITEM_WIDTH;let r=1,l=1;0===o?(r=1,l=1):1===o?(r=.75,l=.75):2===o?(r=.5,l=.5):(r=Math.max(.25,1-.25*o),l=Math.max(.25,1-.25*o));const c=R.BASE_SIZE*r,h=document.createElement("div");h.style.position="absolute",h.style.left=a-c/2+"px",h.style.top=i-c/2+"px",h.style.width=`${c}px`,h.style.height=`${c}px`,h.style.backgroundColor=0===o?"#FFD700":"#00AAFF",h.style.border="3px solid rgba(255, 255, 255, 0.5)",h.style.borderRadius="10px",h.style.opacity=l.toString(),h.style.transition="background-color 0.2s",h.style.display="flex",h.style.flexDirection="column",h.style.justifyContent="center",h.style.alignItems="center",h.style.pointerEvents="none",h.style.color="#000000",h.style.fontWeight="bold",h.style.textAlign="center",h.style.padding="10px",h.style.boxSizing="border-box";const d=document.createElement("div");if(d.textContent=s.name,d.style.fontSize=`${Math.max(12,16*r)}px`,d.style.marginBottom="5px",h.appendChild(d),0===o){const t=document.createElement("div");t.textContent=s.description,t.style.fontSize=`${Math.max(8,10*r)}px`,t.style.color="#333333",t.style.overflow="hidden",t.style.textOverflow="ellipsis",h.appendChild(t)}this.container.appendChild(h)}const s=document.createElement("div");s.textContent="Drag to browse • Click center to select",s.style.position="absolute",s.style.bottom="20px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.color="#AAAAAA",s.style.fontSize="14px",s.style.pointerEvents="none",this.container.appendChild(s)}onSelect(t){this.onSelectCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}R.ITEM_WIDTH=200,R.BASE_SIZE=120,R.VELOCITY_MULTIPLIER=.1,R.VELOCITY_FACTOR=.001,R.SMOOTH_INTERPOLATION_FACTOR=.15,R.VELOCITY_DECAY_FACTOR=.9;class L{constructor(){this.game=null,this.lastTime=0,this.isRunning=!1,this.holdStartTime=null,this.holdPosition=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedBase=null,this.isSelecting=!1,this.selectionStartScreen=null;const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element not found");this.renderer=new P(t),this.menu=new I,this.menu.onStart(t=>this.startNewGame(t)),this.setupInputHandlers(t)}startNewGame(t){this.game=this.createGameFromSettings(t),this.game.players.length>0&&(this.renderer.viewingPlayer=this.game.players[0]),this.start()}createGameFromSettings(t){const e=function(t){const e=new E;e.suns.push(new y(new h(0,0),1,100));const i=new h(-700,700),s=new h(700,-700),n=Math.random()<.5?[i,s]:[s,i];for(let i=0;i<t.length&&!(i>=n.length);i++){const[s,o]=t[i],a=new m(s,o),r=n[i],l=[r,r];e.initializePlayer(a,r,l),e.players.push(a)}e.initializeSpaceDust(1e3,2e3,2e3),e.initializeAsteroids(10,2e3,2e3);const a=-Math.PI/4,r=new h(Math.cos(a)*o,Math.sin(a)*o);e.asteroids.push(new p(r,6,120));const l=3*Math.PI/4,c=new h(Math.cos(l)*o,Math.sin(l)*o);return e.asteroids.push(new p(c,6,120)),e.isRunning=!0,e}([["Player 1",c.RADIANT],["Player 2",c.AURUM]]),i=t.selectedMap;e.suns=[],"twin-suns"===i.id?(e.suns.push(new y(new h(-300,-300),1,100)),e.suns.push(new y(new h(300,300),1,100))):e.suns.push(new y(new h(0,0),1,100));const s=e.asteroids.slice(-2);return e.asteroids=[],e.initializeAsteroids(i.numAsteroids,i.mapSize,i.mapSize),"standard"===i.id&&e.asteroids.push(...s),e.spaceDust=[],e.initializeSpaceDust(1e3,i.mapSize,i.mapSize),e}setupInputHandlers(t){let e=!1,i=!1,s=0,n=0,o=0,a=0,r=0;const l=20,c=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window,d=new Set;t.addEventListener("wheel",t=>{t.preventDefault();const e=this.renderer.screenToWorld(t.clientX,t.clientY),i=t.deltaY>0?.9:1.1,s=this.renderer.zoom;this.renderer.setZoom(s*i);const n=this.renderer.screenToWorld(t.clientX,t.clientY),o=this.renderer.camera;this.renderer.setCameraPosition(new h(o.x+(e.x-n.x),o.y+(e.y-n.y)))});const p=(t,e)=>{s=t,n=e,this.selectionStartScreen=new h(t,e),this.isSelecting=!1;const i=this.renderer.screenToWorld(t,e);this.startHold(i)},g=(t,o,a=!1)=>{if(!i)return s=t,void(n=o);const r=t-s,l=o-n,c=Math.sqrt(r*r+l*l);if(a){e||(e=!0,this.cancelHold(),this.renderer.selectionStart=null,this.renderer.selectionEnd=null);const t=this.renderer.camera;this.renderer.setCameraPosition(new h(t.x-r/this.renderer.zoom,t.y-l/this.renderer.zoom))}else c>5&&(this.isSelecting||e||(this.isSelecting=!0,this.cancelHold()),this.isSelecting&&(this.renderer.selectionStart=this.selectionStartScreen,this.renderer.selectionEnd=new h(t,o)));s=t,n=o},x=()=>{const t=this.selectionStartScreen&&Math.abs(s-this.selectionStartScreen.x)<5&&Math.abs(n-this.selectionStartScreen.y)<5;if(t&&this.selectionStartScreen&&this.renderer.createTapEffect(s,n),this.game&&t){const t=this.renderer.screenToWorld(s,n),o=this.game.players[0];if(o.stellarForge&&o.stellarForge.containsPoint(t)){if(o.stellarForge.isSelected)o.stellarForge.isSelected=!1,this.selectedBase=null,console.log("Stellar Forge deselected");else{o.stellarForge.isSelected=!0,this.selectedBase=o.stellarForge,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of o.solarMirrors)t.isSelected=!1;console.log("Stellar Forge selected")}return e=!1,i=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let a=null;for(const e of o.solarMirrors)if(e.containsPoint(t)){a=e;break}if(a){if(a.isSelected)a.isSelected=!1,this.selectedMirrors.delete(a),console.log("Solar Mirror deselected");else{a.isSelected=!0,this.selectedMirrors.clear(),this.selectedMirrors.add(a),o.stellarForge&&(o.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of o.solarMirrors)t!==a&&(t.isSelected=!1);console.log("Solar Mirror selected")}return e=!1,i=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}for(const s of this.game.warpGates){if(!s.isComplete)continue;if(s.owner!==o)continue;const n=20,a=80,r=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(let l=0;l<4;l++){const c=r[l],d=new h(s.position.x+Math.cos(c)*a,s.position.y+Math.sin(c)*a);if(t.distanceTo(d)<=n){if(0===l)if(o.spendSolarium(150)){const t=new f(new h(s.position.x,s.position.y),o);o.buildings.push(t),console.log(`Minigun building queued at warp gate (${s.position.x.toFixed(0)}, ${s.position.y.toFixed(0)})`);const e=this.game.warpGates.indexOf(s);e>-1&&this.game.warpGates.splice(e,1)}else console.log("Not enough solarium to build Minigun");return e=!1,i=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}}if(o.stellarForge&&o.stellarForge.isSelected)return o.stellarForge.setTarget(t),o.stellarForge.isSelected=!1,console.log(`Stellar Forge moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),e=!1,i=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();const r=o.solarMirrors.find(t=>t.isSelected);if(r)return r.setTarget(t),r.isSelected=!1,console.log(`Solar Mirror moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),e=!1,i=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(this.isSelecting&&this.selectionStartScreen&&this.game){const t=new h(s,n);this.selectUnitsInRectangle(this.selectionStartScreen,t)}else if(!this.isSelecting&&(this.selectedUnits.size>0||this.selectedMirrors.size>0||this.selectedBase)&&this.selectionStartScreen&&this.game){const t=new h(s,n);if(this.selectionStartScreen.distanceTo(t)>=5&&this.selectedUnits.size>0){this.renderer.createSwipeEffect(this.selectionStartScreen.x,this.selectionStartScreen.y,t.x,t.y);const e=t.x-this.selectionStartScreen.x,i=t.y-this.selectionStartScreen.y,s=Math.sqrt(e*e+i*i),n=new h(e/s,i/s);let o=!1;for(const t of this.selectedUnits)t.useAbility(n)&&(o=!0);o&&console.log(`Ability activated in direction (${n.x.toFixed(2)}, ${n.y.toFixed(2)})`),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits}else{const t=this.renderer.screenToWorld(s,n);for(const e of this.selectedUnits)e.rallyPoint=new h(t.x,t.y);for(const e of this.selectedMirrors)e.setTarget(new h(t.x,t.y)),e.isSelected=!1;this.selectedBase&&(this.selectedBase.setTarget(new h(t.x,t.y)),this.selectedBase.isSelected=!1),this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,console.log(`Movement target set at (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`)}}e=!1,i=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,this.endHold()};t.addEventListener("mousedown",t=>{i=!0,p(t.clientX,t.clientY)}),t.addEventListener("mousemove",t=>{o=t.clientX,a=t.clientY,g(t.clientX,t.clientY,!1)}),t.addEventListener("mouseup",()=>{x()}),t.addEventListener("mouseleave",()=>{x()}),t.addEventListener("touchstart",t=>{if(1===t.touches.length)t.preventDefault(),i=!0,p(t.touches[0].clientX,t.touches[0].clientY);else if(2===t.touches.length){t.preventDefault(),i=!0,e=!1;const o=t.touches[0],a=t.touches[1];s=(o.clientX+a.clientX)/2,n=(o.clientY+a.clientY)/2;const l=a.clientX-o.clientX,c=a.clientY-o.clientY;r=Math.sqrt(l*l+c*c),this.cancelHold()}},{passive:!1}),t.addEventListener("touchmove",t=>{if(1===t.touches.length&&i){t.preventDefault();const e=t.touches[0];g(e.clientX,e.clientY,!1)}else if(2===t.touches.length){t.preventDefault();const e=t.touches[0],i=t.touches[1],s=(e.clientX+i.clientX)/2,n=(e.clientY+i.clientY)/2,o=i.clientX-e.clientX,a=i.clientY-e.clientY,l=Math.sqrt(o*o+a*a);if(Math.abs(l-r)>1){const t=this.renderer.screenToWorld(s,n),e=l/r,i=this.renderer.zoom;this.renderer.setZoom(i*e);const o=this.renderer.screenToWorld(s,n),a=this.renderer.camera;this.renderer.setCameraPosition(new h(a.x+(t.x-o.x),a.y+(t.y-o.y))),r=l}g(s,n,!0)}},{passive:!1}),t.addEventListener("touchend",t=>{if(0===t.touches.length)x(),r=0;else if(1===t.touches.length){const i=t.touches[0];s=i.clientX,n=i.clientY,e=!1,r=0}}),t.addEventListener("touchcancel",()=>{x(),r=0}),window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(e)&&(t.preventDefault(),d.add(e))}),window.addEventListener("keyup",t=>{const e=t.key.toLowerCase();d.delete(e)});const u=()=>{const s=d.size>0,n=!c&&!i&&!e&&(o<l||o>t.width-l||a<l||a>t.height-l);if(s||n){const e=this.renderer.camera;let i=0,s=0;(d.has("w")||d.has("arrowup"))&&(s-=10),(d.has("s")||d.has("arrowdown"))&&(s+=10),(d.has("a")||d.has("arrowleft"))&&(i-=10),(d.has("d")||d.has("arrowright"))&&(i+=10),n&&(o<l&&(i-=5),o>t.width-l&&(i+=5),a<l&&(s-=5),a>t.height-l&&(s+=5)),0===i&&0===s||this.renderer.setCameraPosition(new h(e.x+i/this.renderer.zoom,e.y+s/this.renderer.zoom))}requestAnimationFrame(u)};u()}startHold(e){if(!this.game)return;const i=this.game.players[0];if(i.stellarForge)if(this.selectedMirrors.size>0){let t=!1;for(const i of this.selectedMirrors){if(!i.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const s=new d(i.position,new h(e.x-i.position.x,e.y-i.position.y).normalize(),1);let n=!0;for(const t of this.game.asteroids)if(s.intersectsPolygon(t.getWorldVertices())){n=!1;break}if(n){t=!0;break}}t&&(this.holdStartTime=Date.now(),this.holdPosition=e,this.isUsingMirrorsForWarpGate=!0,console.log("Starting mirror-based warp gate at",e))}else e.distanceTo(i.stellarForge.position)<t&&(this.holdStartTime=Date.now(),this.holdPosition=e,this.isUsingMirrorsForWarpGate=!1)}selectUnitsInRectangle(t,e){if(!this.game)return;const i=this.renderer.screenToWorld(t.x,t.y),s=this.renderer.screenToWorld(e.x,e.y),n=Math.min(i.x,s.x),o=Math.max(i.x,s.x),a=Math.min(i.y,s.y),r=Math.max(i.y,s.y);this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null;const l=this.game.players[0];if(l&&!l.isDefeated()){for(const t of l.units)t.position.x>=n&&t.position.x<=o&&t.position.y>=a&&t.position.y<=r&&this.selectedUnits.add(t);for(const t of l.solarMirrors)t.position.x>=n&&t.position.x<=o&&t.position.y>=a&&t.position.y<=r?(this.selectedMirrors.add(t),t.isSelected=!0):t.isSelected=!1;l.stellarForge&&l.stellarForge.position.x>=n&&l.stellarForge.position.x<=o&&l.stellarForge.position.y>=a&&l.stellarForge.position.y<=r&&0===this.selectedUnits.size?(this.selectedBase=l.stellarForge,l.stellarForge.isSelected=!0):l.stellarForge&&(l.stellarForge.isSelected=!1),this.renderer.selectedUnits=this.selectedUnits,console.log(`Selected ${this.selectedUnits.size} units, ${this.selectedMirrors.size} mirrors, ${this.selectedBase?"1 base":"0 bases"}`)}}cancelHold(){if(this.game){if(this.currentWarpGate){this.currentWarpGate.cancel(),this.scatterParticles(this.currentWarpGate.position);const t=this.game.warpGates.indexOf(this.currentWarpGate);t>-1&&this.game.warpGates.splice(t,1)}this.holdStartTime=null,this.holdPosition=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1}}endHold(){this.holdStartTime=null,this.holdPosition=null,this.isUsingMirrorsForWarpGate=!1}scatterParticles(t){if(this.game)for(const e of this.game.spaceDust)if(e.position.distanceTo(t)<150){const i=new h(e.position.x-t.x,e.position.y-t.y).normalize();e.applyForce(new h(200*i.x,200*i.y))}}update(t){if(this.game){if(this.game.isRunning&&this.game.update(t),this.holdStartTime&&this.holdPosition&&(Date.now()-this.holdStartTime)/1e3>=1&&!this.currentWarpGate){const t=this.game.players[0];this.currentWarpGate=new A(this.holdPosition,t),this.currentWarpGate.startCharging(),this.game.warpGates.push(this.currentWarpGate)}if(this.currentWarpGate){const e=null!==this.holdStartTime&&null!==this.holdPosition;let i=1;if(this.isUsingMirrorsForWarpGate&&e){this.game.players[0];let t=0;for(const e of this.selectedMirrors){if(!e.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const i=new d(e.position,new h(this.currentWarpGate.position.x-e.position.x,this.currentWarpGate.position.y-e.position.y).normalize(),1);let s=!0;for(const t of this.game.asteroids)if(i.intersectsPolygon(t.getWorldVertices())){s=!1;break}if(s){const i=this.game.suns.reduce((t,i)=>e.position.distanceTo(i.position)<(t?e.position.distanceTo(t.position):1/0)?i:t,null);if(i){const s=e.position.distanceTo(i.position);t+=Math.max(1,2*(1-Math.min(1,s/r)))}}}i=.5+.5*t}this.currentWarpGate.update(t,e,i)}}}render(){this.game&&this.renderer.render(this.game)}gameLoop(t){if(!this.isRunning)return;const e=0===this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,this.update(Math.min(e,.1)),this.render(),requestAnimationFrame(t=>this.gameLoop(t))}start(){this.game&&(this.isRunning=!0,this.lastTime=0,requestAnimationFrame(t=>this.gameLoop(t)))}stop(){this.isRunning=!1}}document.addEventListener("DOMContentLoaded",()=>{new L})})();