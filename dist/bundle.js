(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})}};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),t.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var e={};t.r(e),t.d(e,{ABILITY_ARROW_MIN_LENGTH:()=>Yn,ABILITY_BULLET_EFFECT_RADIUS:()=>P,ABILITY_BULLET_FORCE_MULTIPLIER:()=>C,AIStrategy:()=>ja,AI_AGGRESSIVE_HERO_MULTIPLIER:()=>zs,AI_DEFENSE_COMMAND_INTERVAL_SEC:()=>Us,AI_DEFENSE_RADIUS_PX:()=>Js,AI_ECONOMIC_HERO_MULTIPLIER:()=>js,AI_HERO_COMMAND_INTERVAL_SEC:()=>Gs,AI_MAX_MIRRORS:()=>$s,AI_MIRROR_ARC_SPACING_RAD:()=>Xs,AI_MIRROR_COMMAND_INTERVAL_SEC:()=>Bs,AI_MIRROR_PURCHASE_INTERVAL_SEC:()=>Ws,AI_MIRROR_REPOSITION_THRESHOLD_PX:()=>qs,AI_MIRROR_SUN_DISTANCE_PX:()=>Ys,AI_STRUCTURE_COMMAND_INTERVAL_SEC:()=>Hs,AI_STRUCTURE_PLACEMENT_ANGLE_STEP_RAD:()=>Zs,AI_STRUCTURE_PLACEMENT_DISTANCE_PX:()=>Qs,AI_WAVES_ATTACK_THRESHOLD:()=>Vs,AI_WAVES_HERO_MULTIPLIER:()=>Ks,ASTEROID_MAX_SIZE:()=>Kt,ASTEROID_MIN_SIZE:()=>jt,BEAM_ABILITY_BASE_DAMAGE:()=>ir,BEAM_ABILITY_COOLDOWN:()=>er,BEAM_ABILITY_DAMAGE_PER_DISTANCE:()=>nr,BEAM_ABILITY_MAX_RANGE:()=>sr,BEAM_ALONG_COMPONENT:()=>G,BEAM_ATTACK_DAMAGE:()=>Zo,BEAM_ATTACK_RANGE:()=>Qo,BEAM_ATTACK_SPEED:()=>tr,BEAM_EFFECT_RADIUS:()=>O,BEAM_FORCE_STRENGTH:()=>N,BEAM_MAX_HEALTH:()=>Jo,BEAM_PERPENDICULAR_COMPONENT:()=>H,BORDER_FADE_WIDTH:()=>Xt,BOUNCING_BULLET_LIFETIME:()=>dn,BOUNCING_BULLET_SPEED_MAX:()=>pn,BOUNCING_BULLET_SPEED_MIN:()=>un,BUILDING_BUILD_TIME:()=>rn,BULLET_CASING_LIFETIME:()=>ln,BULLET_CASING_SPEED_MAX:()=>cn,BULLET_CASING_SPEED_MIN:()=>hn,CASING_COLLISION_DAMPING:()=>fn,CASING_SPACEDUST_COLLISION_DISTANCE:()=>gn,CASING_SPACEDUST_FORCE:()=>yn,CLICK_DRAG_THRESHOLD:()=>Vn,COUNTDOWN_DURATION:()=>Jt,DAGGER_ABILITY_COOLDOWN:()=>jo,DAGGER_ABILITY_DAMAGE:()=>Yo,DAGGER_ABILITY_RANGE:()=>Ko,DAGGER_ATTACK_DAMAGE:()=>Vo,DAGGER_ATTACK_RANGE:()=>$o,DAGGER_ATTACK_SPEED:()=>zo,DAGGER_CLOAK_OPACITY:()=>qo,DAGGER_MAX_HEALTH:()=>Wo,DAGGER_VISIBILITY_DURATION:()=>Xo,DEFAULT_PROJECTILE_DAMAGE:()=>M,DEPLOYED_TURRET_ANIMATION_DURATION:()=>Io,DEPLOYED_TURRET_ANIMATION_FRAME_COUNT:()=>Mo,DEPLOYED_TURRET_ATTACK_DAMAGE:()=>vo,DEPLOYED_TURRET_ATTACK_RANGE:()=>bo,DEPLOYED_TURRET_ATTACK_SPEED:()=>Po,DEPLOYED_TURRET_HEALTH_BAR_SIZE:()=>Lo,DEPLOYED_TURRET_MAX_HEALTH:()=>Eo,DEPLOYED_TURRET_SPRITE_SCALE:()=>Ro,DRILLER_ABILITY_COOLDOWN:()=>No,DRILLER_ATTACK_DAMAGE:()=>Do,DRILLER_ATTACK_RANGE:()=>ko,DRILLER_ATTACK_SPEED:()=>Oo,DRILLER_BUILDING_DAMAGE_MULTIPLIER:()=>Go,DRILLER_DECELERATION:()=>Ho,DRILLER_DRILL_DAMAGE:()=>Uo,DRILLER_DRILL_SPEED:()=>Bo,DRILLER_MAX_HEALTH:()=>Fo,DUST_CLUSTER_COUNT:()=>J,DUST_CLUSTER_RADIUS_PX:()=>Q,DUST_CLUSTER_SPAWN_RATIO:()=>Z,DUST_COLOR_FADE_IN_SPEED:()=>lt,DUST_COLOR_FADE_OUT_SPEED:()=>ht,DUST_COLOR_FORCE_SCALE:()=>ct,DUST_COLOR_IMPACT_HOLD_SEC:()=>at,DUST_FADE_TO_NORMAL_DELAY_MS:()=>Ft,DUST_FADE_TO_SLIGHT_DELAY_MS:()=>kt,DUST_FAST_MOVEMENT_THRESHOLD:()=>Mt,DUST_GLOW_STATE_FULL:()=>Rt,DUST_GLOW_STATE_NORMAL:()=>Ct,DUST_GLOW_STATE_SLIGHT:()=>It,DUST_GLOW_TRANSITION_SPEED_DOWN:()=>Ot,DUST_GLOW_TRANSITION_SPEED_UP:()=>Dt,DUST_MIN_VELOCITY:()=>K,DUST_PARTICLE_DIAMETER_PX:()=>z,DUST_PARTICLE_SIZE:()=>V,DUST_PUSH_MIN_EFFECTIVE_SPEED_PX_PER_SEC:()=>tt,DUST_REPULSION_CELL_SIZE_PX:()=>X,DUST_REPULSION_RADIUS_PX:()=>Y,DUST_REPULSION_STRENGTH:()=>q,DUST_SHADOW_LENGTH_PX:()=>ut,DUST_SHADOW_MAX_DISTANCE_PX:()=>dt,DUST_SHADOW_OPACITY:()=>pt,DUST_SHADOW_WIDTH_PX:()=>gt,DUST_SLOW_MOVEMENT_THRESHOLD:()=>Lt,DUST_SPRITE_SCALE_FACTOR:()=>wt,DUST_TRAIL_LENGTH_PER_SPEED:()=>xt,DUST_TRAIL_MAX_LENGTH_PX:()=>mt,DUST_TRAIL_MIN_LENGTH_PX:()=>ft,DUST_TRAIL_MIN_SPEED_PX_PER_SEC:()=>yt,DUST_TRAIL_WIDTH_PX:()=>St,FLUID_FORWARD_COMPONENT:()=>B,FLUID_MIN_DISTANCE:()=>W,FLUID_RADIAL_COMPONENT:()=>U,FORGE_CRUNCH_INTERVAL:()=>ri,FORGE_CRUNCH_SUCK_DURATION:()=>ai,FORGE_CRUNCH_SUCK_FORCE:()=>di,FORGE_CRUNCH_SUCK_RADIUS:()=>hi,FORGE_CRUNCH_WAVE_DURATION:()=>li,FORGE_CRUNCH_WAVE_FORCE:()=>ui,FORGE_CRUNCH_WAVE_RADIUS:()=>ci,FORGE_DUST_PUSH_FORCE_MULTIPLIER:()=>nt,FORGE_DUST_PUSH_RADIUS_PX:()=>st,FORGE_FLAME_ALPHA:()=>Ze,FORGE_FLAME_OFFSET_MULTIPLIER:()=>si,FORGE_FLAME_ROTATION_SPEED_RAD_PER_SEC:()=>ei,FORGE_FLAME_SIZE_MULTIPLIER:()=>ti,FORGE_FLAME_WARMTH_FADE_PER_SEC:()=>ii,FORGE_UPGRADE_BUTTON_DISTANCE_PX:()=>on,FORGE_UPGRADE_BUTTON_RADIUS_PX:()=>nn,FOUNDRY_ATTACK_UPGRADE_COST:()=>bs,FOUNDRY_ATTACK_UPGRADE_ITEM:()=>Cs,FOUNDRY_BLINK_UPGRADE_COST:()=>Rs,FOUNDRY_BLINK_UPGRADE_ITEM:()=>Ms,FOUNDRY_REGEN_UPGRADE_COST:()=>Es,FOUNDRY_REGEN_UPGRADE_ITEM:()=>Ps,FOUNDRY_STRAFE_UPGRADE_COST:()=>ws,FOUNDRY_STRAFE_UPGRADE_ITEM:()=>vs,GATLING_ATTACK_DAMAGE:()=>wi,GATLING_ATTACK_RANGE:()=>_i,GATLING_ATTACK_SPEED:()=>Ei,GATLING_COST:()=>ys,GATLING_MAX_HEALTH:()=>Ti,GATLING_RADIUS:()=>bi,GRAVE_ATTACK_DAMAGE:()=>le,GRAVE_ATTACK_RANGE:()=>re,GRAVE_ATTACK_SPEED:()=>he,GRAVE_BLACK_HOLE_DURATION:()=>Pe,GRAVE_BLACK_HOLE_SIZE:()=>Ce,GRAVE_BLACK_HOLE_SPEED:()=>Ie,GRAVE_HERO_ATTACK_RANGE_MULTIPLIER:()=>ae,GRAVE_MAX_HEALTH:()=>oe,GRAVE_MAX_SMALL_PARTICLES:()=>me,GRAVE_NUM_PROJECTILES:()=>ce,GRAVE_PROJECTILE_ATTRACTION_FORCE:()=>pe,GRAVE_PROJECTILE_EFFECT_RADIUS:()=>L,GRAVE_PROJECTILE_FORCE_MULTIPLIER:()=>F,GRAVE_PROJECTILE_HIT_DISTANCE:()=>fe,GRAVE_PROJECTILE_LAUNCH_SPEED:()=>ge,GRAVE_PROJECTILE_MIN_SPEED:()=>ue,GRAVE_PROJECTILE_ORBIT_RADIUS:()=>de,GRAVE_PROJECTILE_TRAIL_LENGTH:()=>ye,GRAVE_SMALL_PARTICLES_PER_ATTACK:()=>Se,GRAVE_SMALL_PARTICLE_ATTRACTION_FORCE:()=>be,GRAVE_SMALL_PARTICLE_DAMAGE:()=>_e,GRAVE_SMALL_PARTICLE_DRAG:()=>ve,GRAVE_SMALL_PARTICLE_REGEN_RATE:()=>xe,GRAVE_SMALL_PARTICLE_SIZE:()=>Te,GRAVE_SMALL_PARTICLE_SPEED:()=>Ae,GRAVE_SMALL_PARTICLE_SPLASH_FALLOFF:()=>Ee,GRAVE_SMALL_PARTICLE_SPLASH_RADIUS:()=>we,HERO_ATTACK_RANGE_ALPHA:()=>jn,HERO_BUTTON_DISTANCE_PX:()=>sn,HERO_BUTTON_RADIUS_PX:()=>en,HERO_PRODUCTION_TIME_SEC:()=>tn,HERO_UNIT_COST:()=>Ts,INFLUENCE_BALL_ABILITY_COOLDOWN:()=>yo,INFLUENCE_BALL_ATTACK_DAMAGE:()=>po,INFLUENCE_BALL_ATTACK_RANGE:()=>uo,INFLUENCE_BALL_ATTACK_SPEED:()=>go,INFLUENCE_BALL_DURATION:()=>xo,INFLUENCE_BALL_EFFECT_RADIUS:()=>k,INFLUENCE_BALL_EXPLOSION_RADIUS:()=>mo,INFLUENCE_BALL_FORCE_MULTIPLIER:()=>D,INFLUENCE_BALL_MAX_HEALTH:()=>co,INFLUENCE_BALL_PROJECTILE_SPEED:()=>fo,INFLUENCE_RADIUS:()=>o,LAD_SUN_OUTLINE_COLOR:()=>l,LOCKON_TOWER_ATTACK_DAMAGE:()=>ts,LOCKON_TOWER_ATTACK_RANGE:()=>Zi,LOCKON_TOWER_ATTACK_SPEED:()=>es,LOCKON_TOWER_COST:()=>Ss,LOCKON_TOWER_LASER_WIDTH_PX:()=>ns,LOCKON_TOWER_LOCKON_TIME:()=>ss,LOCKON_TOWER_MAX_HEALTH:()=>Qi,LOCKON_TOWER_RADIUS:()=>is,MAP_PLAYABLE_BOUNDARY:()=>qt,MAP_SIZE:()=>Yt,MARINE_ABILITY_BULLET_COUNT:()=>Bn,MARINE_ABILITY_BULLET_DAMAGE:()=>Wn,MARINE_ABILITY_BULLET_LIFETIME:()=>Gn,MARINE_ABILITY_BULLET_SPEED:()=>Un,MARINE_ABILITY_COOLDOWN:()=>Nn,MARINE_ABILITY_SPREAD_ANGLE:()=>Hn,MARINE_ATTACK_DAMAGE:()=>se,MARINE_ATTACK_RANGE:()=>ie,MARINE_ATTACK_SPEED:()=>ne,MARINE_MAX_HEALTH:()=>ee,MAX_RAY_DISTANCE:()=>Gt,MINIGUN_ATTACK_DAMAGE:()=>mi,MINIGUN_ATTACK_RANGE:()=>fi,MINIGUN_ATTACK_SPEED:()=>xi,MINIGUN_COST:()=>gs,MINIGUN_LASER_WIDTH_PX:()=>Si,MINIGUN_MAX_HEALTH:()=>yi,MINIGUN_RADIUS:()=>Ai,MINION_PROJECTILE_EFFECT_RADIUS:()=>I,MINION_PROJECTILE_FORCE_MULTIPLIER:()=>R,MIN_WAYPOINT_DISTANCE:()=>Rn,MIRROR_ACTIVE_GLOW_RADIUS:()=>Fn,MIRROR_CLICK_RADIUS_PX:()=>kn,MIRROR_COUNTDOWN_DEPLOY_DISTANCE:()=>Qt,MIRROR_DUST_PUSH_FORCE_MULTIPLIER:()=>it,MIRROR_DUST_PUSH_RADIUS_PX:()=>et,MIRROR_MAX_GLOW_DISTANCE:()=>Dn,MIRROR_MAX_HEALTH:()=>Zt,MIRROR_PROXIMITY_MULTIPLIER:()=>On,MIRROR_REGEN_PER_SEC:()=>te,MIRROR_WARP_GATE_HOLD_DURATION_MS:()=>u,MORTAR_ABILITY_COOLDOWN:()=>br,MORTAR_ATTACK_DAMAGE:()=>wr,MORTAR_ATTACK_RANGE:()=>_r,MORTAR_ATTACK_SPEED:()=>Er,MORTAR_DETECTION_CONE_ANGLE:()=>vr,MORTAR_MAX_HEALTH:()=>Tr,MORTAR_PROJECTILE_SPEED:()=>Ir,MORTAR_SPLASH_DAMAGE_FALLOFF:()=>Cr,MORTAR_SPLASH_RADIUS:()=>Pr,MOVEMENT_POINT_ANIMATION_FPS:()=>Pt,MOVEMENT_POINT_ANIMATION_FRAME_COUNT:()=>vt,MUZZLE_FLASH_DURATION:()=>an,NOVA_ABILITY_COOLDOWN:()=>ha,NOVA_ATTACK_DAMAGE:()=>aa,NOVA_ATTACK_RANGE:()=>ra,NOVA_ATTACK_SPEED:()=>la,NOVA_BOMB_ARMING_TIME:()=>pa,NOVA_BOMB_BOUNCE_DAMPING:()=>ga,NOVA_BOMB_DECELERATION:()=>da,NOVA_BOMB_EXPLOSION_DAMAGE:()=>fa,NOVA_BOMB_EXPLOSION_RADIUS:()=>ma,NOVA_BOMB_INITIAL_SPEED:()=>ca,NOVA_BOMB_MAX_BOUNCES:()=>ya,NOVA_BOMB_MIN_SPEED:()=>ua,NOVA_BOMB_RADIUS:()=>wa,NOVA_BOMB_SCATTER_ARC:()=>xa,NOVA_BOMB_SCATTER_BULLET_COUNT:()=>Sa,NOVA_BOMB_SCATTER_BULLET_DAMAGE:()=>Ta,NOVA_BOMB_SCATTER_BULLET_LIFETIME:()=>_a,NOVA_BOMB_SCATTER_BULLET_SPEED:()=>Aa,NOVA_MAX_HEALTH:()=>oa,PARTICLE_SCATTER_FORCE:()=>v,PARTICLE_SCATTER_RADIUS:()=>b,PATH_WAYPOINT_ARRIVAL_MULTIPLIER:()=>In,PLAYER_1_COLOR:()=>r,PLAYER_2_COLOR:()=>a,PREIST_ABILITY_COOLDOWN:()=>kr,PREIST_ATTACK_DAMAGE:()=>Lr,PREIST_ATTACK_RANGE:()=>Mr,PREIST_ATTACK_SPEED:()=>Fr,PREIST_HEALING_BOMB_EXPLOSION_RADIUS:()=>$r,PREIST_HEALING_BOMB_MAX_RANGE:()=>Gr,PREIST_HEALING_BOMB_PARTICLE_COUNT:()=>Hr,PREIST_HEALING_BOMB_PARTICLE_HEALING:()=>Wr,PREIST_HEALING_BOMB_PARTICLE_LIFETIME:()=>zr,PREIST_HEALING_BOMB_PARTICLE_SPEED:()=>Vr,PREIST_HEALING_BOMB_SPEED:()=>Ur,PREIST_HEALING_PER_SECOND:()=>Or,PREIST_HEALING_RANGE:()=>Dr,PREIST_MAX_HEALTH:()=>Rr,PREIST_NUM_BEAMS:()=>Br,PREIST_TARGET_LOCK_DURATION:()=>Nr,PRODUCTION_BUTTON_WAVE_MAX_RADIUS_PX:()=>Zn,PRODUCTION_BUTTON_WAVE_PROGRESS_PER_FRAME:()=>to,RAYTRACING_NUM_RAYS:()=>Ut,RAY_ABILITY_COOLDOWN:()=>ro,RAY_ATTACK_DAMAGE:()=>no,RAY_ATTACK_RANGE:()=>so,RAY_ATTACK_SPEED:()=>oo,RAY_BEAM_DAMAGE:()=>ao,RAY_BEAM_MAX_BOUNCES:()=>lo,RAY_BEAM_WIDTH:()=>ho,RAY_MAX_HEALTH:()=>io,SCREEN_SHAKE_DECAY:()=>_t,SCREEN_SHAKE_DURATION:()=>At,SCREEN_SHAKE_INTENSITY:()=>Tt,SHADE_OPACITY:()=>$t,SHADOW_LENGTH:()=>Ht,SHIELD_CENTER_COLLISION_THRESHOLD:()=>$,SHIELD_HEALTH_BAR_VERTICAL_OFFSET:()=>Xn,SHIELD_TOWER_ATTACK_DAMAGE:()=>as,SHIELD_TOWER_ATTACK_RANGE:()=>rs,SHIELD_TOWER_ATTACK_SPEED:()=>ls,SHIELD_TOWER_COST:()=>As,SHIELD_TOWER_MAX_HEALTH:()=>os,SHIELD_TOWER_RADIUS:()=>hs,SHIELD_TOWER_REGENERATION_TIME:()=>us,SHIELD_TOWER_SHIELD_HEALTH:()=>ds,SHIELD_TOWER_SHIELD_RADIUS:()=>cs,SLY_ABILITY_COOLDOWN:()=>Ca,SLY_ATTACK_DAMAGE:()=>va,SLY_ATTACK_RANGE:()=>ba,SLY_ATTACK_SPEED:()=>Pa,SLY_MAX_HEALTH:()=>Ea,SMALL_SELECTION_THRESHOLD:()=>zn,SOLAR_MIRROR_COST:()=>_s,SOLAR_MIRROR_FROM_FOUNDRY_COST:()=>Is,SOL_ICON_TEXT_SPACING:()=>Kn,SPACE_DUST_PARTICLE_COUNT:()=>j,SPOTLIGHT_ABILITY_COOLDOWN:()=>hr,SPOTLIGHT_ACTIVE_TIME_SEC:()=>dr,SPOTLIGHT_ATTACK_DAMAGE:()=>ar,SPOTLIGHT_ATTACK_RANGE:()=>rr,SPOTLIGHT_ATTACK_SPEED:()=>lr,SPOTLIGHT_BULLET_DAMAGE:()=>fr,SPOTLIGHT_BULLET_HIT_RADIUS_PX:()=>Ar,SPOTLIGHT_BULLET_LENGTH_PX:()=>Sr,SPOTLIGHT_BULLET_LIFETIME_SEC:()=>mr,SPOTLIGHT_BULLET_SPEED:()=>yr,SPOTLIGHT_BULLET_WIDTH_PX:()=>xr,SPOTLIGHT_CONE_ANGLE_RAD:()=>pr,SPOTLIGHT_FIRE_RATE_PER_SEC:()=>gr,SPOTLIGHT_MAX_HEALTH:()=>or,SPOTLIGHT_SETUP_TIME_SEC:()=>cr,SPOTLIGHT_TEARDOWN_TIME_SEC:()=>ur,STARLING_ATTACK_DAMAGE:()=>Le,STARLING_ATTACK_RANGE:()=>Me,STARLING_ATTACK_SPEED:()=>ke,STARLING_ATTACK_UPGRADE_BONUS:()=>Fe,STARLING_BLINK_COOLDOWN_SEC:()=>Xe,STARLING_BLINK_DISTANCE_PX:()=>Ye,STARLING_COLLISION_RADIUS_PX:()=>We,STARLING_COST_PER_ENERGY:()=>pi,STARLING_DUST_PUSH_FORCE_MULTIPLIER:()=>rt,STARLING_DUST_PUSH_RADIUS_PX:()=>ot,STARLING_EXPLORATION_CHANGE_INTERVAL:()=>Be,STARLING_GROUP_STOP_BASE_RADIUS_PX:()=>qe,STARLING_GROUP_STOP_SPACING_PX:()=>Je,STARLING_LASER_IMPACT_PARTICLES:()=>$e,STARLING_LASER_PARTICLE_LIFETIME:()=>ze,STARLING_LASER_PARTICLE_SPEED:()=>Ve,STARLING_LASER_WIDTH_PX:()=>je,STARLING_MAX_COUNT:()=>Qe,STARLING_MAX_HEALTH:()=>Re,STARLING_MERGE_COUNT:()=>Ls,STARLING_MERGE_DURATION_SEC:()=>Fs,STARLING_MERGE_GATE_MAX_HEALTH:()=>Ds,STARLING_MERGE_GATE_RADIUS_PX:()=>ks,STARLING_MERGE_HOLD_DURATION_MS:()=>Os,STARLING_MERGE_HOLD_RADIUS_PX:()=>Ns,STARLING_MOVE_ACCELERATION_PX_PER_SEC:()=>Oe,STARLING_MOVE_SPEED:()=>De,STARLING_PROJECTILE_HIT_RADIUS_PX:()=>He,STARLING_PROJECTILE_MAX_RANGE_PX:()=>Ge,STARLING_PROJECTILE_SPEED:()=>Ue,STARLING_REGEN_RATE_PER_SEC:()=>Ke,STARLING_SACRIFICE_ENERGY_MULTIPLIER:()=>gi,STARLING_SPAWN_INTERVAL:()=>Ne,STARLING_SPRITE_ROTATION_OFFSET_RAD:()=>bt,STARLING_SPRITE_SCALE_FACTOR:()=>Et,STAR_LAYER_CONFIGS:()=>Bt,STAR_WRAP_SIZE:()=>Nt,STATE_HASH_TICK_INTERVAL:()=>Ln,STELLAR_FORGE_MAX_HEALTH:()=>ni,STELLAR_FORGE_STARLING_DEFENSE:()=>oi,STICKY_BOMB_ARM_TIME:()=>Fa,STICKY_BOMB_DECELERATION:()=>Ra,STICKY_BOMB_DIAGONAL_LASER_DAMAGE:()=>Ha,STICKY_BOMB_DIAGONAL_LASER_WIDTH:()=>Wa,STICKY_BOMB_DISINTEGRATE_PARTICLE_COUNT:()=>Oa,STICKY_BOMB_DISINTEGRATE_PARTICLE_LIFETIME:()=>Ba,STICKY_BOMB_DISINTEGRATE_PARTICLE_SPEED:()=>Na,STICKY_BOMB_INITIAL_SPEED:()=>Ia,STICKY_BOMB_LASER_ANGLE:()=>$a,STICKY_BOMB_LASER_DURATION:()=>za,STICKY_BOMB_LASER_RANGE:()=>Va,STICKY_BOMB_MAX_LIFETIME:()=>ka,STICKY_BOMB_MIN_SPEED:()=>Ma,STICKY_BOMB_RADIUS:()=>Da,STICKY_BOMB_STICK_DISTANCE:()=>La,STICKY_BOMB_WIDE_LASER_DAMAGE:()=>Ua,STICKY_BOMB_WIDE_LASER_WIDTH:()=>Ga,STRATEGIC_ASTEROID_DISTANCE:()=>zt,STRATEGIC_ASTEROID_SIZE:()=>Vt,STRIKER_TOWER_ATTACK_DAMAGE:()=>Ki,STRIKER_TOWER_ATTACK_RANGE:()=>ji,STRIKER_TOWER_ATTACK_SPEED:()=>Yi,STRIKER_TOWER_COST:()=>xs,STRIKER_TOWER_EXPLOSION_RADIUS:()=>Ji,STRIKER_TOWER_MAX_HEALTH:()=>zi,STRIKER_TOWER_RADIUS:()=>Xi,STRIKER_TOWER_RELOAD_TIME:()=>qi,SUBSIDIARY_FACTORY_ATTACK_DAMAGE:()=>Hi,SUBSIDIARY_FACTORY_ATTACK_RANGE:()=>Gi,SUBSIDIARY_FACTORY_ATTACK_SPEED:()=>Wi,SUBSIDIARY_FACTORY_COST:()=>ms,SUBSIDIARY_FACTORY_MAX_HEALTH:()=>Ui,SUBSIDIARY_FACTORY_PRODUCTION_INTERVAL:()=>Vi,SUBSIDIARY_FACTORY_RADIUS:()=>$i,SWIPE_ARROW_SIZE:()=>eo,SWIPE_EFFECT_SPEED:()=>Qn,SWIRLER_ATTACK_DAMAGE:()=>Ci,SWIRLER_ATTACK_RANGE:()=>Pi,SWIRLER_ATTACK_SPEED:()=>Ii,SWIRLER_COST:()=>fs,SWIRLER_DUST_ORBIT_SPEED_BASE:()=>Ni,SWIRLER_DUST_SPEED_MULTIPLIER:()=>Bi,SWIRLER_GROWTH_RATE_PER_SEC:()=>Fi,SWIRLER_INFLUENCE_RADIUS:()=>Mi,SWIRLER_INITIAL_RADIUS_MULTIPLIER:()=>Li,SWIRLER_MAX_HEALTH:()=>vi,SWIRLER_MIN_INFLUENCE_RADIUS:()=>Oi,SWIRLER_RADIUS:()=>Ri,SWIRLER_SHRINK_BASE_RATE:()=>ki,SWIRLER_SHRINK_DAMAGE_MULTIPLIER:()=>Di,TANK_ABILITY_COOLDOWN:()=>Jr,TANK_ATTACK_DAMAGE:()=>Yr,TANK_ATTACK_RANGE:()=>Kr,TANK_ATTACK_SPEED:()=>Xr,TANK_COLLISION_RADIUS_PX:()=>na,TANK_DEFENSE:()=>qr,TANK_MAX_HEALTH:()=>jr,TANK_SHIELD_RADIUS:()=>Qr,TANK_STUN_DURATION:()=>sa,TANK_WAVE_ANGLE:()=>Zr,TANK_WAVE_RANGE:()=>ta,TANK_WAVE_SPEED:()=>ea,TANK_WAVE_WIDTH:()=>ia,TAP_EFFECT_MAX_RADIUS:()=>Jn,TAP_EFFECT_SPEED:()=>qn,TURRET_DEPLOYER_ABILITY_COOLDOWN:()=>wo,TURRET_DEPLOYER_ATTACK_DAMAGE:()=>To,TURRET_DEPLOYER_ATTACK_RANGE:()=>Ao,TURRET_DEPLOYER_ATTACK_SPEED:()=>_o,TURRET_DEPLOYER_MAX_HEALTH:()=>So,TURRET_PROJECTILE_SPEED:()=>Co,UI_BACKGROUND_COLOR:()=>$n,UNIT_ARRIVAL_THRESHOLD:()=>Sn,UNIT_ASTEROID_AVOIDANCE_BUFFER_PX:()=>En,UNIT_ASTEROID_AVOIDANCE_LOOKAHEAD_PX:()=>wn,UNIT_ASTEROID_AVOIDANCE_STRENGTH:()=>bn,UNIT_AVOIDANCE_RANGE_PX:()=>Tn,UNIT_AVOIDANCE_STRENGTH:()=>_n,UNIT_HERO_AVOIDANCE_MULTIPLIER:()=>vn,UNIT_MINION_YIELD_MULTIPLIER:()=>Pn,UNIT_MOVE_SPEED:()=>mn,UNIT_PATH_DRAW_RADIUS:()=>Mn,UNIT_RADIUS_PX:()=>An,UNIT_STRUCTURE_STANDOFF_PX:()=>Cn,UNIT_TURN_SPEED_RAD_PER_SEC:()=>xn,UNIT_VISIBILITY_RADIUS:()=>ps,VISIBILITY_PROXIMITY_RANGE:()=>Wt,WARP_GATE_BUTTON_HIT_RADIUS_PX:()=>A,WARP_GATE_BUTTON_OFFSET:()=>S,WARP_GATE_BUTTON_RADIUS:()=>x,WARP_GATE_CANCEL_DECAY_ENERGY_PER_SEC:()=>w,WARP_GATE_CHARGE_TIME:()=>h,WARP_GATE_COMPLETION_WINDOW_SEC:()=>E,WARP_GATE_ENERGY_REQUIRED:()=>c,WARP_GATE_INITIAL_DELAY:()=>d,WARP_GATE_RADIUS:()=>m,WARP_GATE_SHOCKWAVE_MAX_RADIUS_PX:()=>T,WARP_GATE_SHOCKWAVE_PROGRESS_PER_FRAME:()=>_,WARP_GATE_SPIRAL_FORCE_RADIAL:()=>y,WARP_GATE_SPIRAL_FORCE_TANGENT:()=>f,WARP_GATE_SPIRAL_MIN_DISTANCE:()=>g,WARP_GATE_SPIRAL_RADIUS:()=>p});class i{constructor(t,e){this.x=t,this.y=e}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}normalize(){const t=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return 0===t?new i(0,0):new i(this.x/t,this.y/t)}}class s{constructor(t,e,i=1){this.origin=t,this.direction=e,this.intensity=i}intersects(t,e){const s=new i(this.origin.x-t.x,this.origin.y-t.y),n=this.direction.x*this.direction.x+this.direction.y*this.direction.y,o=2*(s.x*this.direction.x+s.y*this.direction.y);return o*o-4*n*(s.x*s.x+s.y*s.y-e*e)>=0}intersectsPolygon(t){for(let e=0;e<t.length;e++){const i=t[e],s=t[(e+1)%t.length];if(null!==this.intersectsLineSegment(i,s))return!0}return!1}getIntersectionDistance(t){let e=null;for(let i=0;i<t.length;i++){const s=t[i],n=t[(i+1)%t.length],o=this.intersectsLineSegment(s,n);null!==o&&(null===e||o<e)&&(e=o)}return e}intersectsLineSegment(t,e){const s=new i(e.x-t.x,e.y-t.y),n=new i(t.x-this.origin.x,t.y-this.origin.y),o=this.direction.x*s.y-this.direction.y*s.x;if(Math.abs(o)<1e-4)return null;const r=(n.x*s.y-n.y*s.x)/o,a=(n.x*this.direction.y-n.y*this.direction.x)/o;return r>=0&&a>=0&&a<=1?r:null}}class n{constructor(t,e=1,i=100,s="normal"){this.position=t,this.intensity=e,this.radius=i,this.type=s}emitLight(t){return new s(this.position,t,this.intensity)}}const o=300,r="#0066FF",a="#FF0000",l="#FFD700",h=6,c=100,d=1,u=1e3,p=200,g=5,y=50,f=20,m=50,x=28,S=30,A=40,T=220,_=.06,w=220,E=20,b=150,v=200,P=30,C=.5,I=25,R=.4,M=5,L=20,F=.4,k=35,D=.5,O=40,N=300,B=.6,U=.4,G=.7,H=.3,W=.1,$=.1,V=1,z=2*V,j=3e3,K=.2,Y=z,X=4*z,q=.8,J=8,Q=220,Z=.35,tt=3,et=110,it=1.1,st=160,nt=.9,ot=50,rt=.5,at=.08,lt=7.5,ht=1.4,ct=35,dt=420,ut=18,pt=.25,gt=.6,yt=2,ft=2,mt=8,xt=.08,St=.6,At=.3,Tt=8,_t=.9,wt=3,Et=6,bt=Math.PI/2,vt=30,Pt=60,Ct=0,It=1,Rt=2,Mt=5,Lt=1,Ft=2e3,kt=1e3,Dt=3,Ot=.5,Nt=4e3,Bt=[{count:600,parallaxFactor:.1,sizeRange:[.4,.9]},{count:450,parallaxFactor:.2,sizeRange:[.6,1.2]},{count:300,parallaxFactor:.35,sizeRange:[.8,1.6]},{count:200,parallaxFactor:.5,sizeRange:[1,2.2]}],Ut=64,Gt=2e3,Ht=1500,Wt=150,$t=.3,Vt=120,zt=250,jt=30,Kt=Vt,Yt=2e3,Xt=150,qt=Yt/2-Xt,Jt=3,Qt=150,Zt=100,te=2,ee=100,ie=300,se=10,ne=5,oe=150,re=400,ae=.25,le=15,he=2,ce=6,de=18,ue=80,pe=300,ge=400,ye=15,fe=10,me=30,xe=1,Se=5,Ae=120,Te=2,_e=5,we=30,Ee=.5,be=200,ve=.95,Pe=5,Ce=15,Ie=300,Re=50,Me=120,Le=5,Fe=1,ke=2,De=50,Oe=120,Ne=10,Be=5,Ue=320,Ge=140,He=8,We=3,$e=3,Ve=30,ze=.3,je=2,Ke=2,Ye=80,Xe=6,qe=8,Je=5,Qe=100,Ze=.75,ti=.45,ei=Math.PI,ii=2,si=.35,ni=1e3,oi=5,ri=10,ai=.8,li=1.2,hi=250,ci=300,di=150,ui=100,pi=50,gi=.5,yi=200,fi=350,mi=12,xi=6,Si=12,Ai=30,Ti=200,_i=175,wi=12,Ei=4,bi=30,vi=250,Pi=0,Ci=0,Ii=0,Ri=35,Mi=400,Li=.5,Fi=30,ki=20,Di=.5,Oi=50,Ni=80,Bi=2.5,Ui=500,Gi=0,Hi=0,Wi=0,$i=40,Vi=15,zi=300,ji=400,Ki=100,Yi=0,Xi=32,qi=10,Ji=60,Qi=250,Zi=300,ts=200,es=0,is=30,ss=2,ns=20,os=300,rs=0,as=0,ls=0,hs=35,cs=200,ds=500,us=10,ps=200,gs=500,ys=250,fs=750,ms=1e3,xs=400,Ss=600,As=650,Ts=300,_s=50,ws=1e3,Es=1e3,bs=1e3,vs="strafe-upgrade",Ps="regen-upgrade",Cs="attack-upgrade",Is=300,Rs=3e3,Ms="blink-upgrade",Ls=10,Fs=10,ks=18,Ds=80,Os=2e3,Ns=30,Bs=2,Us=1,Gs=3,Hs=5,Ws=8,$s=6,Vs=8,zs=.7,js=1.5,Ks=1.2,Ys=220,Xs=.6,qs=40,Js=350,Qs=140,Zs=Math.PI/4,tn=8,en=28,sn=100,nn=22,on=140,rn=5,an=.05,ln=2,hn=100,cn=150,dn=.5,un=150,pn=250,gn=5,yn=50,fn=.3,mn=100,xn=8,Sn=5,An=10,Tn=40,_n=.7,wn=140,En=12,bn=1.1,vn=.3,Pn=1.4,Cn=4,In=2,Rn=50,Mn=50,Ln=30,Fn=15,kn=20,Dn=1e3,On=2,Nn=5,Bn=15,Un=500,Gn=1,Hn=10*Math.PI/180,Wn=5,$n="#000011",Vn=10,zn=50,jn=.2,Kn=2,Yn=10,Xn=20,qn=.05,Jn=40,Qn=.08,Zn=48,to=.12,eo=15,io=120,so=250,no=8,oo=3,ro=8,ao=25,lo=5,ho=3,co=100,uo=200,po=5,go=1.5,yo=15,fo=300,mo=150,xo=10,So=90,Ao=180,To=6,_o=2,wo=12,Eo=150,bo=300,vo=12,Po=2,Co=400,Io=.1,Ro=.08,Mo=28,Lo=40,Fo=140,ko=0,Do=0,Oo=0,No=5,Bo=500,Uo=30,Go=2,Ho=200,Wo=80,$o=100,Vo=35,zo=1.5,jo=6,Ko=150,Yo=50,Xo=8,qo=.4,Jo=70,Qo=150,Zo=20,tr=1,er=8,ir=30,sr=600,nr=.1,or=95,rr=0,ar=0,lr=1,hr=12,cr=1,dr=4,ur=5,pr=5*Math.PI/180,gr=8,yr=600,fr=4,mr=1.2,xr=1.5,Sr=10,Ar=6,Tr=120,_r=450,wr=40,Er=.5,br=0,vr=150*Math.PI/180,Pr=80,Cr=.5,Ir=300,Rr=110,Mr=0,Lr=0,Fr=0,kr=10,Dr=350,Or=.02,Nr=.5,Br=2,Ur=400,Gr=500,Hr=50,Wr=.01,$r=120,Vr=200,zr=.5,jr=300,Kr=0,Yr=0,Xr=0,qr=50,Jr=12,Qr=60,Zr=Math.PI/2,ta=400,ea=150,ia=40,sa=2,na=20,oa=105,ra=250,aa=6,la=2,ha=0,ca=400,da=150,ua=50,pa=2,ga=.7,ya=10,fa=50,ma=100,xa=30*Math.PI/180,Sa=12,Aa=350,Ta=8,_a=1,wa=15,Ea=90,ba=200,va=15,Pa=1.5,Ca=0,Ia=500,Ra=200,Ma=20,La=25,Fa=.5,ka=5,Da=12,Oa=20,Na=150,Ba=1,Ua=40,Ga=20,Ha=25,Wa=12,$a=45*Math.PI/180,Va=500,za=.15;var ja;!function(t){t.ECONOMIC="economic",t.DEFENSIVE="defensive",t.AGGRESSIVE="aggressive",t.WAVES="waves"}(ja||(ja={}));class Ka{constructor(t,e){this.position=t,this.owner=e,this.health=Zt,this.maxHealth=Zt,this.efficiency=1,this.isSelected=!1,this.linkedStructure=null,this.targetPosition=null,this.velocity=new i(0,0),this.reflectionAngle=0,this.closestSunDistance=1/0,this.moveOrder=0,this.MAX_SPEED=50,this.ACCELERATION=25,this.DECELERATION=50,this.ARRIVAL_THRESHOLD=2,this.SLOW_RADIUS_PX=60,this.AVOIDANCE_BLEND_FACTOR=.6,this.ROTATION_SPEED_RAD_PER_SEC=Math.PI,this.ROTATION_SNAP_THRESHOLD_RAD=.01}isPathClear(t,e=[]){const n=new i(t.x-this.position.x,t.y-this.position.y).normalize(),o=new s(this.position,n),r=this.position.distanceTo(t);for(const t of e){const e=o.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<r)return!1}return!0}isCircleBlockingRay(t,e,i,s){const n=i.x-this.position.x,o=i.y-this.position.y,r=n*t.x+o*t.y;if(r<=0||r>=e)return!1;const a=this.position.x+t.x*r,l=this.position.y+t.y*r,h=i.x-a,c=i.y-l;return h*h+c*c<=s*s}hasLineOfSightToLight(t,e=[]){for(const i of t)if(this.isPathClear(i.position,e))return!0;return!1}hasLineOfSightToForge(t,e=[],i=[]){return this.hasLineOfSightToStructure(t,e,i)}hasLineOfSightToStructure(t,e=[],n=[]){const o=new i(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),r=this.position.distanceTo(t.position),a=new s(this.position,o);for(const t of e){const e=a.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<r)return!1}for(const e of n){for(const i of e.buildings)if(i!==t&&this.isCircleBlockingRay(o,r,i.position,i.radius))return!1;if(e.stellarForge&&e.stellarForge!==t&&this.isCircleBlockingRay(o,r,e.stellarForge.position,e.stellarForge.radius))return!1}return!0}getClosestVisibleSun(t,e=[]){let i=null,s=1/0;for(const n of t)if(this.isPathClear(n.position,e)){const t=this.position.distanceTo(n.position);t<s&&(i=n,s=t)}return i}getClosestSun(t){let e=null,i=1/0;for(const s of t){const t=this.position.distanceTo(s.position);t<i&&(e=s,i=t)}return e}generateEnergy(t){return this.getEnergyRatePerSec()*t}getEnergyRatePerSec(){const t=Math.max(1,On-this.closestSunDistance/Dn);return 10*this.efficiency*t}setTarget(t){this.targetPosition=t}setLinkedStructure(t){this.linkedStructure=t}getLinkedStructure(t){var e;return null!==(e=this.linkedStructure)&&void 0!==e?e:t}updateReflectionAngle(t,e,s=[],n){if(!t)return;const o=this.getClosestVisibleSun(e,s);if(!o)return void(this.closestSunDistance=1/0);this.closestSunDistance=this.position.distanceTo(o.position);const r=new i(o.position.x-this.position.x,o.position.y-this.position.y).normalize(),a=new i(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),l=r.x+a.x,h=r.y+a.y,c=(Math.sqrt(l*l+h*h)>0?Math.atan2(h,l):Math.atan2(r.y,r.x))+Math.PI/2,d=this.getShortestAngleDelta(this.reflectionAngle,c),u=this.ROTATION_SPEED_RAD_PER_SEC*n;Math.abs(d)<=Math.max(this.ROTATION_SNAP_THRESHOLD_RAD,u)?this.reflectionAngle=c:this.reflectionAngle+=Math.sign(d)*u}getShortestAngleDelta(t,e){let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(t,e=null){if(!this.targetPosition)return;if(e)for(const t of e.asteroids)if(t.containsPoint(this.targetPosition))return this.targetPosition=null,void(this.velocity=new i(0,0));const s=this.targetPosition.x-this.position.x,n=this.targetPosition.y-this.position.y,o=Math.sqrt(s*s+n*n);if(o<this.ARRIVAL_THRESHOLD)return this.position=this.targetPosition,this.targetPosition=null,void(this.velocity=new i(0,0));let r=s/o,a=n/o;if(e){const t=this.calculateObstacleAvoidance(e);if(t){r+=t.x*this.AVOIDANCE_BLEND_FACTOR,a+=t.y*this.AVOIDANCE_BLEND_FACTOR;const e=Math.sqrt(r*r+a*a);e>0&&(r/=e,a/=e)}}if(o<=this.SLOW_RADIUS_PX){const t=Math.max(0,o/this.SLOW_RADIUS_PX),e=this.MAX_SPEED*t;this.velocity.x=r*e,this.velocity.y=a*e}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(o>e*e/(2*this.DECELERATION)&&e<this.MAX_SPEED)this.velocity.x+=r*this.ACCELERATION*t,this.velocity.y+=a*this.ACCELERATION*t;else if(e>.1){const i=this.DECELERATION*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0;const i=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));i>this.MAX_SPEED&&(this.velocity.x=this.velocity.x/i*this.MAX_SPEED,this.velocity.y=this.velocity.y/i*this.MAX_SPEED)}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let e=0,s=0,n=0;const o=60;for(const i of t.asteroids){const t=this.position.x-i.position.x,r=this.position.y-i.position.y,a=Math.sqrt(t*t+r*r),l=i.size+20;if(a>0&&a<l+o){const i=(l+o-a)/o;e+=t/a*i,s+=r/a*i,n++}}for(const i of t.suns){const t=this.position.x-i.position.x,r=this.position.y-i.position.y,a=Math.sqrt(t*t+r*r),l=i.radius+30;if(a<l+o){const i=(l+o-a)/o;e+=t/a*i,s+=r/a*i,n++}}for(const i of t.players){for(const t of i.solarMirrors){if(t===this)continue;const i=this.position.x-t.position.x,r=this.position.y-t.position.y,a=Math.sqrt(i*i+r*r),l=40;if(a<l+o&&a>0){const t=(l+o-a)/o;e+=i/a*t,s+=r/a*t,n++}}if(i.stellarForge){const t=i.stellarForge,r=this.position.x-t.position.x,a=this.position.y-t.position.y,l=Math.sqrt(r*r+a*a),h=t.radius+30;if(l<h+o){const t=(h+o-l)/o;e+=r/l*t,s+=a/l*t,n++}}}if(n>0){const t=Math.sqrt(e*e+s*s);if(t>0)return new i(e/t,s/t)}return null}takeDamage(t){this.health-=t}containsPoint(t){return this.position.distanceTo(t)<kn}}class Ya{constructor(t){this.initialSeed=t>>>0,this.state=this.initialSeed}getSeed(){return this.initialSeed}reset(){this.state=this.initialSeed}next(){let t=this.state+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}nextInt(t,e){return Math.floor(this.next()*(e-t+1))+t}nextFloat(t,e){return this.next()*(e-t)+t}nextBool(t=.5){return this.next()<t}choice(t){if(0!==t.length)return t[this.nextInt(0,t.length-1)]}shuffle(t){for(let e=t.length-1;e>0;e--){const i=this.nextInt(0,e);[t[e],t[i]]=[t[i],t[e]]}return t}nextAngle(){return this.next()*Math.PI*2}nextUnitCircle(){const t=this.nextAngle();return{x:Math.cos(t),y:Math.sin(t)}}nextInUnitCircle(){const t=this.nextAngle(),e=Math.sqrt(this.next());return{x:Math.cos(t)*e,y:Math.sin(t)*e}}}let Xa=null;function qa(t){Xa=t}function Ja(){if(!Xa)throw new Error("Game RNG not initialized. Call setGameRNG() with match seed before using.");return Xa}function Qa(){return Date.now()%4294967295>>>0}var Za;class tl{constructor(t,e,s){if(this.position=t,this.glowState=Ct,this.glowTransition=0,this.targetGlowState=Ct,this.lastMovementTime=0,this.impactColor=null,this.impactBlend=0,this.impactTargetBlend=0,this.impactHoldTimeSec=0,this.baseColor=tl.generateBaseColor(s),this.currentColor=this.baseColor,e)this.velocity=e;else{const t=Ja();this.velocity=new i(t.nextFloat(-1,1),t.nextFloat(-1,1))}}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>Mt)this.targetGlowState=Rt,this.lastMovementTime=Date.now();else if(e>Lt)this.glowState<It&&(this.targetGlowState=It),this.lastMovementTime=Date.now();else{const t=Date.now()-this.lastMovementTime;t>Ft?this.targetGlowState=Ct:t>kt&&this.glowState===Rt&&(this.targetGlowState=It)}const i=this.glowState<this.targetGlowState?Dt:Ot;(this.glowState<this.targetGlowState||this.glowState>this.targetGlowState)&&(this.glowTransition+=t*i,this.glowTransition>=1&&(this.glowState=this.targetGlowState,this.glowTransition=0)),this.updateImpactBlend(t),this.velocity.x*=.98,this.velocity.y*=.98;const s=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(s<K)if(0===s)this.velocity.x=K,this.velocity.y=0;else{const t=K/s;this.velocity.x*=t,this.velocity.y*=t}}applyForce(t){this.velocity.x+=t.x,this.velocity.y+=t.y}applyImpactColor(t,e){!t||e<=0||(this.impactColor=t,this.impactTargetBlend=Math.max(this.impactTargetBlend,Math.min(1,e)),this.impactHoldTimeSec=at)}updateColor(t,e){let i=this.baseColor;t&&e>0&&(i=this.blendColors(this.baseColor,t,e)),this.impactColor&&this.impactBlend>0?this.currentColor=this.blendColors(i,this.impactColor,this.impactBlend):this.currentColor=i}blendColors(t,e,i){if(!(t&&e&&t.startsWith("#")&&e.startsWith("#")))return this.baseColor;const s=parseInt(t.slice(1),16),n=parseInt(e.slice(1),16);if(isNaN(s)||isNaN(n))return this.baseColor;const o=s>>16&255,r=s>>8&255,a=255&s,l=n>>16&255,h=n>>8&255,c=255&n;return`#${(Math.round(o+(l-o)*i)<<16|Math.round(r+(h-r)*i)<<8|Math.round(a+(c-a)*i)).toString(16).padStart(6,"0")}`}updateImpactBlend(t){this.impactHoldTimeSec>0&&(this.impactHoldTimeSec=Math.max(0,this.impactHoldTimeSec-t));const e=this.impactHoldTimeSec>0?this.impactTargetBlend:0,i=(e>this.impactBlend?lt:ht)*t;this.impactBlend<e?this.impactBlend=Math.min(e,this.impactBlend+i):this.impactBlend>e&&(this.impactBlend=Math.max(e,this.impactBlend-i)),0===e&&0===this.impactBlend&&(this.impactTargetBlend=0,this.impactColor=null)}static generateBaseColor(t){const e=Ja();if(t&&t.neutral.length>0){const i=e.next()>.7&&t.accent.length>0?t.accent:t.neutral;return i[e.nextInt(0,i.length-1)]}const i=e.nextFloat(85,195);let s=i,n=i,o=i;const r=e.next();r<.18?(s=i-8,n=i-4,o=i+14):r<.28&&(s=i+10,n=i-10,o=i+12);const a=t=>Math.max(0,Math.min(255,Math.round(t)));return`#${(a(s)<<16|a(n)<<8|a(o)).toString(16).padStart(6,"0")}`}}class el{constructor(t){this.position=t,this.phase="idle",this.phaseTimer=0}start(){this.phase="suck",this.phaseTimer=ai}update(t){"idle"!==this.phase&&(this.phaseTimer-=t,this.phaseTimer<=0&&("suck"===this.phase?(this.phase="wave",this.phaseTimer=li):"wave"===this.phase&&(this.phase="idle",this.phaseTimer=0)))}isActive(){return"idle"!==this.phase}getPhaseProgress(){if("idle"===this.phase)return 0;const t="suck"===this.phase?ai:li;return 1-this.phaseTimer/t}}class il{constructor(t,e){this.position=t,this.rotation=0,this.lifetime=0,this.maxLifetime=ln,this.velocity=e;const i=Ja();this.rotationSpeed=i.nextFloat(-5,5)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=.95,this.velocity.y*=.95,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}applyCollision(t){this.velocity.x+=t.x*fn,this.velocity.y+=t.y*fn}}class sl{constructor(t,e){this.position=t,this.angle=e,this.lifetime=0,this.maxLifetime=an}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class nl{constructor(t,e){this.position=t,this.lifetime=0,this.maxLifetime=dn,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.y+=100*t,this.velocity.x*=.98,this.velocity.y*=.98,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class ol{constructor(t,e,s,n=Wn){this.position=t,this.owner=s,this.damage=n,this.lifetime=0,this.maxLifetime=Gn,this.maxRange=1/0,this.hitRadiusPx=10,this.velocity=e,this.startPosition=new i(t.x,t.y)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime||this.startPosition.distanceTo(this.position)>=this.maxRange}checkHit(t){return this.position.distanceTo(t.position)<this.hitRadiusPx}}class rl{constructor(t,e,i,s,n=je){this.startPos=t,this.endPos=e,this.owner=i,this.damage=s,this.widthPx=n,this.lifetime=0,this.maxLifetime=.1}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}class al{constructor(t,e,i,s){this.position=t,this.velocity=e,this.maxLifetime=i,this.faction=s,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class ll{constructor(t,e,i,s,n=2){this.position=t,this.velocity=e,this.maxLifetime=i,this.color=s,this.size=n,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t,this.velocity.x*=.95,this.velocity.y*=.95}getOpacity(){return Math.max(0,1-this.lifetime/this.maxLifetime)}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class hl{constructor(t,e,s,n,o){this.lifetime=0,this.spriteFragment=null,this.opacity=1,this.position=new i(t.x,t.y),this.velocity=e,this.rotation=s;const r=Ja();this.rotationSpeed=r.nextFloat(-2,2),this.spriteFragment=n,this.fadeStartTime=o}update(t){if(this.lifetime+=t,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=hl.VELOCITY_DAMPING,this.velocity.y*=hl.VELOCITY_DAMPING,this.lifetime<hl.INITIAL_FADE_DURATION)this.opacity=1-hl.OPACITY_DROP*(this.lifetime/hl.INITIAL_FADE_DURATION);else if(this.lifetime<this.fadeStartTime)this.opacity=hl.STABLE_OPACITY;else{const t=(this.lifetime-this.fadeStartTime)/hl.FINAL_FADE_DURATION;this.opacity=Math.max(0,hl.STABLE_OPACITY*(1-t))}}shouldDespawn(){return this.lifetime>=this.fadeStartTime+hl.FINAL_FADE_DURATION}}hl.VELOCITY_DAMPING=.98,hl.INITIAL_FADE_DURATION=.5,hl.OPACITY_DROP=.7,hl.STABLE_OPACITY=.3,hl.FINAL_FADE_DURATION=1;class cl{constructor(t,e){this.position=t,this.owner=e,this.health=ni,this.maxHealth=ni,this.isReceivingLight=!1,this.incomingLightPerSec=0,this.unitQueue=[],this.heroProductionUnitType=null,this.heroProductionRemainingSec=0,this.heroProductionDurationSec=0,this.isSelected=!1,this.targetPosition=null,this.velocity=new i(0,0),this.baseMaxSpeed=50,this.acceleration=30,this.deceleration=50,this.slowRadiusPx=80,this.AVOIDANCE_BLEND_FACTOR=.6,this.radius=40,this.crunchTimer=0,this.currentCrunch=null,this.pendingEnergy=0,this.minionPath=[],this.moveOrder=0,this.rotation=0;const s=Ja();this.crunchTimer=s.nextFloat(0,ri)}setMinionPath(t){this.minionPath=t.map(t=>new i(t.x,t.y))}initializeDefaultPath(t){this.minionPath=[new i(t.x,t.y)]}canProduceUnits(){return this.isReceivingLight&&this.health>0}produceUnit(t,e,i){return!(this.health<=0||i<e||(this.unitQueue.push(t),0))}enqueueHeroUnit(t){this.unitQueue.push(t)}startHeroProductionIfIdle(){if(this.heroProductionUnitType||0===this.unitQueue.length)return;const t=this.unitQueue.shift();t&&(this.heroProductionUnitType=t,this.heroProductionDurationSec=tn,this.heroProductionRemainingSec=tn)}advanceHeroProduction(t){if(this.startHeroProductionIfIdle(),!this.heroProductionUnitType)return null;if(!this.canProduceUnits())return null;if(this.heroProductionRemainingSec=Math.max(0,this.heroProductionRemainingSec-t),this.heroProductionRemainingSec>0)return null;const e=this.heroProductionUnitType;return this.heroProductionUnitType=null,this.heroProductionDurationSec=0,this.heroProductionRemainingSec=0,e}updateLightStatus(t,e,i=[],s=[]){this.isReceivingLight=!1,this.incomingLightPerSec=0;for(const n of t)n.getLinkedStructure(this)===this&&n.hasLineOfSightToLight(e,i)&&n.hasLineOfSightToForge(this,i,s)&&(this.isReceivingLight=!0,this.incomingLightPerSec+=n.getEnergyRatePerSec())}getCurrentMaxSpeed(){if(!this.isReceivingLight||this.incomingLightPerSec<=0)return 0;const t=Math.min(2,this.incomingLightPerSec/100);return this.baseMaxSpeed*t}update(t,e=null){this.health>0&&this.isReceivingLight&&(this.crunchTimer-=t),this.currentCrunch&&(this.currentCrunch.update(t),this.currentCrunch.isActive()||(this.currentCrunch=null));const i=this.getCurrentMaxSpeed();if(this.targetPosition&&0!==i){const s=this.targetPosition.x-this.position.x,n=this.targetPosition.y-this.position.y,o=Math.sqrt(Math.pow(s,2)+Math.pow(n,2));if(o<5)this.position.x=this.targetPosition.x,this.position.y=this.targetPosition.y,this.velocity.x=0,this.velocity.y=0,this.targetPosition=null;else{let r=s/o,a=n/o;if(e){const t=this.calculateObstacleAvoidance(e);if(t){r+=t.x*this.AVOIDANCE_BLEND_FACTOR,a+=t.y*this.AVOIDANCE_BLEND_FACTOR;const e=Math.sqrt(r*r+a*a);e>0&&(r/=e,a/=e)}}if(o<=this.slowRadiusPx){const t=i*Math.max(0,o/this.slowRadiusPx);this.velocity.x=r*t,this.velocity.y=a*t}else{this.velocity.x+=r*this.acceleration*t,this.velocity.y+=a*this.acceleration*t;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));e>i&&(this.velocity.x=this.velocity.x/e*i,this.velocity.y=this.velocity.y/e*i)}}}else{const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>.1){const i=this.deceleration*t,s=Math.max(0,(e-i)/e);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let e=0,s=0,n=0;const o=80;for(const i of t.suns){const t=this.position.x-i.position.x,r=this.position.y-i.position.y,a=Math.sqrt(t*t+r*r),l=i.radius+this.radius+10;if(a<l+o){const i=(l+o-a)/o;e+=t/a*i,s+=r/a*i,n++}}for(const i of t.players){if(i.stellarForge&&i.stellarForge!==this){const t=i.stellarForge,r=this.position.x-t.position.x,a=this.position.y-t.position.y,l=Math.sqrt(r*r+a*a),h=this.radius+t.radius+10;if(l<h+o&&l>0){const t=(h+o-l)/o;e+=r/l*t,s+=a/l*t,n++}}for(const t of i.solarMirrors){const i=this.position.x-t.position.x,r=this.position.y-t.position.y,a=Math.sqrt(i*i+r*r),l=this.radius+30;if(a<l+o){const t=(l+o-a)/o;e+=i/a*t,s+=r/a*t,n++}}}if(n>0){const t=Math.sqrt(e*e+s*s);if(t>0)return new i(e/t,s/t)}return null}shouldCrunch(){if(this.crunchTimer<=0&&this.health>0&&this.isReceivingLight){this.crunchTimer=ri,this.currentCrunch=new el(new i(this.position.x,this.position.y)),this.currentCrunch.start(),this.rotation+=Math.PI/3,this.rotation>=2*Math.PI&&(this.rotation-=2*Math.PI);const t=this.pendingEnergy;return this.pendingEnergy=0,t}return 0}addPendingEnergy(t){this.pendingEnergy+=t}getCurrentCrunch(){return this.currentCrunch}setTarget(t){this.targetPosition=new i(t.x,t.y)}toggleSelection(){this.isSelected=!this.isSelected}containsPoint(t){return this.position.distanceTo(t)<=this.radius}}class dl{constructor(t,e,i,s,n,o,r){this.position=t,this.owner=e,this.radius=s,this.attackRange=n,this.attackDamage=o,this.attackSpeed=r,this.attackCooldown=0,this.target=null,this.buildProgress=0,this.accumulatedEnergy=0,this.energyRequired=0,this.isComplete=!1,this.isSelected=!1,this.health=i,this.maxHealth=i}update(t,e,i,s=[],n=[],o=qt){this.attackCooldown>0&&(this.attackCooldown-=t),this.isComplete&&(this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0)&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target,e,n,s,o),this.attackCooldown=1/this.attackSpeed)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t,e=[],i=[],s=[],n=qt){"health"in t&&(t.health-=this.attackDamage)}takeDamage(t){this.health-=t}isDestroyed(){return this.health<=0}addBuildProgress(t){this.isComplete||(this.buildProgress+=t,this.buildProgress>=1&&(this.buildProgress=1,this.isComplete=!0))}addEnergy(t){this.isComplete||(this.accumulatedEnergy+=t,this.energyRequired>0&&(this.buildProgress=Math.min(1,this.accumulatedEnergy/this.energyRequired),this.buildProgress>=1&&(this.isComplete=!0)))}containsPoint(t){return this.position.distanceTo(t)<=this.radius}canShoot(){return this.attackRange>0&&this.attackDamage>0}}class ul extends dl{constructor(t,e){super(t,e,yi,Ai,fi,mi,xi),this.lastShotEffects={},this.lastShotLasers=[],this.energyRequired=gs}attack(t,e=[],s=[],n=[],o=qt){const r=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.sqrt(r*r+a*a);if(l<=0)return;const h=r/l,c=a/l;let d=this.getRayBoundaryDistance(this.position.x,this.position.y,h,c,o),u=null;for(const t of s){const e=this.getStructureRadius(t),i=this.getRayCircleHitDistance(this.position.x,this.position.y,h,c,t.position.x,t.position.y,e);null!==i&&i<d&&(d=i,u=t)}for(const t of n){const e=this.getRayCircleHitDistance(this.position.x,this.position.y,h,c,t.position.x,t.position.y,t.size);null!==e&&e<d&&(d=e,u=null)}const p=new i(this.position.x+h*d,this.position.y+c*d),g=new rl(new i(this.position.x,this.position.y),new i(p.x,p.y),this.owner,this.attackDamage,Si);this.lastShotLasers.push(g);const y=.5*Si;for(const t of e){if(!("collisionRadiusPx"in t))continue;const e=(t.position.x-this.position.x)*h+(t.position.y-this.position.y)*c;if(e<0||e>d)continue;const i=this.position.x+h*e,s=this.position.y+c*e,n=t.position.x-i,o=t.position.y-s,r=n*n+o*o,a=y+t.collisionRadiusPx;r<=a*a&&t.takeDamage(this.attackDamage)}u&&"owner"in u&&u.owner!==this.owner&&"health"in u&&(u.health-=this.attackDamage);const f=Math.atan2(a,r);this.lastShotEffects.muzzleFlash=new sl(new i(this.position.x,this.position.y),f);const m=Ja(),x=f+Math.PI/2+m.nextFloat(-.25,.25),S=m.nextFloat(hn,cn);this.lastShotEffects.casing=new il(new i(this.position.x,this.position.y),new i(Math.cos(x)*S,Math.sin(x)*S));const A=f+Math.PI+m.nextFloat(-.5,.5),T=m.nextFloat(un,pn);this.lastShotEffects.bouncingBullet=new nl(new i(t.position.x,t.position.y),new i(Math.cos(A)*T,Math.sin(A)*T))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}getAndClearLastShotLasers(){const t=this.lastShotLasers;return this.lastShotLasers=[],t}getRayBoundaryDistance(t,e,i,s,n){let o=1/0;if(Math.abs(i)>.001){const e=(n-t)/i;e>0&&e<o&&(o=e);const s=(-n-t)/i;s>0&&s<o&&(o=s)}if(Math.abs(s)>.001){const t=(n-e)/s;t>0&&t<o&&(o=t);const i=(-n-e)/s;i>0&&i<o&&(o=i)}return o===1/0?0:o}getRayCircleHitDistance(t,e,i,s,n,o,r){const a=(n-t)*i+(o-e)*s;if(a<0)return null;const l=n-(t+i*a),h=o-(e+s*a),c=l*l+h*h,d=r*r;if(c>d)return null;const u=Math.sqrt(d-c),p=a-u;return p>=0?p:a+u}getStructureRadius(t){return"radius"in t?t.radius:kn}}class pl extends dl{constructor(t,e){super(t,e,Ti,bi,_i,wi,Ei),this.lastShotEffects={},this.energyRequired=ys}attack(t,e=[],s=[],n=[],o=qt){super.attack(t);const r=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.atan2(a,r);this.lastShotEffects.muzzleFlash=new sl(new i(this.position.x,this.position.y),l);const h=Ja(),c=l+Math.PI/2+h.nextFloat(-.25,.25),d=h.nextFloat(hn,cn);this.lastShotEffects.casing=new il(new i(this.position.x,this.position.y),new i(Math.cos(c)*d,Math.sin(c)*d));const u=l+Math.PI+h.nextFloat(-.5,.5),p=h.nextFloat(un,pn);this.lastShotEffects.bouncingBullet=new nl(new i(t.position.x,t.position.y),new i(Math.cos(u)*p,Math.sin(u)*p))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}}class gl extends dl{constructor(t,e){super(t,e,vi,Ri,Pi,Ci,Ii),this.energyRequired=fs;const i=Mi*Li;this.currentInfluenceRadius=i,this.targetInfluenceRadius=i}update(t,e,i,s=[]){if(super.update(t,e,i,s),this.isComplete){this.targetInfluenceRadius<Mi&&(this.targetInfluenceRadius=Math.min(this.targetInfluenceRadius+Fi*t,Mi));const e=this.targetInfluenceRadius-this.currentInfluenceRadius;Math.abs(e)>.1?this.currentInfluenceRadius+=.2*e:this.currentInfluenceRadius=this.targetInfluenceRadius}}applyDustSwirl(t,e){if(this.isComplete)for(const e of t){const t=e.position.x-this.position.x,i=e.position.y-this.position.y,s=Math.sqrt(t*t+i*i);if(s>this.currentInfluenceRadius||s<1)continue;const n=i/s,o=-t/s,r=s/this.currentInfluenceRadius,a=Ni*(1+Bi*(1-r));e.velocity.x=n*a,e.velocity.y=o*a}}absorbProjectile(t){if(!this.isComplete)return!1;const e=t.position.x-this.position.x,i=t.position.y-this.position.y;if(Math.sqrt(e*e+i*i)>this.currentInfluenceRadius)return!1;let s=5;"damage"in t&&"number"==typeof t.damage?s=t.damage:"GraveProjectile"===t.constructor.name?s=le:"InfluenceBallProjectile"===t.constructor.name&&(s=10);const n=ki+s*Di;return this.targetInfluenceRadius=Math.max(this.targetInfluenceRadius-n,Oi),!0}deflectProjectile(t){return this.absorbProjectile(t)}}class yl extends dl{constructor(t,e){super(t,e,Ui,$i,Gi,Hi,Wi),this.productionTimer=0,this.completedProduction=null,this.productionQueue=[],this.currentProduction=null,this.productionProgress=0,this.energyRequired=ms}update(t,e,i){if(this.isComplete&&(!this.currentProduction&&this.productionQueue.length>0&&(this.currentProduction=this.productionQueue.shift()||null,this.productionProgress=0),this.currentProduction)){const e=this.getProductionTime(this.currentProduction);this.addProductionProgress(t/e)}}enqueueProduction(t){this.productionQueue.push(t)}getCompletedProduction(){const t=this.completedProduction;return t&&(this.completedProduction=null),t}addProductionProgress(t){this.currentProduction&&(this.productionProgress+=t,this.productionProgress>=1&&(this.productionProgress=0,this.completedProduction=this.currentProduction,this.currentProduction=null))}addProductionEnergyBoost(t){if(!this.currentProduction)return;const e=this.getProductionEnergyCost(this.currentProduction);e<=0||this.addProductionProgress(t/e)}getProductionTime(t){return"solar-mirror"===t?rn:Vi}getProductionEnergyCost(t){return t===vs?ws:t===Ps?Es:t===Cs?bs:t===Ms?Rs:ms}canUpgradeStrafe(){return this.isComplete&&!this.owner.hasStrafeUpgrade}canQueueStrafeUpgrade(){return this.canUpgradeStrafe()&&!this.hasProductionItem(vs)}canUpgradeRegen(){return this.isComplete&&!this.owner.hasRegenUpgrade}canUpgradeBlink(){return this.isComplete&&!this.owner.hasBlinkUpgrade}canUpgradeAttack(){return this.isComplete&&!this.owner.hasAttackUpgrade}canQueueRegenUpgrade(){return this.canUpgradeRegen()&&!this.hasProductionItem(Ps)}canQueueBlinkUpgrade(){return this.canUpgradeBlink()&&!this.hasProductionItem(Ms)}canQueueAttackUpgrade(){return this.canUpgradeAttack()&&!this.hasProductionItem(Cs)}hasProductionItem(t){return this.currentProduction===t||this.productionQueue.includes(t)}upgradeStrafe(){return!!this.canUpgradeStrafe()&&(this.owner.hasStrafeUpgrade=!0,!0)}upgradeRegen(){return!!this.canUpgradeRegen()&&(this.owner.hasRegenUpgrade=!0,!0)}upgradeBlink(){return!!this.canUpgradeBlink()&&(this.owner.hasBlinkUpgrade=!0,!0)}upgradeAttack(){return!!this.canUpgradeAttack()&&(this.owner.hasAttackUpgrade=!0,!0)}}class fl extends dl{constructor(t,e){super(t,e,zi,Xi,ji,Ki,Yi),this.reloadTimer=0,this.missileReady=!0,this.isAwaitingTarget=!1,this.countdownTimer=0,this.targetPosition=null,this.COUNTDOWN_DURATION=5,this.energyRequired=xs}update(t,e,i,s=[],n=[],o=qt){this.isComplete&&(null!==this.targetPosition&&this.countdownTimer>0&&(this.countdownTimer-=t),this.missileReady||(this.reloadTimer+=t,this.reloadTimer>=qi&&(this.missileReady=!0,this.reloadTimer=0)))}isMissileReady(){return this.isComplete&&this.missileReady}isInCountdown(){return this.countdownTimer>0&&null!==this.targetPosition}getRemainingCountdown(){return Math.max(0,this.countdownTimer)}startCountdown(t){this.targetPosition=t,this.countdownTimer=this.COUNTDOWN_DURATION,this.isAwaitingTarget=!1}cancelCountdown(){this.targetPosition=null,this.countdownTimer=0,this.isAwaitingTarget=!1}isValidTarget(t,e,i,s){return!(this.position.distanceTo(t)>this.attackRange||!e(t)||i(t,s))}fireMissile(t,e,i,s,n){if(!this.isMissileReady())return!1;if(!this.isValidTarget(t,i,s,n))return!1;for(const i of e)t.distanceTo(i.position)<=Ji&&"health"in i&&(i.health-=this.attackDamage);return this.missileReady=!1,this.reloadTimer=0,this.targetPosition=null,this.countdownTimer=0,this.isAwaitingTarget=!1,!0}getReloadProgress(){return this.missileReady?1:Math.min(1,this.reloadTimer/qi)}}class ml extends dl{constructor(t,e){super(t,e,Qi,is,Zi,ts,es),this.lockedTarget=null,this.lockOnTimer=0,this.lastShotLasers=[],this.energyRequired=Ss}update(t,e,i,s=[],n=[],o=qt){if(this.isComplete)if(this.lockedTarget){if(this.isTargetDead(this.lockedTarget)||!(this.position.distanceTo(this.lockedTarget.position)<=this.attackRange))return this.lockedTarget=null,void(this.lockOnTimer=0);this.lockOnTimer+=t,this.lockOnTimer>=ss&&(this.fireLaser(this.lockedTarget,e,n,s,o),this.lockedTarget=null,this.lockOnTimer=0)}else this.lockedTarget=this.findNearestEnemy(e),this.lockedTarget&&(this.lockOnTimer=0)}fireLaser(t,e,s,n,o){const r=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.sqrt(r*r+a*a);if(l<=0)return;const h=r/l,c=a/l;let d=this.getRayBoundaryDistance(this.position.x,this.position.y,h,c,o),u=null;for(const t of s){const e=this.getStructureRadius(t),i=this.getRayCircleHitDistance(this.position.x,this.position.y,h,c,t.position.x,t.position.y,e);null!==i&&i<d&&(d=i,u=t)}for(const t of n){const e=this.getRayCircleHitDistance(this.position.x,this.position.y,h,c,t.position.x,t.position.y,t.size);null!==e&&e<d&&(d=e,u=null)}const p=new i(this.position.x+h*d,this.position.y+c*d),g=new rl(new i(this.position.x,this.position.y),new i(p.x,p.y),this.owner,this.attackDamage,ns);this.lastShotLasers.push(g);const y=.5*ns;for(const t of e){if(!("collisionRadiusPx"in t))continue;const e=(t.position.x-this.position.x)*h+(t.position.y-this.position.y)*c;if(e<0||e>d)continue;const i=this.position.x+h*e,s=this.position.y+c*e,n=t.position.x-i,o=t.position.y-s,r=n*n+o*o,a=y+t.collisionRadiusPx;r<=a*a&&t.takeDamage(this.attackDamage)}u&&"owner"in u&&u.owner!==this.owner&&"health"in u&&(u.health-=this.attackDamage)}getLockedTarget(){return this.lockedTarget}getLockOnProgress(){return this.lockedTarget?Math.min(1,this.lockOnTimer/ss):0}getAndClearLastShotLasers(){const t=this.lastShotLasers;return this.lastShotLasers=[],t}getRayBoundaryDistance(t,e,i,s,n){let o=1/0;if(Math.abs(i)>.001){const e=(n-t)/i;e>0&&e<o&&(o=e);const s=(-n-t)/i;s>0&&s<o&&(o=s)}if(Math.abs(s)>.001){const t=(n-e)/s;t>0&&t<o&&(o=t);const i=(-n-e)/s;i>0&&i<o&&(o=i)}return o===1/0?0:o}getRayCircleHitDistance(t,e,i,s,n,o,r){const a=(n-t)*i+(o-e)*s;if(a<0)return null;const l=n-(t+i*a),h=o-(e+s*a),c=l*l+h*h,d=r*r;if(c>d)return null;const u=Math.sqrt(d-c),p=a-u;return p>=0?p:a+u}getStructureRadius(t){return"radius"in t?t.radius:kn}}class xl extends dl{constructor(t,e){super(t,e,os,hs,rs,as,ls),this.energyRequired=As,this.maxShieldHealth=ds,this.shieldHealth=this.maxShieldHealth,this.shieldActive=!0,this.regenerationTimer=0,this.shieldRadius=cs}update(t,e,i,s=[]){super.update(t,e,i,s),this.isComplete&&!this.shieldActive&&(this.regenerationTimer+=t,this.regenerationTimer>=us)&&(e.some(t=>{const e=t.position.x-this.position.x,i=t.position.y-this.position.y;return Math.sqrt(e*e+i*i)<=this.shieldRadius})||(this.shieldActive=!0,this.shieldHealth=this.maxShieldHealth,this.regenerationTimer=0))}damageShield(t){return!(!this.shieldActive||!this.isComplete||(this.shieldHealth-=t,this.shieldHealth<=0&&(this.shieldHealth=0,this.shieldActive=!1,this.regenerationTimer=0),0))}isEnemyBlocked(t){if(!this.shieldActive||!this.isComplete)return!1;const e=t.x-this.position.x,i=t.y-this.position.y;return Math.sqrt(e*e+i*i)<=this.shieldRadius}getShieldHealthPercent(){return this.shieldHealth/this.maxShieldHealth}}!function(t){t.RADIANT="Radiant",t.AURUM="Aurum",t.VELARIS="Velaris"}(Za||(Za={}));class Sl{constructor(t,e){this.name=t,this.faction=e,this.energy=100,this.stellarForge=null,this.solarMirrors=[],this.units=[],this.buildings=[],this.isAi=!1,this.aiNextMirrorCommandSec=0,this.aiNextDefenseCommandSec=0,this.aiNextHeroCommandSec=0,this.aiNextStructureCommandSec=0,this.aiNextMirrorPurchaseCommandSec=0,this.aiStrategy=ja.ECONOMIC,this.hasStrafeUpgrade=!1,this.hasRegenUpgrade=!1,this.hasBlinkUpgrade=!1,this.hasAttackUpgrade=!1,this.unitsCreated=0,this.unitsLost=0,this.energyGathered=0}isDefeated(){return null===this.stellarForge||this.stellarForge.health<=0}addEnergy(t){this.energy+=t,this.energyGathered+=t}spendEnergy(t){return this.energy>=t&&(this.energy-=t,!0)}}class Al{constructor(t,e,s,n,o,r,a=5,l=An){this.position=t,this.owner=e,this.attackRange=n,this.attackDamage=o,this.attackSpeed=r,this.abilityCooldownTime=a,this.attackCooldown=0,this.abilityCooldown=0,this.target=null,this.manualTarget=null,this.rallyPoint=null,this.lastAbilityEffects=[],this.isHero=!1,this.moveOrder=0,this.isSelected=!1,this.rotation=0,this.velocity=new i(0,0),this.waypoints=[],this.currentWaypointIndex=0,this.stunDuration=0,this.health=s,this.maxHealth=s,this.collisionRadiusPx=l}setManualTarget(t,e){this.manualTarget=t,this.target=t,this.clearMovementOrders(),e&&(this.rallyPoint=new i(e.x,e.y))}clearManualTarget(){this.manualTarget=null,this.target=null}getManualTarget(){return this.manualTarget}clearMovementOrders(){this.rallyPoint=null,this.waypoints=[],this.currentWaypointIndex=0,this.velocity.x=0,this.velocity.y=0}update(t,e,i,s=[]){if(this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.stunDuration>0)this.stunDuration-=t;else if(this.moveTowardRallyPoint(t,mn,i,s),this.manualTarget&&this.isTargetDead(this.manualTarget)&&(this.manualTarget=null,this.target=null,this.clearMovementOrders()),this.target&&!this.isTargetDead(this.target)||(this.manualTarget?this.target=this.manualTarget:this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed),this.target&&!this.isTargetDead(this.target)&&this.position.distanceTo(this.target.position)<=this.attackRange){const e=this.target.position.x-this.position.x,i=this.target.position.y-this.position.y,s=Math.atan2(i,e)+Math.PI/2,n=this.getShortestAngleDelta(this.rotation,s),o=xn*t;Math.abs(n)<=o?this.rotation=s:this.rotation+=Math.sign(n)*o,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}setPath(t){this.waypoints=t.map(t=>new i(t.x,t.y)),this.currentWaypointIndex=0,this.waypoints.length>0&&(this.rallyPoint=this.waypoints[0])}getStructureStandoffPoint(t,e){const s=this.position.x-t.x,n=this.position.y-t.y,o=Math.sqrt(s*s+n*n),r=e+this.collisionRadiusPx+Cn;if(o<=0)return new i(t.x+r,t.y);const a=r/o;return new i(t.x+s*a,t.y+n*a)}moveTowardRallyPoint(t,e,i,s=[]){if(!this.rallyPoint)return this.velocity.x=0,void(this.velocity.y=0);const n=this.rallyPoint.x-this.position.x,o=this.rallyPoint.y-this.position.y,r=Math.sqrt(n*n+o*o);if(r<=Sn)return this.waypoints.length>0&&this.currentWaypointIndex<this.waypoints.length-1?(this.currentWaypointIndex++,void(this.rallyPoint=this.waypoints[this.currentWaypointIndex])):(this.rallyPoint=null,this.waypoints=[],this.currentWaypointIndex=0,this.velocity.x=0,void(this.velocity.y=0));let a=n/r,l=o/r;const h=Tn,c=h*h;let d=0,u=0;for(let t=0;t<i.length;t++){const e=i[t];if(e===this||e.isDead())continue;const s=this.position.x-e.position.x,n=this.position.y-e.position.y,o=s*s+n*n;if(o>0&&o<c){const t=Math.sqrt(o);let i=(h-t)/h;this.isHero&&!e.isHero?i*=vn:!this.isHero&&e.isHero&&(i*=Pn),d+=s/t*i,u+=n/t*i}}const p=Math.sqrt(d*d+u*u);p>0&&(d/=p,u/=p);let g=0,y=0;const f=wn,m=En;for(let t=0;t<s.length;t++){const e=s[t],i=e.position.x-this.position.x,n=e.position.y-this.position.y,o=i*a+n*l,r=e.size+this.collisionRadiusPx+m,h=r*r;if(o>0&&o<f){const t=i-a*o,e=n-l*o,s=t*t+e*e;if(s<h){const t=a*n-l*i,e=t>0?l:-l,o=t>0?-a:a,h=(r-Math.sqrt(s))/r;g+=e*h,y+=o*h}}const c=this.position.x-e.position.x,d=this.position.y-e.position.y,u=c*c+d*d;if(u<h){const t=Math.sqrt(u);if(t>0){const e=(r-t)/r;g+=c/t*e,y+=d/t*e}}}const x=Math.sqrt(g*g+y*y);x>0&&(g/=x,y/=x),a+=d*_n,l+=u*_n,a+=g*bn,l+=y*bn;const S=Math.sqrt(a*a+l*l);if(S>0&&(a/=S,l/=S),S>0){const e=Math.atan2(l,a)+Math.PI/2,i=this.getShortestAngleDelta(this.rotation,e),s=xn*t;Math.abs(i)<=s?this.rotation=e:this.rotation+=Math.sign(i)*s,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}const A=e*t,T=a*A,_=l*A;this.position.x+=T,this.position.y+=_,this.velocity.x=a*e,this.velocity.y=l*e;const w=qt;this.position.x=Math.max(-w,Math.min(w,this.position.x)),this.position.y=Math.max(-w,Math.min(w,this.position.y))}getShortestAngleDelta(t,e){let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=this.attackDamage)}useAbility(t){return!(this.abilityCooldown>0||(this.abilityCooldown=this.abilityCooldownTime,0))}getAndClearLastAbilityEffects(){const t=this.lastAbilityEffects;return this.lastAbilityEffects=[],t}applyStun(t){this.stunDuration=Math.max(this.stunDuration,t)}isStunned(){return this.stunDuration>0}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class Tl extends Al{constructor(t,e,s=[]){super(t,e,Re,Me,Le,ke,Xe,We),this.explorationTarget=null,this.explorationTimer=0,this.currentPathWaypointIndex=0,this.assignedPath=[],this.hasManualOrder=!1,this.lastShotLasers=[],this.pathHash="",this.hasReachedFinalWaypoint=!1,this.currentMoveSpeedPxPerSec=De,this.spriteLevel=1,this.assignedPath=s.map(t=>new i(t.x,t.y)),this.pathHash=this.generatePathHash(this.assignedPath)}generatePathHash(t){return 0===t.length?"no-path":t.map(t=>`${Math.round(t.x)},${Math.round(t.y)}`).join("|")}setManualRallyPoint(t){this.tryBlinkToward(t),this.rallyPoint=t,this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1}setManualTarget(t,e){this.manualTarget=t,this.target=t,this.clearMovementOrders(),this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1,e&&this.setManualRallyPoint(e)}setPath(t){this.assignedPath=t.map(t=>new i(t.x,t.y)),this.pathHash=this.generatePathHash(this.assignedPath),this.currentPathWaypointIndex=0,this.hasManualOrder=!0,this.hasReachedFinalWaypoint=!1,this.rallyPoint=null}tryBlinkToward(t){if(!this.owner.hasBlinkUpgrade||this.abilityCooldown>0)return;const e=t.x-this.position.x,i=t.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s<=0)return;const n=Math.min(Ye,s),o=e/s,r=i/s;this.position.x+=o*n,this.position.y+=r*n,this.velocity.x=0,this.velocity.y=0,this.abilityCooldown=this.abilityCooldownTime}getAssignedPathLength(){return this.assignedPath.length}getPathHash(){return this.pathHash}getHasReachedFinalWaypoint(){return this.hasReachedFinalWaypoint}getCurrentPathWaypointIndex(){return this.currentPathWaypointIndex}getCurrentMoveSpeedPxPerSec(){return this.currentMoveSpeedPxPerSec}hasActiveManualOrder(){return this.hasManualOrder}clearManualOrders(){this.hasManualOrder=!1,this.clearManualTarget(),this.clearMovementOrders(),this.hasReachedFinalWaypoint=!1}getAndClearLastShotProjectiles(){return[]}getAndClearLastShotLasers(){const t=this.lastShotLasers;return this.lastShotLasers=[],t}updateAI(t,e){var s,n;if(!this.hasManualOrder)if(this.assignedPath.length>0){const e=this.assignedPath[this.currentPathWaypointIndex],i=null!==(s=this.getStandoffPointForWaypoint(t,e))&&void 0!==s?s:e;if(this.position.distanceTo(i)<Sn*In){if(!(this.currentPathWaypointIndex<this.assignedPath.length-1))return this.rallyPoint=i,void(this.hasReachedFinalWaypoint=!0);{this.currentPathWaypointIndex++;const e=this.assignedPath[this.currentPathWaypointIndex];this.rallyPoint=null!==(n=this.getStandoffPointForWaypoint(t,e))&&void 0!==n?n:e}}else this.rallyPoint=i}else{let s=null,n=null;for(const i of e)if(i instanceof cl&&i.owner!==this.owner&&t.isObjectVisibleToPlayer(i.position,this.owner)){s=i.position,n=i.radius;break}if(!s)for(const e of t.players)if(e!==this.owner){for(const i of e.solarMirrors)if(t.isObjectVisibleToPlayer(i.position,this.owner)){s=i.position;break}if(s)break}if(!s){if(this.explorationTimer<=0||!this.explorationTarget||this.position.distanceTo(this.explorationTarget)<Sn){const t=Ja(),e=t.nextAngle(),s=t.nextFloat(300,800);this.explorationTarget=new i(this.position.x+Math.cos(e)*s,this.position.y+Math.sin(e)*s),this.explorationTimer=Be}s=this.explorationTarget}s&&(this.rallyPoint=n?this.getStructureStandoffPoint(s,n):s)}}getStandoffPointForWaypoint(t,e){for(const i of t.players){if(i.stellarForge&&e.distanceTo(i.stellarForge.position)<i.stellarForge.radius+this.collisionRadiusPx)return this.getStructureStandoffPoint(i.stellarForge.position,i.stellarForge.radius);for(const t of i.buildings)if(e.distanceTo(t.position)<t.radius+this.collisionRadiusPx)return this.getStructureStandoffPoint(t.position,t.radius)}return null}getGroupStopRadiusPx(t){let e=0;for(let i=0;i<t.length;i++){const s=t[i];s instanceof Tl&&s.owner===this.owner&&!s.isDead()&&s.pathHash===this.pathHash&&s.hasReachedFinalWaypoint&&(e+=1)}return qe+Je*Math.sqrt(e)}moveTowardRallyPoint(t,e,i,s=[]){if(this.assignedPath.length>0&&this.currentPathWaypointIndex===this.assignedPath.length-1&&!this.hasReachedFinalWaypoint&&null!==this.rallyPoint){const t=this.getGroupStopRadiusPx(i);if(this.position.distanceTo(this.rallyPoint)<=t)return this.rallyPoint=null,this.velocity.x=0,this.velocity.y=0,void(this.hasReachedFinalWaypoint=!0)}super.moveTowardRallyPoint(t,e,i,s)}update(t,e,i=[],s=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.explorationTimer-=t,this.owner.hasRegenUpgrade&&this.owner.stellarForge&&this.health<this.maxHealth&&this.position.distanceTo(this.owner.stellarForge.position)<=o&&(this.health=Math.min(this.maxHealth,this.health+Ke*t)),this.owner.hasStrafeUpgrade?this.currentMoveSpeedPxPerSec=De:this.currentMoveSpeedPxPerSec<De&&(this.currentMoveSpeedPxPerSec=Math.min(De,this.currentMoveSpeedPxPerSec+Oe*t)),this.moveTowardRallyPoint(t,this.currentMoveSpeedPxPerSec,i,s),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}getAttackDamage(){return this.attackDamage+(this.owner.hasAttackUpgrade?Fe:0)}attack(t){const e=this.getAttackDamage(),s=t.position.x-this.position.x,n=t.position.y-this.position.y;if(Math.sqrt(s*s+n*n)<=0)return;let o=e;t instanceof cl&&(o=Math.max(0,e-oi));const r=new rl(new i(this.position.x,this.position.y),new i(t.position.x,t.position.y),this.owner,o);this.lastShotLasers.push(r),t instanceof cl?t.health-=o:"takeDamage"in t&&t.takeDamage(o),this.owner.hasStrafeUpgrade||(this.currentMoveSpeedPxPerSec=0)}}class _l{constructor(t,e,s){this.absorbedCount=0,this.assignedStarlings=[],this.position=new i(t.x,t.y),this.owner=e,this.remainingSec=Fs,this.assignedStarlings=s,this.maxHealth=Ds,this.health=this.maxHealth,this.radius=ks}}class wl{constructor(t,e){this.position=t,this.owner=e,this.chargeTime=0,this.accumulatedEnergy=0,this.isCharging=!1,this.isComplete=!1,this.isCancelling=!1,this.hasDissipated=!1,this.completionRemainingSec=0,this.health=100,this.hasEmittedShockwave=!1,this.hasReceivedEnergyThisTick=!1}update(t){if(!this.hasDissipated){if(this.isCancelling){const e=w*t;return this.accumulatedEnergy=Math.max(0,this.accumulatedEnergy-e),this.chargeTime=this.accumulatedEnergy/c*h,void(this.accumulatedEnergy<=0&&(this.isCharging=!1,this.isComplete=!1,this.isCancelling=!1,this.hasDissipated=!0))}if(this.isComplete)return this.completionRemainingSec=Math.max(0,this.completionRemainingSec-t),void(this.completionRemainingSec<=0&&this.startCancellation());this.isCharging&&(this.chargeTime=this.accumulatedEnergy/c*h,this.accumulatedEnergy>=c&&(this.isComplete=!0,this.isCharging=!1,this.completionRemainingSec=E))}}addEnergy(t){!this.isCharging||this.isComplete||this.isCancelling||this.hasDissipated||(this.hasReceivedEnergyThisTick=!0,this.accumulatedEnergy+=t,this.chargeTime=this.accumulatedEnergy/c*h)}startCharging(){this.isCharging=!0,this.isCancelling=!1,this.hasDissipated=!1,this.chargeTime=0,this.accumulatedEnergy=0,this.completionRemainingSec=0}takeDamage(t){return this.health-=t,this.health<=0&&(this.cancel(),!0)}cancel(){this.startCancellation()}startCancellation(){this.isCancelling||this.hasDissipated||(this.isCancelling=!0,this.isCharging=!1,this.isComplete=!1,this.completionRemainingSec=0)}resetEnergyReceipt(){this.hasReceivedEnergyThisTick=!1}shouldEmitShockwave(){return!this.hasEmittedShockwave&&this.chargeTime>=1&&(this.hasEmittedShockwave=!0,!0)}}var El,bl,vl=function(t,e,i,s){return new(i||(i=Promise))(function(n,o){function r(t){try{l(s.next(t))}catch(t){o(t)}}function a(t){try{l(s.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}l((s=s.apply(t,e||[])).next())})};!function(t){t.GAME_COMMAND="game_command",t.GAME_STATE="game_state",t.PLAYER_JOIN="player_join",t.PLAYER_LEAVE="player_leave",t.LOBBY_UPDATE="lobby_update",t.GAME_START="game_start",t.PING="ping",t.PONG="pong"}(El||(El={})),function(t){t.CONNECTED="connected",t.DISCONNECTED="disconnected",t.MESSAGE_RECEIVED="message_received",t.PLAYER_JOINED="player_joined",t.PLAYER_LEFT="player_left",t.ERROR="error"}(bl||(bl={}));class Pl{constructor(t){this.connection=null,this.dataChannel=null,this.onMessageCallback=null,this.onConnectedCallback=null,this.onDisconnectedCallback=null,this.peerId=t}createPeerConnection(){return new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]})}createOffer(){return vl(this,void 0,void 0,function*(){this.connection=this.createPeerConnection(),this.setupConnectionHandlers(),this.dataChannel=this.connection.createDataChannel("gameData",{ordered:!0,maxRetransmits:3}),this.setupDataChannelHandlers(this.dataChannel);const t=yield this.connection.createOffer();return yield this.connection.setLocalDescription(t),yield this.waitForIceGathering(),this.connection.localDescription})}createAnswer(t){return vl(this,void 0,void 0,function*(){this.connection=this.createPeerConnection(),this.setupConnectionHandlers(),this.connection.ondatachannel=t=>{this.dataChannel=t.channel,this.setupDataChannelHandlers(this.dataChannel)},yield this.connection.setRemoteDescription(t);const e=yield this.connection.createAnswer();return yield this.connection.setLocalDescription(e),yield this.waitForIceGathering(),this.connection.localDescription})}waitForIceGathering(){return this.connection?new Promise(t=>{if("complete"===this.connection.iceGatheringState)return void t();const e=()=>{"complete"===this.connection.iceGatheringState&&(this.connection.removeEventListener("icegatheringstatechange",e),t())};this.connection.addEventListener("icegatheringstatechange",e)}):Promise.reject(new Error("Connection not initialized"))}setAnswer(t){return vl(this,void 0,void 0,function*(){if(!this.connection)throw new Error("Connection not initialized");yield this.connection.setRemoteDescription(t)})}addIceCandidate(t){return vl(this,void 0,void 0,function*(){if(!this.connection)throw new Error("Connection not initialized");yield this.connection.addIceCandidate(t)})}setupConnectionHandlers(){this.connection&&(this.connection.onicecandidate=t=>{t.candidate&&console.log("ICE candidate:",t.candidate)},this.connection.onconnectionstatechange=()=>{this.connection&&(console.log("Connection state:",this.connection.connectionState),"connected"===this.connection.connectionState?this.onConnectedCallback&&this.onConnectedCallback():"disconnected"!==this.connection.connectionState&&"failed"!==this.connection.connectionState&&"closed"!==this.connection.connectionState||this.onDisconnectedCallback&&this.onDisconnectedCallback())})}setupDataChannelHandlers(t){t.onopen=()=>{console.log("Data channel opened with peer:",this.peerId)},t.onclose=()=>{console.log("Data channel closed with peer:",this.peerId)},t.onerror=t=>{console.error("Data channel error:",t)},t.onmessage=t=>{try{const e=JSON.parse(t.data);this.onMessageCallback&&this.onMessageCallback(e)}catch(t){console.error("Failed to parse network message:",t)}}}sendMessage(t){if(this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(JSON.stringify(t))}catch(t){console.error("Failed to send message:",t)}else console.warn("Data channel not open, cannot send message")}onMessage(t){this.onMessageCallback=t}onConnected(t){this.onConnectedCallback=t}onDisconnected(t){this.onDisconnectedCallback=t}close(){this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.connection&&(this.connection.close(),this.connection=null)}isConnected(){return null!==this.dataChannel&&"open"===this.dataChannel.readyState}getPeerId(){return this.peerId}}class Cl{constructor(t){this.peers=new Map,this.eventListeners=new Map,this.lobby=null,this.isHost=!1,this.localPlayerId=t}createLobby(t,e,i=2){return this.isHost=!0,this.lobby={id:this.generateLobbyId(),name:t,hostId:this.localPlayerId,players:[{id:this.localPlayerId,username:e,isHost:!0,isReady:!0}],maxPlayers:i,gameStarted:!1},this.lobby}connectToPeer(t,e){return vl(this,void 0,void 0,function*(){const i=new Pl(t);this.setupPeerHandlers(i);const s=yield i.createAnswer(e);return this.peers.set(t,i),s})}createOfferForPeer(t){return vl(this,void 0,void 0,function*(){const e=new Pl(t);this.setupPeerHandlers(e);const i=yield e.createOffer();return this.peers.set(t,e),i})}completeConnection(t,e){return vl(this,void 0,void 0,function*(){const i=this.peers.get(t);if(!i)throw new Error(`No peer connection found for ${t}`);yield i.setAnswer(e)})}setupPeerHandlers(t){t.onMessage(e=>{this.handleMessage(t.getPeerId(),e)}),t.onConnected(()=>{console.log("Peer connected:",t.getPeerId()),this.emit(bl.CONNECTED,{peerId:t.getPeerId()})}),t.onDisconnected(()=>{console.log("Peer disconnected:",t.getPeerId()),this.removePeer(t.getPeerId()),this.emit(bl.DISCONNECTED,{peerId:t.getPeerId()})})}handleMessage(t,e){switch(console.log("Received message from",t,":",e),e.type){case El.PLAYER_JOIN:if(this.isHost&&this.lobby){const t=e.data;this.lobby.players.push(t),this.broadcastLobbyUpdate()}break;case El.LOBBY_UPDATE:this.lobby=e.data,this.emit(bl.PLAYER_JOINED,e.data);break;case El.GAME_START:this.lobby&&(this.lobby.gameStarted=!0);break;case El.GAME_COMMAND:default:this.emit(bl.MESSAGE_RECEIVED,e)}}sendToPeer(t,e){const i=this.peers.get(t);i?i.sendMessage(e):console.warn(`Cannot send to peer ${t}: not connected`)}broadcast(t){this.peers.forEach(e=>{e.sendMessage(t)})}broadcastLobbyUpdate(){if(!this.lobby)return;const t={type:El.LOBBY_UPDATE,senderId:this.localPlayerId,timestamp:Date.now(),data:this.lobby};this.broadcast(t)}sendGameCommand(t){const e={type:El.GAME_COMMAND,senderId:this.localPlayerId,timestamp:Date.now(),data:t};this.broadcast(e)}startGame(){if(!this.isHost||!this.lobby)return void console.warn("Only host can start the game");this.lobby.gameStarted=!0;const t={type:El.GAME_START,senderId:this.localPlayerId,timestamp:Date.now(),data:this.lobby};this.broadcast(t)}on(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}emit(t,e){const i=this.eventListeners.get(t);i&&i.forEach(t=>t(e))}removePeer(t){const e=this.peers.get(t);e&&(e.close(),this.peers.delete(t)),this.lobby&&(this.lobby.players=this.lobby.players.filter(e=>e.id!==t),this.isHost&&this.broadcastLobbyUpdate())}disconnect(){this.peers.forEach(t=>{t.close()}),this.peers.clear(),this.lobby=null,this.isHost=!1,this.eventListeners.clear()}generateLobbyId(){return`lobby_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}getLobby(){return this.lobby}getLocalPlayerId(){return this.localPlayerId}isLobbyHost(){return this.isHost}getPeerCount(){return this.peers.size}getPeerIds(){return Array.from(this.peers.keys())}}class Il{static generateHostCode(t,e,i){return vl(this,void 0,void 0,function*(){const s={type:"offer",sdp:t,playerId:e,username:i};return btoa(JSON.stringify(s))})}static parseHostCode(t){try{const e=JSON.parse(atob(t));if("offer"!==e.type)throw new Error("Invalid connection code: not an offer");return{offer:e.sdp,playerId:e.playerId||"host",username:e.username||"Host"}}catch(t){throw new Error("Invalid connection code format")}}static generateAnswerCode(t,e,i){return vl(this,void 0,void 0,function*(){const s={type:"answer",sdp:t,playerId:e,username:i};return btoa(JSON.stringify(s))})}static parseAnswerCode(t){try{const e=JSON.parse(atob(t));if("answer"!==e.type)throw new Error("Invalid connection code: not an answer");return{answer:e.sdp,playerId:e.playerId||"client",username:e.username||"Client"}}catch(t){throw new Error("Invalid connection code format")}}}class Rl{constructor(t,e,i){this.position=t,this.sides=e,this.size=i,this.vertices=[],this.rotation=0,this.generateVertices();const s=Ja();this.rotationSpeed=s.nextFloat(-.25,.25)}generateVertices(){this.vertices=[];const t=Ja();for(let e=0;e<this.sides;e++){const s=2*Math.PI*e/this.sides,n=t.nextFloat(.8,1.2),o=this.size*n;this.vertices.push(new i(Math.cos(s)*o,Math.sin(s)*o))}}getWorldVertices(){return this.vertices.map(t=>{const e=Math.cos(this.rotation),s=Math.sin(this.rotation);return new i(this.position.x+t.x*e-t.y*s,this.position.y+t.x*s+t.y*e)})}update(t){this.rotation+=this.rotationSpeed*t}containsPoint(t){const e=this.getWorldVertices();let i=!1;for(let s=0,n=e.length-1;s<e.length;n=s++){const o=e[s].x,r=e[s].y,a=e[n].x,l=e[n].y;r>t.y!=l>t.y&&t.x<(a-o)*(t.y-r)/(l-r)+o&&(i=!i)}return i}}class Ml{constructor(t,e,s,n=100,o=0,r=null){this.position=new i(t.x,t.y),this.damage=Math.round(e),this.remainingHealth=Math.round(o),this.creationTime=s,this.maxHealth=n,this.unitId=r;const a=Ja();this.velocity=new i(a.nextFloat(-10,10),-50)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}isExpired(t){return t-this.creationTime>2}getOpacity(t){const e=t-this.creationTime;return Math.max(0,1-e/2)}}class Ll{constructor(){this.players=[],this.playersByName=new Map,this.suns=[],this.spaceDust=[],this.warpGates=[],this.starlingMergeGates=[],this.starlingMergeGateExplosions=[],this.asteroids=[],this.muzzleFlashes=[],this.bulletCasings=[],this.bouncingBullets=[],this.abilityBullets=[],this.minionProjectiles=[],this.mortarProjectiles=[],this.laserBeams=[],this.impactParticles=[],this.influenceZones=[],this.influenceBallProjectiles=[],this.deployedTurrets=[],this.damageNumbers=[],this.crescentWaves=[],this.novaBombs=[],this.novaScatterBullets=[],this.stickyBombs=[],this.stickyLasers=[],this.disintegrationParticles=[],this.sparkleParticles=[],this.deathParticles=[],this.strikerTowerExplosions=[],this.gameTime=0,this.stateHash=0,this.stateHashTickCounter=0,this.isRunning=!1,this.countdownTime=Jt,this.isCountdownActive=!0,this.mirrorsMovedToSun=!1,this.mapSize=2e3,this.damageDisplayMode="damage",this.networkManager=null,this.localPlayerIndex=0,this.pendingCommands=[],this.MAX_PUSH_DISTANCE=10,this.PUSH_MULTIPLIER=15,this.dustSpatialHash=new Map,this.dustSpatialHashKeys=[]}update(t){var e,s;this.gameTime+=t,this.starlingMergeGateExplosions.length=0,this.networkManager&&this.processPendingNetworkCommands(),this.isCountdownActive&&(this.countdownTime-=t,this.mirrorsMovedToSun||(this.initializeMirrorMovement(),this.mirrorsMovedToSun=!0),this.countdownTime<=0&&(this.isCountdownActive=!1,this.countdownTime=0));for(const t of this.warpGates)t.resetEnergyReceipt();for(const e of this.asteroids)e.update(t);this.isCountdownActive||this.updateAi(t);for(const n of this.players)if(!n.isDefeated()){if(n.solarMirrors.length>0&&(n.solarMirrors=n.solarMirrors.filter(t=>t.health>0)),n.stellarForge){const o=new i(n.stellarForge.position.x,n.stellarForge.position.y);if(n.stellarForge.updateLightStatus(n.solarMirrors,this.suns,this.asteroids,this.players),this.isCountdownActive||(n.stellarForge.update(t,this),this.checkCollision(n.stellarForge.position,n.stellarForge.radius,n.stellarForge)&&(n.stellarForge.position=o,n.stellarForge.targetPosition=null,n.stellarForge.velocity=new i(0,0)),this.applyDustPushFromMovingEntity(n.stellarForge.position,n.stellarForge.velocity,st,nt,this.getPlayerImpactColor(n),t)),!this.isCountdownActive){const t=n.stellarForge.shouldCrunch();if(t>0){const o=this.getStarlingCountForPlayer(n),r=Math.max(0,Qe-o),a=Math.min(Math.floor(t/pi),r),l=t-a*pi;if(l>0&&n.stellarForge.addPendingEnergy(l),a>0){for(let t=0;t<a;t++){const o=2*Math.PI*t/a,r=n.stellarForge.radius+We+5,l=new i(n.stellarForge.position.x+Math.cos(o)*r,n.stellarForge.position.y+Math.sin(o)*r),h=new Tl(l,n,null!==(s=null===(e=n.stellarForge)||void 0===e?void 0:e.minionPath)&&void 0!==s?s:[]);n.units.push(h),n.unitsCreated++}console.log(`${n.name} forge crunch spawned ${a} Starlings with ${t.toFixed(0)} energy`)}}}if(!this.isCountdownActive){const e=n.stellarForge.advanceHeroProduction(t);if(e){const t=n.stellarForge.radius+An+5,s=new i(n.stellarForge.position.x,n.stellarForge.position.y+t),o=this.createHeroUnit(e,s,n);o&&(n.units.push(o),n.unitsCreated++,console.log(`${n.name} forged hero ${e}`))}}}for(const e of n.solarMirrors){const s=new i(e.position.x,e.position.y);e.update(t,this),this.checkCollision(e.position,20,e)&&(e.position=s,e.velocity=new i(0,0)),this.applyDustPushFromMovingEntity(e.position,e.velocity,et,it,this.getPlayerImpactColor(n),t),e.linkedStructure instanceof dl&&e.linkedStructure.isDestroyed()&&e.setLinkedStructure(null),e.linkedStructure instanceof cl&&e.linkedStructure!==n.stellarForge&&e.setLinkedStructure(null);const l=e.getLinkedStructure(n.stellarForge);if(e.updateReflectionAngle(l,this.suns,this.asteroids,t),e.hasLineOfSightToLight(this.suns,this.asteroids)&&l){const i=e.generateEnergy(t);if(l instanceof cl&&n.stellarForge&&e.hasLineOfSightToForge(n.stellarForge,this.asteroids,this.players))n.addEnergy(i),n.stellarForge.addPendingEnergy(i);else if(l instanceof dl&&e.hasLineOfSightToStructure(l,this.asteroids,this.players))l.isComplete||l.addEnergy(i);else if(l instanceof wl&&e.hasLineOfSightToStructure(l,this.asteroids,this.players)){const t=!l.isComplete;l.isCharging&&!l.isComplete&&l.addEnergy(i),t&&l.isComplete&&n.stellarForge&&e.setLinkedStructure(n.stellarForge)}}if(n.stellarForge&&e.health<Zt&&n.stellarForge.position.distanceTo(e.position)<=o){e.health=Math.min(Zt,e.health+te*t);const s=Ja();if(s.next()<2.5*t){const t=s.nextAngle(),o=s.nextFloat(0,25),l=new i(e.position.x+Math.cos(t)*o,e.position.y+Math.sin(t)*o),h=new i(s.nextFloat(-15,15),s.nextFloat(-15,15)-20),c=n===this.players[0]?r:a;this.sparkleParticles.push(new ll(l,h,.8,c,s.nextFloat(2,4)))}}}}for(const t of this.warpGates)!t.isCharging||t.isComplete||t.isCancelling||t.hasReceivedEnergyThisTick||t.startCancellation();this.updateSpaceDust(t);const n=[],l=[];for(const t of this.players)if(!t.isDefeated()){n.push(...t.units),l.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&l.push(e);for(const e of this.starlingMergeGates)e.owner===t&&e.health>0&&l.push(e);t.stellarForge&&l.push(t.stellarForge)}for(const e of this.players){if(e.isDefeated())continue;const s=[];for(const t of this.players)if(t!==e&&!t.isDefeated()){s.push(...t.units),s.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&s.push(e);for(const e of this.starlingMergeGates)e.owner===t&&e.health>0&&s.push(e);t.stellarForge&&s.push(t.stellarForge)}if(!this.isCountdownActive)for(const o of e.units){o instanceof Tl&&o.updateAI(this,s),o.update(t,s,n,this.asteroids);for(const t of this.players)if(t!==o.owner)for(const e of t.buildings)if(e instanceof xl&&e.shieldActive&&e.isComplete){const t=o.position.x-e.position.x,i=o.position.y-e.position.y,s=Math.sqrt(t*t+i*i);if(s<e.shieldRadius){const n=e.shieldRadius-s;if(s>$){const e=t/s,r=i/s;o.position.x+=e*n,o.position.y+=r*n}else o.position.x+=n;o.velocity.x=0,o.velocity.y=0}}if(o instanceof Tl&&this.applyDustPushFromMovingEntity(o.position,o.velocity,ot,rt,this.getPlayerImpactColor(o.owner),t),o instanceof kl)for(const e of o.getProjectiles())if(e.isAttacking){const i=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,L,i*F,this.getPlayerImpactColor(o.owner),t)}if(o instanceof Fl){const t=o.getAndClearLastShotEffects();t.muzzleFlash&&this.muzzleFlashes.push(t.muzzleFlash),t.casing&&this.bulletCasings.push(t.casing),t.bouncingBullet&&this.bouncingBullets.push(t.bouncingBullet)}const e=o.getAndClearLastAbilityEffects();if(this.abilityBullets.push(...e),o instanceof Tl){const t=o.getAndClearLastShotLasers();if(t.length>0){this.laserBeams.push(...t);for(const e of t)for(let t=0;t<$e;t++){const s=2*Math.PI*t/$e,n=new i(Math.cos(s)*Ve,Math.sin(s)*Ve);this.impactParticles.push(new al(new i(e.endPos.x,e.endPos.y),n,ze,e.owner.faction))}}}if(o instanceof Gl){const t=o.getAndClearProjectile();t&&this.influenceBallProjectiles.push(t)}if(o instanceof Yl){const t=o.getAndClearLastShotProjectiles();t.length>0&&this.mortarProjectiles.push(...t)}if(o instanceof Zl){const t=o.getCrescentWave();t&&!this.crescentWaves.includes(t)&&this.crescentWaves.push(t)}if(o instanceof eh){const t=o.getAndClearBomb();t&&this.novaBombs.push(t)}if(o instanceof nh){const t=o.getAndClearBombToCreate();t&&this.stickyBombs.push(t);const e=o.getAndClearLasersToCreate();e.length>0&&this.stickyLasers.push(...e);const i=o.getAndClearParticlesToCreate();i.length>0&&this.disintegrationParticles.push(...i)}if(o instanceof Bl){o.updateBeamSegments(t);for(const e of o.getBeamSegments())this.applyFluidForceFromBeam(e.startPos,e.endPos,O,N,this.getPlayerImpactColor(o.owner),t);o.abilityCooldown>o.abilityCooldownTime-.1&&o.drillDirection&&(this.processRayBeamAbility(o),o.drillDirection=null)}if(o instanceof $l&&o.abilityCooldown>o.abilityCooldownTime-.1&&this.processTurretDeployment(o),o instanceof Ql&&this.updateSpotlightAbility(o,s,t),o instanceof zl&&o.isDrilling&&(o.updateDrilling(t),this.processDrillerCollisions(o,t)),o instanceof jl&&o.updateTimers(t),o instanceof kl)for(const t of o.getProjectiles())if(t.isAttacking){let e=!1;for(const i of this.players){for(const s of i.buildings)if(s instanceof gl){if(s.owner===t.owner)continue;if(s.absorbProjectile(t)){t.isAttacking=!1,t.trail=[],t.targetEnemy=null,e=!0;break}}if(e)break}}}this.isCountdownActive||this.updateStarlingMergeGatesForPlayer(e,t),this.isCountdownActive||this.processStarlingSacrificesForPlayer(e);const h=e.units.filter(t=>t.isDead());for(const t of h){const i=e===this.players[0]?r:a;this.createDeathParticles(t,i)}if(e.unitsLost+=h.length,e.units=e.units.filter(t=>!t.isDead()),!this.isCountdownActive)for(const i of e.buildings){if(i.update(t,s,n,this.asteroids,l,qt),i instanceof fl&&i.targetPosition&&i.countdownTimer<=.001&&i.isMissileReady()){const t=i.targetPosition;i.fireMissile(t,s,t=>this.isPointInShadow(t),(t,e)=>this.isPositionVisibleByPlayerUnits(t,e),e.units)&&this.strikerTowerExplosions.push({position:t,timestamp:this.gameTime})}if(i instanceof ul||i instanceof pl){const t=i.getAndClearLastShotEffects();t.muzzleFlash&&this.muzzleFlashes.push(t.muzzleFlash),t.casing&&this.bulletCasings.push(t.casing),t.bouncingBullet&&this.bouncingBullets.push(t.bouncingBullet)}if(i instanceof ul||i instanceof ml){const t=i.getAndClearLastShotLasers();t.length>0&&this.laserBeams.push(...t)}if(i instanceof yl){if(i.currentProduction){const s=this.getMirrorLightOnStructure(e,i);if(s>0){const e=s/10*(1/rn)*t;i.addProductionProgress(e)}}const s=i.getCompletedProduction();s===vs?i.upgradeStrafe():s===Ps?i.upgradeRegen():s===Cs?i.upgradeAttack():s===Ms&&i.upgradeBlink()}}if(!this.isCountdownActive)for(const i of e.buildings)if(!i.isComplete)if(e.stellarForge&&i.position.distanceTo(e.stellarForge.position)<=o&&e.stellarForge){const e=1/rn*t;i.addBuildProgress(e)}else{const s=this.getMirrorLightOnStructure(e,i);if(s>0){const e=s/10*(1/rn)*t;i.addBuildProgress(e)}}const c=e.buildings.filter(t=>t.isDestroyed());for(const t of c){const i=e===this.players[0]?r:a;this.createDeathParticles(t,i)}e.buildings=e.buildings.filter(t=>!t.isDestroyed())}this.isCountdownActive||(this.resolveUnitCollisions(n),this.resolveUnitObstacleCollisions(n)),this.stateHashTickCounter+=1,this.stateHashTickCounter%Ln===0&&this.updateStateHash();for(const e of this.muzzleFlashes)e.update(t);this.muzzleFlashes=this.muzzleFlashes.filter(t=>!t.shouldDespawn());for(const e of this.bulletCasings){e.update(t);for(const t of this.spaceDust)if(e.position.distanceTo(t.position)<gn){const s=new i(t.position.x-e.position.x,t.position.y-e.position.y).normalize();t.applyForce(new i(s.x*yn,s.y*yn)),e.applyCollision(new i(-s.x*yn,-s.y*yn))}}this.bulletCasings=this.bulletCasings.filter(t=>!t.shouldDespawn());for(const e of this.bouncingBullets)e.update(t);this.bouncingBullets=this.bouncingBullets.filter(t=>!t.shouldDespawn());for(const e of this.abilityBullets){e.update(t);let i=!1;for(const t of this.players){for(const s of t.units)if(s instanceof Zl&&s.isPositionInShield(e.position)&&e.owner!==t){i=!0,e.lifetime=e.maxLifetime;break}if(i)break}if(i)continue;let s=!1;for(const t of this.players){for(const i of t.buildings)if(i instanceof xl&&i.shieldActive&&i.isComplete&&e.owner!==t&&i.isEnemyBlocked(e.position)){i.damageShield(e.damage),e.lifetime=e.maxLifetime,s=!0;break}if(s)break}if(s)continue;e.isHealingBomb&&e.healingBombOwner&&e.shouldDespawn()&&e.healingBombOwner.explodeHealingBomb(e.position);const n=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,P,n*C,this.getPlayerImpactColor(e.owner),t);for(const t of this.players)if(t!==e.owner&&!e.isHealingBomb){for(const i of t.units)if(e.checkHit(i)){let t=e.damage;if(e.isBeamProjectile&&e.beamOwner){const s=e.beamOwner,n=s.position.distanceTo(i.position),o=1+n*nr;t=Math.round(ir*o),s.lastBeamDamage=t,s.lastBeamDistance=n,s.lastBeamMultiplier=o,s.lastBeamTime=this.gameTime}i.takeDamage(t);const s=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,t,i.maxHealth,i.health,s),e.lifetime=e.maxLifetime;break}if(!e.shouldDespawn()){for(const i of t.solarMirrors)if(!(i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`mirror_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,Zt,i.health,s),e.lifetime=e.maxLifetime;break}if(!e.shouldDespawn()){for(const i of this.starlingMergeGates)if(!(i.owner!==t||i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`merge_gate_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,s),e.lifetime=e.maxLifetime;break}if(!e.shouldDespawn()&&t.stellarForge&&e.checkHit(t.stellarForge)){let i=e.damage;if(e.isBeamProjectile&&e.beamOwner){const s=e.beamOwner,n=s.position.distanceTo(t.stellarForge.position),o=1+n*nr;i=Math.round(ir*o),s.lastBeamDamage=i,s.lastBeamDistance=n,s.lastBeamMultiplier=o,s.lastBeamTime=this.gameTime}t.stellarForge.health-=i;const s=`forge_${t.stellarForge.position.x}_${t.stellarForge.position.y}_${t.name}`;this.addDamageNumber(t.stellarForge.position,i,ni,t.stellarForge.health,s),e.lifetime=e.maxLifetime}}}}}this.abilityBullets=this.abilityBullets.filter(t=>!t.shouldDespawn());for(const e of this.mortarProjectiles){e.update(t);let i=!1;for(const t of this.players)if(t!==e.owner){for(const s of t.units)if(e.checkHit(s)){i=!0;break}if(i)break}if(i||e.shouldDespawn()){const t=[];for(const i of this.players)if(i!==e.owner){t.push(...i.units),i.stellarForge&&i.stellarForge.health>0&&t.push(i.stellarForge);for(const e of i.buildings)e.health>0&&t.push(e)}const i=e.applySplashDamage(t);for(const t of i){const i=1-e.position.distanceTo(t.position)/e.splashRadius*(1-Cr),s=Math.round(e.damage*i);if(t instanceof Al){const e=`unit_${t.position.x}_${t.position.y}_${t.owner.name}`;this.addDamageNumber(t.position,s,t.maxHealth,t.health,e)}else if("isBuilding"in t&&t.isBuilding){const e=`building_${t.position.x}_${t.position.y}`;this.addDamageNumber(t.position,s,t.maxHealth,t.health,e)}else if("isForge"in t&&t.isForge){const e=`forge_${t.position.x}_${t.position.y}`;this.addDamageNumber(t.position,s,t.maxHealth,t.health,e)}}e.lifetime=e.maxLifetime}}this.mortarProjectiles=this.mortarProjectiles.filter(t=>!t.shouldDespawn());for(const e of this.minionProjectiles){e.update(t);let i=!1;for(const t of this.players){for(const s of t.units)if(s instanceof Zl&&s.isPositionInShield(e.position)&&e.owner!==t){i=!0,e.distanceTraveledPx=e.maxRangePx;break}if(i)break}if(i)continue;let s=!1;for(const t of this.players){for(const i of t.buildings)if(i instanceof xl&&i.shieldActive&&i.isComplete&&e.owner!==t&&i.isEnemyBlocked(e.position)){const t="damage"in e?e.damage:M;i.damageShield(t),e.distanceTraveledPx=e.maxRangePx,s=!0;break}if(s)break}if(s)continue;const n=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,I,n*R,this.getPlayerImpactColor(e.owner),t);let o=!1;for(const t of this.players){for(const i of t.buildings)if(i instanceof gl){if(i.owner===e.owner)continue;if(i.absorbProjectile(e)){e.distanceTraveledPx=e.maxRangePx,o=!0;break}}if(o)break}if(o)continue;let r=!1;for(const t of this.players)if(t!==e.owner){for(const i of t.units)if(e.checkHit(i)){i.takeDamage(e.damage);const t=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,t),r=!0;break}if(r)break;for(const i of t.solarMirrors)if(!(i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`mirror_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,Zt,i.health,s),r=!0;break}if(r)break;for(const i of this.starlingMergeGates)if(!(i.owner!==t||i.health<=0)&&e.checkHit(i)){i.health-=e.damage;const s=`merge_gate_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,s),r=!0;break}if(r)break;for(const i of t.buildings)if(e.checkHit(i)){i.health-=e.damage;const s=`building_${i.position.x}_${i.position.y}_${t.name}`;this.addDamageNumber(i.position,e.damage,i.maxHealth,i.health,s),r=!0;break}if(r)break;if(t.stellarForge&&e.checkHit(t.stellarForge)){t.stellarForge.health-=e.damage;const i=`forge_${t.stellarForge.position.x}_${t.stellarForge.position.y}_${t.name}`;this.addDamageNumber(t.stellarForge.position,e.damage,ni,t.stellarForge.health,i),r=!0;break}}r&&(e.distanceTraveledPx=e.maxRangePx)}this.minionProjectiles=this.minionProjectiles.filter(t=>!t.shouldDespawn()),this.laserBeams=this.laserBeams.filter(e=>!e.update(t));for(const e of this.impactParticles)e.update(t);this.impactParticles=this.impactParticles.filter(t=>!t.shouldDespawn());for(const e of this.sparkleParticles)e.update(t);this.sparkleParticles=this.sparkleParticles.filter(t=>!t.shouldDespawn());for(const e of this.deathParticles)e.update(t);this.deathParticles=this.deathParticles.filter(t=>!t.shouldDespawn()),this.strikerTowerExplosions=this.strikerTowerExplosions.filter(t=>this.gameTime-t.timestamp<1),this.influenceZones=this.influenceZones.filter(e=>!e.update(t));for(const e of this.influenceBallProjectiles){e.update(t);const s=Math.sqrt(Math.pow(e.velocity.x,2)+Math.pow(e.velocity.y,2));this.applyFluidForceFromMovingObject(e.position,e.velocity,k,s*D,this.getPlayerImpactColor(e.owner),t);let n=!1;for(const t of this.players){for(const i of t.buildings)if(i instanceof gl){if(i.owner===e.owner)continue;if(i.absorbProjectile(e)){e.lifetime=e.maxLifetime,n=!0;break}}if(n)break}if(!n&&e.shouldExplode()){const t=new Hl(new i(e.position.x,e.position.y),e.owner);this.influenceZones.push(t)}}this.influenceBallProjectiles=this.influenceBallProjectiles.filter(t=>!t.shouldExplode());for(const e of this.crescentWaves){e.update(t);for(const t of this.players)for(const i of t.units)!e.affectedUnits.has(i)&&e.isPointInWave(i.position)&&(i.applyStun(sa),e.affectedUnits.add(i));this.abilityBullets=this.abilityBullets.filter(t=>!e.isPointInWave(t.position)),this.minionProjectiles=this.minionProjectiles.filter(t=>!e.isPointInWave(t.position)),this.mortarProjectiles=this.mortarProjectiles.filter(t=>!e.isPointInWave(t.position)),this.influenceBallProjectiles=this.influenceBallProjectiles.filter(t=>!e.isPointInWave(t.position)),this.bouncingBullets=this.bouncingBullets.filter(t=>!e.isPointInWave(t.position))}this.crescentWaves=this.crescentWaves.filter(t=>!t.shouldDespawn());for(const e of this.novaBombs){e.update(t);for(const t of this.asteroids)if(e.position.distanceTo(t.position)<t.size+wa){const i=e.position.x-t.position.x,s=e.position.y-t.position.y,n=Math.sqrt(i*i+s*s);if(n>0){const o=i/n,r=s/n;e.bounce(o,r),e.position.x=t.position.x+o*(t.size+wa),e.position.y=t.position.y+r*(t.size+wa)}}const s=qt;e.position.x<=-s?(e.bounce(1,0),e.position.x=-s):e.position.x>=s&&(e.bounce(-1,0),e.position.x=s),e.position.y<=-s?(e.bounce(0,1),e.position.y=-s):e.position.y>=s&&(e.bounce(0,-1),e.position.y=s);for(const t of this.abilityBullets)if(t.owner!==e.owner&&e.position.distanceTo(t.position)<wa){e.takeDamage();break}for(const t of this.mortarProjectiles)if(t.owner!==e.owner&&e.position.distanceTo(t.position)<wa){e.takeDamage();break}if(e.shouldExplode()){const t=e.getScatterDirection();if(t){const s=Math.atan2(t.y,t.x),n=xa/2;for(let t=0;t<Sa;t++){const o=s-n+t/(Sa-1)*xa,r=new i(Math.cos(o)*Aa,Math.sin(o)*Aa);this.novaScatterBullets.push(new sh(new i(e.position.x,e.position.y),r,e.owner))}for(const t of this.players)if(t!==e.owner){for(const i of t.units)e.position.distanceTo(i.position)<=ma&&(i.health-=fa);for(const i of t.buildings)e.position.distanceTo(i.position)<=ma&&(i.health-=fa)}e.novaUnit&&e.novaUnit.getActiveBomb()===e&&e.novaUnit.clearActiveBomb()}}}this.novaBombs=this.novaBombs.filter(t=>!t.shouldExplode());for(const e of this.novaScatterBullets){e.update(t);for(const t of this.players)if(t!==e.owner)for(const i of t.units)if(e.checkHit(i)){i.health-=e.damage,e.lifetime=e.maxLifetime;break}}this.novaScatterBullets=this.novaScatterBullets.filter(t=>!t.shouldDespawn());for(const e of this.stickyBombs){if(e.update(t),!e.isStuck){for(const t of this.asteroids)if(e.position.distanceTo(t.position)<t.size+La){const s=e.position.x-t.position.x,n=e.position.y-t.position.y,o=Math.sqrt(s*s+n*n);if(o>0){const r=new i(s/o,n/o);e.stickToSurface("asteroid",r,t),e.position.x=t.position.x+r.x*(t.size+Da),e.position.y=t.position.y+r.y*(t.size+Da)}break}if(!e.isStuck)for(const t of this.players){for(const s of t.buildings)if(e.position.distanceTo(s.position)<La){const t=e.position.x-s.position.x,n=e.position.y-s.position.y,o=Math.sqrt(t*t+n*n);if(o>0){const r=new i(t/o,n/o);e.stickToSurface("structure",r,s)}break}if(e.isStuck)break;for(const s of t.solarMirrors)if(e.position.distanceTo(s.position)<La){const t=e.position.x-s.position.x,n=e.position.y-s.position.y,o=Math.sqrt(t*t+n*n);if(o>0){const r=new i(t/o,n/o);e.stickToSurface("structure",r,s)}break}if(e.isStuck)break;if(t.stellarForge&&e.position.distanceTo(t.stellarForge.position)<La){const s=e.position.x-t.stellarForge.position.x,n=e.position.y-t.stellarForge.position.y,o=Math.sqrt(s*s+n*n);if(o>0){const r=new i(s/o,n/o);e.stickToSurface("structure",r,t.stellarForge)}break}if(e.isStuck)break}if(!e.isStuck){const t=qt,s=La;e.position.x<=-t+s?(e.stickToSurface("edge",new i(1,0)),e.position.x=-t+Da):e.position.x>=t-s?(e.stickToSurface("edge",new i(-1,0)),e.position.x=t-Da):e.position.y<=-t+s?(e.stickToSurface("edge",new i(0,1)),e.position.y=-t+Da):e.position.y>=t-s&&(e.stickToSurface("edge",new i(0,-1)),e.position.y=t-Da)}}e.shouldDisintegrate()&&e.slyOwner.onBombDestroyed(e)}this.stickyBombs=this.stickyBombs.filter(t=>!t.shouldDespawn());for(const e of this.stickyLasers){e.update(t);for(const t of this.players)if(t!==e.owner){for(const i of t.units)e.checkHit(i)&&(i.health-=e.damage,this.damageNumbers.push(new Ml(i.position,e.damage,this.gameTime)));for(const i of t.buildings)e.checkHit(i)&&(i.health-=e.damage,this.damageNumbers.push(new Ml(i.position,e.damage,this.gameTime)));for(const i of t.solarMirrors)e.checkHit(i)&&(i.health-=e.damage,this.damageNumbers.push(new Ml(i.position,e.damage,this.gameTime)));t.stellarForge&&e.checkHit(t.stellarForge)&&(t.stellarForge.health-=e.damage,this.damageNumbers.push(new Ml(t.stellarForge.position,e.damage,this.gameTime)))}}this.stickyLasers=this.stickyLasers.filter(t=>!t.shouldDespawn());for(const e of this.disintegrationParticles)e.update(t);this.disintegrationParticles=this.disintegrationParticles.filter(t=>!t.shouldDespawn());const h=[];for(const t of this.players)if(!t.isDefeated()){h.push(...t.units),h.push(...t.buildings);for(const e of t.solarMirrors)e.health>0&&h.push(e);t.stellarForge&&h.push(t.stellarForge)}for(const e of this.deployedTurrets){const i=h.filter(t=>t.owner!==e.owner);e.update(t,i)}this.deployedTurrets=this.deployedTurrets.filter(t=>!t.isDead());for(const e of this.damageNumbers)e.update(t);this.damageNumbers=this.damageNumbers.filter(t=>!t.isExpired(this.gameTime))}updateSpaceDust(t){this.applyDustRepulsion(t);for(const e of this.spaceDust){e.update(t);let i=null;for(let t=0;t<this.players.length;t++){const s=this.players[t];if(s.stellarForge&&!s.isDefeated()){const n=e.position.distanceTo(s.stellarForge.position);if(n<o){const e=0===t?r:a;(!i||n<i.distance)&&(i={color:e,distance:n})}}}if(i){const t=1-i.distance/o;e.updateColor(i.color,t)}else e.updateColor(null,0)}for(const e of this.warpGates)if(e.isCharging&&e.chargeTime>=d)for(const s of this.spaceDust){const n=s.position.distanceTo(e.position);if(n<p&&n>g){const o=new i(e.position.x-s.position.x,e.position.y-s.position.y).normalize(),r=new i(-o.y,o.x),a=new i(o.x*y+r.x*f,o.y*y+r.y*f);s.applyForce(new i(a.x*t/n,a.y*t/n))}}for(const e of this.players)if(e.stellarForge&&!e.isDefeated()){const s=e.stellarForge.getCurrentCrunch();if(s&&s.isActive())for(const e of this.spaceDust){const n=e.position.distanceTo(s.position);if("suck"===s.phase&&n<hi){if(n>5){const o=new i(s.position.x-e.position.x,s.position.y-e.position.y).normalize(),r=di/Math.sqrt(n);e.applyForce(new i(o.x*r*t,o.y*r*t))}}else if("wave"===s.phase&&n<ci&&n>5){const o=new i(e.position.x-s.position.x,e.position.y-s.position.y).normalize(),r=s.getPhaseProgress()*ci,a=Math.abs(n-r),l=50,h=Math.exp(-a/l),c=ui*h;e.applyForce(new i(o.x*c*t,o.y*c*t))}}}for(const e of this.players)for(const i of e.buildings)i instanceof gl&&i.applyDustSwirl(this.spaceDust,t)}applyDustRepulsion(t){const e=X,i=Y,s=i*i,n=q;for(let t=0;t<this.dustSpatialHashKeys.length;t++){const e=this.dustSpatialHashKeys[t],i=this.dustSpatialHash.get(e);i&&(i.length=0)}this.dustSpatialHashKeys.length=0;for(let t=0;t<this.spaceDust.length;t++){const i=this.spaceDust[t],s=Math.floor(i.position.x/e)<<16^65535&Math.floor(i.position.y/e);let n=this.dustSpatialHash.get(s);n||(n=[],this.dustSpatialHash.set(s,n)),0===n.length&&this.dustSpatialHashKeys.push(s),n.push(t)}for(let o=0;o<this.spaceDust.length;o++){const r=this.spaceDust[o],a=Math.floor(r.position.x/e),l=Math.floor(r.position.y/e);let h=0,c=0;for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){const d=a+e<<16^l+t&65535,u=this.dustSpatialHash.get(d);if(u)for(let t=0;t<u.length;t++){const e=u[t];if(e===o)continue;const a=this.spaceDust[e],l=r.position.x-a.position.x,d=r.position.y-a.position.y,p=l*l+d*d;if(p>0&&p<s){const t=Math.sqrt(p),e=1-t/i,s=e*e*n;h+=l/t*s,c+=d/t*s}}}0===h&&0===c||(r.velocity.x+=h*t,r.velocity.y+=c*t)}}updateAi(t){for(const t of this.players){if(!t.isAi||t.isDefeated())continue;const e=this.getEnemiesForPlayer(t);this.updateAiMirrorsForPlayer(t),this.updateAiMirrorPurchaseForPlayer(t),this.updateAiDefenseForPlayer(t,e),this.updateAiHeroProductionForPlayer(t),this.updateAiStructuresForPlayer(t,e)}}updateStarlingMergeGatesForPlayer(t,e){for(let s=this.starlingMergeGates.length-1;s>=0;s--){const n=this.starlingMergeGates[s];if(n.owner!==t)continue;if(n.health<=0){this.releaseStarlingMergeGate(n,t),this.starlingMergeGateExplosions.push(new i(n.position.x,n.position.y)),this.starlingMergeGates.splice(s,1);continue}n.remainingSec=Math.max(0,n.remainingSec-e);const o=n.assignedStarlings;let r=0;for(let t=0;t<o.length;t++){const e=o[t];e.isDead()||(e.clearManualTarget(),e.setManualRallyPoint(n.position),e.position.distanceTo(n.position)<=ks?(e.health=0,n.absorbedCount+=1):(o[r]=e,r+=1))}o.length=r,n.remainingSec<=0&&(n.absorbedCount>=Ls?(this.starlingMergeGateExplosions.push(new i(n.position.x,n.position.y)),t.solarMirrors.push(new Ka(new i(n.position.x,n.position.y),t))):(this.releaseStarlingMergeGate(n,t),this.starlingMergeGateExplosions.push(new i(n.position.x,n.position.y))),this.starlingMergeGates.splice(s,1))}}processStarlingSacrificesForPlayer(t){const e=pi*gi;if(!(e<=0))for(const i of t.buildings)if(i instanceof yl&&i.isComplete&&i.currentProduction)for(const s of t.units)if(s instanceof Tl&&!s.isDead()&&s.getManualTarget()===i){if(!i.currentProduction)break;s.position.distanceTo(i.position)>i.radius+s.collisionRadiusPx||(i.addProductionEnergyBoost(e),s.health=0)}}releaseStarlingMergeGate(t,e){var s,n;const o=t.absorbedCount;if(o>0){const r=this.getStarlingCountForPlayer(e),a=Math.max(0,Qe-r),l=Math.min(o,a),h=ks+We+4;for(let o=0;o<l;o++){const r=2*Math.PI*o/l,a=new i(t.position.x+Math.cos(r)*h,t.position.y+Math.sin(r)*h),c=new Tl(a,e,null!==(n=null===(s=e.stellarForge)||void 0===s?void 0:s.minionPath)&&void 0!==n?n:[]);e.units.push(c),e.unitsCreated++}}for(const e of t.assignedStarlings)e.isDead()||e.clearManualOrders();t.assignedStarlings.length=0}getEnemiesForPlayer(t){const e=[];for(const i of this.players)if(i!==t&&!i.isDefeated()){e.push(...i.units),e.push(...i.buildings);for(const t of i.solarMirrors)t.health>0&&e.push(t);for(const t of this.starlingMergeGates)t.owner===i&&t.health>0&&e.push(t);i.stellarForge&&e.push(i.stellarForge)}return e}getStarlingCountForPlayer(t){let e=0;for(const i of t.units)i instanceof Tl&&(e+=1);return e}updateAiMirrorsForPlayer(t){if(this.gameTime<t.aiNextMirrorCommandSec)return;if(t.aiNextMirrorCommandSec=this.gameTime+Bs,!t.stellarForge||0===t.solarMirrors.length)return;const e=this.getClosestSunToPoint(t.stellarForge.position);if(!e)return;const s=t.solarMirrors.length,n=Math.atan2(t.stellarForge.position.y-e.position.y,t.stellarForge.position.x-e.position.x)-Xs*(s-1)/2,o=e.radius+Ys;for(let r=0;r<s;r++){const s=t.solarMirrors[r],a=n+Xs*r,l=new i(e.position.x+Math.cos(a)*o,e.position.y+Math.sin(a)*o);s.position.distanceTo(l)>qs&&s.setTarget(l)}}updateAiMirrorPurchaseForPlayer(t){}updateAiDefenseForPlayer(t,e){if(this.gameTime<t.aiNextDefenseCommandSec)return;t.aiNextDefenseCommandSec=this.gameTime+Us;const s=this.findAiThreat(t,e);if(s){const e=s.enemy.position;for(const s of t.units)s.isHero?s.rallyPoint=new i(e.x,e.y):s instanceof Tl&&s.setManualRallyPoint(new i(e.x,e.y));return}if(!t.stellarForge)return;if(t.aiStrategy===ja.WAVES){if(!(t.units.length>=Vs)){for(const e of t.units)e.isHero?e.rallyPoint=new i(t.stellarForge.position.x,t.stellarForge.position.y):e instanceof Tl&&e.setManualRallyPoint(new i(t.stellarForge.position.x,t.stellarForge.position.y));return}{const e=this.getEnemyForgeForPlayer(t);if(e){for(const s of t.units)(s.isHero||s instanceof Tl)&&(s.rallyPoint=new i(e.position.x,e.position.y),s instanceof Tl&&s.setManualRallyPoint(new i(e.position.x,e.position.y)));return}}}else if(t.aiStrategy===ja.AGGRESSIVE){const e=this.getEnemyForgeForPlayer(t);if(e){for(const s of t.units)s.isHero?s.rallyPoint=new i(e.position.x,e.position.y):s instanceof Tl&&s.setManualRallyPoint(new i(e.position.x,e.position.y));return}}const n=t.solarMirrors.length;let o=0;for(const e of t.units)if(e.isHero)e.rallyPoint=new i(t.stellarForge.position.x,t.stellarForge.position.y);else if(e instanceof Tl)if(o<n){const s=t.solarMirrors[o];e.setManualRallyPoint(new i(s.position.x,s.position.y)),o+=1}else e.setManualRallyPoint(new i(t.stellarForge.position.x,t.stellarForge.position.y))}getEnemyForgeForPlayer(t){for(const e of this.players)if(e!==t&&!e.isDefeated()&&e.stellarForge)return e.stellarForge;return null}updateAiHeroProductionForPlayer(t){if(this.gameTime<t.aiNextHeroCommandSec)return;let e=Gs;switch(t.aiStrategy){case ja.AGGRESSIVE:e=Gs*zs;break;case ja.ECONOMIC:e=Gs*js;break;case ja.WAVES:e=Gs*Ks;break;default:e=Gs}if(t.aiNextHeroCommandSec=this.gameTime+e,!t.stellarForge||!t.stellarForge.canProduceUnits())return;const i=this.getAiHeroTypesForFaction(t.faction);for(const e of i)if(!this.isHeroUnitAlive(t,e)&&!this.isHeroUnitQueuedOrProducing(t.stellarForge,e)){if(!t.spendEnergy(Ts))return;return t.stellarForge.enqueueHeroUnit(e),void t.stellarForge.startHeroProductionIfIdle()}}updateAiStructuresForPlayer(t,e){var i;if(this.gameTime<t.aiNextStructureCommandSec)return;if(t.aiNextStructureCommandSec=this.gameTime+Hs,!t.stellarForge)return;const s=t.buildings.filter(t=>t instanceof ul).length,n=t.buildings.filter(t=>t instanceof gl).length,o=t.buildings.some(t=>t instanceof yl);let r=null;const a=t.faction===Za.RADIANT;switch(t.aiStrategy){case ja.ECONOMIC:!o&&t.energy>=ms?r="subsidiaryFactory":a&&s<1&&t.energy>=gs?r="minigun":a&&n<1&&t.energy>=fs&&(r="swirler");break;case ja.DEFENSIVE:a&&n<2&&t.energy>=fs?r="swirler":a&&s<3&&t.energy>=gs?r="minigun":!o&&t.energy>=ms?r="subsidiaryFactory":a&&s<5&&t.energy>=gs&&(r="minigun");break;case ja.AGGRESSIVE:!o&&t.energy>=ms?r="subsidiaryFactory":a&&s<1&&t.energy>=gs&&(r="minigun");break;case ja.WAVES:!o&&t.energy>=ms?r="subsidiaryFactory":a&&s<2&&t.energy>=gs?r="minigun":a&&n<1&&t.energy>=fs?r="swirler":a&&s<3&&t.energy>=gs&&(r="minigun")}if(!r)return;const l=this.findAiThreat(t,e),h=null!==(i=null==l?void 0:l.guardPoint)&&void 0!==i?i:this.getAiStructureAnchor(t);if(!h)return;let c=null;switch(r){case"subsidiaryFactory":c=this.findAiStructurePlacement(h,$i,t),c&&t.spendEnergy(ms)&&t.buildings.push(new yl(c,t));break;case"swirler":c=this.findAiStructurePlacement(h,Ri,t),c&&t.spendEnergy(fs)&&t.buildings.push(new gl(c,t));break;case"minigun":c=this.findAiStructurePlacement(h,Ai,t),c&&t.spendEnergy(gs)&&t.buildings.push(new ul(c,t))}}getAiStructureAnchor(t){if(!t.stellarForge)return null;if(0===t.solarMirrors.length||0===this.suns.length)return t.stellarForge.position;let e=null,i=1/0;for(const s of t.solarMirrors){const t=s.getClosestSun(this.suns);if(!t)continue;const n=s.position.distanceTo(t.position);n<i&&(i=n,e=s)}return e?e.position:t.stellarForge.position}findAiStructurePlacement(t,e,s){const n=s.buildings.length*Zs,o=Qs+e;for(let s=0;s<8;s++){const r=n+Zs*s,a=new i(t.x+Math.cos(r)*o,t.y+Math.sin(r)*o);if(!this.checkCollision(a,e))return a}return null}findAiThreat(t,e){if(!t.stellarForge)return null;const i=[t.stellarForge.position];for(const e of t.solarMirrors)i.push(e.position);let s=null,n=null,o=1/0;const r=Js*Js;for(const t of i)for(const i of e){if("health"in i&&i.health<=0)continue;const e=i.position.x-t.x,a=i.position.y-t.y,l=e*e+a*a;l<=r&&l<o&&(o=l,s=i,n=t)}return s&&n?{enemy:s,guardPoint:n}:null}getClosestSunToPoint(t){let e=null,i=1/0;for(const s of this.suns){const n=t.distanceTo(s.position);n<i&&(i=n,e=s)}return e}getAiHeroTypesForFaction(t){switch(t){case Za.RADIANT:return["Marine","Dagger","Beam","Mortar","Preist","Tank","Spotlight"];case Za.AURUM:return["Driller"];case Za.VELARIS:return["Grave","Ray","InfluenceBall","TurretDeployer"];default:return[]}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof Fl;case"Grave":return t instanceof kl;case"Ray":return t instanceof Bl;case"InfluenceBall":return t instanceof Gl;case"TurretDeployer":return t instanceof $l;case"Driller":return t instanceof zl;case"Dagger":return t instanceof jl;case"Beam":return t instanceof Kl;case"Mortar":return t instanceof Yl;case"Preist":return t instanceof ql;case"Tank":return t instanceof Zl;case"Spotlight":return t instanceof Ql;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}applyDustPushFromMovingEntity(t,e,i,s,n,o){const r=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));if(r<=0)return;const a=Math.max(r,tt);this.applyFluidForceFromMovingObject(t,e,i,a*s,n,o)}applyFluidForceFromMovingObject(t,e,s,n,o,r){for(const a of this.spaceDust){const l=a.position.distanceTo(t);if(l<s&&l>W){const h=new i(a.position.x-t.x,a.position.y-t.y).normalize(),c=e.normalize(),d=B,u=U,p=new i(c.x*d+h.x*u,c.y*d+h.y*u),g=1-l/s,y=n*g*g;if(o){const t=Math.min(1,y/ct);t>0&&a.applyImpactColor(o,t)}a.applyForce(new i(p.x*y*r,p.y*y*r))}}}applyFluidForceFromBeam(t,e,s,n,o,r){const a=t.distanceTo(e);if(a<W)return;const l=new i(e.x-t.x,e.y-t.y).normalize();for(const e of this.spaceDust){const h=new i(e.position.x-t.x,e.position.y-t.y),c=h.x*l.x+h.y*l.y,d=Math.max(0,Math.min(a,c)),u=new i(t.x+l.x*d,t.y+l.y*d),p=e.position.distanceTo(u);if(p<s&&p>W){const t=new i(e.position.x-u.x,e.position.y-u.y).normalize(),a=G,h=H,c=new i(l.x*a+t.x*h,l.y*a+t.y*h),d=1-p/s,g=n*d*d;if(o){const t=Math.min(1,g/ct);t>0&&e.applyImpactColor(o,t)}e.applyForce(new i(c.x*g*r,c.y*g*r))}}}getPlayerImpactColor(t){const e=this.players.indexOf(t);return 0===e?r:1===e?a:r}initializeMirrorMovement(){if(0===this.suns.length)return;const t=this.suns[0];for(const e of this.players){if(!e.stellarForge||e.solarMirrors.length<2)continue;const s=e.stellarForge.position,n=s.x-t.position.x,o=s.y-t.position.y,r=Math.atan2(o,n),a=r+Math.PI/2,l=r-Math.PI/2;if(e.solarMirrors.length>=1){const t=new i(s.x+Math.cos(a)*Qt,s.y+Math.sin(a)*Qt);e.solarMirrors[0].setTarget(t)}if(e.solarMirrors.length>=2){const t=new i(s.x+Math.cos(l)*Qt,s.y+Math.sin(l)*Qt);e.solarMirrors[1].setTarget(t)}}}isPointInShadow(t){if(0===this.suns.length)return!0;for(const e of this.suns){const n=new i(e.position.x-t.x,e.position.y-t.y).normalize(),o=new s(t,n),r=t.distanceTo(e.position);let a=!0;for(const t of this.asteroids){const e=o.getIntersectionDistance(t.getWorldVertices());if(null!==e&&e<r){a=!1;break}}if(a)return!1}return!0}isObjectVisibleToPlayer(t,e,i){const s=this.suns.find(t=>"lad"===t.type);if(s)return this.isObjectVisibleInLadMode(t,e,i,s);if(i&&i instanceof jl&&i.isCloakedToEnemies()&&i.owner!==e)return!1;if(!this.isPointInShadow(t))return!0;for(const i of e.units)if(i.position.distanceTo(t)<=Wt)return!0;return!!(e.stellarForge&&e.stellarForge.position.distanceTo(t)<=o)||!!this.isObjectRevealedBySpotlight(t,e)}getLadSide(t,e){return t.x<e.position.x?"light":"dark"}isObjectVisibleInLadMode(t,e,i,s){if(i&&i instanceof jl&&i.isCloakedToEnemies()&&i.owner!==e)return!1;const n=e.stellarForge?this.getLadSide(e.stellarForge.position,s):"light",o=this.getLadSide(t,s);return!(i&&"owner"in i&&i.owner)||(i.owner===e||o===n||this.isObjectRevealedBySpotlight(t,e))}processRayBeamAbility(t){if(!t.drillDirection)return;const e=[];let s=new i(t.position.x,t.position.y),n=t.drillDirection.normalize(),o=0;const r=2e3;for(;o<lo;){let a=null,l=r;for(const t of this.asteroids){const e=this.rayIntersectsAsteroid(s,n,t);if(e){const t=s.distanceTo(e);t<l&&(l=t,a={pos:e,type:"asteroid"})}}for(const e of this.players)if(e!==t.owner){for(const t of e.units){const e=this.rayIntersectsUnit(s,n,t.position);if(e){const i=s.distanceTo(e);i<l&&(l=i,a={pos:e,type:"unit",target:t})}}if(e.stellarForge){const t=this.rayIntersectsUnit(s,n,e.stellarForge.position,e.stellarForge.radius);if(t){const i=s.distanceTo(t);i<l&&(l=i,a={pos:t,type:"forge",target:e.stellarForge})}}}for(const t of this.suns){const e=this.rayIntersectsUnit(s,n,t.position,t.radius);if(e){const t=s.distanceTo(e);t<l&&(l=t,a={pos:e,type:"sun"})}}const h=this.rayIntersectsEdge(s,n);if(h&&s.distanceTo(h)<l&&(l=s.distanceTo(h),a={pos:h,type:"edge"}),!a){const o=new i(s.x+n.x*r,s.y+n.y*r);e.push(new Ul(s,o,t.owner));break}if(e.push(new Ul(s,a.pos,t.owner)),"unit"===a.type||"forge"===a.type){if(a.target){a.target.takeDamage(ao);const t="forge"===a.type?ni:a.target.maxHealth,e="forge"===a.type?`forge_${a.target.position.x}_${a.target.position.y}_${a.target.owner.name}`:`unit_${a.target.position.x}_${a.target.position.y}_${a.target.owner.name}`;this.addDamageNumber(a.target.position,ao,t,a.target.health,e)}break}if("sun"===a.type||"edge"===a.type)break;"asteroid"===a.type&&(o++,s=a.pos,n=new i(-n.x,-n.y))}t.setBeamSegments(e)}updateSpotlightAbility(t,e,i){if(t.updateSpotlightState(i),!t.isSpotlightActive()||!t.spotlightDirection)return void t.setSpotlightRangePx(0);const s=this.getSpotlightMaxRangePx(t);t.setSpotlightRangePx(s);const n=s*t.spotlightLengthFactor;if(!t.canFireSpotlight()||n<=0)return;const o=this.getSpotlightTargetsInCone(t,e,n);if(o.length>0){const e=t.fireSpotlightAtTargets(o,n);e.length>0&&this.abilityBullets.push(...e)}}getSpotlightMaxRangePx(t){const e=t.spotlightDirection;if(!e)return 0;let i=1/0;const s=this.rayIntersectsEdge(t.position,e);s&&(i=t.position.distanceTo(s));for(const s of this.asteroids){const n=this.rayIntersectsAsteroid(t.position,e,s);if(n){const e=t.position.distanceTo(n);e<i&&(i=e)}}return Number.isFinite(i)?i:0}getSpotlightTargetsInCone(t,e,i){const s=[],n=t.spotlightDirection;if(!n)return s;const o=Math.atan2(n.y,n.x),r=pr/2,a=i*i;for(const i of e){const e=i.position.x-t.position.x,n=i.position.y-t.position.y;if(e*e+n*n>a)continue;let l=Math.atan2(n,e)-o;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;Math.abs(l)<=r&&s.push(i)}return s}isPositionInSpotlightCone(t,e,i){const s=t.spotlightDirection;if(!s)return!1;const n=e.x-t.position.x,o=e.y-t.position.y;if(n*n+o*o>i*i)return!1;const r=Math.atan2(s.y,s.x);let a=Math.atan2(o,n)-r;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;return Math.abs(a)<=pr/2}isObjectRevealedBySpotlight(t,e){for(const i of e.units){if(!(i instanceof Ql))continue;if(!i.isSpotlightActive()||!i.spotlightDirection)continue;const e=i.spotlightRangePx*i.spotlightLengthFactor;if(!(e<=0)&&this.isPositionInSpotlightCone(i,t,e))return!0}return!1}rayIntersectsAsteroid(t,e,s){const n=new i(s.position.x-t.x,s.position.y-t.y),o=n.x*e.x+n.y*e.y;if(o<0)return null;const r=new i(t.x+e.x*o,t.y+e.y*o);return r.distanceTo(s.position)<60?r:null}rayIntersectsUnit(t,e,s,n=8){const o=new i(s.x-t.x,s.y-t.y),r=o.x*e.x+o.y*e.y;if(r<0)return null;const a=new i(t.x+e.x*r,t.y+e.y*r);return a.distanceTo(s)<n?a:null}rayIntersectsEdge(t,e){const s=this.mapSize;let n=null,o=1/0;const r=[{x:0,normal:new i(1,0)},{x:s,normal:new i(-1,0)},{y:0,normal:new i(0,1)},{y:s,normal:new i(0,-1)}];for(const s of r){let r=null;if("x"in s&&void 0!==s.x){if(Math.abs(e.x)>.001){const n=(s.x-t.x)/e.x;n>0&&(r=new i(s.x,t.y+e.y*n))}}else if("y"in s&&void 0!==s.y&&Math.abs(e.y)>.001){const n=(s.y-t.y)/e.y;n>0&&(r=new i(t.x+e.x*n,s.y))}if(r){const e=t.distanceTo(r);e<o&&(o=e,n=r)}}return n}processTurretDeployment(t){let e=null,s=1/0;for(const i of this.asteroids){const n=t.position.distanceTo(i.position);n<s&&n<200&&(s=n,e=i)}if(e){const s=new Vl(new i(e.position.x,e.position.y),t.owner,e);this.deployedTurrets.push(s)}}processDrillerCollisions(t,e){for(const e of this.suns)if(t.position.distanceTo(e.position)<e.radius+10)return t.health=0,void t.stopDrilling();for(const e of this.asteroids)if(e.containsPoint(t.position))return t.hideInAsteroid(e),void t.stopDrilling();for(const e of this.players)if(e!==t.owner){for(const i of e.units)if(t.position.distanceTo(i.position)<15){i.takeDamage(Uo);const t=`unit_${i.position.x}_${i.position.y}_${i.owner.name}`;this.addDamageNumber(i.position,Uo,i.maxHealth,i.health,t)}for(const i of e.buildings)if(t.position.distanceTo(i.position)<40){const t=Uo*Go;i.takeDamage(t);const s=`building_${i.position.x}_${i.position.y}_${e.name}`;this.addDamageNumber(i.position,t,i.maxHealth,i.health,s)}if(e.stellarForge&&t.position.distanceTo(e.stellarForge.position)<e.stellarForge.radius+10){const t=Uo*Go;e.stellarForge.health-=t;const i=`forge_${e.stellarForge.position.x}_${e.stellarForge.position.y}_${e.name}`;this.addDamageNumber(e.stellarForge.position,t,ni,e.stellarForge.health,i)}}const i=this.mapSize;if(t.position.x<0||t.position.x>i||t.position.y<0||t.position.y>i){const s=Math.sqrt(Math.pow(t.drillVelocity.x,2)+Math.pow(t.drillVelocity.y,2));if(s>0){const i=Ho*e,n=Math.max(0,s-i);0===n?t.stopDrilling():(t.drillVelocity.x=t.drillVelocity.x/s*n,t.drillVelocity.y=t.drillVelocity.y/s*n)}t.position.x=Math.max(0,Math.min(i,t.position.x)),t.position.y=Math.max(0,Math.min(i,t.position.y))}}resolveUnitCollisions(t){for(let e=0;e<t.length;e++){const i=t[e];if(!i.isDead())for(let s=e+1;s<t.length;s++){const n=t[s];if(n.isDead())continue;let o=n.position.x-i.position.x,r=n.position.y-i.position.y,a=o*o+r*r;0===a&&(o=e%2==0?1:-1,r=0,a=1);const l=i.collisionRadiusPx+n.collisionRadiusPx;if(a<l*l){const t=Math.sqrt(a),e=l-t,s=o/t*e,h=r/t*e;i.isHero&&!n.isHero?(n.position.x+=s,n.position.y+=h):!i.isHero&&n.isHero?(i.position.x-=s,i.position.y-=h):(i.position.x-=.5*s,i.position.y-=.5*h,n.position.x+=.5*s,n.position.y+=.5*h)}}}}resolveUnitObstacleCollisions(t){for(const e of t){if(e.isDead())continue;const t=new i(e.position.x,e.position.y);if(this.checkCollision(e.position,e.collisionRadiusPx)){let i=0,s=0,n=0;for(const t of this.asteroids){const o=e.position.x-t.position.x,r=e.position.y-t.position.y,a=o*o+r*r,l=t.size+e.collisionRadiusPx+En;if(a<l*l||t.containsPoint(e.position)){const t=Math.sqrt(a)||1,e=(l-t)/l;i+=o/t*e,s+=r/t*e,n++}}for(const t of this.players)if(t.stellarForge){const o=t.stellarForge,r=e.position.x-o.position.x,a=e.position.y-o.position.y,l=Math.sqrt(r*r+a*a),h=o.radius+e.collisionRadiusPx;if(l<h){const t=(h-l)/h;i+=r/l*t,s+=a/l*t,n++}}for(const t of this.players)for(const o of t.solarMirrors){if(o.owner===e.owner)continue;const t=e.position.x-o.position.x,r=e.position.y-o.position.y,a=Math.sqrt(t*t+r*r),l=20+e.collisionRadiusPx;if(a<l){const e=(l-a)/l;i+=t/a*e,s+=r/a*e,n++}}for(const t of this.players)for(const o of t.buildings){const t=e.position.x-o.position.x,r=e.position.y-o.position.y,a=Math.sqrt(t*t+r*r),l=o.radius+e.collisionRadiusPx;if(a<l){const e=(l-a)/l;i+=t/a*e,s+=r/a*e,n++}}if(n>0){const n=Math.sqrt(i*i+s*s);if(n>0){const o=Math.min(this.MAX_PUSH_DISTANCE,n*this.PUSH_MULTIPLIER);e.position.x=t.x+i/n*o,e.position.y=t.y+s/n*o}}this.checkCollision(e.position,e.collisionRadiusPx)&&(e.position=t,e.rallyPoint&&this.checkCollision(e.rallyPoint,e.collisionRadiusPx)&&(e.rallyPoint=null))}this.clampUnitOutsideStructures(e)}}clampUnitOutsideStructures(t){for(const e of this.players){e.stellarForge&&this.pushUnitOutsideCircle(t,e.stellarForge.position,e.stellarForge.radius);for(const i of e.buildings)this.pushUnitOutsideCircle(t,i.position,i.radius)}}pushUnitOutsideCircle(t,e,i){const s=i+t.collisionRadiusPx+Cn,n=t.position.x-e.x,o=t.position.y-e.y,r=n*n+o*o;if(r<s*s){const i=Math.sqrt(r);if(i>0){const r=s/i;t.position.x=e.x+n*r,t.position.y=e.y+o*r}else t.position.x=e.x+s,t.position.y=e.y}}createHeroUnit(t,e,i){switch(t){case"Marine":return new Fl(e,i);case"Grave":return new kl(e,i);case"Ray":return new Bl(e,i);case"InfluenceBall":return new Gl(e,i);case"TurretDeployer":return new $l(e,i);case"Driller":return new zl(e,i);case"Dagger":return new jl(e,i);case"Beam":return new Kl(e,i);case"Mortar":return new Yl(e,i);case"Preist":return new ql(e,i);case"Tank":return new Zl(e,i);case"Spotlight":return new Ql(e,i);case"Nova":return new eh(e,i);case"Sly":return new nh(e,i);default:return null}}checkCollision(t,e=An,i=null){for(const e of this.asteroids)if(e.containsPoint(t))return!0;for(const s of this.players){if(s.stellarForge){if(s.stellarForge===i)continue;if(t.distanceTo(s.stellarForge.position)<s.stellarForge.radius+e)return!0}for(const n of s.solarMirrors)if(n!==i&&t.distanceTo(n.position)<20+e)return!0;for(const n of s.buildings)if(n!==i&&t.distanceTo(n.position)<n.radius+e)return!0}return!1}getMirrorLightOnStructure(t,e){let n=0;for(const o of t.solarMirrors){if(o.getLinkedStructure(t.stellarForge)!==e)continue;if(!o.hasLineOfSightToLight(this.suns,this.asteroids))continue;const r=new s(o.position,new i(e.position.x-o.position.x,e.position.y-o.position.y).normalize(),1);let a=!0;for(const t of this.asteroids)if(r.intersectsPolygon(t.getWorldVertices())){a=!1;break}if(a){const t=this.suns.reduce((t,e)=>o.position.distanceTo(e.position)<(t?o.position.distanceTo(t.position):1/0)?e:t,null);if(t){const e=o.position.distanceTo(t.position);n+=Math.max(1,On*(1-Math.min(1,e/Dn)))}}}return n}updateStateHash(){var t,e,i;let s=2166136261;const n=t=>{const e=Math.floor(100*t);s=Math.imul(s^e,16777619)},o=t=>{s=Math.imul(s^t,16777619)},r=t=>{o(t.length);for(let e=0;e<t.length;e++)o(t.charCodeAt(e))};n(this.gameTime),n(this.suns.length),n(this.asteroids.length),n(K),o(this.spaceDust.length);for(const e of this.spaceDust)n(e.position.x),n(e.position.y),n(e.velocity.x),n(e.velocity.y),n(e.glowTransition),o(e.glowState),o(e.targetGlowState),n(e.impactBlend),n(e.impactTargetBlend),n(e.impactHoldTimeSec),r(e.baseColor),r(null!==(t=e.impactColor)&&void 0!==t?t:"");for(const t of this.players){if(n(t.energy),o(t.isAi?1:0),n(t.aiNextMirrorCommandSec),n(t.aiNextDefenseCommandSec),n(t.aiNextHeroCommandSec),n(t.aiNextStructureCommandSec),n(t.aiNextMirrorPurchaseCommandSec),r(t.aiStrategy),o(t.hasStrafeUpgrade?1:0),o(t.hasRegenUpgrade?1:0),o(t.hasBlinkUpgrade?1:0),o(t.hasAttackUpgrade?1:0),o(t.units.length),t.stellarForge){n(t.stellarForge.position.x),n(t.stellarForge.position.y),n(t.stellarForge.health),o(t.stellarForge.unitQueue.length);for(const e of t.stellarForge.unitQueue)r(e);r(null!==(e=t.stellarForge.heroProductionUnitType)&&void 0!==e?e:""),n(t.stellarForge.heroProductionRemainingSec),n(t.stellarForge.heroProductionDurationSec),n(t.stellarForge.crunchTimer),n(t.stellarForge.rotation),t.stellarForge.targetPosition?(n(t.stellarForge.targetPosition.x),n(t.stellarForge.targetPosition.y)):(n(-1),n(-1)),n(t.stellarForge.velocity.x),n(t.stellarForge.velocity.y)}else n(-1);for(const e of t.solarMirrors)n(e.position.x),n(e.position.y),n(e.health),n(e.efficiency),n(e.reflectionAngle),e.linkedStructure?(e.linkedStructure instanceof cl?o(1):o(2),n(e.linkedStructure.position.x),n(e.linkedStructure.position.y)):(o(0),n(-1),n(-1)),e.targetPosition?(n(e.targetPosition.x),n(e.targetPosition.y)):(n(-1),n(-1)),n(e.velocity.x),n(e.velocity.y);for(const e of t.units){n(e.position.x),n(e.position.y),n(e.velocity.x),n(e.velocity.y),n(e.rotation),n(e.health),n(e.isHero?1:0),n(e.collisionRadiusPx),o(e.moveOrder),e.rallyPoint?(n(e.rallyPoint.x),n(e.rallyPoint.y)):(n(-1),n(-1));const t=e.getManualTarget();if(t?(o(1),o(t instanceof cl?1:t instanceof dl?2:t instanceof Ka?3:4),n(t.position.x),n(t.position.y),"owner"in t&&t.owner?o(this.players.indexOf(t.owner)):o(-1)):(o(0),n(-1),n(-1),o(-1)),e instanceof Tl&&(o(e.getAssignedPathLength()),o(e.getCurrentPathWaypointIndex()),o(e.hasActiveManualOrder()?1:0),n(e.getCurrentMoveSpeedPxPerSec()),n(e.abilityCooldown),o(e.getHasReachedFinalWaypoint()?1:0),r(e.getPathHash())),e instanceof Ql&&(o(e.getSpotlightStateCode()),n(e.spotlightStateElapsedSec),n(e.spotlightFireCooldownSec),n(e.spotlightLengthFactor),n(e.spotlightRangePx),e.spotlightDirection?(n(e.spotlightDirection.x),n(e.spotlightDirection.y)):(n(-1),n(-1))),e instanceof kl){n(e.getSmallParticleCount()),n(e.projectileLaunchCooldown),n(e.smallParticleRegenTimer),o(e.isUsingAbility?1:0);const t=e.getProjectiles();o(t.length);for(const e of t)n(e.position.x),n(e.position.y),n(e.velocity.x),n(e.velocity.y),n(e.lifetime),n(e.targetAngle),o(e.isAttacking?1:0),e.targetEnemy?(o(1),n(e.targetEnemy.position.x),n(e.targetEnemy.position.y)):(o(0),n(-1),n(-1))}}for(const e of t.buildings)if(n(e.position.x),n(e.position.y),n(e.health),n(e.isComplete?1:0),e instanceof yl){n(e.productionProgress),r(null!==(i=e.currentProduction)&&void 0!==i?i:""),o(e.productionQueue.length);for(const t of e.productionQueue)r(t)}}o(this.starlingMergeGates.length);for(const t of this.starlingMergeGates)n(t.position.x),n(t.position.y),n(t.remainingSec),n(t.health),o(t.absorbedCount),o(t.assignedStarlings.length),o(this.players.indexOf(t.owner));o(this.warpGates.length);for(const t of this.warpGates)n(t.position.x),n(t.position.y),n(t.chargeTime),n(t.accumulatedEnergy),o(t.isCharging?1:0),o(t.isComplete?1:0),o(t.isCancelling?1:0),o(t.hasDissipated?1:0),n(t.completionRemainingSec),n(t.health),o(this.players.indexOf(t.owner));o(this.minionProjectiles.length);for(const t of this.minionProjectiles)n(t.position.x),n(t.position.y),n(t.velocity.x),n(t.velocity.y),n(t.damage),n(t.distanceTraveledPx),n(t.maxRangePx),o(this.players.indexOf(t.owner));o(this.muzzleFlashes.length);for(const t of this.muzzleFlashes)n(t.position.x),n(t.position.y),n(t.angle),n(t.lifetime),n(t.maxLifetime);o(this.bulletCasings.length);for(const t of this.bulletCasings)n(t.position.x),n(t.position.y),n(t.velocity.x),n(t.velocity.y),n(t.rotation),n(t.rotationSpeed),n(t.lifetime),n(t.maxLifetime);o(this.bouncingBullets.length);for(const t of this.bouncingBullets)n(t.position.x),n(t.position.y),n(t.velocity.x),n(t.velocity.y),n(t.lifetime),n(t.maxLifetime);this.stateHash=s>>>0}initializeSpaceDust(t,e,s,n){this.spaceDust=[];const o=J,r=Q,a=Z,l=[],h=Ja();for(let t=0;t<o;t++){const t=h.nextFloat(-e/2,e/2),n=h.nextFloat(-s/2,s/2);l.push(new i(t,n))}for(let o=0;o<t;o++){let t=0,o=0;if(h.next()<a&&l.length>0){const e=l[h.nextInt(0,l.length-1)],i=h.nextAngle(),s=Math.sqrt(h.next())*r;t=e.x+Math.cos(i)*s,o=e.y+Math.sin(i)*s}else t=h.nextFloat(-e/2,e/2),o=h.nextFloat(-s/2,s/2);this.spaceDust.push(new tl(new i(t,o),void 0,n))}}initializeAsteroids(t,e,s){this.asteroids=[];const n=Ja();for(let o=0;o<t;o++){let t=!1,o=0,r=0,a=0,l=0;for(;!t&&o<50;){const i=n.nextAngle(),h=n.nextFloat(200,Math.min(e,s)/2-100);r=Math.cos(i)*h,a=Math.sin(i)*h,l=n.nextFloat(jt,80),t=!0;for(const e of this.asteroids){const i=r-e.position.x,s=a-e.position.y;if(Math.sqrt(i*i+s*s)<l+e.size){t=!1;break}}o++}if(t){const t=n.nextInt(3,9);this.asteroids.push(new Rl(new i(r,a),t,l))}}}checkVictoryConditions(){const t=this.players.filter(t=>!t.isDefeated());return 1===t.length?t[0]:null}initializePlayer(t,e,i){t.stellarForge=new cl(e,t);for(const e of i){const i=new Ka(e,t);t.solarMirrors.push(i)}}addDamageNumber(t,e,i,s,n=null){const o=Math.max(0,s);"remaining-life"===this.damageDisplayMode&&null!==n&&(this.damageNumbers=this.damageNumbers.filter(t=>t.unitId!==n)),this.damageNumbers.push(new Ml(t,e,this.gameTime,i,o,n))}setupNetworkManager(t,e){this.networkManager=t,this.localPlayerIndex=e,this.networkManager.on(bl.MESSAGE_RECEIVED,t=>{if(t&&"object"==typeof t&&"type"in t&&t.type===El.GAME_COMMAND){const e=t.data;this.receiveNetworkCommand(e)}})}sendGameCommand(t,e){if(!this.networkManager)return;const i={tick:Math.floor(60*this.gameTime),playerId:this.networkManager.getLocalPlayerId(),command:t,data:e};this.networkManager.sendGameCommand(i)}receiveNetworkCommand(t){this.pendingCommands.push(t)}processPendingNetworkCommands(){if(0!==this.pendingCommands.length){this.pendingCommands.sort((t,e)=>t.tick-e.tick);for(const t of this.pendingCommands)this.executeNetworkCommand(t);this.pendingCommands=[]}}executeNetworkCommand(t){const e=0===this.localPlayerIndex?1:0,i=this.players[e];i&&this.executePlayerCommand(i,t.command,t.data)}updatePlayerNameMap(){this.playersByName.clear();for(const t of this.players)this.playersByName.set(t.name,t)}executePlayerCommand(t,e,i){switch(e){case"unit_move":this.executeUnitMoveCommand(t,i);break;case"unit_target_structure":this.executeUnitTargetStructureCommand(t,i);break;case"unit_ability":this.executeUnitAbilityCommand(t,i);break;case"unit_path":this.executeUnitPathCommand(t,i);break;case"hero_purchase":this.executeHeroPurchaseCommand(t,i);break;case"building_purchase":this.executeBuildingPurchaseCommand(t,i);break;case"mirror_purchase":this.executeMirrorPurchaseCommand(t,i);break;case"mirror_move":this.executeMirrorMoveCommand(t,i);break;case"mirror_link":this.executeMirrorLinkCommand(t,i);break;case"starling_merge":this.executeStarlingMergeCommand(t,i);break;case"foundry_production":this.executeFoundryProductionCommand(t,i);break;case"foundry_strafe_upgrade":this.executeFoundryUpgradeCommand(t,i,"strafe");break;case"foundry_regen_upgrade":this.executeFoundryUpgradeCommand(t,i,"regen");break;case"foundry_attack_upgrade":this.executeFoundryUpgradeCommand(t,i,"attack");break;case"foundry_blink_upgrade":this.executeFoundryUpgradeCommand(t,i,"blink");break;case"striker_tower_fire":this.executeStrikerTowerFireCommand(t,i);break;case"striker_tower_start_countdown":this.executeStrikerTowerStartCountdownCommand(t,i);break;case"forge_move":this.executeForgeMoveCommand(t,i);break;case"set_rally_path":this.executeSetRallyPathCommand(t,i);break;default:console.warn("Unknown command type:",e)}}executeCommand(t){const e=this.playersByName.get(t.playerId);e?this.executePlayerCommand(e,t.commandType,t.payload):console.warn("Player not found for P2P command:",t.playerId)}executeCommands(t){for(const e of t)this.executeCommand(e)}executeUnitMoveCommand(t,e){const{unitIds:s,targetX:n,targetY:o,moveOrder:r}=e,a=new i(n,o);for(const e of s){const i=t.units.find(t=>this.getUnitNetworkId(t)===e);i?(i.clearManualTarget(),i instanceof Tl?i.setManualRallyPoint(a):i.rallyPoint=a,"number"==typeof r&&(i.moveOrder=r)):console.warn(`Unit not found for network command: ${e}`)}}executeUnitTargetStructureCommand(t,e){var i,s,n;const{unitIds:o,targetPlayerIndex:r,structureType:a,structureIndex:l,moveOrder:h}=e,c=this.players[r];if(!c)return void console.warn("Target player not found for unit target command.");let d=null;if("forge"===a?d=null!==(i=c.stellarForge)&&void 0!==i?i:null:"building"===a?d=null!==(s=c.buildings[l])&&void 0!==s?s:null:"mirror"===a&&(d=null!==(n=c.solarMirrors[l])&&void 0!==n?n:null),d)for(const e of null!=o?o:[]){const i=t.units.find(t=>this.getUnitNetworkId(t)===e);if(i){if(i instanceof Tl&&d instanceof yl&&d.owner===t)i.setManualTarget(d,d.position);else{const t=this.getCombatTargetRadiusPx(d),e=i.getStructureStandoffPoint(d.position,t);i.setManualTarget(d,e)}"number"==typeof h&&(i.moveOrder=h)}else console.warn(`Unit not found for network command: ${e}`)}else console.warn("Target structure not found for unit target command.")}createDeathParticles(t,e){let s,n;const o=Ja();t instanceof dl?(s=o.nextInt(10,20),n=16):t.isHero?(s=o.nextInt(10,20),n=12):(s=o.nextInt(4,8),n=8);const r=o.nextFloat(5,15);for(let a=0;a<s;a++){const l=2*Math.PI*a/s+o.nextFloat(-.25,.25),h=o.nextFloat(50,150),c=new i(Math.cos(l)*h,Math.sin(l)*h),d=document.createElement("canvas"),u=o.nextFloat(n,2*n);d.width=u,d.height=u;const p=d.getContext("2d");p&&(p.fillStyle=e,p.fillRect(0,0,u,u));const g=new hl(new i(t.position.x,t.position.y),c,o.nextAngle(),d,r);this.deathParticles.push(g)}}getCombatTargetRadiusPx(t){return t instanceof Ka?kn:"radius"in t?t.radius:0}executeUnitAbilityCommand(t,e){const{unitId:s,directionX:n,directionY:o}=e,r=new i(n,o),a=t.units.find(t=>this.getUnitNetworkId(t)===s);a?a.useAbility(r):console.warn(`Unit not found for ability command: ${s}`)}executeUnitPathCommand(t,e){const{unitIds:s,waypoints:n,moveOrder:o}=e,r=(null!=n?n:[]).map(t=>new i(t.x,t.y));for(const e of null!=s?s:[]){const i=t.units.find(t=>this.getUnitNetworkId(t)===e);i?(i.clearManualTarget(),i.setPath(r),"number"==typeof o&&(i.moveOrder=o)):console.warn(`Unit not found for path command: ${e}`)}}executeHeroPurchaseCommand(t,e){const{heroType:i}=e;t.stellarForge&&(t.stellarForge.enqueueHeroUnit(i),t.stellarForge.startHeroProductionIfIdle())}executeBuildingPurchaseCommand(t,e){const{buildingType:s,positionX:n,positionY:o}=e,r=new i(n,o);if(["Minigun","Cannon","Gatling","GatlingTower","ShieldTower"].includes(s)&&t.faction!==Za.RADIANT)return;if(["StrikerTower","LockOnLaserTower","SpaceDustSwirler"].includes(s)&&t.faction!==Za.VELARIS)return;let a=0;"Minigun"===s||"Cannon"===s?a=gs:"Gatling"===s||"GatlingTower"===s?a=ys:"SpaceDustSwirler"===s?a=fs:"SubsidiaryFactory"===s||"Foundry"===s?a=ms:"StrikerTower"===s?a=xs:"LockOnLaserTower"===s?a=Ss:"ShieldTower"===s&&(a=As),t.spendEnergy(a)&&("Minigun"===s||"Cannon"===s?t.buildings.push(new ul(r,t)):"Gatling"===s||"GatlingTower"===s?t.buildings.push(new pl(r,t)):"SpaceDustSwirler"===s?t.buildings.push(new gl(r,t)):"SubsidiaryFactory"===s||"Foundry"===s?t.buildings.push(new yl(r,t)):"StrikerTower"===s?t.buildings.push(new fl(r,t)):"LockOnLaserTower"===s?t.buildings.push(new ml(r,t)):"ShieldTower"===s&&t.buildings.push(new xl(r,t)))}executeMirrorPurchaseCommand(t,e){}executeStrikerTowerStartCountdownCommand(t,e){const{buildingId:s,targetX:n,targetY:o}=e,r=new i(n,o),a=t.buildings.find(t=>t instanceof fl&&this.getBuildingNetworkId(t)===s);a instanceof fl&&a.isValidTarget(r,t=>this.isPointInShadow(t),(t,e)=>this.isPositionVisibleByPlayerUnits(t,e),t.units)&&a.startCountdown(r)}executeStrikerTowerFireCommand(t,e){const{buildingId:s,targetX:n,targetY:o}=e,r=new i(n,o),a=t.buildings.find(t=>t instanceof fl&&this.getBuildingNetworkId(t)===s);if(a instanceof fl){const e=[];for(const i of this.players)i!==t&&(e.push(...i.units),i.stellarForge&&e.push(i.stellarForge),e.push(...i.buildings));a.fireMissile(r,e,t=>this.isPointInShadow(t),(t,e)=>this.isPositionVisibleByPlayerUnits(t,e),t.units)}}isPositionVisibleByPlayerUnits(t,e){for(const i of e)if(i.position.distanceTo(t)<=ps)return!0;return!1}getBuildingNetworkId(t){return`p${this.players.findIndex(e=>e===t.owner)}_b${t.owner.buildings.indexOf(t)}`}executeMirrorMoveCommand(t,e){const{mirrorIndices:s,targetX:n,targetY:o,moveOrder:r}=e,a=new i(n,o);for(const e of null!=s?s:[]){const i=t.solarMirrors[e];i&&(i.setTarget(a),"number"==typeof r&&(i.moveOrder=r))}}executeMirrorLinkCommand(t,e){var i,s;const{mirrorIndices:n,structureType:o,buildingIndex:r}=e;let a=null;"forge"===o?a=null!==(i=t.stellarForge)&&void 0!==i?i:null:"building"===o&&(a=null!==(s=t.buildings[r])&&void 0!==s?s:null);for(const e of null!=n?n:[]){const i=t.solarMirrors[e];i&&i.setLinkedStructure(a)}}executeStarlingMergeCommand(t,e){const{unitIds:s,targetX:n,targetY:o}=e;if(!Array.isArray(s))return;const r=new i(n,o);this.applyStarlingMerge(t,s,r)}applyStarlingMerge(t,e,i){if(!t.buildings.some(t=>t instanceof yl))return;const s=[];for(const i of e){if(s.length>=Ls)break;const e=t.units.find(t=>this.getUnitNetworkId(t)===i);e instanceof Tl&&!e.isDead()&&s.push(e)}if(!(s.length<Ls)){for(const t of s)t.clearManualTarget(),t.setManualRallyPoint(i);this.starlingMergeGates.push(new _l(i,t,s))}}executeFoundryProductionCommand(t,e){const{buildingId:i,itemType:s}=e,n=t.buildings[i];n instanceof yl&&n.isComplete}executeFoundryUpgradeCommand(t,e,i){const{buildingId:s}=e,n=t.buildings[s];n instanceof yl&&n.isComplete&&("strafe"!==i?"blink"!==i?"attack"!==i?n.canQueueRegenUpgrade()&&t.spendEnergy(Es)&&n.enqueueProduction(Ps):n.canQueueAttackUpgrade()&&t.spendEnergy(bs)&&n.enqueueProduction(Cs):n.canQueueBlinkUpgrade()&&t.spendEnergy(Rs)&&n.enqueueProduction(Ms):n.canQueueStrafeUpgrade()&&t.spendEnergy(ws)&&n.enqueueProduction(vs))}executeForgeMoveCommand(t,e){const{targetX:s,targetY:n,moveOrder:o}=e,r=new i(s,n);t.stellarForge&&(t.stellarForge.targetPosition=r,"number"==typeof o&&(t.stellarForge.moveOrder=o))}executeSetRallyPathCommand(t,e){const{waypoints:s}=e,n=s.map(t=>new i(t.x,t.y));t.stellarForge&&t.stellarForge.setMinionPath(n)}getUnitNetworkId(t){return`${this.players.indexOf(t.owner)}_${t.position.x.toFixed(1)}_${t.position.y.toFixed(1)}_${t.maxHealth}_${t.constructor.name}`}}const{Marine:Fl}=(t=>{const{Unit:e,Vector2D:i,Constants:s,MuzzleFlash:n,BulletCasing:o,BouncingBullet:r,AbilityBullet:a}=t;return{Marine:class extends e{constructor(t,e){super(t,e,s.MARINE_MAX_HEALTH,s.MARINE_ATTACK_RANGE,s.MARINE_ATTACK_DAMAGE,s.MARINE_ATTACK_SPEED,s.MARINE_ABILITY_COOLDOWN),this.lastShotEffects={},this.isHero=!0}attack(t){super.attack(t);const e=t.position.x-this.position.x,a=t.position.y-this.position.y,l=Math.atan2(a,e);this.lastShotEffects.muzzleFlash=new n(new i(this.position.x,this.position.y),l);const h=Ja(),c=l+Math.PI/2+h.nextFloat(-.25,.25),d=h.nextFloat(s.BULLET_CASING_SPEED_MIN,s.BULLET_CASING_SPEED_MAX);this.lastShotEffects.casing=new o(new i(this.position.x,this.position.y),new i(Math.cos(c)*d,Math.sin(c)*d));const u=l+Math.PI+h.nextFloat(-.5,.5),p=h.nextFloat(s.BOUNCING_BULLET_SPEED_MIN,s.BOUNCING_BULLET_SPEED_MAX);this.lastShotEffects.bouncingBullet=new r(new i(t.position.x,t.position.y),new i(Math.cos(u)*p,Math.sin(u)*p))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}useAbility(t){if(!super.useAbility(t))return!1;const e=Math.atan2(t.y,t.x),n=s.MARINE_ABILITY_SPREAD_ANGLE,o=s.MARINE_ABILITY_BULLET_COUNT;for(let t=0;t<o;t++){const r=e+(t/Math.max(o-1,1)-.5)*n*2,l=s.MARINE_ABILITY_BULLET_SPEED,h=new i(Math.cos(r)*l,Math.sin(r)*l),c=new a(new i(this.position.x,this.position.y),h,this.owner);this.lastAbilityEffects.push(c)}return!0}}}})({Unit:Al,Vector2D:i,Constants:e,MuzzleFlash:sl,BulletCasing:il,BouncingBullet:nl,AbilityBullet:ol}),{Grave:kl,GraveProjectile:Dl,GraveSmallParticle:Ol,GraveBlackHole:Nl}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class n{constructor(t,e){this.position=t,this.owner=e,this.hasExploded=!1;const s=Ja(),n=s.nextAngle(),o=s.nextFloat(20,50);this.velocity=new i(Math.cos(n)*o,Math.sin(n)*o)}update(t,e){const i=e.x-this.position.x,n=e.y-this.position.y,o=Math.sqrt(i*i+n*n);if(o>.1){const e=s.GRAVE_SMALL_PARTICLE_ATTRACTION_FORCE/Math.max(o,10);this.velocity.x+=i/o*e*t,this.velocity.y+=n/o*e*t}this.velocity.x*=s.GRAVE_SMALL_PARTICLE_DRAG,this.velocity.y*=s.GRAVE_SMALL_PARTICLE_DRAG,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}checkCollision(t){return this.position.distanceTo(t.position)<10}applySplashDamage(t){const e=[];for(const i of t){const t=this.position.distanceTo(i.position);if(t<=s.GRAVE_SMALL_PARTICLE_SPLASH_RADIUS){const n=1-t/s.GRAVE_SMALL_PARTICLE_SPLASH_RADIUS*(1-s.GRAVE_SMALL_PARTICLE_SPLASH_FALLOFF),o=s.GRAVE_SMALL_PARTICLE_DAMAGE*n;"health"in i&&(i.health-=o,e.push(i))}}return e}}class o{constructor(t,e,n){this.position=t,this.owner=n,this.lifetime=0,this.velocity=new i(e.x*s.GRAVE_BLACK_HOLE_SPEED,e.y*s.GRAVE_BLACK_HOLE_SPEED)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=s.GRAVE_BLACK_HOLE_DURATION}}class r{constructor(t,e,i,n){this.position=t,this.owner=i,this.index=n,this.lifetime=0,this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.velocity=e,this.targetAngle=n/s.GRAVE_NUM_PROJECTILES*Math.PI*2}update(t,e){if(this.isAttacking)this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;else{const i=e.x+Math.cos(this.targetAngle)*s.GRAVE_PROJECTILE_ORBIT_RADIUS,n=e.y+Math.sin(this.targetAngle)*s.GRAVE_PROJECTILE_ORBIT_RADIUS,o=i-this.position.x,r=n-this.position.y,a=Math.sqrt(o*o+r*r);if(a>0){const e=s.GRAVE_PROJECTILE_MIN_SPEED,i=Math.min(e*t,a);this.position.x+=o/a*i,this.position.y+=r/a*i,this.velocity.x=o/a*e,this.velocity.y=r/a*e}}this.isAttacking&&(this.trail.push(new i(this.position.x,this.position.y)),this.trail.length>s.GRAVE_PROJECTILE_TRAIL_LENGTH&&this.trail.shift(),this.lifetime+=t,!this.targetEnemy&&this.lifetime>2&&this.returnToOrbit()),this.isAttacking&&this.targetEnemy&&this.position.distanceTo(this.targetEnemy.position)<s.GRAVE_PROJECTILE_HIT_DISTANCE&&("health"in this.targetEnemy&&(this.targetEnemy.health-=s.GRAVE_ATTACK_DAMAGE),this.returnToOrbit())}launchAtTarget(t){this.isAttacking=!0,this.targetEnemy=t,this.trail=[],this.lifetime=0;const e=t.position.x-this.position.x,i=t.position.y-this.position.y,n=Math.sqrt(e*e+i*i);if(n>0){const t=e/n,o=i/n;this.velocity.x=t*s.GRAVE_PROJECTILE_LAUNCH_SPEED,this.velocity.y=o*s.GRAVE_PROJECTILE_LAUNCH_SPEED}}launchInDirection(t){this.isAttacking=!0,this.targetEnemy=null,this.trail=[],this.lifetime=0,this.velocity.x=t.x*s.GRAVE_PROJECTILE_LAUNCH_SPEED,this.velocity.y=t.y*s.GRAVE_PROJECTILE_LAUNCH_SPEED}returnToOrbit(){this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.lifetime=0}}return{Grave:class extends e{constructor(t,e){super(t,e,s.GRAVE_MAX_HEALTH,s.GRAVE_ATTACK_RANGE*s.GRAVE_HERO_ATTACK_RANGE_MULTIPLIER,s.GRAVE_ATTACK_DAMAGE,s.GRAVE_ATTACK_SPEED,5),this.projectiles=[],this.smallParticles=[],this.smallParticleCount=0,this.projectileLaunchCooldown=0,this.smallParticleRegenTimer=0,this.isUsingAbility=!1,this.blackHole=null,this.explosionPositions=[],this.isHero=!0;for(let n=0;n<s.GRAVE_NUM_PROJECTILES;n++){const o=n/s.GRAVE_NUM_PROJECTILES*Math.PI*2,a=Math.cos(o)*s.GRAVE_PROJECTILE_ORBIT_RADIUS,l=Math.sin(o)*s.GRAVE_PROJECTILE_ORBIT_RADIUS;this.projectiles.push(new r(new i(t.x+a,t.y+l),new i(0,0),e,n))}}spawnSmallParticle(){const t=Ja(),e=t.nextAngle(),s=t.nextFloat(20,50),o=new i(this.position.x+Math.cos(e)*s,this.position.y+Math.sin(e)*s);this.smallParticles.push(new n(o,this.owner)),this.smallParticleCount++}update(t,e,n,o=[]){if(super.update(t,e,n,o),this.explosionPositions=[],this.smallParticleCount<s.GRAVE_MAX_SMALL_PARTICLES){this.smallParticleRegenTimer+=t;const e=1/s.GRAVE_SMALL_PARTICLE_REGEN_RATE;for(;this.smallParticleRegenTimer>=e&&this.smallParticleCount<s.GRAVE_MAX_SMALL_PARTICLES;)this.spawnSmallParticle(),this.smallParticleRegenTimer-=e}this.projectileLaunchCooldown>0&&(this.projectileLaunchCooldown-=t),this.blackHole&&(this.blackHole.update(t),this.blackHole.shouldDespawn()&&(this.blackHole=null));const r=this.blackHole?this.blackHole.position:this.position;for(const e of this.projectiles)e.update(t,this.position);for(const e of this.smallParticles)e.update(t,r);const a=[];for(let t=0;t<this.smallParticles.length;t++){const s=this.smallParticles[t];for(const n of e)if("health"in n&&n.health>0&&s.checkCollision(n)){s.applySplashDamage(e),a.push(t),this.explosionPositions.push(new i(s.position.x,s.position.y));break}}for(let t=a.length-1;t>=0;t--){const e=a[t];this.smallParticles.splice(e,1),this.smallParticleCount--}if(this.canLaunchProjectile()&&this.position.distanceTo(this.target.position)<=this.attackRange){const t=this.projectiles.find(t=>!t.isAttacking);t&&(t.launchAtTarget(this.target),this.projectileLaunchCooldown=1/this.attackSpeed)}}canLaunchProjectile(){return!this.isUsingAbility&&null!==this.target&&this.projectileLaunchCooldown<=0}attack(t){}useAbility(t){return!!super.useAbility(t)&&(this.blackHole=new o(new i(this.position.x,this.position.y),t,this.owner),this.isUsingAbility=!1,!0)}startAbilityDrag(){this.isUsingAbility=!0}endAbilityDrag(){this.isUsingAbility=!1}getProjectiles(){return this.projectiles}getSmallParticles(){return this.smallParticles}getSmallParticleCount(){return this.smallParticleCount}getBlackHole(){return this.blackHole}getExplosionPositions(){return this.explosionPositions}},GraveProjectile:r,GraveSmallParticle:n,GraveBlackHole:o}})({Unit:Al,Vector2D:i,Constants:e}),{Ray:Bl,RayBeamSegment:Ul}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;return{Ray:class extends e{constructor(t,e){super(t,e,s.RAY_MAX_HEALTH,s.RAY_ATTACK_RANGE,s.RAY_ATTACK_DAMAGE,s.RAY_ATTACK_SPEED,s.RAY_ABILITY_COOLDOWN),this.beamSegments=[],this.drillDirection=null,this.isHero=!0}useAbility(t){return!!super.useAbility(t)&&(this.drillDirection=t,!0)}getBeamSegments(){return this.beamSegments}setBeamSegments(t){this.beamSegments=t}updateBeamSegments(t){this.beamSegments=this.beamSegments.filter(e=>!e.update(t))}},RayBeamSegment:class{constructor(t,e,i){this.startPos=t,this.endPos=e,this.owner=i,this.lifetime=0,this.maxLifetime=.5}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}}})({Unit:Al,Vector2D:i,Constants:e}),{InfluenceBall:Gl,InfluenceZone:Hl,InfluenceBallProjectile:Wl}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class n{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.maxLifetime=5,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldExplode(){return this.lifetime>=this.maxLifetime}}return{InfluenceBall:class extends e{constructor(t,e){super(t,e,s.INFLUENCE_BALL_MAX_HEALTH,s.INFLUENCE_BALL_ATTACK_RANGE,s.INFLUENCE_BALL_ATTACK_DAMAGE,s.INFLUENCE_BALL_ATTACK_SPEED,s.INFLUENCE_BALL_ABILITY_COOLDOWN),this.projectileToCreate=null,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const e=new i(t.x*s.INFLUENCE_BALL_PROJECTILE_SPEED,t.y*s.INFLUENCE_BALL_PROJECTILE_SPEED);return this.projectileToCreate=new n(new i(this.position.x,this.position.y),e,this.owner),!0}getAndClearProjectile(){const t=this.projectileToCreate;return this.projectileToCreate=null,t}},InfluenceZone:class{constructor(t,e,i=s.INFLUENCE_BALL_EXPLOSION_RADIUS,n=s.INFLUENCE_BALL_DURATION){this.position=t,this.owner=e,this.radius=i,this.duration=n,this.lifetime=0}update(t){return this.lifetime+=t,this.lifetime>=this.duration}isExpired(){return this.lifetime>=this.duration}},InfluenceBallProjectile:n}})({Unit:Al,Vector2D:i,Constants:e}),{TurretDeployer:$l,DeployedTurret:Vl}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;return{TurretDeployer:class extends e{constructor(t,e){super(t,e,s.TURRET_DEPLOYER_MAX_HEALTH,s.TURRET_DEPLOYER_ATTACK_RANGE,s.TURRET_DEPLOYER_ATTACK_DAMAGE,s.TURRET_DEPLOYER_ATTACK_SPEED,s.TURRET_DEPLOYER_ABILITY_COOLDOWN),this.isHero=!0}useAbility(t){return!!super.useAbility(t)}},DeployedTurret:class{constructor(t,e,i=null){this.position=t,this.owner=e,this.attachedToAsteroid=i,this.maxHealth=s.DEPLOYED_TURRET_MAX_HEALTH,this.attackCooldown=0,this.target=null,this.firingAnimationProgress=0,this.isFiring=!1,this.health=this.maxHealth}update(t,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.isFiring&&(this.firingAnimationProgress+=t/s.DEPLOYED_TURRET_ANIMATION_DURATION,this.firingAnimationProgress>=1&&(this.firingAnimationProgress=0,this.isFiring=!1)),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(e)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=s.DEPLOYED_TURRET_ATTACK_RANGE&&(this.attack(this.target),this.attackCooldown=1/s.DEPLOYED_TURRET_ATTACK_SPEED,this.isFiring=!0,this.firingAnimationProgress=0)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let e=null,i=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<i&&(i=t,e=s)}return e}attack(t){"health"in t&&(t.health-=s.DEPLOYED_TURRET_ATTACK_DAMAGE)}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}}})({Unit:Al,Vector2D:i,Constants:e}),{Driller:zl}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;return{Driller:class extends e{constructor(t,e){super(t,e,s.DRILLER_MAX_HEALTH,s.DRILLER_ATTACK_RANGE,s.DRILLER_ATTACK_DAMAGE,s.DRILLER_ATTACK_SPEED,s.DRILLER_ABILITY_COOLDOWN),this.isDrilling=!1,this.isHidden=!1,this.drillDirection=null,this.drillVelocity=new i(0,0),this.hiddenInAsteroid=null,this.isHero=!0}attack(t){}useAbility(t){return!this.isDrilling&&!!super.useAbility(t)&&(this.isDrilling=!0,this.isHidden=!1,this.drillDirection=t.normalize(),this.drillVelocity=new i(this.drillDirection.x*s.DRILLER_DRILL_SPEED,this.drillDirection.y*s.DRILLER_DRILL_SPEED),!0)}updateDrilling(t){this.isDrilling&&this.drillVelocity&&(this.position.x+=this.drillVelocity.x*t,this.position.y+=this.drillVelocity.y*t)}stopDrilling(){this.isDrilling=!1,this.drillVelocity=new i(0,0)}hideInAsteroid(t){this.isHidden=!0,this.hiddenInAsteroid=t,this.position=new i(t.position.x,t.position.y)}isHiddenInAsteroid(){return this.isHidden}}}})({Unit:Al,Vector2D:i,Constants:e}),{Dagger:jl}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:n}=t;return{Dagger:class extends e{constructor(t,e){super(t,e,s.DAGGER_MAX_HEALTH,s.DAGGER_ATTACK_RANGE,s.DAGGER_ATTACK_DAMAGE,s.DAGGER_ATTACK_SPEED,s.DAGGER_ABILITY_COOLDOWN),this.isCloaked=!0,this.visibilityTimer=0,this.canSeeEnemies=!1,this.enemyVisionTimer=0,this.isHero=!0}updateTimers(t){this.visibilityTimer>0&&(this.visibilityTimer-=t,this.visibilityTimer<=0&&(this.visibilityTimer=0,this.isCloaked=!0)),this.enemyVisionTimer>0&&(this.enemyVisionTimer-=t,this.enemyVisionTimer<=0&&(this.enemyVisionTimer=0,this.canSeeEnemies=!1))}useAbility(t){if(!super.useAbility(t))return!1;this.isCloaked=!1,this.visibilityTimer=s.DAGGER_VISIBILITY_DURATION,this.canSeeEnemies=!0,this.enemyVisionTimer=s.DAGGER_VISIBILITY_DURATION;const e=t.normalize(),o=Math.atan2(e.y,e.x),r=new i(400*Math.cos(o),400*Math.sin(o)),a=new n(new i(this.position.x,this.position.y),r,this.owner,s.DAGGER_ABILITY_DAMAGE);return a.maxRange=s.DAGGER_ABILITY_RANGE,this.lastAbilityEffects.push(a),!0}update(t,e,i,s=[]){let n=e;this.canSeeEnemies||(n=[]),super.update(t,n,i,s)}isCloakedToEnemies(){return this.isCloaked}hasEnemyVision(){return this.canSeeEnemies}}}})({Unit:Al,Vector2D:i,Constants:e,AbilityBullet:ol}),{Beam:Kl}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:n}=t;return{Beam:class extends e{constructor(t,e){super(t,e,s.BEAM_MAX_HEALTH,s.BEAM_ATTACK_RANGE,s.BEAM_ATTACK_DAMAGE,s.BEAM_ATTACK_SPEED,s.BEAM_ABILITY_COOLDOWN),this.lastBeamDamage=0,this.lastBeamDistance=0,this.lastBeamMultiplier=0,this.lastBeamTime=0,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const e=t.normalize(),o=new i(1e3*e.x,1e3*e.y),r=new n(new i(this.position.x,this.position.y),o,this.owner,s.BEAM_ABILITY_BASE_DAMAGE);return r.maxRange=s.BEAM_ABILITY_MAX_RANGE,r.isBeamProjectile=!0,r.beamOwner=this,this.lastAbilityEffects.push(r),!0}}}})({Unit:Al,Vector2D:i,Constants:e,AbilityBullet:ol}),{Mortar:Yl,MortarProjectile:Xl}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class n{constructor(t,e,i,s,n){this.position=t,this.owner=i,this.damage=s,this.splashRadius=n,this.lifetime=0,this.maxLifetime=3,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}checkHit(t){return this.position.distanceTo(t.position)<15}applySplashDamage(t){const e=[];for(const i of t){const t=this.position.distanceTo(i.position);if(t<=this.splashRadius){const n=1-t/this.splashRadius*(1-s.MORTAR_SPLASH_DAMAGE_FALLOFF),o=this.damage*n;"health"in i&&(i.health-=o,e.push(i))}}return e}}return{Mortar:class extends e{constructor(t,e){super(t,e,s.MORTAR_MAX_HEALTH,s.MORTAR_ATTACK_RANGE,s.MORTAR_ATTACK_DAMAGE,s.MORTAR_ATTACK_SPEED,s.MORTAR_ABILITY_COOLDOWN),this.isSetup=!1,this.facingDirection=null,this.lastShotProjectiles=[],this.isHero=!0}useAbility(t){return this.facingDirection=t.normalize(),this.isSetup=!0,!0}update(t,e,i,s=[]){if(!this.isSetup||!this.facingDirection)return this.attackCooldown>0&&(this.attackCooldown-=t),void(this.abilityCooldown>0&&(this.abilityCooldown-=t));const n=this.getEnemiesInCone(e);super.update(t,n,i,s)}getEnemiesInCone(t){if(!this.facingDirection)return[];const e=[],i=Math.atan2(this.facingDirection.y,this.facingDirection.x),n=s.MORTAR_DETECTION_CONE_ANGLE/2;for(const s of t){const t=s.position.x-this.position.x,o=s.position.y-this.position.y;let r=Math.atan2(o,t)-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;Math.abs(r)<=n&&e.push(s)}return e}attack(t){const e=t.position.x-this.position.x,o=t.position.y-this.position.y,r=Math.atan2(o,e),a=s.MORTAR_PROJECTILE_SPEED,l=new i(Math.cos(r)*a,Math.sin(r)*a),h=new n(new i(this.position.x,this.position.y),l,this.owner,this.attackDamage,s.MORTAR_SPLASH_RADIUS);this.lastShotProjectiles.push(h)}getAndClearLastShotProjectiles(){const t=this.lastShotProjectiles;return this.lastShotProjectiles=[],t}isReadyToFire(){return this.isSetup&&null!==this.facingDirection}getFacingDirection(){return this.facingDirection}},MortarProjectile:n}})({Unit:Al,Vector2D:i,Constants:e}),{Preist:ql,HealingBombParticle:Jl}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:n}=t;class o{constructor(t,e,i){this.position=t,this.velocity=e,this.owner=i,this.lifetime=0,this.maxLifetime=s.PREIST_HEALING_BOMB_PARTICLE_LIFETIME,this.hasHealed=new Set}update(t){return this.lifetime+=t,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime>=this.maxLifetime}}return{Preist:class extends e{constructor(t,e){super(t,e,s.PREIST_MAX_HEALTH,s.PREIST_HEALING_RANGE,s.PREIST_ATTACK_DAMAGE,s.PREIST_ATTACK_SPEED,s.PREIST_ABILITY_COOLDOWN),this.beamTargets=[],this.healingBombParticles=[],this.isHero=!0;for(let t=0;t<s.PREIST_NUM_BEAMS;t++)this.beamTargets.push({target:null,lockTimer:0})}update(t,e,i,n=[]){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.moveTowardRallyPoint(t,s.UNIT_MOVE_SPEED,i,n);const o=this.getFriendlyUnits(i);if(this.updateHealingBeams(t,o),this.updateHealingBombParticles(t,i),this.beamTargets[0].target&&!this.isTargetDead(this.beamTargets[0].target)){const e=this.beamTargets[0].target,i=e.position.x-this.position.x,n=e.position.y-this.position.y,o=Math.atan2(n,i)+Math.PI/2,r=this.getShortestAngleDelta(this.rotation,o),a=s.UNIT_TURN_SPEED_RAD_PER_SEC*t;Math.abs(r)<=a?this.rotation=o:this.rotation+=Math.sign(r)*a,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}getFriendlyUnits(t){return t.filter(t=>t.owner===this.owner&&t!==this&&!t.isDead())}updateHealingBeams(t,e){for(const e of this.beamTargets)if(e.lockTimer>0&&(e.lockTimer-=t),e.target){const t=this.isTargetDead(e.target),i=this.position.distanceTo(e.target.position)>this.attackRange,s="health"in e.target&&"maxHealth"in e.target&&e.target.health>=e.target.maxHealth;(t||i||s||e.lockTimer<=0)&&(e.target=null,e.lockTimer=0)}for(const t of this.beamTargets)if(!t.target){const i=this.findBestHealingTarget(e);i&&(t.target=i,t.lockTimer=s.PREIST_TARGET_LOCK_DURATION)}for(const e of this.beamTargets)if(e.target&&"health"in e.target&&"maxHealth"in e.target){const i=e.target,n=i.maxHealth*s.PREIST_HEALING_PER_SECOND*t;i.health=Math.min(i.maxHealth,i.health+n)}}findBestHealingTarget(t){const e=new Set(this.beamTargets.filter(t=>t.target).map(t=>t.target)),i=t.filter(t=>!e.has(t)&&(!(t.health>=t.maxHealth)&&this.position.distanceTo(t.position)<=this.attackRange));return 0===i.length?null:(i.sort((t,e)=>t.isHero!==e.isHero?t.isHero?-1:1:t.health/t.maxHealth-e.health/e.maxHealth),i[0])}getHealingBeamTargets(){return this.beamTargets.map(t=>t.target)}useAbility(t){if(!super.useAbility(t))return!1;const e=t.normalize(),o=new i(e.x*s.PREIST_HEALING_BOMB_SPEED,e.y*s.PREIST_HEALING_BOMB_SPEED),r=new n(new i(this.position.x,this.position.y),o,this.owner,0);return r.maxRange=s.PREIST_HEALING_BOMB_MAX_RANGE,r.isHealingBomb=!0,r.healingBombOwner=this,this.lastAbilityEffects.push(r),!0}explodeHealingBomb(t){const e=Ja();for(let n=0;n<s.PREIST_HEALING_BOMB_PARTICLE_COUNT;n++){const n=e.nextAngle(),r=e.nextFloat(.5,1),a=s.PREIST_HEALING_BOMB_PARTICLE_SPEED*r,l=new i(Math.cos(n)*a,Math.sin(n)*a),h=new o(new i(t.x,t.y),l,this.owner);this.healingBombParticles.push(h)}}updateHealingBombParticles(t,e){this.healingBombParticles=this.healingBombParticles.filter(i=>{const n=i.update(t);if(!n)for(const t of e)if(!t.isDead()&&!i.hasHealed.has(t)&&i.position.distanceTo(t.position)<=(t.collisionRadiusPx||s.UNIT_RADIUS_PX)){const e=t.maxHealth*s.PREIST_HEALING_BOMB_PARTICLE_HEALING;t.health=Math.min(t.maxHealth,t.health+e),i.hasHealed.add(t)}return!n})}getHealingBombParticles(){return this.healingBombParticles}attack(t){}},HealingBombParticle:o}})({Unit:Al,Vector2D:i,Constants:e,AbilityBullet:ol}),{Spotlight:Ql}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:n}=t;return{Spotlight:class extends e{constructor(t,e){super(t,e,s.SPOTLIGHT_MAX_HEALTH,s.SPOTLIGHT_ATTACK_RANGE,s.SPOTLIGHT_ATTACK_DAMAGE,s.SPOTLIGHT_ATTACK_SPEED,s.SPOTLIGHT_ABILITY_COOLDOWN),this.spotlightDirection=null,this.spotlightState="inactive",this.spotlightStateElapsedSec=0,this.spotlightFireCooldownSec=0,this.spotlightLengthFactor=0,this.spotlightRangePx=0,this.isHero=!0}attack(t){}useAbility(t){return"inactive"===this.spotlightState&&!!super.useAbility(t)&&(this.spotlightDirection=t.normalize(),this.spotlightState="setup",this.spotlightStateElapsedSec=0,this.spotlightFireCooldownSec=0,this.spotlightLengthFactor=0,!0)}updateSpotlightState(t){if("inactive"!==this.spotlightState){if(this.spotlightStateElapsedSec+=t,"setup"===this.spotlightState){const t=s.SPOTLIGHT_SETUP_TIME_SEC;this.spotlightLengthFactor=Math.min(1,this.spotlightStateElapsedSec/t),this.spotlightStateElapsedSec>=t&&(this.spotlightState="active",this.spotlightStateElapsedSec=0,this.spotlightLengthFactor=1)}else if("active"===this.spotlightState)this.spotlightLengthFactor=1,this.spotlightStateElapsedSec>=s.SPOTLIGHT_ACTIVE_TIME_SEC&&(this.spotlightState="teardown",this.spotlightStateElapsedSec=0);else if("teardown"===this.spotlightState){const t=s.SPOTLIGHT_TEARDOWN_TIME_SEC,e=Math.min(1,this.spotlightStateElapsedSec/t);this.spotlightLengthFactor=Math.max(0,1-e),this.spotlightStateElapsedSec>=t&&(this.spotlightState="inactive",this.spotlightDirection=null,this.spotlightLengthFactor=0,this.spotlightRangePx=0,this.spotlightFireCooldownSec=0)}this.spotlightFireCooldownSec>0&&(this.spotlightFireCooldownSec-=t)}}isSpotlightActive(){return"inactive"!==this.spotlightState}isSpotlightSetupComplete(){return"active"===this.spotlightState||"teardown"===this.spotlightState}getSpotlightStateCode(){switch(this.spotlightState){case"setup":return 1;case"active":return 2;case"teardown":return 3;default:return 0}}setSpotlightRangePx(t){this.spotlightRangePx=t}canFireSpotlight(){return this.isSpotlightSetupComplete()&&this.spotlightFireCooldownSec<=0}fireSpotlightAtTargets(t,e){const o=[],r=1/s.SPOTLIGHT_FIRE_RATE_PER_SEC;this.spotlightFireCooldownSec=r;for(const r of t){const t=r.position.x-this.position.x,a=r.position.y-this.position.y,l=t*t+a*a;if(l<=1e-4)continue;const h=1/Math.sqrt(l),c=new i(t*h*s.SPOTLIGHT_BULLET_SPEED,a*h*s.SPOTLIGHT_BULLET_SPEED),d=new n(new i(this.position.x,this.position.y),c,this.owner,s.SPOTLIGHT_BULLET_DAMAGE);d.maxLifetime=s.SPOTLIGHT_BULLET_LIFETIME_SEC,d.maxRange=e,d.isSpotlightBullet=!0,d.renderWidthPx=s.SPOTLIGHT_BULLET_WIDTH_PX,d.renderLengthPx=s.SPOTLIGHT_BULLET_LENGTH_PX,d.hitRadiusPx=s.SPOTLIGHT_BULLET_HIT_RADIUS_PX,o.push(d)}return o}}}})({Unit:Al,Vector2D:i,Constants:e,AbilityBullet:ol}),{Tank:Zl,CrescentWave:th}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class n{constructor(t,e,i,s){this.position=t,this.direction=e,this.angle=i,this.owner=s,this.lifetime=0,this.distanceTraveled=0,this.affectedUnits=new Set}update(t){const e=s.TANK_WAVE_SPEED*t;this.position.x+=this.direction.x*e,this.position.y+=this.direction.y*e,this.distanceTraveled+=e,this.lifetime+=t}shouldDespawn(){return this.distanceTraveled>=s.TANK_WAVE_RANGE}isPointInWave(t){const e=t.x-this.position.x,i=t.y-this.position.y;if(Math.sqrt(e*e+i*i)>s.TANK_WAVE_WIDTH)return!1;const n=Math.atan2(i,e),o=this.normalizeAngle(n-this.angle);return Math.abs(o)<=s.TANK_WAVE_ANGLE/2}normalizeAngle(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}}return{Tank:class extends e{constructor(t,e){super(t,e,s.TANK_MAX_HEALTH,s.TANK_ATTACK_RANGE,s.TANK_ATTACK_DAMAGE,s.TANK_ATTACK_SPEED,s.TANK_ABILITY_COOLDOWN,s.TANK_COLLISION_RADIUS_PX),this.crescentWave=null,this.isHero=!0}attack(t){}update(t,e,i,n=[]){if(this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.stunDuration>0)this.stunDuration-=t;else{if(this.moveTowardRallyPoint(t,s.UNIT_MOVE_SPEED,i,n),this.rallyPoint){const e=this.rallyPoint.x-this.position.x,i=this.rallyPoint.y-this.position.y;if(Math.abs(e)>.1||Math.abs(i)>.1){const n=Math.atan2(i,e)+Math.PI/2,o=this.getShortestAngleDelta(this.rotation,n),r=s.UNIT_TURN_SPEED_RAD_PER_SEC*t;Math.abs(o)<=r?this.rotation=n:this.rotation+=Math.sign(o)*r,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}else{const i=this.findNearestEnemy(e);if(i&&!this.isTargetDead(i)){const e=i.position.x-this.position.x,n=i.position.y-this.position.y,o=Math.atan2(n,e)+Math.PI/2,r=this.getShortestAngleDelta(this.rotation,o),a=s.UNIT_TURN_SPEED_RAD_PER_SEC*t;Math.abs(r)<=a?this.rotation=o:this.rotation+=Math.sign(r)*a,this.rotation=(this.rotation%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}}this.crescentWave&&(this.crescentWave.update(t),this.crescentWave.shouldDespawn()&&(this.crescentWave=null))}}useAbility(t){if(!super.useAbility(t))return!1;const e=Math.atan2(t.y,t.x);return this.crescentWave=new n(new i(this.position.x,this.position.y),t.normalize(),e,this.owner),!0}getCrescentWave(){return this.crescentWave}isPositionInShield(t){return this.position.distanceTo(t)<=s.TANK_SHIELD_RADIUS}},CrescentWave:n}})({Unit:Al,Vector2D:i,Constants:e}),{Nova:eh,NovaBomb:ih,NovaScatterBullet:sh}=(t=>{const{Unit:e,Vector2D:i,Constants:s,AbilityBullet:n}=t;class o{constructor(t,e,i,s){this.position=t,this.owner=i,this.lifetime=0,this.bounceCount=0,this.isArmed=!1,this.scatterDirection=null,this.velocity=e,this.novaUnit=s}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const e=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(e>s.NOVA_BOMB_MIN_SPEED){const i=s.NOVA_BOMB_DECELERATION*t,n=Math.max(s.NOVA_BOMB_MIN_SPEED,e-i)/e;this.velocity.x*=n,this.velocity.y*=n}this.lifetime+=t,this.lifetime>=s.NOVA_BOMB_ARMING_TIME&&(this.isArmed=!0)}bounce(t,e){if(this.bounceCount>=s.NOVA_BOMB_MAX_BOUNCES)return;const i=this.velocity.x*t+this.velocity.y*e;this.velocity.x=this.velocity.x-2*i*t,this.velocity.y=this.velocity.y-2*i*e,this.velocity.x*=s.NOVA_BOMB_BOUNCE_DAMPING,this.velocity.y*=s.NOVA_BOMB_BOUNCE_DAMPING,this.bounceCount++}trigger(t){this.isArmed&&(this.scatterDirection=t.normalize())}shouldExplode(){return null!==this.scatterDirection}getScatterDirection(){return this.scatterDirection}takeDamage(){const t=Ja();if(this.isArmed){if(null===this.scatterDirection){const e=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(e>0)this.scatterDirection=new i(this.velocity.x/e,this.velocity.y/e);else{const e=t.nextAngle();this.scatterDirection=new i(Math.cos(e),Math.sin(e))}}}else{const e=t.nextAngle();this.scatterDirection=new i(Math.cos(e),Math.sin(e))}}}return{Nova:class extends e{constructor(t,e){super(t,e,s.NOVA_MAX_HEALTH,s.NOVA_ATTACK_RANGE,s.NOVA_ATTACK_DAMAGE,s.NOVA_ATTACK_SPEED,s.NOVA_ABILITY_COOLDOWN),this.activeBomb=null,this.bombToCreate=null,this.isHero=!0}useAbility(t){if(null!==this.activeBomb&&this.activeBomb.isArmed)return this.activeBomb.trigger(t),!0;if(!super.useAbility(t))return!1;const e=new i(t.x*s.NOVA_BOMB_INITIAL_SPEED,t.y*s.NOVA_BOMB_INITIAL_SPEED);return this.bombToCreate=new o(new i(this.position.x,this.position.y),e,this.owner,this),!0}getAndClearBomb(){const t=this.bombToCreate;return this.bombToCreate=null,t&&(this.activeBomb=t),t}clearActiveBomb(){this.activeBomb=null}getActiveBomb(){return this.activeBomb}},NovaBomb:o,NovaScatterBullet:class{constructor(t,e,i,n=s.NOVA_BOMB_SCATTER_BULLET_DAMAGE,o=s.NOVA_BOMB_SCATTER_BULLET_LIFETIME){this.position=t,this.velocity=e,this.owner=i,this.damage=n,this.maxLifetime=o,this.lifetime=0}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}checkHit(t){return this.position.distanceTo(t.position)<15}}}})({Unit:Al,Vector2D:i,Constants:e,AbilityBullet:ol}),{Sly:nh,StickyBomb:oh,StickyLaser:rh,DisintegrationParticle:ah}=(t=>{const{Unit:e,Vector2D:i,Constants:s}=t;class n{constructor(t,e,i){this.position=t,this.owner=i,this.lifetime=0,this.maxLifetime=s.STICKY_BOMB_DISINTEGRATE_PARTICLE_LIFETIME,this.velocity=e}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class o{constructor(t,e,i,n,o,r){this.startPosition=t,this.direction=e,this.owner=i,this.damage=n,this.width=o,this.range=r,this.lifetime=0,this.maxLifetime=s.STICKY_BOMB_LASER_DURATION}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}getEndPosition(){return new i(this.startPosition.x+this.direction.x*this.range,this.startPosition.y+this.direction.y*this.range)}checkHit(t){const e=this.getEndPosition(),i=e.x-this.startPosition.x,s=e.y-this.startPosition.y,n=i*i+s*s;if(0===n)return this.startPosition.distanceTo(t.position)<this.width/2;const o=Math.max(0,Math.min(1,((t.position.x-this.startPosition.x)*i+(t.position.y-this.startPosition.y)*s)/n)),r=this.startPosition.x+o*i,a=this.startPosition.y+o*s,l=t.position.x-r,h=t.position.y-a;return Math.sqrt(l*l+h*h)<this.width/2}}class r{constructor(t,e,i,s){this.position=t,this.owner=i,this.slyOwner=s,this.lifetime=0,this.isStuck=!1,this.stuckTo=null,this.stuckSurface=null,this.surfaceNormal=null,this.isArmed=!1,this.armedTime=0,this.hasTriggered=!1,this.bounceCount=0,this.velocity=e}update(t){if(this.lifetime+=t,this.isArmed||(this.armedTime+=t,this.armedTime>=s.STICKY_BOMB_ARM_TIME&&(this.isArmed=!0)),this.isStuck)return;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(e>s.STICKY_BOMB_MIN_SPEED){const i=s.STICKY_BOMB_DECELERATION*t,n=Math.max(s.STICKY_BOMB_MIN_SPEED,e-i)/e;this.velocity.x*=n,this.velocity.y*=n}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}stickToSurface(t,e,s=null){this.isStuck=!0,this.stuckSurface=t,this.stuckTo=s;const n=Math.sqrt(e.x*e.x+e.y*e.y);this.surfaceNormal=n>.001?new i(e.x/n,e.y/n):new i(0,-1),this.velocity=new i(0,0)}shouldDisintegrate(){return!this.isStuck&&this.lifetime>=s.STICKY_BOMB_MAX_LIFETIME}shouldDespawn(){return this.hasTriggered||this.shouldDisintegrate()}triggerLasers(){if(!this.isArmed||!this.isStuck||this.hasTriggered||!this.surfaceNormal)return[];this.hasTriggered=!0;const t=[];t.push(new o(new i(this.position.x,this.position.y),new i(this.surfaceNormal.x,this.surfaceNormal.y),this.owner,s.STICKY_BOMB_WIDE_LASER_DAMAGE,s.STICKY_BOMB_WIDE_LASER_WIDTH,s.STICKY_BOMB_LASER_RANGE));const e=Math.atan2(this.surfaceNormal.y,this.surfaceNormal.x),n=e+s.STICKY_BOMB_LASER_ANGLE;t.push(new o(new i(this.position.x,this.position.y),new i(Math.cos(n),Math.sin(n)),this.owner,s.STICKY_BOMB_DIAGONAL_LASER_DAMAGE,s.STICKY_BOMB_DIAGONAL_LASER_WIDTH,s.STICKY_BOMB_LASER_RANGE));const r=e-s.STICKY_BOMB_LASER_ANGLE;return t.push(new o(new i(this.position.x,this.position.y),new i(Math.cos(r),Math.sin(r)),this.owner,s.STICKY_BOMB_DIAGONAL_LASER_DAMAGE,s.STICKY_BOMB_DIAGONAL_LASER_WIDTH,s.STICKY_BOMB_LASER_RANGE)),t}createDisintegrationParticles(){const t=[],e=s.STICKY_BOMB_DISINTEGRATE_PARTICLE_COUNT,o=Ja();for(let r=0;r<e;r++){const e=o.nextAngle(),r=s.STICKY_BOMB_DISINTEGRATE_PARTICLE_SPEED*o.nextFloat(.5,1),a=new i(Math.cos(e)*r,Math.sin(e)*r);t.push(new n(new i(this.position.x,this.position.y),a,this.owner))}return t}}return{Sly:class extends e{constructor(t,e){super(t,e,s.SLY_MAX_HEALTH,s.SLY_ATTACK_RANGE,s.SLY_ATTACK_DAMAGE,s.SLY_ATTACK_SPEED,s.SLY_ABILITY_COOLDOWN),this.activeBomb=null,this.bombToCreate=null,this.lasersToCreate=[],this.particlesToCreate=[],this.isHero=!0}useAbility(t){if(null!==this.activeBomb&&this.activeBomb.isArmed&&this.activeBomb.isStuck){const t=this.activeBomb.triggerLasers();return this.lasersToCreate.push(...t),this.activeBomb=null,!0}if(null===this.activeBomb){const e=t.normalize(),n=s.STICKY_BOMB_INITIAL_SPEED,o=new i(e.x*n,e.y*n),a=new r(new i(this.position.x,this.position.y),o,this.owner,this);return this.bombToCreate=a,this.activeBomb=a,!0}return!1}getAndClearBombToCreate(){const t=this.bombToCreate;return this.bombToCreate=null,t}getAndClearLasersToCreate(){const t=this.lasersToCreate;return this.lasersToCreate=[],t}getAndClearParticlesToCreate(){const t=this.particlesToCreate;return this.particlesToCreate=[],t}onBombDestroyed(t){this.activeBomb===t&&(this.particlesToCreate.push(...t.createDisintegrationParticles()),this.activeBomb=null)}},StickyBomb:r,StickyLaser:o,DisintegrationParticle:n}})({Unit:Al,Vector2D:i,Constants:e});class lh{constructor(t){this.particles=[],this.attractionMatrix=[],this.animationFrameId=null,this.isActive=!1,this.lastColorChangeMs=0,this.edgeGlows={top:[0,0,0],right:[0,0,0],bottom:[0,0,0],left:[0,0,0]},this.gradientColors=[[138,43,226],[147,51,234],[219,39,119],[236,72,153],[59,130,246],[14,165,233],[168,85,247],[192,132,252]],this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="-1";const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to create background particle canvas context. This may be due to browser compatibility or system limitations.");this.context=e,t.appendChild(this.canvas),this.resize(),this.initializeParticles(),this.initializeAttractionMatrix(),this.start()}initializeParticles(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1),i=this.getParticleRadiusPx();this.particles=[];for(let s=0;s<lh.PARTICLE_COUNT;s++){const n=this.gradientColors[s%this.gradientColors.length],o={x:Math.random()*t,y:Math.random()*e,velocityX:.5*(Math.random()-.5),velocityY:.5*(Math.random()-.5),colorR:n[0],colorG:n[1],colorB:n[2],targetColorR:n[0],targetColorG:n[1],targetColorB:n[2],radius:i};this.particles.push(o)}}initializeAttractionMatrix(){this.attractionMatrix=[];for(let t=0;t<lh.PARTICLE_COUNT;t++){this.attractionMatrix[t]=[];for(let e=0;e<lh.PARTICLE_COUNT;e++)this.attractionMatrix[t][e]=t===e?0:(Math.random()-.5)*lh.ATTRACTION_STRENGTH}}resize(){const t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.canvas.width=Math.round(e*t),this.canvas.height=Math.round(i*t),this.context.setTransform(t,0,0,t,0,0),this.updateParticleRadii()}start(){this.isActive||(this.isActive=!0,this.lastColorChangeMs=performance.now(),this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animate(){if(!this.isActive)return;const t=performance.now();t-this.lastColorChangeMs>=lh.COLOR_CHANGE_INTERVAL_MS&&(this.updateTargetColors(),this.lastColorChangeMs=t),this.updateParticles(),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.animate())}updateTargetColors(){for(let t=0;t<this.particles.length;t++){const e=Math.floor(Math.random()*this.gradientColors.length),i=this.gradientColors[e];this.particles[t].targetColorR=i[0],this.particles[t].targetColorG=i[1],this.particles[t].targetColorB=i[2]}}updateParticles(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);this.edgeGlows.top=[0,0,0],this.edgeGlows.right=[0,0,0],this.edgeGlows.bottom=[0,0,0],this.edgeGlows.left=[0,0,0];for(let i=0;i<this.particles.length;i++){const s=this.particles[i];for(let t=0;t<this.particles.length;t++){if(i===t)continue;const e=this.particles[t],n=e.x-s.x,o=e.y-s.y,r=Math.sqrt(n*n+o*o);if(r>0){const e=this.attractionMatrix[i][t],a=n/r*e,l=o/r*e;s.velocityX+=a,s.velocityY+=l}}const n=lh.EDGE_REPULSION_DISTANCE,o=lh.EDGE_REPULSION_STRENGTH;if(s.x<n){const t=(1-s.x/n)*o;s.velocityX+=t}if(s.x>t-n){const e=(1-(t-s.x)/n)*o;s.velocityX-=e}if(s.y<n){const t=(1-s.y/n)*o;s.velocityY+=t}if(s.y>e-n){const t=(1-(e-s.y)/n)*o;s.velocityY-=t}s.velocityX*=lh.FRICTION,s.velocityY*=lh.FRICTION;const r=Math.sqrt(s.velocityX*s.velocityX+s.velocityY*s.velocityY);if(r>lh.MAX_VELOCITY&&(s.velocityX=s.velocityX/r*lh.MAX_VELOCITY,s.velocityY=s.velocityY/r*lh.MAX_VELOCITY),r<lh.MIN_VELOCITY){const t=Math.random()*Math.PI*2;s.velocityX=Math.cos(t)*lh.MIN_VELOCITY,s.velocityY=Math.sin(t)*lh.MIN_VELOCITY}s.x+=s.velocityX,s.y+=s.velocityY,s.x<0&&(s.x=0,s.velocityX=Math.abs(s.velocityX)),s.x>t&&(s.x=t,s.velocityX=-Math.abs(s.velocityX)),s.y<0&&(s.y=0,s.velocityY=Math.abs(s.velocityY)),s.y>e&&(s.y=e,s.velocityY=-Math.abs(s.velocityY));const a=lh.EDGE_GLOW_DISTANCE,l=Math.round(s.colorR),h=Math.round(s.colorG),c=Math.round(s.colorB);if(s.y<a){const t=1-s.y/a;this.edgeGlows.top[0]+=l*t,this.edgeGlows.top[1]+=h*t,this.edgeGlows.top[2]+=c*t}if(s.y>e-a){const t=1-(e-s.y)/a;this.edgeGlows.bottom[0]+=l*t,this.edgeGlows.bottom[1]+=h*t,this.edgeGlows.bottom[2]+=c*t}if(s.x<a){const t=1-s.x/a;this.edgeGlows.left[0]+=l*t,this.edgeGlows.left[1]+=h*t,this.edgeGlows.left[2]+=c*t}if(s.x>t-a){const e=1-(t-s.x)/a;this.edgeGlows.right[0]+=l*e,this.edgeGlows.right[1]+=h*e,this.edgeGlows.right[2]+=c*e}s.colorR+=(s.targetColorR-s.colorR)*lh.COLOR_TRANSITION_SPEED,s.colorG+=(s.targetColorG-s.colorG)*lh.COLOR_TRANSITION_SPEED,s.colorB+=(s.targetColorB-s.colorB)*lh.COLOR_TRANSITION_SPEED}}updateParticleRadii(){const t=this.getParticleRadiusPx();for(let e=0;e<this.particles.length;e++)this.particles[e].radius=t}getParticleRadiusPx(){return window.matchMedia("(min-width: 768px)").matches?lh.PARTICLE_RADIUS_DESKTOP_PX:lh.PARTICLE_RADIUS_MOBILE_PX}render(){const t=this.canvas.width/(window.devicePixelRatio||1),e=this.canvas.height/(window.devicePixelRatio||1);this.context.fillStyle="#000000",this.context.fillRect(0,0,t,e),this.context.globalCompositeOperation="screen",this.context.filter="blur(40px)";const i=lh.EDGE_GLOW_NORMALIZATION,s=Math.min(255,Math.round(this.edgeGlows.top[0]/i*255)),n=Math.min(255,Math.round(this.edgeGlows.top[1]/i*255)),o=Math.min(255,Math.round(this.edgeGlows.top[2]/i*255));if(s+n+o>0){const e=this.context.createLinearGradient(0,0,0,60);e.addColorStop(0,`rgba(${s}, ${n}, ${o}, 0.6)`),e.addColorStop(1,`rgba(${s}, ${n}, ${o}, 0)`),this.context.fillStyle=e,this.context.fillRect(0,0,t,60)}const r=Math.min(255,Math.round(this.edgeGlows.bottom[0]/i*255)),a=Math.min(255,Math.round(this.edgeGlows.bottom[1]/i*255)),l=Math.min(255,Math.round(this.edgeGlows.bottom[2]/i*255));if(r+a+l>0){const i=this.context.createLinearGradient(0,e-60,0,e);i.addColorStop(0,`rgba(${r}, ${a}, ${l}, 0)`),i.addColorStop(1,`rgba(${r}, ${a}, ${l}, 0.6)`),this.context.fillStyle=i,this.context.fillRect(0,e-60,t,60)}const h=Math.min(255,Math.round(this.edgeGlows.left[0]/i*255)),c=Math.min(255,Math.round(this.edgeGlows.left[1]/i*255)),d=Math.min(255,Math.round(this.edgeGlows.left[2]/i*255));if(h+c+d>0){const t=this.context.createLinearGradient(0,0,60,0);t.addColorStop(0,`rgba(${h}, ${c}, ${d}, 0.6)`),t.addColorStop(1,`rgba(${h}, ${c}, ${d}, 0)`),this.context.fillStyle=t,this.context.fillRect(0,0,60,e)}const u=Math.min(255,Math.round(this.edgeGlows.right[0]/i*255)),p=Math.min(255,Math.round(this.edgeGlows.right[1]/i*255)),g=Math.min(255,Math.round(this.edgeGlows.right[2]/i*255));if(u+p+g>0){const i=this.context.createLinearGradient(t-60,0,t,0);i.addColorStop(0,`rgba(${u}, ${p}, ${g}, 0)`),i.addColorStop(1,`rgba(${u}, ${p}, ${g}, 0.6)`),this.context.fillStyle=i,this.context.fillRect(t-60,0,60,e)}this.context.filter="blur(60px)",this.context.globalCompositeOperation="screen";for(const t of this.particles){const e=this.context.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius),i=Math.round(t.colorR),s=Math.round(t.colorG),n=Math.round(t.colorB);e.addColorStop(0,`rgba(${i}, ${s}, ${n}, 0.4)`),e.addColorStop(1,`rgba(${i}, ${s}, ${n}, 0)`),this.context.fillStyle=e,this.context.beginPath(),this.context.arc(t.x,t.y,t.radius,0,2*Math.PI),this.context.fill()}this.context.filter="none",this.context.globalCompositeOperation="source-over"}destroy(){this.stop(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas)}}lh.PARTICLE_COUNT=8,lh.PARTICLE_RADIUS_MOBILE_PX=37.5,lh.PARTICLE_RADIUS_DESKTOP_PX=75,lh.MAX_VELOCITY=.3,lh.MIN_VELOCITY=.02,lh.FRICTION=.98,lh.COLOR_TRANSITION_SPEED=.002,lh.ATTRACTION_STRENGTH=.15,lh.COLOR_CHANGE_INTERVAL_MS=8e3,lh.EDGE_REPULSION_DISTANCE=300,lh.EDGE_REPULSION_STRENGTH=.05,lh.EDGE_GLOW_DISTANCE=400,lh.EDGE_GLOW_NORMALIZATION=350*lh.PARTICLE_COUNT;class hh{constructor(t,e){this.asteroids=[],this.animationFrameId=null,this.isActive=!1,this.widthPx=0,this.heightPx=0,this.container=t,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="0",this.canvas.style.opacity="0.2";const i=this.canvas.getContext("2d");if(!i)throw new Error("Unable to create menu atmosphere canvas context.");this.context=i,this.sunSprite=new Image,this.sunSprite.src=e,this.container.appendChild(this.canvas),this.resize(),this.initializeAsteroids(),this.start()}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resize(){const t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.widthPx=e,this.heightPx=i,this.canvas.width=Math.round(e*t),this.canvas.height=Math.round(i*t),this.context.setTransform(t,0,0,t,0,0)}destroy(){this.stop(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas)}initializeAsteroids(){this.asteroids=[];for(let t=0;t<hh.ASTEROID_COUNT;t++)this.asteroids.push(this.createAsteroid())}createAsteroid(){const t=this.randomRange(hh.ASTEROID_MIN_RADIUS_PX,hh.ASTEROID_MAX_RADIUS_PX),e=this.createSpawnPosition(),i=this.createVelocity(),s=this.randomRange(hh.ASTEROID_ROTATION_MIN_RAD,hh.ASTEROID_ROTATION_MAX_RAD),n=[],o=7+Math.floor(4*Math.random());for(let t=0;t<o;t++)n.push({angleRad:2*Math.PI*t/o,radiusScale:.7+.5*Math.random()});return{x:e.x,y:e.y,radiusPx:t,velocityX:i.x,velocityY:i.y,rotationRad:Math.random()*Math.PI*2,rotationSpeedRad:s*(Math.random()>.5?1:-1),points:n}}createSpawnPosition(){const t=hh.BOUNDS_MARGIN_PX;return Math.random()<.5?{x:this.randomRange(-t,this.widthPx+t),y:this.randomRange(.6*-t,.7*this.heightPx)}:{x:this.randomRange(-t,.7*this.widthPx),y:this.randomRange(-t,this.heightPx+t)}}createVelocity(){const t=this.randomRange(hh.ASTEROID_SPEED_MIN,hh.ASTEROID_SPEED_MAX),e=Math.random()*Math.PI*2;return{x:Math.cos(e)*t,y:Math.sin(e)*t}}animate(){this.isActive&&(this.updateAsteroids(),this.render(),this.animationFrameId=requestAnimationFrame(()=>this.animate()))}updateAsteroids(){const t=hh.BOUNDS_MARGIN_PX,e=-t,i=-t,s=this.widthPx+t,n=this.heightPx+t;for(const t of this.asteroids)if(t.x+=t.velocityX,t.y+=t.velocityY,t.rotationRad+=t.rotationSpeedRad,t.x<e||t.x>s||t.y<i||t.y>n){const e=this.createSpawnPosition(),i=this.createVelocity();t.x=e.x,t.y=e.y,t.velocityX=i.x,t.velocityY=i.y}}render(){this.context.clearRect(0,0,this.widthPx,this.heightPx),this.renderSunGlow(),this.renderAsteroids()}renderSunGlow(){const t=this.getSunCenter(),e=this.context.createRadialGradient(t.x,t.y,.35*hh.SUN_RADIUS_PX,t.x,t.y,hh.SUN_GLOW_RADIUS_PX);if(e.addColorStop(0,"rgba(255, 240, 200, 0.9)"),e.addColorStop(.4,"rgba(255, 200, 120, 0.5)"),e.addColorStop(.7,"rgba(255, 150, 80, 0.25)"),e.addColorStop(1,"rgba(255, 120, 40, 0)"),this.context.fillStyle=e,this.context.beginPath(),this.context.arc(t.x,t.y,hh.SUN_GLOW_RADIUS_PX,0,2*Math.PI),this.context.fill(),this.sunSprite.complete&&this.sunSprite.naturalWidth>0){const e=2*hh.SUN_RADIUS_PX;this.context.drawImage(this.sunSprite,t.x-hh.SUN_RADIUS_PX,t.y-hh.SUN_RADIUS_PX,e,e)}else this.context.fillStyle="rgba(255, 215, 120, 0.95)",this.context.beginPath(),this.context.arc(t.x,t.y,hh.SUN_RADIUS_PX,0,2*Math.PI),this.context.fill()}renderAsteroids(){this.getSunCenter();for(const t of this.asteroids){const e=this.getAsteroidPoints(t);this.renderAsteroidBody(t,e)}}renderAsteroidShadow(t,e,i){const s=this.getShadowOffset(t,i),n=hh.SHADOW_LENGTH_BASE_PX+t.radiusPx*hh.SHADOW_LENGTH_MULTIPLIER;this.context.fillStyle="rgba(20, 14, 12, 0.45)",this.context.beginPath();for(let t=0;t<e.length;t++){const i=e[t];0===t?this.context.moveTo(i.x,i.y):this.context.lineTo(i.x,i.y)}for(let t=e.length-1;t>=0;t--){const i=e[t];this.context.lineTo(i.x+s.x*n,i.y+s.y*n)}this.context.closePath(),this.context.fill()}renderAsteroidBody(t,e){this.context.fillStyle="rgba(170, 160, 140, 0.8)",this.context.beginPath();for(let t=0;t<e.length;t++){const i=e[t];0===t?this.context.moveTo(i.x,i.y):this.context.lineTo(i.x,i.y)}this.context.closePath(),this.context.fill(),this.context.strokeStyle="rgba(120, 105, 90, 0.65)",this.context.lineWidth=1,this.context.stroke()}getSunCenter(){return{x:hh.SUN_RADIUS_PX+hh.SUN_OFFSET_X_PX,y:hh.SUN_RADIUS_PX+hh.SUN_OFFSET_Y_PX}}getShadowOffset(t,e){const i=t.x-e.x,s=t.y-e.y,n=Math.max(1,Math.hypot(i,s));return{x:i/n,y:s/n}}getAsteroidPoints(t){const e=[],i=t.points;for(let s=0;s<i.length;s++){const n=i[s],o=n.angleRad+t.rotationRad,r=t.radiusPx*n.radiusScale;e.push({x:t.x+Math.cos(o)*r,y:t.y+Math.sin(o)*r})}return e}randomRange(t,e){return t+Math.random()*(e-t)}}hh.ASTEROID_COUNT=14,hh.ASTEROID_MIN_RADIUS_PX=6,hh.ASTEROID_MAX_RADIUS_PX=16,hh.ASTEROID_SPEED_MIN=.06,hh.ASTEROID_SPEED_MAX=.18,hh.ASTEROID_ROTATION_MIN_RAD=.004,hh.ASTEROID_ROTATION_MAX_RAD=.014,hh.SUN_RADIUS_PX=120,hh.SUN_GLOW_RADIUS_PX=320,hh.SUN_OFFSET_X_PX=-28,hh.SUN_OFFSET_Y_PX=-22,hh.SHADOW_LENGTH_BASE_PX=120,hh.SHADOW_LENGTH_MULTIPLIER=7.5,hh.BOUNDS_MARGIN_PX=80;class ch{constructor(t){this.particles=[],this.animationFrameId=null,this.isActive=!1,this.needsTargetRefresh=!1,this.lastTargetRefreshMs=0,this.targetRefreshContainer=null,this.densityMultiplier=1,this.desiredParticleCount=0,this.menuContentElement=null,this.particleOpacity=ch.BASE_PARTICLE_OPACITY,this.menuOpacity=1,this.transitionStartMs=null,this.container=t,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="2";const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to create menu particle canvas context.");this.context=e,this.offscreenCanvas=document.createElement("canvas");const i=this.offscreenCanvas.getContext("2d");if(!i)throw new Error("Unable to create offscreen particle canvas context.");this.offscreenContext=i,this.container.appendChild(this.canvas),requestAnimationFrame(()=>{try{this.resize()}catch(t){console.error("Failed to resize particle canvas:",t)}}),this.start()}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resize(){const t=this.container.getBoundingClientRect(),e=window.devicePixelRatio||1,i=t.width||window.innerWidth,s=t.height||window.innerHeight;this.canvas.width=Math.round(i*e),this.canvas.height=Math.round(s*e),this.context.setTransform(e,0,0,e,0,0)}setMenuContentElement(t){this.menuContentElement=t,this.applyMenuOpacity()}requestTargetRefresh(t){this.needsTargetRefresh=!0,this.targetRefreshContainer=t}clearTargets(){this.setTargets([])}setDensityMultiplier(t){this.densityMultiplier=Math.max(.5,t)}startTransition(){this.transitionStartMs=performance.now()}animate(){if(!this.isActive)return;const t=performance.now();this.needsTargetRefresh&&this.targetRefreshContainer&&t-this.lastTargetRefreshMs>=ch.REFRESH_INTERVAL_MS&&(this.updateTargetsFromElements(this.targetRefreshContainer),this.lastTargetRefreshMs=t,this.needsTargetRefresh=!1),this.updateParticles(t),this.renderParticles(),this.animationFrameId=requestAnimationFrame(()=>this.animate())}updateTargetsFromElements(t){const e=this.collectTargets(t);this.setTargets(e)}setTargets(t){const e=[],i=t.length;if(0===i)return this.particles=e,void(this.desiredParticleCount=0);this.desiredParticleCount=i;const s=this.desiredParticleCount,n=this.particles.slice();for(n.length>s&&(n.length=s);n.length<s;){const e=t[n.length%i];n.push(this.createParticle(e.x,e.y,e.color))}for(let o=0;o<s;o++){const s=t[o%i],r=n[o],a=this.getRelocatedTarget(s);r.targetX=a.x,r.targetY=a.y,r.baseTargetX=a.x,r.baseTargetY=a.y;const l=this.parseColor(s.color);r.targetColorR=l.r,r.targetColorG=l.g,r.targetColorB=l.b,r.sizePx=ch.PARTICLE_SIZE_PX,e.push(r)}this.particles=e}createParticle(t,e,i){const s=Math.random()*Math.PI*2,n=ch.DRIFT_RADIUS_MIN_PX+Math.random()*(ch.DRIFT_RADIUS_MAX_PX-ch.DRIFT_RADIUS_MIN_PX),o=.8+.4*Math.random(),r=this.parseColor(i);return{x:t,y:e,velocityX:0,velocityY:0,targetX:t,targetY:e,baseTargetX:t,baseTargetY:e,colorR:r.r,colorG:r.g,colorB:r.b,targetColorR:r.r,targetColorG:r.g,targetColorB:r.b,sizePx:ch.PARTICLE_SIZE_PX,driftPhase:s,driftRadiusPx:n,speedMultiplier:o}}getRelocatedTarget(t){const e=ch.RELOCATE_MIN_DISTANCE_PX,i=ch.RELOCATE_MAX_DISTANCE_PX,s=e+Math.random()*(i-e),n=Math.random()*Math.PI*2;return{x:t.x+Math.cos(n)*s,y:t.y+Math.sin(n)*s}}updateParticles(t){this.updateTransition(t);const e=t*ch.DRIFT_SPEED;for(const t of this.particles){const i=e*t.speedMultiplier,s=Math.cos(t.driftPhase+i)*t.driftRadiusPx,n=Math.sin(t.driftPhase+i)*t.driftRadiusPx;t.baseTargetX=t.targetX+s,t.baseTargetY=t.targetY+n;const o=t.baseTargetX-t.x,r=t.baseTargetY-t.y,a=ch.POSITION_SMOOTHING*t.speedMultiplier;t.velocityX+=o*a,t.velocityY+=r*a,t.velocityX*=.82,t.velocityY*=.82,t.x+=t.velocityX,t.y+=t.velocityY,t.colorR+=(t.targetColorR-t.colorR)*ch.COLOR_SMOOTHING,t.colorG+=(t.targetColorG-t.colorG)*ch.COLOR_SMOOTHING,t.colorB+=(t.targetColorB-t.colorB)*ch.COLOR_SMOOTHING}}updateTransition(t){if(null===this.transitionStartMs)return this.particleOpacity=ch.BASE_PARTICLE_OPACITY,this.menuOpacity=1,void this.applyMenuOpacity();const e=t-this.transitionStartMs,i=ch.TRANSITION_DURATION_MS,s=i/2;if(e>=i)return this.transitionStartMs=null,this.particleOpacity=ch.BASE_PARTICLE_OPACITY,this.menuOpacity=1,void this.applyMenuOpacity();if(e<=s){const t=e/s;this.particleOpacity=ch.BASE_PARTICLE_OPACITY+(ch.PEAK_PARTICLE_OPACITY-ch.BASE_PARTICLE_OPACITY)*t,this.menuOpacity=1-t}else{const t=(e-s)/s;this.particleOpacity=ch.PEAK_PARTICLE_OPACITY+(ch.BASE_PARTICLE_OPACITY-ch.PEAK_PARTICLE_OPACITY)*t,this.menuOpacity=t}this.applyMenuOpacity()}applyMenuOpacity(){this.menuContentElement&&(this.menuContentElement.style.opacity=this.menuOpacity.toFixed(3))}renderParticles(){const t=this.container.getBoundingClientRect(),e=t.width||window.innerWidth,i=t.height||window.innerHeight;this.context.clearRect(0,0,e,i),this.context.globalCompositeOperation="lighter",this.context.globalAlpha=this.particleOpacity;for(const t of this.particles){const e=Math.min(255,Math.max(0,Math.round(t.colorR))),i=Math.min(255,Math.max(0,Math.round(t.colorG))),s=Math.min(255,Math.max(0,Math.round(t.colorB)));this.context.fillStyle=`rgb(${e}, ${i}, ${s})`,this.context.beginPath(),this.context.arc(t.x,t.y,t.sizePx,0,2*Math.PI),this.context.fill()}this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over"}collectTargets(t){const e=Array.from(t.querySelectorAll("[data-particle-text], [data-particle-box]")),i=[];for(const t of e)void 0!==t.dataset.particleText&&i.push(...this.collectTextTargets(t)),void 0!==t.dataset.particleBox&&i.push(...this.collectBoxTargets(t));return i}collectTextTargets(t){var e;const i=null===(e=t.textContent)||void 0===e?void 0:e.trim();if(!i)return[];const s=t.getBoundingClientRect();if(s.width<=0||s.height<=0)return[];const n=window.getComputedStyle(t),o=Number.parseFloat(n.fontSize)||16,r=n.fontFamily||"Arial, sans-serif",a=n.fontWeight||"600",l=t.dataset.particleColor||"#FFFFFF",h=Math.max(3,Math.round(o/7.5)),c=Math.max(2,Math.round(h/this.densityMultiplier));this.offscreenCanvas.width=Math.ceil(s.width),this.offscreenCanvas.height=Math.ceil(s.height),this.offscreenContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.offscreenContext.font=`${a} ${o}px ${r}`,this.offscreenContext.textAlign="center",this.offscreenContext.textBaseline="middle",this.offscreenContext.fillStyle="#FFFFFF",this.offscreenContext.fillText(i,this.offscreenCanvas.width/2,this.offscreenCanvas.height/2);const d=this.offscreenContext.getImageData(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height).data,u=[],p=c/2;for(let t=c/2;t<this.offscreenCanvas.height;t+=c)for(let e=p;e<this.offscreenCanvas.width;e+=c)d[4*(Math.floor(t)*this.offscreenCanvas.width+Math.floor(e))+3]>80&&u.push({x:s.left+e,y:s.top+t,color:l});return u}collectBoxTargets(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return[];const i=t.dataset.particleColor||"#FFFFFF",s=Math.max(6,Math.round(Math.min(e.width,e.height)/12)),n=Math.max(3,Math.round(s/this.densityMultiplier)),o=[],r=e.left,a=e.right,l=e.top,h=e.bottom;for(let t=r;t<=a;t+=n)o.push({x:t,y:l,color:i}),o.push({x:t,y:h,color:i});for(let t=l;t<=h;t+=n)o.push({x:r,y:t,color:i}),o.push({x:a,y:t,color:i});return o}parseColor(t){const e=t.trim();if(e.startsWith("#")){const t=e.slice(1);if(3===t.length)return{r:Number.parseInt(t[0]+t[0],16),g:Number.parseInt(t[1]+t[1],16),b:Number.parseInt(t[2]+t[2],16)};if(6===t.length)return{r:Number.parseInt(t.slice(0,2),16),g:Number.parseInt(t.slice(2,4),16),b:Number.parseInt(t.slice(4,6),16)}}return{r:255,g:255,b:255}}}ch.REFRESH_INTERVAL_MS=140,ch.POSITION_SMOOTHING=.08/14,ch.DRIFT_SPEED=7e-4/6,ch.DRIFT_RADIUS_MIN_PX=.03,ch.DRIFT_RADIUS_MAX_PX=.11,ch.COLOR_SMOOTHING=.08,ch.PARTICLE_SIZE_PX=1.6,ch.RELOCATE_MIN_DISTANCE_PX=4,ch.RELOCATE_MAX_DISTANCE_PX=12,ch.BASE_PARTICLE_OPACITY=.15,ch.PEAK_PARTICLE_OPACITY=.4,ch.TRANSITION_DURATION_MS=600;const dh={SpaceBlack:{id:"SpaceBlack",name:"Space Black",background:"#000000",asteroidColors:{fillStart:"#878787",fillEnd:"#505050",strokeStart:"#9B9B9B",strokeEnd:"#646464"},spaceDustPalette:{neutral:["#5a5a5a","#6c6c6c","#7f7f7f","#8f8f8f"],accent:["#5b6c8f","#6a5f8f","#7a6aa6"]},sunCore:{inner:"rgba(255, 255, 255, 1)",mid:"rgba(255, 230, 120, 1)",outer:"rgba(255, 180, 50, 0.9)"},sunGlow:{outerGlow1:"rgba(255, 220, 100, 0.8)",outerGlow2:"rgba(255, 180, 50, 0.4)",outerGlow3:"rgba(255, 140, 30, 0.2)",outerGlow4:"rgba(255, 100, 0, 0)"},sunLightRays:{nearCenter:"rgba(255, 245, 215, 0.2)",mid:"rgba(255, 220, 170, 0.45)",edge:"rgba(255, 200, 140, 0.7)"},lensFlareHalo:"rgba(255, 240, 200, 0.15)"},ColdIce:{id:"ColdIce",name:"Cold Ice",background:"#0B1426",asteroidColors:{fillStart:"#4A3B6E",fillEnd:"#7B63A6",strokeStart:"#6A52A0",strokeEnd:"#B39DE6"},spaceDustPalette:{neutral:["#6D717B","#7C808A","#8A8D97","#9A9EB0"],accent:["#6C5A91","#7B66A8","#8B75C3","#9A82D6"]},sunCore:{inner:"rgba(230, 245, 255, 1)",mid:"rgba(190, 220, 255, 0.95)",outer:"rgba(150, 200, 255, 0.85)"},sunGlow:{outerGlow1:"rgba(200, 230, 255, 0.75)",outerGlow2:"rgba(160, 210, 255, 0.45)",outerGlow3:"rgba(120, 190, 255, 0.25)",outerGlow4:"rgba(80, 170, 255, 0)"},sunLightRays:{nearCenter:"rgba(220, 240, 255, 0.2)",mid:"rgba(170, 215, 255, 0.45)",edge:"rgba(130, 190, 255, 0.7)"},lensFlareHalo:"rgba(210, 235, 255, 0.18)"},DeepSpace:{id:"DeepSpace",name:"Deep Space",background:"#0A0A1E",asteroidColors:{fillStart:"#4A4A7E",fillEnd:"#2E2E5A",strokeStart:"#6A6A9E",strokeEnd:"#4A4A7A"},spaceDustPalette:{neutral:["#3A3A5E","#4A4A6E","#5A5A7E","#6A6A8E"],accent:["#5A4A8F","#6A5A9F","#7A6AAF","#8A7ABF"]},sunCore:{inner:"rgba(220, 200, 255, 1)",mid:"rgba(180, 150, 230, 0.95)",outer:"rgba(140, 100, 200, 0.85)"},sunGlow:{outerGlow1:"rgba(170, 140, 230, 0.75)",outerGlow2:"rgba(140, 110, 200, 0.45)",outerGlow3:"rgba(110, 80, 170, 0.25)",outerGlow4:"rgba(80, 50, 140, 0)"},sunLightRays:{nearCenter:"rgba(200, 180, 240, 0.2)",mid:"rgba(160, 130, 210, 0.45)",edge:"rgba(120, 90, 180, 0.7)"},lensFlareHalo:"rgba(190, 170, 230, 0.18)"},RedGiant:{id:"RedGiant",name:"Red Giant",background:"#1A0A0A",asteroidColors:{fillStart:"#8A5A5A",fillEnd:"#5A3030",strokeStart:"#AA7A7A",strokeEnd:"#7A4A4A"},spaceDustPalette:{neutral:["#6A4A4A","#7A5A5A","#8A6A6A","#9A7A7A"],accent:["#8F5A4A","#9F6A5A","#AF7A6A","#BF8A7A"]},sunCore:{inner:"rgba(255, 240, 200, 1)",mid:"rgba(255, 160, 80, 0.95)",outer:"rgba(255, 100, 60, 0.85)"},sunGlow:{outerGlow1:"rgba(255, 140, 80, 0.75)",outerGlow2:"rgba(240, 100, 60, 0.45)",outerGlow3:"rgba(220, 60, 40, 0.25)",outerGlow4:"rgba(200, 40, 20, 0)"},sunLightRays:{nearCenter:"rgba(255, 200, 150, 0.2)",mid:"rgba(255, 140, 90, 0.45)",edge:"rgba(240, 100, 60, 0.7)"},lensFlareHalo:"rgba(255, 180, 120, 0.18)"},Nebula:{id:"Nebula",name:"Nebula",background:"#150A1A",asteroidColors:{fillStart:"#7A4A7A",fillEnd:"#5A2A5A",strokeStart:"#9A6A9A",strokeEnd:"#7A4A7A"},spaceDustPalette:{neutral:["#6A4A6A","#7A5A7A","#8A6A8A","#9A7A9A"],accent:["#8F4A7A","#9F5A8A","#AF6A9A","#BF7AAA"]},sunCore:{inner:"rgba(255, 220, 255, 1)",mid:"rgba(240, 150, 220, 0.95)",outer:"rgba(200, 100, 180, 0.85)"},sunGlow:{outerGlow1:"rgba(230, 140, 210, 0.75)",outerGlow2:"rgba(200, 100, 180, 0.45)",outerGlow3:"rgba(170, 70, 150, 0.25)",outerGlow4:"rgba(140, 50, 120, 0)"},sunLightRays:{nearCenter:"rgba(240, 180, 230, 0.2)",mid:"rgba(210, 130, 190, 0.45)",edge:"rgba(180, 90, 160, 0.7)"},lensFlareHalo:"rgba(230, 160, 210, 0.18)"},GreenAurora:{id:"GreenAurora",name:"Green Aurora",background:"#0A1A14",asteroidColors:{fillStart:"#4A7A5A",fillEnd:"#2A5A3A",strokeStart:"#6A9A7A",strokeEnd:"#4A7A5A"},spaceDustPalette:{neutral:["#4A6A5A","#5A7A6A","#6A8A7A","#7A9A8A"],accent:["#4A8F6A","#5A9F7A","#6AAF8A","#7ABF9A"]},sunCore:{inner:"rgba(220, 255, 230, 1)",mid:"rgba(160, 240, 180, 0.95)",outer:"rgba(100, 200, 140, 0.85)"},sunGlow:{outerGlow1:"rgba(140, 230, 170, 0.75)",outerGlow2:"rgba(100, 200, 140, 0.45)",outerGlow3:"rgba(70, 170, 110, 0.25)",outerGlow4:"rgba(50, 140, 80, 0)"},sunLightRays:{nearCenter:"rgba(180, 240, 210, 0.2)",mid:"rgba(130, 210, 170, 0.45)",edge:"rgba(90, 180, 130, 0.7)"},lensFlareHalo:"rgba(160, 230, 190, 0.18)"}};function uh(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;class ph extends Error{constructor(t,e="FunctionsError",i){super(t),this.name=e,this.context=i}}class gh extends ph{constructor(t){super("Failed to send a request to the Edge Function","FunctionsFetchError",t)}}class yh extends ph{constructor(t){super("Relay Error invoking the Edge Function","FunctionsRelayError",t)}}class fh extends ph{constructor(t){super("Edge Function returned a non-2xx status code","FunctionsHttpError",t)}}var mh;!function(t){t.Any="any",t.ApNortheast1="ap-northeast-1",t.ApNortheast2="ap-northeast-2",t.ApSouth1="ap-south-1",t.ApSoutheast1="ap-southeast-1",t.ApSoutheast2="ap-southeast-2",t.CaCentral1="ca-central-1",t.EuCentral1="eu-central-1",t.EuWest1="eu-west-1",t.EuWest2="eu-west-2",t.EuWest3="eu-west-3",t.SaEast1="sa-east-1",t.UsEast1="us-east-1",t.UsWest1="us-west-1",t.UsWest2="us-west-2"}(mh||(mh={}));class xh{constructor(t,{headers:e={},customFetch:i,region:s=mh.Any}={}){this.url=t,this.headers=e,this.region=s,this.fetch=(t=>t?(...e)=>t(...e):(...t)=>fetch(...t))(i)}setAuth(t){this.headers.Authorization=`Bearer ${t}`}invoke(t){return e=this,i=arguments,n=function*(t,e={}){var i;let s,n;try{const{headers:o,method:r,body:a,signal:l,timeout:h}=e;let c={},{region:d}=e;d||(d=this.region);const u=new URL(`${this.url}/${t}`);let p;d&&"any"!==d&&(c["x-region"]=d,u.searchParams.set("forceFunctionRegion",d)),a&&(o&&!Object.prototype.hasOwnProperty.call(o,"Content-Type")||!o)?"undefined"!=typeof Blob&&a instanceof Blob||a instanceof ArrayBuffer?(c["Content-Type"]="application/octet-stream",p=a):"string"==typeof a?(c["Content-Type"]="text/plain",p=a):"undefined"!=typeof FormData&&a instanceof FormData?p=a:(c["Content-Type"]="application/json",p=JSON.stringify(a)):p=!a||"string"==typeof a||"undefined"!=typeof Blob&&a instanceof Blob||a instanceof ArrayBuffer||"undefined"!=typeof FormData&&a instanceof FormData?a:JSON.stringify(a);let g=l;h&&(n=new AbortController,s=setTimeout(()=>n.abort(),h),l?(g=n.signal,l.addEventListener("abort",()=>n.abort())):g=n.signal);const y=yield this.fetch(u.toString(),{method:r||"POST",headers:Object.assign(Object.assign(Object.assign({},c),this.headers),o),body:p,signal:g}).catch(t=>{throw new gh(t)}),f=y.headers.get("x-relay-error");if(f&&"true"===f)throw new yh(y);if(!y.ok)throw new fh(y);let m,x=(null!==(i=y.headers.get("Content-Type"))&&void 0!==i?i:"text/plain").split(";")[0].trim();return m="application/json"===x?yield y.json():"application/octet-stream"===x||"application/pdf"===x?yield y.blob():"text/event-stream"===x?y:"multipart/form-data"===x?yield y.formData():yield y.text(),{data:m,error:null,response:y}}catch(t){return{data:null,error:t,response:t instanceof fh||t instanceof yh?t.context:void 0}}finally{s&&clearTimeout(s)}},new((s=void 0)||(s=Promise))(function(t,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s(function(t){t(i)})).then(r,a)}l((n=n.apply(e,i||[])).next())});var e,i,s,n}}var Sh=class extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}},Ah=class{constructor(t){var e,i,s;this.shouldThrowOnError=!1,this.method=t.method,this.url=t.url,this.headers=new Headers(t.headers),this.schema=t.schema,this.body=t.body,this.shouldThrowOnError=null!==(e=t.shouldThrowOnError)&&void 0!==e&&e,this.signal=t.signal,this.isMaybeSingle=null!==(i=t.isMaybeSingle)&&void 0!==i&&i,this.urlLengthLimit=null!==(s=t.urlLengthLimit)&&void 0!==s?s:8e3,t.fetch?this.fetch=t.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=new Headers(this.headers),this.headers.set(t,e),this}then(t,e){var i=this;void 0===this.schema||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),"GET"!==this.method&&"HEAD"!==this.method&&this.headers.set("Content-Type","application/json");let s=(0,this.fetch)(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async t=>{let e=null,s=null,n=null,o=t.status,r=t.statusText;if(t.ok){var a,l;if("HEAD"!==i.method){var h;const e=await t.text();""===e||(s="text/csv"===i.headers.get("Accept")||i.headers.get("Accept")&&(null===(h=i.headers.get("Accept"))||void 0===h?void 0:h.includes("application/vnd.pgrst.plan+text"))?e:JSON.parse(e))}const c=null===(a=i.headers.get("Prefer"))||void 0===a?void 0:a.match(/count=(exact|planned|estimated)/),d=null===(l=t.headers.get("content-range"))||void 0===l?void 0:l.split("/");c&&d&&d.length>1&&(n=parseInt(d[1])),i.isMaybeSingle&&"GET"===i.method&&Array.isArray(s)&&(s.length>1?(e={code:"PGRST116",details:`Results contain ${s.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},s=null,n=null,o=406,r="Not Acceptable"):s=1===s.length?s[0]:null)}else{var c;const n=await t.text();try{e=JSON.parse(n),Array.isArray(e)&&404===t.status&&(s=[],e=null,o=200,r="OK")}catch(i){404===t.status&&""===n?(o=204,r="No Content"):e={message:n}}if(e&&i.isMaybeSingle&&(null==e||null===(c=e.details)||void 0===c?void 0:c.includes("0 rows"))&&(e=null,o=200,r="OK"),e&&i.shouldThrowOnError)throw new Sh(e)}return{error:e,data:s,count:n,status:o,statusText:r}});return this.shouldThrowOnError||(s=s.catch(t=>{var e;let i="",s="",n="";const o=null==t?void 0:t.cause;if(o){var r,a,l,h;const e=null!==(r=null==o?void 0:o.message)&&void 0!==r?r:"",s=null!==(a=null==o?void 0:o.code)&&void 0!==a?a:"";i=`${null!==(l=null==t?void 0:t.name)&&void 0!==l?l:"FetchError"}: ${null==t?void 0:t.message}`,i+=`\n\nCaused by: ${null!==(h=null==o?void 0:o.name)&&void 0!==h?h:"Error"}: ${e}`,s&&(i+=` (${s})`),(null==o?void 0:o.stack)&&(i+=`\n${o.stack}`)}else{var c;i=null!==(c=null==t?void 0:t.stack)&&void 0!==c?c:""}const d=this.url.toString().length;return"AbortError"===(null==t?void 0:t.name)||"ABORT_ERR"===(null==t?void 0:t.code)?(n="",s="Request was aborted (timeout or manual cancellation)",d>this.urlLengthLimit&&(s+=`. Note: Your request URL is ${d} characters, which may exceed server limits. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [many IDs])), consider using an RPC function to pass values server-side.`)):"HeadersOverflowError"!==(null==o?void 0:o.name)&&"UND_ERR_HEADERS_OVERFLOW"!==(null==o?void 0:o.code)||(n="",s="HTTP headers exceeded server limits (typically 16KB)",d>this.urlLengthLimit&&(s+=`. Your request URL is ${d} characters. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [200+ IDs])), consider using an RPC function instead.`)),{error:{message:`${null!==(e=null==t?void 0:t.name)&&void 0!==e?e:"FetchError"}: ${null==t?void 0:t.message}`,details:i,hint:s,code:n},data:null,count:null,status:0,statusText:""}})),s.then(t,e)}returns(){return this}overrideTypes(){return this}},Th=class extends Ah{select(t){let e=!1;const i=(null!=t?t:"*").split("").map(t=>/\s/.test(t)&&!e?"":('"'===t&&(e=!e),t)).join("");return this.url.searchParams.set("select",i),this.headers.append("Prefer","return=representation"),this}order(t,{ascending:e=!0,nullsFirst:i,foreignTable:s,referencedTable:n=s}={}){const o=n?`${n}.order`:"order",r=this.url.searchParams.get(o);return this.url.searchParams.set(o,`${r?`${r},`:""}${t}.${e?"asc":"desc"}${void 0===i?"":i?".nullsfirst":".nullslast"}`),this}limit(t,{foreignTable:e,referencedTable:i=e}={}){const s=void 0===i?"limit":`${i}.limit`;return this.url.searchParams.set(s,`${t}`),this}range(t,e,{foreignTable:i,referencedTable:s=i}={}){const n=void 0===s?"offset":`${s}.offset`,o=void 0===s?"limit":`${s}.limit`;return this.url.searchParams.set(n,`${t}`),this.url.searchParams.set(o,""+(e-t+1)),this}abortSignal(t){return this.signal=t,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return"GET"===this.method?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:t=!1,verbose:e=!1,settings:i=!1,buffers:s=!1,wal:n=!1,format:o="text"}={}){var r;const a=[t?"analyze":null,e?"verbose":null,i?"settings":null,s?"buffers":null,n?"wal":null].filter(Boolean).join("|"),l=null!==(r=this.headers.get("Accept"))&&void 0!==r?r:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${o}; for="${l}"; options=${a};`),this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(t){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${t}`),this}};const _h=new RegExp("[,()]");var wh=class extends Th{eq(t,e){return this.url.searchParams.append(t,`eq.${e}`),this}neq(t,e){return this.url.searchParams.append(t,`neq.${e}`),this}gt(t,e){return this.url.searchParams.append(t,`gt.${e}`),this}gte(t,e){return this.url.searchParams.append(t,`gte.${e}`),this}lt(t,e){return this.url.searchParams.append(t,`lt.${e}`),this}lte(t,e){return this.url.searchParams.append(t,`lte.${e}`),this}like(t,e){return this.url.searchParams.append(t,`like.${e}`),this}likeAllOf(t,e){return this.url.searchParams.append(t,`like(all).{${e.join(",")}}`),this}likeAnyOf(t,e){return this.url.searchParams.append(t,`like(any).{${e.join(",")}}`),this}ilike(t,e){return this.url.searchParams.append(t,`ilike.${e}`),this}ilikeAllOf(t,e){return this.url.searchParams.append(t,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(t,e){return this.url.searchParams.append(t,`ilike(any).{${e.join(",")}}`),this}regexMatch(t,e){return this.url.searchParams.append(t,`match.${e}`),this}regexIMatch(t,e){return this.url.searchParams.append(t,`imatch.${e}`),this}is(t,e){return this.url.searchParams.append(t,`is.${e}`),this}isDistinct(t,e){return this.url.searchParams.append(t,`isdistinct.${e}`),this}in(t,e){const i=Array.from(new Set(e)).map(t=>"string"==typeof t&&_h.test(t)?`"${t}"`:`${t}`).join(",");return this.url.searchParams.append(t,`in.(${i})`),this}notIn(t,e){const i=Array.from(new Set(e)).map(t=>"string"==typeof t&&_h.test(t)?`"${t}"`:`${t}`).join(",");return this.url.searchParams.append(t,`not.in.(${i})`),this}contains(t,e){return"string"==typeof e?this.url.searchParams.append(t,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cs.{${e.join(",")}}`):this.url.searchParams.append(t,`cs.${JSON.stringify(e)}`),this}containedBy(t,e){return"string"==typeof e?this.url.searchParams.append(t,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cd.{${e.join(",")}}`):this.url.searchParams.append(t,`cd.${JSON.stringify(e)}`),this}rangeGt(t,e){return this.url.searchParams.append(t,`sr.${e}`),this}rangeGte(t,e){return this.url.searchParams.append(t,`nxl.${e}`),this}rangeLt(t,e){return this.url.searchParams.append(t,`sl.${e}`),this}rangeLte(t,e){return this.url.searchParams.append(t,`nxr.${e}`),this}rangeAdjacent(t,e){return this.url.searchParams.append(t,`adj.${e}`),this}overlaps(t,e){return"string"==typeof e?this.url.searchParams.append(t,`ov.${e}`):this.url.searchParams.append(t,`ov.{${e.join(",")}}`),this}textSearch(t,e,{config:i,type:s}={}){let n="";"plain"===s?n="pl":"phrase"===s?n="ph":"websearch"===s&&(n="w");const o=void 0===i?"":`(${i})`;return this.url.searchParams.append(t,`${n}fts${o}.${e}`),this}match(t){return Object.entries(t).forEach(([t,e])=>{this.url.searchParams.append(t,`eq.${e}`)}),this}not(t,e,i){return this.url.searchParams.append(t,`not.${e}.${i}`),this}or(t,{foreignTable:e,referencedTable:i=e}={}){const s=i?`${i}.or`:"or";return this.url.searchParams.append(s,`(${t})`),this}filter(t,e,i){return this.url.searchParams.append(t,`${e}.${i}`),this}},Eh=class{constructor(t,{headers:e={},schema:i,fetch:s,urlLengthLimit:n=8e3}){this.url=t,this.headers=new Headers(e),this.schema=i,this.fetch=s,this.urlLengthLimit=n}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(t,e){const{head:i=!1,count:s}=null!=e?e:{},n=i?"HEAD":"GET";let o=!1;const r=(null!=t?t:"*").split("").map(t=>/\s/.test(t)&&!o?"":('"'===t&&(o=!o),t)).join(""),{url:a,headers:l}=this.cloneRequestState();return a.searchParams.set("select",r),s&&l.append("Prefer",`count=${s}`),new wh({method:n,url:a,headers:l,schema:this.schema,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}insert(t,{count:e,defaultToNull:i=!0}={}){var s;const{url:n,headers:o}=this.cloneRequestState();if(e&&o.append("Prefer",`count=${e}`),i||o.append("Prefer","missing=default"),Array.isArray(t)){const e=t.reduce((t,e)=>t.concat(Object.keys(e)),[]);if(e.length>0){const t=[...new Set(e)].map(t=>`"${t}"`);n.searchParams.set("columns",t.join(","))}}return new wh({method:"POST",url:n,headers:o,schema:this.schema,body:t,fetch:null!==(s=this.fetch)&&void 0!==s?s:fetch,urlLengthLimit:this.urlLengthLimit})}upsert(t,{onConflict:e,ignoreDuplicates:i=!1,count:s,defaultToNull:n=!0}={}){var o;const{url:r,headers:a}=this.cloneRequestState();if(a.append("Prefer",`resolution=${i?"ignore":"merge"}-duplicates`),void 0!==e&&r.searchParams.set("on_conflict",e),s&&a.append("Prefer",`count=${s}`),n||a.append("Prefer","missing=default"),Array.isArray(t)){const e=t.reduce((t,e)=>t.concat(Object.keys(e)),[]);if(e.length>0){const t=[...new Set(e)].map(t=>`"${t}"`);r.searchParams.set("columns",t.join(","))}}return new wh({method:"POST",url:r,headers:a,schema:this.schema,body:t,fetch:null!==(o=this.fetch)&&void 0!==o?o:fetch,urlLengthLimit:this.urlLengthLimit})}update(t,{count:e}={}){var i;const{url:s,headers:n}=this.cloneRequestState();return e&&n.append("Prefer",`count=${e}`),new wh({method:"PATCH",url:s,headers:n,schema:this.schema,body:t,fetch:null!==(i=this.fetch)&&void 0!==i?i:fetch,urlLengthLimit:this.urlLengthLimit})}delete({count:t}={}){var e;const{url:i,headers:s}=this.cloneRequestState();return t&&s.append("Prefer",`count=${t}`),new wh({method:"DELETE",url:i,headers:s,schema:this.schema,fetch:null!==(e=this.fetch)&&void 0!==e?e:fetch,urlLengthLimit:this.urlLengthLimit})}};function bh(t){return(bh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function vh(t,e,i){return(e=function(t){var e=function(t){if("object"!=bh(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=bh(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==bh(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ph(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,s)}return i}function Ch(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ph(Object(i),!0).forEach(function(e){vh(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ph(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}var Ih=class t{constructor(t,{headers:e={},schema:i,fetch:s,timeout:n,urlLengthLimit:o=8e3}={}){this.url=t,this.headers=new Headers(e),this.schemaName=i,this.urlLengthLimit=o;const r=null!=s?s:globalThis.fetch;this.fetch=void 0!==n&&n>0?(t,e)=>{const i=new AbortController,s=setTimeout(()=>i.abort(),n),o=null==e?void 0:e.signal;if(o){if(o.aborted)return clearTimeout(s),r(t,e);const n=()=>{clearTimeout(s),i.abort()};return o.addEventListener("abort",n,{once:!0}),r(t,Ch(Ch({},e),{},{signal:i.signal})).finally(()=>{clearTimeout(s),o.removeEventListener("abort",n)})}return r(t,Ch(Ch({},e),{},{signal:i.signal})).finally(()=>clearTimeout(s))}:r}from(t){if(!t||"string"!=typeof t||""===t.trim())throw new Error("Invalid relation name: relation must be a non-empty string.");return new Eh(new URL(`${this.url}/${t}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}schema(e){return new t(this.url,{headers:this.headers,schema:e,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}rpc(t,e={},{head:i=!1,get:s=!1,count:n}={}){var o;let r;const a=new URL(`${this.url}/rpc/${t}`);let l;const h=t=>null!==t&&"object"==typeof t&&(!Array.isArray(t)||t.some(h)),c=i&&Object.values(e).some(h);c?(r="POST",l=e):i||s?(r=i?"HEAD":"GET",Object.entries(e).filter(([t,e])=>void 0!==e).map(([t,e])=>[t,Array.isArray(e)?`{${e.join(",")}}`:`${e}`]).forEach(([t,e])=>{a.searchParams.append(t,e)})):(r="POST",l=e);const d=new Headers(this.headers);return c?d.set("Prefer",n?`count=${n},return=minimal`:"return=minimal"):n&&d.set("Prefer",`count=${n}`),new wh({method:r,url:a,headers:d,schema:this.schemaName,body:l,fetch:null!==(o=this.fetch)&&void 0!==o?o:fetch,urlLengthLimit:this.urlLengthLimit})}};const Rh=class{constructor(){}static detectEnvironment(){var e;if("undefined"!=typeof WebSocket)return{type:"native",constructor:WebSocket};if("undefined"!=typeof globalThis&&void 0!==globalThis.WebSocket)return{type:"native",constructor:globalThis.WebSocket};if(void 0!==t.g&&void 0!==t.g.WebSocket)return{type:"native",constructor:t.g.WebSocket};if("undefined"!=typeof globalThis&&void 0!==globalThis.WebSocketPair&&void 0===globalThis.WebSocket)return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if("undefined"!=typeof globalThis&&globalThis.EdgeRuntime||"undefined"!=typeof navigator&&(null===(e=navigator.userAgent)||void 0===e?void 0:e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const i=globalThis.process;if(i){const t=i.versions;if(t&&t.node){const e=t.node,i=parseInt(e.replace(/^v/,"").split(".")[0]);return i>=22?void 0!==globalThis.WebSocket?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:'For Node.js < 22, install "ws" package and provide it via the transport option:\nimport ws from "ws"\nnew RealtimeClient(url, { transport: ws })'}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const t=this.detectEnvironment();if(t.constructor)return t.constructor;let e=t.error||"WebSocket not supported in this environment.";throw t.workaround&&(e+=`\n\nSuggested solution: ${t.workaround}`),new Error(e)}static createWebSocket(t,e){return new(this.getWebSocketConstructor())(t,e)}static isWebSocketSupported(){try{const t=this.detectEnvironment();return"native"===t.type||"ws"===t.type}catch(t){return!1}}},Mh="2.0.0",Lh=Mh;var Fh,kh,Dh,Oh,Nh,Bh;!function(t){t[t.connecting=0]="connecting",t[t.open=1]="open",t[t.closing=2]="closing",t[t.closed=3]="closed"}(Fh||(Fh={})),function(t){t.closed="closed",t.errored="errored",t.joined="joined",t.joining="joining",t.leaving="leaving"}(kh||(kh={})),function(t){t.close="phx_close",t.error="phx_error",t.join="phx_join",t.reply="phx_reply",t.leave="phx_leave",t.access_token="access_token"}(Dh||(Dh={})),function(t){t.websocket="websocket"}(Oh||(Oh={})),function(t){t.Connecting="connecting",t.Open="open",t.Closing="closing",t.Closed="closed"}(Nh||(Nh={}));class Uh{constructor(t){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=null!=t?t:[]}encode(t,e){if(t.event===this.BROADCAST_EVENT&&!(t.payload instanceof ArrayBuffer)&&"string"==typeof t.payload.event)return e(this._binaryEncodeUserBroadcastPush(t));let i=[t.join_ref,t.ref,t.topic,t.event,t.payload];return e(JSON.stringify(i))}_binaryEncodeUserBroadcastPush(t){var e;return this._isArrayBuffer(null===(e=t.payload)||void 0===e?void 0:e.payload)?this._encodeBinaryUserBroadcastPush(t):this._encodeJsonUserBroadcastPush(t)}_encodeBinaryUserBroadcastPush(t){var e,i;const s=null!==(i=null===(e=t.payload)||void 0===e?void 0:e.payload)&&void 0!==i?i:new ArrayBuffer(0);return this._encodeUserBroadcastPush(t,this.BINARY_ENCODING,s)}_encodeJsonUserBroadcastPush(t){var e,i;const s=null!==(i=null===(e=t.payload)||void 0===e?void 0:e.payload)&&void 0!==i?i:{},n=(new TextEncoder).encode(JSON.stringify(s)).buffer;return this._encodeUserBroadcastPush(t,this.JSON_ENCODING,n)}_encodeUserBroadcastPush(t,e,i){var s,n;const o=t.topic,r=null!==(s=t.ref)&&void 0!==s?s:"",a=null!==(n=t.join_ref)&&void 0!==n?n:"",l=t.payload.event,h=this.allowedMetadataKeys?this._pick(t.payload,this.allowedMetadataKeys):{},c=0===Object.keys(h).length?"":JSON.stringify(h);if(a.length>255)throw new Error(`joinRef length ${a.length} exceeds maximum of 255`);if(r.length>255)throw new Error(`ref length ${r.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`topic length ${o.length} exceeds maximum of 255`);if(l.length>255)throw new Error(`userEvent length ${l.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`metadata length ${c.length} exceeds maximum of 255`);const d=this.USER_BROADCAST_PUSH_META_LENGTH+a.length+r.length+o.length+l.length+c.length,u=new ArrayBuffer(this.HEADER_LENGTH+d);let p=new DataView(u),g=0;p.setUint8(g++,this.KINDS.userBroadcastPush),p.setUint8(g++,a.length),p.setUint8(g++,r.length),p.setUint8(g++,o.length),p.setUint8(g++,l.length),p.setUint8(g++,c.length),p.setUint8(g++,e),Array.from(a,t=>p.setUint8(g++,t.charCodeAt(0))),Array.from(r,t=>p.setUint8(g++,t.charCodeAt(0))),Array.from(o,t=>p.setUint8(g++,t.charCodeAt(0))),Array.from(l,t=>p.setUint8(g++,t.charCodeAt(0))),Array.from(c,t=>p.setUint8(g++,t.charCodeAt(0)));var y=new Uint8Array(u.byteLength+i.byteLength);return y.set(new Uint8Array(u),0),y.set(new Uint8Array(i),u.byteLength),y.buffer}decode(t,e){if(this._isArrayBuffer(t))return e(this._binaryDecode(t));if("string"==typeof t){const i=JSON.parse(t),[s,n,o,r,a]=i;return e({join_ref:s,ref:n,topic:o,event:r,payload:a})}return e({})}_binaryDecode(t){const e=new DataView(t),i=e.getUint8(0),s=new TextDecoder;if(i===this.KINDS.userBroadcast)return this._decodeUserBroadcast(t,e,s)}_decodeUserBroadcast(t,e,i){const s=e.getUint8(1),n=e.getUint8(2),o=e.getUint8(3),r=e.getUint8(4);let a=this.HEADER_LENGTH+4;const l=i.decode(t.slice(a,a+s));a+=s;const h=i.decode(t.slice(a,a+n));a+=n;const c=i.decode(t.slice(a,a+o));a+=o;const d=t.slice(a,t.byteLength),u=r===this.JSON_ENCODING?JSON.parse(i.decode(d)):d,p={type:this.BROADCAST_EVENT,event:h,payload:u};return o>0&&(p.meta=JSON.parse(c)),{join_ref:null,ref:null,topic:l,event:this.BROADCAST_EVENT,payload:p}}_isArrayBuffer(t){var e;return t instanceof ArrayBuffer||"ArrayBuffer"===(null===(e=null==t?void 0:t.constructor)||void 0===e?void 0:e.name)}_pick(t,e){return t&&"object"==typeof t?Object.fromEntries(Object.entries(t).filter(([t])=>e.includes(t))):{}}}class Gh{constructor(t,e){this.callback=t,this.timerCalc=e,this.timer=void 0,this.tries=0,this.callback=t,this.timerCalc=e}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}!function(t){t.abstime="abstime",t.bool="bool",t.date="date",t.daterange="daterange",t.float4="float4",t.float8="float8",t.int2="int2",t.int4="int4",t.int4range="int4range",t.int8="int8",t.int8range="int8range",t.json="json",t.jsonb="jsonb",t.money="money",t.numeric="numeric",t.oid="oid",t.reltime="reltime",t.text="text",t.time="time",t.timestamp="timestamp",t.timestamptz="timestamptz",t.timetz="timetz",t.tsrange="tsrange",t.tstzrange="tstzrange"}(Bh||(Bh={}));const Hh=(t,e,i={})=>{var s;const n=null!==(s=i.skipTypes)&&void 0!==s?s:[];return e?Object.keys(e).reduce((i,s)=>(i[s]=Wh(s,t,e,n),i),{}):{}},Wh=(t,e,i,s)=>{const n=e.find(e=>e.name===t),o=null==n?void 0:n.type,r=i[t];return o&&!s.includes(o)?$h(o,r):Vh(r)},$h=(t,e)=>{if("_"===t.charAt(0)){const i=t.slice(1,t.length);return Yh(e,i)}switch(t){case Bh.bool:return zh(e);case Bh.float4:case Bh.float8:case Bh.int2:case Bh.int4:case Bh.int8:case Bh.numeric:case Bh.oid:return jh(e);case Bh.json:case Bh.jsonb:return Kh(e);case Bh.timestamp:return Xh(e);case Bh.abstime:case Bh.date:case Bh.daterange:case Bh.int4range:case Bh.int8range:case Bh.money:case Bh.reltime:case Bh.text:case Bh.time:case Bh.timestamptz:case Bh.timetz:case Bh.tsrange:case Bh.tstzrange:default:return Vh(e)}},Vh=t=>t,zh=t=>{switch(t){case"t":return!0;case"f":return!1;default:return t}},jh=t=>{if("string"==typeof t){const e=parseFloat(t);if(!Number.isNaN(e))return e}return t},Kh=t=>{if("string"==typeof t)try{return JSON.parse(t)}catch(e){return t}return t},Yh=(t,e)=>{if("string"!=typeof t)return t;const i=t.length-1,s=t[i];if("{"===t[0]&&"}"===s){let s;const n=t.slice(1,i);try{s=JSON.parse("["+n+"]")}catch(t){s=n?n.split(","):[]}return s.map(t=>$h(e,t))}return t},Xh=t=>"string"==typeof t?t.replace(" ","T"):t,qh=t=>{const e=new URL(t);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),""===e.pathname||"/"===e.pathname?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class Jh{constructor(t,e,i={},s=1e4){this.channel=t,this.event=e,this.payload=i,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(t){this.timeout=t,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(t){this.payload=Object.assign(Object.assign({},this.payload),t)}receive(t,e){var i;return this._hasReceived(t)&&e(null===(i=this.receivedResp)||void 0===i?void 0:i.response),this.recHooks.push({status:t,callback:e}),this}startTimeout(){this.timeoutTimer||(this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref),this.channel._on(this.refEvent,{},t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout))}trigger(t,e){this.refEvent&&this.channel._trigger(this.refEvent,{status:t,response:e})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:t,response:e}){this.recHooks.filter(e=>e.status===t).forEach(t=>t.callback(e))}_hasReceived(t){return this.receivedResp&&this.receivedResp.status===t}}var Qh,Zh,tc,ec;!function(t){t.SYNC="sync",t.JOIN="join",t.LEAVE="leave"}(Qh||(Qh={}));class ic{constructor(t,e){this.channel=t,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const i=(null==e?void 0:e.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(i.state,{},t=>{const{onJoin:e,onLeave:i,onSync:s}=this.caller;this.joinRef=this.channel._joinRef(),this.state=ic.syncState(this.state,t,e,i),this.pendingDiffs.forEach(t=>{this.state=ic.syncDiff(this.state,t,e,i)}),this.pendingDiffs=[],s()}),this.channel._on(i.diff,{},t=>{const{onJoin:e,onLeave:i,onSync:s}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(t):(this.state=ic.syncDiff(this.state,t,e,i),s())}),this.onJoin((t,e,i)=>{this.channel._trigger("presence",{event:"join",key:t,currentPresences:e,newPresences:i})}),this.onLeave((t,e,i)=>{this.channel._trigger("presence",{event:"leave",key:t,currentPresences:e,leftPresences:i})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(t,e,i,s){const n=this.cloneDeep(t),o=this.transformState(e),r={},a={};return this.map(n,(t,e)=>{o[t]||(a[t]=e)}),this.map(o,(t,e)=>{const i=n[t];if(i){const s=e.map(t=>t.presence_ref),n=i.map(t=>t.presence_ref),o=e.filter(t=>n.indexOf(t.presence_ref)<0),l=i.filter(t=>s.indexOf(t.presence_ref)<0);o.length>0&&(r[t]=o),l.length>0&&(a[t]=l)}else r[t]=e}),this.syncDiff(n,{joins:r,leaves:a},i,s)}static syncDiff(t,e,i,s){const{joins:n,leaves:o}={joins:this.transformState(e.joins),leaves:this.transformState(e.leaves)};return i||(i=()=>{}),s||(s=()=>{}),this.map(n,(e,s)=>{var n;const o=null!==(n=t[e])&&void 0!==n?n:[];if(t[e]=this.cloneDeep(s),o.length>0){const i=t[e].map(t=>t.presence_ref),s=o.filter(t=>i.indexOf(t.presence_ref)<0);t[e].unshift(...s)}i(e,o,s)}),this.map(o,(e,i)=>{let n=t[e];if(!n)return;const o=i.map(t=>t.presence_ref);n=n.filter(t=>o.indexOf(t.presence_ref)<0),t[e]=n,s(e,n,i),0===n.length&&delete t[e]}),t}static map(t,e){return Object.getOwnPropertyNames(t).map(i=>e(i,t[i]))}static transformState(t){return t=this.cloneDeep(t),Object.getOwnPropertyNames(t).reduce((e,i)=>{const s=t[i];return e[i]="metas"in s?s.metas.map(t=>(t.presence_ref=t.phx_ref,delete t.phx_ref,delete t.phx_ref_prev,t)):s,e},{})}static cloneDeep(t){return JSON.parse(JSON.stringify(t))}onJoin(t){this.caller.onJoin=t}onLeave(t){this.caller.onLeave=t}onSync(t){this.caller.onSync=t}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}!function(t){t.ALL="*",t.INSERT="INSERT",t.UPDATE="UPDATE",t.DELETE="DELETE"}(Zh||(Zh={})),function(t){t.BROADCAST="broadcast",t.PRESENCE="presence",t.POSTGRES_CHANGES="postgres_changes",t.SYSTEM="system"}(tc||(tc={})),function(t){t.SUBSCRIBED="SUBSCRIBED",t.TIMED_OUT="TIMED_OUT",t.CLOSED="CLOSED",t.CHANNEL_ERROR="CHANNEL_ERROR"}(ec||(ec={}));class sc{constructor(t,e={config:{}},i){var s,n;if(this.topic=t,this.params=e,this.socket=i,this.bindings={},this.state=kh.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=t.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},e.config),this.timeout=this.socket.timeout,this.joinPush=new Jh(this,Dh.join,this.params,this.timeout),this.rejoinTimer=new Gh(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=kh.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(t=>t.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=kh.closed,this.socket._remove(this)}),this._onError(t=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,t),this.state=kh.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=kh.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",t=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,t),this.state=kh.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Dh.reply,{},(t,e)=>{this._trigger(this._replyEventName(e),t)}),this.presence=new ic(this),this.broadcastEndpointURL=qh(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(null===(n=null===(s=this.params.config)||void 0===s?void 0:s.broadcast)||void 0===n?void 0:n.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(t,e=this.timeout){var i,s,n;if(this.socket.isConnected()||this.socket.connect(),this.state==kh.closed){const{config:{broadcast:o,presence:r,private:a}}=this.params,l=null!==(s=null===(i=this.bindings.postgres_changes)||void 0===i?void 0:i.map(t=>t.filter))&&void 0!==s?s:[],h=!!this.bindings[tc.PRESENCE]&&this.bindings[tc.PRESENCE].length>0||!0===(null===(n=this.params.config.presence)||void 0===n?void 0:n.enabled),c={},d={broadcast:o,presence:Object.assign(Object.assign({},r),{enabled:h}),postgres_changes:l,private:a};this.socket.accessTokenValue&&(c.access_token=this.socket.accessTokenValue),this._onError(e=>null==t?void 0:t(ec.CHANNEL_ERROR,e)),this._onClose(()=>null==t?void 0:t(ec.CLOSED)),this.updateJoinPayload(Object.assign({config:d},c)),this.joinedOnce=!0,this._rejoin(e),this.joinPush.receive("ok",async({postgres_changes:e})=>{var i;if(this.socket._isManualToken()||this.socket.setAuth(),void 0!==e){const s=this.bindings.postgres_changes,n=null!==(i=null==s?void 0:s.length)&&void 0!==i?i:0,o=[];for(let i=0;i<n;i++){const n=s[i],{filter:{event:r,schema:a,table:l,filter:h}}=n,c=e&&e[i];if(!(c&&c.event===r&&sc.isFilterValueEqual(c.schema,a)&&sc.isFilterValueEqual(c.table,l)&&sc.isFilterValueEqual(c.filter,h)))return this.unsubscribe(),this.state=kh.errored,void(null==t||t(ec.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes")));o.push(Object.assign(Object.assign({},n),{id:c.id}))}return this.bindings.postgres_changes=o,void(t&&t(ec.SUBSCRIBED))}null==t||t(ec.SUBSCRIBED)}).receive("error",e=>{this.state=kh.errored,null==t||t(ec.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(e).join(", ")||"error")))}).receive("timeout",()=>{null==t||t(ec.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(t,e={}){return await this.send({type:"presence",event:"track",payload:t},e.timeout||this.timeout)}async untrack(t={}){return await this.send({type:"presence",event:"untrack"},t)}on(t,e,i){return this.state===kh.joined&&t===tc.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(t,e,i)}async httpSend(t,e,i={}){var s;if(null==e)return Promise.reject("Payload is required for httpSend()");const n={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(n.Authorization=`Bearer ${this.socket.accessTokenValue}`);const o={method:"POST",headers:n,body:JSON.stringify({messages:[{topic:this.subTopic,event:t,payload:e,private:this.private}]})},r=await this._fetchWithTimeout(this.broadcastEndpointURL,o,null!==(s=i.timeout)&&void 0!==s?s:this.timeout);if(202===r.status)return{success:!0};let a=r.statusText;try{const t=await r.json();a=t.error||t.message||a}catch(t){}return Promise.reject(new Error(a))}async send(t,e={}){var i,s;if(this._canPush()||"broadcast"!==t.type)return new Promise(i=>{var s,n,o;const r=this._push(t.type,t,e.timeout||this.timeout);"broadcast"!==t.type||(null===(o=null===(n=null===(s=this.params)||void 0===s?void 0:s.config)||void 0===n?void 0:n.broadcast)||void 0===o?void 0:o.ack)||i("ok"),r.receive("ok",()=>i("ok")),r.receive("error",()=>i("error")),r.receive("timeout",()=>i("timed out"))});{console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:n,payload:o}=t,r={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(r.Authorization=`Bearer ${this.socket.accessTokenValue}`);const a={method:"POST",headers:r,body:JSON.stringify({messages:[{topic:this.subTopic,event:n,payload:o,private:this.private}]})};try{const t=await this._fetchWithTimeout(this.broadcastEndpointURL,a,null!==(i=e.timeout)&&void 0!==i?i:this.timeout);return await(null===(s=t.body)||void 0===s?void 0:s.cancel()),t.ok?"ok":"error"}catch(t){return"AbortError"===t.name?"timed out":"error"}}}updateJoinPayload(t){this.joinPush.updatePayload(t)}unsubscribe(t=this.timeout){this.state=kh.leaving;const e=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Dh.close,"leave",this._joinRef())};this.joinPush.destroy();let i=null;return new Promise(s=>{i=new Jh(this,Dh.leave,{},t),i.receive("ok",()=>{e(),s("ok")}).receive("timeout",()=>{e(),s("timed out")}).receive("error",()=>{s("error")}),i.send(),this._canPush()||i.trigger("ok",{})}).finally(()=>{null==i||i.destroy()})}teardown(){this.pushBuffer.forEach(t=>t.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=kh.closed,this.bindings={}}async _fetchWithTimeout(t,e,i){const s=new AbortController,n=setTimeout(()=>s.abort(),i),o=await this.socket.fetch(t,Object.assign(Object.assign({},e),{signal:s.signal}));return clearTimeout(n),o}_push(t,e,i=this.timeout){if(!this.joinedOnce)throw`tried to push '${t}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new Jh(this,t,e,i);return this._canPush()?s.send():this._addToPushBuffer(s),s}_addToPushBuffer(t){if(t.startTimeout(),this.pushBuffer.push(t),this.pushBuffer.length>100){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(t,e,i){return e}_isMember(t){return this.topic===t}_joinRef(){return this.joinPush.ref}_trigger(t,e,i){var s,n;const o=t.toLocaleLowerCase(),{close:r,error:a,leave:l,join:h}=Dh;if(i&&[r,a,l,h].indexOf(o)>=0&&i!==this._joinRef())return;let c=this._onMessage(o,e,i);if(e&&!c)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?null===(s=this.bindings.postgres_changes)||void 0===s||s.filter(t=>{var e,i,s;return"*"===(null===(e=t.filter)||void 0===e?void 0:e.event)||(null===(s=null===(i=t.filter)||void 0===i?void 0:i.event)||void 0===s?void 0:s.toLocaleLowerCase())===o}).map(t=>t.callback(c,i)):null===(n=this.bindings[o])||void 0===n||n.filter(t=>{var i,s,n,r,a,l;if(["broadcast","presence","postgres_changes"].includes(o)){if("id"in t){const o=t.id,r=null===(i=t.filter)||void 0===i?void 0:i.event;return o&&(null===(s=e.ids)||void 0===s?void 0:s.includes(o))&&("*"===r||(null==r?void 0:r.toLocaleLowerCase())===(null===(n=e.data)||void 0===n?void 0:n.type.toLocaleLowerCase()))}{const i=null===(a=null===(r=null==t?void 0:t.filter)||void 0===r?void 0:r.event)||void 0===a?void 0:a.toLocaleLowerCase();return"*"===i||i===(null===(l=null==e?void 0:e.event)||void 0===l?void 0:l.toLocaleLowerCase())}}return t.type.toLocaleLowerCase()===o}).map(t=>{if("object"==typeof c&&"ids"in c){const t=c.data,{schema:e,table:i,commit_timestamp:s,type:n,errors:o}=t,r={schema:e,table:i,commit_timestamp:s,eventType:n,new:{},old:{},errors:o};c=Object.assign(Object.assign({},r),this._getPayloadRecords(t))}t.callback(c,i)})}_isClosed(){return this.state===kh.closed}_isJoined(){return this.state===kh.joined}_isJoining(){return this.state===kh.joining}_isLeaving(){return this.state===kh.leaving}_replyEventName(t){return`chan_reply_${t}`}_on(t,e,i){const s=t.toLocaleLowerCase(),n={type:s,filter:e,callback:i};return this.bindings[s]?this.bindings[s].push(n):this.bindings[s]=[n],this}_off(t,e){const i=t.toLocaleLowerCase();return this.bindings[i]&&(this.bindings[i]=this.bindings[i].filter(t=>{var s;return!((null===(s=t.type)||void 0===s?void 0:s.toLocaleLowerCase())===i&&sc.isEqual(t.filter,e))})),this}static isEqual(t,e){if(Object.keys(t).length!==Object.keys(e).length)return!1;for(const i in t)if(t[i]!==e[i])return!1;return!0}static isFilterValueEqual(t,e){return(null!=t?t:void 0)===(null!=e?e:void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(t){this._on(Dh.close,{},t)}_onError(t){this._on(Dh.error,{},e=>t(e))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(t=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=kh.joining,this.joinPush.resend(t))}_getPayloadRecords(t){const e={new:{},old:{}};return"INSERT"!==t.type&&"UPDATE"!==t.type||(e.new=Hh(t.columns,t.record)),"UPDATE"!==t.type&&"DELETE"!==t.type||(e.old=Hh(t.columns,t.old_record)),e}}const nc=()=>{},oc=[1e3,2e3,5e3,1e4];class rc{constructor(t,e){var i;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=1e4,this.transport=null,this.heartbeatIntervalMs=25e3,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=nc,this.ref=0,this.reconnectTimer=null,this.vsn=Lh,this.logger=nc,this.conn=null,this.sendBuffer=[],this.serializer=new Uh,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=t=>t?(...e)=>t(...e):(...t)=>fetch(...t),!(null===(i=null==e?void 0:e.params)||void 0===i?void 0:i.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=e.params.apikey,this.endPoint=`${t}/${Oh.websocket}`,this.httpEndpoint=qh(t),this._initializeOptions(e),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(null==e?void 0:e.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||null!==this.conn&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Rh.createWebSocket(this.endpointURL())}catch(t){this._setConnectionState("disconnected");const e=t.message;if(e.includes("Node.js"))throw new Error(`${e}\n\nTo use Realtime in Node.js, you need to provide a WebSocket implementation:\n\nOption 1: Use Node.js 22+ which has native WebSocket support\nOption 2: Install and provide the "ws" package:\n\n  npm install ws\n\n  import ws from "ws"\n  const client = new RealtimeClient(url, {\n    ...options,\n    transport: ws\n  })`);throw new Error(`WebSocket not available: ${e}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(t,e){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const i=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(i),this._setConnectionState("disconnected")},"function"==typeof this.conn.close&&(t?this.conn.close(t,null!=e?e:""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(t){const e=await t.unsubscribe();return"ok"===e&&this._remove(t),0===this.channels.length&&this.disconnect(),e}async removeAllChannels(){const t=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),t}log(t,e,i){this.logger(t,e,i)}connectionState(){switch(this.conn&&this.conn.readyState){case Fh.connecting:return Nh.Connecting;case Fh.open:return Nh.Open;case Fh.closing:return Nh.Closing;default:return Nh.Closed}}isConnected(){return this.connectionState()===Nh.Open}isConnecting(){return"connecting"===this._connectionState}isDisconnecting(){return"disconnecting"===this._connectionState}channel(t,e={config:{}}){const i=`realtime:${t}`,s=this.getChannels().find(t=>t.topic===i);if(s)return s;{const i=new sc(`realtime:${t}`,e,this);return this.channels.push(i),i}}push(t){const{topic:e,event:i,payload:s,ref:n}=t,o=()=>{this.encode(t,t=>{var e;null===(e=this.conn)||void 0===e||e.send(t)})};this.log("push",`${e} ${i} (${n})`,s),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(t=null){this._authPromise=this._performAuth(t);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var t;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}return this._wasManualDisconnect=!1,null===(t=this.conn)||void 0===t||t.close(1e3,"heartbeat timeout"),void setTimeout(()=>{var t;this.isConnected()||null===(t=this.reconnectTimer)||void 0===t||t.scheduleTimeout()},100)}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}else try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}}onHeartbeat(t){this.heartbeatCallback=t}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(t=>t()),this.sendBuffer=[])}_makeRef(){let t=this.ref+1;return t===this.ref?this.ref=0:this.ref=t,this.ref.toString()}_leaveOpenTopic(t){let e=this.channels.find(e=>e.topic===t&&(e._isJoined()||e._isJoining()));e&&(this.log("transport",`leaving duplicate topic "${t}"`),e.unsubscribe())}_remove(t){this.channels=this.channels.filter(e=>e.topic!==t.topic)}_onConnMessage(t){this.decode(t.data,t=>{if("phoenix"===t.topic&&"phx_reply"===t.event&&t.ref&&t.ref===this.pendingHeartbeatRef){const e=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback("ok"===t.payload.status?"ok":"error",e)}catch(t){this.log("error","error in heartbeat callback",t)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:e,event:i,payload:s,ref:n}=t,o=n?`(${n})`:"",r=s.status||"";this.log("receive",`${r} ${e} ${i} ${o}`.trim(),s),this.channels.filter(t=>t._isMember(e)).forEach(t=>t._trigger(i,s,n)),this._triggerStateCallbacks("message",t)})}_clearTimer(t){var e;"heartbeat"===t&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):"reconnect"===t&&(null===(e=this.reconnectTimer)||void 0===e||e.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=t=>this._onConnError(t),this.conn.onmessage=t=>this._onConnMessage(t),this.conn.onclose=t=>this._onConnClose(t),this.conn.readyState===Fh.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===Fh.open||this.conn.readyState===Fh.connecting)try{this.conn.close()}catch(t){this.log("error","Error closing connection",t)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(t=>t.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const t=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(t),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this._terminateWorker()},this.workerRef.onmessage=t=>{"keepAlive"===t.data.event&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(t){var e;this._setConnectionState("disconnected"),this.log("transport","close",t),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||null===(e=this.reconnectTimer)||void 0===e||e.scheduleTimeout(),this._triggerStateCallbacks("close",t)}_onConnError(t){this._setConnectionState("disconnected"),this.log("transport",`${t}`),this._triggerChanError(),this._triggerStateCallbacks("error",t);try{this.heartbeatCallback("error")}catch(t){this.log("error","error in heartbeat callback",t)}}_triggerChanError(){this.channels.forEach(t=>t._trigger(Dh.error))}_appendParams(t,e){if(0===Object.keys(e).length)return t;const i=t.match(/\?/)?"&":"?";return`${t}${i}${new URLSearchParams(e)}`}_workerObjectUrl(t){let e;if(t)e=t;else{const t=new Blob(['\n  addEventListener("message", (e) => {\n    if (e.data.event === "start") {\n      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);\n    }\n  });'],{type:"application/javascript"});e=URL.createObjectURL(t)}return e}_setConnectionState(t,e=!1){this._connectionState=t,"connecting"===t?this._wasManualDisconnect=!1:"disconnecting"===t&&(this._wasManualDisconnect=e)}async _performAuth(t=null){let e,i=!1;if(t)e=t,i=!0;else if(this.accessToken)try{e=await this.accessToken()}catch(t){this.log("error","Error fetching access token from callback",t),e=this.accessTokenValue}else e=this.accessTokenValue;i?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=e&&(this.accessTokenValue=e,this.channels.forEach(t=>{const i={access_token:e,version:"realtime-js/2.95.3"};e&&t.updateJoinPayload(i),t.joinedOnce&&t._isJoined()&&t._push(Dh.access_token,{access_token:e})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(t="general"){this._isManualToken()||this.setAuth().catch(e=>{this.log("error",`Error setting auth in ${t}`,e)})}_triggerStateCallbacks(t,e){try{this.stateChangeCallbacks[t].forEach(i=>{try{i(e)}catch(e){this.log("error",`error in ${t} callback`,e)}})}catch(e){this.log("error",`error triggering ${t} callbacks`,e)}}_setupReconnectionTimer(){this.reconnectTimer=new Gh(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},10)},this.reconnectAfterMs)}_initializeOptions(t){var e,i,s,n,o,r,a,l,h,c,d,u;switch(this.transport=null!==(e=null==t?void 0:t.transport)&&void 0!==e?e:null,this.timeout=null!==(i=null==t?void 0:t.timeout)&&void 0!==i?i:1e4,this.heartbeatIntervalMs=null!==(s=null==t?void 0:t.heartbeatIntervalMs)&&void 0!==s?s:25e3,this.worker=null!==(n=null==t?void 0:t.worker)&&void 0!==n&&n,this.accessToken=null!==(o=null==t?void 0:t.accessToken)&&void 0!==o?o:null,this.heartbeatCallback=null!==(r=null==t?void 0:t.heartbeatCallback)&&void 0!==r?r:nc,this.vsn=null!==(a=null==t?void 0:t.vsn)&&void 0!==a?a:Lh,(null==t?void 0:t.params)&&(this.params=t.params),(null==t?void 0:t.logger)&&(this.logger=t.logger),((null==t?void 0:t.logLevel)||(null==t?void 0:t.log_level))&&(this.logLevel=t.logLevel||t.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=null!==(l=null==t?void 0:t.reconnectAfterMs)&&void 0!==l?l:t=>oc[t-1]||1e4,this.vsn){case"1.0.0":this.encode=null!==(h=null==t?void 0:t.encode)&&void 0!==h?h:(t,e)=>e(JSON.stringify(t)),this.decode=null!==(c=null==t?void 0:t.decode)&&void 0!==c?c:(t,e)=>e(JSON.parse(t));break;case Mh:this.encode=null!==(d=null==t?void 0:t.encode)&&void 0!==d?d:this.serializer.encode.bind(this.serializer),this.decode=null!==(u=null==t?void 0:t.decode)&&void 0!==u?u:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if("undefined"!=typeof window&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=null==t?void 0:t.workerUrl}}}var ac=class extends Error{constructor(t,e){super(t),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown="CommitStateUnknownException"===e.icebergType||[500,502,504].includes(e.status)&&!0===e.icebergType?.includes("CommitState")}isNotFound(){return 404===this.status}isConflict(){return 409===this.status}isAuthenticationTimeout(){return 419===this.status}};function lc(t){return t.join("")}var hc=class{constructor(t,e=""){this.client=t,this.prefix=e}async listNamespaces(t){const e=t?{parent:lc(t.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(t=>({namespace:t}))}async createNamespace(t,e){const i={namespace:t.namespace,properties:e?.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:i})).data}async dropNamespace(t){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${lc(t.namespace)}`})}async loadNamespaceMetadata(t){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${lc(t.namespace)}`})).data.properties}}async namespaceExists(t){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${lc(t.namespace)}`}),!0}catch(t){if(t instanceof ac&&404===t.status)return!1;throw t}}async createNamespaceIfNotExists(t,e){try{return await this.createNamespace(t,e)}catch(t){if(t instanceof ac&&409===t.status)return;throw t}}};function cc(t){return t.join("")}var dc=class{constructor(t,e="",i){this.client=t,this.prefix=e,this.accessDelegation=i}async listTables(t){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${cc(t.namespace)}/tables`})).data.identifiers}async createTable(t,e){const i={};return this.accessDelegation&&(i["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${cc(t.namespace)}/tables`,body:e,headers:i})).data.metadata}async updateTable(t,e){const i=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${cc(t.namespace)}/tables/${t.name}`,body:e});return{"metadata-location":i.data["metadata-location"],metadata:i.data.metadata}}async dropTable(t,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${cc(t.namespace)}/tables/${t.name}`,query:{purgeRequested:String(e?.purge??!1)}})}async loadTable(t){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${cc(t.namespace)}/tables/${t.name}`,headers:e})).data.metadata}async tableExists(t){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${cc(t.namespace)}/tables/${t.name}`,headers:e}),!0}catch(t){if(t instanceof ac&&404===t.status)return!1;throw t}}async createTableIfNotExists(t,e){try{return await this.createTable(t,e)}catch(i){if(i instanceof ac&&409===i.status)return await this.loadTable({namespace:t.namespace,name:e.name});throw i}}},uc=class{constructor(t){let e="v1";t.catalogName&&(e+=`/${t.catalogName}`);const i=t.baseUrl.endsWith("/")?t.baseUrl:`${t.baseUrl}/`;this.client=function(t){const e=t.fetchImpl??globalThis.fetch;return{async request({method:i,path:s,query:n,body:o,headers:r}){const a=function(t,e,i){const s=new URL(e,t);if(i)for(const[t,e]of Object.entries(i))void 0!==e&&s.searchParams.set(t,e);return s.toString()}(t.baseUrl,s,n),l=await async function(t){return t&&"none"!==t.type?"bearer"===t.type?{Authorization:`Bearer ${t.token}`}:"header"===t.type?{[t.name]:t.value}:"custom"===t.type?await t.getHeaders():{}:{}}(t.auth),h=await e(a,{method:i,headers:{...o?{"Content-Type":"application/json"}:{},...l,...r},body:o?JSON.stringify(o):void 0}),c=await h.text(),d=(h.headers.get("content-type")||"").includes("application/json"),u=d&&c?JSON.parse(c):c;if(!h.ok){const t=d?u:void 0,e=t?.error;throw new ac(e?.message??`Request failed with status ${h.status}`,{status:h.status,icebergType:e?.type,icebergCode:e?.code,details:t})}return{status:h.status,headers:h.headers,data:u}}}}({baseUrl:i,auth:t.auth,fetchImpl:t.fetch}),this.accessDelegation=t.accessDelegation?.join(","),this.namespaceOps=new hc(this.client,e),this.tableOps=new dc(this.client,e,this.accessDelegation)}async listNamespaces(t){return this.namespaceOps.listNamespaces(t)}async createNamespace(t,e){return this.namespaceOps.createNamespace(t,e)}async dropNamespace(t){await this.namespaceOps.dropNamespace(t)}async loadNamespaceMetadata(t){return this.namespaceOps.loadNamespaceMetadata(t)}async listTables(t){return this.tableOps.listTables(t)}async createTable(t,e){return this.tableOps.createTable(t,e)}async updateTable(t,e){return this.tableOps.updateTable(t,e)}async dropTable(t,e){await this.tableOps.dropTable(t,e)}async loadTable(t){return this.tableOps.loadTable(t)}async namespaceExists(t){return this.namespaceOps.namespaceExists(t)}async tableExists(t){return this.tableOps.tableExists(t)}async createNamespaceIfNotExists(t,e){return this.namespaceOps.createNamespaceIfNotExists(t,e)}async createTableIfNotExists(t,e){return this.tableOps.createTableIfNotExists(t,e)}},pc=class extends Error{constructor(t,e="storage",i,s){super(t),this.__isStorageError=!0,this.namespace=e,this.name="vectors"===e?"StorageVectorsError":"StorageError",this.status=i,this.statusCode=s}};function gc(t){return"object"==typeof t&&null!==t&&"__isStorageError"in t}var yc=class extends pc{constructor(t,e,i,s="storage"){super(t,s,e,i),this.name="vectors"===s?"StorageVectorsApiError":"StorageApiError",this.status=e,this.statusCode=i}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},fc=class extends pc{constructor(t,e,i="storage"){super(t,i),this.name="vectors"===i?"StorageVectorsUnknownError":"StorageUnknownError",this.originalError=e}};const mc=t=>{if(Array.isArray(t))return t.map(t=>mc(t));if("function"==typeof t||t!==Object(t))return t;const e={};return Object.entries(t).forEach(([t,i])=>{const s=t.replace(/([-_][a-z])/gi,t=>t.toUpperCase().replace(/[-_]/g,""));e[s]=mc(i)}),e};function xc(t){return(xc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Sc(t,e,i){return(e=function(t){var e=function(t){if("object"!=xc(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=xc(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==xc(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ac(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,s)}return i}function Tc(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ac(Object(i),!0).forEach(function(e){Sc(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ac(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}const _c=t=>{var e;return t.msg||t.message||t.error_description||("string"==typeof t.error?t.error:null===(e=t.error)||void 0===e?void 0:e.message)||JSON.stringify(t)};async function wc(t,e,i,s,n,o,r){return new Promise((a,l)=>{t(i,((t,e,i,s)=>{const n={method:t,headers:(null==e?void 0:e.headers)||{}};return"GET"!==t&&"HEAD"!==t&&s?((t=>{if("object"!=typeof t||null===t)return!1;const e=Object.getPrototypeOf(t);return!(null!==e&&e!==Object.prototype&&null!==Object.getPrototypeOf(e)||Symbol.toStringTag in t||Symbol.iterator in t)})(s)?(n.headers=Tc({"Content-Type":"application/json"},null==e?void 0:e.headers),n.body=JSON.stringify(s)):n.body=s,(null==e?void 0:e.duplex)&&(n.duplex=e.duplex),Tc(Tc({},n),i)):Tc(Tc({},n),i)})(e,s,n,o)).then(t=>{if(!t.ok)throw t;if(null==s?void 0:s.noResolveJson)return t;if("vectors"===r){const e=t.headers.get("content-type");if("0"===t.headers.get("content-length")||204===t.status)return{};if(!e||!e.includes("application/json"))return{}}return t.json()}).then(t=>a(t)).catch(t=>(async(t,e,i,s)=>{if(t&&"object"==typeof t&&"status"in t&&"ok"in t&&"number"==typeof t.status&&!(null==i?void 0:i.noResolveJson)){const i=t,n=i.status||500;if("function"==typeof i.json)i.json().then(t=>{const i=(null==t?void 0:t.statusCode)||(null==t?void 0:t.code)||n+"";e(new yc(_c(t),n,i,s))}).catch(()=>{if("vectors"===s){const t=n+"";e(new yc(i.statusText||`HTTP ${n} error`,n,t,s))}else{const t=n+"";e(new yc(i.statusText||`HTTP ${n} error`,n,t,s))}});else{const t=n+"";e(new yc(i.statusText||`HTTP ${n} error`,n,t,s))}}else e(new fc(_c(t),t,s))})(t,l,s,r))})}function Ec(t="storage"){return{get:async(e,i,s,n)=>wc(e,"GET",i,s,n,void 0,t),post:async(e,i,s,n,o)=>wc(e,"POST",i,n,o,s,t),put:async(e,i,s,n,o)=>wc(e,"PUT",i,n,o,s,t),head:async(e,i,s,n)=>wc(e,"HEAD",i,Tc(Tc({},s),{},{noResolveJson:!0}),n,void 0,t),remove:async(e,i,s,n,o)=>wc(e,"DELETE",i,n,o,s,t)}}const bc=Ec("storage"),{get:vc,post:Pc,put:Cc,head:Ic,remove:Rc}=bc,Mc=Ec("vectors");var Lc=class{constructor(t,e={},i,s="storage"){var n;this.shouldThrowOnError=!1,this.url=t,this.headers=e,this.fetch=(n=i)?(...t)=>n(...t):(...t)=>fetch(...t),this.namespace=s}throwOnError(){return this.shouldThrowOnError=!0,this}async handleOperation(t){try{return{data:await t(),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(gc(t))return{data:null,error:t};throw t}}},Fc=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e}then(t,e){return this.execute().then(t,e)}async execute(){try{return{data:(await this.downloadFn()).body,error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(gc(t))return{data:null,error:t};throw t}}};let kc;kc=Symbol.toStringTag;var Dc=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e,this[kc]="BlobDownloadBuilder",this.promise=null}asStream(){return new Fc(this.downloadFn,this.shouldThrowOnError)}then(t,e){return this.getPromise().then(t,e)}catch(t){return this.getPromise().catch(t)}finally(t){return this.getPromise().finally(t)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){try{return{data:await(await this.downloadFn()).blob(),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(gc(t))return{data:null,error:t};throw t}}};const Oc={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Nc={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var Bc=class extends Lc{constructor(t,e={},i,s){super(t,e,s,"storage"),this.bucketId=i}async uploadOrUpdate(t,e,i,s){var n=this;return n.handleOperation(async()=>{let o;const r=Tc(Tc({},Nc),s);let a=Tc(Tc({},n.headers),"POST"===t&&{"x-upsert":String(r.upsert)});const l=r.metadata;"undefined"!=typeof Blob&&i instanceof Blob?(o=new FormData,o.append("cacheControl",r.cacheControl),l&&o.append("metadata",n.encodeMetadata(l)),o.append("",i)):"undefined"!=typeof FormData&&i instanceof FormData?(o=i,o.has("cacheControl")||o.append("cacheControl",r.cacheControl),l&&!o.has("metadata")&&o.append("metadata",n.encodeMetadata(l))):(o=i,a["cache-control"]=`max-age=${r.cacheControl}`,a["content-type"]=r.contentType,l&&(a["x-metadata"]=n.toBase64(n.encodeMetadata(l))),("undefined"!=typeof ReadableStream&&o instanceof ReadableStream||o&&"object"==typeof o&&"pipe"in o&&"function"==typeof o.pipe)&&!r.duplex&&(r.duplex="half")),(null==s?void 0:s.headers)&&(a=Tc(Tc({},a),s.headers));const h=n._removeEmptyFolders(e),c=n._getFinalPath(h),d=await("PUT"==t?Cc:Pc)(n.fetch,`${n.url}/object/${c}`,o,Tc({headers:a},(null==r?void 0:r.duplex)?{duplex:r.duplex}:{}));return{path:h,id:d.Id,fullPath:d.Key}})}async upload(t,e,i){return this.uploadOrUpdate("POST",t,e,i)}async uploadToSignedUrl(t,e,i,s){var n=this;const o=n._removeEmptyFolders(t),r=n._getFinalPath(o),a=new URL(n.url+`/object/upload/sign/${r}`);return a.searchParams.set("token",e),n.handleOperation(async()=>{let t;const e=Tc({upsert:Nc.upsert},s),r=Tc(Tc({},n.headers),{"x-upsert":String(e.upsert)});return"undefined"!=typeof Blob&&i instanceof Blob?(t=new FormData,t.append("cacheControl",e.cacheControl),t.append("",i)):"undefined"!=typeof FormData&&i instanceof FormData?(t=i,t.append("cacheControl",e.cacheControl)):(t=i,r["cache-control"]=`max-age=${e.cacheControl}`,r["content-type"]=e.contentType),{path:o,fullPath:(await Cc(n.fetch,a.toString(),t,{headers:r})).Key}})}async createSignedUploadUrl(t,e){var i=this;return i.handleOperation(async()=>{let s=i._getFinalPath(t);const n=Tc({},i.headers);(null==e?void 0:e.upsert)&&(n["x-upsert"]="true");const o=await Pc(i.fetch,`${i.url}/object/upload/sign/${s}`,{},{headers:n}),r=new URL(i.url+o.url),a=r.searchParams.get("token");if(!a)throw new pc("No token returned by API");return{signedUrl:r.toString(),path:t,token:a}})}async update(t,e,i){return this.uploadOrUpdate("PUT",t,e,i)}async move(t,e,i){var s=this;return s.handleOperation(async()=>await Pc(s.fetch,`${s.url}/object/move`,{bucketId:s.bucketId,sourceKey:t,destinationKey:e,destinationBucket:null==i?void 0:i.destinationBucket},{headers:s.headers}))}async copy(t,e,i){var s=this;return s.handleOperation(async()=>({path:(await Pc(s.fetch,`${s.url}/object/copy`,{bucketId:s.bucketId,sourceKey:t,destinationKey:e,destinationBucket:null==i?void 0:i.destinationBucket},{headers:s.headers})).Key}))}async createSignedUrl(t,e,i){var s=this;return s.handleOperation(async()=>{let n=s._getFinalPath(t),o=await Pc(s.fetch,`${s.url}/object/sign/${n}`,Tc({expiresIn:e},(null==i?void 0:i.transform)?{transform:i.transform}:{}),{headers:s.headers});const r=(null==i?void 0:i.download)?`&download=${!0===i.download?"":i.download}`:"";return{signedUrl:encodeURI(`${s.url}${o.signedURL}${r}`)}})}async createSignedUrls(t,e,i){var s=this;return s.handleOperation(async()=>{const n=await Pc(s.fetch,`${s.url}/object/sign/${s.bucketId}`,{expiresIn:e,paths:t},{headers:s.headers}),o=(null==i?void 0:i.download)?`&download=${!0===i.download?"":i.download}`:"";return n.map(t=>Tc(Tc({},t),{},{signedUrl:t.signedURL?encodeURI(`${s.url}${t.signedURL}${o}`):null}))})}download(t,e,i){const s=void 0!==(null==e?void 0:e.transform)?"render/image/authenticated":"object",n=this.transformOptsToQueryString((null==e?void 0:e.transform)||{}),o=n?`?${n}`:"",r=this._getFinalPath(t);return new Dc(()=>vc(this.fetch,`${this.url}/${s}/${r}${o}`,{headers:this.headers,noResolveJson:!0},i),this.shouldThrowOnError)}async info(t){var e=this;const i=e._getFinalPath(t);return e.handleOperation(async()=>mc(await vc(e.fetch,`${e.url}/object/info/${i}`,{headers:e.headers})))}async exists(t){var e=this;const i=e._getFinalPath(t);try{return await Ic(e.fetch,`${e.url}/object/${i}`,{headers:e.headers}),{data:!0,error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(gc(t)&&t instanceof fc){const e=t.originalError;if([400,404].includes(null==e?void 0:e.status))return{data:!1,error:t}}throw t}}getPublicUrl(t,e){const i=this._getFinalPath(t),s=[],n=(null==e?void 0:e.download)?`download=${!0===e.download?"":e.download}`:"";""!==n&&s.push(n);const o=void 0!==(null==e?void 0:e.transform)?"render/image":"object",r=this.transformOptsToQueryString((null==e?void 0:e.transform)||{});""!==r&&s.push(r);let a=s.join("&");return""!==a&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${i}${a}`)}}}async remove(t){var e=this;return e.handleOperation(async()=>await Rc(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:t},{headers:e.headers}))}async list(t,e,i){var s=this;return s.handleOperation(async()=>{const n=Tc(Tc(Tc({},Oc),e),{},{prefix:t||""});return await Pc(s.fetch,`${s.url}/object/list/${s.bucketId}`,n,{headers:s.headers},i)})}async listV2(t,e){var i=this;return i.handleOperation(async()=>{const s=Tc({},t);return await Pc(i.fetch,`${i.url}/object/list-v2/${i.bucketId}`,s,{headers:i.headers},e)})}encodeMetadata(t){return JSON.stringify(t)}toBase64(t){return"undefined"!=typeof Buffer?Buffer.from(t).toString("base64"):btoa(t)}_getFinalPath(t){return`${this.bucketId}/${t.replace(/^\/+/,"")}`}_removeEmptyFolders(t){return t.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(t){const e=[];return t.width&&e.push(`width=${t.width}`),t.height&&e.push(`height=${t.height}`),t.resize&&e.push(`resize=${t.resize}`),t.format&&e.push(`format=${t.format}`),t.quality&&e.push(`quality=${t.quality}`),e.join("&")}};const Uc={"X-Client-Info":"storage-js/2.95.3"};var Gc=class extends Lc{constructor(t,e={},i,s){const n=new URL(t);(null==s?void 0:s.useNewHostname)&&/supabase\.(co|in|red)$/.test(n.hostname)&&!n.hostname.includes("storage.supabase.")&&(n.hostname=n.hostname.replace("supabase.","storage.supabase.")),super(n.href.replace(/\/$/,""),Tc(Tc({},Uc),e),i,"storage")}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const i=e.listBucketOptionsToQueryString(t);return await vc(e.fetch,`${e.url}/bucket${i}`,{headers:e.headers})})}async getBucket(t){var e=this;return e.handleOperation(async()=>await vc(e.fetch,`${e.url}/bucket/${t}`,{headers:e.headers}))}async createBucket(t,e={public:!1}){var i=this;return i.handleOperation(async()=>await Pc(i.fetch,`${i.url}/bucket`,{id:t,name:t,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:i.headers}))}async updateBucket(t,e){var i=this;return i.handleOperation(async()=>await Cc(i.fetch,`${i.url}/bucket/${t}`,{id:t,name:t,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:i.headers}))}async emptyBucket(t){var e=this;return e.handleOperation(async()=>await Pc(e.fetch,`${e.url}/bucket/${t}/empty`,{},{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Rc(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}listBucketOptionsToQueryString(t){const e={};return t&&("limit"in t&&(e.limit=String(t.limit)),"offset"in t&&(e.offset=String(t.offset)),t.search&&(e.search=t.search),t.sortColumn&&(e.sortColumn=t.sortColumn),t.sortOrder&&(e.sortOrder=t.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},Hc=class extends Lc{constructor(t,e={},i){super(t.replace(/\/$/,""),Tc(Tc({},Uc),e),i,"storage")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Pc(e.fetch,`${e.url}/bucket`,{name:t},{headers:e.headers}))}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const i=new URLSearchParams;void 0!==(null==t?void 0:t.limit)&&i.set("limit",t.limit.toString()),void 0!==(null==t?void 0:t.offset)&&i.set("offset",t.offset.toString()),(null==t?void 0:t.sortColumn)&&i.set("sortColumn",t.sortColumn),(null==t?void 0:t.sortOrder)&&i.set("sortOrder",t.sortOrder),(null==t?void 0:t.search)&&i.set("search",t.search);const s=i.toString(),n=s?`${e.url}/bucket?${s}`:`${e.url}/bucket`;return await vc(e.fetch,n,{headers:e.headers})})}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Rc(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}from(t){var e=this;if(!(t=>!(!t||"string"!=typeof t)&&!(0===t.length||t.length>100)&&t.trim()===t&&!t.includes("/")&&!t.includes("\\")&&/^[\w!.\*'() &$@=;:+,?-]+$/.test(t))(t))throw new pc("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const i=new uc({baseUrl:this.url,catalogName:t,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),s=this.shouldThrowOnError;return new Proxy(i,{get(t,e){const i=t[e];return"function"!=typeof i?i:async(...e)=>{try{return{data:await i.apply(t,e),error:null}}catch(t){if(s)throw t;return{data:null,error:t}}}}})}},Wc=class extends Lc{constructor(t,e={},i){super(t.replace(/\/$/,""),Tc(Tc({},Uc),{},{"Content-Type":"application/json"},e),i,"vectors")}async createIndex(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/CreateIndex`,t,{headers:e.headers})||{})}async getIndex(t,e){var i=this;return i.handleOperation(async()=>await Mc.post(i.fetch,`${i.url}/GetIndex`,{vectorBucketName:t,indexName:e},{headers:i.headers}))}async listIndexes(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/ListIndexes`,t,{headers:e.headers}))}async deleteIndex(t,e){var i=this;return i.handleOperation(async()=>await Mc.post(i.fetch,`${i.url}/DeleteIndex`,{vectorBucketName:t,indexName:e},{headers:i.headers})||{})}},$c=class extends Lc{constructor(t,e={},i){super(t.replace(/\/$/,""),Tc(Tc({},Uc),{},{"Content-Type":"application/json"},e),i,"vectors")}async putVectors(t){var e=this;if(t.vectors.length<1||t.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/PutVectors`,t,{headers:e.headers})||{})}async getVectors(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/GetVectors`,t,{headers:e.headers}))}async listVectors(t){var e=this;if(void 0!==t.segmentCount){if(t.segmentCount<1||t.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(void 0!==t.segmentIndex&&(t.segmentIndex<0||t.segmentIndex>=t.segmentCount))throw new Error("segmentIndex must be between 0 and "+(t.segmentCount-1))}return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/ListVectors`,t,{headers:e.headers}))}async queryVectors(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/QueryVectors`,t,{headers:e.headers}))}async deleteVectors(t){var e=this;if(t.keys.length<1||t.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/DeleteVectors`,t,{headers:e.headers})||{})}},Vc=class extends Lc{constructor(t,e={},i){super(t.replace(/\/$/,""),Tc(Tc({},Uc),{},{"Content-Type":"application/json"},e),i,"vectors")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}async getBucket(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:t},{headers:e.headers}))}async listBuckets(t={}){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/ListVectorBuckets`,t,{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Mc.post(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}},zc=class extends Vc{constructor(t,e={}){super(t,e.headers||{},e.fetch)}from(t){return new jc(this.url,this.headers,t,this.fetch)}async createBucket(t){return(()=>super.createBucket)().call(this,t)}async getBucket(t){return(()=>super.getBucket)().call(this,t)}async listBuckets(t={}){return(()=>super.listBuckets)().call(this,t)}async deleteBucket(t){return(()=>super.deleteBucket)().call(this,t)}},jc=class extends Wc{constructor(t,e,i,s){super(t,e,s),this.vectorBucketName=i}async createIndex(t){return(()=>super.createIndex)().call(this,Tc(Tc({},t),{},{vectorBucketName:this.vectorBucketName}))}async listIndexes(t={}){return(()=>super.listIndexes)().call(this,Tc(Tc({},t),{},{vectorBucketName:this.vectorBucketName}))}async getIndex(t){return(()=>super.getIndex)().call(this,this.vectorBucketName,t)}async deleteIndex(t){return(()=>super.deleteIndex)().call(this,this.vectorBucketName,t)}index(t){return new Kc(this.url,this.headers,this.vectorBucketName,t,this.fetch)}},Kc=class extends $c{constructor(t,e,i,s,n){super(t,e,n),this.vectorBucketName=i,this.indexName=s}async putVectors(t){var e=this;return(()=>super.putVectors)().call(e,Tc(Tc({},t),{},{vectorBucketName:e.vectorBucketName,indexName:e.indexName}))}async getVectors(t){var e=this;return(()=>super.getVectors)().call(e,Tc(Tc({},t),{},{vectorBucketName:e.vectorBucketName,indexName:e.indexName}))}async listVectors(t={}){var e=this;return(()=>super.listVectors)().call(e,Tc(Tc({},t),{},{vectorBucketName:e.vectorBucketName,indexName:e.indexName}))}async queryVectors(t){var e=this;return(()=>super.queryVectors)().call(e,Tc(Tc({},t),{},{vectorBucketName:e.vectorBucketName,indexName:e.indexName}))}async deleteVectors(t){var e=this;return(()=>super.deleteVectors)().call(e,Tc(Tc({},t),{},{vectorBucketName:e.vectorBucketName,indexName:e.indexName}))}},Yc=class extends Gc{constructor(t,e={},i,s){super(t,e,i,s)}from(t){return new Bc(this.url,this.headers,t,this.fetch)}get vectors(){return new zc(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new Hc(this.url+"/iceberg",this.headers,this.fetch)}};const Xc="2.95.3",qc=3e4,Jc={"X-Client-Info":`gotrue-js/${Xc}`},Qc="X-Supabase-Api-Version",Zc=Date.parse("2024-01-01T00:00:00.0Z"),td="2024-01-01",ed=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i;class id extends Error{constructor(t,e,i){super(t),this.__isAuthError=!0,this.name="AuthError",this.status=e,this.code=i}}function sd(t){return"object"==typeof t&&null!==t&&"__isAuthError"in t}class nd extends id{constructor(t,e,i){super(t,e,i),this.name="AuthApiError",this.status=e,this.code=i}}class od extends id{constructor(t,e){super(t),this.name="AuthUnknownError",this.originalError=e}}class rd extends id{constructor(t,e,i,s){super(t,i,s),this.name=e,this.status=i}}class ad extends rd{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function ld(t){return sd(t)&&"AuthSessionMissingError"===t.name}class hd extends rd{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class cd extends rd{constructor(t){super(t,"AuthInvalidCredentialsError",400,void 0)}}class dd extends rd{constructor(t,e=null){super(t,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=e}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class ud extends rd{constructor(t,e=null){super(t,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=e}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class pd extends rd{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class gd extends rd{constructor(t,e){super(t,"AuthRetryableFetchError",e,void 0)}}function yd(t){return sd(t)&&"AuthRetryableFetchError"===t.name}class fd extends rd{constructor(t,e,i){super(t,"AuthWeakPasswordError",e,"weak_password"),this.reasons=i}}class md extends rd{constructor(t){super(t,"AuthInvalidJwtError",400,"invalid_jwt")}}const xd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Sd=" \t\n\r=".split(""),Ad=(()=>{const t=new Array(128);for(let e=0;e<t.length;e+=1)t[e]=-1;for(let e=0;e<Sd.length;e+=1)t[Sd[e].charCodeAt(0)]=-2;for(let e=0;e<xd.length;e+=1)t[xd[e].charCodeAt(0)]=e;return t})();function Td(t,e,i){if(null!==t)for(e.queue=e.queue<<8|t,e.queuedBits+=8;e.queuedBits>=6;){const t=e.queue>>e.queuedBits-6&63;i(xd[t]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const t=e.queue>>e.queuedBits-6&63;i(xd[t]),e.queuedBits-=6}}function _d(t,e,i){const s=Ad[t];if(!(s>-1)){if(-2===s)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(t)}"`)}for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)i(e.queue>>e.queuedBits-8&255),e.queuedBits-=8}function wd(t){const e=[],i=t=>{e.push(String.fromCodePoint(t))},s={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},o=t=>{!function(t,e,i){if(0===e.utf8seq){if(t<=127)return void i(t);for(let i=1;i<6;i+=1)if(!(t>>7-i&1)){e.utf8seq=i;break}if(2===e.utf8seq)e.codepoint=31&t;else if(3===e.utf8seq)e.codepoint=15&t;else{if(4!==e.utf8seq)throw new Error("Invalid UTF-8 sequence");e.codepoint=7&t}e.utf8seq-=1}else if(e.utf8seq>0){if(t<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|63&t,e.utf8seq-=1,0===e.utf8seq&&i(e.codepoint)}}(t,s,i)};for(let e=0;e<t.length;e+=1)_d(t.charCodeAt(e),n,o);return e.join("")}function Ed(t,e){if(!(t<=127)){if(t<=2047)return e(192|t>>6),void e(128|63&t);if(t<=65535)return e(224|t>>12),e(128|t>>6&63),void e(128|63&t);if(t<=1114111)return e(240|t>>18),e(128|t>>12&63),e(128|t>>6&63),void e(128|63&t);throw new Error(`Unrecognized Unicode codepoint: ${t.toString(16)}`)}e(t)}function bd(t){const e=[],i={queue:0,queuedBits:0},s=t=>{e.push(t)};for(let e=0;e<t.length;e+=1)_d(t.charCodeAt(e),i,s);return new Uint8Array(e)}function vd(t){const e=[],i={queue:0,queuedBits:0},s=t=>{e.push(t)};return t.forEach(t=>Td(t,i,s)),Td(null,i,s),e.join("")}const Pd=()=>"undefined"!=typeof window&&"undefined"!=typeof document,Cd={tested:!1,writable:!1},Id=()=>{if(!Pd())return!1;try{if("object"!=typeof globalThis.localStorage)return!1}catch(t){return!1}if(Cd.tested)return Cd.writable;const t=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(t,t),globalThis.localStorage.removeItem(t),Cd.tested=!0,Cd.writable=!0}catch(t){Cd.tested=!0,Cd.writable=!1}return Cd.writable},Rd=t=>t?(...e)=>t(...e):(...t)=>fetch(...t),Md=async(t,e,i)=>{await t.setItem(e,JSON.stringify(i))},Ld=async(t,e)=>{const i=await t.getItem(e);if(!i)return null;try{return JSON.parse(i)}catch(t){return i}},Fd=async(t,e)=>{await t.removeItem(e)};class kd{constructor(){this.promise=new kd.promiseConstructor((t,e)=>{this.resolve=t,this.reject=e})}}function Dd(t){const e=t.split(".");if(3!==e.length)throw new md("Invalid JWT structure");for(let t=0;t<e.length;t++)if(!ed.test(e[t]))throw new md("JWT not in base64url format");return{header:JSON.parse(wd(e[0])),payload:JSON.parse(wd(e[1])),signature:bd(e[2]),raw:{header:e[0],payload:e[1]}}}function Od(t){return("0"+t.toString(16)).substr(-2)}async function Nd(t,e,i=!1){const s=function(){const t=new Uint32Array(56);if("undefined"==typeof crypto){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",e=t.length;let i="";for(let s=0;s<56;s++)i+=t.charAt(Math.floor(Math.random()*e));return i}return crypto.getRandomValues(t),Array.from(t,Od).join("")}();let n=s;i&&(n+="/PASSWORD_RECOVERY"),await Md(t,`${e}-code-verifier`,n);const o=await async function(t){if("undefined"==typeof crypto||void 0===crypto.subtle||"undefined"==typeof TextEncoder)return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),t;const e=await async function(t){const e=(new TextEncoder).encode(t),i=await crypto.subtle.digest("SHA-256",e),s=new Uint8Array(i);return Array.from(s).map(t=>String.fromCharCode(t)).join("")}(t);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(s);return[o,s===o?"plain":"s256"]}kd.promiseConstructor=Promise;const Bd=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i,Ud=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Gd(t){if(!Ud.test(t))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Hd(){return new Proxy({},{get:(t,e)=>{if("__isUserNotAvailableProxy"===e)return!0;if("symbol"==typeof e){const t=e.toString();if("Symbol(Symbol.toPrimitive)"===t||"Symbol(Symbol.toStringTag)"===t||"Symbol(util.inspect.custom)"===t)return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${e}" property of the session object is not supported. Please use getUser() instead.`)},set:(t,e)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${e}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(t,e)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${e}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Wd(t){return JSON.parse(JSON.stringify(t))}const $d=t=>t.msg||t.message||t.error_description||t.error||JSON.stringify(t),Vd=[502,503,504];async function zd(t){var e,i;if(!("object"==typeof(i=t)&&null!==i&&"status"in i&&"ok"in i&&"json"in i&&"function"==typeof i.json))throw new gd($d(t),0);if(Vd.includes(t.status))throw new gd($d(t),t.status);let s,n;try{s=await t.json()}catch(t){throw new od($d(t),t)}const o=function(t){const e=t.headers.get(Qc);if(!e)return null;if(!e.match(Bd))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch(t){return null}}(t);if(o&&o.getTime()>=Zc&&"object"==typeof s&&s&&"string"==typeof s.code?n=s.code:"object"==typeof s&&s&&"string"==typeof s.error_code&&(n=s.error_code),n){if("weak_password"===n)throw new fd($d(s),t.status,(null===(e=s.weak_password)||void 0===e?void 0:e.reasons)||[]);if("session_not_found"===n)throw new ad}else if("object"==typeof s&&s&&"object"==typeof s.weak_password&&s.weak_password&&Array.isArray(s.weak_password.reasons)&&s.weak_password.reasons.length&&s.weak_password.reasons.reduce((t,e)=>t&&"string"==typeof e,!0))throw new fd($d(s),t.status,s.weak_password.reasons);throw new nd($d(s),t.status||500,n)}async function jd(t,e,i,s){var n;const o=Object.assign({},null==s?void 0:s.headers);o[Qc]||(o[Qc]=td),(null==s?void 0:s.jwt)&&(o.Authorization=`Bearer ${s.jwt}`);const r=null!==(n=null==s?void 0:s.query)&&void 0!==n?n:{};(null==s?void 0:s.redirectTo)&&(r.redirect_to=s.redirectTo);const a=Object.keys(r).length?"?"+new URLSearchParams(r).toString():"",l=await async function(t,e,i,s,n,o){const r=((t,e,i,s)=>{const n={method:t,headers:(null==e?void 0:e.headers)||{}};return"GET"===t?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},null==e?void 0:e.headers),n.body=JSON.stringify(s),Object.assign(Object.assign({},n),i))})(e,s,{},o);let a;try{a=await t(i,Object.assign({},r))}catch(t){throw console.error(t),new gd($d(t),0)}if(a.ok||await zd(a),null==s?void 0:s.noResolveJson)return a;try{return await a.json()}catch(t){await zd(t)}}(t,e,i+a,{headers:o,noResolveJson:null==s?void 0:s.noResolveJson},0,null==s?void 0:s.body);return(null==s?void 0:s.xform)?null==s?void 0:s.xform(l):{data:Object.assign({},l),error:null}}function Kd(t){var e;let i=null;var s;return function(t){return t.access_token&&t.refresh_token&&t.expires_in}(t)&&(i=Object.assign({},t),t.expires_at||(i.expires_at=(s=t.expires_in,Math.round(Date.now()/1e3)+s))),{data:{session:i,user:null!==(e=t.user)&&void 0!==e?e:t},error:null}}function Yd(t){const e=Kd(t);return!e.error&&t.weak_password&&"object"==typeof t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.message&&"string"==typeof t.weak_password.message&&t.weak_password.reasons.reduce((t,e)=>t&&"string"==typeof e,!0)&&(e.data.weak_password=t.weak_password),e}function Xd(t){var e;return{data:{user:null!==(e=t.user)&&void 0!==e?e:t},error:null}}function qd(t){return{data:t,error:null}}function Jd(t){const{action_link:e,email_otp:i,hashed_token:s,redirect_to:n,verification_type:o}=t,r=uh(t,["action_link","email_otp","hashed_token","redirect_to","verification_type"]);return{data:{properties:{action_link:e,email_otp:i,hashed_token:s,redirect_to:n,verification_type:o},user:Object.assign({},r)},error:null}}function Qd(t){return t}const Zd=["global","local","others"];class tu{constructor({url:t="",headers:e={},fetch:i}){this.url=t,this.headers=e,this.fetch=Rd(i),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(t,e=Zd[0]){if(Zd.indexOf(e)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Zd.join(", ")}`);try{return await jd(this.fetch,"POST",`${this.url}/logout?scope=${e}`,{headers:this.headers,jwt:t,noResolveJson:!0}),{data:null,error:null}}catch(t){if(sd(t))return{data:null,error:t};throw t}}async inviteUserByEmail(t,e={}){try{return await jd(this.fetch,"POST",`${this.url}/invite`,{body:{email:t,data:e.data},headers:this.headers,redirectTo:e.redirectTo,xform:Xd})}catch(t){if(sd(t))return{data:{user:null},error:t};throw t}}async generateLink(t){try{const{options:e}=t,i=uh(t,["options"]),s=Object.assign(Object.assign({},i),e);return"newEmail"in i&&(s.new_email=null==i?void 0:i.newEmail,delete s.newEmail),await jd(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:Jd,redirectTo:null==e?void 0:e.redirectTo})}catch(t){if(sd(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(t){try{return await jd(this.fetch,"POST",`${this.url}/admin/users`,{body:t,headers:this.headers,xform:Xd})}catch(t){if(sd(t))return{data:{user:null},error:t};throw t}}async listUsers(t){var e,i,s,n,o,r,a;try{const l={nextPage:null,lastPage:0,total:0},h=await jd(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:null!==(i=null===(e=null==t?void 0:t.page)||void 0===e?void 0:e.toString())&&void 0!==i?i:"",per_page:null!==(n=null===(s=null==t?void 0:t.perPage)||void 0===s?void 0:s.toString())&&void 0!==n?n:""},xform:Qd});if(h.error)throw h.error;const c=await h.json(),d=null!==(o=h.headers.get("x-total-count"))&&void 0!==o?o:0,u=null!==(a=null===(r=h.headers.get("link"))||void 0===r?void 0:r.split(","))&&void 0!==a?a:[];return u.length>0&&(u.forEach(t=>{const e=parseInt(t.split(";")[0].split("=")[1].substring(0,1)),i=JSON.parse(t.split(";")[1].split("=")[1]);l[`${i}Page`]=e}),l.total=parseInt(d)),{data:Object.assign(Object.assign({},c),l),error:null}}catch(t){if(sd(t))return{data:{users:[]},error:t};throw t}}async getUserById(t){Gd(t);try{return await jd(this.fetch,"GET",`${this.url}/admin/users/${t}`,{headers:this.headers,xform:Xd})}catch(t){if(sd(t))return{data:{user:null},error:t};throw t}}async updateUserById(t,e){Gd(t);try{return await jd(this.fetch,"PUT",`${this.url}/admin/users/${t}`,{body:e,headers:this.headers,xform:Xd})}catch(t){if(sd(t))return{data:{user:null},error:t};throw t}}async deleteUser(t,e=!1){Gd(t);try{return await jd(this.fetch,"DELETE",`${this.url}/admin/users/${t}`,{headers:this.headers,body:{should_soft_delete:e},xform:Xd})}catch(t){if(sd(t))return{data:{user:null},error:t};throw t}}async _listFactors(t){Gd(t.userId);try{const{data:e,error:i}=await jd(this.fetch,"GET",`${this.url}/admin/users/${t.userId}/factors`,{headers:this.headers,xform:t=>({data:{factors:t},error:null})});return{data:e,error:i}}catch(t){if(sd(t))return{data:null,error:t};throw t}}async _deleteFactor(t){Gd(t.userId),Gd(t.id);try{return{data:await jd(this.fetch,"DELETE",`${this.url}/admin/users/${t.userId}/factors/${t.id}`,{headers:this.headers}),error:null}}catch(t){if(sd(t))return{data:null,error:t};throw t}}async _listOAuthClients(t){var e,i,s,n,o,r,a;try{const l={nextPage:null,lastPage:0,total:0},h=await jd(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:null!==(i=null===(e=null==t?void 0:t.page)||void 0===e?void 0:e.toString())&&void 0!==i?i:"",per_page:null!==(n=null===(s=null==t?void 0:t.perPage)||void 0===s?void 0:s.toString())&&void 0!==n?n:""},xform:Qd});if(h.error)throw h.error;const c=await h.json(),d=null!==(o=h.headers.get("x-total-count"))&&void 0!==o?o:0,u=null!==(a=null===(r=h.headers.get("link"))||void 0===r?void 0:r.split(","))&&void 0!==a?a:[];return u.length>0&&(u.forEach(t=>{const e=parseInt(t.split(";")[0].split("=")[1].substring(0,1)),i=JSON.parse(t.split(";")[1].split("=")[1]);l[`${i}Page`]=e}),l.total=parseInt(d)),{data:Object.assign(Object.assign({},c),l),error:null}}catch(t){if(sd(t))return{data:{clients:[]},error:t};throw t}}async _createOAuthClient(t){try{return await jd(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:t,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(sd(t))return{data:null,error:t};throw t}}async _getOAuthClient(t){try{return await jd(this.fetch,"GET",`${this.url}/admin/oauth/clients/${t}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(sd(t))return{data:null,error:t};throw t}}async _updateOAuthClient(t,e){try{return await jd(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${t}`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(sd(t))return{data:null,error:t};throw t}}async _deleteOAuthClient(t){try{return await jd(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${t}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(sd(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(t){try{return await jd(this.fetch,"POST",`${this.url}/admin/oauth/clients/${t}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(sd(t))return{data:null,error:t};throw t}}}function eu(t={}){return{getItem:e=>t[e]||null,setItem:(e,i)=>{t[e]=i},removeItem:e=>{delete t[e]}}}const iu=!!(globalThis&&Id()&&globalThis.localStorage&&"true"===globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug"));class su extends Error{constructor(t){super(t),this.isAcquireTimeout=!0}}class nu extends su{}async function ou(t,e,i){iu&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",t,e);const s=new globalThis.AbortController;return e>0&&setTimeout(()=>{s.abort(),iu&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",t)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(t,0===e?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async s=>{if(!s){if(0===e)throw iu&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",t),new nu(`Acquiring an exclusive Navigator LockManager lock "${t}" immediately failed`);if(iu)try{const t=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(t,null,"  "))}catch(t){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",t)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await i()}iu&&console.log("@supabase/gotrue-js: navigatorLock: acquired",t,s.name);try{return await i()}finally{iu&&console.log("@supabase/gotrue-js: navigatorLock: released",t,s.name)}}))}function ru(t){if(!/^0x[a-fA-F0-9]{40}$/.test(t))throw new Error(`@supabase/auth-js: Address "${t}" is invalid.`);return t.toLowerCase()}function au(t){const e=(new TextEncoder).encode(t);return"0x"+Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}class lu extends Error{constructor({message:t,code:e,cause:i,name:s}){var n;super(t,{cause:i}),this.__isWebAuthnError=!0,this.name=null!==(n=null!=s?s:i instanceof Error?i.name:void 0)&&void 0!==n?n:"Unknown Error",this.code=e}}class hu extends lu{constructor(t,e){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e,message:t}),this.name="WebAuthnUnknownError",this.originalError=e}}function cu({error:t,options:e}){var i,s,n;const{publicKey:o}=e;if(!o)throw Error("options was missing required publicKey property");if("AbortError"===t.name){if(e.signal instanceof AbortSignal)return new lu({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else if("ConstraintError"===t.name){if(!0===(null===(i=o.authenticatorSelection)||void 0===i?void 0:i.requireResidentKey))return new lu({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:t});if("conditional"===e.mediation&&"required"===(null===(s=o.authenticatorSelection)||void 0===s?void 0:s.userVerification))return new lu({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:t});if("required"===(null===(n=o.authenticatorSelection)||void 0===n?void 0:n.userVerification))return new lu({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:t})}else{if("InvalidStateError"===t.name)return new lu({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:t});if("NotAllowedError"===t.name)return new lu({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if("NotSupportedError"===t.name)return 0===o.pubKeyCredParams.filter(t=>"public-key"===t.type).length?new lu({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:t}):new lu({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:t});if("SecurityError"===t.name){const e=window.location.hostname;if(!mu(e))return new lu({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t});if(o.rp.id!==e)return new lu({message:`The RP ID "${o.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else if("TypeError"===t.name){if(o.user.id.byteLength<1||o.user.id.byteLength>64)return new lu({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:t})}else if("UnknownError"===t.name)return new lu({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new lu({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}function du({error:t,options:e}){const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if("AbortError"===t.name){if(e.signal instanceof AbortSignal)return new lu({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else{if("NotAllowedError"===t.name)return new lu({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if("SecurityError"===t.name){const e=window.location.hostname;if(!mu(e))return new lu({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t});if(i.rpId!==e)return new lu({message:`The RP ID "${i.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else if("UnknownError"===t.name)return new lu({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new lu({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}const uu=new class{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const t=new AbortController;return this.controller=t,t.signal}cancelCeremony(){if(this.controller){const t=new Error("Manually cancelling existing WebAuthn API call");t.name="AbortError",this.controller.abort(t),this.controller=void 0}}};function pu(t){if(!t)throw new Error("Credential creation options are required");if("undefined"!=typeof PublicKeyCredential&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&"function"==typeof PublicKeyCredential.parseCreationOptionsFromJSON)return PublicKeyCredential.parseCreationOptionsFromJSON(t);const{challenge:e,user:i,excludeCredentials:s}=t,n=uh(t,["challenge","user","excludeCredentials"]),o=bd(e).buffer,r=Object.assign(Object.assign({},i),{id:bd(i.id).buffer}),a=Object.assign(Object.assign({},n),{challenge:o,user:r});if(s&&s.length>0){a.excludeCredentials=new Array(s.length);for(let t=0;t<s.length;t++){const e=s[t];a.excludeCredentials[t]=Object.assign(Object.assign({},e),{id:bd(e.id).buffer,type:e.type||"public-key",transports:e.transports})}}return a}function gu(t){if(!t)throw new Error("Credential request options are required");if("undefined"!=typeof PublicKeyCredential&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&"function"==typeof PublicKeyCredential.parseRequestOptionsFromJSON)return PublicKeyCredential.parseRequestOptionsFromJSON(t);const{challenge:e,allowCredentials:i}=t,s=uh(t,["challenge","allowCredentials"]),n=bd(e).buffer,o=Object.assign(Object.assign({},s),{challenge:n});if(i&&i.length>0){o.allowCredentials=new Array(i.length);for(let t=0;t<i.length;t++){const e=i[t];o.allowCredentials[t]=Object.assign(Object.assign({},e),{id:bd(e.id).buffer,type:e.type||"public-key",transports:e.transports})}}return o}function yu(t){var e;if("toJSON"in t&&"function"==typeof t.toJSON)return t.toJSON();const i=t;return{id:t.id,rawId:t.id,response:{attestationObject:vd(new Uint8Array(t.response.attestationObject)),clientDataJSON:vd(new Uint8Array(t.response.clientDataJSON))},type:"public-key",clientExtensionResults:t.getClientExtensionResults(),authenticatorAttachment:null!==(e=i.authenticatorAttachment)&&void 0!==e?e:void 0}}function fu(t){var e;if("toJSON"in t&&"function"==typeof t.toJSON)return t.toJSON();const i=t,s=t.getClientExtensionResults(),n=t.response;return{id:t.id,rawId:t.id,response:{authenticatorData:vd(new Uint8Array(n.authenticatorData)),clientDataJSON:vd(new Uint8Array(n.clientDataJSON)),signature:vd(new Uint8Array(n.signature)),userHandle:n.userHandle?vd(new Uint8Array(n.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:null!==(e=i.authenticatorAttachment)&&void 0!==e?e:void 0}}function mu(t){return"localhost"===t||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(t)}function xu(){var t,e;return!!(Pd()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&"function"==typeof(null===(t=null===navigator||void 0===navigator?void 0:navigator.credentials)||void 0===t?void 0:t.create)&&"function"==typeof(null===(e=null===navigator||void 0===navigator?void 0:navigator.credentials)||void 0===e?void 0:e.get))}const Su={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},Au={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Tu(...t){const e=t=>null!==t&&"object"==typeof t&&!Array.isArray(t),i=t=>t instanceof ArrayBuffer||ArrayBuffer.isView(t),s={};for(const n of t)if(n)for(const t in n){const o=n[t];if(void 0!==o)if(Array.isArray(o))s[t]=o;else if(i(o))s[t]=o;else if(e(o)){const i=s[t];e(i)?s[t]=Tu(i,o):s[t]=Tu(o)}else s[t]=o}return s}class _u{constructor(t){this.client=t,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(t){return this.client.mfa.enroll(Object.assign(Object.assign({},t),{factorType:"webauthn"}))}async _challenge({factorId:t,webauthn:e,friendlyName:i,signal:s},n){var o;try{const{data:r,error:a}=await this.client.mfa.challenge({factorId:t,webauthn:e});if(!r)return{data:null,error:a};const l=null!=s?s:uu.createNewAbortSignal();if("create"===r.webauthn.type){const{user:t}=r.webauthn.credential_options.publicKey;if(!t.name){const e=i;if(e)t.name=`${t.id}:${e}`;else{const e=(await this.client.getUser()).data.user,i=(null===(o=null==e?void 0:e.user_metadata)||void 0===o?void 0:o.name)||(null==e?void 0:e.email)||(null==e?void 0:e.id)||"User";t.name=`${t.id}:${i}`}}t.displayName||(t.displayName=t.name)}switch(r.webauthn.type){case"create":{const e=function(t,e){return Tu(Su,t,e||{})}(r.webauthn.credential_options.publicKey,null==n?void 0:n.create),{data:i,error:s}=await async function(t){try{const e=await navigator.credentials.create(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new hu("Browser returned unexpected credential type",e)}:{data:null,error:new hu("Empty credential response",e)}}catch(e){return{data:null,error:cu({error:e,options:t})}}}({publicKey:e,signal:l});return i?{data:{factorId:t,challengeId:r.id,webauthn:{type:r.webauthn.type,credential_response:i}},error:null}:{data:null,error:s}}case"request":{const e=function(t,e){return Tu(Au,t,e||{})}(r.webauthn.credential_options.publicKey,null==n?void 0:n.request),{data:i,error:s}=await async function(t){try{const e=await navigator.credentials.get(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new hu("Browser returned unexpected credential type",e)}:{data:null,error:new hu("Empty credential response",e)}}catch(e){return{data:null,error:du({error:e,options:t})}}}(Object.assign(Object.assign({},r.webauthn.credential_options),{publicKey:e,signal:l}));return i?{data:{factorId:t,challengeId:r.id,webauthn:{type:r.webauthn.type,credential_response:i}},error:null}:{data:null,error:s}}}}catch(t){return sd(t)?{data:null,error:t}:{data:null,error:new od("Unexpected error in challenge",t)}}}async _verify({challengeId:t,factorId:e,webauthn:i}){return this.client.mfa.verify({factorId:e,challengeId:t,webauthn:i})}async _authenticate({factorId:t,webauthn:{rpId:e=("undefined"!=typeof window?window.location.hostname:void 0),rpOrigins:i=("undefined"!=typeof window?[window.location.origin]:void 0),signal:s}={}},n){if(!e)return{data:null,error:new id("rpId is required for WebAuthn authentication")};try{if(!xu())return{data:null,error:new od("Browser does not support WebAuthn",null)};const{data:o,error:r}=await this.challenge({factorId:t,webauthn:{rpId:e,rpOrigins:i},signal:s},{request:n});if(!o)return{data:null,error:r};const{webauthn:a}=o;return this._verify({factorId:t,challengeId:o.challengeId,webauthn:{type:a.type,rpId:e,rpOrigins:i,credential_response:a.credential_response}})}catch(t){return sd(t)?{data:null,error:t}:{data:null,error:new od("Unexpected error in authenticate",t)}}}async _register({friendlyName:t,webauthn:{rpId:e=("undefined"!=typeof window?window.location.hostname:void 0),rpOrigins:i=("undefined"!=typeof window?[window.location.origin]:void 0),signal:s}={}},n){if(!e)return{data:null,error:new id("rpId is required for WebAuthn registration")};try{if(!xu())return{data:null,error:new od("Browser does not support WebAuthn",null)};const{data:o,error:r}=await this._enroll({friendlyName:t});if(!o)return await this.client.mfa.listFactors().then(e=>{var i;return null===(i=e.data)||void 0===i?void 0:i.all.find(e=>"webauthn"===e.factor_type&&e.friendly_name===t&&"unverified"!==e.status)}).then(t=>t?this.client.mfa.unenroll({factorId:null==t?void 0:t.id}):void 0),{data:null,error:r};const{data:a,error:l}=await this._challenge({factorId:o.id,friendlyName:o.friendly_name,webauthn:{rpId:e,rpOrigins:i},signal:s},{create:n});return a?this._verify({factorId:o.id,challengeId:a.challengeId,webauthn:{rpId:e,rpOrigins:i,type:a.webauthn.type,credential_response:a.webauthn.credential_response}}):{data:null,error:l}}catch(t){return sd(t)?{data:null,error:t}:{data:null,error:new od("Unexpected error in register",t)}}}}!function(){if("object"!=typeof globalThis)try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch(t){"undefined"!=typeof self&&(self.globalThis=self)}}();const wu={url:"http://localhost:9999",storageKey:"supabase.auth.token",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Jc,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function Eu(t,e,i){return await i()}const bu={};class vu{get jwks(){var t,e;return null!==(e=null===(t=bu[this.storageKey])||void 0===t?void 0:t.jwks)&&void 0!==e?e:{keys:[]}}set jwks(t){bu[this.storageKey]=Object.assign(Object.assign({},bu[this.storageKey]),{jwks:t})}get jwks_cached_at(){var t,e;return null!==(e=null===(t=bu[this.storageKey])||void 0===t?void 0:t.cachedAt)&&void 0!==e?e:Number.MIN_SAFE_INTEGER}set jwks_cached_at(t){bu[this.storageKey]=Object.assign(Object.assign({},bu[this.storageKey]),{cachedAt:t})}constructor(t){var e,i,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const n=Object.assign(Object.assign({},wu),t);if(this.storageKey=n.storageKey,this.instanceID=null!==(e=vu.nextInstanceID[this.storageKey])&&void 0!==e?e:0,vu.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!n.debug,"function"==typeof n.debug&&(this.logger=n.debug),this.instanceID>0&&Pd()){const t=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(t),this.logDebugMessages&&console.trace(t)}if(this.persistSession=n.persistSession,this.autoRefreshToken=n.autoRefreshToken,this.admin=new tu({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=Rd(n.fetch),this.lock=n.lock||Eu,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,this.throwOnError=n.throwOnError,this.lockAcquireTimeout=n.lockAcquireTimeout,n.lock?this.lock=n.lock:this.persistSession&&Pd()&&(null===(i=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===i?void 0:i.locks)?this.lock=ou:this.lock=Eu,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new _u(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(n.storage?this.storage=n.storage:Id()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=eu(this.memoryStorage)),n.userStorage&&(this.userStorage=n.userStorage)):(this.memoryStorage={},this.storage=eu(this.memoryStorage)),Pd()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(t){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",t)}null===(s=this.broadcastChannel)||void 0===s||s.addEventListener("message",async t=>{this._debug("received broadcast notification from other tab or client",t);try{await this._notifyAllSubscribers(t.data.event,t.data.session,!1)}catch(t){this._debug("#broadcastChannel","error",t)}})}this.initialize().catch(t=>{this._debug("#initialize()","error",t)})}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(t){if(this.throwOnError&&t&&t.error)throw t.error;return t}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${Xc}) ${(new Date).toISOString()}`}_debug(...t){return this.logDebugMessages&&this.logger(this._logPrefix(),...t),this}async initialize(){return this.initializePromise||(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))()),await this.initializePromise}async _initialize(){var t;try{let e={},i="none";if(Pd()&&(e=function(t){const e={},i=new URL(t);if(i.hash&&"#"===i.hash[0])try{new URLSearchParams(i.hash.substring(1)).forEach((t,i)=>{e[i]=t})}catch(t){}return i.searchParams.forEach((t,i)=>{e[i]=t}),e}(window.location.href),this._isImplicitGrantCallback(e)?i="implicit":await this._isPKCECallback(e)&&(i="pkce")),Pd()&&this.detectSessionInUrl&&"none"!==i){const{data:s,error:n}=await this._getSessionFromURL(e,i);if(n){if(this._debug("#_initialize()","error detecting session from URL",n),function(t){return sd(t)&&"AuthImplicitGrantRedirectError"===t.name}(n)){const e=null===(t=n.details)||void 0===t?void 0:t.code;if("identity_already_exists"===e||"identity_not_found"===e||"single_identity_not_deletable"===e)return{error:n}}return{error:n}}const{session:o,redirectType:r}=s;return this._debug("#_initialize()","detected session in URL",o,"redirect type",r),await this._saveSession(o),setTimeout(async()=>{"recovery"===r?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return sd(t)?this._returnResult({error:t}):this._returnResult({error:new od("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(t){var e,i,s;try{const n=await jd(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:null!==(i=null===(e=null==t?void 0:t.options)||void 0===e?void 0:e.data)&&void 0!==i?i:{},gotrue_meta_security:{captcha_token:null===(s=null==t?void 0:t.options)||void 0===s?void 0:s.captchaToken}},xform:Kd}),{data:o,error:r}=n;if(r||!o)return this._returnResult({data:{user:null,session:null},error:r});const a=o.session,l=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",a)),this._returnResult({data:{user:l,session:a},error:null})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signUp(t){var e,i,s;try{let n;if("email"in t){const{email:i,password:s,options:o}=t;let r=null,a=null;"pkce"===this.flowType&&([r,a]=await Nd(this.storage,this.storageKey)),n=await jd(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:null==o?void 0:o.emailRedirectTo,body:{email:i,password:s,data:null!==(e=null==o?void 0:o.data)&&void 0!==e?e:{},gotrue_meta_security:{captcha_token:null==o?void 0:o.captchaToken},code_challenge:r,code_challenge_method:a},xform:Kd})}else{if(!("phone"in t))throw new cd("You must provide either an email or phone number and a password");{const{phone:e,password:o,options:r}=t;n=await jd(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:e,password:o,data:null!==(i=null==r?void 0:r.data)&&void 0!==i?i:{},channel:null!==(s=null==r?void 0:r.channel)&&void 0!==s?s:"sms",gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken}},xform:Kd})}}const{data:o,error:r}=n;if(r||!o)return await Fd(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:r});const a=o.session,l=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",a)),this._returnResult({data:{user:l,session:a},error:null})}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithPassword(t){try{let e;if("email"in t){const{email:i,password:s,options:n}=t;e=await jd(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:s,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},xform:Yd})}else{if(!("phone"in t))throw new cd("You must provide either an email or phone number and a password");{const{phone:i,password:s,options:n}=t;e=await jd(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:s,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},xform:Yd})}}const{data:i,error:s}=e;if(s)return this._returnResult({data:{user:null,session:null},error:s});if(!i||!i.session||!i.user){const t=new hd;return this._returnResult({data:{user:null,session:null},error:t})}return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),this._returnResult({data:Object.assign({user:i.user,session:i.session},i.weak_password?{weakPassword:i.weak_password}:null),error:s})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(t){var e,i,s,n;return await this._handleProviderSignIn(t.provider,{redirectTo:null===(e=t.options)||void 0===e?void 0:e.redirectTo,scopes:null===(i=t.options)||void 0===i?void 0:i.scopes,queryParams:null===(s=t.options)||void 0===s?void 0:s.queryParams,skipBrowserRedirect:null===(n=t.options)||void 0===n?void 0:n.skipBrowserRedirect})}async exchangeCodeForSession(t){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(t))}async signInWithWeb3(t){const{chain:e}=t;switch(e){case"ethereum":return await this.signInWithEthereum(t);case"solana":return await this.signInWithSolana(t);default:throw new Error(`@supabase/auth-js: Unsupported chain "${e}"`)}}async signInWithEthereum(t){var e,i,s,n,o,r,a,l,h,c,d;let u,p;if("message"in t)u=t.message,p=t.signature;else{const{chain:c,wallet:d,statement:g,options:y}=t;let f;if(Pd())if("object"==typeof d)f=d;else{const t=window;if(!("ethereum"in t)||"object"!=typeof t.ethereum||!("request"in t.ethereum)||"function"!=typeof t.ethereum.request)throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.");f=t.ethereum}else{if("object"!=typeof d||!(null==y?void 0:y.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");f=d}const m=new URL(null!==(e=null==y?void 0:y.url)&&void 0!==e?e:window.location.href),x=await f.request({method:"eth_requestAccounts"}).then(t=>t).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!x||0===x.length)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const S=ru(x[0]);let A=null===(i=null==y?void 0:y.signInWithEthereum)||void 0===i?void 0:i.chainId;if(!A){const t=await f.request({method:"eth_chainId"});A=parseInt(t,16)}u=function(t){var e;const{chainId:i,domain:s,expirationTime:n,issuedAt:o=new Date,nonce:r,notBefore:a,requestId:l,resources:h,scheme:c,uri:d,version:u}=t;if(!Number.isInteger(i))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${i}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(r&&r.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${r}`);if(!d)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if("1"!==u)throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${u}`);if(null===(e=t.statement)||void 0===e?void 0:e.includes("\n"))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${t.statement}`);const p=`${c?`${c}://${s}`:s} wants you to sign in with your Ethereum account:\n${ru(t.address)}\n\n${t.statement?`${t.statement}\n`:""}`;let g=`URI: ${d}\nVersion: ${u}\nChain ID: ${i}${r?`\nNonce: ${r}`:""}\nIssued At: ${o.toISOString()}`;if(n&&(g+=`\nExpiration Time: ${n.toISOString()}`),a&&(g+=`\nNot Before: ${a.toISOString()}`),l&&(g+=`\nRequest ID: ${l}`),h){let t="\nResources:";for(const e of h){if(!e||"string"!=typeof e)throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${e}`);t+=`\n- ${e}`}g+=t}return`${p}\n${g}`}({domain:m.host,address:S,statement:g,uri:m.href,version:"1",chainId:A,nonce:null===(s=null==y?void 0:y.signInWithEthereum)||void 0===s?void 0:s.nonce,issuedAt:null!==(o=null===(n=null==y?void 0:y.signInWithEthereum)||void 0===n?void 0:n.issuedAt)&&void 0!==o?o:new Date,expirationTime:null===(r=null==y?void 0:y.signInWithEthereum)||void 0===r?void 0:r.expirationTime,notBefore:null===(a=null==y?void 0:y.signInWithEthereum)||void 0===a?void 0:a.notBefore,requestId:null===(l=null==y?void 0:y.signInWithEthereum)||void 0===l?void 0:l.requestId,resources:null===(h=null==y?void 0:y.signInWithEthereum)||void 0===h?void 0:h.resources}),p=await f.request({method:"personal_sign",params:[au(u),S]})}try{const{data:e,error:i}=await jd(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:u,signature:p},(null===(c=t.options)||void 0===c?void 0:c.captchaToken)?{gotrue_meta_security:{captcha_token:null===(d=t.options)||void 0===d?void 0:d.captchaToken}}:null),xform:Kd});if(i)throw i;if(!e||!e.session||!e.user){const t=new hd;return this._returnResult({data:{user:null,session:null},error:t})}return e.session&&(await this._saveSession(e.session),await this._notifyAllSubscribers("SIGNED_IN",e.session)),this._returnResult({data:Object.assign({},e),error:i})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithSolana(t){var e,i,s,n,o,r,a,l,h,c,d,u;let p,g;if("message"in t)p=t.message,g=t.signature;else{const{chain:d,wallet:u,statement:y,options:f}=t;let m;if(Pd())if("object"==typeof u)m=u;else{const t=window;if(!("solana"in t)||"object"!=typeof t.solana||!("signIn"in t.solana&&"function"==typeof t.solana.signIn||"signMessage"in t.solana&&"function"==typeof t.solana.signMessage))throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.");m=t.solana}else{if("object"!=typeof u||!(null==f?void 0:f.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");m=u}const x=new URL(null!==(e=null==f?void 0:f.url)&&void 0!==e?e:window.location.href);if("signIn"in m&&m.signIn){const t=await m.signIn(Object.assign(Object.assign(Object.assign({issuedAt:(new Date).toISOString()},null==f?void 0:f.signInWithSolana),{version:"1",domain:x.host,uri:x.href}),y?{statement:y}:null));let e;if(Array.isArray(t)&&t[0]&&"object"==typeof t[0])e=t[0];else{if(!(t&&"object"==typeof t&&"signedMessage"in t&&"signature"in t))throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");e=t}if(!("signedMessage"in e&&"signature"in e&&("string"==typeof e.signedMessage||e.signedMessage instanceof Uint8Array)&&e.signature instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields");p="string"==typeof e.signedMessage?e.signedMessage:(new TextDecoder).decode(e.signedMessage),g=e.signature}else{if(!("signMessage"in m&&"function"==typeof m.signMessage&&"publicKey"in m&&"object"==typeof m&&m.publicKey&&"toBase58"in m.publicKey&&"function"==typeof m.publicKey.toBase58))throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");p=[`${x.host} wants you to sign in with your Solana account:`,m.publicKey.toBase58(),...y?["",y,""]:[""],"Version: 1",`URI: ${x.href}`,`Issued At: ${null!==(s=null===(i=null==f?void 0:f.signInWithSolana)||void 0===i?void 0:i.issuedAt)&&void 0!==s?s:(new Date).toISOString()}`,...(null===(n=null==f?void 0:f.signInWithSolana)||void 0===n?void 0:n.notBefore)?[`Not Before: ${f.signInWithSolana.notBefore}`]:[],...(null===(o=null==f?void 0:f.signInWithSolana)||void 0===o?void 0:o.expirationTime)?[`Expiration Time: ${f.signInWithSolana.expirationTime}`]:[],...(null===(r=null==f?void 0:f.signInWithSolana)||void 0===r?void 0:r.chainId)?[`Chain ID: ${f.signInWithSolana.chainId}`]:[],...(null===(a=null==f?void 0:f.signInWithSolana)||void 0===a?void 0:a.nonce)?[`Nonce: ${f.signInWithSolana.nonce}`]:[],...(null===(l=null==f?void 0:f.signInWithSolana)||void 0===l?void 0:l.requestId)?[`Request ID: ${f.signInWithSolana.requestId}`]:[],...(null===(c=null===(h=null==f?void 0:f.signInWithSolana)||void 0===h?void 0:h.resources)||void 0===c?void 0:c.length)?["Resources",...f.signInWithSolana.resources.map(t=>`- ${t}`)]:[]].join("\n");const t=await m.signMessage((new TextEncoder).encode(p),"utf8");if(!(t&&t instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=t}}try{const{data:e,error:i}=await jd(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:p,signature:vd(g)},(null===(d=t.options)||void 0===d?void 0:d.captchaToken)?{gotrue_meta_security:{captcha_token:null===(u=t.options)||void 0===u?void 0:u.captchaToken}}:null),xform:Kd});if(i)throw i;if(!e||!e.session||!e.user){const t=new hd;return this._returnResult({data:{user:null,session:null},error:t})}return e.session&&(await this._saveSession(e.session),await this._notifyAllSubscribers("SIGNED_IN",e.session)),this._returnResult({data:Object.assign({},e),error:i})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _exchangeCodeForSession(t){const e=await Ld(this.storage,`${this.storageKey}-code-verifier`),[i,s]=(null!=e?e:"").split("/");try{if(!i&&"pkce"===this.flowType)throw new pd;const{data:e,error:n}=await jd(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:t,code_verifier:i},xform:Kd});if(await Fd(this.storage,`${this.storageKey}-code-verifier`),n)throw n;if(!e||!e.session||!e.user){const t=new hd;return this._returnResult({data:{user:null,session:null,redirectType:null},error:t})}return e.session&&(await this._saveSession(e.session),await this._notifyAllSubscribers("SIGNED_IN",e.session)),this._returnResult({data:Object.assign(Object.assign({},e),{redirectType:null!=s?s:null}),error:n})}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:{user:null,session:null,redirectType:null},error:t});throw t}}async signInWithIdToken(t){try{const{options:e,provider:i,token:s,access_token:n,nonce:o}=t,r=await jd(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:i,id_token:s,access_token:n,nonce:o,gotrue_meta_security:{captcha_token:null==e?void 0:e.captchaToken}},xform:Kd}),{data:a,error:l}=r;if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!a||!a.session||!a.user){const t=new hd;return this._returnResult({data:{user:null,session:null},error:t})}return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),this._returnResult({data:a,error:l})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(t){var e,i,s,n,o;try{if("email"in t){const{email:s,options:n}=t;let o=null,r=null;"pkce"===this.flowType&&([o,r]=await Nd(this.storage,this.storageKey));const{error:a}=await jd(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:s,data:null!==(e=null==n?void 0:n.data)&&void 0!==e?e:{},create_user:null===(i=null==n?void 0:n.shouldCreateUser)||void 0===i||i,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken},code_challenge:o,code_challenge_method:r},redirectTo:null==n?void 0:n.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:a})}if("phone"in t){const{phone:e,options:i}=t,{data:r,error:a}=await jd(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:e,data:null!==(s=null==i?void 0:i.data)&&void 0!==s?s:{},create_user:null===(n=null==i?void 0:i.shouldCreateUser)||void 0===n||n,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken},channel:null!==(o=null==i?void 0:i.channel)&&void 0!==o?o:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:null==r?void 0:r.message_id},error:a})}throw new cd("You must provide either an email or phone number.")}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async verifyOtp(t){var e,i;try{let s,n;"options"in t&&(s=null===(e=t.options)||void 0===e?void 0:e.redirectTo,n=null===(i=t.options)||void 0===i?void 0:i.captchaToken);const{data:o,error:r}=await jd(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},t),{gotrue_meta_security:{captcha_token:n}}),redirectTo:s,xform:Kd});if(r)throw r;if(!o)throw new Error("An error occurred on token verification.");const a=o.session,l=o.user;return(null==a?void 0:a.access_token)&&(await this._saveSession(a),await this._notifyAllSubscribers("recovery"==t.type?"PASSWORD_RECOVERY":"SIGNED_IN",a)),this._returnResult({data:{user:l,session:a},error:null})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithSSO(t){var e,i,s,n,o;try{let r=null,a=null;"pkce"===this.flowType&&([r,a]=await Nd(this.storage,this.storageKey));const l=await jd(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in t?{provider_id:t.providerId}:null),"domain"in t?{domain:t.domain}:null),{redirect_to:null!==(i=null===(e=t.options)||void 0===e?void 0:e.redirectTo)&&void 0!==i?i:void 0}),(null===(s=null==t?void 0:t.options)||void 0===s?void 0:s.captchaToken)?{gotrue_meta_security:{captcha_token:t.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:r,code_challenge_method:a}),headers:this.headers,xform:qd});return(null===(n=l.data)||void 0===n?void 0:n.url)&&Pd()&&!(null===(o=t.options)||void 0===o?void 0:o.skipBrowserRedirect)&&window.location.assign(l.data.url),this._returnResult(l)}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:null,error:t});throw t}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async t=>{const{data:{session:e},error:i}=t;if(i)throw i;if(!e)throw new ad;const{error:s}=await jd(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:e.access_token});return this._returnResult({data:{user:null,session:null},error:s})})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async resend(t){try{const e=`${this.url}/resend`;if("email"in t){const{email:i,type:s,options:n}=t,{error:o}=await jd(this.fetch,"POST",e,{headers:this.headers,body:{email:i,type:s,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},redirectTo:null==n?void 0:n.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:o})}if("phone"in t){const{phone:i,type:s,options:n}=t,{data:o,error:r}=await jd(this.fetch,"POST",e,{headers:this.headers,body:{phone:i,type:s,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:null==o?void 0:o.message_id},error:r})}throw new cd("You must provide either an email or phone number and a type")}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async t=>t))}async _acquireLock(t,e){this._debug("#_acquireLock","begin",t);try{if(this.lockAcquired){const t=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await t,await e()))();return this.pendingInLock.push((async()=>{try{await i}catch(t){}})()),i}return await this.lock(`lock:${this.storageKey}`,t,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const t=e();for(this.pendingInLock.push((async()=>{try{await t}catch(t){}})()),await t;this.pendingInLock.length;){const t=[...this.pendingInLock];await Promise.all(t),this.pendingInLock.splice(0,t.length)}return await t}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(t){this._debug("#_useSession","begin");try{const e=await this.__loadSession();return await t(e)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",(new Error).stack);try{let t=null;const e=await Ld(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",e),null!==e&&(this._isValidSession(e)?t=e:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!t)return{data:{session:null},error:null};const i=!!t.expires_at&&1e3*t.expires_at-Date.now()<9e4;if(this._debug("#__loadSession()",`session has${i?"":" not"} expired`,"expires_at",t.expires_at),!i){if(this.userStorage){const e=await Ld(this.userStorage,this.storageKey+"-user");(null==e?void 0:e.user)?t.user=e.user:t.user=Hd()}if(this.storage.isServer&&t.user&&!t.user.__isUserNotAvailableProxy){const e={value:this.suppressGetSessionWarning};t.user=function(t,e){return new Proxy(t,{get:(t,i,s)=>{if("__isInsecureUserWarningProxy"===i)return!0;if("symbol"==typeof i){const e=i.toString();if("Symbol(Symbol.toPrimitive)"===e||"Symbol(Symbol.toStringTag)"===e||"Symbol(util.inspect.custom)"===e||"Symbol(nodejs.util.inspect.custom)"===e)return Reflect.get(t,i,s)}return e.value||"string"!=typeof i||(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,i,s)}})}(t.user,e),e.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:t},error:null}}const{data:s,error:n}=await this._callRefreshToken(t.refresh_token);return n?this._returnResult({data:{session:null},error:n}):this._returnResult({data:{session:s},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(t){if(t)return await this._getUser(t);await this.initializePromise;const e=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return e.data.user&&(this.suppressGetSessionWarning=!0),e}async _getUser(t){try{return t?await jd(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:t,xform:Xd}):await this._useSession(async t=>{var e,i,s;const{data:n,error:o}=t;if(o)throw o;return(null===(e=n.session)||void 0===e?void 0:e.access_token)||this.hasCustomAuthorizationHeader?await jd(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:null!==(s=null===(i=n.session)||void 0===i?void 0:i.access_token)&&void 0!==s?s:void 0,xform:Xd}):{data:{user:null},error:new ad}})}catch(t){if(sd(t))return ld(t)&&(await this._removeSession(),await Fd(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(t,e={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(t,e))}async _updateUser(t,e={}){try{return await this._useSession(async i=>{const{data:s,error:n}=i;if(n)throw n;if(!s.session)throw new ad;const o=s.session;let r=null,a=null;"pkce"===this.flowType&&null!=t.email&&([r,a]=await Nd(this.storage,this.storageKey));const{data:l,error:h}=await jd(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:null==e?void 0:e.emailRedirectTo,body:Object.assign(Object.assign({},t),{code_challenge:r,code_challenge_method:a}),jwt:o.access_token,xform:Xd});if(h)throw h;return o.user=l.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),this._returnResult({data:{user:o.user},error:null})})}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:{user:null},error:t});throw t}}async setSession(t){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(t))}async _setSession(t){try{if(!t.access_token||!t.refresh_token)throw new ad;const e=Date.now()/1e3;let i=e,s=!0,n=null;const{payload:o}=Dd(t.access_token);if(o.exp&&(i=o.exp,s=i<=e),s){const{data:e,error:i}=await this._callRefreshToken(t.refresh_token);if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!e)return{data:{user:null,session:null},error:null};n=e}else{const{data:s,error:o}=await this._getUser(t.access_token);if(o)return this._returnResult({data:{user:null,session:null},error:o});n={access_token:t.access_token,refresh_token:t.refresh_token,user:s.user,token_type:"bearer",expires_in:i-e,expires_at:i},await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)}return this._returnResult({data:{user:n.user,session:n},error:null})}catch(t){if(sd(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(t){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(t))}async _refreshSession(t){try{return await this._useSession(async e=>{var i;if(!t){const{data:s,error:n}=e;if(n)throw n;t=null!==(i=s.session)&&void 0!==i?i:void 0}if(!(null==t?void 0:t.refresh_token))throw new ad;const{data:s,error:n}=await this._callRefreshToken(t.refresh_token);return n?this._returnResult({data:{user:null,session:null},error:n}):s?this._returnResult({data:{user:s.user,session:s},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(t,e){try{if(!Pd())throw new dd("No browser detected.");if(t.error||t.error_description||t.error_code)throw new dd(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});switch(e){case"implicit":if("pkce"===this.flowType)throw new ud("Not a valid PKCE flow url.");break;case"pkce":if("implicit"===this.flowType)throw new dd("Not a valid implicit grant flow url.")}if("pkce"===e){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!t.code)throw new ud("No code detected.");const{data:e,error:i}=await this._exchangeCodeForSession(t.code);if(i)throw i;const s=new URL(window.location.href);return s.searchParams.delete("code"),window.history.replaceState(window.history.state,"",s.toString()),{data:{session:e.session,redirectType:null},error:null}}const{provider_token:i,provider_refresh_token:s,access_token:n,refresh_token:o,expires_in:r,expires_at:a,token_type:l}=t;if(!(n&&r&&o&&l))throw new dd("No session defined in URL");const h=Math.round(Date.now()/1e3),c=parseInt(r);let d=h+c;a&&(d=parseInt(a));const u=d-h;1e3*u<=qc&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${u}s, should have been closer to ${c}s`);const p=d-c;h-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,d,h):h-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",p,d,h);const{data:g,error:y}=await this._getUser(n);if(y)throw y;const f={provider_token:i,provider_refresh_token:s,access_token:n,expires_in:c,expires_at:d,refresh_token:o,token_type:l,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:f,redirectType:t.type},error:null})}catch(t){if(sd(t))return this._returnResult({data:{session:null,redirectType:null},error:t});throw t}}_isImplicitGrantCallback(t){return"function"==typeof this.detectSessionInUrl?this.detectSessionInUrl(new URL(window.location.href),t):Boolean(t.access_token||t.error_description)}async _isPKCECallback(t){const e=await Ld(this.storage,`${this.storageKey}-code-verifier`);return!(!t.code||!e)}async signOut(t={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(t))}async _signOut({scope:t}={scope:"global"}){return await this._useSession(async e=>{var i;const{data:s,error:n}=e;if(n&&!ld(n))return this._returnResult({error:n});const o=null===(i=s.session)||void 0===i?void 0:i.access_token;if(o){const{error:e}=await this.admin.signOut(o,t);if(e&&(!function(t){return sd(t)&&"AuthApiError"===t.name}(e)||404!==e.status&&401!==e.status&&403!==e.status)&&!ld(e))return this._returnResult({error:e})}return"others"!==t&&(await this._removeSession(),await Fd(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(t){const e=Symbol("auth-callback"),i={id:e,callback:t,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",e),this.stateChangeEmitters.delete(e)}};return this._debug("#onAuthStateChange()","registered callback with id",e),this.stateChangeEmitters.set(e,i),(async()=>{await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(e)})})(),{data:{subscription:i}}}async _emitInitialSession(t){return await this._useSession(async e=>{var i,s;try{const{data:{session:s},error:n}=e;if(n)throw n;await(null===(i=this.stateChangeEmitters.get(t))||void 0===i?void 0:i.callback("INITIAL_SESSION",s)),this._debug("INITIAL_SESSION","callback id",t,"session",s)}catch(e){await(null===(s=this.stateChangeEmitters.get(t))||void 0===s?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",t,"error",e),console.error(e)}})}async resetPasswordForEmail(t,e={}){let i=null,s=null;"pkce"===this.flowType&&([i,s]=await Nd(this.storage,this.storageKey,!0));try{return await jd(this.fetch,"POST",`${this.url}/recover`,{body:{email:t,code_challenge:i,code_challenge_method:s,gotrue_meta_security:{captcha_token:e.captchaToken}},headers:this.headers,redirectTo:e.redirectTo})}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:null,error:t});throw t}}async getUserIdentities(){var t;try{const{data:e,error:i}=await this.getUser();if(i)throw i;return this._returnResult({data:{identities:null!==(t=e.user.identities)&&void 0!==t?t:[]},error:null})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(t){return"token"in t?this.linkIdentityIdToken(t):this.linkIdentityOAuth(t)}async linkIdentityOAuth(t){var e;try{const{data:i,error:s}=await this._useSession(async e=>{var i,s,n,o,r;const{data:a,error:l}=e;if(l)throw l;const h=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,t.provider,{redirectTo:null===(i=t.options)||void 0===i?void 0:i.redirectTo,scopes:null===(s=t.options)||void 0===s?void 0:s.scopes,queryParams:null===(n=t.options)||void 0===n?void 0:n.queryParams,skipBrowserRedirect:!0});return await jd(this.fetch,"GET",h,{headers:this.headers,jwt:null!==(r=null===(o=a.session)||void 0===o?void 0:o.access_token)&&void 0!==r?r:void 0})});if(s)throw s;return Pd()&&!(null===(e=t.options)||void 0===e?void 0:e.skipBrowserRedirect)&&window.location.assign(null==i?void 0:i.url),this._returnResult({data:{provider:t.provider,url:null==i?void 0:i.url},error:null})}catch(e){if(sd(e))return this._returnResult({data:{provider:t.provider,url:null},error:e});throw e}}async linkIdentityIdToken(t){return await this._useSession(async e=>{var i;try{const{error:s,data:{session:n}}=e;if(s)throw s;const{options:o,provider:r,token:a,access_token:l,nonce:h}=t,c=await jd(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:null!==(i=null==n?void 0:n.access_token)&&void 0!==i?i:void 0,body:{provider:r,id_token:a,access_token:l,nonce:h,link_identity:!0,gotrue_meta_security:{captcha_token:null==o?void 0:o.captchaToken}},xform:Kd}),{data:d,error:u}=c;return u?this._returnResult({data:{user:null,session:null},error:u}):d&&d.session&&d.user?(d.session&&(await this._saveSession(d.session),await this._notifyAllSubscribers("USER_UPDATED",d.session)),this._returnResult({data:d,error:u})):this._returnResult({data:{user:null,session:null},error:new hd})}catch(t){if(await Fd(this.storage,`${this.storageKey}-code-verifier`),sd(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}})}async unlinkIdentity(t){try{return await this._useSession(async e=>{var i,s;const{data:n,error:o}=e;if(o)throw o;return await jd(this.fetch,"DELETE",`${this.url}/user/identities/${t.identity_id}`,{headers:this.headers,jwt:null!==(s=null===(i=n.session)||void 0===i?void 0:i.access_token)&&void 0!==s?s:void 0})})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(t){const e=`#_refreshAccessToken(${t.substring(0,5)}...)`;this._debug(e,"begin");try{const n=Date.now();return await(i=async i=>(i>0&&await async function(t){return await new Promise(e=>{setTimeout(()=>e(null),t)})}(200*Math.pow(2,i-1)),this._debug(e,"refreshing attempt",i),await jd(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:t},headers:this.headers,xform:Kd})),s=(t,e)=>{const i=200*Math.pow(2,t);return e&&yd(e)&&Date.now()+i-n<qc},new Promise((t,e)=>{(async()=>{for(let n=0;n<1/0;n++)try{const e=await i(n);if(!s(n,null))return void t(e)}catch(t){if(!s(n,t))return void e(t)}})()}))}catch(t){if(this._debug(e,"error",t),sd(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}finally{this._debug(e,"end")}var i,s}_isValidSession(t){return"object"==typeof t&&null!==t&&"access_token"in t&&"refresh_token"in t&&"expires_at"in t}async _handleProviderSignIn(t,e){const i=await this._getUrlForProvider(`${this.url}/authorize`,t,{redirectTo:e.redirectTo,scopes:e.scopes,queryParams:e.queryParams});return this._debug("#_handleProviderSignIn()","provider",t,"options",e,"url",i),Pd()&&!e.skipBrowserRedirect&&window.location.assign(i),{data:{provider:t,url:i},error:null}}async _recoverAndRefresh(){var t,e;const i="#_recoverAndRefresh()";this._debug(i,"begin");try{const s=await Ld(this.storage,this.storageKey);if(s&&this.userStorage){let e=await Ld(this.userStorage,this.storageKey+"-user");this.storage.isServer||!Object.is(this.storage,this.userStorage)||e||(e={user:s.user},await Md(this.userStorage,this.storageKey+"-user",e)),s.user=null!==(t=null==e?void 0:e.user)&&void 0!==t?t:Hd()}else if(s&&!s.user&&!s.user){const t=await Ld(this.storage,this.storageKey+"-user");t&&(null==t?void 0:t.user)?(s.user=t.user,await Fd(this.storage,this.storageKey+"-user"),await Md(this.storage,this.storageKey,s)):s.user=Hd()}if(this._debug(i,"session from storage",s),!this._isValidSession(s))return this._debug(i,"session is not valid"),void(null!==s&&await this._removeSession());const n=1e3*(null!==(e=s.expires_at)&&void 0!==e?e:1/0)-Date.now()<9e4;if(this._debug(i,`session has${n?"":" not"} expired with margin of 90000s`),n){if(this.autoRefreshToken&&s.refresh_token){const{error:t}=await this._callRefreshToken(s.refresh_token);t&&(console.error(t),yd(t)||(this._debug(i,"refresh failed with a non-retryable error, removing the session",t),await this._removeSession()))}}else if(s.user&&!0===s.user.__isUserNotAvailableProxy)try{const{data:t,error:e}=await this._getUser(s.access_token);!e&&(null==t?void 0:t.user)?(s.user=t.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(i,"could not get user data, skipping SIGNED_IN notification")}catch(t){console.error("Error getting user data:",t),this._debug(i,"error getting user data, skipping SIGNED_IN notification",t)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(t){return this._debug(i,"error",t),void console.error(t)}finally{this._debug(i,"end")}}async _callRefreshToken(t){var e,i;if(!t)throw new ad;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${t.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new kd;const{data:e,error:i}=await this._refreshAccessToken(t);if(i)throw i;if(!e.session)throw new ad;await this._saveSession(e.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",e.session);const s={data:e.session,error:null};return this.refreshingDeferred.resolve(s),s}catch(t){if(this._debug(s,"error",t),sd(t)){const i={data:null,error:t};return yd(t)||await this._removeSession(),null===(e=this.refreshingDeferred)||void 0===e||e.resolve(i),i}throw null===(i=this.refreshingDeferred)||void 0===i||i.reject(t),t}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(t,e,i=!0){const s=`#_notifyAllSubscribers(${t})`;this._debug(s,"begin",e,`broadcast = ${i}`);try{this.broadcastChannel&&i&&this.broadcastChannel.postMessage({event:t,session:e});const s=[],n=Array.from(this.stateChangeEmitters.values()).map(async i=>{try{await i.callback(t,e)}catch(t){s.push(t)}});if(await Promise.all(n),s.length>0){for(let t=0;t<s.length;t+=1)console.error(s[t]);throw s[0]}}finally{this._debug(s,"end")}}async _saveSession(t){this._debug("#_saveSession()",t),this.suppressGetSessionWarning=!0,await Fd(this.storage,`${this.storageKey}-code-verifier`);const e=Object.assign({},t),i=e.user&&!0===e.user.__isUserNotAvailableProxy;if(this.userStorage){!i&&e.user&&await Md(this.userStorage,this.storageKey+"-user",{user:e.user});const t=Object.assign({},e);delete t.user;const s=Wd(t);await Md(this.storage,this.storageKey,s)}else{const t=Wd(e);await Md(this.storage,this.storageKey,t)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await Fd(this.storage,this.storageKey),await Fd(this.storage,this.storageKey+"-code-verifier"),await Fd(this.storage,this.storageKey+"-user"),this.userStorage&&await Fd(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const t=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{t&&Pd()&&(null===window||void 0===window?void 0:window.removeEventListener)&&window.removeEventListener("visibilitychange",t)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const t=setInterval(()=>this._autoRefreshTokenTick(),qc);this.autoRefreshTicker=t,t&&"object"==typeof t&&"function"==typeof t.unref?t.unref():"undefined"!=typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(t);const e=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=e,e&&"object"==typeof e&&"function"==typeof e.unref?e.unref():"undefined"!=typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(e)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const t=this.autoRefreshTicker;this.autoRefreshTicker=null,t&&clearInterval(t);const e=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,e&&clearTimeout(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const t=Date.now();try{return await this._useSession(async e=>{const{data:{session:i}}=e;if(!i||!i.refresh_token||!i.expires_at)return void this._debug("#_autoRefreshTokenTick()","no session");const s=Math.floor((1e3*i.expires_at-t)/qc);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts 30000ms, refresh threshold is 3 ticks`),s<=3&&await this._callRefreshToken(i.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(t){if(!(t.isAcquireTimeout||t instanceof su))throw t;this._debug("auto refresh token tick lock not available")}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Pd()||!(null===window||void 0===window?void 0:window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>{try{await this._onVisibilityChanged(!1)}catch(t){this._debug("#visibilityChangedCallback","error",t)}},null===window||void 0===window||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(t){console.error("_handleVisibilityChange",t)}}async _onVisibilityChanged(t){const e=`#_onVisibilityChanged(${t})`;this._debug(e,"visibilityState",document.visibilityState),"visible"===document.visibilityState?(this.autoRefreshToken&&this._startAutoRefresh(),t||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{"visible"===document.visibilityState?await this._recoverAndRefresh():this._debug(e,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting")}))):"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(t,e,i){const s=[`provider=${encodeURIComponent(e)}`];if((null==i?void 0:i.redirectTo)&&s.push(`redirect_to=${encodeURIComponent(i.redirectTo)}`),(null==i?void 0:i.scopes)&&s.push(`scopes=${encodeURIComponent(i.scopes)}`),"pkce"===this.flowType){const[t,e]=await Nd(this.storage,this.storageKey),i=new URLSearchParams({code_challenge:`${encodeURIComponent(t)}`,code_challenge_method:`${encodeURIComponent(e)}`});s.push(i.toString())}if(null==i?void 0:i.queryParams){const t=new URLSearchParams(i.queryParams);s.push(t.toString())}return(null==i?void 0:i.skipBrowserRedirect)&&s.push(`skip_http_redirect=${i.skipBrowserRedirect}`),`${t}?${s.join("&")}`}async _unenroll(t){try{return await this._useSession(async e=>{var i;const{data:s,error:n}=e;return n?this._returnResult({data:null,error:n}):await jd(this.fetch,"DELETE",`${this.url}/factors/${t.factorId}`,{headers:this.headers,jwt:null===(i=null==s?void 0:s.session)||void 0===i?void 0:i.access_token})})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(t){try{return await this._useSession(async e=>{var i,s;const{data:n,error:o}=e;if(o)return this._returnResult({data:null,error:o});const r=Object.assign({friendly_name:t.friendlyName,factor_type:t.factorType},"phone"===t.factorType?{phone:t.phone}:"totp"===t.factorType?{issuer:t.issuer}:{}),{data:a,error:l}=await jd(this.fetch,"POST",`${this.url}/factors`,{body:r,headers:this.headers,jwt:null===(i=null==n?void 0:n.session)||void 0===i?void 0:i.access_token});return l?this._returnResult({data:null,error:l}):("totp"===t.factorType&&"totp"===a.type&&(null===(s=null==a?void 0:a.totp)||void 0===s?void 0:s.qr_code)&&(a.totp.qr_code=`data:image/svg+xml;utf-8,${a.totp.qr_code}`),this._returnResult({data:a,error:null}))})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _verify(t){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async e=>{var i;const{data:s,error:n}=e;if(n)return this._returnResult({data:null,error:n});const o=Object.assign({challenge_id:t.challengeId},"webauthn"in t?{webauthn:Object.assign(Object.assign({},t.webauthn),{credential_response:"create"===t.webauthn.type?yu(t.webauthn.credential_response):fu(t.webauthn.credential_response)})}:{code:t.code}),{data:r,error:a}=await jd(this.fetch,"POST",`${this.url}/factors/${t.factorId}/verify`,{body:o,headers:this.headers,jwt:null===(i=null==s?void 0:s.session)||void 0===i?void 0:i.access_token});return a?this._returnResult({data:null,error:a}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+r.expires_in},r)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",r),this._returnResult({data:r,error:a}))})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(t){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async e=>{var i;const{data:s,error:n}=e;if(n)return this._returnResult({data:null,error:n});const o=await jd(this.fetch,"POST",`${this.url}/factors/${t.factorId}/challenge`,{body:t,headers:this.headers,jwt:null===(i=null==s?void 0:s.session)||void 0===i?void 0:i.access_token});if(o.error)return o;const{data:r}=o;if("webauthn"!==r.type)return{data:r,error:null};switch(r.webauthn.type){case"create":return{data:Object.assign(Object.assign({},r),{webauthn:Object.assign(Object.assign({},r.webauthn),{credential_options:Object.assign(Object.assign({},r.webauthn.credential_options),{publicKey:pu(r.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},r),{webauthn:Object.assign(Object.assign({},r.webauthn),{credential_options:Object.assign(Object.assign({},r.webauthn.credential_options),{publicKey:gu(r.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(t){const{data:e,error:i}=await this._challenge({factorId:t.factorId});return i?this._returnResult({data:null,error:i}):await this._verify({factorId:t.factorId,challengeId:e.id,code:t.code})}async _listFactors(){var t;const{data:{user:e},error:i}=await this.getUser();if(i)return{data:null,error:i};const s={all:[],phone:[],totp:[],webauthn:[]};for(const i of null!==(t=null==e?void 0:e.factors)&&void 0!==t?t:[])s.all.push(i),"verified"===i.status&&s[i.factor_type].push(i);return{data:s,error:null}}async _getAuthenticatorAssuranceLevel(t){var e,i,s,n;if(t)try{const{payload:s}=Dd(t);let n=null;s.aal&&(n=s.aal);let o=n;const{data:{user:r},error:a}=await this.getUser(t);return a?this._returnResult({data:null,error:a}):((null!==(i=null===(e=null==r?void 0:r.factors)||void 0===e?void 0:e.filter(t=>"verified"===t.status))&&void 0!==i?i:[]).length>0&&(o="aal2"),{data:{currentLevel:n,nextLevel:o,currentAuthenticationMethods:s.amr||[]},error:null})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}const{data:{session:o},error:r}=await this.getSession();if(r)return this._returnResult({data:null,error:r});if(!o)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:a}=Dd(o.access_token);let l=null;a.aal&&(l=a.aal);let h=l;return(null!==(n=null===(s=o.user.factors)||void 0===s?void 0:s.filter(t=>"verified"===t.status))&&void 0!==n?n:[]).length>0&&(h="aal2"),{data:{currentLevel:l,nextLevel:h,currentAuthenticationMethods:a.amr||[]},error:null}}async _getAuthorizationDetails(t){try{return await this._useSession(async e=>{const{data:{session:i},error:s}=e;return s?this._returnResult({data:null,error:s}):i?await jd(this.fetch,"GET",`${this.url}/oauth/authorizations/${t}`,{headers:this.headers,jwt:i.access_token,xform:t=>({data:t,error:null})}):this._returnResult({data:null,error:new ad})})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(t,e){try{return await this._useSession(async i=>{const{data:{session:s},error:n}=i;if(n)return this._returnResult({data:null,error:n});if(!s)return this._returnResult({data:null,error:new ad});const o=await jd(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"approve"},xform:t=>({data:t,error:null})});return o.data&&o.data.redirect_url&&Pd()&&!(null==e?void 0:e.skipBrowserRedirect)&&window.location.assign(o.data.redirect_url),o})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _denyAuthorization(t,e){try{return await this._useSession(async i=>{const{data:{session:s},error:n}=i;if(n)return this._returnResult({data:null,error:n});if(!s)return this._returnResult({data:null,error:new ad});const o=await jd(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"deny"},xform:t=>({data:t,error:null})});return o.data&&o.data.redirect_url&&Pd()&&!(null==e?void 0:e.skipBrowserRedirect)&&window.location.assign(o.data.redirect_url),o})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _listOAuthGrants(){try{return await this._useSession(async t=>{const{data:{session:e},error:i}=t;return i?this._returnResult({data:null,error:i}):e?await jd(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:e.access_token,xform:t=>({data:t,error:null})}):this._returnResult({data:null,error:new ad})})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async _revokeOAuthGrant(t){try{return await this._useSession(async e=>{const{data:{session:i},error:s}=e;return s?this._returnResult({data:null,error:s}):i?(await jd(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:i.access_token,query:{client_id:t.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new ad})})}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(t,e={keys:[]}){let i=e.keys.find(e=>e.kid===t);if(i)return i;const s=Date.now();if(i=this.jwks.keys.find(e=>e.kid===t),i&&this.jwks_cached_at+6e5>s)return i;const{data:n,error:o}=await jd(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return n.keys&&0!==n.keys.length?(this.jwks=n,this.jwks_cached_at=s,i=n.keys.find(e=>e.kid===t),i||null):null}async getClaims(t,e={}){try{let i=t;if(!i){const{data:t,error:e}=await this.getSession();if(e||!t.session)return this._returnResult({data:null,error:e});i=t.session.access_token}const{header:s,payload:n,signature:o,raw:{header:r,payload:a}}=Dd(i);(null==e?void 0:e.allowExpired)||function(t){if(!t)throw new Error("Missing exp claim");if(t<=Math.floor(Date.now()/1e3))throw new Error("JWT has expired")}(n.exp);const l=s.alg&&!s.alg.startsWith("HS")&&s.kid&&"crypto"in globalThis&&"subtle"in globalThis.crypto?await this.fetchJwk(s.kid,(null==e?void 0:e.keys)?{keys:e.keys}:null==e?void 0:e.jwks):null;if(!l){const{error:t}=await this.getUser(i);if(t)throw t;return{data:{claims:n,header:s,signature:o},error:null}}const h=function(t){switch(t){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}(s.alg),c=await crypto.subtle.importKey("jwk",l,h,!0,["verify"]);if(!await crypto.subtle.verify(h,c,o,function(t){const e=[];return function(t,e){for(let i=0;i<t.length;i+=1){let s=t.charCodeAt(i);if(s>55295&&s<=56319){const e=1024*(s-55296)&65535;s=65536+(t.charCodeAt(i+1)-56320&65535|e),i+=1}Ed(s,e)}}(t,t=>e.push(t)),new Uint8Array(e)}(`${r}.${a}`)))throw new md("Invalid JWT signature");return{data:{claims:n,header:s,signature:o},error:null}}catch(t){if(sd(t))return this._returnResult({data:null,error:t});throw t}}}vu.nextInstanceID={};const Pu=vu;let Cu="";Cu="undefined"!=typeof Deno?"deno":"undefined"!=typeof document?"web":"undefined"!=typeof navigator&&"ReactNative"===navigator.product?"react-native":"node";const Iu={headers:{"X-Client-Info":`supabase-js-${Cu}/2.95.3`}},Ru={schema:"public"},Mu={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Lu={};function Fu(t){return(Fu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ku(t,e,i){return(e=function(t){var e=function(t){if("object"!=Fu(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=Fu(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Fu(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Du(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,s)}return i}function Ou(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Du(Object(i),!0).forEach(function(e){ku(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Du(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}var Nu=class extends Pu{constructor(t){super(t)}},Bu=class{constructor(t,e,i){var s,n;this.supabaseUrl=t,this.supabaseKey=e;const o=function(t){const e=null==t?void 0:t.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL((i=e).endsWith("/")?i:i+"/")}catch(t){throw Error("Invalid supabaseUrl: Provided URL is malformed.")}var i}(t);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const r=`sb-${o.hostname.split(".")[0]}-auth-token`,a=function(t,e){var i,s;const{db:n,auth:o,realtime:r,global:a}=t,{db:l,auth:h,realtime:c,global:d}=e,u={db:Ou(Ou({},l),n),auth:Ou(Ou({},h),o),realtime:Ou(Ou({},c),r),storage:{},global:Ou(Ou(Ou({},d),a),{},{headers:Ou(Ou({},null!==(i=null==d?void 0:d.headers)&&void 0!==i?i:{}),null!==(s=null==a?void 0:a.headers)&&void 0!==s?s:{})}),accessToken:async()=>""};return t.accessToken?u.accessToken=t.accessToken:delete u.accessToken,u}(null!=i?i:{},{db:Ru,realtime:Lu,auth:Ou(Ou({},Mu),{},{storageKey:r}),global:Iu});var l;this.storageKey=null!==(s=a.auth.storageKey)&&void 0!==s?s:"",this.headers=null!==(n=a.global.headers)&&void 0!==n?n:{},a.accessToken?(this.accessToken=a.accessToken,this.auth=new Proxy({},{get:(t,e)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(e)} is not possible`)}})):this.auth=this._initSupabaseAuthClient(null!==(l=a.auth)&&void 0!==l?l:{},this.headers,a.global.fetch),this.fetch=((t,e,i)=>{const s=(t=>t?(...e)=>t(...e):(...t)=>fetch(...t))(i),n=Headers;return async(i,o)=>{var r;const a=null!==(r=await e())&&void 0!==r?r:t;let l=new n(null==o?void 0:o.headers);return l.has("apikey")||l.set("apikey",t),l.has("Authorization")||l.set("Authorization",`Bearer ${a}`),s(i,Ou(Ou({},o),{},{headers:l}))}})(e,this._getAccessToken.bind(this),a.global.fetch),this.realtime=this._initRealtimeClient(Ou({headers:this.headers,accessToken:this._getAccessToken.bind(this)},a.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(t=>this.realtime.setAuth(t)).catch(t=>console.warn("Failed to set initial Realtime auth token:",t)),this.rest=new Ih(new URL("rest/v1",o).href,{headers:this.headers,schema:a.db.schema,fetch:this.fetch,timeout:a.db.timeout,urlLengthLimit:a.db.urlLengthLimit}),this.storage=new Yc(this.storageUrl.href,this.headers,this.fetch,null==i?void 0:i.storage),a.accessToken||this._listenForAuthEvents()}get functions(){return new xh(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(t){return this.rest.from(t)}schema(t){return this.rest.schema(t)}rpc(t,e={},i={head:!1,get:!1,count:void 0}){return this.rest.rpc(t,e,i)}channel(t,e={config:{}}){return this.realtime.channel(t,e)}getChannels(){return this.realtime.getChannels()}removeChannel(t){return this.realtime.removeChannel(t)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var t,e,i=this;if(i.accessToken)return await i.accessToken();const{data:s}=await i.auth.getSession();return null!==(t=null===(e=s.session)||void 0===e?void 0:e.access_token)&&void 0!==t?t:i.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:t,persistSession:e,detectSessionInUrl:i,storage:s,userStorage:n,storageKey:o,flowType:r,lock:a,debug:l,throwOnError:h},c,d){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Nu({url:this.authUrl.href,headers:Ou(Ou({},u),c),storageKey:o,autoRefreshToken:t,persistSession:e,detectSessionInUrl:i,storage:s,userStorage:n,flowType:r,lock:a,debug:l,throwOnError:h,fetch:d,hasCustomAuthorizationHeader:Object.keys(this.headers).some(t=>"authorization"===t.toLowerCase())})}_initRealtimeClient(t){return new rc(this.realtimeUrl.href,Ou(Ou({},t),{},{params:Ou(Ou({},{apikey:this.supabaseKey}),null==t?void 0:t.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,e)=>{this._handleTokenChanged(t,"CLIENT",null==e?void 0:e.access_token)})}_handleTokenChanged(t,e,i){"TOKEN_REFRESHED"!==t&&"SIGNED_IN"!==t||this.changedAccessToken===i?"SIGNED_OUT"===t&&(this.realtime.setAuth(),"STORAGE"==e&&this.auth.signOut(),this.changedAccessToken=void 0):(this.changedAccessToken=i,this.realtime.setAuth(i))}};const Uu=(t,e,i)=>new Bu(t,e,i);(function(){if("undefined"!=typeof window)return!1;const t=globalThis.process;if(!t)return!1;const e=t.version;if(null==e)return!1;const i=e.match(/^v(\d+)\./);return!!i&&parseInt(i[1],10)<=18})()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");var Gu,Hu=function(t,e,i,s){return new(i||(i=Promise))(function(n,o){function r(t){try{l(s.next(t))}catch(t){o(t)}}function a(t){try{l(s.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}l((s=s.apply(t,e||[])).next())})};class Wu{constructor(t){this.connection=null,this.dataChannel=null,this.onMessageCallback=null,this.onStateChangeCallback=null,this.stats={bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},this.latencyMs=0,this.pendingPings=new Map,this.nextPingId=0,this.peerId=t}createConnection(){return new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]})}createOffer(){return Hu(this,void 0,void 0,function*(){this.connection=this.createConnection(),this.setupConnectionHandlers(),this.dataChannel=this.connection.createDataChannel("commands",{ordered:!0,maxRetransmits:3}),this.setupDataChannelHandlers();const t=yield this.connection.createOffer();return yield this.connection.setLocalDescription(t),yield this.waitForIceGathering(),this.connection.localDescription})}createAnswer(t){return Hu(this,void 0,void 0,function*(){this.connection=this.createConnection(),this.setupConnectionHandlers(),this.connection.ondatachannel=t=>{this.dataChannel=t.channel,this.setupDataChannelHandlers()},yield this.connection.setRemoteDescription(t);const e=yield this.connection.createAnswer();return yield this.connection.setLocalDescription(e),yield this.waitForIceGathering(),this.connection.localDescription})}setAnswer(t){return Hu(this,void 0,void 0,function*(){if(!this.connection)throw new Error("Connection not initialized");yield this.connection.setRemoteDescription(t)})}addIceCandidate(t){return Hu(this,void 0,void 0,function*(){if(!this.connection)throw new Error("Connection not initialized");yield this.connection.addIceCandidate(t)})}waitForIceGathering(){return new Promise(t=>{if(!this.connection)return void t();if("complete"===this.connection.iceGatheringState)return void t();const e=()=>{"complete"===this.connection.iceGatheringState&&(this.connection.removeEventListener("icegatheringstatechange",e),t())};this.connection.addEventListener("icegatheringstatechange",e),setTimeout(()=>{this.connection.removeEventListener("icegatheringstatechange",e),t()},5e3)})}setupConnectionHandlers(){this.connection&&(this.connection.onconnectionstatechange=()=>{this.connection&&(console.log(`[P2P] Connection state: ${this.connection.connectionState}`),this.onStateChangeCallback&&this.onStateChangeCallback(this.connection.connectionState))},this.connection.onicecandidate=t=>{t.candidate&&console.log("[P2P] New ICE candidate generated")})}setupDataChannelHandlers(){this.dataChannel&&(this.dataChannel.onopen=()=>{console.log(`[P2P] Data channel opened with peer: ${this.peerId}`)},this.dataChannel.onclose=()=>{console.log(`[P2P] Data channel closed with peer: ${this.peerId}`)},this.dataChannel.onerror=t=>{console.error("[P2P] Data channel error:",t)},this.dataChannel.onmessage=t=>{try{const e="string"==typeof t.data?t.data.length:t.data.byteLength;this.stats.bytesReceived+=e,this.stats.packetsReceived++;const i=JSON.parse(t.data);if("ping"===i.type)return void this.send({type:"pong",pingId:i.pingId});if("pong"===i.type){const t=this.pendingPings.get(i.pingId);return void(t&&(this.latencyMs=Date.now()-t,this.pendingPings.delete(i.pingId)))}if("command_batch"===i.type&&Array.isArray(i.commands))return void(this.onMessageCallback&&i.commands.forEach(t=>{this.onMessageCallback({type:"command",command:t})}));this.onMessageCallback&&this.onMessageCallback(i)}catch(t){console.error("[P2P] Failed to parse message:",t)}})}send(t){if(this.dataChannel&&"open"===this.dataChannel.readyState)try{const e=JSON.stringify(t);this.dataChannel.send(e),this.stats.bytesSent+=e.length,this.stats.packetsSent++}catch(t){console.error("[P2P] Failed to send message:",t)}else console.warn("[P2P] Cannot send: data channel not open")}sendRaw(t){if(this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(t),this.stats.bytesSent+=t.length,this.stats.packetsSent++}catch(t){console.error("[P2P] Failed to send message:",t)}else console.warn("[P2P] Cannot send: data channel not open")}isReady(){return null!==this.dataChannel&&"open"===this.dataChannel.readyState}onMessage(t){this.onMessageCallback=t}onStateChange(t){this.onStateChangeCallback=t}close(){this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.connection&&(this.connection.close(),this.connection=null)}getStats(){return Object.assign(Object.assign({},this.stats),{latencyMs:this.latencyMs})}sendPing(){if(!this.dataChannel||"open"!==this.dataChannel.readyState)return;const t=this.nextPingId++;this.pendingPings.set(t,Date.now()),this.send({type:"ping",pingId:t}),setTimeout(()=>{this.pendingPings.delete(t)},5e3)}getPeerId(){return this.peerId}}class $u{constructor(t,e,i,s,n){this.peers=new Map,this.commandCallback=null,this.onReadyCallback=null,this.signalingChannel=null,this.ready=!1,this.expectedPeerIds=[],this.pingInterval=null,this.PING_INTERVAL_MS=2e3,this.commandBatch=[],this.batchTimer=null,this.BATCH_INTERVAL_MS=16,this.MAX_BATCH_SIZE=50,this.supabase=t,this.matchId=e,this.localPlayerId=i,this.isHost=s,this.expectedPeerIds=n,console.log("[P2PTransport] Created",{matchId:e,localPlayerId:i,isHost:s,otherPlayers:n})}initialize(){return Hu(this,void 0,void 0,function*(){console.log("[P2PTransport] Initializing...");try{yield this.setupSignaling(),this.isHost&&(yield this.initiateConnections())}catch(t){throw console.error("[P2PTransport] Failed to initialize:",t),t}})}setupSignaling(){return Hu(this,void 0,void 0,function*(){this.signalingChannel=this.supabase.channel(`signaling:${this.matchId}`),this.signalingChannel.on("broadcast",{event:"webrtc-signal"},t=>{this.handleSignalingMessage(t.payload)}).subscribe(t=>{console.log("[P2PTransport] Signaling channel status:",t)})})}initiateConnections(){return Hu(this,void 0,void 0,function*(){console.log("[P2PTransport] Host initiating connections to:",this.expectedPeerIds);for(const t of this.expectedPeerIds)try{yield this.createOfferForPeer(t)}catch(e){console.error(`[P2PTransport] Failed to create offer for peer ${t}:`,e)}})}createOfferForPeer(t){return Hu(this,void 0,void 0,function*(){const e=new Wu(t);this.setupPeerHandlers(e),this.peers.set(t,e);const i=yield e.createOffer();yield this.sendSignalingMessage(t,"offer",i)})}handleSignalingMessage(t){return Hu(this,void 0,void 0,function*(){if(t.from!==this.localPlayerId&&(!t.to||t.to===this.localPlayerId)){console.log("[P2PTransport] Received signaling:",t.type,"from",t.from);try{switch(t.type){case"offer":yield this.handleOffer(t.from,t.data);break;case"answer":yield this.handleAnswer(t.from,t.data);break;case"ice":yield this.handleIceCandidate(t.from,t.data)}}catch(t){console.error("[P2PTransport] Error handling signaling message:",t)}}})}handleOffer(t,e){return Hu(this,void 0,void 0,function*(){let i=this.peers.get(t);i||(i=new Wu(t),this.setupPeerHandlers(i),this.peers.set(t,i));const s=yield i.createAnswer(e);yield this.sendSignalingMessage(t,"answer",s)})}handleAnswer(t,e){return Hu(this,void 0,void 0,function*(){const i=this.peers.get(t);i?yield i.setAnswer(e):console.error("[P2PTransport] No peer found for answer from",t)})}handleIceCandidate(t,e){return Hu(this,void 0,void 0,function*(){const i=this.peers.get(t);i?yield i.addIceCandidate(e):console.warn("[P2PTransport] No peer found for ICE candidate from",t)})}sendSignalingMessage(t,e,i){return Hu(this,void 0,void 0,function*(){if(!this.signalingChannel)return void console.error("[P2PTransport] Signaling channel not ready");const s={from:this.localPlayerId,to:t,type:e,data:i};yield this.signalingChannel.send({type:"broadcast",event:"webrtc-signal",payload:s}),console.log("[P2PTransport] Sent signaling:",e,"to",t)})}setupPeerHandlers(t){t.onMessage(t=>{this.commandCallback&&"command"===t.type&&this.commandCallback(t.command)}),t.onStateChange(e=>{"connected"===e?(console.log("[P2PTransport] Peer connected:",t.getPeerId()),this.checkIfReady()):"failed"!==e&&"disconnected"!==e&&"closed"!==e||(console.log("[P2PTransport] Peer disconnected:",t.getPeerId()),this.ready=!1)})}checkIfReady(){this.expectedPeerIds.every(t=>{const e=this.peers.get(t);return e&&e.isReady()})&&!this.ready&&(this.ready=!0,console.log("[P2PTransport] All peers connected! Transport ready."),this.startLatencyMeasurement(),this.onReadyCallback&&this.onReadyCallback())}startLatencyMeasurement(){this.pingInterval=setInterval(()=>{this.peers.forEach(t=>{t.isReady()&&t.sendPing()})},this.PING_INTERVAL_MS)}sendCommand(t){this.ready?(this.commandBatch.push(t),this.commandBatch.length>=this.MAX_BATCH_SIZE?this.flushCommandBatch():this.batchTimer||(this.batchTimer=setTimeout(()=>{this.flushCommandBatch()},this.BATCH_INTERVAL_MS))):console.warn("[P2PTransport] Cannot send command: not ready")}flushCommandBatch(){if(0===this.commandBatch.length)return;this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const t={type:"command_batch",commands:this.commandBatch},e=JSON.stringify(t);this.peers.forEach(t=>{t.sendRaw(e)}),this.commandBatch=[]}onCommandReceived(t){this.commandCallback=t}isReady(){return this.ready}onReady(t){this.onReadyCallback=t}disconnect(){console.log("[P2PTransport] Disconnecting..."),this.flushCommandBatch(),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.peers.forEach(t=>t.close()),this.peers.clear(),this.signalingChannel&&(this.supabase.removeChannel(this.signalingChannel),this.signalingChannel=null),this.ready=!1}getStats(){let t=0,e=0,i=0,s=0,n=0;return this.peers.forEach(o=>{const r=o.getStats();t+=r.bytesSent,e+=r.bytesReceived,i+=r.packetsSent,s+=r.packetsReceived,r.latencyMs>n&&(n=r.latencyMs)}),{connected:this.ready,latencyMs:n,packetsSent:i,packetsReceived:s,bytesOut:t,bytesIn:e}}}class Vu{constructor(t){this.commandsByTick=new Map,this.expectedPlayers=new Set,this.currentTick=0,this.COMMAND_TIMEOUT_TICKS=5,this.MAX_FUTURE_TICKS=10,this.missedCommandsCount=0,this.totalCommandsProcessed=0,this.playerIdCache=new Map,this.UNKNOWN_PLAYER_INDEX=999,this.TICK_RETENTION_WINDOW=10,this.expectedPlayers=new Set(t),t.forEach((t,e)=>{this.playerIdCache.set(t,e)})}addCommand(t){if(t.tick<this.currentTick)return console.warn(`Command for old tick ${t.tick} rejected (current: ${this.currentTick})`),!1;if(t.tick>this.currentTick+this.MAX_FUTURE_TICKS)return console.warn(`Command for tick ${t.tick} too far ahead (current: ${this.currentTick})`),!1;let e=this.commandsByTick.get(t.tick);return e||(e=[],this.commandsByTick.set(t.tick,e)),e.push(t),!0}hasAllCommandsForTick(t){const e=this.commandsByTick.get(t);if(!e)return 0===this.expectedPlayers.size;const i=new Set(e.map(t=>t.playerId));return this.expectedPlayers.size===i.size&&[...this.expectedPlayers].every(t=>i.has(t))}getNextTickCommands(){const t=this.currentTick;if(this.hasAllCommandsForTick(t))return this.consumeTickCommands(t);const e=Array.from(this.commandsByTick.keys());return e.length>0&&t-Math.min(...e)>=this.COMMAND_TIMEOUT_TICKS?(console.warn(`Command timeout at tick ${t}, proceeding with partial commands`),this.missedCommandsCount++,this.consumeTickCommands(t)):null}consumeTickCommands(t){const e=this.commandsByTick.get(t)||[];return this.commandsByTick.delete(t),this.currentTick=t+1,this.totalCommandsProcessed+=e.length,e.length>1&&e.sort((t,e)=>{var i,s;return(null!==(i=this.playerIdCache.get(t.playerId))&&void 0!==i?i:this.UNKNOWN_PLAYER_INDEX)-(null!==(s=this.playerIdCache.get(e.playerId))&&void 0!==s?s:this.UNKNOWN_PLAYER_INDEX)}),t%100==0&&this.cleanupOldTicks(t),e}cleanupOldTicks(t){const e=t-this.TICK_RETENTION_WINDOW;for(const t of this.commandsByTick.keys())t<e&&this.commandsByTick.delete(t)}getCurrentTick(){return this.currentTick}getStats(){return{currentTick:this.currentTick,queuedTicks:this.commandsByTick.size,missedCommands:this.missedCommandsCount,totalProcessed:this.totalCommandsProcessed,expectedPlayers:this.expectedPlayers.size}}clear(){this.commandsByTick.clear(),this.currentTick=0}setExpectedPlayers(t){this.expectedPlayers=new Set(t),this.playerIdCache.clear(),t.forEach((t,e)=>{this.playerIdCache.set(t,e)})}}class zu{constructor(){this.MAX_PAYLOAD_SIZE=1024,this.commandCounts=new Map,this.COMMANDS_PER_TICK_LIMIT=100,this.lastCleanupTick=0,this.CLEANUP_INTERVAL=100}validate(t){if("number"!=typeof t.tick||"string"!=typeof t.playerId||"string"!=typeof t.commandType)return console.error("Invalid command structure:",t),!1;if(t.tick<0)return console.error("Invalid tick (negative):",t.tick),!1;if(t.payload){const e=JSON.stringify(t.payload);if(e.length>this.MAX_PAYLOAD_SIZE)return console.error(`Payload too large: ${e.length} bytes`),!1}const e=`${t.playerId}-${t.tick}`,i=this.commandCounts.get(e)||0;return i>=this.COMMANDS_PER_TICK_LIMIT?(console.error(`Rate limit exceeded for player ${t.playerId} at tick ${t.tick}`),!1):(this.commandCounts.set(e,i+1),t.tick-this.lastCleanupTick>=this.CLEANUP_INTERVAL&&this.cleanupOldEntries(t.tick),!0)}cleanupOldEntries(t){const e=t-this.CLEANUP_INTERVAL;for(const[t]of this.commandCounts)parseInt(t.split("-")[1])<e&&this.commandCounts.delete(t);this.lastCleanupTick=t}verifySignature(t,e){return!0}verifyLegality(t,e){return!0}}!function(t){t.DESYNC="desync",t.HASH_VERIFIED="hash_verified"}(Gu||(Gu={}));class ju{constructor(t,e,i){this.receivedHashes=new Map,this.localHashes=new Map,this.eventListeners=new Map,this.HASH_TIMEOUT_TICKS=10,this.MAX_STORED_TICKS=100,this.stats={hashesExchanged:0,desyncsDetected:0,lastVerifiedTick:0},this.transport=t,this.localPlayerId=e,this.expectedPlayers=new Set(i)}submitHash(t,e){this.localHashes.set(t,e);const i={type:"state_hash",tick:t,playerId:this.localPlayerId,hash:e};this.transport.sendCommand({tick:t,playerId:this.localPlayerId,commandType:"__state_hash__",payload:i}),this.stats.hashesExchanged++,this.checkTick(t),this.cleanupOldHashes(t)}receiveHash(t,e,i){this.receivedHashes.has(t)||this.receivedHashes.set(t,new Map),this.receivedHashes.get(t).set(e,i),this.checkTick(t)}checkTick(t){const e=this.localHashes.get(t);if(void 0===e)return;const i=this.receivedHashes.get(t);if(!i)return;const s=new Set(i.keys());[...this.expectedPlayers].filter(t=>t!==this.localPlayerId&&!s.has(t)).length>0||this.verifyTick(t,e,i)}verifyTick(t,e,i){const s=[];for(const[t,n]of i)n!==e&&s.push(t);if(s.length>0){console.error(`[StateVerifier] DESYNC detected at tick ${t}!`),console.error(`  Local hash (${this.localPlayerId}): ${e}`);for(const[t,e]of i)console.error(`  Remote hash (${t}): ${e}`);this.stats.desyncsDetected++;const n={tick:t,localHash:e,remoteHashes:new Map(i),mismatchedPlayers:s};this.emit(Gu.DESYNC,n)}else this.stats.lastVerifiedTick=t,this.emit(Gu.HASH_VERIFIED,{tick:t,hash:e})}cleanupOldHashes(t){const e=t-this.MAX_STORED_TICKS;for(const t of this.localHashes.keys())t<e&&this.localHashes.delete(t);for(const t of this.receivedHashes.keys())t<e&&this.receivedHashes.delete(t)}getStats(){return Object.assign({},this.stats)}on(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}off(t,e){const i=this.eventListeners.get(t);if(i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}emit(t,e){const i=this.eventListeners.get(t);i&&i.forEach(t=>{try{t(e)}catch(t){console.error("[StateVerifier] Error in event listener:",t)}})}}var Ku,Yu=function(t,e,i,s){return new(i||(i=Promise))(function(n,o){function r(t){try{l(s.next(t))}catch(t){o(t)}}function a(t){try{l(s.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}l((s=s.apply(t,e||[])).next())})};!function(t){t.MATCH_CREATED="match_created",t.PLAYER_JOINED="player_joined",t.PLAYER_LEFT="player_left",t.CONNECTING="connecting",t.CONNECTED="connected",t.DISCONNECTED="disconnected",t.MATCH_STARTED="match_started",t.MATCH_ENDED="match_ended",t.COMMAND_RECEIVED="command_received",t.DESYNC_DETECTED="desync_detected",t.ERROR="error"}(Ku||(Ku={}));class Xu{constructor(t,e,i){this.currentMatch=null,this.isHost=!1,this.transport=null,this.commandQueue=null,this.commandValidator=new zu,this.stateVerifier=null,this.gameRNG=null,this.eventListeners=new Map,this.isActive=!1,this.currentTick=0,this.isTransportReady=!1,this.playerListenerChannel=null,this.connectionTimeout=null,this.CONNECTION_TIMEOUT_MS=3e4,this.pendingCommands=[],this.supabase=Uu(t,e),this.localPlayerId=i,console.log("[MultiplayerNetworkManager] Initialized",{playerId:i})}createMatch(t){return Yu(this,void 0,void 0,function*(){try{console.log("[MultiplayerNetworkManager] Creating match...",t),this.isHost=!0;const e=t.gameSeed||Qa(),{data:i,error:s}=yield this.supabase.from("matches").insert([{status:"open",host_player_id:this.localPlayerId,game_seed:e,tick_rate:t.tickRate||30,lockstep_enabled:t.lockstepEnabled||!1,max_players:t.maxPlayers||2,match_name:t.matchName,game_settings:t.gameSettings||{}}]).select().single();if(s){console.error("[MultiplayerNetworkManager] Failed to create match:",s);const t="Failed to create match. Please check your connection and try again.";return this.emit(Ku.ERROR,{error:s,message:t}),null}this.currentMatch=i;const{error:n}=yield this.supabase.from("match_players").insert([{match_id:i.id,player_id:this.localPlayerId,role:"host",connected:!1,username:t.username}]);if(n){console.error("[MultiplayerNetworkManager] Failed to add host player:",n);const t="Failed to join match as host. Please try again.";return this.emit(Ku.ERROR,{error:n,message:t}),null}return this.gameRNG=new Ya(e),qa(this.gameRNG),console.log("[MultiplayerNetworkManager] Match created:",i.id,"seed:",e),this.emit(Ku.MATCH_CREATED,{match:i}),this.startListeningForPlayers(),i}catch(t){console.error("[MultiplayerNetworkManager] Error creating match:",t);const e="An unexpected error occurred while creating the match.";return this.emit(Ku.ERROR,{error:t,message:e}),null}})}listMatches(){return Yu(this,void 0,void 0,function*(){const{data:t,error:e}=yield this.supabase.from("matches").select("*").eq("status","open").order("created_at",{ascending:!1}).limit(20);return e?(console.error("[MultiplayerNetworkManager] Failed to list matches:",e),[]):t||[]})}joinMatch(t,e){return Yu(this,void 0,void 0,function*(){try{console.log("[MultiplayerNetworkManager] Joining match:",t);const{data:i,error:s}=yield this.supabase.from("matches").select("*").eq("id",t).single();if(s||!i){console.error("[MultiplayerNetworkManager] Match not found:",s);const t="Match not found. The match code may be incorrect or expired.";return this.emit(Ku.ERROR,{error:"Match not found",message:t}),!1}if("open"!==i.status){console.error("[MultiplayerNetworkManager] Match not open for joining");const t="Match is not accepting new players. It may have already started.";return this.emit(Ku.ERROR,{error:"Match not open",message:t}),!1}const{data:n,error:o}=yield this.supabase.from("match_players").select("*").eq("match_id",t);if(o||!n)return console.error("[MultiplayerNetworkManager] Failed to get players:",o),!1;if(n.length>=i.max_players){console.error("[MultiplayerNetworkManager] Match is full");const t=`Match is full (${i.max_players}/${i.max_players} players).`;return this.emit(Ku.ERROR,{error:"Match is full",message:t}),!1}this.currentMatch=i,this.isHost=!1;const{error:r}=yield this.supabase.from("match_players").insert([{match_id:t,player_id:this.localPlayerId,role:"client",connected:!1,username:e}]);if(r){console.error("[MultiplayerNetworkManager] Failed to join match:",r);const t="Failed to join match. Please try again.";return this.emit(Ku.ERROR,{error:r,message:t}),!1}return this.gameRNG=new Ya(i.game_seed),qa(this.gameRNG),console.log("[MultiplayerNetworkManager] Joined match:",t),this.emit(Ku.PLAYER_JOINED,{matchId:t,playerId:this.localPlayerId}),!0}catch(t){console.error("[MultiplayerNetworkManager] Error joining match:",t);const e="An unexpected error occurred while joining the match.";return this.emit(Ku.ERROR,{error:t,message:e}),!1}})}startListeningForPlayers(){this.isHost&&this.currentMatch&&(this.stopListeningForPlayers(),this.playerListenerChannel=this.supabase.channel(`match:${this.currentMatch.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"match_players",filter:`match_id=eq.${this.currentMatch.id}`},t=>{console.log("[MultiplayerNetworkManager] Player joined:",t.new),this.emit(Ku.PLAYER_JOINED,t.new)}).subscribe())}stopListeningForPlayers(){this.playerListenerChannel&&(this.supabase.removeChannel(this.playerListenerChannel),this.playerListenerChannel=null)}startMatch(){return Yu(this,void 0,void 0,function*(){if(!this.currentMatch)return console.error("[MultiplayerNetworkManager] No active match"),!1;try{console.log("[MultiplayerNetworkManager] Starting match...");const{data:t,error:e}=yield this.supabase.from("match_players").select("*").eq("match_id",this.currentMatch.id);if(e||!t)return console.error("[MultiplayerNetworkManager] Failed to get players:",e),!1;this.isHost&&(yield this.supabase.from("matches").update({status:"connecting"}).eq("id",this.currentMatch.id)),this.emit(Ku.CONNECTING);const i=t.filter(t=>t.player_id!==this.localPlayerId).map(t=>t.player_id),s=t.map(t=>t.player_id);return this.commandQueue=new Vu(s),this.transport=new $u(this.supabase,this.currentMatch.id,this.localPlayerId,this.isHost,i),this.transport.onCommandReceived(t=>{this.handleReceivedCommand(t)}),yield this.transport.initialize(),this.connectionTimeout=setTimeout(()=>{if(!this.isTransportReady){console.error("[MultiplayerNetworkManager] Connection timeout - failed to establish connections");const t="Connection timeout. Unable to establish P2P connections. Please check your network and try again.";this.emit(Ku.ERROR,{error:new Error("Connection timeout - failed to establish P2P connections"),message:t}),this.endMatch("connection_timeout")}},this.CONNECTION_TIMEOUT_MS),this.transport.onReady(()=>{this.onTransportReady()}),this.currentMatch.lockstep_enabled&&(this.stateVerifier=new ju(this.transport,this.localPlayerId,s),this.stateVerifier.on(Gu.DESYNC,t=>{console.error("[MultiplayerNetworkManager] Desync detected!",t),this.emit(Ku.DESYNC_DETECTED,t)}),console.log("[MultiplayerNetworkManager] State verification enabled")),!0}catch(t){console.error("[MultiplayerNetworkManager] Error starting match:",t);const e="Failed to start match. Please try again.";return this.emit(Ku.ERROR,{error:t,message:e}),!1}})}onTransportReady(){return Yu(this,void 0,void 0,function*(){var t,e;if(this.isTransportReady)console.warn("[MultiplayerNetworkManager] Transport already ready, ignoring duplicate call");else{if(console.log("[MultiplayerNetworkManager] Transport ready!"),this.isTransportReady=!0,this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.isHost&&this.currentMatch&&(yield this.supabase.from("matches").update({status:"active"}).eq("id",this.currentMatch.id)),this.pendingCommands.length>0){console.log(`[MultiplayerNetworkManager] Flushing ${this.pendingCommands.length} pending commands`);for(const t of this.pendingCommands)this.commandQueue&&this.commandQueue.addCommand(t),this.transport&&this.transport.sendCommand(t);this.pendingCommands=[]}this.isActive=!0,this.emit(Ku.CONNECTED),this.emit(Ku.MATCH_STARTED,{matchId:null===(t=this.currentMatch)||void 0===t?void 0:t.id,seed:null===(e=this.currentMatch)||void 0===e?void 0:e.game_seed})}})}handleReceivedCommand(t){if("__state_hash__"===t.commandType&&this.stateVerifier){const e=t.payload;return void this.stateVerifier.receiveHash(e.tick,e.playerId,e.hash)}this.commandValidator.validate(t)?(this.commandQueue&&this.commandQueue.addCommand(t),this.emit(Ku.COMMAND_RECEIVED,{command:t})):console.error("[MultiplayerNetworkManager] Invalid command received:",t)}sendCommand(t,e){const i={tick:this.currentTick,playerId:this.localPlayerId,commandType:t,payload:e};if(this.commandValidator.validate(i)){if(!this.transport||!this.transport.isReady())return console.warn("[MultiplayerNetworkManager] Transport not ready, queuing command"),void this.pendingCommands.push(i);this.commandQueue&&this.commandQueue.addCommand(i),this.transport.sendCommand(i)}else console.error("[MultiplayerNetworkManager] Cannot send invalid command:",i)}getNextTickCommands(){return this.commandQueue?this.commandQueue.getNextTickCommands():[]}advanceTick(){this.currentTick++}submitStateHash(t){this.stateVerifier&&this.stateVerifier.submitHash(this.currentTick,t)}getStateVerificationStats(){var t;return(null===(t=this.stateVerifier)||void 0===t?void 0:t.getStats())||null}endMatch(t){return Yu(this,void 0,void 0,function*(){console.log("[MultiplayerNetworkManager] Ending match...",t),this.isActive=!1,this.isTransportReady=!1,this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null),this.pendingCommands=[],this.stopListeningForPlayers(),this.currentMatch&&this.isHost&&(yield this.supabase.from("matches").update({status:"ended"}).eq("id",this.currentMatch.id)),this.transport&&(this.transport.disconnect(),this.transport=null),this.commandQueue&&(this.commandQueue.clear(),this.commandQueue=null),this.stateVerifier=null,this.emit(Ku.MATCH_ENDED,{reason:t})})}disconnect(){return Yu(this,void 0,void 0,function*(){yield this.endMatch("player_disconnect")})}getCurrentMatch(){return this.currentMatch}isInMatch(){return this.isActive}getGameSeed(){var t;return(null===(t=this.currentMatch)||void 0===t?void 0:t.game_seed)||null}getCurrentTick(){return this.currentTick}getQueueStats(){var t;return(null===(t=this.commandQueue)||void 0===t?void 0:t.getStats())||null}getNetworkStats(){var t,e;return(null===(e=null===(t=this.transport)||void 0===t?void 0:t.getStats)||void 0===e?void 0:e.call(t))||null}on(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}off(t,e){const i=this.eventListeners.get(t);if(i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}emit(t,e){const i=this.eventListeners.get(t);i&&i.forEach(t=>{try{t(e)}catch(t){console.error("[MultiplayerNetworkManager] Error in event listener:",t)}})}}function qu(){const t=("undefined"!=typeof process&&process.env,""),e=("undefined"!=typeof process&&process.env,"");return t&&e||(console.warn("Supabase credentials not configured. Online play will not be available."),console.warn("Set SUPABASE_URL and SUPABASE_ANON_KEY environment variables.")),{url:t,anonKey:e}}var Ju=function(t,e,i,s){return new(i||(i=Promise))(function(n,o){function r(t){try{l(s.next(t))}catch(t){o(t)}}function a(t){try{l(s.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}l((s=s.apply(t,e||[])).next())})};const Qu="sol-lan-lobbies";class Zu{constructor(){this.backgroundParticleLayer=null,this.atmosphereLayer=null,this.menuParticleLayer=null,this.resizeHandler=null,this.onStartCallback=null,this.currentScreen="main",this.carouselMenu=null,this.factionCarousel=null,this.testLevelButton=null,this.ladButton=null,this.lanServerListTimeout=null,this.lanLobbyHeartbeatTimeout=null,this.networkManager=null,this.multiplayerNetworkManager=null,this.p2pMatchPlayers=[],this.p2pMatchName="",this.p2pMaxPlayers=2,this.mainScreenRenderToken=0,this.onlineMode="ranked",this.visibilityHandler=null,this.heroUnits=[{id:"radiant-marine",name:"Marine",description:"Rapid-fire ranged specialist",faction:Za.RADIANT,maxHealth:ee,attackDamage:se,attackSpeed:ne,attackRange:ie,attackIgnoresDefense:!1,defense:10,regen:4,abilityDescription:"Bullet storm: fires a spread of shots toward a target direction"},{id:"velaris-grave",name:"Grave",description:"Gravitic sentinel with orbiting projectiles",faction:Za.VELARIS,maxHealth:oe,attackDamage:le,attackSpeed:he,attackRange:re*ae,attackIgnoresDefense:!1,defense:18,regen:3,abilityDescription:"Black Hole: launches a vortex that attracts all small particles for 5 seconds"},{id:"velaris-nova",name:"Nova",description:"Remote bomb specialist with bouncing projectile",faction:Za.VELARIS,maxHealth:oa,attackDamage:aa,attackSpeed:la,attackRange:ra,attackIgnoresDefense:!1,defense:10,regen:5,abilityDescription:"Remote bomb: throws a bouncing bomb that explodes in a directional scatter when triggered"},{id:"velaris-sly",name:"Sly",description:"Sticky laser bomb specialist",faction:Za.VELARIS,maxHealth:Ea,attackDamage:va,attackSpeed:Pa,attackRange:ba,attackIgnoresDefense:!1,defense:8,regen:4,abilityDescription:"Sticky bomb: throws a bomb that sticks to surfaces and fires 3 lasers (1 wide center, 2 diagonal)"},{id:"radiant-ray",name:"Ray",description:"Bouncing beam marks targets",faction:Za.RADIANT,maxHealth:io,attackDamage:no,attackSpeed:oo,attackRange:so,attackIgnoresDefense:!0,defense:8,regen:5,abilityDescription:"Solar ricochet: beam bounces between multiple enemies"},{id:"radiant-influence-ball",name:"Influence Ball",description:"Deploys temporary influence zones",faction:Za.RADIANT,maxHealth:co,attackDamage:po,attackSpeed:go,attackRange:uo,attackIgnoresDefense:!1,defense:12,regen:6,abilityDescription:"Influence surge: expand an influence zone at target location"},{id:"radiant-turret-deployer",name:"Turret Deployer",description:"Deploys automated turrets on asteroids",faction:Za.RADIANT,maxHealth:So,attackDamage:To,attackSpeed:_o,attackRange:Ao,attackIgnoresDefense:!1,defense:14,regen:4,abilityDescription:"Deploy turret: places a turret on a nearby asteroid"},{id:"radiant-driller",name:"Driller",description:"Burrows through asteroids to flank",faction:Za.RADIANT,maxHealth:Fo,attackDamage:Do,attackSpeed:Oo,attackRange:ko,attackIgnoresDefense:!1,defense:16,regen:3,abilityDescription:"Drill charge: tunnels through an asteroid toward the target"},{id:"radiant-dagger",name:"Dagger",description:"Cloaked assassin with burst damage",faction:Za.RADIANT,maxHealth:Wo,attackDamage:Vo,attackSpeed:zo,attackRange:$o,attackIgnoresDefense:!1,defense:5,regen:3,abilityDescription:"Shadow strike: short-range burst attack, reveals Dagger for 8 seconds"},{id:"radiant-beam",name:"Beam",description:"Sniper with distance-based damage multiplier",faction:Za.RADIANT,maxHealth:Jo,attackDamage:Zo,attackSpeed:tr,attackRange:Qo,attackIgnoresDefense:!0,defense:6,regen:3,abilityDescription:"Precision shot: long-range beam that does more damage at greater distances"},{id:"radiant-spotlight",name:"Spotlight",description:"Reveals enemies in a razor-thin cone",faction:Za.RADIANT,maxHealth:or,attackDamage:ar,attackSpeed:0,attackRange:rr,attackIgnoresDefense:!1,defense:8,regen:4,abilityDescription:"Spotlight sweep: 5 cone reveals and rapidly fires at enemies (1s setup, 5s teardown)"},{id:"radiant-mortar",name:"Mortar",description:"Siege unit with splash damage",faction:Za.RADIANT,maxHealth:Tr,attackDamage:wr,attackSpeed:Er,attackRange:_r,attackIgnoresDefense:!1,defense:14,regen:2,abilityDescription:"Siege mode: temporarily becomes immobile but gains increased range and damage"},{id:"radiant-preist",name:"Preist",description:"Support healer with dual beams",faction:Za.RADIANT,maxHealth:Rr,attackDamage:0,attackSpeed:0,attackRange:Dr,attackIgnoresDefense:!1,defense:18,regen:4,abilityDescription:"Healing bomb: launches a projectile that explodes into healing particles"},{id:"radiant-tank",name:"Tank",description:"Extremely tough defensive unit with projectile shield",faction:Za.RADIANT,maxHealth:jr,attackDamage:0,attackSpeed:0,attackRange:0,attackIgnoresDefense:!1,defense:qr,regen:3,abilityDescription:"Crescent wave: sends a slow 90-degree wave that stuns all units and erases projectiles"}],this.availableMaps=[{id:"standard",name:"Standard Battle",description:"Classic 1v1 map with a single sun at the center. Balanced gameplay with moderate obstacles.",numSuns:1,numAsteroids:10,mapSize:2e3},{id:"test-level",name:"Test Level",description:"Minimal layout for AI testing with a single sun, mirrored bases, and no asteroids.",numSuns:1,numAsteroids:0,mapSize:2e3},{id:"twin-suns",name:"Twin Suns",description:"Two suns create complex lighting patterns. Control multiple light sources for economic dominance.",numSuns:2,numAsteroids:12,mapSize:2500},{id:"asteroid-field",name:"Asteroid Field",description:"Dense asteroid field creates tactical challenges. Careful mirror placement is crucial.",numSuns:1,numAsteroids:20,mapSize:2e3},{id:"open-space",name:"Open Space",description:"Minimal obstacles in a vast arena. Pure strategic combat with fewer terrain advantages.",numSuns:1,numAsteroids:5,mapSize:3e3},{id:"lad",name:"LaD",description:'Light and Dark - A split battlefield with a dual sun. White light on one side, black "light" on the other. Units are invisible until they cross into enemy territory.',numSuns:1,numAsteroids:8,mapSize:2e3}],this.baseLoadouts=[{id:"radiant-standard",name:"Standard Forge",description:"Balanced base with standard production",faction:Za.RADIANT},{id:"aurum-standard",name:"Standard Vault",description:"Balanced base with standard production",faction:Za.AURUM},{id:"velaris-standard",name:"Standard Temple",description:"Balanced base with standard production",faction:Za.VELARIS}],this.spawnLoadouts=[{id:"radiant-standard",name:"Standard Starlings",description:"Balanced minions with standard stats",faction:Za.RADIANT},{id:"aurum-standard",name:"Standard Drones",description:"Balanced minions with standard stats",faction:Za.AURUM},{id:"velaris-standard",name:"Standard Zealots",description:"Balanced minions with standard stats",faction:Za.VELARIS}],this.settings={selectedMap:this.availableMaps[0],difficulty:"normal",soundEnabled:!0,musicEnabled:!0,isBattleStatsInfoEnabled:!1,screenShakeEnabled:!0,selectedFaction:Za.RADIANT,selectedHeroes:["radiant-marine"],selectedHeroNames:[],playerColor:"#66B3FF",enemyColor:"#FF6B6B",selectedBaseLoadout:null,selectedSpawnLoadout:null,colorScheme:"SpaceBlack",damageDisplayMode:"damage",healthDisplayMode:"bar",graphicsQuality:"high",username:this.getOrGenerateUsername(),gameMode:"ai"},this.ensureDefaultHeroSelection(),this.menuElement=this.createMenuElement(),document.body.appendChild(this.menuElement),this.visibilityHandler=()=>{document.hidden?this.pauseMenuAnimations():this.resumeMenuAnimations()},document.addEventListener("visibilitychange",this.visibilityHandler)}createMenuElement(){const t=document.createElement("div");t.id="mainMenu",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.boxSizing="border-box",t.style.backgroundColor="transparent",t.style.zIndex="1000",t.style.fontFamily='"Doto", Arial, sans-serif',t.style.fontWeight="300",t.style.fontSize="24px",t.style.color="#FFFFFF",t.style.overflowY="auto",t.style.overflowX="hidden",t.style.isolation="isolate";const e=document.createElement("div");return e.style.position="relative",e.style.zIndex="1",e.style.width="100%",e.style.minHeight="100%",e.style.padding="24px 16px",e.style.boxSizing="border-box",e.style.display="flex",e.style.flexDirection="column",e.style.justifyContent="center",e.style.alignItems="center",t.appendChild(e),this.contentElement=e,this.backgroundParticleLayer=new lh(t),this.atmosphereLayer=new hh(t,this.resolveAssetPath("ASSETS/sprites/environment/centralSun.svg")),this.menuParticleLayer=new ch(t),this.menuParticleLayer.setMenuContentElement(e),t.appendChild(this.createBuildNumberLabel()),this.testLevelButton=this.createTestLevelButton(),t.appendChild(this.testLevelButton),this.ladButton=this.createLadButton(),t.appendChild(this.ladButton),this.renderMainScreenContent(e),this.resizeHandler=()=>{var t,e;null===(t=this.backgroundParticleLayer)||void 0===t||t.resize(),null===(e=this.atmosphereLayer)||void 0===e||e.resize(),this.menuParticleLayer&&(this.menuParticleLayer.resize(),this.menuParticleLayer.requestTargetRefresh(this.contentElement))},window.addEventListener("resize",this.resizeHandler),t.addEventListener("scroll",()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),t}pauseMenuAnimations(){var t,e,i,s,n;null===(t=this.backgroundParticleLayer)||void 0===t||t.stop(),null===(e=this.atmosphereLayer)||void 0===e||e.stop(),null===(i=this.menuParticleLayer)||void 0===i||i.stop(),null===(s=this.carouselMenu)||void 0===s||s.pauseAnimation(),null===(n=this.factionCarousel)||void 0===n||n.pauseAnimation()}resumeMenuAnimations(){var t,e,i,s,n,o;"none"!==this.menuElement.style.display&&(null===(t=this.backgroundParticleLayer)||void 0===t||t.start(),null===(e=this.atmosphereLayer)||void 0===e||e.start(),null===(i=this.menuParticleLayer)||void 0===i||i.start(),null===(s=this.menuParticleLayer)||void 0===s||s.requestTargetRefresh(this.contentElement),null===(n=this.carouselMenu)||void 0===n||n.resumeAnimation(),null===(o=this.factionCarousel)||void 0===o||o.resumeAnimation())}createBuildNumberLabel(){const t=document.createElement("div");return t.textContent="BUILD 57",t.style.position="absolute",t.style.top="16px",t.style.left="16px",t.style.padding="6px 10px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.4)",t.style.backgroundColor="rgba(10, 10, 10, 0.6)",t.style.color="#FFFFFF",t.style.fontFamily='"Doto", Arial, sans-serif',t.style.fontWeight="500",t.style.fontSize="12px",t.style.letterSpacing="0.18em",t.style.textTransform="uppercase",t.style.zIndex="2",t.style.pointerEvents="none",t}createTestLevelButton(){const t=document.createElement("button");return t.textContent="TEST LEVEL",t.type="button",t.style.position="absolute",t.style.top="20px",t.style.right="20px",t.style.padding="10px 16px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.6)",t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.color="#FFFFFF",t.style.fontFamily="Arial, sans-serif",t.style.fontWeight="500",t.style.fontSize="14px",t.style.letterSpacing="0.08em",t.style.cursor="pointer",t.style.zIndex="2",t.style.transition="background-color 0.2s ease, border-color 0.2s ease",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="rgba(60, 60, 60, 0.85)",t.style.borderColor="#FFD700"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.borderColor="rgba(255, 255, 255, 0.6)"}),t.addEventListener("click",()=>{const t=this.availableMaps.find(t=>"test-level"===t.id);t&&(this.settings.selectedMap=t,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings)))}),t}createLadButton(){const t=document.createElement("button");return t.textContent="LaD",t.type="button",t.style.position="absolute",t.style.top="20px",t.style.right="140px",t.style.padding="10px 16px",t.style.borderRadius="6px",t.style.border="1px solid rgba(255, 255, 255, 0.6)",t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.color="#FFFFFF",t.style.fontFamily="Arial, sans-serif",t.style.fontWeight="500",t.style.fontSize="14px",t.style.letterSpacing="0.08em",t.style.cursor="pointer",t.style.zIndex="2",t.style.transition="background-color 0.2s ease, border-color 0.2s ease",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="rgba(60, 60, 60, 0.85)",t.style.borderColor="#FFD700"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="rgba(20, 20, 20, 0.7)",t.style.borderColor="rgba(255, 255, 255, 0.6)"}),t.addEventListener("click",()=>{const t=this.availableMaps.find(t=>"lad"===t.id);t&&(this.settings.selectedMap=t,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings)))}),t}setTestLevelButtonVisible(t){this.testLevelButton&&(this.testLevelButton.style.display=t?"block":"none")}setLadButtonVisible(t){this.ladButton&&(this.ladButton.style.display=t?"block":"none")}getSelectedHeroNames(){return this.heroUnits.filter(t=>this.settings.selectedHeroes.includes(t.id)).map(t=>t.name)}getDefaultHeroIdsForFaction(t){if(!t)return[];const e=this.heroUnits.find(e=>e.faction===t);return e?[e.id]:[]}getFactionLabelAndColor(t){switch(t){case Za.RADIANT:return{label:"Radiant",color:"#FF5722"};case Za.AURUM:return{label:"Aurum",color:"#FFD700"};case Za.VELARIS:return{label:"Velaris",color:"#9C27B0"};default:return{label:"Unselected",color:"#999999"}}}ensureDefaultHeroSelection(){if(0===this.settings.selectedHeroes.length){const t=this.getDefaultHeroIdsForFaction(this.settings.selectedFaction);t.length>0&&(this.settings.selectedHeroes=[...t])}this.settings.selectedHeroNames=this.getSelectedHeroNames()}generateRandomUsername(){return`player#${Math.floor(1e4*Math.random()).toString().padStart(4,"0")}`}getOrGenerateUsername(){const t=localStorage.getItem("sol_username");if(t&&""!==t.trim())return t;const e=this.generateRandomUsername();return localStorage.setItem("sol_username",e),e}saveUsername(t){localStorage.setItem("sol_username",t),this.settings.username=t}clearPlayerDataAndCache(){return Ju(this,void 0,void 0,function*(){if(localStorage.clear(),sessionStorage.clear(),"undefined"!=typeof caches){const t=yield caches.keys();yield Promise.all(t.map(t=>caches.delete(t)))}const t=indexedDB;if(t.databases){const e=yield t.databases();yield Promise.all(e.map(t=>{const e=t.name;return e?new Promise(t=>{const i=indexedDB.deleteDatabase(e);i.addEventListener("success",()=>t()),i.addEventListener("error",()=>t()),i.addEventListener("blocked",()=>t())}):Promise.resolve()}))}})}resolveAssetPath(t){return t.startsWith("ASSETS/")&&window.location.pathname.includes("/dist/")?`../${t}`:t}clearMenu(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.factionCarousel&&(this.factionCarousel.destroy(),this.factionCarousel=null),this.contentElement&&(this.contentElement.innerHTML="",this.contentElement.style.justifyContent="center"),null!==this.lanServerListTimeout&&(clearTimeout(this.lanServerListTimeout),this.lanServerListTimeout=null),null!==this.lanLobbyHeartbeatTimeout&&(clearTimeout(this.lanLobbyHeartbeatTimeout),this.lanLobbyHeartbeatTimeout=null),this.setTestLevelButtonVisible(!1),this.setLadButtonVisible(!1)}setMenuParticleDensity(t){var e;const i=Math.SQRT2;null===(e=this.menuParticleLayer)||void 0===e||e.setDensityMultiplier(t*i)}startMenuTransition(){var t;null===(t=this.menuParticleLayer)||void 0===t||t.startTransition()}loadLanLobbyEntries(){const t=localStorage.getItem(Qu);if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.warn("Failed to parse LAN lobby list from storage:",t),[]}}persistLanLobbyEntries(t){localStorage.setItem(Qu,JSON.stringify(t))}pruneLanLobbyEntries(t,e){const i=t.filter(t=>e-t.lastSeenMs<=15e3);return i.length!==t.length&&this.persistLanLobbyEntries(i),i}registerLanLobbyEntry(t){var e;const i=Date.now(),s=this.loadLanLobbyEntries(),n=s.filter(e=>e.hostPlayerId!==t.hostPlayerId),o=s.find(e=>e.hostPlayerId===t.hostPlayerId);n.push(Object.assign(Object.assign({},t),{createdMs:null!==(e=null==o?void 0:o.createdMs)&&void 0!==e?e:i,lastSeenMs:i})),this.persistLanLobbyEntries(n)}unregisterLanLobbyEntry(t){const e=this.loadLanLobbyEntries(),i=e.filter(e=>e.hostPlayerId!==t);i.length!==e.length&&this.persistLanLobbyEntries(i)}startLanLobbyHeartbeat(t){null!==this.lanLobbyHeartbeatTimeout&&(clearTimeout(this.lanLobbyHeartbeatTimeout),this.lanLobbyHeartbeatTimeout=null);const e=()=>{this.registerLanLobbyEntry(t),this.lanLobbyHeartbeatTimeout=window.setTimeout(e,5e3)};e()}stopLanLobbyHeartbeat(){null!==this.lanLobbyHeartbeatTimeout&&(clearTimeout(this.lanLobbyHeartbeatTimeout),this.lanLobbyHeartbeatTimeout=null)}renderLanLobbyList(t){t.innerHTML="";const e=Date.now(),i=this.pruneLanLobbyEntries(this.loadLanLobbyEntries(),e).sort((t,e)=>e.lastSeenMs-t.lastSeenMs);if(0===i.length){const e=document.createElement("p");return e.textContent="No LAN lobbies detected yet. Host a game to make it appear here.",e.style.color="#888888",e.style.fontSize="16px",e.style.textAlign="center",e.style.margin="0",void t.appendChild(e)}for(const e of i){const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="row",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.gap="16px",i.style.padding="14px 18px",i.style.borderRadius="8px",i.style.backgroundColor="rgba(0, 0, 0, 0.4)",i.style.border="1px solid rgba(255, 215, 0, 0.3)",i.style.cursor="pointer",i.style.transition="transform 0.15s ease, border-color 0.15s ease",i.addEventListener("mouseenter",()=>{i.style.transform="translateY(-2px)",i.style.borderColor="rgba(255, 215, 0, 0.6)"}),i.addEventListener("mouseleave",()=>{i.style.transform="translateY(0)",i.style.borderColor="rgba(255, 215, 0, 0.3)"});const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.gap="4px",s.style.flex="1";const n=document.createElement("div");n.textContent=e.lobbyName,n.style.color="#FFD700",n.style.fontSize="18px",n.style.fontWeight="600",s.appendChild(n);const o=document.createElement("div");o.textContent=`${e.hostUsername}  ${e.playerCount}/${e.maxPlayerCount} players`,o.style.color="#CCCCCC",o.style.fontSize="14px",s.appendChild(o);const r=this.createButton("JOIN",()=>{this.joinLanLobbyWithCode(e.connectionCode)},"#00AAFF");r.style.padding="8px 18px",r.style.fontSize="14px",r.addEventListener("click",t=>{t.stopPropagation()}),i.addEventListener("click",()=>{this.joinLanLobbyWithCode(e.connectionCode)}),i.appendChild(s),i.appendChild(r),t.appendChild(i)}}scheduleLanLobbyListRefresh(t){null!==this.lanServerListTimeout&&clearTimeout(this.lanServerListTimeout),this.lanServerListTimeout=window.setTimeout(()=>{this.renderLanLobbyList(t),this.scheduleLanLobbyListRefresh(t)},2e3)}joinLanLobbyWithCode(t){return Ju(this,void 0,void 0,function*(){if(t)try{this.renderClientWaitingScreen();const{offer:e,playerId:i,username:s}=Il.parseHostCode(t),n=`player_${Date.now()}`;this.networkManager=new Cl(n);const o=yield this.networkManager.connectToPeer(i,e),r=yield Il.generateAnswerCode(o,n,this.settings.username);this.renderClientAnswerScreen(r,s)}catch(t){console.error("Failed to join lobby:",t),alert(`Failed to join lobby: ${t instanceof Error?t.message:"Unknown error"}`),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)}})}renderMainScreen(t){this.clearMenu(),this.renderMainScreenWhenReady(t)}renderMainScreenWhenReady(t){const e=++this.mainScreenRenderToken;"main"===this.currentScreen&&e===this.mainScreenRenderToken&&this.renderMainScreenContent(t)}renderMainScreenContent(t){var e;this.setTestLevelButtonVisible(!0),this.setLadButtonVisible(!0),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;t.style.justifyContent="flex-start";const s=document.createElement("img");s.src=this.resolveAssetPath("ASSETS/SPRITES/menu/titleGraphic.png"),s.alt="Speed of Light RTS",s.style.width=i?"300px":"480px",s.style.maxWidth="90%",s.style.height="auto",s.style.marginBottom=i?"6px":"12px",s.style.alignSelf="center",t.appendChild(s);const n=document.createElement("div");n.style.width="100%",n.style.maxWidth=i?"100%":"900px",n.style.padding=i?"0 10px":"0",n.style.marginTop="0",n.style.marginBottom=i?"18px":"20px",t.appendChild(n);const{label:o,color:r}=this.getFactionLabelAndColor(this.settings.selectedFaction),a=[{id:"loadout",name:"LOADOUT",description:"Select faction & heroes",subLabel:o,subLabelColor:r},{id:"start",name:"START",description:"Begin game"},{id:"maps",name:"MAPS",description:"Select map"},{id:"settings",name:"SETTINGS",description:"Configure game"}];this.carouselMenu=new ep(n,a,1,"rgba(0, 0, 0, 0.5)"),this.carouselMenu.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onNavigate(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onSelect(t=>{switch(t.id){case"loadout":this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement);break;case"start":this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement);break;case"maps":this.currentScreen="maps",this.startMenuTransition(),this.renderMapSelectionScreen(this.contentElement);break;case"settings":this.currentScreen="settings",this.startMenuTransition(),this.renderSettingsScreen(this.contentElement)}}),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderMapSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Map",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.display="grid",n.style.gridTemplateColumns=`repeat(auto-fit, minmax(${i?220:300}px, 1fr))`,n.style.gap="20px",n.style.maxWidth="900px",n.style.padding="20px",n.style.marginBottom="30px";for(const t of this.availableMaps){const e=document.createElement("div");e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.border="2px solid transparent",e.style.borderRadius="10px",e.style.padding="20px",e.style.cursor="pointer",e.style.transition="all 0.3s",e.dataset.particleBox="true",e.dataset.particleColor=t.id===this.settings.selectedMap.id?"#FFD700":"#66B3FF",e.addEventListener("mouseenter",()=>{t.id!==this.settings.selectedMap.id&&(e.style.backgroundColor="rgba(255, 255, 255, 0.1)",e.style.transform="scale(1.02)")}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="rgba(255, 255, 255, 0.05)",e.style.transform="scale(1)"}),e.addEventListener("click",()=>{this.settings.selectedMap=t,this.renderMapSelectionScreen(this.contentElement)});const i=document.createElement("h3");i.textContent=t.name,i.style.fontSize="28px",i.style.marginBottom="10px",i.style.color=t.id===this.settings.selectedMap.id?"#FFD700":"#FFFFFF",i.style.fontWeight="300",i.dataset.particleText="true",i.dataset.particleColor=t.id===this.settings.selectedMap.id?"#FFF2B3":"#E0F2FF",e.appendChild(i);const s=document.createElement("p");s.textContent=t.description,s.style.fontSize="24px",s.style.lineHeight="1.5",s.style.marginBottom="15px",s.style.color="#CCCCCC",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#CCCCCC",e.appendChild(s);const o=document.createElement("div");o.style.fontSize="24px",o.style.color="#888888",o.innerHTML=`\n                <div> Suns: ${t.numSuns}</div>\n                <div> Asteroids: ${t.numAsteroids}</div>\n                <div> Size: ${t.mapSize}px</div>\n            `,e.appendChild(o),n.appendChild(e)}t.appendChild(n);const o=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");t.appendChild(o),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderLANScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="LAN Play",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=this.createButton("HOST SERVER",()=>{this.showHostLobbyDialog()},"#00AA00");n.style.marginBottom="20px",n.style.padding="15px 40px",n.style.fontSize="28px",t.appendChild(n);const o=this.createButton("JOIN SERVER",()=>{this.showJoinLobbyDialog()},"#0088FF");o.style.marginBottom="40px",o.style.padding="15px 40px",o.style.fontSize="28px",t.appendChild(o);const r=document.createElement("div");r.style.maxWidth="720px",r.style.width="100%",r.style.padding="20px",r.style.backgroundColor="rgba(0, 0, 0, 0.35)",r.style.borderRadius="12px",r.style.border="2px solid rgba(255, 215, 0, 0.25)",r.style.marginBottom="30px",r.style.display="flex",r.style.flexDirection="column",r.style.gap="14px";const a=document.createElement("h3");a.textContent="Available LAN Lobbies",a.style.fontSize="22px",a.style.margin="0",a.style.color="#FFD700",a.style.textAlign="center",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="12px",r.appendChild(l),this.renderLanLobbyList(l),this.scheduleLanLobbyListRefresh(l),t.appendChild(r);const h=document.createElement("div");h.style.maxWidth="600px",h.style.width="100%",h.style.padding="20px",h.style.backgroundColor="rgba(0, 0, 0, 0.3)",h.style.borderRadius="10px",h.style.border="2px solid rgba(255, 255, 255, 0.2)",h.style.marginBottom="30px";const c=document.createElement("h3");c.textContent="How LAN Play Works",c.style.fontSize="24px",c.style.marginBottom="15px",c.style.color="#FFD700",c.style.textAlign="center",h.appendChild(c);const d=document.createElement("p");d.innerHTML='\n            <strong>For Host:</strong><br>\n            1. Click "HOST SERVER" to create a lobby<br>\n            2. Share the connection code with other players<br>\n            3. Wait for players to join<br>\n            4. Start the game when ready<br><br>\n            <strong>For Client:</strong><br>\n            1. Click "JOIN SERVER"<br>\n            2. Enter the connection code from the host<br>\n            3. Wait in lobby for host to start the game\n        ',d.style.color="#CCCCCC",d.style.fontSize="16px",d.style.lineHeight="1.6",h.appendChild(d),t.appendChild(h);const u=this.createButton("BACK",()=>{this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement)},"#666666");t.appendChild(u),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}showHostLobbyDialog(){return Ju(this,void 0,void 0,function*(){const t=`player_${Date.now()}`;this.networkManager=new Cl(t);const e=`${this.settings.username}'s lobby`,i=this.networkManager.createLobby(e,this.settings.username,2);try{const e=yield this.networkManager.createOfferForPeer("client"),s=yield Il.generateHostCode(e,t,this.settings.username);this.renderHostLobbyScreen(i,s,t)}catch(t){console.error("Failed to create lobby:",t),alert("Failed to create lobby. Please try again.")}})}showJoinLobbyDialog(){return Ju(this,void 0,void 0,function*(){const t=prompt("Enter the connection code from the host:");t&&(yield this.joinLanLobbyWithCode(t.trim()))})}renderHostLobbyScreen(t,e,i){var s,n,o;this.clearMenu(),this.setMenuParticleDensity(1.6);const r=window.innerWidth<600;this.startLanLobbyHeartbeat({hostPlayerId:i,lobbyName:t.name,hostUsername:null!==(n=null===(s=t.players.find(t=>t.isHost))||void 0===s?void 0:s.username)&&void 0!==n?n:this.settings.username,connectionCode:e,maxPlayerCount:t.maxPlayers,playerCount:t.players.length});const a=document.createElement("h2");a.textContent="Lobby: "+t.name,a.style.fontSize=r?"28px":"36px",a.style.marginBottom="20px",a.style.color="#FFD700",a.style.textAlign="center",a.dataset.particleText="true",a.dataset.particleColor="#FFD700",this.contentElement.appendChild(a);const l=document.createElement("div");l.style.maxWidth="600px",l.style.width="100%",l.style.padding="20px",l.style.backgroundColor="rgba(0, 100, 0, 0.3)",l.style.borderRadius="10px",l.style.border="2px solid rgba(0, 255, 0, 0.3)",l.style.marginBottom="20px";const h=document.createElement("p");h.textContent="Share this connection code:",h.style.color="#CCCCCC",h.style.fontSize="18px",h.style.marginBottom="10px",l.appendChild(h);const c=document.createElement("textarea");c.value=e,c.readOnly=!0,c.style.width="100%",c.style.height="80px",c.style.padding="10px",c.style.backgroundColor="rgba(0, 0, 0, 0.5)",c.style.color="#00FF00",c.style.border="1px solid rgba(255, 255, 255, 0.3)",c.style.borderRadius="5px",c.style.fontSize="14px",c.style.fontFamily="monospace",c.style.resize="none",l.appendChild(c);const d=this.createButton("COPY CODE",()=>Ju(this,void 0,void 0,function*(){try{yield navigator.clipboard.writeText(c.value),alert("Connection code copied to clipboard!")}catch(t){c.select(),document.execCommand("copy"),alert("Connection code copied to clipboard!")}}),"#008800");d.style.marginTop="10px",d.style.padding="10px 20px",d.style.fontSize="16px",l.appendChild(d),this.contentElement.appendChild(l);const u=document.createElement("div");u.style.maxWidth="600px",u.style.width="100%",u.style.padding="20px",u.style.backgroundColor="rgba(0, 0, 100, 0.3)",u.style.borderRadius="10px",u.style.border="2px solid rgba(0, 100, 255, 0.3)",u.style.marginBottom="30px";const p=document.createElement("p");p.textContent="Paste the answer code from the client:",p.style.color="#CCCCCC",p.style.fontSize="18px",p.style.marginBottom="10px",u.appendChild(p);const g=document.createElement("textarea");g.placeholder="Paste answer code here...",g.style.width="100%",g.style.height="80px",g.style.padding="10px",g.style.backgroundColor="rgba(0, 0, 0, 0.5)",g.style.color="#FFFFFF",g.style.border="1px solid rgba(255, 255, 255, 0.3)",g.style.borderRadius="5px",g.style.fontSize="14px",g.style.fontFamily="monospace",g.style.resize="none",u.appendChild(g);const y=this.createButton("CONNECT",()=>Ju(this,void 0,void 0,function*(){var t,s;const n=g.value.trim();if(n)try{const{answer:o,playerId:r,username:a}=Il.parseAnswerCode(n);if(yield null===(t=this.networkManager)||void 0===t?void 0:t.completeConnection(r,o),this.networkManager&&this.networkManager.getLobby()){const t=this.networkManager.getLobby();t.players.push({id:r,username:a,isHost:!1,isReady:!0}),this.networkManager.broadcast({type:El.LOBBY_UPDATE,senderId:i,timestamp:Date.now(),data:t});const n=t.players.find(t=>t.isHost);this.registerLanLobbyEntry({hostPlayerId:i,lobbyName:t.name,hostUsername:null!==(s=null==n?void 0:n.username)&&void 0!==s?s:this.settings.username,connectionCode:e,maxPlayerCount:t.maxPlayers,playerCount:t.players.length})}alert(`${a} connected! You can now start the game.`)}catch(t){console.error("Failed to connect client:",t),alert(`Failed to connect: ${t instanceof Error?t.message:"Invalid answer code"}`)}else alert("Please paste the answer code from the client.")}),"#0088FF");y.style.marginTop="10px",y.style.padding="10px 20px",y.style.fontSize="16px",u.appendChild(y),this.contentElement.appendChild(u);const f=this.createButton("START GAME",()=>{this.networkManager?0!==this.networkManager.getPeerCount()?(this.networkManager.startGame(),this.unregisterLanLobbyEntry(i),this.stopLanLobbyHeartbeat(),this.settings.gameMode="lan",this.settings.networkManager=this.networkManager,this.onStartCallback&&(this.hide(),this.onStartCallback(this.settings))):alert("Please wait for at least one player to connect before starting."):alert("Network manager not initialized.")},"#FF8800");f.style.marginBottom="20px",f.style.padding="15px 40px",f.style.fontSize="24px",this.contentElement.appendChild(f);const m=this.createButton("CANCEL",()=>{this.networkManager&&(this.networkManager.disconnect(),this.networkManager=null),this.unregisterLanLobbyEntry(i),this.stopLanLobbyHeartbeat(),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)},"#666666");this.contentElement.appendChild(m),null===(o=this.menuParticleLayer)||void 0===o||o.requestTargetRefresh(this.contentElement)}renderClientAnswerScreen(t,e){var i,s;this.clearMenu(),this.setMenuParticleDensity(1.6);const n=document.createElement("h2");n.textContent=`Joining ${e}'s Lobby`,n.style.fontSize="32px",n.style.marginBottom="20px",n.style.color="#FFD700",n.style.textAlign="center",n.dataset.particleText="true",n.dataset.particleColor="#FFD700",this.contentElement.appendChild(n);const o=document.createElement("p");o.textContent="Send this answer code to the host:",o.style.color="#CCCCCC",o.style.fontSize="18px",o.style.textAlign="center",o.style.marginBottom="20px",this.contentElement.appendChild(o);const r=document.createElement("div");r.style.maxWidth="600px",r.style.width="100%",r.style.padding="20px",r.style.backgroundColor="rgba(0, 0, 100, 0.3)",r.style.borderRadius="10px",r.style.border="2px solid rgba(0, 100, 255, 0.3)",r.style.marginBottom="30px";const a=document.createElement("textarea");a.value=t,a.readOnly=!0,a.style.width="100%",a.style.height="80px",a.style.padding="10px",a.style.backgroundColor="rgba(0, 0, 0, 0.5)",a.style.color="#0088FF",a.style.border="1px solid rgba(255, 255, 255, 0.3)",a.style.borderRadius="5px",a.style.fontSize="14px",a.style.fontFamily="monospace",a.style.resize="none",r.appendChild(a);const l=this.createButton("COPY CODE",()=>Ju(this,void 0,void 0,function*(){try{yield navigator.clipboard.writeText(a.value),alert("Answer code copied to clipboard!")}catch(t){a.select(),document.execCommand("copy"),alert("Answer code copied to clipboard!")}}),"#0088FF");l.style.marginTop="10px",l.style.padding="10px 20px",l.style.fontSize="16px",r.appendChild(l),this.contentElement.appendChild(r);const h=document.createElement("p");h.textContent="Waiting for host to complete connection...",h.style.color="#888888",h.style.fontSize="18px",h.style.textAlign="center",h.style.marginBottom="30px",this.contentElement.appendChild(h),null===(i=this.networkManager)||void 0===i||i.on(bl.MESSAGE_RECEIVED,t=>{t&&t.type===El.GAME_START&&this.onStartCallback&&(this.settings.gameMode="lan",this.settings.networkManager=this.networkManager,this.hide(),this.onStartCallback(this.settings))});const c=this.createButton("CANCEL",()=>{this.networkManager&&(this.networkManager.disconnect(),this.networkManager=null),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)},"#666666");this.contentElement.appendChild(c),null===(s=this.menuParticleLayer)||void 0===s||s.requestTargetRefresh(this.contentElement)}renderClientWaitingScreen(){var t;this.clearMenu(),this.setMenuParticleDensity(1.6);const e=document.createElement("h2");e.textContent="Connecting to Host...",e.style.fontSize="36px",e.style.marginBottom="30px",e.style.color="#FFD700",e.style.textAlign="center",e.dataset.particleText="true",e.dataset.particleColor="#FFD700",this.contentElement.appendChild(e);const i=document.createElement("p");i.textContent="Waiting for host to complete the connection...",i.style.color="#CCCCCC",i.style.fontSize="20px",i.style.textAlign="center",i.style.marginBottom="30px",this.contentElement.appendChild(i);const s=this.createButton("CANCEL",()=>{this.networkManager&&(this.networkManager.disconnect(),this.networkManager=null),this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement)},"#666666");this.contentElement.appendChild(s),null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}renderOnlinePlaceholderScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Online Play",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.display="flex",n.style.gap="20px",n.style.marginBottom="30px",n.style.justifyContent="center";const o=this.createButton("UNRANKED",()=>{this.onlineMode="unranked",this.renderOnlinePlaceholderScreen(this.contentElement)},"unranked"===this.onlineMode?"#FF8800":"#666666");o.style.padding="12px 24px",o.style.fontSize="18px","unranked"===this.onlineMode&&(o.style.border="2px solid #FF8800",o.style.boxShadow="0 0 15px rgba(255, 136, 0, 0.5)"),n.appendChild(o);const r=this.createButton("RANKED",()=>{this.onlineMode="ranked",this.renderOnlinePlaceholderScreen(this.contentElement)},"ranked"===this.onlineMode?"#FF8800":"#666666");r.style.padding="12px 24px",r.style.fontSize="18px","ranked"===this.onlineMode&&(r.style.border="2px solid #FF8800",r.style.boxShadow="0 0 15px rgba(255, 136, 0, 0.5)"),n.appendChild(r),t.appendChild(n);const a=document.createElement("div");a.style.maxWidth="600px",a.style.padding="40px",a.style.backgroundColor="rgba(0, 0, 0, 0.3)",a.style.borderRadius="10px",a.style.border="2px solid rgba(255, 215, 0, 0.3)",a.style.marginBottom="30px";const l=document.createElement("h3");l.textContent="Coming Soon!",l.style.fontSize="32px",l.style.color="#FFD700",l.style.textAlign="center",l.style.marginBottom="20px",l.style.fontWeight="300",a.appendChild(l);const h=document.createElement("p");h.innerHTML="\n            Online multiplayer is currently in development.<br><br>\n            <strong>Features:</strong><br>\n             Simple, efficient data transmission<br>\n             Prioritized for speed and minimal data size<br>\n             Cross-platform matchmaking<br>\n             Ranked and casual modes\n        ",h.style.fontSize="20px",h.style.color="#CCCCCC",h.style.textAlign="center",h.style.lineHeight="1.6",a.appendChild(h),t.appendChild(a);const c=this.createButton("BACK",()=>{this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement)},"#666666");t.appendChild(c),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderP2PScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="P2P Multiplayer (Beta)",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=this.createButton("HOST MATCH",()=>{this.currentScreen="p2p-host",this.startMenuTransition(),this.renderP2PHostScreen(this.contentElement)},"#00AA00");n.style.marginBottom="20px",n.style.padding="15px 40px",n.style.fontSize="28px",t.appendChild(n);const o=this.createButton("JOIN MATCH",()=>{this.currentScreen="p2p-join",this.startMenuTransition(),this.renderP2PJoinScreen(this.contentElement)},"#0088FF");o.style.marginBottom="40px",o.style.padding="15px 40px",o.style.fontSize="28px",t.appendChild(o);const r=this.createButton("BACK",()=>{this.currentScreen="game-mode-select",this.startMenuTransition(),this.renderGameModeSelectionScreen(this.contentElement)},"#666666");t.appendChild(r),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderP2PHostScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Host P2P Match",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.maxWidth="500px",n.style.width="100%",n.style.padding="20px",n.style.backgroundColor="rgba(0, 0, 0, 0.35)",n.style.borderRadius="12px",n.style.border="2px solid rgba(255, 215, 0, 0.25)",n.style.marginBottom="20px",t.appendChild(n);const o=document.createElement("label");o.textContent="Match Name:",o.style.fontSize="20px",o.style.color="#FFFFFF",o.style.marginBottom="8px",o.style.display="block",n.appendChild(o);const r=document.createElement("input");r.type="text",r.value=`${this.settings.username}'s Match`,r.placeholder="Enter match name",r.style.fontSize="18px",r.style.padding="8px 15px",r.style.backgroundColor="rgba(255, 255, 255, 0.1)",r.style.color="#FFFFFF",r.style.border="2px solid rgba(255, 255, 255, 0.3)",r.style.borderRadius="5px",r.style.fontFamily="inherit",r.style.width="100%",r.style.marginBottom="20px",r.style.boxSizing="border-box",n.appendChild(r);const a=document.createElement("label");a.textContent="Max Players (2-8):",a.style.fontSize="20px",a.style.color="#FFFFFF",a.style.marginBottom="8px",a.style.display="block",n.appendChild(a);const l=document.createElement("input");l.type="number",l.min="2",l.max="8",l.value="2",l.style.fontSize="18px",l.style.padding="8px 15px",l.style.backgroundColor="rgba(255, 255, 255, 0.1)",l.style.color="#FFFFFF",l.style.border="2px solid rgba(255, 255, 255, 0.3)",l.style.borderRadius="5px",l.style.fontFamily="inherit",l.style.width="100%",l.style.boxSizing="border-box",n.appendChild(l);const h=document.createElement("div");h.style.maxWidth="600px",h.style.width="100%",h.style.padding="20px",h.style.backgroundColor="rgba(0, 100, 0, 0.2)",h.style.borderRadius="12px",h.style.border="2px solid rgba(0, 255, 136, 0.4)",h.style.marginBottom="20px",h.style.display="none",t.appendChild(h);const c=document.createElement("div");c.textContent="SHARE THIS CODE:",c.style.fontSize="18px",c.style.color="#00FF88",c.style.marginBottom="10px",c.style.textAlign="center",h.appendChild(c);const d=document.createElement("div");d.textContent="",d.style.fontSize="32px",d.style.color="#FFFFFF",d.style.marginBottom="15px",d.style.textAlign="center",d.style.fontFamily="monospace",d.style.letterSpacing="4px",h.appendChild(d);const u=this.createButton("COPY CODE",()=>Ju(this,void 0,void 0,function*(){try{yield navigator.clipboard.writeText(d.textContent||""),c.textContent="CODE COPIED!",setTimeout(()=>{c.textContent="SHARE THIS CODE:"},2e3)}catch(t){console.error("Failed to copy match ID:",t),c.textContent="Failed to copy. Please copy manually.",setTimeout(()=>{c.textContent="SHARE THIS CODE:"},2e3)}}),"#00FF88");u.style.padding="10px 30px",u.style.fontSize="18px",h.appendChild(u);const p=document.createElement("div");p.style.maxWidth="600px",p.style.width="100%",p.style.padding="20px",p.style.backgroundColor="rgba(0, 0, 0, 0.35)",p.style.borderRadius="12px",p.style.border="2px solid rgba(255, 215, 0, 0.25)",p.style.marginBottom="20px",p.style.display="none",t.appendChild(p);const g=document.createElement("h3");g.textContent="Players:",g.style.fontSize="24px",g.style.color="#FFD700",g.style.marginBottom="15px",g.style.textAlign="center",p.appendChild(g);const y=document.createElement("div");y.style.display="flex",y.style.flexDirection="column",y.style.gap="10px",p.appendChild(y);const f=document.createElement("div");f.style.fontSize="18px",f.style.color="#FF6666",f.style.marginBottom="20px",f.style.textAlign="center",f.style.display="none",t.appendChild(f);const m=this.createButton("CREATE MATCH",()=>Ju(this,void 0,void 0,function*(){const t=qu();if(!t.url||!t.anonKey)return f.textContent="Supabase not configured. Cannot create P2P match.",void(f.style.display="block");m.disabled=!0,m.textContent="CREATING...";const e=r.value.trim()||`${this.settings.username}'s Match`,i=Math.max(2,Math.min(8,parseInt(l.value)||2));this.p2pMatchName=e,this.p2pMaxPlayers=i;const s=`player_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;this.multiplayerNetworkManager=new Xu(t.url,t.anonKey,s),this.multiplayerNetworkManager.on(Ku.MATCH_CREATED,t=>{const e=t.match;d.textContent=e.id.substring(0,8).toUpperCase(),h.style.display="block",p.style.display="block",n.style.display="none",m.style.display="none",x.style.display="block",this.p2pMatchPlayers=[{id:s,match_id:e.id,player_id:s,role:"host",connected:!0,username:this.settings.username,faction:null}],this.updatePlayersList(y)}),this.multiplayerNetworkManager.on(Ku.PLAYER_JOINED,t=>{this.fetchAndUpdatePlayers(y)}),this.multiplayerNetworkManager.on(Ku.MATCH_STARTED,()=>{this.settings.multiplayerNetworkManager=this.multiplayerNetworkManager||void 0,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings))}),this.multiplayerNetworkManager.on(Ku.ERROR,t=>{var e;const i=t.message||(null===(e=t.error)||void 0===e?void 0:e.message)||t.error||"Unknown error";f.textContent=`Error: ${i}`,f.style.display="block",m.disabled=!1,m.textContent="CREATE MATCH"}),(yield this.multiplayerNetworkManager.createMatch({matchName:e,username:this.settings.username,maxPlayers:i,gameSettings:{}}))||(m.disabled=!1,m.textContent="CREATE MATCH")}),"#00AA00");m.style.marginBottom="20px",m.style.padding="15px 40px",m.style.fontSize="24px",t.appendChild(m);const x=this.createButton("START MATCH",()=>Ju(this,void 0,void 0,function*(){this.multiplayerNetworkManager&&(x.disabled=!0,x.textContent="STARTING...",yield this.multiplayerNetworkManager.startMatch())}),"#00FF88");x.style.marginBottom="20px",x.style.padding="15px 40px",x.style.fontSize="24px",x.style.display="none",t.appendChild(x);const S=this.createButton("CANCEL",()=>{this.multiplayerNetworkManager&&(this.multiplayerNetworkManager.disconnect(),this.multiplayerNetworkManager=null),this.currentScreen="p2p",this.startMenuTransition(),this.renderP2PScreen(this.contentElement)},"#666666");t.appendChild(S),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderP2PJoinScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Join P2P Match",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.maxWidth="500px",n.style.width="100%",n.style.padding="20px",n.style.backgroundColor="rgba(0, 0, 0, 0.35)",n.style.borderRadius="12px",n.style.border="2px solid rgba(255, 215, 0, 0.25)",n.style.marginBottom="20px",t.appendChild(n);const o=document.createElement("label");o.textContent="Match ID:",o.style.fontSize="20px",o.style.color="#FFFFFF",o.style.marginBottom="8px",o.style.display="block",n.appendChild(o);const r=document.createElement("input");r.type="text",r.placeholder="Enter 8-character match ID",r.style.fontSize="24px",r.style.padding="12px 15px",r.style.backgroundColor="rgba(255, 255, 255, 0.1)",r.style.color="#FFFFFF",r.style.border="2px solid rgba(255, 255, 255, 0.3)",r.style.borderRadius="5px",r.style.fontFamily="monospace",r.style.width="100%",r.style.boxSizing="border-box",r.style.letterSpacing="4px",r.style.textTransform="uppercase",n.appendChild(r);const a=document.createElement("div");a.style.fontSize="18px",a.style.color="#FFD700",a.style.marginBottom="20px",a.style.textAlign="center",a.style.display="none",t.appendChild(a);const l=document.createElement("div");l.style.maxWidth="600px",l.style.width="100%",l.style.padding="20px",l.style.backgroundColor="rgba(0, 0, 0, 0.35)",l.style.borderRadius="12px",l.style.border="2px solid rgba(255, 215, 0, 0.25)",l.style.marginBottom="20px",l.style.display="none",t.appendChild(l);const h=document.createElement("h3");h.textContent="Match Lobby",h.style.fontSize="24px",h.style.color="#FFD700",h.style.marginBottom="15px",h.style.textAlign="center",l.appendChild(h);const c=document.createElement("div");c.style.display="flex",c.style.flexDirection="column",c.style.gap="10px",c.style.marginBottom="15px",l.appendChild(c);const d=document.createElement("div");d.textContent="Waiting for host to start...",d.style.fontSize="18px",d.style.color="#CCCCCC",d.style.textAlign="center",d.style.fontStyle="italic",l.appendChild(d);const u=this.createButton("JOIN MATCH",()=>Ju(this,void 0,void 0,function*(){const t=qu();if(!t.url||!t.anonKey)return a.textContent="Supabase not configured. Cannot join P2P match.",a.style.color="#FF6666",void(a.style.display="block");const e=r.value.trim().toUpperCase();if(!e||e.length<6)return a.textContent="Please enter a valid match ID (at least 6 characters).",a.style.color="#FF6666",void(a.style.display="block");u.disabled=!0,u.textContent="JOINING...",a.textContent="Connecting...",a.style.color="#FFD700",a.style.display="block";const i=`player_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;this.multiplayerNetworkManager=new Xu(t.url,t.anonKey,i),this.multiplayerNetworkManager.on(Ku.PLAYER_JOINED,()=>{a.textContent="Joined successfully!",a.style.color="#00FF88",n.style.display="none",u.style.display="none",l.style.display="block",this.fetchAndUpdatePlayers(c)}),this.multiplayerNetworkManager.on(Ku.MATCH_STARTED,()=>{this.settings.multiplayerNetworkManager=this.multiplayerNetworkManager||void 0,this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings))}),this.multiplayerNetworkManager.on(Ku.ERROR,t=>{var e;const i=t.message||(null===(e=t.error)||void 0===e?void 0:e.message)||t.error||"Failed to join match";a.textContent=`Error: ${i}`,a.style.color="#FF6666",a.style.display="block",u.disabled=!1,u.textContent="JOIN MATCH"});const s=(yield this.multiplayerNetworkManager.listMatches()).find(t=>t.id.toUpperCase().startsWith(e));if(!s)return a.textContent="Match not found. Please check the match ID.",a.style.color="#FF6666",a.style.display="block",u.disabled=!1,void(u.textContent="JOIN MATCH");(yield this.multiplayerNetworkManager.joinMatch(s.id,this.settings.username))?yield this.multiplayerNetworkManager.startMatch():(u.disabled=!1,u.textContent="JOIN MATCH")}),"#0088FF");u.style.marginBottom="20px",u.style.padding="15px 40px",u.style.fontSize="24px",t.appendChild(u);const p=this.createButton("LEAVE",()=>{this.multiplayerNetworkManager&&(this.multiplayerNetworkManager.disconnect(),this.multiplayerNetworkManager=null),this.currentScreen="p2p",this.startMenuTransition(),this.renderP2PScreen(this.contentElement)},"#666666");t.appendChild(p),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}updatePlayersList(t){t.innerHTML="";for(const e of this.p2pMatchPlayers){const i=document.createElement("div");i.style.padding="10px",i.style.backgroundColor="rgba(255, 255, 255, 0.05)",i.style.borderRadius="5px",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center";const s=document.createElement("span");s.textContent=e.username,s.style.fontSize="18px",s.style.color="#FFFFFF",i.appendChild(s);const n=document.createElement("span");n.textContent="host"===e.role?"(Host)":"(Player)",n.style.fontSize="14px",n.style.color="host"===e.role?"#FFD700":"#CCCCCC",i.appendChild(n),t.appendChild(i)}}fetchAndUpdatePlayers(t){return Ju(this,void 0,void 0,function*(){if(!this.multiplayerNetworkManager)return;const e=this.multiplayerNetworkManager.getCurrentMatch();if(!e)return;const i=qu(),s=Uu(i.url,i.anonKey),{data:n,error:o}=yield s.from("match_players").select("*").eq("match_id",e.id);!o&&n&&(this.p2pMatchPlayers=n,this.updatePlayersList(t))})}renderSettingsScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Settings",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.maxWidth="500px",n.style.width="100%",n.style.padding="20px";const o=this.createSettingSection("Difficulty",this.createSelect(["easy","normal","hard"],this.settings.difficulty,t=>{this.settings.difficulty=t}));n.appendChild(o);const r=this.createSettingSection("Username",this.createTextInput(this.settings.username,t=>{this.saveUsername(t)},"Enter your username"));n.appendChild(r);const a=this.createSettingSection("Sound Effects",this.createToggle(this.settings.soundEnabled,t=>{this.settings.soundEnabled=t}));n.appendChild(a);const l=this.createSettingSection("Music",this.createToggle(this.settings.musicEnabled,t=>{this.settings.musicEnabled=t}));n.appendChild(l);const h=this.createSettingSection("Battle Stats Info",this.createToggle(this.settings.isBattleStatsInfoEnabled,t=>{this.settings.isBattleStatsInfoEnabled=t}));n.appendChild(h);const c=this.createSettingSection("Screen Shake",this.createToggle(this.settings.screenShakeEnabled,t=>{this.settings.screenShakeEnabled=t}));n.appendChild(c);const d=this.createSettingSection("Player Color",this.createColorPicker(this.settings.playerColor,t=>{this.settings.playerColor=t}));n.appendChild(d);const u=this.createSettingSection("Enemy Color",this.createColorPicker(this.settings.enemyColor,t=>{this.settings.enemyColor=t}));n.appendChild(u);const p=this.createSettingSection("Graphics Quality",this.createSelect(["low","medium","high"],this.settings.graphicsQuality,t=>{this.settings.graphicsQuality=t}));n.appendChild(p);const g=this.createSettingSection("Color Scheme",this.createSelect(Object.keys(dh),this.settings.colorScheme,t=>{this.settings.colorScheme=t}));n.appendChild(g);const y=this.createButton("DELETE DATA",()=>Ju(this,void 0,void 0,function*(){window.confirm("Delete all player data and cached files? This will reload the game and start fresh.")&&(yield this.clearPlayerDataAndCache(),window.location.reload())}),"#FF6666");y.style.fontSize="18px",y.style.padding="10px 20px";const f=this.createSettingSection("Reset Player Data",y);n.appendChild(f),t.appendChild(n);const m=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");m.style.marginTop="30px",t.appendChild(m),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderGameModeSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Game Mode",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.width="100%",n.style.maxWidth=i?"100%":"900px",n.style.padding=i?"0 10px":"0",n.style.marginBottom=i?"18px":"20px",t.appendChild(n),this.carouselMenu=new ep(n,[{id:"ai",name:"AI",description:"Play against computer opponent"},{id:"online",name:"ONLINE",description:"Play against players worldwide"},{id:"lan",name:"LAN",description:"Play on local network"},{id:"p2p",name:"P2P MULTIPLAYER",description:"Peer-to-peer multiplayer (Beta)"}],0),this.carouselMenu.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onNavigate(()=>{var t;this.startMenuTransition(),null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)}),this.carouselMenu.onSelect(t=>{switch(this.settings.gameMode=t.id,t.id){case"ai":this.hide(),this.onStartCallback&&(this.ensureDefaultHeroSelection(),this.onStartCallback(this.settings));break;case"online":this.currentScreen="online",this.startMenuTransition(),this.renderOnlinePlaceholderScreen(this.contentElement);break;case"lan":this.currentScreen="lan",this.startMenuTransition(),this.renderLANScreen(this.contentElement);break;case"p2p":this.currentScreen="p2p",this.startMenuTransition(),this.renderP2PScreen(this.contentElement)}});const o=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");o.style.marginTop="30px",t.appendChild(o),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderFactionSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600,s=document.createElement("h2");s.textContent="Select Your Faction",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"8px":"12px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=document.createElement("div");n.style.width="100%",n.style.maxWidth=i?"100%":"900px",n.style.padding=i?"0 10px":"0",n.style.marginBottom="12px",t.appendChild(n);const o=[{id:Za.RADIANT,name:"Radiant",description:"Well-Balanced, Ranged-Focused",color:"#FF5722"},{id:Za.AURUM,name:"Aurum",description:"Fast-Paced, Melee-Focused",color:"#FFD700"},{id:Za.VELARIS,name:"Velaris",description:"Strategic, Ability-Heavy. Particles from Nebulae",color:"#9C27B0"}],r=o.findIndex(t=>t.id===this.settings.selectedFaction),a=r>=0?r:0;!this.settings.selectedFaction&&o.length>0&&(this.settings.selectedFaction=o[a].id),this.factionCarousel=new tp(n,o,a),this.factionCarousel.onSelectionChange(t=>{var e;this.settings.selectedFaction!==t.id&&(this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection()),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}),this.factionCarousel.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)});const l=document.createElement("div");if(l.style.display="flex",l.style.gap="20px",l.style.marginTop="8px",l.style.flexWrap="wrap",l.style.justifyContent="center",i&&(l.style.flexDirection="column",l.style.alignItems="center"),this.settings.selectedFaction){const t=this.createButton("CUSTOMIZE LOADOUT",()=>{this.currentScreen="loadout-customization",this.startMenuTransition(),this.renderLoadoutCustomizationScreen(this.contentElement)},"#00FF88");l.appendChild(t)}const h=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");l.appendChild(h),t.appendChild(l),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}renderLoadoutCustomizationScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;if(!this.settings.selectedFaction)return this.currentScreen="faction-select",void this.renderFactionSelectionScreen(t);const s=document.createElement("h2");s.textContent="Customize Loadout",s.style.fontSize=i?"32px":"48px",s.style.marginBottom=i?"20px":"30px",s.style.color="#FFD700",s.style.textAlign="center",s.style.maxWidth="100%",s.style.fontWeight="bold",s.dataset.particleText="true",s.dataset.particleColor="#FFD700",t.appendChild(s);const n=this.baseLoadouts.filter(t=>t.faction===this.settings.selectedFaction),o=this.spawnLoadouts.filter(t=>t.faction===this.settings.selectedFaction);!this.settings.selectedBaseLoadout&&n.length>0&&(this.settings.selectedBaseLoadout=n[0].id),!this.settings.selectedSpawnLoadout&&o.length>0&&(this.settings.selectedSpawnLoadout=o[0].id);const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="40px",r.style.width="100%",r.style.maxWidth=i?"100%":"800px",r.style.padding=i?"0 10px":"0 20px",t.appendChild(r),this.createLoadoutSection(r,"Base Loadout",n,this.settings.selectedBaseLoadout,t=>{this.settings.selectedBaseLoadout=t},i),this.createLoadoutSection(r,"Spawn Loadout",o,this.settings.selectedSpawnLoadout,t=>{this.settings.selectedSpawnLoadout=t},i);const a=document.createElement("div");a.style.marginTop="20px";const l=document.createElement("h3");l.textContent="Hero Loadout",l.style.fontSize=i?"24px":"32px",l.style.color="#00AAFF",l.style.marginBottom="15px",l.style.fontWeight="bold",l.dataset.particleText="true",l.dataset.particleColor="#00AAFF",a.appendChild(l);const h=document.createElement("div");h.textContent=this.settings.selectedHeroes.length>0?`Selected: ${this.settings.selectedHeroNames.join(", ")}`:"No heroes selected yet",h.style.fontSize="20px",h.style.color="#CCCCCC",h.style.marginBottom="15px",a.appendChild(h);const c=this.createButton("SELECT HEROES",()=>{this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement)},"#00FF88");a.appendChild(c),r.appendChild(a);const d=document.createElement("div");d.style.display="flex",d.style.gap="20px",d.style.marginTop="30px",d.style.flexWrap="wrap",d.style.justifyContent="center",i&&(d.style.flexDirection="column",d.style.alignItems="center");const u=this.createButton("BACK",()=>{this.currentScreen="loadout-select",this.startMenuTransition(),this.renderLoadoutSelectionScreen(this.contentElement)},"#666666");d.appendChild(u),t.appendChild(d),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}createLoadoutSection(t,e,i,s,n,o){const r=document.createElement("div"),a=document.createElement("h3");a.textContent=e,a.style.fontSize=o?"24px":"32px",a.style.color="#00AAFF",a.style.marginBottom="15px",a.style.fontWeight="bold",a.dataset.particleText="true",a.dataset.particleColor="#00AAFF",r.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="10px",i.forEach(t=>{const e=t.id===s,i=document.createElement("div");i.style.padding="15px",i.style.backgroundColor=e?"rgba(0, 170, 255, 0.2)":"rgba(0, 0, 0, 0.3)",i.style.border=e?"2px solid #00AAFF":"2px solid rgba(255, 255, 255, 0.2)",i.style.borderRadius="8px",i.style.cursor="pointer",i.style.transition="all 0.2s";const o=document.createElement("div");o.textContent=t.name,o.style.fontSize="22px",o.style.color=e?"#00AAFF":"#FFFFFF",o.style.fontWeight="bold",o.style.marginBottom="5px",o.dataset.particleText="true",o.dataset.particleColor=e?"#00AAFF":"#FFFFFF",i.appendChild(o);const r=document.createElement("div");r.textContent=t.description,r.style.fontSize="18px",r.style.color="#CCCCCC",i.appendChild(r),i.addEventListener("click",()=>{n(t.id),this.renderLoadoutCustomizationScreen(this.contentElement)}),i.addEventListener("mouseenter",()=>{e||(i.style.backgroundColor="rgba(0, 170, 255, 0.1)",i.style.borderColor="#00AAFF")}),i.addEventListener("mouseleave",()=>{e||(i.style.backgroundColor="rgba(0, 0, 0, 0.3)",i.style.borderColor="rgba(255, 255, 255, 0.2)")}),l.appendChild(i)}),r.appendChild(l),t.appendChild(r)}renderLoadoutSelectionScreen(t){var e;this.clearMenu(),this.setMenuParticleDensity(1.6);const i=window.innerWidth<600;t.style.justifyContent="flex-start";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="flex-start",s.style.width="100%",s.style.maxWidth=i?"100%":"900px",s.style.padding=i?"10px":"10px 0",s.style.alignSelf="center";const n=this.createButton("BACK",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#666666");n.style.fontSize="18px",n.style.padding="8px 18px",s.appendChild(n),t.appendChild(s);const o=document.createElement("div");o.style.width="100%",o.style.maxWidth=i?"100%":"900px",o.style.padding=i?"0 10px":"0",o.style.marginBottom=i?"10px":"12px",t.appendChild(o);const r=[{id:Za.RADIANT,name:"Radiant",description:"Well-Balanced, Ranged-Focused",color:"#FF5722"},{id:Za.AURUM,name:"Aurum",description:"Fast-Paced, Melee-Focused",color:"#FFD700"},{id:Za.VELARIS,name:"Velaris",description:"Strategic, Ability-Heavy. Particles from Nebulae",color:"#9C27B0"}],a=r.findIndex(t=>t.id===this.settings.selectedFaction),l=a>=0?a:0;!this.settings.selectedFaction&&r.length>0&&(this.settings.selectedFaction=r[l].id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection()),this.factionCarousel=new tp(o,r,l),this.factionCarousel.onSelectionChange(t=>{var e;if(this.settings.selectedFaction!==t.id)return this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.ensureDefaultHeroSelection(),void this.renderLoadoutSelectionScreen(this.contentElement);null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}),this.factionCarousel.onRender(()=>{var t;null===(t=this.menuParticleLayer)||void 0===t||t.requestTargetRefresh(this.contentElement)});const h=document.createElement("h2");h.textContent="Select 4 Heroes",h.style.fontSize=i?"26px":"36px",h.style.marginBottom=i?"8px":"12px",h.style.color="#FFD700",h.style.textAlign="center",h.style.maxWidth="100%",h.style.fontWeight="300",h.dataset.particleText="true",h.dataset.particleColor="#FFD700",t.appendChild(h),this.settings.selectedHeroNames=this.getSelectedHeroNames();const c=document.createElement("div");c.textContent=`Selected: ${this.settings.selectedHeroes.length} / 4`,c.style.fontSize=i?"24px":"26px",c.style.marginBottom=i?"20px":"30px",c.style.color=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",c.style.fontWeight="300",c.dataset.particleText="true",c.dataset.particleColor=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",t.appendChild(c);const d=document.createElement("div");d.style.display="grid",d.style.gridTemplateColumns=i?"repeat(2, minmax(0, 1fr))":"repeat(auto-fit, minmax(280px, 1fr))",d.style.gap="15px",d.style.maxWidth="1200px",d.style.padding="20px",d.style.marginBottom="20px",d.style.maxHeight=i?"none":"600px",d.style.overflowY=i?"visible":"auto";const u=this.heroUnits.filter(t=>t.faction===this.settings.selectedFaction);for(const t of u){const e=this.settings.selectedHeroes.includes(t.id),i=e||this.settings.selectedHeroes.length<4,s=document.createElement("div");s.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.border="2px solid transparent",s.style.borderRadius="10px",s.style.padding="15px",s.style.cursor=i?"pointer":"not-allowed",s.style.transition="all 0.3s",s.style.opacity=i?"1":"0.5",s.style.minHeight="300px",s.dataset.particleBox="true",s.dataset.particleColor=e?"#00FF88":"#66B3FF",i&&(s.addEventListener("mouseenter",()=>{e||(s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.transform="scale(1.02)")}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor=e?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.transform="scale(1)"}),s.addEventListener("click",()=>{e?this.settings.selectedHeroes=this.settings.selectedHeroes.filter(e=>e!==t.id):this.settings.selectedHeroes.length<4&&this.settings.selectedHeroes.push(t.id),this.settings.selectedHeroNames=this.getSelectedHeroNames(),this.renderLoadoutSelectionScreen(this.contentElement)}));const n=document.createElement("h4");n.textContent=t.name,n.style.fontSize="24px",n.style.marginBottom="8px",n.style.color=e?"#00FF88":"#E0F2FF",n.style.fontWeight="300",n.dataset.particleText="true",n.dataset.particleColor=e?"#00FF88":"#E0F2FF",s.appendChild(n);const o=document.createElement("p");o.textContent=t.description,o.style.fontSize="24px",o.style.lineHeight="1.4",o.style.color="#AAAAAA",o.style.marginBottom="10px",o.style.fontWeight="300",o.dataset.particleText="true",o.dataset.particleColor="#AAAAAA",s.appendChild(o);const r=document.createElement("div");r.style.fontSize="24px",r.style.lineHeight="1.6",r.style.color="#CCCCCC",r.style.marginBottom="8px",r.style.padding="8px",r.style.backgroundColor="rgba(0, 0, 0, 0.3)",r.style.borderRadius="5px",r.style.fontWeight="300";const a=document.createElement("div");a.textContent=`HP: ${t.maxHealth}`,a.style.color="#CCCCCC",a.style.fontWeight="bold",a.dataset.particleText="true",a.dataset.particleColor="#CCCCCC",r.appendChild(a);const l=document.createElement("div");l.textContent=`RGN: ${t.regen}%`,l.style.color="#CCCCCC",l.style.fontWeight="bold",l.dataset.particleText="true",l.dataset.particleColor="#CCCCCC",r.appendChild(l);const h=document.createElement("div");h.textContent=`DEF: ${t.defense}%`,h.style.color="#CCCCCC",h.style.fontWeight="bold",h.dataset.particleText="true",h.dataset.particleColor="#CCCCCC",r.appendChild(h);const c=document.createElement("div"),u=t.attackIgnoresDefense?" (ignores defense)":"";c.textContent=`ATK: ${t.attackDamage}${u}`,c.style.color="#CCCCCC",c.style.fontWeight="bold",c.dataset.particleText="true",c.dataset.particleColor="#CCCCCC",r.appendChild(c);const p=document.createElement("div");p.textContent=`SPD: ${t.attackSpeed}/s`,p.style.color="#CCCCCC",p.style.fontWeight="bold",p.dataset.particleText="true",p.dataset.particleColor="#CCCCCC",r.appendChild(p);const g=document.createElement("div");g.textContent=`RNG: ${t.attackRange}`,g.style.color="#CCCCCC",g.style.fontWeight="bold",g.dataset.particleText="true",g.dataset.particleColor="#CCCCCC",r.appendChild(g),s.appendChild(r);const y=document.createElement("div");if(y.style.fontSize="24px",y.style.lineHeight="1.4",y.style.color="#FFD700",y.style.marginBottom="8px",y.style.fontStyle="italic",y.style.fontWeight="bold",y.textContent=`${t.abilityDescription}`,y.dataset.particleText="true",y.dataset.particleColor="#FFD700",s.appendChild(y),e){const t=document.createElement("div");t.textContent=" Selected",t.style.fontSize="24px",t.style.marginTop="8px",t.style.color="#00FF88",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#00FF88",s.appendChild(t)}d.appendChild(s)}t.appendChild(d);const p=document.createElement("div");p.style.display="flex",p.style.gap="20px",p.style.marginTop="20px",p.style.flexWrap="wrap",p.style.justifyContent="center",i&&(p.style.flexDirection="column",p.style.alignItems="center");const g=this.createButton("CUSTOMIZE LOADOUT",()=>{this.currentScreen="loadout-customization",this.startMenuTransition(),this.renderLoadoutCustomizationScreen(this.contentElement)},"#00AAFF");if(p.appendChild(g),4===this.settings.selectedHeroes.length){const t=this.createButton("CONFIRM LOADOUT",()=>{this.currentScreen="main",this.startMenuTransition(),this.renderMainScreen(this.contentElement)},"#00FF88");p.appendChild(t)}t.appendChild(p),null===(e=this.menuParticleLayer)||void 0===e||e.requestTargetRefresh(this.contentElement)}createButton(t,e,i="#FFD700"){const s=document.createElement("button");return s.textContent=t,s.style.fontSize="24px",s.style.padding="15px 40px",s.style.backgroundColor="rgba(0, 0, 0, 0.35)",s.style.color="#666666"===i?"#FFFFFF":i,s.style.border="2px solid transparent",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontWeight="300",s.style.fontFamily="inherit",s.style.transition="all 0.3s",s.dataset.particleBox="true",s.dataset.particleColor=i,s.addEventListener("mouseenter",()=>{s.style.backgroundColor="rgba(255, 255, 255, 0.12)",s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor="rgba(0, 0, 0, 0.35)",s.style.transform="scale(1)"}),s.addEventListener("click",e),s}createSettingSection(t,e){const i=document.createElement("div");i.style.marginBottom="30px",i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center";const s=document.createElement("label");return s.textContent=t,s.style.fontSize="24px",s.style.color="#FFFFFF",s.style.fontWeight="300",s.dataset.particleText="true",s.dataset.particleColor="#FFFFFF",i.appendChild(s),i.appendChild(e),i}createSelect(t,e,i){const s=document.createElement("select");s.style.fontSize="24px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontFamily="inherit",s.style.fontWeight="300";for(const i of t){const t=document.createElement("option");t.value=i,t.textContent=i.charAt(0).toUpperCase()+i.slice(1),t.selected=i===e,t.style.backgroundColor=$n,s.appendChild(t)}return s.addEventListener("change",()=>{i(s.value)}),s}createToggle(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="60px",s.style.height="30px",s.style.backgroundColor=t?"#00FF88":"#666666",s.style.borderRadius="15px",s.style.position="relative",s.style.cursor="pointer",s.style.transition="all 0.3s";const n=document.createElement("div");return n.style.width="26px",n.style.height="26px",n.style.backgroundColor="#FFFFFF",n.style.borderRadius="50%",n.style.position="absolute",n.style.top="2px",n.style.left=t?"32px":"2px",n.style.transition="all 0.3s",s.appendChild(n),s.addEventListener("click",()=>{const i=!t;t=i,s.style.backgroundColor=i?"#00FF88":"#666666",n.style.left=i?"32px":"2px",e(i)}),i.appendChild(s),i}createColorPicker(t,e){const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="10px";const s=document.createElement("div");s.style.width="40px",s.style.height="40px",s.style.backgroundColor=t,s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer";const n=document.createElement("input");return n.type="color",n.value=t,n.style.opacity="0",n.style.width="0",n.style.height="0",n.style.position="absolute",n.addEventListener("change",()=>{s.style.backgroundColor=n.value,e(n.value)}),s.addEventListener("click",()=>{n.click()}),i.appendChild(s),i.appendChild(n),i}validateUsername(t){let e=t.trim().substring(0,20);return e.length<1?this.generateRandomUsername():e}createTextInput(t,e,i=""){const s=document.createElement("input");return s.type="text",s.value=t,s.placeholder=i,s.style.fontSize="20px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.fontFamily="inherit",s.style.fontWeight="300",s.style.minWidth="200px",s.maxLength=20,s.style.outline="none",s.addEventListener("blur",()=>{const t=this.validateUsername(s.value);s.value=t,s.style.borderColor="rgba(255, 255, 255, 0.3)",e(t)}),s.addEventListener("focus",()=>{s.style.borderColor="rgba(255, 255, 255, 0.6)"}),s}onStart(t){this.onStartCallback=t}showMatchLoadingScreen(){const t=document.createElement("div");t.id="match-loading-screen",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.backgroundColor="#000011",t.style.zIndex="2000",t.style.display="flex",t.style.flexDirection="column",t.style.justifyContent="flex-start",t.style.alignItems="flex-start",t.style.padding="40px";const e=document.createElement("div");e.style.position="absolute",e.style.top="40px",e.style.left="40px",e.style.fontSize="36px",e.style.color="#FFD700",e.style.fontWeight="300";const i=document.createElement("div");let s="ai"===this.settings.gameMode?"Vs. AI":"lan"===this.settings.gameMode?"LAN":"online"===this.settings.gameMode?"ranked"===this.onlineMode?"Ranked":"Unranked":"Vs. AI";if(i.textContent=s,e.appendChild(i),"online"===this.settings.gameMode&&"ranked"===this.onlineMode){const t=document.createElement("div");t.textContent="MMR: 1000",t.style.fontSize="24px",t.style.marginTop="10px",t.style.color="#D0D0D0",e.appendChild(t);const i=document.createElement("div");i.textContent="Win: +16",i.style.fontSize="20px",i.style.marginTop="8px",i.style.color="#00FF00",e.appendChild(i);const s=document.createElement("div");s.textContent="Loss: -37",s.style.fontSize="20px",s.style.marginTop="4px",s.style.color="#FF6666",e.appendChild(s)}t.appendChild(e);const n=document.createElement("div");n.style.position="absolute",n.style.bottom="40px",n.style.left="40px",n.style.display="flex",n.style.alignItems="center",n.style.gap="20px";const o=document.createElement("img");o.id="match-loading-animation",o.src=this.resolveAssetPath("ASSETS/sprites/loadingScreen/loadingAnimation/frame (1).png"),o.style.width="60px",o.style.height="auto",n.appendChild(o);const r=document.createElement("div");r.textContent="Loading...",r.style.fontSize="24px",r.style.color="#D0D0D0",r.style.fontWeight="300",n.appendChild(r),t.appendChild(n),document.body.appendChild(t);const a=1e3/60;let l=0,h=performance.now(),c=0;const d=t=>{if(!o.parentElement)return;const e=t-h;for(h=t,c+=e;c>=a;)l=(l+1)%25,c-=a;const i=l+1;o.src=this.resolveAssetPath(`ASSETS/sprites/loadingScreen/loadingAnimation/frame (${i}).png`),requestAnimationFrame(d)};requestAnimationFrame(d),setTimeout(()=>{t.remove()},1500)}hide(){this.menuElement.style.display="none",this.pauseMenuAnimations(),this.showMatchLoadingScreen()}show(){this.menuElement.style.display="block",this.currentScreen="main",this.renderMainScreen(this.contentElement),this.resumeMenuAnimations()}destroy(){var t,e,i;this.settings.networkManager&&(this.settings.networkManager.disconnect(),this.settings.networkManager=void 0),this.multiplayerNetworkManager&&(this.multiplayerNetworkManager.disconnect(),this.multiplayerNetworkManager=null),this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.factionCarousel&&(this.factionCarousel.destroy(),this.factionCarousel=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),null===(t=this.backgroundParticleLayer)||void 0===t||t.destroy(),null===(e=this.atmosphereLayer)||void 0===e||e.destroy(),null===(i=this.menuParticleLayer)||void 0===i||i.stop(),this.menuElement.parentNode&&this.menuElement.parentNode.removeChild(this.menuElement)}getSettings(){return this.settings}}class tp{constructor(t,e,i){this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.lastDragDeltaX=0,this.velocity=0,this.hasDragged=!1,this.isCompactLayout=!1,this.resizeHandler=null,this.keydownHandler=null,this.onSelectionChangeCallback=null,this.onRenderCallback=null,this.animationFrameId=null,this.isAnimationActive=!1,this.container=t,this.options=e,this.currentIndex=Math.max(0,Math.min(e.length-1,i)),this.targetIndex=this.currentIndex,this.setupContainer(),this.setupEventHandlers(),this.scrollOffset=-this.currentIndex*this.getItemSpacingPx(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.updateLayoutMetrics(),this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.resizeHandler=()=>{this.updateLayoutMetrics()},window.addEventListener("resize",this.resizeHandler),this.keydownHandler=t=>{const e=t.target;if(e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName))return;const i=t.key.toLowerCase();"arrowleft"!==i&&"a"!==i||(this.moveSelection(-1),t.preventDefault()),"arrowright"!==i&&"d"!==i||(this.moveSelection(1),t.preventDefault())},window.addEventListener("keydown",this.keydownHandler),this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.lastDragDeltaX=0,this.container.style.cursor="grabbing",this.startAnimation()}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.lastDragDeltaX=e,this.scrollOffset=this.dragStartOffset+e,this.velocity=e*tp.VELOCITY_MULTIPLIER,Math.abs(e)>Vn&&(this.hasDragged=!0),this.startAnimation()}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=this.getItemSpacingPx(),i=this.lastDragDeltaX;if(Math.abs(i)>=tp.SWIPE_THRESHOLD_PX){const t=i<0?1:-1;return void this.setCurrentIndex(this.currentIndex+t)}const s=-this.scrollOffset/e,n=Math.round(s+this.velocity*tp.VELOCITY_FACTOR);this.setCurrentIndex(n)}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,n=this.currentIndex+Math.round(s/this.getItemSpacingPx());this.setCurrentIndex(n)}moveSelection(t){this.setCurrentIndex(this.currentIndex+t)}setCurrentIndex(t){const e=Math.max(0,Math.min(this.options.length-1,t));e!==this.currentIndex?(this.targetIndex=e,this.currentIndex=e,this.onSelectionChangeCallback&&this.onSelectionChangeCallback(this.options[this.currentIndex]),this.startAnimation()):this.targetIndex=e}startAnimation(){if(this.isAnimationActive)return;this.isAnimationActive=!0;const t=()=>{if(!this.isAnimationActive)return;const e=this.update();if(this.render(),!e)return this.isAnimationActive=!1,void(this.animationFrameId=null);this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}pauseAnimation(){this.isAnimationActive&&(this.isAnimationActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}resumeAnimation(){this.startAnimation()}updateLayoutMetrics(){this.isCompactLayout=window.innerWidth<600;const t=this.isCompactLayout?"300px":"380px";this.container.style.height!==t&&(this.container.style.height=t)}getLayoutScale(){return this.isCompactLayout?.6:.9}getItemSpacingPx(){return tp.ITEM_SPACING_PX*this.getLayoutScale()}update(){this.updateLayoutMetrics();const t=-this.currentIndex*this.getItemSpacingPx(),e=t-this.scrollOffset;this.scrollOffset+=e*tp.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=tp.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0;const i=!this.isDragging&&Math.abs(this.velocity)<=.1&&Math.abs(e)<.5;return i&&(this.scrollOffset=t),!i}render(){this.container.innerHTML="";const t=this.container.getBoundingClientRect(),e=t.width/2,i=t.height/2,s=this.getLayoutScale(),n=this.getItemSpacingPx(),o=tp.BASE_SIZE_PX*s,r=tp.TEXT_SCALE*s;for(let t=0;t<this.options.length;t++){const a=this.options[t],l=t-this.currentIndex,h=Math.abs(l),c=e+this.scrollOffset+t*n;let d=1,u=1;0===h?(d=1,u=1):1===h?(d=.72,u=.85):2===h?(d=.5,u=.55):(d=Math.max(.3,1-.25*h),u=Math.max(.3,1-.25*h));const p=o*d,g=document.createElement("div");g.style.position="absolute",g.style.left=c-p/2+"px",g.style.top=i-p/2+"px",g.style.width=`${p}px`,g.style.height=`${p}px`,g.style.backgroundColor=0===h?"rgba(12, 14, 22, 0.98)":"rgba(12, 14, 22, 0.85)",g.style.border=0===h?`2px solid ${a.color}`:"2px solid rgba(255, 255, 255, 0.2)",g.style.borderRadius="10px",g.style.opacity=u.toString(),g.style.display="flex",g.style.flexDirection="column",g.style.justifyContent="center",g.style.alignItems="center",g.style.pointerEvents="none",g.style.color="#FFFFFF",g.style.fontWeight="300",g.style.textAlign="center",g.style.padding=24*s+"px",g.style.boxSizing="border-box",g.style.zIndex=(100-h).toString(),g.style.overflow="hidden",g.dataset.particleBox="true",g.dataset.particleColor=0===h?a.color:"#66B3FF";const y=document.createElement("div");if(y.textContent=a.name.toUpperCase(),y.style.fontSize=Math.max(16,20*d)*r+"px",y.style.marginBottom=0===h?"14px":"0",y.style.color=0===h?"#FFFFFF":"#E0F2FF",y.style.fontWeight="300",y.dataset.particleText="true",y.dataset.particleColor=0===h?"#FFFFFF":"#E0F2FF",g.appendChild(y),0===h){const t=document.createElement("div");t.textContent=a.description,t.style.fontSize=Math.max(10,12*d)*r+"px",t.style.color="#D0D0D0",t.style.lineHeight="1.4",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#D0D0D0",g.appendChild(t)}this.container.appendChild(g)}this.onRenderCallback&&this.onRenderCallback()}onSelectionChange(t){this.onSelectionChangeCallback=t}onRender(t){this.onRenderCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler)}}tp.ITEM_SPACING_PX=210,tp.BASE_SIZE_PX=224,tp.TEXT_SCALE=2.4,tp.VELOCITY_MULTIPLIER=.1,tp.VELOCITY_FACTOR=.001,tp.SMOOTH_INTERPOLATION_FACTOR=.15,tp.VELOCITY_DECAY_FACTOR=.9,tp.SWIPE_THRESHOLD_PX=50;class ep{constructor(t,e,i=0,s="transparent"){this.currentIndex=0,this.targetIndex=0,this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.lastDragDeltaX=0,this.velocity=0,this.onSelectCallback=null,this.onRenderCallback=null,this.onNavigateCallback=null,this.animationFrameId=null,this.isAnimationActive=!1,this.hasDragged=!1,this.isCompactLayout=!1,this.resizeHandler=null,this.container=t,this.options=e,this.optionBackgroundColor=s;const n=Math.max(0,Math.min(i,e.length-1));this.currentIndex=n,this.targetIndex=n,this.setupContainer(),this.setupEventHandlers(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.updateLayoutMetrics(),this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.resizeHandler=()=>{this.updateLayoutMetrics()},window.addEventListener("resize",this.resizeHandler),this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const e=t.changedTouches[0];this.endDrag(e.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.lastDragDeltaX=0,this.container.style.cursor="grabbing",this.startAnimation()}updateDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX;this.lastDragDeltaX=e,this.scrollOffset=this.dragStartOffset+e,this.velocity=e*ep.VELOCITY_MULTIPLIER,Math.abs(e)>Vn&&(this.hasDragged=!0),this.startAnimation()}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const e=this.getItemWidthPx(),i=this.lastDragDeltaX;if(Math.abs(i)>=ep.SWIPE_THRESHOLD_PX){const t=i<0?1:-1,e=Math.max(0,Math.min(this.options.length-1,this.currentIndex+t));return void this.setCurrentIndex(e)}const s=-this.scrollOffset/e;let n=Math.round(s+this.velocity*ep.VELOCITY_FACTOR);n=Math.max(0,Math.min(this.options.length-1,n)),this.setCurrentIndex(n)}handleClick(t){const e=this.container.getBoundingClientRect(),i=e.width/2,s=t-e.left-i,n=this.currentIndex+Math.round(s/this.getItemWidthPx()),o=Math.max(0,Math.min(this.options.length-1,n));o===this.currentIndex?this.onSelectCallback&&this.onSelectCallback(this.options[this.currentIndex]):this.setCurrentIndex(o)}setCurrentIndex(t){t!==this.currentIndex?(this.targetIndex=t,this.currentIndex=t,this.onNavigateCallback&&this.onNavigateCallback(t),this.startAnimation()):this.targetIndex=t}startAnimation(){if(this.isAnimationActive)return;this.isAnimationActive=!0;const t=()=>{if(!this.isAnimationActive)return;const e=this.update();if(this.render(),!e)return this.isAnimationActive=!1,void(this.animationFrameId=null);this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}pauseAnimation(){this.isAnimationActive&&(this.isAnimationActive=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}resumeAnimation(){this.startAnimation()}updateLayoutMetrics(){const t=window.innerWidth<600;this.isCompactLayout=t;const e=this.getLayoutScale(),i=ep.BASE_SIZE*e,s=120*e,n=`${Math.round(i+s)}px`;this.container.style.height!==n&&(this.container.style.height=n)}getLayoutScale(){return this.isCompactLayout?.5:1}getItemWidthPx(){return ep.ITEM_WIDTH*this.getLayoutScale()}update(){this.updateLayoutMetrics();const t=-this.currentIndex*this.getItemWidthPx(),e=t-this.scrollOffset;this.scrollOffset+=e*ep.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=ep.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0;const i=!this.isDragging&&Math.abs(this.velocity)<=.1&&Math.abs(e)<.5;return i&&(this.scrollOffset=t),!i}render(){var t,e;this.container.innerHTML="";const i=this.container.getBoundingClientRect(),s=i.width/2,n=i.height/2,o=this.getLayoutScale(),r=this.getItemWidthPx(),a=ep.BASE_SIZE*o,l=ep.TEXT_SCALE*o;for(let i=0;i<this.options.length;i++){const o=this.options[i],h=i-this.currentIndex,c=Math.abs(h),d=s+this.scrollOffset+i*r;let u=1,p=1;0===c?(u=1,p=1):1===c?(u=.75,p=.75):2===c?(u=.5,p=.5):(u=Math.max(.25,1-.25*c),p=Math.max(.25,1-.25*c));const g=a*u,y=document.createElement("div");y.style.position="absolute",y.style.left=d-g/2+"px",y.style.top=n-g/2+"px",y.style.width=`${g}px`,y.style.height=`${g}px`,y.style.backgroundColor=this.optionBackgroundColor,y.style.border="2px solid transparent",y.style.borderRadius="10px",y.style.opacity=p.toString(),y.style.transition="background-color 0.2s",y.style.display="flex",y.style.flexDirection="column",y.style.justifyContent="center",y.style.alignItems="center",y.style.pointerEvents="none",y.style.color="#000000",y.style.fontWeight="300",y.style.textAlign="center",y.style.padding="30px",y.style.boxSizing="border-box",y.dataset.particleBox="true",y.dataset.particleColor=0===c?"#FFD700":"#00AAFF";const f=document.createElement("div");if(f.textContent=o.name,f.style.fontSize=Math.max(14,18*u)*l+"px",f.style.marginBottom=o.subLabel?"6px":"15px",f.style.color=0===c?"#FFF5C2":"#E2F4FF",f.style.fontWeight="300",f.dataset.particleText="true",f.dataset.particleColor=0===c?"#FFF5C2":"#E2F4FF",y.appendChild(f),o.subLabel){const i=document.createElement("div");i.textContent=o.subLabel,i.style.fontSize=Math.max(10,12*u)*l+"px",i.style.marginBottom="10px",i.style.color=null!==(t=o.subLabelColor)&&void 0!==t?t:"#D0D0D0",i.style.fontWeight="300",i.dataset.particleText="true",i.dataset.particleColor=null!==(e=o.subLabelColor)&&void 0!==e?e:"#D0D0D0",y.appendChild(i)}if(0===c){const t=document.createElement("div");t.textContent=o.description,t.style.fontSize=Math.max(10,12*u)*l+"px",t.style.color="#D0D0D0",t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.fontWeight="300",t.dataset.particleText="true",t.dataset.particleColor="#D0D0D0",y.appendChild(t)}this.container.appendChild(y)}this.onRenderCallback&&this.onRenderCallback()}onSelect(t){this.onSelectCallback=t}onRender(t){this.onRenderCallback=t}onNavigate(t){this.onNavigateCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler)}}ep.ITEM_WIDTH=260,ep.BASE_SIZE=220,ep.TEXT_SCALE=2,ep.VELOCITY_MULTIPLIER=.1,ep.VELOCITY_FACTOR=.001,ep.SMOOTH_INTERPOLATION_FACTOR=.15,ep.VELOCITY_DECAY_FACTOR=.9,ep.SWIPE_THRESHOLD_PX=50;const ip=[{key:"centralSun",label:"Central Sun",svgPath:"ASSETS/sprites/environment/centralSun.svg",pngPath:"ASSETS/sprites/environment/centralSun.png"},{key:"stellarForge",label:"Stellar Forge Base",svgPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantBaseType1.svg",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantBaseType1.png"},{key:"forgeFlameHot",label:"Forge Flame (Hot)",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantForgeFlame.png"},{key:"forgeFlameCold",label:"Forge Flame (Cold)",pngPath:"ASSETS/sprites/RADIANT/stellarForgeBases/radiantForgeFlameCold.png"},{key:"solarMirror",label:"Solar Mirror",svgPath:"ASSETS/sprites/RADIANT/solarMirrors/radiantSolarMirror.svg",pngPath:"ASSETS/sprites/RADIANT/solarMirrors/radiantSolarMirror.png"},{key:"starling",label:"Starling",svgPath:"ASSETS/sprites/RADIANT/starlings/starlingLevel (1).svg",pngPath:"ASSETS/sprites/RADIANT/starlings/starlingLevel (1).png"},{key:"heroMarine",label:"Hero: Marine",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Marine.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Marine.png"},{key:"heroGrave",label:"Hero: Grave",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Grave.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Grave.png"},{key:"heroRay",label:"Hero: Ray",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Ray.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Ray.png"},{key:"heroNova",label:"Hero: Nova",svgPath:"ASSETS/sprites/VELARIS/heroUnits/Nova.svg",pngPath:"ASSETS/sprites/VELARIS/heroUnits/Nova.png"},{key:"heroInfluenceBall",label:"Hero: Influence Ball",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Uniter.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Uniter.png"},{key:"heroTurretDeployer",label:"Hero: Turret Deployer",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Engineer.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Engineer.png"},{key:"heroDriller",label:"Hero: Driller",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Drill.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Drill.png"},{key:"heroDagger",label:"Hero: Dagger",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Dagger.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Dagger.png"},{key:"heroBeam",label:"Hero: Beam",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Beam.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Beam.png"},{key:"heroPreist",label:"Hero: Preist",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Preist.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Preist.png"},{key:"heroTank",label:"Hero: Tank",svgPath:"ASSETS/sprites/RADIANT/heroUnits/Tank.svg",pngPath:"ASSETS/sprites/RADIANT/heroUnits/Tank.png"}];class sp{constructor(t){this.camera=new i(0,0),this.parallaxCamera=new i(0,0),this.zoom=1,this.selectionStart=null,this.selectionEnd=null,this.abilityArrowStarts=[],this.abilityArrowDirection=null,this.abilityArrowLengthPx=0,this.buildingAbilityArrowStart=null,this.buildingAbilityArrowDirection=null,this.buildingAbilityArrowLengthPx=0,this.highlightedButtonIndex=-1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedWarpGate=null,this.pathPreviewForge=null,this.pathPreviewPoints=[],this.pathPreviewEnd=null,this.selectedHeroNames=[],this.hasSeenFoundry=!1,this.hasActiveFoundry=!1,this.isWarpGatePlacementMode=!1,this.canCreateWarpGateFromMirrors=!1,this.tapEffects=[],this.swipeEffects=[],this.warpGateShockwaves=[],this.productionButtonWaves=[],this.viewingPlayer=null,this.showInfo=!1,this.showInGameMenu=!1,this.isPaused=!1,this.playerColor=r,this.enemyColor=a,this.colorScheme=dh.SpaceBlack,this.inGameMenuTab="main",this.damageDisplayMode="damage",this.healthDisplayMode="bar",this.graphicsQuality="high",this.isFancyGraphicsEnabled=!1,this.screenShakeEnabled=!0,this.offscreenIndicatorOpacity=.25,this.infoBoxOpacity=.5,this.screenShakeIntensity=0,this.screenShakeTimer=0,this.shakenExplosions=new WeakSet,this.colorblindMode=!0,this.HERO_SPRITE_SCALE=4.2,this.FORGE_SPRITE_SCALE=2.64,this.AURUM_EDGE_DETECTION_FILL_COLOR="white",this.AURUM_EDGE_ALPHA_THRESHOLD=128,this.AURUM_SEED_BASE_MULTIPLIER=1e3,this.AURUM_FORGE_SEED_MULTIPLIER=137.5,this.AURUM_FOUNDRY_SEED_MULTIPLIER=157.3,this.VELARIS_FORGE_PARTICLE_COUNT=180,this.VELARIS_FORGE_PARTICLE_SPEED_UNITS_PER_SEC=.28,this.VELARIS_FORGE_PARTICLE_RADIUS_PX=1.6,this.VELARIS_FORGE_SCRIPT_SCALE=1.15,this.VELARIS_FORGE_MAIN_GRAPHEME_LETTER="V",this.VELARIS_FORGE_MAIN_GRAPHEME_SCALE=2.05,this.VELARIS_FOUNDRY_GRAPHEME_LETTER="F",this.VELARIS_FOUNDRY_PARTICLE_COUNT=26,this.VELARIS_FOUNDRY_PARTICLE_RADIUS_PX=1.2,this.VELARIS_FOUNDRY_PARTICLE_ORBIT_SPEED_RAD_PER_SEC=.8,this.VELARIS_WARP_GATE_PARTICLE_COUNT=120,this.VELARIS_WARP_GATE_PARTICLE_BASE_SPEED=.55,this.VELARIS_WARP_GATE_PARTICLE_SWIRL_TIGHTNESS=2.4,this.VELARIS_WARP_GATE_PARTICLE_CENTER_FADE=.18,this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS=["ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-A.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-B.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-C.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-D.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-E.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-F.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-G.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-H.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-I.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-J.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-K.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-L.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-M.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-N.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-O.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-P.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-Q.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-R.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-S.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-T.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-U.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-V.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-W.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-X.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-Y.png","ASSETS/sprites/VELARIS/velarisAncientScript/grapheme-Z.png"],this.VELARIS_MIRROR_WORD="VELARIS",this.VELARIS_MIRROR_CLOUD_GLYPH_COUNT=18,this.VELARIS_MIRROR_CLOUD_PARTICLE_COUNT=12,this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT=10,this.VELARIS_MIRROR_PARTICLE_TIME_SCALE=.35,this.VELARIS_MIRROR_PARTICLE_DRIFT_SPEED=.7,this.VELARIS_STARLING_PARTICLE_COUNT=24,this.VELARIS_STARLING_PARTICLE_RADIUS_PX=1.2,this.VELARIS_STARLING_CLOUD_RADIUS_SCALE=2.1,this.VELARIS_STARLING_TRIANGLE_RADIUS_SCALE=2.5,this.VELARIS_STARLING_PENTAGON_RADIUS_SCALE=2.7,this.VELARIS_STARLING_TRIANGLE_WOBBLE_SCALE=.08,this.VELARIS_STARLING_CLOUD_SWIRL_SCALE=.45,this.VELARIS_STARLING_TRIANGLE_FLOW_SPEED=.08,this.VELARIS_STARLING_TRIANGLE_WOBBLE_SPEED=2.2,this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_BASE=.35,this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_VARIANCE=.55,this.VELARIS_STARLING_CLOUD_PULL_SPEED=.6,this.VELARIS_STARLING_CLOUD_TIME_SCALE=.28,this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_BASE=.35,this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_RANGE=.25,this.VELARIS_STARLING_SHAPE_BLEND_SPEED=1.4,this.VELARIS_STARLING_GRAPHEME_ALPHA_MAX=.3,this.VELARIS_STARLING_GRAPHEME_PULSE_SPEED=1.4,this.VELARIS_STARLING_GRAPHEME_SIZE_SCALE=1.15,this.spriteImageCache=new Map,this.tintedSpriteCache=new Map,this.graphemeMaskCache=new Map,this.forgeFlameStates=new Map,this.velarisForgeScriptStates=new Map,this.starlingParticleStates=new WeakMap,this.starlingParticleSeeds=new WeakMap,this.velarisMirrorSeeds=new WeakMap,this.velarisFoundrySeeds=new WeakMap,this.aurumForgeShapeStates=new WeakMap,this.aurumFoundryShapeStates=new WeakMap,this.aurumOffscreenCanvas=null,this.velarisWarpGateSeeds=new WeakMap,this.solEnergyIcon=null,this.viewMinX=0,this.viewMaxX=0,this.viewMinY=0,this.viewMaxY=0,this.graphicsOptionByKey=new Map,this.graphicsVariantByKey=new Map,this.graphicsMenuScrollOffset=0,this.graphicsOptions=ip,this.MOVE_ORDER_DOT_RADIUS=8.4,this.MOVE_ORDER_FRAME_DURATION_MS=1e3/Pt,this.MOVE_ORDER_FALLBACK_SPRITE_PATH="ASSETS/sprites/interface/movementPoint.png",this.FORGE_MAX_HEALTH=1e3,this.MIRROR_MAX_HEALTH=Zt,this.starLayers=[],this.movementPointFramePaths=[],this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context from canvas");this.ctx=e,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.initializeStarLayers();const s=["stellarForge","solarMirror"];for(const t of this.graphicsOptions){this.graphicsOptionByKey.set(t.key,t);const e=t.svgPath?"svg":t.pngPath?"png":"stub",i=s.includes(t.key)&&t.pngPath;this.graphicsVariantByKey.set(t.key,i?"png":e)}for(let t=1;t<=vt;t++)this.movementPointFramePaths.push(`ASSETS/sprites/interface/movementPointAnimation/movementPoint_frame${t}.png`)}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t)}initializeStarLayers(){let t=42;const e=()=>(t=(9301*t+49297)%233280,t/233280);for(const t of Bt){const i=[];for(let s=0;s<t.count;s++)i.push({x:e()*Nt-Nt/2,y:e()*Nt-Nt/2,size:t.sizeRange[0]+e()*(t.sizeRange[1]-t.sizeRange[0]),brightness:.15+.55*e()});this.starLayers.push({stars:i,parallaxFactor:t.parallaxFactor})}}worldToScreen(t){const e=window.devicePixelRatio||1,s=this.canvas.width/e/2,n=this.canvas.height/e/2;let o=0,r=0;if(this.screenShakeEnabled&&this.screenShakeIntensity>0){const t=Math.random()*Math.PI*2;o=Math.cos(t)*this.screenShakeIntensity,r=Math.sin(t)*this.screenShakeIntensity}return new i(s+(t.x-this.camera.x)*this.zoom+o,n+(t.y-this.camera.y)*this.zoom+r)}isWithinRenderBounds(t,e,i=0){const s=e/2;return t.x>=-s-i&&t.x<=s+i&&t.y>=-s-i&&t.y<=s+i}updateViewBounds(){const t=window.devicePixelRatio||1,e=this.canvas.width/t/(2*this.zoom),i=this.canvas.height/t/(2*this.zoom);this.viewMinX=this.camera.x-e,this.viewMaxX=this.camera.x+e,this.viewMinY=this.camera.y-i,this.viewMaxY=this.camera.y+i}isWithinViewBounds(t,e=0){return t.x>=this.viewMinX-e&&t.x<=this.viewMaxX+e&&t.y>=this.viewMinY-e&&t.y<=this.viewMaxY+e}screenToWorld(t,e){const s=window.devicePixelRatio||1,n=this.canvas.width/s/2,o=this.canvas.height/s/2;return new i(this.camera.x+(t-n)/this.zoom,this.camera.y+(e-o)/this.zoom)}getFactionColor(t){switch(t){case Za.RADIANT:return"#FFD700";case Za.AURUM:return"#DAA520";case Za.VELARIS:return"#9C27B0";default:return"#FFFFFF"}}getLadPlayerColor(t,e,i){return e&&t.stellarForge?"light"===i.getLadSide(t.stellarForge.position,e)?"#FFFFFF":"#000000":null!==this.viewingPlayer&&t!==this.viewingPlayer?this.enemyColor:this.playerColor}getSpriteImage(t){const e=this.resolveAssetPath(t),i=this.spriteImageCache.get(e);if(i)return i;const s=new Image;return s.src=e,this.spriteImageCache.set(e,s),s}getSolEnergyIcon(){return this.solEnergyIcon||(this.solEnergyIcon=this.getSpriteImage("ASSETS/sprites/interface/SoL_icon.png")),this.solEnergyIcon}getTintedSprite(t,e){const i=this.resolveAssetPath(t),s=`${i}|${e}`,n=this.tintedSpriteCache.get(s);if(n)return n;const o=this.getSpriteImage(i);if(!o.complete||0===o.naturalWidth||0===o.naturalHeight)return null;const r=document.createElement("canvas");r.width=o.naturalWidth,r.height=o.naturalHeight;const a=r.getContext("2d");return a?(a.drawImage(o,0,0),a.globalCompositeOperation="multiply",a.fillStyle=e,a.fillRect(0,0,r.width,r.height),a.globalCompositeOperation="destination-in",a.drawImage(o,0,0),a.globalCompositeOperation="source-over",this.tintedSpriteCache.set(s,r),r):null}getVelarisGraphemeSpritePath(t){if(!t)return null;const e=t.toUpperCase().charCodeAt(0)-65;return e<0||e>=this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS.length?null:this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS[e]}getGraphemeMaskData(t){const e=this.resolveAssetPath(t),i=this.graphemeMaskCache.get(e);if(i)return i;const s=this.getSpriteImage(e);if(!s.complete||0===s.naturalWidth||0===s.naturalHeight)return null;const n=document.createElement("canvas");n.width=s.naturalWidth,n.height=s.naturalHeight;const o=n.getContext("2d");if(!o)return null;o.drawImage(s,0,0);const r=o.getImageData(0,0,n.width,n.height);return this.graphemeMaskCache.set(e,r),r}isPointInsideGraphemeMask(t,e,i){const s=i.width,n=i.height,o=Math.round((t+.5)*(s-1)),r=Math.round((e+.5)*(n-1));return!(o<0||o>=s||r<0||r>=n)&&i.data[4*(r*s+o)+3]>24}drawVelarisGraphemeSprite(t,e,i,s,n){const o=this.getTintedSprite(t,n);if(!o)return!1;const r=s/Math.max(o.width,o.height),a=o.width*r,l=o.height*r;return this.ctx.drawImage(o,e-a/2,i-l/2,a,l),!0}resolveAssetPath(t){return t.startsWith("ASSETS/")&&window.location.pathname.includes("/dist/")?`../${t}`:t}getGraphicVariant(t){var e;return null!==(e=this.graphicsVariantByKey.get(t))&&void 0!==e?e:"stub"}setGraphicsVariant(t,e){this.graphicsVariantByKey.set(t,e)}setInGameMenuTab(t){this.inGameMenuTab=t}getGraphicAssetPath(t){var e,i;const s=this.graphicsOptionByKey.get(t);if(!s)return null;const n=this.getGraphicVariant(t);return"svg"===n?null!==(e=s.svgPath)&&void 0!==e?e:null:"png"===n&&null!==(i=s.pngPath)&&void 0!==i?i:null}getForgeSpritePath(t){return t.owner.faction===Za.RADIANT?this.getGraphicAssetPath("stellarForge"):null}getSolarMirrorSpritePath(t){return t.owner.faction===Za.RADIANT?this.getGraphicAssetPath("solarMirror"):null}getStarlingSpritePath(t){return t.owner.faction===Za.RADIANT?`ASSETS/sprites/RADIANT/starlings/starlingLevel (${Math.min(4,Math.max(1,t.spriteLevel))}).png`:null}getStarlingFacingRotationRad(t){if(t.rallyPoint&&t.position.distanceTo(t.rallyPoint)>Sn)return t.rotation;if(t.target&&"position"in t.target&&(!("health"in t.target)||t.target.health>0)){const e=t.target.position,i=e.x-t.position.x,s=e.y-t.position.y;if(0!==i||0!==s)return Math.atan2(s,i)+Math.PI/2}return t.rotation}getForgeFlameState(t,e){let i=this.forgeFlameStates.get(t);if(!i)return i={warmth:t.isReceivingLight?1:0,rotationRad:t.rotation,lastGameTime:e},this.forgeFlameStates.set(t,i),i;const s=Math.max(0,e-i.lastGameTime);i.lastGameTime=e;const n=t.isReceivingLight?1:0;if(n>i.warmth?i.warmth=Math.min(1,i.warmth+ii*s):n<i.warmth&&(i.warmth=Math.max(0,i.warmth-ii*s)),t.isReceivingLight){const e=t.getCurrentCrunch(),n=e&&e.isActive()?2:1;i.rotationRad+=ei*n*s,i.rotationRad>=2*Math.PI&&(i.rotationRad-=2*Math.PI)}return i}getVelarisForgeScriptState(t,e){let i=this.velarisForgeScriptStates.get(t);if(i)return i;const s=this.VELARIS_FORGE_PARTICLE_COUNT,n=new Float32Array(s),o=new Float32Array(s),r=new Float32Array(s),a=new Float32Array(s),l=this.getVelarisGraphemeSpritePath(this.VELARIS_FORGE_MAIN_GRAPHEME_LETTER),h=l?this.getGraphemeMaskData(l):null;for(let t=0;t<s;t++){let e=0,i=0,s=0;for(;e<40&&(i=Math.random()-.5,s=Math.random()-.5,h&&!this.isPointInsideGraphemeMask(i,s,h));)e++;n[t]=i,o[t]=s;const l=Math.random()*Math.PI*2,c=this.VELARIS_FORGE_PARTICLE_SPEED_UNITS_PER_SEC*(.6+.8*Math.random());r[t]=Math.cos(l)*c,a[t]=Math.sin(l)*c}return i={positionsX:n,positionsY:o,velocitiesX:r,velocitiesY:a,lastGameTime:e},this.velarisForgeScriptStates.set(t,i),i}updateVelarisForgeParticles(t,e,i){if(e<=0)return;const s=t.positionsX.length;for(let n=0;n<s;n++){const s=t.positionsX[n],o=t.positionsY[n];let r=s+t.velocitiesX[n]*e,a=o+t.velocitiesY[n]*e;if((i?!this.isPointInsideGraphemeMask(r,a,i):Math.abs(r)>.5||Math.abs(a)>.5)&&(t.velocitiesX[n]=-t.velocitiesX[n],t.velocitiesY[n]=-t.velocitiesY[n],r=s+t.velocitiesX[n]*e,a=o+t.velocitiesY[n]*e,i?!this.isPointInsideGraphemeMask(r,a,i):Math.abs(r)>.5||Math.abs(a)>.5))if(i){let t=0,e=s,n=o;for(;t<20&&(e=Math.random()-.5,n=Math.random()-.5,!this.isPointInsideGraphemeMask(e,n,i));)t++;r=e,a=n}else r=s,a=o;t.positionsX[n]=r,t.positionsY[n]=a}}drawVelarisForgeScript(t,e,i,s,n,o){const r=i*this.VELARIS_FORGE_SCRIPT_SCALE,a=this.getVelarisGraphemeSpritePath(this.VELARIS_FORGE_MAIN_GRAPHEME_LETTER),l=a?this.getGraphemeMaskData(a):null,h=this.getVelarisForgeScriptState(t,n),c=Math.min(.05,Math.max(0,n-h.lastGameTime));h.lastGameTime=n,this.updateVelarisForgeParticles(h,c,l);const d=Math.max(1,this.VELARIS_FORGE_PARTICLE_RADIUS_PX*this.zoom),u=o?.45:.75,p=o?.5:.8,g=r*this.VELARIS_FORGE_MAIN_GRAPHEME_SCALE;a&&(this.ctx.save(),this.ctx.globalAlpha=p,this.drawVelarisGraphemeSprite(a,e.x,e.y,g,s),this.ctx.restore()),this.ctx.save(),this.ctx.globalAlpha=u,this.ctx.fillStyle=s;const y=h.positionsX.length;for(let t=0;t<y;t++){const i=e.x+h.positionsX[t]*g,s=e.y+h.positionsY[t]*g;this.ctx.beginPath(),this.ctx.arc(i,s,d,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawVelarisFoundrySigil(t,e,i,s,n,o){const r=this.getVelarisGraphemeSpritePath(this.VELARIS_FOUNDRY_GRAPHEME_LETTER),a=1.55*i,l=Math.max(1,this.VELARIS_FOUNDRY_PARTICLE_RADIUS_PX*this.zoom),h=Boolean(t.currentProduction)?2.6:1,c=this.VELARIS_FOUNDRY_PARTICLE_ORBIT_SPEED_RAD_PER_SEC*h,d=this.getVelarisFoundrySeed(t),u=2*Math.PI,p=.62*a,g=o?.5:.85,y=o?.35:.7;r&&(this.ctx.save(),this.ctx.globalAlpha=g,this.drawVelarisGraphemeSprite(r,e.x,e.y,a,s),this.ctx.restore()),this.ctx.save(),this.ctx.globalAlpha=y,this.ctx.fillStyle=s;for(let t=0;t<this.VELARIS_FOUNDRY_PARTICLE_COUNT;t++){const i=this.getPseudoRandom(d+1.37*t)*u,s=p*(.75+.4*this.getPseudoRandom(d+2.11*t)),o=i+n*c+.5*this.getPseudoRandom(d+3.07*t),r=e.x+Math.cos(o)*s,a=e.y+Math.sin(o)*s;this.ctx.beginPath(),this.ctx.arc(r,a,l,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawVelarisWarpGateVortex(t,e,i,s,n){const o=2*Math.PI,r=this.getVelarisWarpGateSeed(t),a=Math.max(1,1.35*this.zoom);this.ctx.save(),this.ctx.strokeStyle=n,this.ctx.lineWidth=3,this.ctx.globalAlpha=.65,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,o),this.ctx.stroke(),this.ctx.restore(),this.ctx.save(),this.ctx.fillStyle=n;for(let t=0;t<this.VELARIS_WARP_GATE_PARTICLE_COUNT;t++){const n=r+.83*t,l=(s*this.VELARIS_WARP_GATE_PARTICLE_BASE_SPEED+this.getPseudoRandom(n))%1,h=1-l,c=Math.max(0,(h-this.VELARIS_WARP_GATE_PARTICLE_CENTER_FADE)/(1-this.VELARIS_WARP_GATE_PARTICLE_CENTER_FADE));if(c<=0)continue;const d=this.getPseudoRandom(n+2.4)*o+.9*s+l*this.VELARIS_WARP_GATE_PARTICLE_SWIRL_TIGHTNESS*o,u=i*h,p=e.x+Math.cos(d)*u,g=e.y+Math.sin(d)*u;this.ctx.globalAlpha=.9*c,this.ctx.beginPath(),this.ctx.arc(p,g,a,0,o),this.ctx.fill()}this.ctx.restore()}detectAndDrawEdges(t,e,i,s,n,o){const r=t.data;this.ctx.save(),this.ctx.strokeStyle=o,this.ctx.shadowColor=o,this.ctx.shadowBlur=10,this.ctx.lineWidth=2,this.ctx.fillStyle=o;for(let t=1;t<i-1;t++)for(let i=1;i<e-1;i++)r[4*(t*e+i)+3]>this.AURUM_EDGE_ALPHA_THRESHOLD&&(r[4*((t-1)*e+i)+3]<this.AURUM_EDGE_ALPHA_THRESHOLD||r[4*((t+1)*e+i)+3]<this.AURUM_EDGE_ALPHA_THRESHOLD||r[4*(t*e+(i-1))+3]<this.AURUM_EDGE_ALPHA_THRESHOLD||r[4*(t*e+(i+1))+3]<this.AURUM_EDGE_ALPHA_THRESHOLD)&&this.ctx.fillRect(s+i,n+t,1,1);this.ctx.restore()}drawAurumForgeOutline(t,e,i,s,n){const o=this.getAurumForgeShapeState(t,n),r=n-o.lastGameTime;o.lastGameTime=n,o.shapes.forEach(t=>{t.angle+=t.speed*r});const a=2*i,l=Math.max(0,Math.floor(e.x-a)),h=Math.min(this.canvas.width,Math.ceil(e.x+a)),c=Math.max(0,Math.floor(e.y-a)),d=Math.min(this.canvas.height,Math.ceil(e.y+a)),u=h-l,p=d-c;this.aurumOffscreenCanvas||(this.aurumOffscreenCanvas=document.createElement("canvas"));const g=this.aurumOffscreenCanvas;g.width=u,g.height=p;const y=g.getContext("2d");y.clearRect(0,0,u,p),y.fillStyle=this.AURUM_EDGE_DETECTION_FILL_COLOR,o.shapes.forEach(t=>{const s=i*t.size,n=Math.cos(t.angle)*i*t.offset,o=Math.sin(t.angle)*i*t.offset,r=e.x+n-l,a=e.y+o-c;y.save(),y.translate(r,a),y.rotate(t.angle),y.fillRect(-s/2,-s/2,s,s),y.restore()});const f=y.getImageData(0,0,u,p);this.detectAndDrawEdges(f,u,p,l,c,s)}drawAurumFoundryOutline(t,e,i,s,n){const o=this.getAurumFoundryShapeState(t,n),r=n-o.lastGameTime;o.lastGameTime=n,o.shapes.forEach(t=>{t.angle+=t.speed*r});const a=2*i,l=Math.max(0,Math.floor(e.x-a)),h=Math.min(this.canvas.width,Math.ceil(e.x+a)),c=Math.max(0,Math.floor(e.y-a)),d=Math.min(this.canvas.height,Math.ceil(e.y+a)),u=h-l,p=d-c;this.aurumOffscreenCanvas||(this.aurumOffscreenCanvas=document.createElement("canvas"));const g=this.aurumOffscreenCanvas;g.width=u,g.height=p;const y=g.getContext("2d");y.clearRect(0,0,u,p),y.fillStyle=this.AURUM_EDGE_DETECTION_FILL_COLOR,o.shapes.forEach(t=>{const s=i*t.size,n=Math.cos(t.angle)*i*t.offset,o=Math.sin(t.angle)*i*t.offset,r=e.x+n-l,a=e.y+o-c;y.save(),y.translate(r,a),y.rotate(t.angle),y.beginPath();for(let t=0;t<3;t++){const e=t/3*Math.PI*2-Math.PI/2,i=Math.cos(e)*s,n=Math.sin(e)*s;0===t?y.moveTo(i,n):y.lineTo(i,n)}y.closePath(),y.fill(),y.restore()});const f=y.getImageData(0,0,u,p);this.detectAndDrawEdges(f,u,p,l,c,s)}getHeroSpritePath(t){return t.owner.faction!==Za.RADIANT?null:t instanceof Fl?this.getGraphicAssetPath("heroMarine"):t instanceof kl?this.getGraphicAssetPath("heroGrave"):t instanceof jl?this.getGraphicAssetPath("heroDagger"):t instanceof Kl?this.getGraphicAssetPath("heroBeam"):t instanceof Yl?this.getGraphicAssetPath("heroMortar"):t instanceof Bl?this.getGraphicAssetPath("heroRay"):t instanceof eh?this.getGraphicAssetPath("heroNova"):t instanceof Gl?this.getGraphicAssetPath("heroInfluenceBall"):t instanceof $l?this.getGraphicAssetPath("heroTurretDeployer"):t instanceof zl?this.getGraphicAssetPath("heroDriller"):t instanceof ql?this.getGraphicAssetPath("heroPreist"):t instanceof Zl?this.getGraphicAssetPath("heroTank"):t instanceof Ql?this.getGraphicAssetPath("heroBeam"):null}darkenColor(t,e){const i=Math.max(0,Math.min(1,e));let s=t.replace("#","");3===s.length&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]);const n=parseInt(s.substring(0,2),16)||0,o=parseInt(s.substring(2,4),16)||0,r=parseInt(s.substring(4,6),16)||0,a=Math.floor(Math.min(255,n*i)),l=Math.floor(Math.min(255,o*i)),h=Math.floor(Math.min(255,r*i));return"#"+a.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+h.toString(16).padStart(2,"0")}adjustColorBrightness(t,e){let i=t.replace("#","");3===i.length&&(i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]);const s=parseInt(i.substring(0,2),16)||0,n=parseInt(i.substring(2,4),16)||0,o=parseInt(i.substring(4,6),16)||0,r=Math.floor(Math.min(255,s*e)),a=Math.floor(Math.min(255,n*e)),l=Math.floor(Math.min(255,o*e));return"#"+r.toString(16).padStart(2,"0")+a.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")}brightenAndPaleColor(t){let e=t.replace("#","");3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);const i=parseInt(e.substring(0,2),16)||0,s=parseInt(e.substring(2,4),16)||0,n=parseInt(e.substring(4,6),16)||0,o=i+.2*(255-i),r=s+.2*(255-s),a=n+.2*(255-n),l=(o+r+a)/3,h=.15,c=Math.floor(o+(l-o)*h),d=Math.floor(r+(l-r)*h),u=Math.floor(a+(l-a)*h);return"#"+c.toString(16).padStart(2,"0")+d.toString(16).padStart(2,"0")+u.toString(16).padStart(2,"0")}drawLadAura(t,e,i,s){this.ctx.save();let n=i;n="light"===s?this.darkenColor(i,.7):this.adjustColorBrightness(i,1.3);const o=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,1.8*e);o.addColorStop(0,n+"80"),o.addColorStop(.5,n+"60"),o.addColorStop(.8,n+"30"),o.addColorStop(1,n+"00"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1.8*e,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawFancyBloom(t,e,i,s){this.ctx.save(),this.ctx.globalCompositeOperation="screen",this.ctx.globalAlpha=Math.max(0,Math.min(1,s)),this.ctx.shadowColor=i,this.ctx.shadowBlur=.9*e,this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBuildingSelectionIndicator(t,e){this.ctx.strokeStyle="#00FF00",this.ctx.lineWidth=3,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e+5,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([])}drawSun(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom;if("lad"===t.type)return void this.drawLadSun(t,e,i);if(this.isFancyGraphicsEnabled){const t=1.35*i;this.drawFancyBloom(e,t,this.colorScheme.sunGlow.outerGlow1,.7)}const s=this.getGraphicAssetPath("centralSun"),n=s?this.getSpriteImage(s):null,o=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);if(o.addColorStop(0,this.colorScheme.sunGlow.outerGlow1),o.addColorStop(.5,this.colorScheme.sunGlow.outerGlow2),o.addColorStop(.8,this.colorScheme.sunGlow.outerGlow3),o.addColorStop(1,this.colorScheme.sunGlow.outerGlow4),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),n&&n.complete&&n.naturalWidth>0){const t=2*i;return void this.ctx.drawImage(n,e.x-i,e.y-i,t,t)}this.ctx.strokeStyle=this.colorScheme.sunGlow.outerGlow1,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.8*i,0,2*Math.PI),this.ctx.stroke()}drawLadSun(t,e,i){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,Math.PI/2,-Math.PI/2),this.ctx.closePath(),this.ctx.clip(),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(e.x-i,e.y-i,i,2*i),this.ctx.restore(),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,-Math.PI/2,Math.PI/2),this.ctx.closePath(),this.ctx.clip(),this.ctx.fillStyle="#000000",this.ctx.fillRect(e.x,e.y-i,i,2*i),this.ctx.restore(),this.ctx.strokeStyle="#666666",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y+i),this.ctx.stroke(),this.ctx.strokeStyle=l,this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke()}drawForgeFlames(t,e,i,s,n){const o=this.getForgeFlameState(t,s.gameTime),r=this.getGraphicAssetPath("forgeFlameHot"),a=this.getGraphicAssetPath("forgeFlameCold");if(!r||!a)return;const l=this.getSpriteImage(r),h=this.getSpriteImage(a);if(!l.complete||0===l.naturalWidth||!h.complete||0===h.naturalWidth)return;const c=i*ti,d=Ze*(n?1-$t:1),u=d*o.warmth,p=d*(1-o.warmth),g=[0,0];for(let t=0;t<g.length;t++){const i=g[t],s=0===t?o.rotationRad:-o.rotationRad;this.ctx.save(),this.ctx.translate(e.x+i,e.y),this.ctx.rotate(s),p>0&&(this.ctx.globalAlpha=p,this.ctx.drawImage(h,-c/2,-c/2,c,c)),u>0&&(this.ctx.globalAlpha=u,this.ctx.drawImage(l,-c/2,-c/2,c,c)),this.ctx.restore()}this.ctx.globalAlpha=1}drawLensFlare(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=window.devicePixelRatio||1,n=this.canvas.width/s,o=this.canvas.height/s,r=n/2,a=o/2,l=e.x-r,h=e.y-a;if(Math.sqrt(l*l+h*h)>Math.sqrt(n*n+o*o)/2+i)return;const c=this.colorScheme.lensFlareHalo.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/),d=c?`rgba(${c[1]}, ${c[2]}, ${c[3]}, `:"rgba(255, 240, 200, ",u=[{offset:-.3,size:.4,alpha:.15},{offset:-.5,size:.25,alpha:.12},{offset:.4,size:.3,alpha:.1},{offset:.7,size:.2,alpha:.08}];for(const t of u){const e=r+l*t.offset,s=a+h*t.offset,n=i*t.size,o=this.ctx.createRadialGradient(e,s,0,e,s,n);o.addColorStop(0,`${d}${t.alpha})`),o.addColorStop(.5,`${d}${.5*t.alpha})`),o.addColorStop(1,`${d}0)`),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,s,n,0,2*Math.PI),this.ctx.fill()}this.ctx.save(),this.ctx.globalAlpha=.2,this.ctx.strokeStyle=this.colorScheme.lensFlareHalo,this.ctx.lineWidth=2;for(let t=0;t<6;t++){const s=Math.PI/3*t,n=1.5*i,o=e.x+Math.cos(s)*i*.7,r=e.y+Math.sin(s)*i*.7,a=e.x+Math.cos(s)*n,l=e.y+Math.sin(s)*n,h=this.ctx.createLinearGradient(o,r,a,l),c=d+"0.4)";h.addColorStop(0,c),h.addColorStop(1,`${d}0)`),this.ctx.strokeStyle=h,this.ctx.beginPath(),this.ctx.moveTo(o,r),this.ctx.lineTo(a,l),this.ctx.stroke()}this.ctx.restore()}drawStellarForge(t,e,i,s){const n=this.worldToScreen(t.position),o=40*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&(a=i.getLadSide(t.position,r),l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,$t))}if(t.isSelected){if(this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,1.5*o,0,2*Math.PI),this.ctx.stroke(),t.minionPath.length>0){this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.setLineDash([10,5]),this.ctx.beginPath();const e=this.worldToScreen(t.position);this.ctx.moveTo(e.x,e.y);for(const e of t.minionPath){const t=this.worldToScreen(e);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="#FFFF00";for(let e=0;e<t.minionPath.length;e++){const i=t.minionPath[e],s=this.worldToScreen(i);this.ctx.beginPath(),this.ctx.arc(s.x,s.y,5,0,2*Math.PI),this.ctx.fill(),e===t.minionPath.length-1&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,8,0,2*Math.PI),this.ctx.stroke())}}this.pathPreviewForge===t&&(this.pathPreviewPoints.length>0||this.pathPreviewEnd)&&this.drawMinionPathPreview(t.position,this.pathPreviewPoints,this.pathPreviewEnd),t.isSelected&&this.selectedHeroNames.length>0&&this.drawHeroButtons(t,n,this.selectedHeroNames)}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,a)}const d=h?this.darkenColor(l,$t):l,u=t.owner.faction===Za.VELARIS,p=t.owner.faction===Za.AURUM,g=this.getForgeSpritePath(t),y=g?this.getTintedSprite(g,d):null;if(p)this.drawAurumForgeOutline(t,n,o,c,i.gameTime);else if(u)this.drawVelarisForgeScript(t,n,o,c,i.gameTime,h);else if(y){const e=o*this.FORGE_SPRITE_SCALE;this.ctx.drawImage(y,n.x-e/2,n.y-e/2,e,e),this.drawForgeFlames(t,n,e,i,h)}else{this.ctx.fillStyle=c;const e=c;this.ctx.strokeStyle=h?this.darkenColor(e,$t):e,this.ctx.lineWidth=2,this.ctx.beginPath();for(let e=0;e<6;e++){const i=Math.PI/3*e+t.rotation,s=n.x+o*Math.cos(i),r=n.y+o*Math.sin(i);0===e?this.ctx.moveTo(s,r):this.ctx.lineTo(s,r)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}if(this.drawHealthDisplay(n,t.health,this.FORGE_MAX_HEALTH,o,-o-15),t.heroProductionUnitType&&t.heroProductionDurationSec>0){const e=2*o,i=6,s=n.x-e/2,r=n.y+o+10,a=Math.max(0,Math.min(1,1-t.heroProductionRemainingSec/t.heroProductionDurationSec));this.ctx.fillStyle="#222",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#00FF88",this.ctx.fillRect(s,r,e*a,i)}t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,h?c:e)}drawHeroButtons(t,e,i){const s=en*this.zoom,n=sn*this.zoom,o=i.slice(0,4),r=this.getRadialButtonOffsets(o.length);for(let i=0;i<o.length;i++){const a=o[i],l=r[i],h=e.x+l.x*n,c=e.y+l.y*n,d=this.getHeroUnitType(a),u=!!d&&this.isHeroUnitAlive(t.owner,d),p=!!d&&this.isHeroUnitQueuedOrProducing(t,d),g=!!d&&!u&&!p,y=this.highlightedButtonIndex===i;this.ctx.fillStyle=y?"rgba(0, 255, 136, 0.7)":g?"rgba(0, 255, 136, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=y||g?"#00FF88":"#888888",this.ctx.lineWidth=y?4:2,this.ctx.beginPath(),this.ctx.arc(h,c,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=g?"#FFFFFF":"#666666",this.ctx.font=14*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,h,c),p?this.drawHeroHourglass(h,c,s):u&&this.drawHeroCheckmark(h,c,s)}}getRadialButtonOffsets(t){if(t<=0)return[];const e=[],i=-Math.PI/2,s=2*Math.PI/t;for(let n=0;n<t;n++){const t=i+s*n;e.push({x:Math.cos(t),y:Math.sin(t)})}return e}getHeroUnitType(t){switch(t){case"Marine":case"Grave":case"Ray":case"Dagger":case"Beam":case"Driller":case"Spotlight":case"Sly":return t;case"Influence Ball":return"InfluenceBall";case"Turret Deployer":return"TurretDeployer";default:return null}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof Fl;case"Grave":return t instanceof kl;case"Ray":return t instanceof Bl;case"Nova":return t instanceof eh;case"InfluenceBall":return t instanceof Gl;case"TurretDeployer":return t instanceof $l;case"Driller":return t instanceof zl;case"Dagger":return t instanceof jl;case"Beam":return t instanceof Kl;case"Spotlight":return t instanceof Ql;case"Mortar":return t instanceof Yl;case"Preist":return t instanceof ql;case"Sly":return t instanceof nh;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}drawHeroHourglass(t,e,i){const s=.7*i,n=.8*i,o=t-.5*s,r=t+.5*s,a=e-.5*n,l=e+.5*n,h=e;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.moveTo(o,a),this.ctx.lineTo(r,a),this.ctx.lineTo(t,h),this.ctx.closePath(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(o,l),this.ctx.lineTo(r,l),this.ctx.lineTo(t,h),this.ctx.closePath(),this.ctx.stroke()}drawHeroCheckmark(t,e,i){const s=.7*i,n=.6*i,o=t-.45*s,r=e+.05*n,a=t-.1*s,l=e+.35*n,h=t+.5*s,c=e-.35*n;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.moveTo(o,r),this.ctx.lineTo(a,l),this.ctx.lineTo(h,c),this.ctx.stroke()}drawFoundryButtons(t,e){const i=en*this.zoom,s=sn*this.zoom,n=[{label:"Strafe",available:t.canQueueStrafeUpgrade(),index:0},{label:"Blink",available:t.canQueueBlinkUpgrade(),index:1},{label:"Regen",available:t.canQueueRegenUpgrade(),index:2},{label:"+1 ATK",available:t.canQueueAttackUpgrade(),index:3}],o=this.getRadialButtonOffsets(n.length);for(let t=0;t<n.length;t++){const r=n[t],a=o[t],l=e.x+a.x*s,h=e.y+a.y*s,c=this.highlightedButtonIndex===r.index;this.ctx.fillStyle=c?"rgba(255, 215, 0, 0.7)":r.available?"rgba(255, 215, 0, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=c||r.available?"#FFD700":"#888888",this.ctx.lineWidth=c?4:2,this.ctx.beginPath(),this.ctx.arc(l,h,i,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=r.available?"#FFFFFF":"#666666",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(r.label,l,h)}}getPseudoRandom(t){const e=43758.5453*Math.sin(t);return e-Math.floor(e)}getStarlingParticleSeed(t){let e=this.starlingParticleSeeds.get(t);return void 0===e&&(e=1e4*Math.random(),this.starlingParticleSeeds.set(t,e)),e}getVelarisMirrorSeed(t){let e=this.velarisMirrorSeeds.get(t);return void 0===e&&(e=1e4*Math.random(),this.velarisMirrorSeeds.set(t,e)),e}getVelarisFoundrySeed(t){let e=this.velarisFoundrySeeds.get(t);return void 0===e&&(e=1e4*Math.random(),this.velarisFoundrySeeds.set(t,e)),e}getVelarisWarpGateSeed(t){let e=this.velarisWarpGateSeeds.get(t);return void 0===e&&(e=1e4*Math.random(),this.velarisWarpGateSeeds.set(t,e)),e}getAurumForgeShapeState(t,e){let i=this.aurumForgeShapeStates.get(t);if(!i){const s=12,n=[],o=t.position.x*this.AURUM_SEED_BASE_MULTIPLIER+t.position.y;for(let t=0;t<s;t++){const e=(o+t*this.AURUM_FORGE_SEED_MULTIPLIER)%1e3/1e3,i=.3+1.2*e,r=.15+.5*e,a=t/s*Math.PI*2,l=.4*e;n.push({size:i,speed:r,angle:a,offset:l})}i={shapes:n,lastGameTime:e},this.aurumForgeShapeStates.set(t,i)}return i}getAurumFoundryShapeState(t,e){let i=this.aurumFoundryShapeStates.get(t);if(!i){const s=10,n=[],o=t.position.x*this.AURUM_SEED_BASE_MULTIPLIER+t.position.y;for(let t=0;t<s;t++){const e=(o+t*this.AURUM_FOUNDRY_SEED_MULTIPLIER)%1e3/1e3,i=.25+1*e,r=.2+.6*e,a=t/s*Math.PI*2,l=.35*e;n.push({size:i,speed:r,angle:a,offset:l})}i={shapes:n,lastGameTime:e},this.aurumFoundryShapeStates.set(t,i)}return i}drawSolarMirror(t,e,s,n,r){const a=s.suns.find(t=>"lad"===t.type);let l,h=e;a&&t.owner&&(l=t.owner.stellarForge?s.getLadSide(t.owner.stellarForge.position,a):"light",h="light"===l?"#FFFFFF":"#000000");let c=!1,d=h;if(n&&this.viewingPlayer){if(!s.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;a||s.isPointInShadow(t.position)&&(c=!0,d=this.darkenColor(h,$t))}const u=this.worldToScreen(t.position),p=14*this.zoom;this.ctx.save();const g=Math.max(0,Math.min(1,1-t.closestSunDistance/Dn)),y=t.owner.faction===Za.VELARIS,f=t.hasLineOfSightToLight(s.suns,s.asteroids)&&g>.1&&t.closestSunDistance!==1/0;if(this.isFancyGraphicsEnabled){const t=this.brightenAndPaleColor(d),e=.25+.5*g;this.drawFancyBloom(u,1.6*p,t,e)}if(g>.1&&t.closestSunDistance!==1/0){const e=Fn*this.zoom*(1+g),n=this.ctx.createRadialGradient(u.x,u.y,0,u.x,u.y,e);n.addColorStop(0,`rgba(255, 255, 150, ${.8*g})`),n.addColorStop(.5,`rgba(255, 255, 100, ${.4*g})`),n.addColorStop(1,"rgba(255, 255, 50, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(u.x,u.y,e,0,2*Math.PI),this.ctx.fill();const o=t.getClosestVisibleSun(s.suns,s.asteroids);if(o){const e=t.owner.stellarForge,n=t.getLinkedStructure(e);let r=null;if(n&&t.hasLineOfSightToStructure(n,s.asteroids,s.players))r=new i(n.position.x-t.position.x,n.position.y-t.position.y).normalize();else{const e=new i(o.position.x-t.position.x,o.position.y-t.position.y).normalize();r=new i(-e.x,-e.y)}const a=100,l=y&&f?new i(t.position.x-6.3*Math.sin(t.reflectionAngle),t.position.y+6.3*Math.cos(t.reflectionAngle)):t.position,h=new i(l.x+r.x*a,l.y+r.y*a),c=this.worldToScreen(l),d=this.worldToScreen(h),u=this.ctx.createLinearGradient(c.x,c.y,d.x,d.y);u.addColorStop(0,`rgba(255, 255, 200, ${1*g})`),u.addColorStop(.7,`rgba(255, 255, 150, ${.6*g})`),u.addColorStop(1,"rgba(255, 255, 100, 0)"),this.ctx.strokeStyle=u,this.ctx.lineWidth=15*this.zoom*g,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(d.x,d.y),this.ctx.stroke();const p=20*this.zoom*g,m=this.ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,p);m.addColorStop(0,`rgba(255, 255, 255, ${.9*g})`),m.addColorStop(.5,`rgba(255, 255, 200, ${.5*g})`),m.addColorStop(1,"rgba(255, 255, 150, 0)"),this.ctx.fillStyle=m,this.ctx.beginPath(),this.ctx.arc(d.x,d.y,p,0,2*Math.PI),this.ctx.fill()}}if(this.ctx.translate(u.x,u.y),this.ctx.rotate(t.reflectionAngle),a&&l){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0);const t=n?this.enemyColor:this.playerColor;this.drawLadAura(u,p,t,l),this.ctx.restore()}const m=2*p,x=.3*p;let S=m,A=x,T=!1;if(y){const e=this.brightenAndPaleColor(d),i=.6*p,s=.75*i,n=this.getVelarisMirrorSeed(t)+.15*t.reflectionAngle,o=r*this.VELARIS_MIRROR_PARTICLE_TIME_SCALE;if(f){const t=this.VELARIS_MIRROR_WORD,r=t.length,a=s*(r-1),l=.1*-p;for(let n=0;n<r;n++){const o=(n-(r-1)/2)*s,a=t.charAt(n),h=this.getVelarisGraphemeSpritePath(a);h&&(this.drawVelarisGraphemeSprite(h,o,l,i,e)||(this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(o,l,.2*i,0,2*Math.PI),this.ctx.fill()))}const h=.45*p,c=a+.6*i,d=Math.max(1,.08*p);this.ctx.fillStyle="rgba(255, 255, 220, 0.85)";for(let t=0;t<this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT;t++){const e=n+2.7*t,i=((this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT>1?t/(this.VELARIS_MIRROR_UNDERLINE_PARTICLE_COUNT-1):.5)-.5)*c+Math.sin(o*this.VELARIS_MIRROR_PARTICLE_DRIFT_SPEED+e)*d*.6,s=h+Math.cos(o*(.8*this.VELARIS_MIRROR_PARTICLE_DRIFT_SPEED)+e)*d*.4;this.ctx.beginPath(),this.ctx.arc(i,s,d,0,2*Math.PI),this.ctx.fill()}S=c+i,A=1.4*p}else{const t=.9*p,s=Math.max(1,.12*p),r=2*Math.PI;for(let a=0;a<this.VELARIS_MIRROR_CLOUD_GLYPH_COUNT;a++){const l=n+12.7*a,h=this.getPseudoRandom(l)*r,c=this.getPseudoRandom(l+7.3)*t,d=.2*o+this.getPseudoRandom(l+5.1)*r,u=Math.cos(h)*c+Math.cos(d)*s,p=Math.sin(h)*c+Math.sin(d)*s,g=Math.floor(this.getPseudoRandom(l+9.6)*this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS.length),y=this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS[g];this.drawVelarisGraphemeSprite(y,u,p,i,e)||(this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(u,p,.2*i,0,2*Math.PI),this.ctx.fill())}const a=Math.max(1,.07*p);this.ctx.fillStyle="rgba(255, 255, 210, 0.6)";for(let e=0;e<this.VELARIS_MIRROR_CLOUD_PARTICLE_COUNT;e++){const i=n+9.4*e,l=this.getPseudoRandom(i+1.1)*r,h=this.getPseudoRandom(i+4.7)*t,c=.25*o+this.getPseudoRandom(i+6.4)*r,d=.75*s,u=Math.cos(l)*h+Math.cos(c)*d,p=Math.sin(l)*h+Math.sin(c)*d;this.ctx.beginPath(),this.ctx.arc(u,p,a,0,2*Math.PI),this.ctx.fill()}S=2*p,A=1.6*p}T=!0}const _=this.getSolarMirrorSpritePath(t);if(_){const t=this.brightenAndPaleColor(d),e=this.getTintedSprite(_,t);if(e){const t=2.4*p/Math.max(e.width,e.height),i=e.width*t,s=e.height*t;S=i,A=s,this.ctx.drawImage(e,-i/2,-s/2,i,s),T=!0}}if(!T){const t=this.ctx.createLinearGradient(0,-x/2,0,x/2);t.addColorStop(0,"#FFFFFF"),t.addColorStop(.5,"#E0E0E0"),t.addColorStop(1,"#C0C0C0"),this.ctx.fillStyle=t,this.ctx.fillRect(-m/2,-x/2,m,x);const e=d;this.ctx.strokeStyle=c?this.darkenColor(e,$t):e,this.ctx.lineWidth=2,this.ctx.strokeRect(-m/2,-x/2,m,x),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(-m/2,0,3,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(m/2,0,3,0,2*Math.PI),this.ctx.fill()}if(t.isSelected&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.strokeRect(-S/2-3,-A/2-3,S+6,A+6)),this.ctx.restore(),this.isWarpGatePlacementMode&&t.isSelected){const t=8,e=Math.max(1.2,.08*p),i=1.25*p,s=1.8*r;this.ctx.save(),this.ctx.globalCompositeOperation="lighter";for(let n=0;n<t;n++){const o=s+n*Math.PI*2/t,r=i+Math.sin(1.4*s+1.9*n)*p*.25,a=u.x+Math.cos(o)*r,l=u.y+Math.sin(o)*r,h=.35+.35*Math.sin(s+n),c=this.ctx.createRadialGradient(a,l,0,a,l,3*e);c.addColorStop(0,`rgba(180, 255, 255, ${h})`),c.addColorStop(1,"rgba(120, 200, 255, 0)"),this.ctx.fillStyle=c,this.ctx.beginPath(),this.ctx.arc(a,l,3*e,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=`rgba(220, 255, 255, ${Math.min(.9,h+.3)})`,this.ctx.beginPath(),this.ctx.arc(a,l,e,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}t.efficiency<1&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(u.x,u.y,.3*p,0,2*Math.PI),this.ctx.fill()),t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,d);const w=t.owner.stellarForge,E=!!(w&&t.health<this.MIRROR_MAX_HEALTH&&t.position.distanceTo(w.position)<=o),b=this.viewingPlayer&&t.owner===this.viewingPlayer?this.playerColor:this.enemyColor;if(this.drawHealthDisplay(u,t.health,this.MIRROR_MAX_HEALTH,p,-p-10,E,E?b:void 0),t.isSelected){const e=t.hasLineOfSightToLight(s.suns,s.asteroids),i=t.owner.stellarForge,n=t.getLinkedStructure(i),o=!!n&&t.hasLineOfSightToStructure(n,s.asteroids,s.players),r=n instanceof cl&&e&&o?t.getEnergyRatePerSec():0,a=this.getSolEnergyIcon(),l=16*this.zoom,h=u.y+p+16*this.zoom;this.ctx.font=12*this.zoom+"px Doto";const c=`+${r.toFixed(0)}/s`,d=this.ctx.measureText(c).width,g=Kn*this.zoom,y=l+g+d,f=u.x-y/2;a.complete&&a.naturalWidth>0&&this.ctx.drawImage(a,f,h-l/2,l,l),this.ctx.fillStyle="#FFFFAA",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(c,f+l+g,h)}}drawSpaceDust(t,e,i){const s=this.worldToScreen(t.position),n=V*this.zoom,o=e.suns.find(t=>"lad"===t.type),r=e.isPointInShadow(t.position);if(null!==i&&r){const s=e.players[i];if(!e.isObjectVisibleToPlayer(t.position,s))return}if(e.suns.length>0&&!o){const i=Math.max(.4,gt*this.zoom);this.ctx.strokeStyle=`rgba(0, 0, 20, ${pt})`,this.ctx.lineWidth=i;for(const i of e.suns){const e=t.position.x-i.position.x,n=t.position.y-i.position.y,o=Math.sqrt(e*e+n*n);if(o>0&&o<dt){const t=ut*(1-o/dt);if(t>0){const i=1/o,r=e*i,a=n*i,l=s.x+r*t*this.zoom,h=s.y+a*t*this.zoom;this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(l,h),this.ctx.stroke()}}}}let a=t.glowState;t.glowTransition>0&&t.glowState!==t.targetGlowState&&(a=t.glowState+(t.targetGlowState-t.glowState)*t.glowTransition);const l=!!o&&t.position.x<o.position.x,h=o?l?"#000000":"#FFFFFF":t.currentColor;o&&(a=0);const c=t.velocity.x,d=t.velocity.y,u=Math.sqrt(c*c+d*d);if(u>yt){const t=1/u,e=c*t,i=d*t,o=-i,r=e,a=Math.min(mt,Math.max(ft,u*xt))*this.zoom,l=o*n,p=r*n,g=e*a,y=i*a,f=s.x+l,m=s.y+p,x=s.x-l,S=s.y-p,A=f-g,T=m-y,_=x-g,w=S-y;if(this.ctx.lineWidth=Math.max(.2,St*this.zoom),this.isFancyGraphicsEnabled&&h.startsWith("#")){let t=h.slice(1);3===t.length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);const e=parseInt(t,16),i=e>>16&255,s=e>>8&255,n=255&e,o=.6,r=this.ctx.createLinearGradient(f,m,A,T);r.addColorStop(0,`rgba(${i}, ${s}, ${n}, ${o})`),r.addColorStop(1,`rgba(${i}, ${s}, ${n}, 0)`),this.ctx.strokeStyle=r,this.ctx.beginPath(),this.ctx.moveTo(f,m),this.ctx.lineTo(A,T),this.ctx.stroke();const a=this.ctx.createLinearGradient(x,S,_,w);a.addColorStop(0,`rgba(${i}, ${s}, ${n}, ${o})`),a.addColorStop(1,`rgba(${i}, ${s}, ${n}, 0)`),this.ctx.strokeStyle=a,this.ctx.beginPath(),this.ctx.moveTo(x,S),this.ctx.lineTo(_,w),this.ctx.stroke()}else this.ctx.strokeStyle=h,this.ctx.globalAlpha=.45,this.ctx.beginPath(),this.ctx.moveTo(f,m),this.ctx.lineTo(A,T),this.ctx.moveTo(x,S),this.ctx.lineTo(_,w),this.ctx.stroke(),this.ctx.globalAlpha=1}if(a>0){const t=n*(1.2+.35*a);this.ctx.fillStyle=h,this.ctx.globalAlpha=.15+.1*a,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,t,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}if(this.isFancyGraphicsEnabled){const t=n*(1.6+.6*a),e=.25+.2*a;this.drawFancyBloom(s,t,h,e)}this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,n,0,2*Math.PI),this.ctx.fill()}getClosestInfluenceOwnerIndex(t,e){let i=1/0,s=null;for(let n=0;n<e.players.length;n++){const r=e.players[n];if(r.stellarForge&&!r.isDefeated()){const e=t.distanceTo(r.stellarForge.position);e<o&&e<i&&(i=e,s=n)}}return s}drawAsteroid(t){const e=t.getWorldVertices();if(0===e.length)return;const i=e.map(t=>this.worldToScreen(t)),s=Kt-jt,n=s>0?Math.min(1,Math.max(0,(t.size-jt)/s)):0,o=this.interpolateHexColor(this.colorScheme.asteroidColors.fillStart,this.colorScheme.asteroidColors.fillEnd,n),r=this.interpolateHexColor(this.colorScheme.asteroidColors.strokeStart,this.colorScheme.asteroidColors.strokeEnd,n);this.ctx.fillStyle=o,this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)this.ctx.lineTo(i[t].x,i[t].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}drawSunRays(t){const e=t.suns.find(t=>"lad"===t.type);e?this.drawLadSunRays(t,e):this.drawNormalSunRays(t)}drawNormalSunRays(t){for(const e of t.suns){const t=this.worldToScreen(e.position),i=2*Math.max(this.canvas.width,this.canvas.height),s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,i);if(s.addColorStop(0,this.colorScheme.sunLightRays.nearCenter),s.addColorStop(.5,this.colorScheme.sunLightRays.mid),s.addColorStop(1,this.colorScheme.sunLightRays.edge),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.isFancyGraphicsEnabled){const e=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,1.1*i);e.addColorStop(0,"rgba(255, 255, 220, 0.35)"),e.addColorStop(.4,"rgba(255, 230, 160, 0.18)"),e.addColorStop(1,"rgba(255, 220, 120, 0)"),this.ctx.save(),this.ctx.globalCompositeOperation="screen",this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}}for(const e of t.suns){this.ctx.save(),this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="rgba(0, 0, 20, 0.5)";let s=!1;this.ctx.beginPath();for(const n of t.asteroids){const t=n.getWorldVertices();for(let n=0;n<t.length;n++){const o=t[n],r=t[(n+1)%t.length],a=new i((o.x+r.x)/2,(o.y+r.y)/2),l=new i(e.position.x-a.x,e.position.y-a.y),h=new i(-(r.y-o.y),r.x-o.x);if(l.x*h.x+l.y*h.y<0){const t=new i(o.x-e.position.x,o.y-e.position.y).normalize(),n=new i(r.x-e.position.x,r.y-e.position.y).normalize(),a=new i(o.x+t.x*Ht,o.y+t.y*Ht),l=new i(r.x+n.x*Ht,r.y+n.y*Ht),h=this.worldToScreen(o),c=this.worldToScreen(r),d=this.worldToScreen(a),u=this.worldToScreen(l);this.ctx.moveTo(h.x,h.y),this.ctx.lineTo(c.x,c.y),this.ctx.lineTo(u.x,u.y),this.ctx.lineTo(d.x,d.y),this.ctx.closePath(),s=!0}}}s&&this.ctx.fill(),this.ctx.restore()}}drawLadSunRays(t,e){const s=this.worldToScreen(e.position);this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(0,0,s.x,this.canvas.height),this.ctx.clip(),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(s.x,0,this.canvas.width-s.x,this.canvas.height),this.ctx.clip(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.fillStyle="#000000",this.ctx.beginPath();let n=!1;for(const s of t.asteroids){const t=s.getWorldVertices();for(let s=0;s<t.length;s++){const o=t[s],r=t[(s+1)%t.length],a=new i((o.x+r.x)/2,(o.y+r.y)/2),l=new i(e.position.x-a.x,e.position.y-a.y),h=new i(-(r.y-o.y),r.x-o.x);if(l.x*h.x+l.y*h.y<0){const t=new i(o.x-e.position.x,o.y-e.position.y).normalize(),s=new i(r.x-e.position.x,r.y-e.position.y).normalize(),a=new i(o.x+t.x*Ht,o.y+t.y*Ht),l=new i(r.x+s.x*Ht,r.y+s.y*Ht);if((a.x+l.x)/2<e.position.x){const t=this.worldToScreen(o),e=this.worldToScreen(r),i=this.worldToScreen(a),s=this.worldToScreen(l);this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.lineTo(i.x,i.y),this.ctx.closePath(),n=!0}}}}n&&this.ctx.fill(),this.ctx.restore(),this.ctx.save(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath();let o=!1;for(const s of t.asteroids){const t=s.getWorldVertices();for(let s=0;s<t.length;s++){const n=t[s],r=t[(s+1)%t.length],a=new i((n.x+r.x)/2,(n.y+r.y)/2),l=new i(e.position.x-a.x,e.position.y-a.y),h=new i(-(r.y-n.y),r.x-n.x);if(l.x*h.x+l.y*h.y<0){const t=new i(n.x-e.position.x,n.y-e.position.y).normalize(),s=new i(r.x-e.position.x,r.y-e.position.y).normalize(),a=new i(n.x+t.x*Ht,n.y+t.y*Ht),l=new i(r.x+s.x*Ht,r.y+s.y*Ht);if(!((a.x+l.x)/2<e.position.x)){const t=this.worldToScreen(n),e=this.worldToScreen(r),i=this.worldToScreen(a),s=this.worldToScreen(l);this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.lineTo(i.x,i.y),this.ctx.closePath(),o=!0}}}}o&&this.ctx.fill(),this.ctx.restore()}drawInfluenceCircle(t,e,i){const s=this.worldToScreen(t),n=e*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,n,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}drawWarpGate(t,e,i){const s=this.worldToScreen(t.position),n=m*this.zoom,o=t.chargeTime/h,r=Math.min(n,o*n),a=this.selectedWarpGate===t,l=t.owner.faction===Za.VELARIS,d=this.getLadPlayerColor(t.owner,i,e);if(t.isComplete){l?this.drawVelarisWarpGateVortex(t,s,n,e.gameTime,d):this.drawWarpGateProductionEffect(s,n,e,d),a&&this.drawBuildingSelectionIndicator(s,n);const i=t.completionRemainingSec/E;if(i>0){const t=n+12*this.zoom;this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,t,-Math.PI/2,-Math.PI/2+i*Math.PI*2),this.ctx.stroke()}if(a){const e=x*this.zoom,i=n+S*this.zoom,o=t.owner.buildings.some(t=>t instanceof yl),r=t.owner.energy;let a;a=t.owner.faction===Za.RADIANT?[{label:"Foundry",index:0,isAvailable:!o&&r>=ms},{label:"Cannon",index:1,isAvailable:r>=gs},{label:"Gatling",index:2,isAvailable:r>=ys},{label:"Shield",index:3,isAvailable:r>=As}]:t.owner.faction===Za.VELARIS?[{label:"Foundry",index:0,isAvailable:!o&&r>=ms},{label:"Striker",index:1,isAvailable:r>=xs},{label:"Lock-on",index:2,isAvailable:r>=Ss},{label:"Cyclone",index:3,isAvailable:r>=fs}]:[{label:"Foundry",index:0,isAvailable:!o&&r>=ms}];const l=this.getRadialButtonOffsets(a.length);for(let t=0;t<a.length;t++){const n=a[t],o=l[t],r=s.x+o.x*i,h=s.y+o.y*i,c=e+14*this.zoom,d=n.isAvailable&&this.highlightedButtonIndex===n.index;n.isAvailable?(this.ctx.fillStyle=d?"rgba(0, 255, 255, 0.6)":"#444444",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=d?4:2):(this.ctx.fillStyle="#1F1F1F",this.ctx.strokeStyle="#555555",this.ctx.lineWidth=2),this.ctx.beginPath(),this.ctx.arc(r,h,e,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=n.isAvailable?"#FFFFFF":"#777777",this.ctx.font=11*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(n.label,r+o.x*c,h+o.y*c)}}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}else{l?this.drawVelarisWarpGateVortex(t,s,r,e.gameTime,d):(this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.globalAlpha=.5+.2*Math.sin(5*t.chargeTime),this.ctx.beginPath(),this.ctx.arc(s.x,s.y,r,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=5,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,r+5,0,o*Math.PI*2),this.ctx.stroke();const i=`${t.accumulatedEnergy.toFixed(0)}/${c}`;this.ctx.fillStyle="#FFFFFF",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i,s.x,s.y+n+20*this.zoom),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}}drawStarlingMergeGate(t){const e=this.worldToScreen(t.position),i=ks*this.zoom,s=Fs,n=s>0?t.remainingSec/s:0,o=.18+.06*Math.sin(4*(s-t.remainingSec)),r=.35+.1*Math.sin(5*(s-t.remainingSec));this.ctx.fillStyle=`rgba(0, 255, 255, ${Math.max(.1,o)})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle=`rgba(0, 255, 255, ${Math.max(.2,r)})`,this.ctx.lineWidth=2.5*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke(),this.ctx.strokeStyle=`rgba(255, 255, 255, ${Math.max(.3,r)})`,this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.65*i,0,2*Math.PI),this.ctx.stroke();const a=i+7*this.zoom;this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,a,-Math.PI/2,-Math.PI/2+n*Math.PI*2),this.ctx.stroke();const l=e.y+i+10*this.zoom;this.ctx.fillStyle="#FFD700",this.ctx.font=12*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText(`${t.absorbedCount}/${Ls}`,e.x,l),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawMirrorCommandButtons(t,e){if(0===t.size)return;const i=Array.from(t)[0],s=this.worldToScreen(i.position),n=this.hasSeenFoundry,o=this.hasActiveFoundry,r=x*this.zoom,a=50*this.zoom,l=n,h=l?3:2,c=this.getRadialButtonOffsets(h),d=c[0],u=c[1],p=l?c[2]:null,g=s.x+d.x*a,y=s.y+d.y*a,f=s.x+u.x*a,m=s.y+u.y*a,S=p?s.x+p.x*a:s.x,A=p?s.y+p.y*a:s.y,T=0===this.highlightedButtonIndex;this.ctx.fillStyle=T?"rgba(255, 215, 0, 0.4)":"#444444",this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=T?4:2,this.ctx.beginPath(),this.ctx.arc(g,y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=11*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Forge",g,y);const _=this.canCreateWarpGateFromMirrors,w=1===this.highlightedButtonIndex&&_,E=this.isWarpGatePlacementMode&&_,b=.35+.25*Math.sin(4*e),v=E?`rgba(0, 255, 255, ${.35+b})`:w?"rgba(0, 255, 255, 0.4)":_?"#444444":"#2C2C2C";if(this.ctx.fillStyle=v,this.ctx.strokeStyle=_?E?"#B8FFFF":"#00FFFF":"#666666",this.ctx.lineWidth=w||E?4:2,E&&(this.ctx.save(),this.ctx.globalCompositeOperation="lighter",this.ctx.strokeStyle=`rgba(120, 255, 255, ${.35+b})`,this.ctx.lineWidth=6*this.zoom,this.ctx.beginPath(),this.ctx.arc(f,m,r+5*this.zoom,0,2*Math.PI),this.ctx.stroke(),this.ctx.restore()),this.ctx.beginPath(),this.ctx.arc(f,m,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=_?"#FFFFFF":"#8A8A8A",this.ctx.font=9*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Warp",f,m-6*this.zoom),this.ctx.fillText("Gate",f,m+6*this.zoom),l){const t=o&&2===this.highlightedButtonIndex,e=o?t?"rgba(160, 160, 160, 0.4)":"#444444":"#2C2C2C",i=o?"#B0B0B0":"#666666",s=o?"#FFFFFF":"#8A8A8A";this.ctx.fillStyle=e,this.ctx.strokeStyle=i,this.ctx.lineWidth=t?4:2,this.ctx.beginPath(),this.ctx.arc(S,A,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=s,this.ctx.font=9*this.zoom+"px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Found",S,A-5*this.zoom),this.ctx.fillText("ry",S,A+6*this.zoom)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawUnit(t,e,i,s,n=1){const o=this.worldToScreen(t.position),r=8*this.zoom*n,a=this.selectedUnits.has(t),l=i.suns.find(t=>"lad"===t.type);let h,c=e;l&&t.owner&&(h=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,l):"light",c="light"===h?"#FFFFFF":"#000000");let d=c;if(s&&this.viewingPlayer&&!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;if(a&&t.isHero&&!s){const e=t.attackRange*this.zoom;this.ctx.strokeStyle=c,this.ctx.lineWidth=1,this.ctx.globalAlpha=jn,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,e,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}if(l&&h){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(o,r,t,h)}const u=t.isHero?this.getHeroSpritePath(t):null,p=l?c:s?this.enemyColor:this.playerColor,g=u?this.getTintedSprite(u,p):null;if(g){const e=r*this.HERO_SPRITE_SCALE,i=t.rotation;this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(i),this.ctx.drawImage(g,-e/2,-e/2,e,e),this.ctx.restore()}else this.ctx.fillStyle=d,this.ctx.strokeStyle=d,this.ctx.lineWidth=a?3:1,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();if(this.isFancyGraphicsEnabled){const t=d,e=r*(a?1.9:1.5),i=a?.45:.3;this.drawFancyBloom(o,e,t,i)}if(this.drawHealthDisplay(o,t.health,t.maxHealth,r,-r-8),t.isStunned()){this.ctx.fillStyle="#FFFF00",this.ctx.globalAlpha=.7;const t=6*this.zoom;for(let e=0;e<3;e++){const s=(3*i.gameTime+e*(2*Math.PI/3))%(2*Math.PI),n=o.x+Math.cos(s)*(1.8*r),a=o.y+Math.sin(s)*(1.8*r);this.ctx.beginPath();for(let e=0;e<5;e++){const i=e*(2*Math.PI/5)-Math.PI/2,s=n+Math.cos(i)*t*.5,o=a+Math.sin(i)*t*.5;0===e?this.ctx.moveTo(s,o):this.ctx.lineTo(s,o)}this.ctx.closePath(),this.ctx.fill()}this.ctx.globalAlpha=1}if(!t.isHero&&t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y,s=Math.atan2(i,e);this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(o.x+Math.cos(s)*r*1.5,o.y+Math.sin(s)*r*1.5),this.ctx.stroke()}t.moveOrder>0&&t.rallyPoint&&this.drawMoveOrderIndicator(t.position,t.rallyPoint,t.moveOrder,e)}drawMoveOrderIndicator(t,e,i,s){const n=this.worldToScreen(t),o=this.worldToScreen(e);this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.globalAlpha=.5,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(o.x,o.y),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=1;const r=this.MOVE_ORDER_DOT_RADIUS;this.drawMovementPointMarker(o,r,s)||(this.ctx.fillStyle=s,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke())}getMoveOrderFrameIndex(){return Math.floor(performance.now()/this.MOVE_ORDER_FRAME_DURATION_MS)%vt}drawMovementPointMarker(t,e,i){const s=this.getMoveOrderFrameIndex(),n=this.movementPointFramePaths[s],o=this.getTintedSprite(n,i);if(o)return this.drawMovementPointSprite(o,t,e),!0;const r=this.getTintedSprite(this.MOVE_ORDER_FALLBACK_SPRITE_PATH,i);return!!r&&(this.drawMovementPointSprite(r,t,e),!0)}drawMovementPointSprite(t,e,i){const s=this.getMinZoomForBounds();let n=1;this.zoom<=s&&(n=.5);const o=2*i*n/Math.max(t.width,t.height),r=t.width*o,a=t.height*o;this.ctx.drawImage(t,e.x-r/2,e.y-a/2,r,a)}drawMuzzleFlash(t){const e=this.worldToScreen(t.position),i=5*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.angle),this.ctx.fillStyle=`rgba(255, 255, 100, ${s})`,this.ctx.beginPath(),this.ctx.ellipse(0,0,2*i,i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBulletCasing(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=5*this.zoom,n=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.rotation),this.ctx.fillStyle=`rgba(255, 215, 0, ${n})`,this.ctx.fillRect(-i/2,-s/2,i,s),this.ctx.restore()}drawBouncingBullet(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=`rgba(255, 255, 0, ${s})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill()}drawAbilityBullet(t){var e,i;const s=this.worldToScreen(t.position),n=4*this.zoom,o=t.lifetime/t.maxLifetime,r=this.getFactionColor(t.owner.faction);if(this.ctx.fillStyle=`${r}`,this.ctx.globalAlpha=o,t.isSpotlightBullet){const n=Math.atan2(t.velocity.y,t.velocity.x),o=(null!==(e=t.renderLengthPx)&&void 0!==e?e:8)*this.zoom,r=(null!==(i=t.renderWidthPx)&&void 0!==i?i:2)*this.zoom;this.ctx.save(),this.ctx.translate(s.x,s.y),this.ctx.rotate(n),this.ctx.fillRect(.5*-o,.5*-r,o,r),this.ctx.restore()}else this.ctx.beginPath(),this.ctx.arc(s.x,s.y,n,0,2*Math.PI),this.ctx.fill();this.ctx.globalAlpha=1}drawMinionProjectile(t){const e=this.worldToScreen(t.position),i=2.5*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.globalAlpha=.9,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawMortarProjectile(t){const e=this.worldToScreen(t.position),i=6*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.5,this.ctx.beginPath(),this.ctx.arc(e.x-.2*i,e.y-.2*i,.4*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawNovaBomb(t){const e=this.worldToScreen(t.position),i=wa*this.zoom,s=this.getFactionColor(t.owner.faction);if(t.isArmed){const n=.5+.5*Math.sin(8*t.lifetime);this.ctx.fillStyle=s,this.ctx.globalAlpha=.2*n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,2*i,0,2*Math.PI),this.ctx.fill()}if(this.ctx.fillStyle=s,this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.4*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),t.isArmed){const s=5*t.lifetime,n=e.x+Math.cos(s)*i*.6,o=e.y+Math.sin(s)*i*.6;this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(n,o,.3*i,0,2*Math.PI),this.ctx.fill()}else this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(e.x-.3*i,e.y-.3*i,.4*i,0,2*Math.PI),this.ctx.fill();this.ctx.globalAlpha=1}drawNovaScatterBullet(t){const e=this.worldToScreen(t.position),i=4*this.zoom,s=this.getFactionColor(t.owner.faction),n=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=s,this.ctx.globalAlpha=.3*n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=n,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.6*n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.4*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawStickyBomb(t){const e=this.worldToScreen(t.position),i=Da*this.zoom,s=this.getFactionColor(t.owner.faction);if(t.isArmed&&t.isStuck){const n=.5+.5*Math.sin(10*t.lifetime);this.ctx.fillStyle=s,this.ctx.globalAlpha=.3*n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,2.5*i,0,2*Math.PI),this.ctx.fill()}if(this.ctx.fillStyle=s,this.ctx.globalAlpha=t.isStuck?.5:.3,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),t.isStuck&&(this.ctx.fillStyle="#000000",this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.6*i,0,2*Math.PI),this.ctx.fill()),t.isArmed&&t.isStuck){const s=6*t.lifetime,n=e.x+Math.cos(s)*i*.4,o=e.y+Math.sin(s)*i*.4;this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.9,this.ctx.beginPath(),this.ctx.arc(n,o,.3*i,0,2*Math.PI),this.ctx.fill()}else this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.arc(e.x-.3*i,e.y-.3*i,.3*i,0,2*Math.PI),this.ctx.fill();if(t.isStuck&&t.surfaceNormal){this.ctx.strokeStyle=s,this.ctx.globalAlpha=.5,this.ctx.lineWidth=2*this.zoom;const n=1.5*i;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x+t.surfaceNormal.x*n,e.y+t.surfaceNormal.y*n),this.ctx.stroke()}this.ctx.globalAlpha=1}drawStickyLaser(t){const e=this.worldToScreen(t.startPosition),i=t.getEndPosition(),s=this.worldToScreen(i),n=this.getFactionColor(t.owner.faction),o=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=n,this.ctx.globalAlpha=.2*o,this.ctx.lineWidth=t.width*this.zoom*2.5,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.globalAlpha=.5*o,this.ctx.lineWidth=t.width*this.zoom*1.5,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.globalAlpha=.9*o,this.ctx.lineWidth=t.width*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.strokeStyle="#FFFFFF",this.ctx.globalAlpha=.7*o,this.ctx.lineWidth=t.width*this.zoom*.3,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.globalAlpha=1}drawDisintegrationParticle(t){const e=this.worldToScreen(t.position),i=3*this.zoom,s=this.getFactionColor(t.owner.faction),n=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=s,this.ctx.globalAlpha=.3*n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.8*i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=.8*n,this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),Math.random()>.7&&(this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.5*n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.5*i,0,2*Math.PI),this.ctx.fill()),this.ctx.globalAlpha=1}drawLaserBeam(t){const e=this.worldToScreen(t.startPos),i=this.worldToScreen(t.endPos),s=this.getFactionColor(t.owner.faction),n=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=s,this.ctx.globalAlpha=.8*n,this.ctx.lineWidth=t.widthPx,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=.3*n,this.ctx.lineWidth=2*t.widthPx,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=1}drawImpactParticle(t){const e=this.worldToScreen(t.position),i=this.getFactionColor(t.faction),s=1-t.lifetime/t.maxLifetime,n=1*this.zoom;this.ctx.fillStyle=i,this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawSparkleParticle(t){const e=this.worldToScreen(t.position),i=t.getOpacity(),s=t.size*this.zoom;this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.globalAlpha=i,this.ctx.strokeStyle=t.color,this.ctx.lineWidth=Math.max(1,.4*s),this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(-s,0),this.ctx.lineTo(s,0),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,-s),this.ctx.lineTo(0,s),this.ctx.stroke();const n=this.ctx.createRadialGradient(0,0,0,0,0,s);n.addColorStop(0,t.color),n.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(0,0,s,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawDeathParticle(t){const e=this.worldToScreen(t.position);if(t.spriteFragment){this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(t.rotation),this.ctx.globalAlpha=t.opacity;const i=t.spriteFragment.width*this.zoom;this.ctx.drawImage(t.spriteFragment,-i/2,-i/2,i,i),this.ctx.restore()}}drawInfluenceZone(t){const e=this.worldToScreen(t.position),i=t.radius*this.zoom,s=Math.max(.1,1-t.lifetime/t.duration),n=this.getFactionColor(t.owner.faction);this.ctx.strokeStyle=n,this.ctx.globalAlpha=.6*s,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.stroke();const o=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);o.addColorStop(0,`${n}40`),o.addColorStop(1,`${n}10`),this.ctx.fillStyle=o,this.ctx.globalAlpha=.3*s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawInfluenceBallProjectile(t){const e=this.worldToScreen(t.position),i=12*this.zoom,s=this.getFactionColor(t.owner.faction),n=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);n.addColorStop(0,s),n.addColorStop(.5,`${s}AA`),n.addColorStop(1,`${s}00`),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.3*i,0,2*Math.PI),this.ctx.fill()}drawCrescentWave(t){const e=this.worldToScreen(t.position),i=this.getFactionColor(t.owner.faction);this.ctx.save();const s=ia*this.zoom,n=Zr/2,o=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,1.5*s);o.addColorStop(0,`${i}00`),o.addColorStop(.5,`${i}88`),o.addColorStop(1,`${i}00`),this.ctx.strokeStyle=i,this.ctx.lineWidth=.5*s,this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,s,t.angle-n,t.angle+n),this.ctx.stroke(),this.ctx.fillStyle=o,this.ctx.globalAlpha=.4,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.arc(e.x,e.y,1.5*s,t.angle-n,t.angle+n),this.ctx.closePath(),this.ctx.fill();for(let i=0;i<10;i++){const o=t.angle-n+Zr*i/10,r=s*(.8+.2*Math.sin(5*t.lifetime+i)),a=e.x+Math.cos(o)*r,l=e.y+Math.sin(o)*r;this.ctx.fillStyle="#FFFFFF",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(a,l,3*this.zoom,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawDeployedTurret(t,e){const i=this.worldToScreen(t.position),s=e.suns.find(t=>"lad"===t.type);let n=this.getFactionColor(t.owner.faction);s&&t.owner&&(n="light"===(t.owner.stellarForge?e.getLadSide(t.owner.stellarForge.position,s):"light")?"#FFFFFF":"#000000");const o=Ro*this.zoom,r=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_bottom.png",n);if(r){const t=r.width*o,e=r.height*o;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.drawImage(r,-t/2,-e/2,t,e),this.ctx.restore()}let a=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;a=Math.atan2(i,e)}let l=null;if(t.isFiring){const e=Math.floor(t.firingAnimationProgress*Mo),i=`ASSETS/sprites/RADIANT/structures/radiantCannonAnimation/radiantCannonFrame (${Math.min(e,Mo-1)+1}).png`;l=this.getTintedSprite(i,n)}else l=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_top_outline.png",n);if(l){const t=l.width*o,e=l.height*o;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(a+Math.PI/2),this.ctx.drawImage(l,-t/2,-e/2,t,e),this.ctx.restore()}const h=Lo*this.zoom;this.drawHealthDisplay(i,t.health,t.maxHealth,h,-h-10)}drawGrave(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=18*this.zoom,h=o?this.darkenColor("#FFFFFF",$t):"#FFFFFF",c=this.getVelarisGraphemeSpritePath("g");c&&this.drawVelarisGraphemeSprite(c,a.x,a.y,l,h);for(const e of t.getProjectiles())this.drawGraveProjectile(e,r);for(const e of t.getSmallParticles())this.drawGraveSmallParticle(e,r);const d=t.getBlackHole();d&&this.drawGraveBlackHole(d,r);const u=t.getExplosionPositions();if(u.length>0)for(const t of u)this.triggerScreenShake(),this.drawExplosionEffect(t)}drawMergedStarlingRanges(t){const e=[];for(const t of this.selectedUnits)t instanceof Tl&&this.viewingPlayer&&t.owner===this.viewingPlayer&&e.push(t);if(0===e.length)return;const i=this.getFactionColor(this.viewingPlayer.faction);this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.globalAlpha=jn,this.ctx.beginPath();const s=2*Math.PI,n=window.devicePixelRatio||1,o=this.canvas.width/n/2,r=this.canvas.height/n/2,a=this.camera.x,l=this.camera.y,h=this.zoom;for(let t=0;t<e.length;t++){const i=e[t];if(!this.isWithinViewBounds(i.position,i.attackRange))continue;const n=i.position.x,c=i.position.y,d=i.attackRange;let u=!1,p=!1;for(let i=0;i<e.length;i++){if(t===i)continue;const s=e[i],o=s.position.x-n,r=s.position.y-c,a=o*o+r*r,l=s.attackRange;if(a<=1e-4){if(d<=l){u=!0;break}continue}const h=Math.sqrt(a);if(h+d<=l-.5){u=!0;break}const g=Math.abs(d-l);h<d+l-.5&&h>g+.5&&(p=!0)}if(u)continue;const g=o+(n-a)*h,y=r+(c-l)*h,f=d*h;if(!p){this.ctx.moveTo(g+f,y),this.ctx.arc(g,y,f,0,s);continue}const m=Math.min(.25,Math.max(.02,6/Math.max(f,1)));let x=!1;for(let i=0;i<=s+m;i+=m){const u=i>s?s:i,p=n+Math.cos(u)*d,g=c+Math.sin(u)*d;let y=!1;for(let i=0;i<e.length;i++){if(t===i)continue;const s=e[i],n=p-s.position.x,o=g-s.position.y,r=n*n+o*o,a=s.attackRange;if(r<=a*a-.25){y=!0;break}}if(y){x&&(x=!1);continue}const f=o+(p-a)*h,m=r+(g-l)*h;x?this.ctx.lineTo(f,m):(this.ctx.moveTo(f,m),x=!0)}}this.ctx.stroke(),this.ctx.globalAlpha=1}drawVisibleArcSegment(t,e,i,s,n){if(s<=i)return;const o=2*Math.PI;if(s-i<=n)return;const r=i%o,a=s%o;return s-i>=o?(this.ctx.moveTo(t.x+e,t.y),void this.ctx.arc(t.x,t.y,e,0,o)):a<r?(this.ctx.moveTo(t.x+Math.cos(r)*e,t.y+Math.sin(r)*e),this.ctx.arc(t.x,t.y,e,r,o),this.ctx.moveTo(t.x+e,t.y),void this.ctx.arc(t.x,t.y,e,0,a)):(this.ctx.moveTo(t.x+Math.cos(r)*e,t.y+Math.sin(r)*e),void this.ctx.arc(t.x,t.y,e,r,a))}drawStarling(t,e,i,s){const n=this.worldToScreen(t.position),o=8*this.zoom*.3,r=this.selectedUnits.has(t),a=i.suns.find(t=>"lad"===t.type),l=t.owner.faction===Za.VELARIS;let h=!1,c=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;a||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(e,$t))}const d=this.getStarlingSpritePath(t);let u,p=s?this.enemyColor:this.playerColor;a&&t.owner&&(u=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,a):"light",p="light"===u?"#FFFFFF":"#000000");const g=h?this.darkenColor(p,$t):p;if(c=g,a&&u){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,u)}if(l)this.drawVelarisStarlingParticles(n,o,t,c,i.gameTime);else{const e=d?this.getTintedSprite(d,g):null;if(e){const i=o*Et,s=this.getStarlingFacingRotationRad(t);null!==s?(this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(s),this.ctx.drawImage(e,-i/2,-i/2,i,i),this.ctx.restore()):this.ctx.drawImage(e,n.x-i/2,n.y-i/2,i,i)}else{this.ctx.fillStyle=c;const t=c;this.ctx.strokeStyle=r?t:h?this.darkenColor(t,$t):t,this.ctx.lineWidth=r?3:1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke()}}if(this.drawHealthDisplay(n,t.health,t.maxHealth,o,6*-o-10),!s&&t.owner.hasBlinkUpgrade&&t.abilityCooldownTime>0){const e=8*o,i=Math.max(2,3*this.zoom),s=n.x-e/2,r=n.y+3.5*o,a=Math.max(0,Math.min(1,1-t.abilityCooldown/t.abilityCooldownTime));this.ctx.fillStyle="#222",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#00B4FF",this.ctx.fillRect(s,r,e*a,i)}}drawVelarisStarlingParticles(t,e,i,s,n){var o;const r=i.velocity.x,a=i.velocity.y,l=r*r+a*a,h=l>4;let c=!1;if(i.target&&"position"in i.target&&(!("health"in i.target)||i.target.health>0)){const t=i.target.position,e=t.x-i.position.x,s=t.y-i.position.y;e*e+s*s<=i.attackRange*i.attackRange&&(c=!0)}const d=!h&&!c,u=c,p=h&&!c||u;let g=this.starlingParticleStates.get(i);g||(g={shapeBlend:p?1:0,polygonBlend:u?1:0,lastTimeSec:n},this.starlingParticleStates.set(i,g));const y=Math.max(0,n-g.lastTimeSec);g.lastTimeSec=n;const f=Math.min(1,y*this.VELARIS_STARLING_SHAPE_BLEND_SPEED),m=p?1:0,x=u?1:0;g.shapeBlend+=(m-g.shapeBlend)*f,g.polygonBlend+=(x-g.polygonBlend)*f;const S=Math.max(1,this.VELARIS_STARLING_PARTICLE_RADIUS_PX*this.zoom),A=this.brightenAndPaleColor(s),T=this.getStarlingParticleSeed(i)+9.1*i.spriteLevel,_=2*Math.PI,w=Math.sqrt(l),E=p?Math.min(1,w/80):0,b=this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_BASE+E*this.VELARIS_STARLING_TRIANGLE_TIME_SCALE_RANGE,v=n*(this.VELARIS_STARLING_CLOUD_TIME_SCALE+(b-this.VELARIS_STARLING_CLOUD_TIME_SCALE)*g.shapeBlend),P=this.VELARIS_STARLING_PARTICLE_COUNT;if(d){const i=Math.floor(this.getPseudoRandom(T+7.7)*this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS.length),o=this.VELARIS_FORGE_GRAPHEME_SPRITE_PATHS[i],r=.5*(Math.sin(n*this.VELARIS_STARLING_GRAPHEME_PULSE_SPEED+T)+1)*this.VELARIS_STARLING_GRAPHEME_ALPHA_MAX,a=e*this.VELARIS_STARLING_GRAPHEME_SIZE_SCALE;o&&r>0&&(this.ctx.save(),this.ctx.globalAlpha=r,this.drawVelarisGraphemeSprite(o,t.x,t.y,a,s),this.ctx.restore())}this.ctx.save(),this.ctx.fillStyle=A,this.ctx.globalAlpha=.7+.2*g.shapeBlend,this.ctx.beginPath();const C=(null!==(o=this.getStarlingFacingRotationRad(i))&&void 0!==o?o:i.rotation)-Math.PI/2,I=e*this.VELARIS_STARLING_TRIANGLE_RADIUS_SCALE,R=e*this.VELARIS_STARLING_PENTAGON_RADIUS_SCALE,M=e*this.VELARIS_STARLING_CLOUD_RADIUS_SCALE,L=M*this.VELARIS_STARLING_CLOUD_SWIRL_SCALE,F=e*this.VELARIS_STARLING_TRIANGLE_WOBBLE_SCALE,k=_/3,D=_/5;for(let e=0;e<P;e++){const i=T+13.3*e,s=(e/P+v*this.VELARIS_STARLING_TRIANGLE_FLOW_SPEED+.2*this.getPseudoRandom(i+5.9))%1,n=Math.sin(v*this.VELARIS_STARLING_TRIANGLE_WOBBLE_SPEED+i)*F,o=3*s,r=Math.floor(o),a=o-r,l=C+r*k,h=C+(r+1)*k,c=Math.cos(l)*I,d=Math.sin(l)*I,u=Math.cos(h)*I-c,p=Math.sin(h)*I-d,y=Math.sqrt(u*u+p*p)||1,f=c+u*a+-p/y*n,m=d+p*a+u/y*n,x=5*s,A=Math.floor(x),w=x-A,E=C+A*D,b=C+(A+1)*D,O=Math.cos(E)*R,N=Math.sin(E)*R,B=Math.cos(b)*R-O,U=Math.sin(b)*R-N,G=Math.sqrt(B*B+U*U)||1,H=N+U*w+B/G*n,W=f+(O+B*w+-U/G*n-f)*g.polygonBlend,$=m+(H-m)*g.polygonBlend,V=this.getPseudoRandom(i)*_,z=this.getPseudoRandom(i+1.3)*M,j=v*(this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_BASE+this.getPseudoRandom(i+2.1)*this.VELARIS_STARLING_CLOUD_ORBIT_SPEED_VARIANCE)+this.getPseudoRandom(i+3.4)*_,K=.7+.2*Math.sin(v*this.VELARIS_STARLING_CLOUD_PULL_SPEED+i),Y=Math.cos(V)*z*K+Math.cos(j)*L*.3,X=Math.sin(V)*z*K+Math.sin(j)*L*.3,q=Y+(W-Y)*g.shapeBlend,J=X+($-X)*g.shapeBlend,Q=t.x+q,Z=t.y+J;this.ctx.moveTo(Q+S,Z),this.ctx.arc(Q,Z,S,0,_)}this.ctx.fill(),this.ctx.restore()}drawStarlingMoveLines(t){if(!this.viewingPlayer)return;const e=new Map;for(const t of this.selectedUnits)if(t instanceof Tl&&t.owner===this.viewingPlayer&&t.rallyPoint&&t.moveOrder>0){const i=`${t.rallyPoint.x},${t.rallyPoint.y}`;e.has(i)||e.set(i,{rallyPoint:t.rallyPoint,starlings:[]}),e.get(i).starlings.push(t)}const i=this.getFactionColor(this.viewingPlayer.faction);for(const[t,s]of e){if(0===s.starlings.length)continue;let t=s.starlings[0],e=1/0;for(const i of s.starlings){const n=s.rallyPoint.x-i.position.x,o=s.rallyPoint.y-i.position.y,r=n*n+o*o;r<e&&(e=r,t=i)}this.drawMoveOrderIndicator(t.position,s.rallyPoint,t.moveOrder,i)}}drawRay(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y-l),this.ctx.lineTo(a.x-.3*l,a.y),this.ctx.lineTo(a.x+.3*l,a.y),this.ctx.lineTo(a.x,a.y+l),this.ctx.stroke();const h=t.getBeamSegments();for(const t of h){const e=this.worldToScreen(t.startPos),i=this.worldToScreen(t.endPos),s=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=r,this.ctx.globalAlpha=s,this.ctx.lineWidth=ho*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}this.ctx.globalAlpha=1}drawNova(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom;for(let t=0;t<4;t++){const e=Math.PI/4+t*Math.PI/2,i=a.x+Math.cos(e)*l*.3,s=a.y+Math.sin(e)*l*.3,n=a.x+Math.cos(e)*l,o=a.y+Math.sin(e)*l;this.ctx.beginPath(),this.ctx.moveTo(i,s),this.ctx.lineTo(n,o),this.ctx.stroke()}this.ctx.globalAlpha=1}drawInfluenceBall(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=12*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,l,0,2*Math.PI),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(a.x,a.y,.6*l,0,2*Math.PI),this.ctx.stroke()}drawTurretDeployer(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.fillStyle=r,this.ctx.fillRect(a.x-.5*l,a.y-.3*l,l,.6*l),this.ctx.fillRect(a.x-.2*l,a.y-l,.4*l,l)}drawDriller(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);if(t.isHiddenInAsteroid())return;let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}this.drawUnit(t,r,i,s);const a=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=r,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(a.x-l,a.y),this.ctx.lineTo(a.x,a.y-.5*l),this.ctx.lineTo(a.x+l,a.y),this.ctx.lineTo(a.x,a.y+.5*l),this.ctx.closePath(),this.ctx.stroke()}drawDagger(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}let a=!1;if(!s&&t.isCloakedToEnemies()&&(a=!0,this.ctx.globalAlpha=qo),this.drawUnit(t,a?e:r,i,s),a){const i=this.worldToScreen(t.position),s=8*this.zoom;this.ctx.strokeStyle=e,this.ctx.lineWidth=1.5*this.zoom,this.ctx.setLineDash([3*this.zoom,3*this.zoom]),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s+6,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([])}if(!t.isCloakedToEnemies()&&!s){const e=this.worldToScreen(t.position),i=8*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#FF6600",$t):"#FF6600",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x-.7*i,e.y-.7*i),this.ctx.lineTo(e.x+.7*i,e.y+.7*i),this.ctx.stroke()}a&&(this.ctx.globalAlpha=1)}drawBeam(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}if(this.drawUnit(t,r,i,s),!s){const e=this.worldToScreen(t.position),i=10*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#FF0000",$t):"#FF0000",this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x-i,e.y),this.ctx.lineTo(e.x+i,e.y),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y+i),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,.3*i,0,2*Math.PI),this.ctx.stroke()}if(i.gameTime-t.lastBeamTime<2&&t.lastBeamMultiplier>0){const e=this.worldToScreen(t.position),s=-20*this.zoom,n=`(${ir}x${t.lastBeamMultiplier.toFixed(1)})`,o=10*this.zoom;this.ctx.font=`${o}px Doto`,this.ctx.fillStyle="#FFAA00",this.ctx.textAlign="center",this.ctx.textBaseline="bottom";const r=i.gameTime-t.lastBeamTime,a=Math.max(0,1-r/2);this.ctx.globalAlpha=a,this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeText(n,e.x,e.y+s),this.ctx.fillText(n,e.x,e.y+s)}this.ctx.globalAlpha=1}drawSpotlight(t,e,s,n){const o=s.suns.find(t=>"lad"===t.type);let r=!1,a=e;if(n&&this.viewingPlayer){if(!s.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;o||s.isPointInShadow(t.position)&&(r=!0,a=this.darkenColor(e,$t))}this.drawUnit(t,a,s,n);const l=this.worldToScreen(t.position),h=10*this.zoom;if(this.ctx.strokeStyle=a,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y-.6*h),this.ctx.lineTo(l.x+.6*h,l.y),this.ctx.lineTo(l.x,l.y+.6*h),this.ctx.stroke(),t.spotlightDirection&&t.spotlightLengthFactor>0){const e=t.spotlightRangePx*t.spotlightLengthFactor;if(e>0){const s=Math.atan2(t.spotlightDirection.y,t.spotlightDirection.x),n=pr/2,o=s-n,h=s+n,c=new i(t.position.x+Math.cos(o)*e,t.position.y+Math.sin(o)*e),d=new i(t.position.x+Math.cos(h)*e,t.position.y+Math.sin(h)*e),u=l,p=this.worldToScreen(c),g=this.worldToScreen(d),y=r?.12:.18;this.ctx.fillStyle=a,this.ctx.globalAlpha=y,this.ctx.beginPath(),this.ctx.moveTo(u.x,u.y),this.ctx.lineTo(p.x,p.y),this.ctx.lineTo(g.x,g.y),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=.6,this.ctx.strokeStyle=a,this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(u.x,u.y),this.ctx.lineTo(p.x,p.y),this.ctx.moveTo(u.x,u.y),this.ctx.lineTo(g.x,g.y),this.ctx.stroke(),this.ctx.globalAlpha=1}}}drawMortar(t,e,i,s){const n=i.suns.find(t=>"lad"===t.type);let o=!1,r=e;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer,t))return;n||i.isPointInShadow(t.position)&&(o=!0,r=this.darkenColor(e,$t))}if(!s&&t.isSetup&&t.facingDirection){const i=this.worldToScreen(t.position),s=Math.atan2(t.facingDirection.y,t.facingDirection.x),n=vr/2,r=_r*this.zoom;this.ctx.fillStyle=o?this.darkenColor(e,.5*$t):e,this.ctx.globalAlpha=.15,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.arc(i.x,i.y,r,s-n,s+n),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=1,this.ctx.strokeStyle=o?this.darkenColor(e,$t):e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.arc(i.x,i.y,r,s-n,s+n),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.globalAlpha=1}if(this.drawUnit(t,r,i,s),!s&&t.isSetup&&t.facingDirection){const e=this.worldToScreen(t.position),i=Math.atan2(t.facingDirection.y,t.facingDirection.x),s=15*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#888888",$t):"#888888",this.ctx.lineWidth=4*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x+Math.cos(i)*s,e.y+Math.sin(i)*s),this.ctx.stroke()}else if(!s&&!t.isSetup){const e=this.worldToScreen(t.position),i=12*this.zoom;this.ctx.strokeStyle=o?this.darkenColor("#FFAA00",$t):"#FFAA00",this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y-i),this.ctx.lineTo(e.x,e.y-.3*i),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y-.1*i,1.5*this.zoom,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}}drawPreist(t,e,i,s){if(this.drawUnit(t,e,i,s),s)return;const n=t.getHealingBeamTargets(),o=this.worldToScreen(t.position);this.ctx.save();for(const t of n){if(!t)continue;const e=this.worldToScreen(t.position);this.ctx.strokeStyle="#00FF88",this.ctx.lineWidth=3*this.zoom,this.ctx.globalAlpha=.6+.2*Math.sin(5*i.gameTime),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke();const s=5;for(let t=0;t<s;t++){const n=(t/s+.5*i.gameTime)%1,r=o.x+(e.x-o.x)*n,a=o.y+(e.y-o.y)*n;this.ctx.fillStyle="#00FF88",this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(r,a,2*this.zoom,0,2*Math.PI),this.ctx.fill()}}const r=t.getHealingBombParticles();for(const t of r){const e=this.worldToScreen(t.position);this.ctx.fillStyle="#00FF88",this.ctx.globalAlpha=.8*(1-t.lifetime/t.maxLifetime),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,3*this.zoom,0,2*Math.PI),this.ctx.fill();const i=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,8*this.zoom);i.addColorStop(0,"rgba(0, 255, 136, 0.4)"),i.addColorStop(1,"rgba(0, 255, 136, 0)"),this.ctx.fillStyle=i,this.ctx.globalAlpha=.6*(1-t.lifetime/t.maxLifetime),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,8*this.zoom,0,2*Math.PI),this.ctx.fill()}this.ctx.restore()}drawTank(t,e,i,s){this.drawUnit(t,e,i,s);const n=this.worldToScreen(t.position);this.ctx.save();const o=Qr*this.zoom,r=.2+.1*Math.sin(3*i.gameTime);this.ctx.strokeStyle=e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=r,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.stroke();const a=this.ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,o);a.addColorStop(0,"rgba(100, 150, 255, 0)"),a.addColorStop(.7,`rgba(100, 150, 255, ${.3*r})`),a.addColorStop(1,"rgba(100, 150, 255, 0)"),this.ctx.fillStyle=a,this.ctx.globalAlpha=1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawWarpGateProductionEffect(t,e,i,s){const n=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/warpGate_bottom.png",s),o=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/warpGate_top.png",s),r=n||o;if(!r)return this.ctx.fillStyle="rgba(0, 255, 255, 0.2)",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.fill(),void this.ctx.stroke();const a=2*e/r.width,l=i.gameTime,h=.9*l,c=(e,i)=>{if(!e)return;const s=e.width*a,n=e.height*a;this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(i),this.ctx.drawImage(e,-s/2,-n/2,s,n),this.ctx.restore()};c(n,.9*-l),c(o,h)}drawMinigun(t,e,i,s){const n=this.worldToScreen(t.position),o=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);t.owner.faction,Za.VELARIS;let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,$t))}if(!t.isComplete){this.drawWarpGateProductionEffect(n,o,i,c),t.isSelected&&this.drawBuildingSelectionIndicator(n,o);const e=2*o,s=4,r=n.x-e/2,a=n.y+o+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(r,a,e,s),this.ctx.fillStyle="#00FF00",this.ctx.fillRect(r,a,e*t.buildProgress,s),void(h&&(this.ctx.globalAlpha=1))}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,a)}const d=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_bottom.png",c),u=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCannon_top_outline.png",c);if(d&&u){const e=2*o/d.width,i=d.width*e,s=d.height*e;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.drawImage(d,-i/2,-s/2,i,s),this.ctx.restore(),t.isSelected&&this.drawBuildingSelectionIndicator(n,o);let r=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;r=Math.atan2(i,e)}const a=u.width*e,l=u.height*e;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(r+Math.PI/2),this.ctx.drawImage(u,-a/2,-l/2,a,l),this.ctx.restore()}else{this.ctx.fillStyle=c;const e=c;this.ctx.strokeStyle=h?this.darkenColor(e,$t):e,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isSelected&&this.drawBuildingSelectionIndicator(n,o);const i=.6*o;this.ctx.fillStyle=h?this.darkenColor("#666666",$t):"#666666",this.ctx.beginPath(),this.ctx.arc(n.x,n.y,i,0,2*Math.PI),this.ctx.fill();let s=0;if(t.target){const e=t.target.position.x-t.position.x,i=t.target.position.y-t.position.y;s=Math.atan2(i,e)}const r=1.2*o,a=4*this.zoom;this.ctx.strokeStyle=h?this.darkenColor("#333333",$t):"#333333",this.ctx.lineWidth=a,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(n.x+Math.cos(s)*r,n.y+Math.sin(s)*r),this.ctx.stroke()}this.drawHealthDisplay(n,t.health,t.maxHealth,o,-o-10)}drawSpaceDustSwirler(t,e,i,s){const n=this.worldToScreen(t.position),o=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,$t))}if(!t.isComplete){this.drawWarpGateProductionEffect(n,o,i,c),t.isSelected&&this.drawBuildingSelectionIndicator(n,o);const e=2*o,s=4,r=n.x-e/2,a=n.y+o+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(r,a,e,s),this.ctx.fillStyle="#8A2BE2",this.ctx.fillRect(r,a,e*t.buildProgress,s),void(h&&(this.ctx.globalAlpha=1))}const d=t.currentInfluenceRadius*this.zoom;if(this.ctx.strokeStyle=c,this.ctx.globalAlpha=.15,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,d,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,a)}const u=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCyclone_bottom.png",c),p=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCyclone_middle.png",c),g=this.getTintedSprite("ASSETS/sprites/RADIANT/structures/radiantCyclone_top.png",c),y=u||p||g;if(y){const e=2*o/y.width,s=i.gameTime,r=.6*-s,a=.8*s,l=(t,i)=>{if(!t)return;const s=t.width*e,o=t.height*e;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(i),this.ctx.drawImage(t,-s/2,-o/2,s,o),this.ctx.restore()};l(u,0),t.isSelected&&this.drawBuildingSelectionIndicator(n,o),l(p,r),l(g,a)}this.drawHealthDisplay(n,t.health,t.maxHealth,o,-o-10)}drawSubsidiaryFactory(t,e,i,s){const n=this.worldToScreen(t.position),o=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type),a=t.owner.faction===Za.VELARIS;let l,h=e;r&&t.owner&&(l=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",h="light"===l?"#FFFFFF":"#000000");let c=!1,d=h;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(c=!0,d=this.darkenColor(h,$t))}if(!t.isComplete){this.drawWarpGateProductionEffect(n,o,i,d),t.isSelected&&this.drawBuildingSelectionIndicator(n,o);const e=2*o,s=4,r=n.x-e/2,a=n.y+o+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(r,a,e,s),this.ctx.fillStyle="#FFD700",this.ctx.fillRect(r,a,e*t.buildProgress,s),void(c&&(this.ctx.globalAlpha=1))}if(r&&l){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,l)}if(t.owner.faction===Za.AURUM)this.drawAurumFoundryOutline(t,n,.85*o,d,i.gameTime),t.isSelected&&(this.drawBuildingSelectionIndicator(n,o),this.drawFoundryButtons(t,n));else if(a)this.drawVelarisFoundrySigil(t,n,o,d,i.gameTime,c),t.isSelected&&(this.drawBuildingSelectionIndicator(n,o),this.drawFoundryButtons(t,n));else{const e="ASSETS/sprites/RADIANT/structures/radiantFoundry_bottom.png",s="ASSETS/sprites/RADIANT/structures/radiantFoundry_middle.png",r="ASSETS/sprites/RADIANT/structures/radiantFoundry_top.png",a=this.getTintedSprite(e,d),l=this.getTintedSprite(s,d),h=this.getTintedSprite(r,d),c=a||l||h;if(c){const e=2*o/c.width,s=i.gameTime,r=.2,d=2.5,u=.2;let p=1;if(Boolean(t.currentProduction))if(t.productionProgress<u){const e=t.productionProgress/u;p=1+(d-1)*(.5-.5*Math.cos(e*Math.PI))}else p=d;const g=r*p,y=-s*g,f=(t,i)=>{if(!t)return;const s=t.width*e,o=t.height*e;this.ctx.save(),this.ctx.translate(n.x,n.y),this.ctx.rotate(i),this.ctx.drawImage(t,-s/2,-o/2,s,o),this.ctx.restore()};f(a,s*g),t.isSelected&&(this.drawBuildingSelectionIndicator(n,o),this.drawFoundryButtons(t,n)),f(l,0),f(h,y)}}if(t.currentProduction){const e=2*o,i=4,s=n.x-e/2,r=n.y+o+5;this.ctx.fillStyle="#333333",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#4CAF50",this.ctx.fillRect(s,r,e*t.productionProgress,i)}this.drawHealthDisplay(n,t.health,t.maxHealth,o,-o-10)}drawStrikerTower(t,e,i,s){const n=this.worldToScreen(t.position),o=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,$t))}if(!t.isComplete){this.ctx.fillStyle=c,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,t.isSelected&&this.drawBuildingSelectionIndicator(n,o);const e=2*o,i=4,s=n.x-e/2,r=n.y+o+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#FFD700",void this.ctx.fillRect(s,r,e*t.buildProgress,i)}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,a)}this.ctx.fillStyle=c,this.ctx.strokeStyle="#666666",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath();for(let t=0;t<6;t++){const e=Math.PI/3*t,i=n.x+o*Math.cos(e),s=n.y+o*Math.sin(e);0===t?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}if(this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),t.isMissileReady())this.ctx.fillStyle="#FF4444",this.ctx.beginPath(),this.ctx.arc(n.x,n.y,.4*o,0,2*Math.PI),this.ctx.fill();else{const e=t.getReloadProgress();this.ctx.strokeStyle="#FF4444",this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,.4*o,-Math.PI/2,-Math.PI/2+2*Math.PI*e),this.ctx.stroke()}if(t.isInCountdown()){const e=performance.now()/1e3,i=.5+.5*Math.sin(8*e);this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=(4+4*i)*this.zoom,this.ctx.globalAlpha=.6+.4*i,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,1.3*o,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1;const s=Math.ceil(t.getRemainingCountdown());if(s>0&&(this.ctx.fillStyle="#FF0000",this.ctx.font=`bold ${Math.floor(24*this.zoom)}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(s.toString(),n.x,n.y-o-20*this.zoom)),t.targetPosition){const e=this.worldToScreen(t.targetPosition);this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.setLineDash([5*this.zoom,5*this.zoom]),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,15*this.zoom,0,2*Math.PI),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e.x-20*this.zoom,e.y),this.ctx.lineTo(e.x+20*this.zoom,e.y),this.ctx.moveTo(e.x,e.y-20*this.zoom),this.ctx.lineTo(e.x,e.y+20*this.zoom),this.ctx.stroke()}}t.isSelected&&(this.drawBuildingSelectionIndicator(n,o),this.ctx.strokeStyle=c,this.ctx.globalAlpha=.3,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,t.attackRange*this.zoom,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1),this.drawHealthDisplay(n,t.health,t.maxHealth,o,-o-10)}drawStrikerTowerTargetHighlighting(t){if(!this.viewingPlayer)return;let e=null;for(const t of this.viewingPlayer.buildings)if(t instanceof fl&&t.isAwaitingTarget&&t.isMissileReady()){e=t;break}if(!e)return;const s=e.position,n=e.attackRange,o=40,r=Math.floor((s.x-n)/o)*o,a=Math.ceil((s.x+n)/o)*o,l=Math.floor((s.y-n)/o)*o,h=Math.ceil((s.y+n)/o)*o;for(let e=r;e<=a;e+=o)for(let r=l;r<=h;r+=o){const o=new i(e,r);if(s.distanceTo(o)>n)continue;const a=t.isPointInShadow(o),l=t.isPositionVisibleByPlayerUnits(o,this.viewingPlayer.units);if(a&&!l){const t=this.worldToScreen(o),e=performance.now()/1e3,i=.3+.2*Math.sin(3*e);this.ctx.fillStyle=`rgba(255, 0, 0, ${i})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,8*this.zoom,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle=`rgba(255, 0, 0, ${i+.3})`,this.ctx.lineWidth=1.5*this.zoom,this.ctx.beginPath();const s=6*this.zoom;this.ctx.moveTo(t.x-s,t.y),this.ctx.lineTo(t.x+s,t.y),this.ctx.moveTo(t.x,t.y-s),this.ctx.lineTo(t.x,t.y+s),this.ctx.stroke()}}}drawLockOnLaserTower(t,e,i,s){const n=this.worldToScreen(t.position),o=t.radius*this.zoom,r=i.suns.find(t=>"lad"===t.type);let a,l=e;r&&t.owner&&(a=t.owner.stellarForge?i.getLadSide(t.owner.stellarForge.position,r):"light",l="light"===a?"#FFFFFF":"#000000");let h=!1,c=l;if(s&&this.viewingPlayer){if(!i.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;r||i.isPointInShadow(t.position)&&(h=!0,c=this.darkenColor(l,$t))}if(!t.isComplete){this.ctx.fillStyle=c,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1,t.isSelected&&this.drawBuildingSelectionIndicator(n,o);const e=2*o,i=4,s=n.x-e/2,r=n.y+o+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,r,e,i),this.ctx.fillStyle="#FFD700",void this.ctx.fillRect(s,r,e*t.buildProgress,i)}if(r&&a){const t=s?this.enemyColor:this.playerColor;this.drawLadAura(n,o,t,a)}this.ctx.fillStyle=c,this.ctx.strokeStyle="#666666",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath();for(let t=0;t<8;t++){const e=Math.PI/4*t,i=n.x+o*Math.cos(e),s=n.y+o*Math.sin(e);0===t?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();const d=t.getLockedTarget();if(d){const e=t.getLockOnProgress(),i=this.worldToScreen(d.position);this.ctx.strokeStyle=c,this.ctx.globalAlpha=.5,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,20*this.zoom,-Math.PI/2,-Math.PI/2+2*Math.PI*e),this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle=d?"#FF0000":"#444444",this.ctx.beginPath(),this.ctx.arc(n.x,n.y,.3*o,0,2*Math.PI),this.ctx.fill(),t.isSelected&&(this.drawBuildingSelectionIndicator(n,o),this.ctx.strokeStyle=c,this.ctx.globalAlpha=.3,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,t.attackRange*this.zoom,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1),this.drawHealthDisplay(n,t.health,t.maxHealth,o,-o-10)}drawShieldTower(t,e,i,s){const n=this.worldToScreen(t.position),o=t.radius*this.zoom,r=t.isComplete?e:"#666666";if(t.shieldActive&&t.isComplete){const e=t.shieldRadius*this.zoom,i=t.getShieldHealthPercent();this.ctx.strokeStyle=r,this.ctx.globalAlpha=.2+.3*i,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,e,0,2*Math.PI),this.ctx.stroke(),this.ctx.fillStyle=r,this.ctx.globalAlpha=.05+.1*i,this.ctx.fill(),this.ctx.globalAlpha=1}else if(!t.shieldActive&&t.isComplete){const e=t.shieldRadius*this.zoom;this.ctx.strokeStyle="#444444",this.ctx.globalAlpha=.1,this.ctx.lineWidth=2*this.zoom,this.ctx.setLineDash([5*this.zoom,5*this.zoom]),this.ctx.beginPath(),this.ctx.arc(n.x,n.y,e,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=1}this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle=r,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,1.2*o,0,2*Math.PI),this.ctx.stroke();const a=t.shieldActive?r:"#666666";if(this.ctx.fillStyle=a,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,.4*o,0,2*Math.PI),this.ctx.fill(),t.isSelected&&(this.drawBuildingSelectionIndicator(n,o),t.isComplete&&(this.ctx.strokeStyle=r,this.ctx.globalAlpha=.3,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,t.shieldRadius*this.zoom,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1)),this.drawHealthDisplay(n,t.health,t.maxHealth,o,-o-10),t.isComplete){const e=2.5*o,i=4*this.zoom,s=n.x-e/2,r=n.y-o-Xn-i;this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(s,r,e,i);const a=t.shieldActive?t.getShieldHealthPercent():0,l=t.shieldActive?"#00AAFF":"#444444";this.ctx.fillStyle=l,this.ctx.fillRect(s,r,e*a,i),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.strokeRect(s,r,e,i)}}drawGraveProjectile(t,e){const i=this.worldToScreen(t.position),s=4*this.zoom;if(t.isAttacking&&t.trail.length>1){this.ctx.strokeStyle=e,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath();for(let e=0;e<t.trail.length;e++){const i=this.worldToScreen(t.trail[e]);0===e?this.ctx.moveTo(i.x,i.y):this.ctx.lineTo(i.x,i.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle=e,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isAttacking&&(this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,1.5*s,0,2*Math.PI),this.ctx.fill())}drawGraveSmallParticle(t,e){const i=this.worldToScreen(t.position),s=Te*this.zoom;this.ctx.fillStyle=e,this.ctx.globalAlpha=.7,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawGraveBlackHole(t,e){const i=this.worldToScreen(t.position),s=Ce*this.zoom,n=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,s);n.addColorStop(0,"#000000"),n.addColorStop(.4,e),n.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill();const o=2*t.lifetime;for(let t=0;t<8;t++){const n=t/8*Math.PI*2+o,r=.2*s,a=.9*s;this.ctx.beginPath(),this.ctx.moveTo(i.x+Math.cos(n)*r,i.y+Math.sin(n)*r),this.ctx.lineTo(i.x+Math.cos(n)*a,i.y+Math.sin(n)*a),this.ctx.strokeStyle=e,this.ctx.lineWidth=1*this.zoom,this.ctx.globalAlpha=.3,this.ctx.stroke(),this.ctx.globalAlpha=1}}drawExplosionEffect(t){const e=this.worldToScreen(t),i=we*this.zoom,s=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,i);s.addColorStop(0,"rgba(255, 150, 50, 0.6)"),s.addColorStop(.5,"rgba(255, 100, 0, 0.4)"),s.addColorStop(1,"rgba(255, 50, 0, 0)"),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,2*Math.PI),this.ctx.fillStyle=s,this.ctx.fill()}drawStrikerTowerExplosion(t,e){const i=this.worldToScreen(t.position),s=Ji*this.zoom,n=Math.min(1,3*e),o=Math.max(0,1-e),r=s*n;for(let t=0;t<3;t++){const n=e-.1*t;if(n<0)continue;const o=s*Math.min(1,3*n),r=.6*Math.max(0,1-n);this.ctx.strokeStyle=`rgba(255, 200, 100, ${r})`,this.ctx.lineWidth=(6-2*t)*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,2*Math.PI),this.ctx.stroke()}const a=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,r);a.addColorStop(0,`rgba(255, 255, 200, ${.9*o})`),a.addColorStop(.3,`rgba(255, 150, 50, ${.7*o})`),a.addColorStop(.6,`rgba(255, 50, 0, ${.5*o})`),a.addColorStop(1,"rgba(100, 0, 0, 0)"),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,r,0,2*Math.PI),this.ctx.fillStyle=a,this.ctx.fill(),this.shakenExplosions.has(t)||(this.triggerScreenShake(15),this.shakenExplosions.add(t))}drawConnections(t,e,i,s){if(t.stellarForge&&(!this.viewingPlayer||t===this.viewingPlayer))for(const n of t.solarMirrors){if(!this.isWithinViewBounds(n.position,120))continue;const o=this.worldToScreen(n.position),r=n.getLinkedStructure(t.stellarForge),a=n.hasLineOfSightToLight(e,i),l=a?n.getClosestVisibleSun(e,i):n.getClosestSun(e),h=!!r&&n.hasLineOfSightToStructure(r,i,s);if(l&&!a){const t=this.worldToScreen(l.position);this.ctx.strokeStyle="rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}if(r&&!h){const t=this.worldToScreen(r.position);this.ctx.strokeStyle="rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}a&&h&&(this.ctx.fillStyle="rgba(255, 255, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,Fn*this.zoom,0,2*Math.PI),this.ctx.fill())}}drawUI(t){if(this.showInfo){const e=window.devicePixelRatio||1,i=this.canvas.width/e,s=this.canvas.height/e,n=i<600,o=n?13:16,r=o+4,a=Math.min(300,i-20),l=20+5*r+60*t.players.length;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,10,a,l),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${o}px Doto`;let h=30;this.ctx.fillText("SoL - Speed of Light RTS",20,h),h+=r,this.ctx.fillText(`Game Time: ${t.gameTime.toFixed(1)}s`,20,h),h+=r,this.ctx.fillText(`Dust Particles: ${t.spaceDust.length}`,20,h),h+=r,this.ctx.fillText(`Asteroids: ${t.asteroids.length}`,20,h),h+=r,this.ctx.fillText(`Warp Gates: ${t.warpGates.length}`,20,h);let c=h+r;for(const e of t.players){const t=this.getFactionColor(e.faction);if(this.ctx.fillStyle=t,this.ctx.fillText(`${e.name} (${e.faction})`,20,c),this.ctx.fillStyle="#FFFFFF",this.ctx.fillText(`Energy: ${e.energy.toFixed(1)}`,20,c+20),e.stellarForge){const t=e.stellarForge.isReceivingLight?" Light":" No Light";this.ctx.fillText(`${t} | HP: ${e.stellarForge.health.toFixed(0)}`,20,c+40)}c+=60}const d=n?sp.CONTROL_LINES_COMPACT:sp.CONTROL_LINES_FULL,u=n?12:14,p=u+4,g=Math.min(450,i-20),y=p*d.length+14,f=10,m=s-y-10;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(f,m,g,y),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${u}px Doto`;let x=m+p;for(const t of d)this.ctx.fillText(t,20,x),x+=p}}drawSelectionRectangle(){if(!this.selectionStart||!this.selectionEnd)return;const t=Math.min(this.selectionStart.x,this.selectionEnd.x),e=Math.min(this.selectionStart.y,this.selectionEnd.y),i=Math.abs(this.selectionEnd.x-this.selectionStart.x),s=Math.abs(this.selectionEnd.y-this.selectionStart.y);this.ctx.strokeStyle="rgba(0, 255, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="rgba(0, 255, 0, 0.1)",this.ctx.fillRect(t,e,i,s),this.ctx.setLineDash([])}drawAbilityArrow(){if(!this.abilityArrowDirection||0===this.abilityArrowStarts.length)return;this.ctx.strokeStyle="rgba(255, 215, 0, 0.9)",this.ctx.lineWidth=4,this.ctx.setLineDash([]);const t=this.abilityArrowLengthPx;for(const e of this.abilityArrowStarts){const i=t;if(i<Yn)continue;const s=e.x+this.abilityArrowDirection.x*i,n=e.y+this.abilityArrowDirection.y*i;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s,n),this.ctx.stroke();const o=Math.atan2(this.abilityArrowDirection.y,this.abilityArrowDirection.x),r=20,a=Math.PI/6;this.ctx.beginPath(),this.ctx.moveTo(s,n),this.ctx.lineTo(s-r*Math.cos(o-a),n-r*Math.sin(o-a)),this.ctx.lineTo(s-r*Math.cos(o+a),n-r*Math.sin(o+a)),this.ctx.closePath(),this.ctx.fillStyle="rgba(255, 215, 0, 0.9)",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,8,0,2*Math.PI),this.ctx.fillStyle="rgba(255, 215, 0, 0.5)",this.ctx.fill()}}drawBuildingAbilityArrow(){if(!this.buildingAbilityArrowDirection||!this.buildingAbilityArrowStart)return;const t=this.buildingAbilityArrowLengthPx;if(t<Yn)return;const e=this.buildingAbilityArrowStart.x+this.buildingAbilityArrowDirection.x*t,i=this.buildingAbilityArrowStart.y+this.buildingAbilityArrowDirection.y*t;this.ctx.strokeStyle="rgba(0, 255, 136, 0.9)",this.ctx.lineWidth=4,this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(this.buildingAbilityArrowStart.x,this.buildingAbilityArrowStart.y),this.ctx.lineTo(e,i),this.ctx.stroke();const s=Math.atan2(this.buildingAbilityArrowDirection.y,this.buildingAbilityArrowDirection.x),n=Math.PI/6;this.ctx.beginPath(),this.ctx.moveTo(e,i),this.ctx.lineTo(e-20*Math.cos(s-n),i-20*Math.sin(s-n)),this.ctx.lineTo(e-20*Math.cos(s+n),i-20*Math.sin(s+n)),this.ctx.closePath(),this.ctx.fillStyle="rgba(0, 255, 136, 0.9)",this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(this.buildingAbilityArrowStart.x,this.buildingAbilityArrowStart.y,8,0,2*Math.PI),this.ctx.fillStyle="rgba(0, 255, 136, 0.5)",this.ctx.fill()}drawUnitPathPreview(){if(!this.pathPreviewForge&&this.pathPreviewPoints.length>0){let t=0,e=0,s=0;if(this.selectedUnits.size>0)for(const i of this.selectedUnits)t+=i.position.x,e+=i.position.y,s++;else if(this.selectedMirrors.size>0)for(const i of this.selectedMirrors)t+=i.position.x,e+=i.position.y,s++;if(s>0){const n=new i(t/s,e/s);this.drawMinionPathPreview(n,this.pathPreviewPoints,this.pathPreviewEnd)}}}drawMinionPathPreview(t,e,i){this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=3,this.ctx.setLineDash([6,6]),this.ctx.beginPath();const s=this.worldToScreen(t);this.ctx.moveTo(s.x,s.y);for(let t=0;t<e.length;t++){const i=this.worldToScreen(e[t]);this.ctx.lineTo(i.x,i.y)}if(i){const t=this.worldToScreen(i);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(255, 255, 0, 0.9)";for(let t=0;t<e.length;t++){const i=this.worldToScreen(e[t]);this.ctx.beginPath(),this.ctx.arc(i.x,i.y,4,0,2*Math.PI),this.ctx.fill()}if(i){const t=this.worldToScreen(i);this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,6,0,2*Math.PI),this.ctx.stroke()}}createTapEffect(t,e){this.tapEffects.push({position:new i(t,e),progress:0})}createSwipeEffect(t,e,s,n){this.swipeEffects.push({start:new i(t,e),end:new i(s,n),progress:0})}createWarpGateShockwave(t){this.warpGateShockwaves.push({position:new i(t.x,t.y),progress:0})}createProductionButtonWave(t){this.productionButtonWaves.push({position:new i(t.x,t.y),progress:0})}updateAndDrawTapEffects(){for(let t=this.tapEffects.length-1;t>=0;t--){const e=this.tapEffects[t];if(e.progress+=qn,e.progress>=1){this.tapEffects.splice(t,1);continue}const i=Jn*e.progress,s=1-e.progress;this.ctx.strokeStyle=`rgba(100, 200, 255, ${s})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,i,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(e.position.x,e.position.y,0,e.position.x,e.position.y,.5*i);n.addColorStop(0,`rgba(100, 200, 255, ${.5*s})`),n.addColorStop(1,"rgba(100, 200, 255, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,.5*i,0,2*Math.PI),this.ctx.fill()}}updateAndDrawSwipeEffects(){for(let t=this.swipeEffects.length-1;t>=0;t--){const e=this.swipeEffects[t];if(e.progress+=Qn,e.progress>=1){this.swipeEffects.splice(t,1);continue}const i=e.end.x-e.start.x,s=e.end.y-e.start.y,n=Math.sqrt(i*i+s*s);if(n<5)continue;const o=1-e.progress,r=n*e.progress;this.ctx.strokeStyle=`rgba(255, 200, 100, ${.7*o})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(e.start.x,e.start.y);const a=e.start.x+i/n*r,l=e.start.y+s/n*r;if(this.ctx.lineTo(a,l),this.ctx.stroke(),e.progress>.3){const t=Math.atan2(s,i);this.ctx.fillStyle=`rgba(255, 200, 100, ${o})`,this.ctx.beginPath(),this.ctx.moveTo(a,l),this.ctx.lineTo(a-eo*Math.cos(t-Math.PI/6),l-eo*Math.sin(t-Math.PI/6)),this.ctx.lineTo(a-eo*Math.cos(t+Math.PI/6),l-eo*Math.sin(t+Math.PI/6)),this.ctx.closePath(),this.ctx.fill()}for(let t=0;t<5;t++){const a=t/5,l=e.start.x+i/n*r*a,h=e.start.y+s/n*r*a,c=o*(1-a)*.3,d=this.ctx.createRadialGradient(l,h,0,l,h,10);d.addColorStop(0,`rgba(255, 200, 100, ${c})`),d.addColorStop(1,"rgba(255, 200, 100, 0)"),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(l,h,10,0,2*Math.PI),this.ctx.fill()}}}updateAndDrawWarpGateShockwaves(){for(let t=this.warpGateShockwaves.length-1;t>=0;t--){const e=this.warpGateShockwaves[t];if(e.progress+=_,e.progress>=1){this.warpGateShockwaves.splice(t,1);continue}const i=this.worldToScreen(e.position),s=T*e.progress*this.zoom,n=.8*(1-e.progress);this.ctx.strokeStyle=`rgba(0, 255, 255, ${n})`,this.ctx.lineWidth=Math.max(2,3*this.zoom),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.stroke()}}updateAndDrawProductionButtonWaves(){for(let t=this.productionButtonWaves.length-1;t>=0;t--){const e=this.productionButtonWaves[t];if(e.progress+=to,e.progress>=1){this.productionButtonWaves.splice(t,1);continue}const i=this.worldToScreen(e.position),s=Zn*e.progress*this.zoom,n=.9*(1-e.progress);this.ctx.strokeStyle=`rgba(255, 215, 0, ${n})`,this.ctx.lineWidth=Math.max(1,2*this.zoom),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.stroke();const o=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,s);o.addColorStop(0,`rgba(255, 215, 0, ${.35*n})`),o.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,.6*s,0,2*Math.PI),this.ctx.fill()}}drawDamageNumbers(t){for(const e of t.damageNumbers){const i=this.worldToScreen(e.position),s=e.getOpacity(t.gameTime),n="remaining-life"===this.damageDisplayMode?e.remainingHealth:e.damage,o=e.damage/e.maxHealth,r=Math.max(8,Math.min(24,8+80*o));if(this.ctx.font=`bold ${r}px Doto`,"remaining-life"===this.damageDisplayMode){const t=e.remainingHealth/e.maxHealth,i=this.getHealthColor(t);this.ctx.fillStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${s})`}else this.ctx.fillStyle=`rgba(255, 100, 100, ${s})`;this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeStyle=`rgba(0, 0, 0, ${.8*s})`,this.ctx.lineWidth=2,this.ctx.strokeText(n.toString(),i.x,i.y),this.ctx.fillText(n.toString(),i.x,i.y)}}getHealthColor(t){if(t>.6){const e=(t-.6)/.4;return{r:Math.round(255*(1-e)),g:255,b:0}}if(t>.3){const e=(t-.3)/.3;return{r:255,g:Math.round(165+90*e),b:0}}{const e=t/.3;return{r:Math.round(180+75*e),g:Math.round(165*e),b:0}}}drawHealthDisplay(t,e,i,s,n,o=!1,r){if(e>=i)return;const a=e/i;if("bar"===this.healthDisplayMode){const e=3*s,i=3,l=t.x-e/2,h=t.y+n;if(this.ctx.fillStyle="#333",this.ctx.fillRect(l,h,e,i),this.ctx.fillStyle=a>.5?"#00FF00":a>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(l,h,e*a,i),o){const t=8,s=l+e+5,n=h+i/2;this.ctx.strokeStyle=r||"#00FF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(s-t/2,n),this.ctx.lineTo(s+t/2,n),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(s,n-t/2),this.ctx.lineTo(s,n+t/2),this.ctx.stroke()}}else{const i=this.getHealthColor(a),l=Math.max(10,1.5*s);if(this.ctx.font=`bold ${l}px Doto`,this.ctx.fillStyle=`rgb(${i.r}, ${i.g}, ${i.b})`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeText(Math.round(e).toString(),t.x,t.y+n),this.ctx.fillText(Math.round(e).toString(),t.x,t.y+n),o){const e=.6*l,i=t.x+.8*l,s=t.y+n-l/2;this.ctx.strokeStyle=r||"#00FF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i-e/2,s),this.ctx.lineTo(i+e/2,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(i,s-e/2),this.ctx.lineTo(i,s+e/2),this.ctx.stroke()}}}isOffScreen(t){const e=this.worldToScreen(t),i=window.devicePixelRatio||1,s=this.canvas.width/i,n=this.canvas.height/i;return e.x<0||e.x>s||e.y<0||e.y>n}getEdgePosition(t,e){const i=this.worldToScreen(t),s=window.devicePixelRatio||1,n=this.canvas.width/s,o=this.canvas.height/s,r=n/2,a=o/2,l=i.x-r,h=i.y-a,c=Math.atan2(h,l);let d=i.x,u=i.y;return i.x<0?d=0:i.x>n&&(d=n),i.y<0?u=0:i.y>o&&(u=o),{x:d,y:u,angle:c}}drawOffScreenUnitIndicators(t){if(!this.viewingPlayer)return;this.ctx.save(),this.ctx.globalAlpha=this.offscreenIndicatorOpacity,window.devicePixelRatio;const e=t.suns.find(t=>"lad"===t.type),i=36;for(const t of this.viewingPlayer.units){if(!this.isOffScreen(t.position))continue;const e=t instanceof Tl?12:20,i=this.getEdgePosition(t.position,e);this.ctx.strokeStyle=this.playerColor,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e/2,0,2*Math.PI),this.ctx.stroke()}for(const t of this.viewingPlayer.solarMirrors){if(!this.isOffScreen(t.position))continue;const e=this.getEdgePosition(t.position,24);this.ctx.fillStyle=this.playerColor,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,12,0,2*Math.PI),this.ctx.fill()}for(const t of this.viewingPlayer.buildings){if(!this.isOffScreen(t.position))continue;const e=t instanceof yl?i:28,s=this.getEdgePosition(t.position,e);this.ctx.fillStyle=this.playerColor,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,e/2,0,2*Math.PI),this.ctx.fill()}if(this.viewingPlayer.stellarForge&&!this.viewingPlayer.isDefeated()){const t=this.viewingPlayer.stellarForge;if(this.isOffScreen(t.position)){const e=this.getEdgePosition(t.position,i);this.ctx.fillStyle=this.playerColor,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,18,0,2*Math.PI),this.ctx.fill()}}for(const s of t.players){if(s===this.viewingPlayer||s.isDefeated())continue;const n=this.getLadPlayerColor(s,e,t);for(const e of s.units){if(!this.isOffScreen(e.position))continue;if(!t.isObjectVisibleToPlayer(e.position,this.viewingPlayer,e))continue;const i=e instanceof Tl?12:20,s=this.getEdgePosition(e.position,i);this.colorblindMode?(this.ctx.save(),this.ctx.translate(s.x,s.y),this.ctx.rotate(Math.PI/4),this.ctx.strokeStyle=n,this.ctx.lineWidth=2,this.ctx.strokeRect(-i/2,-i/2,i,i),this.ctx.restore()):(this.ctx.strokeStyle=n,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,i/2,0,2*Math.PI),this.ctx.stroke())}for(const e of s.solarMirrors){if(!this.isOffScreen(e.position))continue;if(!t.isObjectVisibleToPlayer(e.position,this.viewingPlayer,e))continue;const i=this.getEdgePosition(e.position,24);this.colorblindMode?(this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(Math.PI/4),this.ctx.fillStyle=n,this.ctx.fillRect(-12,-12,24,24),this.ctx.restore()):(this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,12,0,2*Math.PI),this.ctx.fill())}for(const e of s.buildings){if(!this.isOffScreen(e.position))continue;if(!t.isObjectVisibleToPlayer(e.position,this.viewingPlayer,e))continue;const s=e instanceof yl?i:28,o=this.getEdgePosition(e.position,s);this.colorblindMode?(this.ctx.save(),this.ctx.translate(o.x,o.y),this.ctx.rotate(Math.PI/4),this.ctx.fillStyle=n,this.ctx.fillRect(-s/2,-s/2,s,s),this.ctx.restore()):(this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,s/2,0,2*Math.PI),this.ctx.fill())}if(s.stellarForge){const e=s.stellarForge;if(this.isOffScreen(e.position)&&t.isObjectVisibleToPlayer(e.position,this.viewingPlayer,e)){const t=this.getEdgePosition(e.position,i);this.colorblindMode?(this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(Math.PI/4),this.ctx.fillStyle=n,this.ctx.fillRect(-18,-18,i,i),this.ctx.restore()):(this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,18,0,2*Math.PI),this.ctx.fill())}}}this.ctx.restore()}render(t){this.ctx.fillStyle=this.colorScheme.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.updateViewBounds();const e=t.suns.find(t=>"lad"===t.type);if(e&&this.drawLadSunRays(t,e),!e)for(const t of this.starLayers){this.ctx.fillStyle="#FFFFFF";const e=window.devicePixelRatio||1;for(const i of t.stars){const s=this.parallaxCamera.x*t.parallaxFactor,n=this.parallaxCamera.y*t.parallaxFactor,o=this.canvas.width/e/2,r=this.canvas.height/e/2,a=o+(i.x-s),l=r+(i.y-n),h=(a+o)%(2*o+Nt)-o,c=(l+r)%(2*r+Nt)-r;h>=-100&&h<=this.canvas.width/e+100&&c>=-100&&c<=this.canvas.height/e+100&&(this.ctx.globalAlpha=i.brightness,this.ctx.fillRect(h,c,i.size,i.size))}this.ctx.globalAlpha=1}const i=this.viewingPlayer?t.players.indexOf(this.viewingPlayer):null;for(const e of t.spaceDust)this.isWithinRenderBounds(e.position,t.mapSize,10)&&this.isWithinViewBounds(e.position,60)&&this.drawSpaceDust(e,t,i);for(const e of t.suns)this.isWithinViewBounds(e.position,2*e.radius)&&this.drawSun(e);e||this.drawSunRays(t);for(const e of t.suns)this.drawLensFlare(e);for(const e of t.asteroids)this.isWithinRenderBounds(e.position,t.mapSize,e.size)&&this.isWithinViewBounds(e.position,2*e.size)&&this.drawAsteroid(e);const s=[];for(let e=0;e<t.players.length;e++){const n=t.players[e];if((null===i||e===i)&&n.stellarForge&&!n.isDefeated()){const t=0===e?this.playerColor:this.enemyColor;s.push({position:n.stellarForge.position,radius:o,color:t})}}const n=new Map;for(const t of s)n.has(t.color)||n.set(t.color,[]),n.get(t.color).push({position:t.position,radius:t.radius});for(const[t,e]of n)if(1===e.length)this.isWithinViewBounds(e[0].position,e[0].radius)&&this.drawInfluenceCircle(e[0].position,e[0].radius,t);else{this.ctx.save(),this.ctx.beginPath();for(const t of e){if(!this.isWithinViewBounds(t.position,t.radius))continue;const e=this.worldToScreen(t.position),i=t.radius*this.zoom;this.ctx.moveTo(e.x+i,e.y),this.ctx.arc(e.x,e.y,i,0,2*Math.PI)}this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle=t,this.ctx.globalAlpha=.05,this.ctx.fill(),this.ctx.globalAlpha=.3,this.ctx.strokeStyle=t,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}for(const e of t.players)e.isDefeated()||this.drawConnections(e,t.suns,t.asteroids,t.players);for(const i of t.players){if(i.isDefeated())continue;const s=this.getLadPlayerColor(i,e,t),n=null!==this.viewingPlayer&&i!==this.viewingPlayer;for(const e of i.solarMirrors)this.isWithinViewBounds(e.position,120)&&this.drawSolarMirror(e,s,t,n,t.gameTime);i.stellarForge&&this.isWithinViewBounds(i.stellarForge.position,3*i.stellarForge.radius)&&this.drawStellarForge(i.stellarForge,s,t,n)}for(const i of t.warpGates)this.isWithinViewBounds(i.position,2*m)&&this.drawWarpGate(i,t,e);for(const e of t.starlingMergeGates)this.isWithinViewBounds(e.position,4*ks)&&this.drawStarlingMergeGate(e);this.updateAndDrawWarpGateShockwaves(),this.drawMergedStarlingRanges(t);for(const i of t.players){if(i.isDefeated())continue;const s=this.getLadPlayerColor(i,e,t),n=null!==this.viewingPlayer&&i!==this.viewingPlayer;for(const e of i.units){const i=e.isHero?120:60;this.isWithinViewBounds(e.position,i)&&(e instanceof kl?this.drawGrave(e,s,t,n):e instanceof Tl?this.drawStarling(e,s,t,n):e instanceof Bl?this.drawRay(e,s,t,n):e instanceof eh?this.drawNova(e,s,t,n):e instanceof Gl?this.drawInfluenceBall(e,s,t,n):e instanceof $l?this.drawTurretDeployer(e,s,t,n):e instanceof zl?this.drawDriller(e,s,t,n):e instanceof jl?this.drawDagger(e,s,t,n):e instanceof Kl?this.drawBeam(e,s,t,n):e instanceof Ql?this.drawSpotlight(e,s,t,n):e instanceof Yl?this.drawMortar(e,s,t,n):e instanceof ql?this.drawPreist(e,s,t,n):e instanceof Zl?this.drawTank(e,s,t,n):this.drawUnit(e,s,t,n))}}this.drawStarlingMoveLines(t);for(const i of t.players){if(i.isDefeated())continue;const s=this.getLadPlayerColor(i,e,t),n=null!==this.viewingPlayer&&i!==this.viewingPlayer;for(const e of i.buildings)this.isWithinViewBounds(e.position,2*e.radius)&&(e instanceof ul||e instanceof pl?this.drawMinigun(e,s,t,n):e instanceof gl?this.drawSpaceDustSwirler(e,s,t,n):e instanceof yl?this.drawSubsidiaryFactory(e,s,t,n):e instanceof fl?this.drawStrikerTower(e,s,t,n):e instanceof ml?this.drawLockOnLaserTower(e,s,t,n):e instanceof xl&&this.drawShieldTower(e,s,t,n))}for(const e of t.muzzleFlashes)this.isWithinViewBounds(e.position,80)&&this.drawMuzzleFlash(e);for(const e of t.bulletCasings)this.isWithinViewBounds(e.position,60)&&this.drawBulletCasing(e);for(const e of t.bouncingBullets)this.isWithinViewBounds(e.position,60)&&this.drawBouncingBullet(e);for(const e of t.abilityBullets)this.isWithinViewBounds(e.position,80)&&this.drawAbilityBullet(e);for(const e of t.minionProjectiles)this.isWithinViewBounds(e.position,80)&&this.drawMinionProjectile(e);for(const e of t.mortarProjectiles)this.isWithinViewBounds(e.position,100)&&this.drawMortarProjectile(e);for(const e of t.laserBeams)(this.isWithinViewBounds(e.startPos,200)||this.isWithinViewBounds(e.endPos,200))&&this.drawLaserBeam(e);if("high"===this.graphicsQuality)for(const e of t.impactParticles)this.isWithinViewBounds(e.position,120)&&this.drawImpactParticle(e);for(const e of t.sparkleParticles)this.isWithinViewBounds(e.position,50)&&this.drawSparkleParticle(e);for(const e of t.deathParticles)this.isWithinViewBounds(e.position,100)&&this.drawDeathParticle(e);for(const e of t.strikerTowerExplosions)this.isWithinViewBounds(e.position,2*Ji)&&this.drawStrikerTowerExplosion(e,t.gameTime-e.timestamp);for(const e of t.influenceZones)this.isWithinViewBounds(e.position,e.radius)&&this.drawInfluenceZone(e);for(const e of t.influenceBallProjectiles)this.isWithinViewBounds(e.position,100)&&this.drawInfluenceBallProjectile(e);for(const e of t.crescentWaves)this.isWithinViewBounds(e.position,2*ia)&&this.drawCrescentWave(e);for(const e of t.novaBombs)this.isWithinViewBounds(e.position,100)&&this.drawNovaBomb(e);for(const e of t.novaScatterBullets)this.isWithinViewBounds(e.position,100)&&this.drawNovaScatterBullet(e);for(const e of t.stickyBombs)this.isWithinViewBounds(e.position,100)&&this.drawStickyBomb(e);for(const e of t.stickyLasers)this.isWithinViewBounds(e.startPosition,600)&&this.drawStickyLaser(e);for(const e of t.disintegrationParticles)this.isWithinViewBounds(e.position,50)&&this.drawDisintegrationParticle(e);for(const e of t.deployedTurrets)this.isWithinViewBounds(e.position,2*Lo)&&this.drawDeployedTurret(e,t);this.drawDamageNumbers(t),this.drawBorderFade(t.mapSize),this.drawOffScreenUnitIndicators(t),this.drawStrikerTowerTargetHighlighting(t),this.drawMirrorCommandButtons(this.selectedMirrors,t.gameTime),this.drawUI(t),this.drawSelectionRectangle(),this.drawAbilityArrow(),this.drawBuildingAbilityArrow(),this.drawUnitPathPreview(),this.updateAndDrawProductionButtonWaves(),this.updateAndDrawTapEffects(),this.updateAndDrawSwipeEffects();const r=t.checkVictoryConditions();if(r&&this.drawEndGameStatsScreen(t,r),t.isCountdownActive){this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFD700",this.ctx.font="bold 120px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const e=Math.ceil(t.countdownTime),i=e>0?e.toString():"Go!";this.ctx.fillText(i,this.canvas.width/2,this.canvas.height/2),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}t.isCountdownActive||r||this.drawMenuButton(),t.isCountdownActive||r||this.drawProductionProgress(t),this.showInGameMenu&&!r&&this.drawInGameMenuOverlay()}drawMenuButton(){window.devicePixelRatio;this.ctx.fillStyle="rgba(50, 50, 50, 0.8)",this.ctx.fillRect(10,10,50,50),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(10,10,50,50),this.ctx.fillStyle="#FFFFFF";this.ctx.fillRect(20,22.5,30,3),this.ctx.fillRect(20,33.5,30,3),this.ctx.fillRect(20,44.5,30,3)}drawProductionProgress(t){var e;const i=window.devicePixelRatio||1,s=200,n=60,o=this.canvas.width/i-s-10;let r=10;const a=t.players.find(t=>!t.isAi);if(!a)return;this.ctx.save(),this.ctx.globalAlpha=this.infoBoxOpacity;const l=30;if(a.stellarForge){const t=a.stellarForge,e=t.incomingLightPerSec;this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(o,r,s,l),this.ctx.strokeStyle=t.isReceivingLight?"#00FF00":"#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(o,r,s,l);const i=this.getSolEnergyIcon(),n=22,h=o+4,c=r+4;i.complete&&i.naturalWidth>0&&this.ctx.drawImage(i,h,c,n,n),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(`${e.toFixed(1)}/s`,o+8+n+4,r+15),r+=35}const h=a.units.filter(t=>t instanceof Tl).length,c=Math.max(0,Qe-h),d=a.stellarForge,u=null!==(e=null==d?void 0:d.pendingEnergy)&&void 0!==e?e:0,p=(null==d?void 0:d.isReceivingLight)?u+d.incomingLightPerSec*Math.max(0,d.crunchTimer):u,g=Math.min(Math.floor(p/pi),c);this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(o,r,s,l),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(o,r,s,l),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="middle";const y=d?` (+${g})`:"";if(this.ctx.fillText(` ${h}${y}`,o+8,r+15),r+=35,this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(o,r,s,l),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(o,r,s,l),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(` ${h}/${Qe}`,o+8,r+15),r+=38,a.stellarForge&&a.stellarForge.heroProductionUnitType){const t=a.stellarForge;this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(o,r,s,n),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(o,r,s,n),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const e=this.getProductionDisplayName(t.heroProductionUnitType);this.ctx.fillText(e,o+8,r+8);const i=t.heroProductionDurationSec>0?1-t.heroProductionRemainingSec/t.heroProductionDurationSec:0;this.drawProgressBar(o+8,r+32,184,16,i),r+=68}const f=a.buildings.find(t=>t instanceof yl);if(null==f?void 0:f.currentProduction){this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(o,r,s,n),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(o,r,s,n),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const t=this.getProductionDisplayName(f.currentProduction);this.ctx.fillText(`Foundry ${t}`,o+8,r+8),this.drawProgressBar(o+8,r+32,184,16,f.productionProgress),r+=68}const m=a.buildings.find(t=>!t.isComplete);if(m){this.ctx.fillStyle="rgba(50, 50, 50, 0.9)",this.ctx.fillRect(o,r,s,n),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(o,r,s,n),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Doto",this.ctx.textAlign="left",this.ctx.textBaseline="top";const t=this.getBuildingDisplayName(m);this.ctx.fillText(`Building ${t}`,o+8,r+8),this.drawProgressBar(o+8,r+32,184,16,m.buildProgress)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",this.ctx.restore()}drawProgressBar(t,e,i,s,n){this.ctx.fillStyle="rgba(100, 100, 100, 0.8)",this.ctx.fillRect(t,e,i,s),this.ctx.fillStyle="#4CAF50",this.ctx.fillRect(t,e,i*n,s),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=1,this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Doto",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`${Math.floor(100*n)}%`,t+i/2,e+s/2)}getBuildingDisplayName(t){return t instanceof pl?"Gatling Tower":t instanceof ul?"Cannon":t instanceof gl?"Cyclone":t instanceof yl?"Foundry":t instanceof fl?"Striker Tower":t instanceof ml?"Lock-on Tower":t instanceof xl?"Shield Tower":"Building"}getProductionDisplayName(t){return{marine:"Marine",grave:"Grave",ray:"Ray",influenceball:"Influence Ball",turretdeployer:"Turret Deployer",driller:"Driller",dagger:"Dagger",beam:"Beam",spotlight:"Spotlight","solar-mirror":"Solar Mirror","strafe-upgrade":"Strafe Upgrade","regen-upgrade":"Regen Upgrade","attack-upgrade":"+1 ATK","blink-upgrade":"Blink Upgrade"}[t.toLowerCase()]||t}getInGameMenuLayout(){return function(t,e){const i=window.devicePixelRatio||1,s=t/i,n=e/i,o=s<600,r=Math.min(480,s-40),a=Math.min(460,n-40),l=(s-r)/2,h=(n-a)/2,c=o?14:20,d=h+(o?34:42),u=o?30:34,p=(r-2*c-24)/3,g=d+(o?16:18),y=l+c,f=[{tab:"main",x:y,y:g,width:p,height:u},{tab:"options",x:y+p+12,y:g,width:p,height:u},{tab:"graphics",x:y+2*(p+12),y:g,width:p,height:u}],m=g+u+(o?16:20),x=h+a-(o?16:20),S=Math.min(300,r-2*c),A=l+c,T=A,_=m,w=r-2*c,E=o?34:38,b=o?10:12,v=o?150:190,P=o?8:10,C=_+(2*E+b)+(o?12:14);return{screenWidth:s,screenHeight:n,panelX:l,panelY:h,panelWidth:r,panelHeight:a,isCompactLayout:o,titleY:d,tabs:f,contentTopY:m,contentBottomY:x,buttonWidth:S,buttonHeight:o?44:50,buttonX:l+(r-S)/2,buttonSpacing:o?14:20,graphicsListX:A,graphicsListY:C,graphicsListWidth:r-2*c,graphicsListHeight:Math.max(0,x-C),graphicsSliderX:T,graphicsSliderY:_,graphicsSliderWidth:w,graphicsSliderRowHeight:E,graphicsSliderGap:b,graphicsSliderLabelWidth:v,graphicsSliderTrackHeight:P,graphicsRowHeight:o?44:48,graphicsButtonWidth:o?54:60,graphicsButtonHeight:o?26:30,graphicsButtonGap:8}}(this.canvas.width,this.canvas.height)}getGraphicsMenuMaxScroll(t){return function(t,e){const i=t*e.graphicsRowHeight;return Math.max(0,i-e.graphicsListHeight)}(this.graphicsOptions.length,t)}handleInGameMenuScroll(t,e,i){if(!this.showInGameMenu||"graphics"!==this.inGameMenuTab)return!1;const s=this.getInGameMenuLayout();if(!(t>=s.graphicsListX&&t<=s.graphicsListX+s.graphicsListWidth&&e>=s.graphicsListY&&e<=s.graphicsListY+s.graphicsListHeight))return!1;const n=this.getGraphicsMenuMaxScroll(s);return 0===n||(this.graphicsMenuScrollOffset=Math.min(n,Math.max(0,this.graphicsMenuScrollOffset+i))),!0}getInGameMenuAction(t,e){if(!this.showInGameMenu)return null;const i=this.getInGameMenuLayout();for(const s of i.tabs)if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return{type:"tab",tab:s.tab};if("main"===this.inGameMenuTab){let s=i.contentTopY;const n=[{action:{type:"resume"}},{action:{type:"toggleInfo"}},{action:{type:"surrender"}}];for(const o of n){if(t>=i.buttonX&&t<=i.buttonX+i.buttonWidth&&e>=s&&e<=s+i.buttonHeight)return o.action;s+=i.buttonHeight+i.buttonSpacing}return null}if("options"===this.inGameMenuTab){let s=i.contentTopY;const n=i.buttonHeight,o=i.buttonSpacing,r=i.buttonX,a=i.buttonWidth,l=.35*a,h=10,c=r+a-2*l-h,d=r+a-l;if(e>=s&&e<=s+n){if(t>=c&&t<=c+l)return{type:"damageDisplayMode",mode:"damage"};if(t>=d&&t<=d+l)return{type:"damageDisplayMode",mode:"remaining-life"}}s+=n+o;const u=r+a-2*l-h,p=r+a-l;if(e>=s&&e<=s+n){if(t>=u&&t<=u+l)return{type:"healthDisplayMode",mode:"bar"};if(t>=p&&t<=p+l)return{type:"healthDisplayMode",mode:"number"}}s+=n+o;const g=r+a-2*l-h,y=r+a-l;if(e>=s&&e<=s+n){if(t>=g&&t<=g+l)return{type:"fancyGraphics",isEnabled:!0};if(t>=y&&t<=y+l)return{type:"fancyGraphics",isEnabled:!1}}s+=n+o;const f=r+a-2*l-h,m=r+a-l;if(e>=s&&e<=s+n){if(t>=f&&t<=f+l)return{type:"colorblindMode",isEnabled:!0};if(t>=m&&t<=m+l)return{type:"colorblindMode",isEnabled:!1}}return null}if("graphics"===this.inGameMenuTab){const s=i.graphicsSliderX+i.graphicsSliderLabelWidth,n=i.graphicsSliderWidth-i.graphicsSliderLabelWidth,o=i.graphicsSliderRowHeight,r=i.graphicsSliderGap,a=["offscreenIndicatorOpacity","infoBoxOpacity"];for(let l=0;l<a.length;l+=1){const h=i.graphicsSliderY+l*(o+r);if(e>=h&&e<=h+o&&t>=s&&t<=s+n){const e=(t-s)/n*100,i=Math.max(0,Math.min(100,5*Math.round(e/5)));return"offscreenIndicatorOpacity"===a[l]?{type:"offscreenIndicatorOpacity",opacityPercent:i}:{type:"infoBoxOpacity",opacityPercent:i}}}}if(!(t>=i.graphicsListX&&t<=i.graphicsListX+i.graphicsListWidth&&e>=i.graphicsListY&&e<=i.graphicsListY+i.graphicsListHeight))return null;const s=this.graphicsOptions.length*i.graphicsRowHeight,n=e-i.graphicsListY+this.graphicsMenuScrollOffset;if(n<0||n>s)return null;const o=Math.floor(n/i.graphicsRowHeight),r=this.graphicsOptions[o];if(!r)return null;const a=3*i.graphicsButtonWidth+2*i.graphicsButtonGap,l=i.graphicsListX+i.graphicsListWidth-a-8,h=i.graphicsListY+o*i.graphicsRowHeight-this.graphicsMenuScrollOffset+(i.graphicsRowHeight-i.graphicsButtonHeight)/2,c=["svg","png","stub"];for(let s=0;s<c.length;s+=1){const n=l+s*(i.graphicsButtonWidth+i.graphicsButtonGap);if(t>=n&&t<=n+i.graphicsButtonWidth&&e>=h&&e<=h+i.graphicsButtonHeight)return{type:"graphicsVariant",key:r.key,variant:c[s]}}return null}drawInGameMenuOverlay(){const t=this.getInGameMenuLayout(),e=t.screenWidth,i=t.screenHeight,s=t.isCompactLayout;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(0,0,e,i);const n=t.panelWidth,o=t.panelHeight,r=t.panelX,a=t.panelY;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(r,a,n,o),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(r,a,n,o),this.ctx.fillStyle="#FFD700",this.ctx.font=`bold ${s?22:30}px Doto`,this.ctx.textAlign="center",this.ctx.fillText("GAME MENU",e/2,t.titleY);for(const e of t.tabs){const t=this.inGameMenuTab===e.tab;this.ctx.fillStyle=t?"rgba(255, 215, 0, 0.3)":"rgba(60, 60, 60, 0.9)",this.ctx.fillRect(e.x,e.y,e.width,e.height),this.ctx.strokeStyle=t?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(e.x,e.y,e.width,e.height),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto";const i="main"===e.tab?"Main":"options"===e.tab?"Options":"Graphics";this.ctx.fillText(i,e.x+e.width/2,e.y+.68*e.height)}if("main"===this.inGameMenuTab){let i=t.contentTopY;const n=t.buttonWidth,o=t.buttonHeight,r=t.buttonX,a=t.buttonSpacing,l=(t,i)=>{this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(r,i,n,o),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(r,i,n,o),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?18:20)+"px Doto",this.ctx.fillText(t,e/2,i+.65*o)};l("Resume",i),i+=o+a,l(this.showInfo?"Hide Info":"Show Info",i),i+=o+a,l("Surrender",i)}else if("options"===this.inGameMenuTab){let e=t.contentTopY;const i=t.buttonHeight,n=t.buttonSpacing,o=t.buttonX,r=t.buttonWidth;this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Damage Display:",o,e+.4*i);const a={button1X:o+r-.35*r*2-10,button2X:o+r-.35*r,buttonWidth:.35*r},l="damage"===this.damageDisplayMode;this.ctx.fillStyle=l?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(a.button1X,e,a.buttonWidth,i),this.ctx.strokeStyle=l?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(a.button1X,e,a.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Dmg #",a.button1X+a.buttonWidth/2,e+.65*i);const h="remaining-life"===this.damageDisplayMode;this.ctx.fillStyle=h?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(a.button2X,e,a.buttonWidth,i),this.ctx.strokeStyle=h?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(a.button2X,e,a.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("HP Left",a.button2X+a.buttonWidth/2,e+.65*i),e+=i+n,this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Health Display:",o,e+.4*i);const c={button1X:o+r-.35*r*2-10,button2X:o+r-.35*r,buttonWidth:.35*r},d="bar"===this.healthDisplayMode;this.ctx.fillStyle=d?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c.button1X,e,c.buttonWidth,i),this.ctx.strokeStyle=d?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c.button1X,e,c.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Bar",c.button1X+c.buttonWidth/2,e+.65*i);const u="number"===this.healthDisplayMode;this.ctx.fillStyle=u?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c.button2X,e,c.buttonWidth,i),this.ctx.strokeStyle=u?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c.button2X,e,c.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Number",c.button2X+c.buttonWidth/2,e+.65*i),e+=i+n,this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Fancy Graphics:",o,e+.4*i);const p={button1X:o+r-.35*r*2-10,button2X:o+r-.35*r,buttonWidth:.35*r},g=this.isFancyGraphicsEnabled;this.ctx.fillStyle=g?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(p.button1X,e,p.buttonWidth,i),this.ctx.strokeStyle=g?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(p.button1X,e,p.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("On",p.button1X+p.buttonWidth/2,e+.65*i);const y=!this.isFancyGraphicsEnabled;this.ctx.fillStyle=y?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(p.button2X,e,p.buttonWidth,i),this.ctx.strokeStyle=y?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(p.button2X,e,p.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Off",p.button2X+p.buttonWidth/2,e+.65*i),e+=i+n,this.ctx.fillStyle="#AAAAAA",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText("Colorblind Mode:",o,e+.4*i);const f={button1X:o+r-.35*r*2-10,button2X:o+r-.35*r,buttonWidth:.35*r},m=this.colorblindMode;this.ctx.fillStyle=m?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(f.button1X,e,f.buttonWidth,i),this.ctx.strokeStyle=m?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(f.button1X,e,f.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("On",f.button1X+f.buttonWidth/2,e+.65*i);const x=!this.colorblindMode;this.ctx.fillStyle=x?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",this.ctx.fillRect(f.button2X,e,f.buttonWidth,i),this.ctx.strokeStyle=x?"#FFD700":"#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(f.button2X,e,f.buttonWidth,i),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?14:16)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText("Off",f.button2X+f.buttonWidth/2,e+.65*i)}else{const e=this.getGraphicsMenuMaxScroll(t);this.graphicsMenuScrollOffset>e&&(this.graphicsMenuScrollOffset=e);const i=t.graphicsSliderX+t.graphicsSliderLabelWidth,n=t.graphicsSliderWidth-t.graphicsSliderLabelWidth,o=t.graphicsSliderRowHeight,r=t.graphicsSliderGap,a=t.graphicsSliderTrackHeight,l=[{label:"Offscreen Indicators",valuePercent:Math.round(100*this.offscreenIndicatorOpacity)},{label:"Info Box Opacity",valuePercent:Math.round(100*this.infoBoxOpacity)}];for(let e=0;e<l.length;e+=1){const h=l[e],c=t.graphicsSliderY+e*(o+r),d=Math.max(0,Math.min(100,h.valuePercent)),u=c+(o-a)/2,p=i+n*d/100,g=1.1*a;this.ctx.fillStyle="#FFFFFF",this.ctx.font=`bold ${s?13:15}px Doto`,this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(h.label,t.graphicsSliderX,c+.5*o),this.ctx.fillStyle="rgba(60, 60, 60, 0.9)",this.ctx.fillRect(i,u,n,a),this.ctx.fillStyle="rgba(255, 215, 0, 0.35)",this.ctx.fillRect(i,u,n*(d/100),a),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=1.5,this.ctx.strokeRect(i,u,n,a),this.ctx.beginPath(),this.ctx.arc(p,u+a/2,g,0,2*Math.PI),this.ctx.fillStyle="#FFD700",this.ctx.fill(),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`bold ${s?12:13}px Doto`,this.ctx.textAlign="right",this.ctx.fillText(`${d}%`,t.graphicsSliderX+t.graphicsSliderWidth,c+.5*o)}this.ctx.fillStyle="rgba(20, 20, 20, 0.85)",this.ctx.fillRect(t.graphicsListX,t.graphicsListY,t.graphicsListWidth,t.graphicsListHeight),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(t.graphicsListX,t.graphicsListY,t.graphicsListWidth,t.graphicsListHeight),this.ctx.clip();const h=t.graphicsListX+8,c=3*t.graphicsButtonWidth+2*t.graphicsButtonGap,d=t.graphicsListX+t.graphicsListWidth-c-8,u=[{variant:"svg",label:"SVG"},{variant:"png",label:"PNG"},{variant:"stub",label:"Stub"}];for(let e=0;e<this.graphicsOptions.length;e+=1){const i=this.graphicsOptions[e],n=t.graphicsListY+e*t.graphicsRowHeight-this.graphicsMenuScrollOffset;if(n+t.graphicsRowHeight<t.graphicsListY||n>t.graphicsListY+t.graphicsListHeight)continue;this.ctx.fillStyle=e%2==0?"rgba(40, 40, 40, 0.6)":"rgba(55, 55, 55, 0.6)",this.ctx.fillRect(t.graphicsListX,n,t.graphicsListWidth,t.graphicsRowHeight),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?13:15)+"px Doto",this.ctx.textAlign="left",this.ctx.fillText(i.label,h,n+.65*t.graphicsRowHeight);const o=this.getGraphicVariant(i.key),r=n+(t.graphicsRowHeight-t.graphicsButtonHeight)/2;for(let e=0;e<u.length;e+=1){const n=u[e],a=d+e*(t.graphicsButtonWidth+t.graphicsButtonGap),l=o===n.variant,h="stub"===n.variant||"svg"===n.variant&&i.svgPath||"png"===n.variant&&i.pngPath;this.ctx.fillStyle=l?"rgba(255, 215, 0, 0.6)":"rgba(80, 80, 80, 0.9)",h||(this.ctx.fillStyle="rgba(50, 50, 50, 0.5)"),this.ctx.fillRect(a,r,t.graphicsButtonWidth,t.graphicsButtonHeight),this.ctx.strokeStyle=l?"#FFD700":"#FFFFFF",this.ctx.lineWidth=1.5,this.ctx.strokeRect(a,r,t.graphicsButtonWidth,t.graphicsButtonHeight),this.ctx.fillStyle=h?"#FFFFFF":"#888888",this.ctx.font=(s?11:12)+"px Doto",this.ctx.textAlign="center",this.ctx.fillText(n.label,a+t.graphicsButtonWidth/2,r+.68*t.graphicsButtonHeight)}}this.ctx.restore()}this.ctx.textAlign="left"}drawEndGameStatsScreen(t,e){const i=window.devicePixelRatio||1,s=this.canvas.width/i,n=this.canvas.height/i,o=s<700;this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.fillRect(0,0,s,n),this.ctx.fillStyle=this.getFactionColor(e.faction);const r=Math.max(28,Math.min(48,.12*s));this.ctx.font=`bold ${r}px Doto`,this.ctx.textAlign="center",this.ctx.fillText(`${e.name} WINS!`,s/2,80);const a=Math.min(700,s-40),l=Math.min(450,n-200),h=(s-a)/2;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(h,130,a,l),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(h,130,a,l),this.ctx.fillStyle="#FFD700";const c=Math.max(18,Math.min(28,.07*s));this.ctx.font=`bold ${c}px Doto`,this.ctx.fillText("MATCH STATISTICS",s/2,180);const d=Math.max(14,Math.min(20,.045*s));this.ctx.font=`${d}px Doto`;let u=230;const p=Math.max(100,Math.min(200,.4*a)),g=t.players.length,y=a-48-p,f=Math.max(50,y/g),m=h+24,x=m+p;this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText("Statistic",m,u),this.ctx.textAlign="right";for(let e=0;e<t.players.length;e++){const i=t.players[e],s=this.getFactionColor(i.faction);this.ctx.fillStyle=s;const n=x+f*(e+1);this.ctx.fillText(i.name,n,u)}u+=o?32:40;const S=[{label:"Units Created",key:"unitsCreated"},{label:"Units Lost",key:"unitsLost"},{label:"Energy Gathered",key:"energyGathered"}];for(const e of S){this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText(e.label,m,u),this.ctx.textAlign="right";for(let i=0;i<t.players.length;i++){const s=t.players[i],n="energyGathered"===e.key?Math.round(s[e.key]):s[e.key],o=x+f*(i+1);this.ctx.fillText(String(n),o,u)}u+=o?28:35}const A=Math.min(300,s-60),T=o?50:60,_=(s-A)/2,w=Math.min(130+l+30,n-T-20);this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(_,w,A,T),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(_,w,A,T),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`bold ${o?20:24}px Doto`,this.ctx.textAlign="center",this.ctx.fillText("Continue",s/2,w+.65*T),this.ctx.textAlign="left"}drawBorderFade(t){const e=window.devicePixelRatio||1,s=this.canvas.width/e,n=this.canvas.height/e,o=150,r=t/2,a=this.worldToScreen(new i(-r,-r)),l=this.worldToScreen(new i(r,-r)),h=this.worldToScreen(new i(-r,r)),c=this.worldToScreen(new i(-r+o,0)),d=(this.worldToScreen(new i(r-o,0)),this.worldToScreen(new i(0,-r+o))),u=(this.worldToScreen(new i(0,r-o)),Math.abs(c.x-a.x)),p=Math.abs(d.y-a.y);if(this.ctx.save(),a.x<s){const t=this.ctx.createLinearGradient(a.x,0,a.x+u,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,a.x+u,n)}if(l.x>0){const t=this.ctx.createLinearGradient(l.x,0,l.x-u,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(l.x-u,0,s-(l.x-u),n)}if(a.y<n){const t=this.ctx.createLinearGradient(0,a.y,0,a.y+p);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,s,a.y+p)}if(h.y>0){const t=this.ctx.createLinearGradient(0,h.y,0,h.y-p);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,h.y-p,s,n-(h.y-p))}this.ctx.restore()}setZoom(t){const e=this.getMinZoomForBounds();this.zoom=Math.max(e,Math.min(2,t));const s=this.clampCameraToLevelBounds(this.camera);this.camera=new i(s.x,s.y),this.parallaxCamera=new i(s.x,s.y)}setCameraPosition(t){const e=this.clampCameraToLevelBounds(t);this.camera=new i(e.x,e.y),this.parallaxCamera=new i(e.x,e.y)}setCameraPositionWithoutParallax(t){const e=this.clampCameraToLevelBounds(t);this.camera=new i(e.x,e.y)}triggerScreenShake(t=Tt){this.screenShakeEnabled&&(this.screenShakeIntensity=Math.max(this.screenShakeIntensity,t),this.screenShakeTimer=At)}updateScreenShake(t){this.screenShakeTimer>0&&(this.screenShakeTimer-=t,this.screenShakeIntensity*=_t,(this.screenShakeTimer<=0||this.screenShakeIntensity<.1)&&(this.screenShakeIntensity=0,this.screenShakeTimer=0))}clampCameraToLevelBounds(t){const e=window.devicePixelRatio||1,s=this.canvas.width/e/this.zoom,n=this.canvas.height/e/this.zoom,o=Yt/2,r=o-s/2,a=o-n/2,l=-r,h=-a,c=Math.max(l,Math.min(r,t.x)),d=Math.max(h,Math.min(a,t.y));return new i(c,d)}getMinZoomForBounds(){const t=window.devicePixelRatio||1,e=this.canvas.width/t,i=this.canvas.height/t,s=e/Yt,n=i/Yt;return Math.max(.5,s,n)}interpolateHexColor(t,e,i){const s=Number.parseInt(t.replace("#",""),16),n=Number.parseInt(e.replace("#",""),16),o=s>>16&255,r=s>>8&255,a=255&s,l=n>>16&255,h=n>>8&255,c=255&n;return`#${(Math.round(o+(l-o)*i)<<16|Math.round(r+(h-r)*i)<<8|Math.round(a+(c-a)*i)).toString(16).padStart(6,"0")}`}}sp.CONTROL_LINES_FULL=["Controls: Drag to select units","Pan: WASD/Arrows or mouse edge or two-finger drag","Zoom: Scroll/Pinch (zooms toward cursor)","Hold still 6 seconds in influence to open warp gate"],sp.CONTROL_LINES_COMPACT=["Controls: Drag to select units","Pan: WASD/Arrows or two-finger drag","Zoom: Scroll/Pinch toward cursor","Hold still 6s in influence to open warp gate"];class np{hasHeroUnitsSelected(){if(0===this.selectedUnits.size)return!1;for(const t of this.selectedUnits)if(t.isHero)return!0;return!1}getSelectedStarlings(t){const e=[];for(const i of this.selectedUnits)i instanceof Tl&&i.owner===t&&e.push(i);return e}tryStartStarlingMerge(t,e,i){if(!this.game)return!1;if(e.length<Ls)return!1;if(!t.buildings.some(t=>t instanceof yl))return!1;const s=e.slice(0,Ls).map(t=>this.game.getUnitNetworkId(t));this.game.applyStarlingMerge(t,s,i),this.sendNetworkCommand("starling_merge",{unitIds:s,targetX:i.x,targetY:i.y});for(const t of this.selectedUnits)t.isSelected=!1;return this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits,!0}getClosestSelectedStarling(t){let e=null,i=1/0;for(const s of this.selectedUnits){if(!(s instanceof Tl))continue;const n=s.position.x-t.x,o=s.position.y-t.y,r=n*n+o*o;r<=Ns*Ns&&r<i&&(i=r,e=s)}return e}updateAbilityArrowStarts(){this.abilityArrowStarts.length=0,this.selectionStartScreen&&this.abilityArrowStarts.push(this.selectionStartScreen);for(const t of this.selectedUnits)t.isHero&&this.abilityArrowStarts.push(this.renderer.worldToScreen(t.position));this.renderer.abilityArrowStarts=this.abilityArrowStarts}isDragStartNearSelectedUnits(t){if(0===this.selectedUnits.size)return!1;for(const e of this.selectedUnits)if(e.position.distanceTo(t)<=Mn)return!0;return!1}isDragStartNearSelectedMirrors(t){if(0===this.selectedMirrors.size)return!1;for(const e of this.selectedMirrors)if(e.containsPoint(t))return!0;return!1}getHeroUnitType(t){switch(t){case"Marine":case"Grave":case"Ray":case"Dagger":case"Beam":case"Driller":case"Nova":case"Sly":return t;case"Influence Ball":return"InfluenceBall";case"Turret Deployer":return"TurretDeployer";default:return null}}isHeroUnitOfType(t,e){switch(e){case"Marine":return t instanceof Fl;case"Grave":return t instanceof kl;case"Ray":return t instanceof Bl;case"InfluenceBall":return t instanceof Gl;case"TurretDeployer":return t instanceof $l;case"Driller":return t instanceof zl;case"Dagger":return t instanceof jl;case"Beam":return t instanceof Kl;case"Nova":return t instanceof eh;case"Sly":return t instanceof nh;default:return!1}}isHeroUnitAlive(t,e){return t.units.some(t=>this.isHeroUnitOfType(t,e))}isHeroUnitQueuedOrProducing(t,e){return t.heroProductionUnitType===e||t.unitQueue.includes(e)}getClosestSelectedMirror(t,e){let i=null,s=-1,n=1/0;for(let o=0;o<t.solarMirrors.length;o++){const r=t.solarMirrors[o];if(!r.isSelected)continue;const a=r.position.x-e.x,l=r.position.y-e.y,h=a*a+l*l;h<n&&(n=h,i=r,s=o)}return{mirror:i,mirrorIndex:s}}getTargetableStructureAtPosition(t,e){if(!this.game)return null;for(let i=0;i<this.game.players.length;i++){const s=this.game.players[i];if(s&&s!==e){if(s.stellarForge&&s.stellarForge.containsPoint(t))return{target:s.stellarForge,targetPlayerIndex:i,structureType:"forge",structureIndex:-1};for(let e=0;e<s.solarMirrors.length;e++){const n=s.solarMirrors[e];if(n.containsPoint(t))return{target:n,targetPlayerIndex:i,structureType:"mirror",structureIndex:e}}for(let e=0;e<s.buildings.length;e++){const n=s.buildings[e];if(n.containsPoint(t))return{target:n,targetPlayerIndex:i,structureType:"building",structureIndex:e}}}}return null}getFriendlySacrificeTargetAtPosition(t,e){if(!this.game)return null;const i=this.game.players.indexOf(e);if(i<0)return null;for(let s=0;s<e.buildings.length;s++){const n=e.buildings[s];if(n instanceof yl&&n.currentProduction&&n.containsPoint(t))return{target:n,targetPlayerIndex:i,structureType:"building",structureIndex:s}}return null}hasSelectedStarlingsOnly(){if(0===this.selectedUnits.size)return!1;for(const t of this.selectedUnits)if(!(t instanceof Tl))return!1;return!0}getTargetStructureRadiusPx(t){return t instanceof Ka?kn:t.radius}handleFoundryButtonPress(t,e,i){if(!this.game)return;const s=t.buildings.indexOf(e);s<0?console.error("Foundry not found in player buildings array"):0===i?e.canQueueStrafeUpgrade()&&t.spendEnergy(ws)?(e.enqueueProduction(vs),console.log("Queued foundry Strafe upgrade"),this.sendNetworkCommand("foundry_strafe_upgrade",{buildingId:s}),e.isSelected=!1,this.selectedBuildings.clear()):console.log("Cannot queue Strafe upgrade or not enough energy"):1===i?e.canQueueBlinkUpgrade()&&t.spendEnergy(Rs)?(e.enqueueProduction(Ms),console.log("Queued foundry Blink upgrade"),this.sendNetworkCommand("foundry_blink_upgrade",{buildingId:s}),e.isSelected=!1,this.selectedBuildings.clear()):console.log("Cannot queue Blink upgrade or not enough energy"):2===i?e.canQueueRegenUpgrade()&&t.spendEnergy(Es)?(e.enqueueProduction(Ps),console.log("Queued foundry Regen upgrade"),this.sendNetworkCommand("foundry_regen_upgrade",{buildingId:s}),e.isSelected=!1,this.selectedBuildings.clear()):console.log("Cannot queue Regen upgrade or not enough energy"):3===i&&(e.canQueueAttackUpgrade()&&t.spendEnergy(bs)?(e.enqueueProduction(Cs),console.log("Queued foundry +1 ATK upgrade"),this.sendNetworkCommand("foundry_attack_upgrade",{buildingId:s}),e.isSelected=!1,this.selectedBuildings.clear()):console.log("Cannot queue +1 ATK upgrade or not enough energy"))}isDoubleTap(t,e){const s=Date.now();return s-this.lastTapTime>this.DOUBLE_TAP_THRESHOLD_MS?(this.lastTapTime=s,this.lastTapPosition=new i(t,e),!1):this.lastTapPosition&&Math.pow(t-this.lastTapPosition.x,2)+Math.pow(e-this.lastTapPosition.y,2)<=this.DOUBLE_TAP_POSITION_THRESHOLD*this.DOUBLE_TAP_POSITION_THRESHOLD?(this.lastTapTime=0,this.lastTapPosition=null,!0):(this.lastTapTime=s,this.lastTapPosition=new i(t,e),!1)}clearWarpGateSelection(){this.selectedWarpGate=null,this.renderer.selectedWarpGate=null,this.renderer.highlightedButtonIndex=-1}getWarpGateAtPosition(t,e){if(!this.game)return null;for(const i of this.game.warpGates)if(i.isComplete&&i.owner===e&&i.position.distanceTo(t)<=m)return i;return null}getWarpGateButtonIndexFromClick(t,e,i){const s=this.renderer.worldToScreen(t.position),n=m*this.renderer.zoom,o=x*this.renderer.zoom,r=n+S*this.renderer.zoom,a=this.getRadialButtonOffsets(4);for(let t=0;t<a.length;t++){const n=a[t],l=e-(s.x+n.x*r),h=i-(s.y+n.y*r);if(Math.sqrt(l*l+h*h)<=o)return t}return-1}isWarpGateButtonAvailable(t,e){const i=t.buildings.some(t=>t instanceof yl),s=t.energy;return t.faction===Za.RADIANT?0===e?!i&&s>=ms:1===e?s>=gs:2===e?s>=ys:3===e&&s>=As:t.faction===Za.VELARIS?0===e?!i&&s>=ms:1===e?s>=xs:2===e?s>=Ss:3===e&&s>=fs:0===e&&!i&&s>=ms}getWarpGateButtonDirection(t){const e=this.getRadialButtonOffsets(4)[t];return e?new i(e.x,e.y):null}getWarpGateButtonWorldPosition(t,e){const s=this.getWarpGateButtonDirection(e);if(!s)return null;const n=m+S;return new i(t.position.x+s.x*n,t.position.y+s.y*n)}buildFromWarpGate(t,e,s){if(!e.isComplete||e.owner!==t)return;const n=new i(e.position.x,e.position.y),o=t.buildings.some(t=>t instanceof yl);if(0===s){if(o)return void console.log("Only one Foundry can exist at a time");if(!t.spendEnergy(ms))return void console.log("Not enough energy to build Foundry");const i=new yl(n,t);t.buildings.push(i),console.log(`Foundry building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"SubsidiaryFactory",positionX:e.position.x,positionY:e.position.y})}else if(1===s){if(t.faction===Za.RADIANT){if(!t.spendEnergy(gs))return void console.log("Not enough energy to build Cannon");const i=new ul(n,t);t.buildings.push(i),console.log(`Cannon building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"Minigun",positionX:e.position.x,positionY:e.position.y})}else if(t.faction===Za.VELARIS){if(!t.spendEnergy(xs))return void console.log("Not enough energy to build Striker Tower");const i=new fl(n,t);t.buildings.push(i),console.log(`Striker Tower building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"StrikerTower",positionX:e.position.x,positionY:e.position.y})}}else if(2===s){if(t.faction===Za.RADIANT){if(!t.spendEnergy(ys))return void console.log("Not enough energy to build Gatling Tower");const i=new pl(n,t);t.buildings.push(i),console.log(`Gatling Tower building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"Gatling",positionX:e.position.x,positionY:e.position.y})}else if(t.faction===Za.VELARIS){if(!t.spendEnergy(Ss))return void console.log("Not enough energy to build Lock-on Laser Tower");const i=new ml(n,t);t.buildings.push(i),console.log(`Lock-on Laser Tower building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"LockOnLaserTower",positionX:e.position.x,positionY:e.position.y})}}else{if(3!==s)return;if(t.faction===Za.RADIANT){if(!t.spendEnergy(As))return void console.log("Not enough energy to build Shield Tower");const i=new xl(n,t);t.buildings.push(i),console.log(`Shield Tower building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"ShieldTower",positionX:e.position.x,positionY:e.position.y})}else if(t.faction===Za.VELARIS){if(!t.spendEnergy(fs))return void console.log("Not enough energy to build Cyclone");const i=new gl(n,t);t.buildings.push(i),console.log(`Cyclone building queued at warp gate (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),this.sendNetworkCommand("building_purchase",{buildingType:"SpaceDustSwirler",positionX:e.position.x,positionY:e.position.y})}}this.scatterParticles(e.position),this.removeWarpGate(e)}removeWarpGate(t){if(!this.game)return;const e=this.game.warpGates.indexOf(t);e>-1&&this.game.warpGates.splice(e,1),this.currentWarpGate===t&&(this.currentWarpGate=null),this.selectedWarpGate===t&&this.clearWarpGateSelection(),this.implodeParticles(t.position)}tryCreateWarpGateAt(t){if(!this.game)return!1;const e=this.getLocalPlayer();if(!e||0===this.selectedMirrors.size)return!1;if(!this.canCreateWarpGateFromSelectedMirrors(t))return!1;const i=new wl(t,e);i.startCharging(),this.game.warpGates.push(i),this.currentWarpGate=i,this.shouldSkipMoveOrderThisTap=!0;for(const t of this.selectedMirrors)t.setLinkedStructure(i),t.isSelected=!1;return this.selectedMirrors.clear(),this.renderer.selectedMirrors=this.selectedMirrors,console.log("Mirror-based warp gate created at",t),this.mirrorCommandMode=null,this.mirrorHoldStartTimeMs=null,this.mirrorHoldWorldPos=null,!0}canCreateWarpGateFromSelectedMirrors(t){if(!this.game)return!1;for(const e of this.selectedMirrors){if(!e.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;if(!t)return!0;const n=new s(e.position,new i(t.x-e.position.x,t.y-e.position.y).normalize(),1);let o=!0;for(const t of this.game.asteroids)if(n.intersectsPolygon(t.getWorldVertices())){o=!1;break}if(o)return!0}return!1}clearAllSelections(){const t=this.getLocalPlayer();if(t){this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.selectedBuildings.clear(),this.clearWarpGateSelection(),this.mirrorCommandMode=null,this.mirrorHoldStartTimeMs=null,this.mirrorHoldWorldPos=null,t.stellarForge&&(t.stellarForge.isSelected=!1);for(const e of t.solarMirrors)e.isSelected=!1;for(const e of t.buildings)e.isSelected=!1;this.renderer.selectedUnits=this.selectedUnits,this.renderer.selectedMirrors=this.selectedMirrors}}selectAllStarlings(){if(!this.game)return;const t=this.getLocalPlayer();if(t){this.clearAllSelections();for(const e of t.units)e instanceof Tl&&this.selectedUnits.add(e);this.renderer.selectedUnits=this.selectedUnits,console.log(`Double-tap: Selected all ${this.selectedUnits.size} starlings`)}}selectAllBuildingsOfType(t){if(!this.game)return;const e=this.getLocalPlayer();if(!e)return;this.clearAllSelections();const i=t.constructor;for(const t of e.buildings)t.constructor===i&&(t.isSelected=!0,this.selectedBuildings.add(t));console.log(`Double-tap: Selected all ${this.selectedBuildings.size} buildings of type ${i.name}`)}getClickedHeroButton(t,e,i,s){const n=this.renderer.worldToScreen(i.position),o=en*this.renderer.zoom,r=sn*this.renderer.zoom,a=s.slice(0,4),l=this.getRadialButtonOffsets(a.length);for(let i=0;i<a.length;i++){const s=l[i],h=n.x+s.x*r,c=n.y+s.y*r,d=t-h,u=e-c;if(Math.sqrt(d*d+u*u)<=o){const t=this.renderer.screenToWorld(h,c);return{heroName:a[i],buttonPos:t}}}return null}getClickedFoundryButtonIndex(t,e,i){const s=this.renderer.worldToScreen(i.position),n=en*this.renderer.zoom,o=sn*this.renderer.zoom,r=this.getRadialButtonOffsets(4);for(let i=0;i<r.length;i++){const a=r[i],l=t-(s.x+a.x*o),h=e-(s.y+a.y*o);if(Math.sqrt(l*l+h*h)<=n)return i}return-1}getNearestButtonIndexFromAngle(t,e){if(e<=0)return-1;if(1===e)return 0;const i=2*Math.PI;let s=(t%i+i)%i- -Math.PI/2;s=(s%i+i)%i;const n=i/e;return Math.round(s/n)%e}getNearestMirrorButtonIndexFromAngle(t,e){const i=e?3:2;return this.getNearestButtonIndexFromAngle(t,i)}getBuildingAbilityAnchorScreen(){if(this.selectedBase)return this.renderer.worldToScreen(this.selectedBase.position);if(this.selectedMirrors.size>0)for(const t of this.selectedMirrors)return this.renderer.worldToScreen(t.position);if(this.selectedWarpGate)return this.renderer.worldToScreen(this.selectedWarpGate.position);if(1===this.selectedBuildings.size){const t=Array.from(this.selectedBuildings)[0];if(t instanceof yl)return this.renderer.worldToScreen(t.position)}return null}getRadialButtonOffsets(t){if(t<=0)return[];const e=[],i=-Math.PI/2,s=2*Math.PI/t;for(let n=0;n<t;n++){const t=i+s*n;e.push({x:Math.cos(t),y:Math.sin(t)})}return e}clearPathPreview(){this.pathPoints=[],this.isDrawingPath=!1,this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=null}toggleInGameMenu(){this.showInGameMenu=!this.showInGameMenu,this.isPaused=this.showInGameMenu,this.renderer.showInGameMenu=this.showInGameMenu,this.renderer.isPaused=this.isPaused}toggleInfo(){this.showInfo=!this.showInfo,this.renderer.showInfo=this.showInfo}getLocalPlayer(){var t;return this.game&&null!==(t=this.game.players[this.localPlayerIndex])&&void 0!==t?t:null}sendNetworkCommand(t,e){this.game&&this.game.networkManager?this.game.sendGameCommand(t,e):this.isMultiplayer&&this.network&&this.network.sendCommand(t,e)}surrender(){if(!this.game)return;const t=this.getLocalPlayer();t&&(t.stellarForge&&(t.stellarForge.health=0),this.showInGameMenu=!1,this.isPaused=!1,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,console.log("Player surrendered"))}returnToMainMenu(){this.stop(),this.game=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.selectedBuildings.clear(),this.clearWarpGateSelection(),this.renderer.selectedUnits=this.selectedUnits,this.renderer.selectedMirrors=this.selectedMirrors,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,this.renderer.showInfo=this.showInfo,this.menu.show()}constructor(){this.game=null,this.lastTime=0,this.isRunning=!1,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=!1,this.holdStartTime=null,this.holdStarlingForMerge=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.mirrorCommandMode=null,this.shouldSkipMoveOrderThisTap=!1,this.mirrorHoldStartTimeMs=null,this.mirrorHoldWorldPos=null,this.hasSeenFoundry=!1,this.hasActiveFoundry=!1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedBase=null,this.selectedBuildings=new Set,this.selectedWarpGate=null,this.isSelecting=!1,this.selectionStartScreen=null,this.isDraggingHeroArrow=!1,this.isDraggingBuildingArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.moveOrderCounter=0,this.localPlayerIndex=0,this.lastTapTime=0,this.lastTapPosition=null,this.DOUBLE_TAP_THRESHOLD_MS=300,this.DOUBLE_TAP_POSITION_THRESHOLD=30,this.network=null,this.isMultiplayer=!1,this.tickAccumulator=0,this.TICK_INTERVAL_MS=1e3/30,this.abilityArrowStarts=[];const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element not found");this.renderer=new sp(t),this.menu=new Zu,this.menu.onStart(t=>this.startNewGame(t)),this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.setupInputHandlers(t)}initializeMultiplayer(t,e,i){console.log("[GameController] Initializing P2P multiplayer..."),this.network=new Xu(t,e,i),this.isMultiplayer=!0,this.setupNetworkEvents()}setupNetworkEvents(){this.network&&(this.network.on(Ku.MATCH_CREATED,t=>{console.log("[GameController] P2P match created:",t.match.id)}),this.network.on(Ku.PLAYER_JOINED,t=>{console.log("[GameController] Player joined:",t.username)}),this.network.on(Ku.CONNECTING,()=>{console.log("[GameController] Establishing P2P connections...")}),this.network.on(Ku.CONNECTED,()=>{console.log("[GameController] All players connected!")}),this.network.on(Ku.MATCH_STARTED,t=>{console.log("[GameController] P2P match started! Seed:",t.seed)}),this.network.on(Ku.COMMAND_RECEIVED,t=>{console.log("[GameController] Command received:",t.command)}),this.network.on(Ku.MATCH_ENDED,t=>{console.log("[GameController] P2P match ended:",t.reason)}),this.network.on(Ku.ERROR,t=>{console.error("[GameController] Network error:",t.error)}))}startNewGame(t){if("lan"!==t.gameMode&&"p2p"!==t.gameMode&&"online"!==t.gameMode){const t=Qa();qa(new Ya(t)),console.log(`[GameController] Initialized RNG with seed: ${t}`)}this.game=this.createGameFromSettings(t),this.renderer.selectedHeroNames=t.selectedHeroNames,this.renderer.playerColor=t.playerColor,this.renderer.enemyColor=t.enemyColor;const e=dh[t.colorScheme];if(e&&(this.renderer.colorScheme=e),this.renderer.damageDisplayMode=t.damageDisplayMode,this.renderer.healthDisplayMode=t.healthDisplayMode,this.game.damageDisplayMode=t.damageDisplayMode,this.renderer.screenShakeEnabled=t.screenShakeEnabled,this.renderer.graphicsQuality=t.graphicsQuality,this.localPlayerIndex=0,"lan"===t.gameMode&&t.networkManager){const e=t.networkManager.isLobbyHost(),i=e?0:1;this.localPlayerIndex=i,this.game.players[0]&&(this.game.players[0].isAi=!1),this.game.players[1]&&(this.game.players[1].isAi=!1),this.game.setupNetworkManager(t.networkManager,i),console.log(`LAN mode: Local player is Player ${i+1} (${e?"Host":"Client"})`)}const i=this.getLocalPlayer();i&&(this.renderer.viewingPlayer=i,i.stellarForge&&(this.renderer.setCameraPosition(i.stellarForge.position),this.renderer.setZoom(.5))),this.showInfo=t.isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.start()}createGameFromSettings(t){var e,s,o;const r=null!==(e=t.selectedFaction)&&void 0!==e?e:Za.RADIANT,a=Za.RADIANT,l=dh[t.colorScheme],h=function(t,e){const s=new Ll;s.suns.push(new n(new i(0,0),1,100));const o=new i(-700,700),r=new i(700,-700),a=Ja(),l=a.next()<.5?[o,r]:[r,o];for(let e=0;e<t.length&&!(e>=l.length);e++){const[n,o]=t[e],r=new Sl(n,o);if(r.isAi=0!==e,r.isAi){const t=[ja.ECONOMIC,ja.DEFENSIVE,ja.AGGRESSIVE,ja.WAVES];r.aiStrategy=a.choice(t)}const h=l[e],c=Qt,d=[new i(h.x-c,h.y),new i(h.x+c,h.y)];s.initializePlayer(r,h,d),s.players.push(r)}if(s.updatePlayerNameMap(),s.players.length>=2)for(let t=0;t<s.players.length;t++){const e=s.players[t],i=(t+1)%s.players.length,n=s.players[i];e.stellarForge&&n.stellarForge&&e.stellarForge.initializeDefaultPath(n.stellarForge.position)}s.initializeSpaceDust(j,2e3,2e3,e),s.initializeAsteroids(10,2e3,2e3);const h=-Math.PI/4,c=new i(Math.cos(h)*zt,Math.sin(h)*zt);s.asteroids.push(new Rl(c,6,Vt));const d=3*Math.PI/4,u=new i(Math.cos(d)*zt,Math.sin(d)*zt);return s.asteroids.push(new Rl(u,6,Vt)),s.isRunning=!0,s}([["Player 1",r],["Player 2",a]],null==l?void 0:l.spaceDustPalette),c=t.selectedMap;if(h.mapSize=c.mapSize,h.suns=[],"twin-suns"===c.id?(h.suns.push(new n(new i(-300,-300),1,100)),h.suns.push(new n(new i(300,300),1,100))):"test-level"===c.id?h.suns.push(new n(new i(0,0),1,100)):"lad"===c.id?h.suns.push(new n(new i(0,0),1,100,"lad")):h.suns.push(new n(new i(0,0),1,100)),"test-level"===c.id){const t=new i(-700,0),e=new i(700,0),n=Qt,r=[new i(t.x,t.y-n),new i(t.x,t.y+n)],a=[t,e],l=[r,[new i(e.x,e.y-n),new i(e.x,e.y+n)]];for(let e=0;e<h.players.length;e++){const i=h.players[e],n=null!==(s=a[e])&&void 0!==s?s:t,c=null!==(o=l[e])&&void 0!==o?o:r;i.stellarForge=null,i.solarMirrors=[],h.initializePlayer(i,n,c)}if(h.players.length>=2){const t=h.players[0],e=h.players[1];t.stellarForge&&e.stellarForge&&(t.stellarForge.initializeDefaultPath(e.stellarForge.position),e.stellarForge.initializeDefaultPath(t.stellarForge.position))}return h.asteroids=[],h.spaceDust=[],h}const d=h.asteroids.slice(-2);h.asteroids=[],h.initializeAsteroids(c.numAsteroids,c.mapSize,c.mapSize),"standard"===c.id&&h.asteroids.push(...d),h.spaceDust=[];const u="test-level"===c.id?3e3:j;return h.initializeSpaceDust(u,c.mapSize,c.mapSize,null==l?void 0:l.spaceDustPalette),h}setupInputHandlers(t){const e=(e,i)=>{const s=t.getBoundingClientRect();return{x:e-s.left,y:i-s.top}};let s=!1,n=!1,o=0,r=0,a=0,l=0,h=0;const c=20,d=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window,u=new Set;t.addEventListener("wheel",t=>{if(t.preventDefault(),this.showInGameMenu){const i=e(t.clientX,t.clientY);if(this.renderer.handleInGameMenuScroll(i.x,i.y,t.deltaY))return}const s=e(t.clientX,t.clientY),n=this.renderer.screenToWorld(s.x,s.y),o=t.deltaY>0?.9:1.1,r=this.renderer.zoom;this.renderer.setZoom(r*o);const a=this.renderer.screenToWorld(s.x,s.y),l=this.renderer.camera;this.renderer.setCameraPositionWithoutParallax(new i(l.x+(n.x-a.x),l.y+(n.y-a.y)))});const p=(t,e)=>{o=t,r=e,this.selectionStartScreen=new i(t,e),this.isSelecting=!1;const s=this.renderer.screenToWorld(t,e);this.startHold(s)},g=(t,e,a=!1)=>{var l;if(!n)return o=t,void(r=e);const h=t-o,c=e-r,d=Math.sqrt(h*h+c*c);if(a){s||(s=!0,this.cancelHold(),this.renderer.selectionStart=null,this.renderer.selectionEnd=null);const t=this.renderer.camera;this.renderer.setCameraPosition(new i(t.x-h/this.renderer.zoom,t.y-c/this.renderer.zoom))}else if(d>Vn){const t=this.hasHeroUnitsSelected(),e=this.selectionStartScreen?this.renderer.screenToWorld(this.selectionStartScreen.x,this.selectionStartScreen.y):null;if(!(this.isSelecting||s||this.isDraggingHeroArrow||this.isDraggingBuildingArrow||this.isDrawingPath)){const i=Boolean(this.selectedBase&&this.selectedBase.isSelected&&e&&this.selectedBase.containsPoint(e)),s=Boolean(e&&this.isDragStartNearSelectedMirrors(e)),n=Boolean(this.selectedWarpGate&&e&&e.distanceTo(this.selectedWarpGate.position)<=m);if(i)this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=this.selectedBase,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold();else if(s)this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold();else if(n)this.isDraggingBuildingArrow=!0,this.cancelHold();else if(1===this.selectedBuildings.size){const t=Array.from(this.selectedBuildings)[0];t instanceof yl&&t.isComplete&&(this.isDraggingBuildingArrow=!0,this.cancelHold())}else(this.selectedBase||this.selectedMirrors.size>0||this.selectedWarpGate)&&0===this.selectedUnits.size?(this.isDraggingBuildingArrow=!0,this.cancelHold()):this.selectedUnits.size>0&&this.selectionStartScreen&&e&&this.isDragStartNearSelectedUnits(e)?(this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold()):t?(this.isDraggingHeroArrow=!0,this.cancelHold()):(this.isSelecting=!0,this.cancelHold())}}if(this.isSelecting)this.renderer.selectionStart=this.selectionStartScreen,this.renderer.selectionEnd=new i(t,e);else if(this.isDraggingHeroArrow)if(this.updateAbilityArrowStarts(),this.selectionStartScreen){const s=t-this.selectionStartScreen.x,n=e-this.selectionStartScreen.y,o=Math.sqrt(s*s+n*n);this.renderer.abilityArrowDirection=o>0?new i(s/o,n/o):null,this.renderer.abilityArrowLengthPx=o}else this.renderer.abilityArrowDirection=null,this.renderer.abilityArrowLengthPx=0;else if(this.isDraggingBuildingArrow){const s=this.getLocalPlayer(),n=this.getBuildingAbilityAnchorScreen(),o=null!=n?n:this.selectionStartScreen;if(o){if(this.renderer.buildingAbilityArrowStart=o,this.selectionStartScreen){const s=t-this.selectionStartScreen.x,n=e-this.selectionStartScreen.y,o=Math.sqrt(s*s+n*n);this.renderer.buildingAbilityArrowDirection=o>0?new i(s/o,n/o):null,this.renderer.buildingAbilityArrowLengthPx=o}else this.renderer.buildingAbilityArrowDirection=null,this.renderer.buildingAbilityArrowLengthPx=0;const n=this.renderer.buildingAbilityArrowDirection,r=n?Math.atan2(n.y,n.x):0;if(s&&s.stellarForge&&s.stellarForge.isSelected)this.renderer.highlightedButtonIndex=n?this.getNearestButtonIndexFromAngle(r,4):-1;else if(this.selectedMirrors.size>0)this.renderer.highlightedButtonIndex=n?this.getNearestMirrorButtonIndexFromAngle(r,this.hasSeenFoundry):-1,1!==this.renderer.highlightedButtonIndex||this.canCreateWarpGateFromSelectedMirrors()||(this.renderer.highlightedButtonIndex=-1);else if(this.selectedWarpGate)if(n&&s){const t=this.getNearestButtonIndexFromAngle(r,4);this.renderer.highlightedButtonIndex=this.isWarpGateButtonAvailable(s,t)?t:-1}else this.renderer.highlightedButtonIndex=-1;else 1===this.selectedBuildings.size&&Array.from(this.selectedBuildings)[0]instanceof yl&&(this.renderer.highlightedButtonIndex=n?this.getNearestButtonIndexFromAngle(r,4):-1)}}else if(this.isDrawingPath){const s=this.renderer.screenToWorld(t,e);(0===this.pathPoints.length||this.pathPoints[this.pathPoints.length-1].distanceTo(s)>Rn)&&((null===(l=this.game)||void 0===l?void 0:l.checkCollision(s,0))||this.pathPoints.push(new i(s.x,s.y))),this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=new i(s.x,s.y)}o=t,r=e},y=()=>{const t=this.selectionStartScreen&&Math.abs(o-this.selectionStartScreen.x)<Vn&&Math.abs(r-this.selectionStartScreen.y)<Vn;if(t&&this.game){const t=this.game.checkVictoryConditions();if(!t&&!this.game.isCountdownActive&&o<=70&&r<=70)return this.toggleInGameMenu(),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(this.showInGameMenu&&!t){const t=this.renderer.getInGameMenuAction(o,r);if(t){switch(t.type){case"resume":this.toggleInGameMenu();break;case"toggleInfo":this.toggleInfo();break;case"surrender":this.surrender();break;case"tab":this.renderer.setInGameMenuTab(t.tab);break;case"graphicsVariant":this.renderer.setGraphicsVariant(t.key,t.variant);break;case"damageDisplayMode":this.renderer.damageDisplayMode=t.mode,this.game&&(this.game.damageDisplayMode=t.mode);break;case"healthDisplayMode":this.renderer.healthDisplayMode=t.mode;break;case"fancyGraphics":this.renderer.isFancyGraphicsEnabled=t.isEnabled;break;case"colorblindMode":this.renderer.colorblindMode=t.isEnabled;break;case"offscreenIndicatorOpacity":this.renderer.offscreenIndicatorOpacity=t.opacityPercent/100;break;case"infoBoxOpacity":this.renderer.infoBoxOpacity=t.opacityPercent/100}return s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t){const t=window.devicePixelRatio||1,e=this.renderer.canvas.width/t,i=(this.renderer.canvas.height,300),a=(e-i)/2,l=610;if(o>=a&&o<=a+i&&r>=l&&r<=l+60)return this.returnToMainMenu(),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t&&this.selectionStartScreen&&this.renderer.createTapEffect(o,r),this.game&&t){const t=this.renderer.screenToWorld(o,r),e=this.getLocalPlayer();if(!e)return;if(this.shouldSkipMoveOrderThisTap)return this.shouldSkipMoveOrderThisTap=!1,s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(this.selectedWarpGate){const t=this.getWarpGateButtonIndexFromClick(this.selectedWarpGate,o,r);if(t>=0){if(!this.isWarpGateButtonAvailable(e,t))return s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();const i=this.getWarpGateButtonWorldPosition(this.selectedWarpGate,t);return i&&this.renderer.createProductionButtonWave(i),console.log(`Warp gate button clicked: index ${t} | energy=${e.energy.toFixed(1)}`),this.buildFromWarpGate(e,this.selectedWarpGate,t),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}const i=this.getWarpGateAtPosition(t,e);if(i)return this.selectedWarpGate===i?this.clearWarpGateSelection():(this.clearAllSelections(),this.selectedWarpGate=i,this.renderer.selectedWarpGate=i),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if("warpgate"===this.mirrorCommandMode&&this.selectedMirrors.size>0)return this.tryCreateWarpGateAt(t),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();const a=this.hasSelectedStarlingsOnly()?this.getFriendlySacrificeTargetAtPosition(t,e):null,l=null!=a?a:this.getTargetableStructureAtPosition(t,e);if(this.selectedUnits.size>0&&l){this.moveOrderCounter++;const t=l.target instanceof yl&&l.target.owner===e,i=this.getTargetStructureRadiusPx(l.target);for(const e of this.selectedUnits){const s=t&&e instanceof Tl?l.target.position:e.getStructureStandoffPoint(l.target.position,i);e.setManualTarget(l.target,s),e.moveOrder=this.moveOrderCounter}const o=this.game?Array.from(this.selectedUnits).map(t=>this.game.getUnitNetworkId(t)):[];return this.sendNetworkCommand("unit_target_structure",{unitIds:o,targetPlayerIndex:l.targetPlayerIndex,structureType:l.structureType,structureIndex:l.structureIndex,moveOrder:this.moveOrderCounter}),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits,this.clearPathPreview(),console.log("Units targeting structure",l.structureType),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(e.stellarForge&&e.stellarForge.containsPoint(t)){if(this.clearWarpGateSelection(),this.selectedMirrors.size>0){for(const t of this.selectedMirrors)t.setLinkedStructure(e.stellarForge),t.isSelected=!1;const t=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0);this.sendNetworkCommand("mirror_link",{mirrorIndices:t,structureType:"forge"}),this.selectedMirrors.clear()}if(e.stellarForge.isSelected)e.stellarForge.isSelected=!1,this.selectedBase=null,this.clearPathPreview(),console.log("Stellar Forge deselected");else{e.stellarForge.isSelected=!0,this.selectedBase=e.stellarForge,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t.isSelected=!1;for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear(),this.clearPathPreview(),console.log("Stellar Forge selected")}return s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let h=null;for(const i of e.solarMirrors)if(i.containsPoint(t)){h=i;break}if(h){if(this.clearWarpGateSelection(),h.isSelected)h.isSelected=!1,this.selectedMirrors.delete(h),this.clearPathPreview(),console.log("Solar Mirror deselected");else{h.isSelected=!0,this.selectedMirrors.clear(),this.selectedMirrors.add(h),e.stellarForge&&(e.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t!==h&&(t.isSelected=!1);for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear(),this.clearPathPreview(),console.log("Solar Mirror selected")}return s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let c=null;for(const i of e.buildings)if(i.containsPoint(t)){c=i;break}if(c){if(this.clearWarpGateSelection(),(c instanceof ul||c instanceof pl||c instanceof gl||c instanceof yl||c instanceof fl||c instanceof ml||c instanceof xl)&&this.selectedMirrors.size>0){for(const t of this.selectedMirrors)t.setLinkedStructure(c),t.isSelected=!1;const t=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0),i=e.buildings.indexOf(c);i>=0&&this.sendNetworkCommand("mirror_link",{mirrorIndices:t,structureType:"building",buildingIndex:i}),this.selectedMirrors.clear()}if(this.isDoubleTap(o,r))this.selectAllBuildingsOfType(c);else if(c.isSelected)c instanceof fl&&c.isMissileReady()?(c.isAwaitingTarget=!0,console.log("Striker Tower: Select target location")):(c.isSelected=!1,this.selectedBuildings.delete(c),console.log("Building deselected"));else{c.isSelected=!0,this.selectedBuildings.clear(),this.selectedBuildings.add(c),e.stellarForge&&(e.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.solarMirrors)t.isSelected=!1;this.selectedMirrors.clear(),this.clearPathPreview(),console.log("Building selected")}return s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(this.selectedMirrors.size>0){const t=Array.from(this.selectedMirrors)[0],i=this.renderer.worldToScreen(t.position),a=x*this.renderer.zoom,l=50*this.renderer.zoom,h=this.hasSeenFoundry,c=i.x,d=i.y-l,u=i.x-l,p=i.y,g=i.x+l,y=i.y;let f=o-u,m=r-p;if(Math.sqrt(f*f+m*m)<=a){if(console.log("Mirror command: Link to Forge"),e.stellarForge){for(const t of this.selectedMirrors)t.setLinkedStructure(e.stellarForge);const t=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0);this.sendNetworkCommand("mirror_link",{mirrorIndices:t,structureType:"forge"}),console.log("Mirrors linked to forge")}for(const t of this.selectedMirrors)t.isSelected=!1;return this.selectedMirrors.clear(),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,void(this.renderer.selectionEnd=null)}if(f=o-c,m=r-d,Math.sqrt(f*f+m*m)<=a)return console.log("Mirror command: Create Warp Gate"),this.canCreateWarpGateFromSelectedMirrors()&&(this.mirrorCommandMode="warpgate"),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,void(this.renderer.selectionEnd=null);if(h&&(f=o-g,m=r-y,Math.sqrt(f*f+m*m)<=a)){if(this.hasActiveFoundry){const t=e.buildings.find(t=>t instanceof yl);if(t){for(const e of this.selectedMirrors)e.setLinkedStructure(t);const i=Array.from(this.selectedMirrors).map(t=>e.solarMirrors.indexOf(t)).filter(t=>t>=0),s=e.buildings.indexOf(t);s>=0&&this.sendNetworkCommand("mirror_link",{mirrorIndices:i,structureType:"building",buildingIndex:s}),console.log("Mirrors linked to foundry")}}for(const t of this.selectedMirrors)t.isSelected=!1;return this.selectedMirrors.clear(),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,void(this.renderer.selectionEnd=null)}}if(e.stellarForge&&e.stellarForge.isSelected&&this.renderer.selectedHeroNames.length>0){const t=this.getClickedHeroButton(o,r,e.stellarForge,this.renderer.selectedHeroNames);if(t){const i=t.heroName;this.renderer.createProductionButtonWave(t.buttonPos);const o=this.getHeroUnitType(i);let r=!1;if(o){const t=this.isHeroUnitAlive(e,o),s=this.isHeroUnitQueuedOrProducing(e.stellarForge,o);console.log(`Hero button clicked: ${i} | unitType=${o} | alive=${t} | producing=${s} | energy=${e.energy.toFixed(1)}`),t?console.log(`${i} is already active`):s?console.log(`${i} is already being produced`):e.spendEnergy(Ts)?(e.stellarForge.enqueueHeroUnit(o),e.stellarForge.startHeroProductionIfIdle(),console.log(`Queued hero ${i} for forging`),r=!0,this.sendNetworkCommand("hero_purchase",{heroType:o})):console.log("Not enough energy to forge hero")}if(r){e.stellarForge.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear(),this.clearPathPreview()}return s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(1===this.selectedBuildings.size){const t=Array.from(this.selectedBuildings)[0];if(t instanceof yl&&t.isComplete){const i=this.getClickedFoundryButtonIndex(o,r,t);if(i>=0)return void this.handleFoundryButtonPress(e,t,i)}}if(this.selectedBuildings.size>0){for(const t of this.selectedBuildings)t.isSelected=!1;return this.selectedBuildings.clear(),this.clearPathPreview(),console.log("Buildings deselected"),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(e.stellarForge&&e.stellarForge.isSelected){e.stellarForge.setTarget(t),this.moveOrderCounter++,e.stellarForge.moveOrder=this.moveOrderCounter,this.sendNetworkCommand("forge_move",{targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter}),e.stellarForge.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.buildings)t.isSelected=!1;return this.selectedBuildings.clear(),console.log(`Stellar Forge moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}const{mirror:d,mirrorIndex:u}=this.getClosestSelectedMirror(e,t);if(d&&"warpgate"!==this.mirrorCommandMode){d.setTarget(t),this.moveOrderCounter++,d.moveOrder=this.moveOrderCounter,this.sendNetworkCommand("mirror_move",{mirrorIndices:u>=0?[u]:[],targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter}),d.isSelected=!1,this.selectedBase=null,this.selectedUnits.clear();for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of e.buildings)t.isSelected=!1;return this.selectedBuildings.clear(),console.log(`Solar Mirror moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),s=!1,n=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(this.isSelecting&&this.selectionStartScreen&&this.game){const t=new i(o,r);this.selectUnitsInRectangle(this.selectionStartScreen,t)}else if(this.isDrawingPath&&this.pathPoints.length>0&&this.game){if(this.selectedBase&&this.selectedBase.isSelected)this.selectedBase.setMinionPath(this.pathPoints),console.log(`Base path set with ${this.pathPoints.length} waypoints`),this.sendNetworkCommand("set_rally_path",{waypoints:this.pathPoints.map(t=>({x:t.x,y:t.y}))});else if(this.selectedMirrors.size>0){const t=this.getLocalPlayer(),e=this.pathPoints[this.pathPoints.length-1];if(t){console.log(`Solar mirror movement path set to (${e.x.toFixed(0)}, ${e.y.toFixed(0)})`),this.moveOrderCounter++;const i=[];for(const s of this.selectedMirrors){s.setTarget(e),s.moveOrder=this.moveOrderCounter,s.isSelected=!1;const n=t.solarMirrors.indexOf(s);n>=0&&i.push(n)}this.sendNetworkCommand("mirror_move",{mirrorIndices:i,targetX:e.x,targetY:e.y,moveOrder:this.moveOrderCounter})}this.selectedMirrors.clear();const i=this.getLocalPlayer();if(i){for(const t of i.buildings)t.isSelected=!1;this.selectedBuildings.clear()}}else if(this.selectedUnits.size>0){console.log(`Unit movement path set with ${this.pathPoints.length} waypoints for ${this.selectedUnits.size} unit(s)`),this.moveOrderCounter++;for(const t of this.selectedUnits)t.clearManualTarget(),t.setPath(this.pathPoints),t.moveOrder=this.moveOrderCounter;const t=this.game?Array.from(this.selectedUnits).map(t=>this.game.getUnitNetworkId(t)):[];this.sendNetworkCommand("unit_path",{unitIds:t,waypoints:this.pathPoints.map(t=>({x:t.x,y:t.y})),moveOrder:this.moveOrderCounter}),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;const e=this.getLocalPlayer();if(e){for(const t of e.buildings)t.isSelected=!1;this.selectedBuildings.clear()}}this.clearPathPreview()}else if(!this.isSelecting&&(this.selectedUnits.size>0||this.selectedMirrors.size>0||this.selectedBase||this.selectedWarpGate)&&this.selectionStartScreen&&this.game){const t=new i(o,r),e=this.selectionStartScreen.distanceTo(t),s=e,n=Math.max(Vn,Yn),a=this.hasHeroUnitsSelected();if(this.selectedUnits.size>0&&(!a&&e>=Vn||a&&this.isDraggingHeroArrow&&e>=n)){a||this.renderer.createSwipeEffect(this.selectionStartScreen.x,this.selectionStartScreen.y,t.x,t.y);const e=t.x-this.selectionStartScreen.x,s=t.y-this.selectionStartScreen.y,n=Math.sqrt(e*e+s*s),o=new i(e/n,s/n);let r=!1;if(!a){const t=this.getLocalPlayer();if(t&&o.y<-.5){const e=this.getSelectedStarlings(t);if(e.length>=Ls){const s=e.reduce((t,e)=>t+e.position.x,0)/e.length,n=e.reduce((t,e)=>t+e.position.y,0)/e.length,o=new i(s,n);r=this.tryStartStarlingMerge(t,e,o)}}}if(!r){let t=!1;for(const e of this.selectedUnits)e.useAbility(o)&&(t=!0,this.game&&this.sendNetworkCommand("unit_ability",{unitId:this.game.getUnitNetworkId(e),directionX:o.x,directionY:o.y}));t&&console.log(`Ability activated in direction (${o.x.toFixed(2)}, ${o.y.toFixed(2)})`),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits}}else if(this.isDraggingBuildingArrow&&s>=n){const t=this.getLocalPlayer();if(t&&this.renderer.highlightedButtonIndex>=0)if(t.stellarForge&&t.stellarForge.isSelected&&this.renderer.selectedHeroNames.length>0){const e=this.renderer.selectedHeroNames;if(this.renderer.highlightedButtonIndex<e.length){const i=e[this.renderer.highlightedButtonIndex],s=this.getHeroUnitType(i);if(s){const e=this.isHeroUnitAlive(t,s),n=this.isHeroUnitQueuedOrProducing(t.stellarForge,s);e||n||!t.spendEnergy(Ts)||(t.stellarForge.enqueueHeroUnit(s),t.stellarForge.startHeroProductionIfIdle(),console.log(`Radial selection: Queued hero ${i} for forging`),this.sendNetworkCommand("hero_purchase",{heroType:s}),t.stellarForge.isSelected=!1,this.selectedBase=null)}}}else if(this.selectedMirrors.size>0){if(0===this.renderer.highlightedButtonIndex){if(t.stellarForge){for(const e of this.selectedMirrors)e.setLinkedStructure(t.stellarForge);const e=Array.from(this.selectedMirrors).map(e=>t.solarMirrors.indexOf(e)).filter(t=>t>=0);this.sendNetworkCommand("mirror_link",{mirrorIndices:e,structureType:"forge"}),console.log("Radial selection: Mirrors linked to forge")}for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear()}else if(1===this.renderer.highlightedButtonIndex)this.canCreateWarpGateFromSelectedMirrors()&&(this.mirrorCommandMode="warpgate",console.log("Radial selection: Mirror command mode set to warpgate"));else if(2===this.renderer.highlightedButtonIndex&&this.hasActiveFoundry){const e=t.buildings.find(t=>t instanceof yl);if(e){for(const t of this.selectedMirrors)t.setLinkedStructure(e);const i=Array.from(this.selectedMirrors).map(e=>t.solarMirrors.indexOf(e)).filter(t=>t>=0),s=t.buildings.indexOf(e);s>=0&&this.sendNetworkCommand("mirror_link",{mirrorIndices:i,structureType:"building",buildingIndex:s}),console.log("Radial selection: Mirrors linked to foundry")}for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear()}}else if(this.selectedWarpGate)this.isWarpGateButtonAvailable(t,this.renderer.highlightedButtonIndex)&&this.buildFromWarpGate(t,this.selectedWarpGate,this.renderer.highlightedButtonIndex);else if(1===this.selectedBuildings.size){const e=Array.from(this.selectedBuildings)[0];e instanceof yl&&this.handleFoundryButtonPress(t,e,this.renderer.highlightedButtonIndex)}}else if(this.isDraggingHeroArrow&&a);else if(this.shouldSkipMoveOrderThisTap)this.shouldSkipMoveOrderThisTap=!1;else if(this.selectedWarpGate&&0===this.selectedUnits.size&&0===this.selectedMirrors.size&&!this.selectedBase);else{const t=this.getLocalPlayer(),e=t&&1===this.selectedBuildings.size?Array.from(this.selectedBuildings)[0]:null;if(e instanceof fl&&e.isAwaitingTarget){const i=this.renderer.screenToWorld(o,r);if(this.game.isPointInShadow(i)&&!this.game.isPositionVisibleByPlayerUnits(i,t.units)&&e.position.distanceTo(i)<=e.attackRange){if(t.buildings.indexOf(e)>=0){const t=this.game.getBuildingNetworkId(e);this.sendNetworkCommand("striker_tower_start_countdown",{buildingId:t,targetX:i.x,targetY:i.y}),console.log(`Striker Tower countdown started at (${i.x.toFixed(0)}, ${i.y.toFixed(0)})`)}}else console.log("Invalid target position for Striker Tower"),e.isAwaitingTarget=!1}else{const t=this.renderer.screenToWorld(o,r);this.moveOrderCounter++;for(const e of this.selectedUnits){const s=new i(t.x,t.y);e.clearManualTarget(),e instanceof Tl?e.setManualRallyPoint(s):e.rallyPoint=s,e.moveOrder=this.moveOrderCounter}const e=this.game?Array.from(this.selectedUnits).map(t=>this.game.getUnitNetworkId(t)):[];this.sendNetworkCommand("unit_move",{unitIds:e,targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter});const s=this.getLocalPlayer();if(s){const{mirror:e,mirrorIndex:n}=this.getClosestSelectedMirror(s,t);e&&n>=0&&(e.setTarget(new i(t.x,t.y)),e.moveOrder=this.moveOrderCounter,e.isSelected=!1,this.sendNetworkCommand("mirror_move",{mirrorIndices:[n],targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter}))}this.selectedBase&&(this.selectedBase.setTarget(new i(t.x,t.y)),this.selectedBase.moveOrder=this.moveOrderCounter,this.selectedBase.isSelected=!1,this.sendNetworkCommand("forge_move",{targetX:t.x,targetY:t.y,moveOrder:this.moveOrderCounter})),this.selectedUnits.clear();for(const t of this.selectedMirrors)t.isSelected=!1;this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,console.log(`Movement target set at (${t.x.toFixed(0)}, ${t.y.toFixed(0)}) - Move order #${this.moveOrderCounter}`)}}}s=!1,n=!1,this.isSelecting=!1,this.isDraggingHeroArrow=!1,this.isDraggingBuildingArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,this.abilityArrowStarts.length=0,this.renderer.abilityArrowStarts=this.abilityArrowStarts,this.renderer.abilityArrowDirection=null,this.renderer.abilityArrowLengthPx=0,this.renderer.buildingAbilityArrowStart=null,this.renderer.buildingAbilityArrowDirection=null,this.renderer.buildingAbilityArrowLengthPx=0,this.renderer.highlightedButtonIndex=-1,this.endHold()};t.addEventListener("mousedown",t=>{n=!0;const i=e(t.clientX,t.clientY);p(i.x,i.y)}),t.addEventListener("mousemove",t=>{const i=e(t.clientX,t.clientY);a=i.x,l=i.y,g(i.x,i.y,!1)}),t.addEventListener("mouseup",()=>{y()}),t.addEventListener("mouseleave",()=>{y()}),t.addEventListener("touchstart",t=>{if(1===t.touches.length){t.preventDefault(),n=!0;const i=e(t.touches[0].clientX,t.touches[0].clientY);p(i.x,i.y)}else if(2===t.touches.length){t.preventDefault(),n=!0,s=!1;const i=e(t.touches[0].clientX,t.touches[0].clientY),a=e(t.touches[1].clientX,t.touches[1].clientY);o=(i.x+a.x)/2,r=(i.y+a.y)/2;const l=a.x-i.x,c=a.y-i.y;h=Math.sqrt(l*l+c*c),this.cancelHold()}},{passive:!1}),t.addEventListener("touchmove",t=>{if(1===t.touches.length&&n){t.preventDefault();const i=e(t.touches[0].clientX,t.touches[0].clientY);g(i.x,i.y,!1)}else if(2===t.touches.length){t.preventDefault();const s=e(t.touches[0].clientX,t.touches[0].clientY),n=e(t.touches[1].clientX,t.touches[1].clientY),o=(s.x+n.x)/2,r=(s.y+n.y)/2,a=n.x-s.x,l=n.y-s.y,c=Math.sqrt(a*a+l*l);if(Math.abs(c-h)>1){const t=this.renderer.screenToWorld(o,r),e=c/h,s=this.renderer.zoom;this.renderer.setZoom(s*e);const n=this.renderer.screenToWorld(o,r),a=this.renderer.camera;this.renderer.setCameraPositionWithoutParallax(new i(a.x+(t.x-n.x),a.y+(t.y-n.y))),h=c}g(o,r,!0)}},{passive:!1}),t.addEventListener("touchend",t=>{if(1===t.touches.length){const i=e(t.touches[0].clientX,t.touches[0].clientY);o=i.x,r=i.y,a=i.x,l=i.y}else if(t.changedTouches.length>0){const i=e(t.changedTouches[0].clientX,t.changedTouches[0].clientY);o=i.x,r=i.y,a=i.x,l=i.y}0===t.touches.length?(y(),h=0):1===t.touches.length&&(s=!1,h=0)}),t.addEventListener("touchcancel",()=>{y(),h=0}),window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();if("escape"===e&&this.game&&!this.game.isCountdownActive&&!this.game.checkVictoryConditions())return t.preventDefault(),void this.toggleInGameMenu();["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(e)&&(t.preventDefault(),u.add(e))}),window.addEventListener("keyup",t=>{const e=t.key.toLowerCase();u.delete(e)});const f=()=>{if(!this.game)return void requestAnimationFrame(f);const e=u.size>0,o=window.devicePixelRatio||1,r=t.width/o,h=t.height/o,p=!d&&!n&&!s&&(a<c||a>r-c||l<c||l>h-c);if(e||p){const t=this.renderer.camera;let e=0,s=0;(u.has("w")||u.has("arrowup"))&&(s-=10),(u.has("s")||u.has("arrowdown"))&&(s+=10),(u.has("a")||u.has("arrowleft"))&&(e-=10),(u.has("d")||u.has("arrowright"))&&(e+=10),p&&(a<c&&(e-=5),a>r-c&&(e+=5),l<c&&(s-=5),l>h-c&&(s+=5)),0===e&&0===s||this.renderer.setCameraPosition(new i(t.x+e/this.renderer.zoom,t.y+s/this.renderer.zoom))}requestAnimationFrame(f)};f()}startHold(t){if(!this.game)return;const e=this.getLocalPlayer();if(!e)return;if(!e.stellarForge)return;if(this.holdStartTime=null,this.holdStarlingForMerge=null,Array.from(this.selectedBuildings).some(t=>t.canShoot())){for(const i of this.selectedBuildings)if(i.canShoot()){const s=[];for(const t of this.game.players)t!==e&&(s.push(...t.units),s.push(...t.buildings),t.stellarForge&&s.push(t.stellarForge));let n=null,o=1/0;for(const e of s){const i=t.distanceTo(e.position);i<o&&(o=i,n=e)}n&&(i.target=n,console.log(`Building targeting enemy at (${n.position.x.toFixed(0)}, ${n.position.y.toFixed(0)})`))}return}const i=this.selectedMirrors.size>0;if(i&&"warpgate"===this.mirrorCommandMode)return void this.tryCreateWarpGateAt(t);i&&null===this.mirrorCommandMode&&(this.mirrorHoldStartTimeMs=performance.now(),this.mirrorHoldWorldPos=t);const s=this.getSelectedStarlings(e);if(e.buildings.some(t=>t instanceof yl)&&s.length>=Ls){const e=this.getClosestSelectedStarling(t);e&&(this.holdStartTime=performance.now(),this.holdStarlingForMerge=e)}}selectUnitsInRectangle(t,e){if(!this.game)return;const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y),n=i<zn&&s<zn&&this.isDoubleTap(e.x,e.y),o=this.renderer.screenToWorld(t.x,t.y),r=this.renderer.screenToWorld(e.x,e.y),a=Math.min(o.x,r.x),l=Math.max(o.x,r.x),h=Math.min(o.y,r.y),c=Math.max(o.y,r.y),d=this.getLocalPlayer();if(d&&!d.isDefeated()){if(n)for(const t of d.units)if(t instanceof Tl&&t.position.x>=a&&t.position.x<=l&&t.position.y>=h&&t.position.y<=c)return void this.selectAllStarlings();this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.clearWarpGateSelection();for(const t of d.buildings)t.isSelected=!1;this.selectedBuildings.clear();for(const t of d.units)t.position.x>=a&&t.position.x<=l&&t.position.y>=h&&t.position.y<=c&&this.selectedUnits.add(t);for(const t of d.solarMirrors)t.position.x>=a&&t.position.x<=l&&t.position.y>=h&&t.position.y<=c?(this.selectedMirrors.add(t),t.isSelected=!0):t.isSelected=!1;d.stellarForge&&d.stellarForge.position.x>=a&&d.stellarForge.position.x<=l&&d.stellarForge.position.y>=h&&d.stellarForge.position.y<=c&&0===this.selectedUnits.size?(this.selectedBase=d.stellarForge,d.stellarForge.isSelected=!0):d.stellarForge&&(d.stellarForge.isSelected=!1),this.renderer.selectedUnits=this.selectedUnits,this.renderer.selectedMirrors=this.selectedMirrors,console.log(`Selected ${this.selectedUnits.size} units, ${this.selectedMirrors.size} mirrors, ${this.selectedBase?"1 base":"0 bases"}`)}}cancelHold(){this.holdStartTime=null,this.holdStarlingForMerge=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.mirrorHoldStartTimeMs=null,this.mirrorHoldWorldPos=null}endHold(){this.holdStartTime=null,this.holdStarlingForMerge=null,this.isUsingMirrorsForWarpGate=!1,this.mirrorHoldStartTimeMs=null,this.mirrorHoldWorldPos=null}updateStarlingMergeHold(){if(!this.game)return;if(!this.holdStartTime||!this.holdStarlingForMerge)return;const t=this.getLocalPlayer();if(!t)return void this.cancelHold();if(!this.selectedUnits.has(this.holdStarlingForMerge))return void this.cancelHold();const e=this.getSelectedStarlings(t);if(e.length<Ls)return void this.cancelHold();if(!t.buildings.some(t=>t instanceof yl))return void this.cancelHold();if(performance.now()-this.holdStartTime<Os)return;const s=new i(this.holdStarlingForMerge.position.x,this.holdStarlingForMerge.position.y);this.tryStartStarlingMerge(t,e,s)&&(this.shouldSkipMoveOrderThisTap=!0),this.cancelHold()}updateMirrorWarpGateHold(){if(this.mirrorHoldStartTimeMs&&this.mirrorHoldWorldPos)return 0===this.selectedMirrors.size||"warpgate"===this.mirrorCommandMode?(this.mirrorHoldStartTimeMs=null,void(this.mirrorHoldWorldPos=null)):void(performance.now()-this.mirrorHoldStartTimeMs<u||(this.tryCreateWarpGateAt(this.mirrorHoldWorldPos),this.mirrorHoldStartTimeMs=null,this.mirrorHoldWorldPos=null))}applyRadialForceToParticles(t,e){if(this.game)for(const s of this.game.spaceDust)if(s.position.distanceTo(t)<b){const n=new i(e?s.position.x-t.x:t.x-s.position.x,e?s.position.y-t.y:t.y-s.position.y).normalize();s.applyForce(new i(n.x*v,n.y*v))}}scatterParticles(t){this.applyRadialForceToParticles(t,!0)}implodeParticles(t){this.applyRadialForceToParticles(t,!1)}unlinkMirrorsFromWarpGate(t){if(this.game)for(const e of this.game.players)for(const i of e.solarMirrors)i.linkedStructure===t&&i.setLinkedStructure(null)}updateFoundryButtonState(){const t=this.getLocalPlayer();if(!t)return this.hasActiveFoundry=!1,this.renderer.hasActiveFoundry=!1,void(this.renderer.hasSeenFoundry=this.hasSeenFoundry);const e=t.buildings.some(t=>t instanceof yl);e&&(this.hasSeenFoundry=!0),this.hasActiveFoundry=e,this.renderer.hasSeenFoundry=this.hasSeenFoundry,this.renderer.hasActiveFoundry=e}update(t){this.game&&(this.isPaused||(this.isMultiplayer?this.updateMultiplayer(t):this.updateSinglePlayer(t)))}updateSinglePlayer(t){if(this.game){this.renderer.updateScreenShake(t),this.updateStarlingMergeHold(),this.updateMirrorWarpGateHold(),"warpgate"!==this.mirrorCommandMode||this.canCreateWarpGateFromSelectedMirrors()||(this.mirrorCommandMode=null),this.game.checkVictoryConditions()&&this.game.isRunning&&(this.game.isRunning=!1),this.game.isRunning&&this.game.update(t);for(let e=this.game.warpGates.length-1;e>=0;e--){const i=this.game.warpGates[e];i.update(t),!i.isComplete&&i.isCharging&&!i.isCancelling&&i.shouldEmitShockwave()&&(this.scatterParticles(i.position),this.renderer.createWarpGateShockwave(i.position)),i.hasDissipated&&(this.unlinkMirrorsFromWarpGate(i),this.scatterParticles(i.position),this.renderer.createWarpGateShockwave(i.position),this.selectedWarpGate===i&&this.clearWarpGateSelection(),this.game.warpGates.splice(e,1))}for(const t of this.game.starlingMergeGateExplosions)this.scatterParticles(t),this.renderer.createWarpGateShockwave(t)}}updateMultiplayer(t){if(!this.network||!this.game)return;for(this.renderer.updateScreenShake(t),this.updateStarlingMergeHold(),this.updateMirrorWarpGateHold(),"warpgate"!==this.mirrorCommandMode||this.canCreateWarpGateFromSelectedMirrors()||(this.mirrorCommandMode=null),this.tickAccumulator+=1e3*t;this.tickAccumulator>=this.TICK_INTERVAL_MS;){const t=this.network.getNextTickCommands();if(!t)break;this.game.executeCommands(t),this.network.advanceTick(),this.game.checkVictoryConditions()&&this.game.isRunning&&(this.game.isRunning=!1),this.game.isRunning&&this.game.update(this.TICK_INTERVAL_MS/1e3),this.tickAccumulator-=this.TICK_INTERVAL_MS}const e=this.TICK_INTERVAL_MS/1e3;for(let t=this.game.warpGates.length-1;t>=0;t--){const i=this.game.warpGates[t];i.update(e),!i.isComplete&&i.isCharging&&!i.isCancelling&&i.shouldEmitShockwave()&&(this.scatterParticles(i.position),this.renderer.createWarpGateShockwave(i.position)),i.hasDissipated&&(this.unlinkMirrorsFromWarpGate(i),this.scatterParticles(i.position),this.renderer.createWarpGateShockwave(i.position),this.selectedWarpGate===i&&this.clearWarpGateSelection(),this.game.warpGates.splice(t,1))}for(const t of this.game.starlingMergeGateExplosions)this.scatterParticles(t),this.renderer.createWarpGateShockwave(t)}render(){if(this.game){this.updateFoundryButtonState();const t=this.selectedMirrors.size>0&&this.canCreateWarpGateFromSelectedMirrors();this.renderer.canCreateWarpGateFromMirrors=t,this.renderer.isWarpGatePlacementMode="warpgate"===this.mirrorCommandMode&&t,this.renderer.render(this.game)}}gameLoop(t){if(!this.isRunning)return;const e=0===this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,this.update(Math.min(e,.1)),this.render(),requestAnimationFrame(t=>this.gameLoop(t))}start(){this.game&&(this.isRunning=!0,this.lastTime=0,requestAnimationFrame(t=>this.gameLoop(t)))}stop(){this.isRunning=!1}}document.addEventListener("DOMContentLoaded",()=>{const t=new np;window.gameController=t})})();