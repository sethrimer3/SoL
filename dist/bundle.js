(()=>{"use strict";const t=300,i="#0066FF",e="#FF0000",s=4e3,o=[{count:200,parallaxFactor:.1,sizeRange:[.5,1]},{count:150,parallaxFactor:.2,sizeRange:[.8,1.5]},{count:100,parallaxFactor:.35,sizeRange:[1,2]},{count:50,parallaxFactor:.5,sizeRange:[1.5,2.5]}],n=1500,r=.3,l=250,a=150,h=1e3,c=10*Math.PI/180;var d;!function(t){t.RADIANT="Radiant",t.AURUM="Aurum",t.SOLARI="Solari"}(d||(d={}));class x{constructor(t,i){this.x=t,this.y=i}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}normalize(){const t=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return 0===t?new x(0,0):new x(this.x/t,this.y/t)}}class p{constructor(t,i,e=1){this.origin=t,this.direction=i,this.intensity=e}intersects(t,i){const e=new x(this.origin.x-t.x,this.origin.y-t.y),s=this.direction.x*this.direction.x+this.direction.y*this.direction.y,o=2*(e.x*this.direction.x+e.y*this.direction.y);return o*o-4*s*(e.x*e.x+e.y*e.y-i*i)>=0}intersectsPolygon(t){for(let i=0;i<t.length;i++){const e=t[i],s=t[(i+1)%t.length];if(null!==this.intersectsLineSegment(e,s))return!0}return!1}getIntersectionDistance(t){let i=null;for(let e=0;e<t.length;e++){const s=t[e],o=t[(e+1)%t.length],n=this.intersectsLineSegment(s,o);null!==n&&(null===i||n<i)&&(i=n)}return i}intersectsLineSegment(t,i){const e=new x(i.x-t.x,i.y-t.y),s=new x(t.x-this.origin.x,t.y-this.origin.y),o=this.direction.x*e.y-this.direction.y*e.x;if(Math.abs(o)<1e-4)return null;const n=(s.x*e.y-s.y*e.x)/o,r=(s.x*this.direction.y-s.y*this.direction.x)/o;return n>=0&&r>=0&&r<=1?n:null}}class u{constructor(t,i,e){this.position=t,this.sides=i,this.size=e,this.vertices=[],this.rotation=0,this.generateVertices(),this.rotationSpeed=.5*(Math.random()-.5)}generateVertices(){this.vertices=[];for(let t=0;t<this.sides;t++){const i=2*Math.PI*t/this.sides,e=.8+.4*Math.random(),s=this.size*e;this.vertices.push(new x(Math.cos(i)*s,Math.sin(i)*s))}}getWorldVertices(){return this.vertices.map(t=>{const i=Math.cos(this.rotation),e=Math.sin(this.rotation);return new x(this.position.x+t.x*i-t.y*e,this.position.y+t.x*e+t.y*i)})}update(t){this.rotation+=this.rotationSpeed*t}containsPoint(t){const i=this.getWorldVertices();let e=!1;for(let s=0,o=i.length-1;s<i.length;o=s++){const n=i[s].x,r=i[s].y,l=i[o].x,a=i[o].y;r>t.y!=a>t.y&&t.x<(l-n)*(t.y-r)/(a-r)+n&&(e=!e)}return e}}class g{constructor(t,i){this.position=t,this.owner=i,this.health=100,this.efficiency=1,this.isSelected=!1,this.targetPosition=null,this.velocity=new x(0,0),this.reflectionAngle=0,this.closestSunDistance=1/0,this.moveOrder=0,this.MAX_SPEED=50,this.ACCELERATION=25,this.DECELERATION=50,this.ARRIVAL_THRESHOLD=2,this.SLOW_RADIUS_PX=60,this.AVOIDANCE_BLEND_FACTOR=.6}isPathClear(t,i=[]){const e=new x(t.x-this.position.x,t.y-this.position.y).normalize(),s=new p(this.position,e),o=this.position.distanceTo(t);for(const t of i){const i=s.getIntersectionDistance(t.getWorldVertices());if(null!==i&&i<o)return!1}return!0}hasLineOfSightToLight(t,i=[]){for(const e of t)if(this.isPathClear(e.position,i))return!0;return!1}hasLineOfSightToForge(t,i=[]){return this.isPathClear(t.position,i)}getClosestVisibleSun(t,i=[]){let e=null,s=1/0;for(const o of t)if(this.isPathClear(o.position,i)){const t=this.position.distanceTo(o.position);t<s&&(e=o,s=t)}return e}generateSolarium(t){const i=Math.max(1,2-this.closestSunDistance/h);return 10*this.efficiency*i*t}setTarget(t){this.targetPosition=t}updateReflectionAngle(t,i,e=[]){if(!t)return;const s=this.getClosestVisibleSun(i,e);if(!s)return void(this.closestSunDistance=1/0);this.closestSunDistance=this.position.distanceTo(s.position);const o=new x(s.position.x-this.position.x,s.position.y-this.position.y).normalize(),n=new x(t.position.x-this.position.x,t.position.y-this.position.y).normalize(),r=o.x+n.x,l=o.y+n.y,a=Math.sqrt(r*r+l*l)>0?Math.atan2(l,r):Math.atan2(o.y,o.x);this.reflectionAngle=a+Math.PI/2}update(t,i=null){if(!this.targetPosition)return;const e=this.targetPosition.x-this.position.x,s=this.targetPosition.y-this.position.y,o=Math.sqrt(e*e+s*s);if(o<this.ARRIVAL_THRESHOLD)return this.position=this.targetPosition,this.targetPosition=null,void(this.velocity=new x(0,0));let n=e/o,r=s/o;if(i){const t=this.calculateObstacleAvoidance(i);if(t){n+=t.x*this.AVOIDANCE_BLEND_FACTOR,r+=t.y*this.AVOIDANCE_BLEND_FACTOR;const i=Math.sqrt(n*n+r*r);i>0&&(n/=i,r/=i)}}if(o<=this.SLOW_RADIUS_PX){const t=Math.max(0,o/this.SLOW_RADIUS_PX),i=this.MAX_SPEED*t;this.velocity.x=n*i,this.velocity.y=r*i}else{const i=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(o>i*i/(2*this.DECELERATION)&&i<this.MAX_SPEED)this.velocity.x+=n*this.ACCELERATION*t,this.velocity.y+=r*this.ACCELERATION*t;else if(i>.1){const e=this.DECELERATION*t,s=Math.max(0,(i-e)/i);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0;const e=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));e>this.MAX_SPEED&&(this.velocity.x=this.velocity.x/e*this.MAX_SPEED,this.velocity.y=this.velocity.y/e*this.MAX_SPEED)}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let i=0,e=0,s=0;const o=60;for(const n of t.suns){const t=this.position.x-n.position.x,r=this.position.y-n.position.y,l=Math.sqrt(t*t+r*r),a=n.radius+30;if(l<a+o){const n=(a+o-l)/o;i+=t/l*n,e+=r/l*n,s++}}for(const n of t.players){for(const t of n.solarMirrors){if(t===this)continue;const n=this.position.x-t.position.x,r=this.position.y-t.position.y,l=Math.sqrt(n*n+r*r),a=40;if(l<a+o&&l>0){const t=(a+o-l)/o;i+=n/l*t,e+=r/l*t,s++}}if(n.stellarForge){const t=n.stellarForge,r=this.position.x-t.position.x,l=this.position.y-t.position.y,a=Math.sqrt(r*r+l*l),h=t.radius+30;if(a<h+o){const t=(h+o-a)/o;i+=r/a*t,e+=l/a*t,s++}}}if(s>0){const t=Math.sqrt(i*i+e*e);if(t>0)return new x(i/t,e/t)}return null}containsPoint(t){return this.position.distanceTo(t)<20}}class y{constructor(t,i){this.position=t,this.owner=i,this.health=1e3,this.isReceivingLight=!1,this.unitQueue=[],this.isSelected=!1,this.targetPosition=null,this.velocity=new x(0,0),this.maxSpeed=50,this.acceleration=30,this.deceleration=50,this.slowRadiusPx=80,this.AVOIDANCE_BLEND_FACTOR=.6,this.radius=40,this.crunchTimer=0,this.currentCrunch=null,this.pendingSolarium=0,this.minionPath=[],this.moveOrder=0,this.crunchTimer=10*Math.random()}setMinionPath(t){this.minionPath=t}initializeDefaultPath(t){this.minionPath=[t]}canProduceUnits(){return this.isReceivingLight&&this.health>0}produceUnit(t,i,e){return!(!this.canProduceUnits()||e<i||(this.unitQueue.push(t),0))}updateLightStatus(t,i,e=[]){this.isReceivingLight=!1;for(const s of t)if(s.hasLineOfSightToLight(i,e)&&s.hasLineOfSightToForge(this,e)){this.isReceivingLight=!0;break}}update(t,i=null){if(this.health>0&&this.isReceivingLight&&(this.crunchTimer-=t),this.currentCrunch&&(this.currentCrunch.update(t),this.currentCrunch.isActive()||(this.currentCrunch=null)),this.targetPosition){const e=this.targetPosition.x-this.position.x,s=this.targetPosition.y-this.position.y,o=Math.sqrt(Math.pow(e,2)+Math.pow(s,2));if(o<5)this.position.x=this.targetPosition.x,this.position.y=this.targetPosition.y,this.velocity.x=0,this.velocity.y=0,this.targetPosition=null;else{let n=e/o,r=s/o;if(i){const t=this.calculateObstacleAvoidance(i);if(t){n+=t.x*this.AVOIDANCE_BLEND_FACTOR,r+=t.y*this.AVOIDANCE_BLEND_FACTOR;const i=Math.sqrt(n*n+r*r);i>0&&(n/=i,r/=i)}}if(o<=this.slowRadiusPx){const t=Math.max(0,o/this.slowRadiusPx),i=this.maxSpeed*t;this.velocity.x=n*i,this.velocity.y=r*i}else{this.velocity.x+=n*this.acceleration*t,this.velocity.y+=r*this.acceleration*t;const i=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));i>this.maxSpeed&&(this.velocity.x=this.velocity.x/i*this.maxSpeed,this.velocity.y=this.velocity.y/i*this.maxSpeed)}}}else{const i=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(i>.1){const e=this.deceleration*t,s=Math.max(0,(i-e)/i);this.velocity.x*=s,this.velocity.y*=s}else this.velocity.x=0,this.velocity.y=0}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t}calculateObstacleAvoidance(t){let i=0,e=0,s=0;const o=80;for(const n of t.suns){const t=this.position.x-n.position.x,r=this.position.y-n.position.y,l=Math.sqrt(t*t+r*r),a=n.radius+this.radius+10;if(l<a+o){const n=(a+o-l)/o;i+=t/l*n,e+=r/l*n,s++}}for(const n of t.players){if(n.stellarForge&&n.stellarForge!==this){const t=n.stellarForge,r=this.position.x-t.position.x,l=this.position.y-t.position.y,a=Math.sqrt(r*r+l*l),h=this.radius+t.radius+10;if(a<h+o&&a>0){const t=(h+o-a)/o;i+=r/a*t,e+=l/a*t,s++}}for(const t of n.solarMirrors){const n=this.position.x-t.position.x,r=this.position.y-t.position.y,l=Math.sqrt(n*n+r*r),a=this.radius+30;if(l<a+o){const t=(a+o-l)/o;i+=n/l*t,e+=r/l*t,s++}}}if(s>0){const t=Math.sqrt(i*i+e*e);if(t>0)return new x(i/t,e/t)}return null}shouldCrunch(){if(this.crunchTimer<=0&&this.health>0&&this.isReceivingLight){this.crunchTimer=10,this.currentCrunch=new b(new x(this.position.x,this.position.y)),this.currentCrunch.start();const t=this.pendingSolarium;return this.pendingSolarium=0,t}return 0}addPendingSolarium(t){this.pendingSolarium+=t}getCurrentCrunch(){return this.currentCrunch}setTarget(t){this.targetPosition=new x(t.x,t.y)}toggleSelection(){this.isSelected=!this.isSelected}containsPoint(t){return this.position.distanceTo(t)<=this.radius}}class f{constructor(t,i,e,s,o,n,r){this.position=t,this.owner=i,this.radius=s,this.attackRange=o,this.attackDamage=n,this.attackSpeed=r,this.attackCooldown=0,this.target=null,this.buildProgress=0,this.isComplete=!1,this.health=e,this.maxHealth=e}update(t,i,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.isComplete&&(this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(i)),this.target&&this.attackCooldown<=0)&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let i=null,e=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<e&&(e=t,i=s)}return i}attack(t){"health"in t&&(t.health-=this.attackDamage)}takeDamage(t){this.health-=t}isDestroyed(){return this.health<=0}addBuildProgress(t){this.isComplete||(this.buildProgress+=t,this.buildProgress>=1&&(this.buildProgress=1,this.isComplete=!0))}}class m extends f{constructor(t,i){super(t,i,200,30,350,12,6),this.lastShotEffects={}}attack(t){super.attack(t);const i=t.position.x-this.position.x,e=t.position.y-this.position.y,s=Math.atan2(e,i);this.lastShotEffects.muzzleFlash=new v(new x(this.position.x,this.position.y),s);const o=s+Math.PI/2+.5*(Math.random()-.5),n=100+50*Math.random();this.lastShotEffects.casing=new M(new x(this.position.x,this.position.y),new x(Math.cos(o)*n,Math.sin(o)*n));const r=s+Math.PI+1*(Math.random()-.5),l=150+100*Math.random();this.lastShotEffects.bouncingBullet=new C(new x(t.position.x,t.position.y),new x(Math.cos(r)*l,Math.sin(r)*l))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}}class S{constructor(t,i=1,e=100){this.position=t,this.intensity=i,this.radius=e}emitLight(t){return new p(this.position,t,this.intensity)}}class w{constructor(t,i){this.name=t,this.faction=i,this.solarium=100,this.stellarForge=null,this.solarMirrors=[],this.units=[],this.buildings=[],this.unitsCreated=0,this.unitsLost=0,this.solariumGathered=0}isDefeated(){return null===this.stellarForge||this.stellarForge.health<=0}addSolarium(t){this.solarium+=t,this.solariumGathered+=t}spendSolarium(t){return this.solarium>=t&&(this.solarium-=t,!0)}}class F{constructor(t,i){this.position=t,this.baseColor="#888888",this.currentColor="#888888",this.velocity=i||new x(2*(Math.random()-.5),2*(Math.random()-.5))}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.x*=.98,this.velocity.y*=.98}applyForce(t){this.velocity.x+=t.x,this.velocity.y+=t.y}updateColor(t,i){this.currentColor=t&&i>0?this.blendColors(this.baseColor,t,i):this.baseColor}blendColors(t,i,e){if(!(t&&i&&t.startsWith("#")&&i.startsWith("#")))return this.baseColor;const s=parseInt(t.slice(1),16),o=parseInt(i.slice(1),16);if(isNaN(s)||isNaN(o))return this.baseColor;const n=s>>16&255,r=s>>8&255,l=255&s,a=o>>16&255,h=o>>8&255,c=255&o;return`#${(Math.round(n+(a-n)*e)<<16|Math.round(r+(h-r)*e)<<8|Math.round(l+(c-l)*e)).toString(16).padStart(6,"0")}`}}class b{constructor(t){this.position=t,this.phase="idle",this.phaseTimer=0}start(){this.phase="suck",this.phaseTimer=.8}update(t){"idle"!==this.phase&&(this.phaseTimer-=t,this.phaseTimer<=0&&("suck"===this.phase?(this.phase="wave",this.phaseTimer=1.2):"wave"===this.phase&&(this.phase="idle",this.phaseTimer=0)))}isActive(){return"idle"!==this.phase}getPhaseProgress(){if("idle"===this.phase)return 0;const t="suck"===this.phase?.8:1.2;return 1-this.phaseTimer/t}}class M{constructor(t,i){this.position=t,this.rotation=0,this.lifetime=0,this.maxLifetime=2,this.velocity=i,this.rotationSpeed=10*(Math.random()-.5)}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.rotation+=this.rotationSpeed*t,this.velocity.x*=.95,this.velocity.y*=.95,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}applyCollision(t){this.velocity.x+=.3*t.x,this.velocity.y+=.3*t.y}}class v{constructor(t,i){this.position=t,this.angle=i,this.lifetime=0,this.maxLifetime=.05}update(t){this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class C{constructor(t,i){this.position=t,this.lifetime=0,this.maxLifetime=.5,this.velocity=i}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.velocity.y+=100*t,this.velocity.x*=.98,this.velocity.y*=.98,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}}class P{constructor(t,i,e,s=5){this.position=t,this.owner=e,this.damage=s,this.lifetime=0,this.maxLifetime=1,this.velocity=i}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldDespawn(){return this.lifetime>=this.maxLifetime}checkHit(t){return this.position.distanceTo(t.position)<10}}class T{constructor(t,i,e,s,o,n,r=5){this.position=t,this.owner=i,this.attackRange=s,this.attackDamage=o,this.attackSpeed=n,this.abilityCooldownTime=r,this.attackCooldown=0,this.abilityCooldown=0,this.target=null,this.rallyPoint=null,this.lastAbilityEffects=[],this.isHero=!1,this.moveOrder=0,this.health=e,this.maxHealth=e}update(t,i,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.moveTowardRallyPoint(t,100,e),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(i)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}moveTowardRallyPoint(t,i,e){if(!this.rallyPoint)return;const s=this.rallyPoint.x-this.position.x,o=this.rallyPoint.y-this.position.y,n=Math.sqrt(s*s+o*o);if(n<=5)return void(this.rallyPoint=null);let r=s/n,l=o/n,a=0,h=0;for(let t=0;t<e.length;t++){const i=e[t];if(i===this||i.isDead())continue;const s=this.position.x-i.position.x,o=this.position.y-i.position.y,n=s*s+o*o;if(n>0&&n<1600){const t=Math.sqrt(n);let e=(40-t)/40;this.isHero&&!i.isHero?e*=.3:!this.isHero&&i.isHero&&(e*=1.4),a+=s/t*e,h+=o/t*e}}const c=Math.sqrt(a*a+h*h);c>0&&(a/=c,h/=c),r+=.7*a,l+=.7*h;const d=Math.sqrt(r*r+l*l);d>0&&(r/=d,l/=d);const x=i*t;this.position.x+=r*x,this.position.y+=l*x;this.position.x=Math.max(-850,Math.min(850,this.position.x)),this.position.y=Math.max(-850,Math.min(850,this.position.y))}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let i=null,e=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<e&&(e=t,i=s)}return i}attack(t){"health"in t&&(t.health-=this.attackDamage)}useAbility(t){return!(this.abilityCooldown>0||(this.abilityCooldown=this.abilityCooldownTime,0))}getAndClearLastAbilityEffects(){const t=this.lastAbilityEffects;return this.lastAbilityEffects=[],t}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class A extends T{constructor(t,i){super(t,i,100,300,10,5,5),this.lastShotEffects={},this.isHero=!0}attack(t){super.attack(t);const i=t.position.x-this.position.x,e=t.position.y-this.position.y,s=Math.atan2(e,i);this.lastShotEffects.muzzleFlash=new v(new x(this.position.x,this.position.y),s);const o=s+Math.PI/2+.5*(Math.random()-.5),n=100+50*Math.random();this.lastShotEffects.casing=new M(new x(this.position.x,this.position.y),new x(Math.cos(o)*n,Math.sin(o)*n));const r=s+Math.PI+1*(Math.random()-.5),l=150+100*Math.random();this.lastShotEffects.bouncingBullet=new C(new x(t.position.x,t.position.y),new x(Math.cos(r)*l,Math.sin(r)*l))}getAndClearLastShotEffects(){const t=this.lastShotEffects;return this.lastShotEffects={},t}useAbility(t){if(!super.useAbility(t))return!1;const i=Math.atan2(t.y,t.x),e=c;for(let t=0;t<15;t++){const s=i+(t/Math.max(14,1)-.5)*e*2,o=500,n=new x(Math.cos(s)*o,Math.sin(s)*o),r=new P(new x(this.position.x,this.position.y),n,this.owner);this.lastAbilityEffects.push(r)}return!0}}class E{constructor(t,i,e){this.position=t,this.owner=e,this.lifetime=0,this.isAttacking=!1,this.targetEnemy=null,this.trail=[],this.velocity=i}update(t,i){if(!this.isAttacking){const e=i.x-this.position.x,s=i.y-this.position.y,o=Math.sqrt(e*e+s*s);if(o>0){const i=e/o,n=s/o,r=300;this.velocity.x+=i*r*t,this.velocity.y+=n*r*t;const l=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y);if(l<80){const t=80/l;this.velocity.x*=t,this.velocity.y*=t}}}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.isAttacking&&(this.trail.push(new x(this.position.x,this.position.y)),this.trail.length>15&&this.trail.shift(),this.lifetime+=t),this.isAttacking&&this.targetEnemy&&this.position.distanceTo(this.targetEnemy.position)<10&&("health"in this.targetEnemy&&(this.targetEnemy.health-=15),this.isAttacking=!1,this.trail=[],this.targetEnemy=null)}launchAtTarget(t){this.isAttacking=!0,this.targetEnemy=t,this.trail=[],this.lifetime=0;const i=t.position.x-this.position.x,e=t.position.y-this.position.y,s=Math.sqrt(i*i+e*e);if(s>0){const t=i/s,o=e/s;this.velocity.x=400*t,this.velocity.y=400*o}}returnToOrbit(){this.isAttacking=!1,this.trail=[],this.targetEnemy=null}}class D extends T{constructor(t,i){super(t,i,150,100,15,2,5),this.projectiles=[],this.projectileLaunchCooldown=0,this.isHero=!0;for(let e=0;e<5;e++){const s=e/5*Math.PI*2,o=50*Math.cos(s),n=50*Math.sin(s),r=80*-Math.sin(s),l=80*Math.cos(s);this.projectiles.push(new E(new x(t.x+o,t.y+n),new x(r,l),i))}}update(t,i,e){super.update(t,i,e),this.projectileLaunchCooldown>0&&(this.projectileLaunchCooldown-=t);for(const i of this.projectiles)i.update(t,this.position);if(this.target&&this.projectileLaunchCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange){const t=this.projectiles.find(t=>!t.isAttacking);t&&(t.launchAtTarget(this.target),this.projectileLaunchCooldown=1/this.attackSpeed)}}attack(t){}getProjectiles(){return this.projectiles}}class I extends T{constructor(t,i){super(t,i,50,150,5,2,0),this.explorationTarget=null,this.explorationTimer=0,this.currentPathWaypoint=0}updateAI(t,i){const e=this.owner.stellarForge;if(e&&e.minionPath.length>0){const t=e.minionPath[this.currentPathWaypoint];if(this.position.distanceTo(t)<10){if(!(this.currentPathWaypoint<e.minionPath.length-1))return void(this.rallyPoint=t);this.currentPathWaypoint++,this.rallyPoint=e.minionPath[this.currentPathWaypoint]}else this.rallyPoint=e.minionPath[this.currentPathWaypoint]}else{let e=null;for(const s of i)if(s instanceof y&&s.owner!==this.owner&&t.isObjectVisibleToPlayer(s.position,this.owner)){e=s.position;break}if(!e)for(const i of t.players)if(i!==this.owner){for(const s of i.solarMirrors)if(t.isObjectVisibleToPlayer(s.position,this.owner)){e=s.position;break}if(e)break}if(!e){if(this.explorationTimer<=0||!this.explorationTarget||this.position.distanceTo(this.explorationTarget)<5){const t=Math.random()*Math.PI*2,i=300+500*Math.random();this.explorationTarget=new x(this.position.x+Math.cos(t)*i,this.position.y+Math.sin(t)*i),this.explorationTimer=5}e=this.explorationTarget}e&&(this.rallyPoint=e)}}update(t,i,e){this.attackCooldown>0&&(this.attackCooldown-=t),this.abilityCooldown>0&&(this.abilityCooldown-=t),this.explorationTimer-=t,this.moveTowardRallyPoint(t,50,e||[]),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(i)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=this.attackRange&&(this.attack(this.target),this.attackCooldown=1/this.attackSpeed)}}class k{constructor(t,i){this.position=t,this.owner=i,this.chargeTime=0,this.isCharging=!1,this.isComplete=!1,this.health=100,this.hasEmittedShockwave=!1}update(t,i,e=1){this.isCharging&&!this.isComplete&&(i?(this.chargeTime+=t*e,this.chargeTime>=6&&(this.isComplete=!0,this.isCharging=!1)):this.cancel())}startCharging(){this.isCharging=!0,this.chargeTime=0}takeDamage(t){return this.health-=t,this.health<=0&&(this.cancel(),!0)}cancel(){this.isCharging=!1,this.isComplete=!1}shouldEmitShockwave(){return!this.hasEmittedShockwave&&this.chargeTime>=1&&(this.hasEmittedShockwave=!0,!0)}}class R{constructor(t,i,e){this.startPos=t,this.endPos=i,this.owner=e,this.lifetime=0,this.maxLifetime=.5}update(t){return this.lifetime+=t,this.lifetime>=this.maxLifetime}}class L extends T{constructor(t,i){super(t,i,120,250,8,3,8),this.beamSegments=[],this.drillDirection=null,this.isHero=!0}useAbility(t){return!!super.useAbility(t)&&(this.drillDirection=t,!0)}getBeamSegments(){return this.beamSegments}setBeamSegments(t){this.beamSegments=t}updateBeamSegments(t){this.beamSegments=this.beamSegments.filter(i=>!i.update(t))}}class z{constructor(t,i,e=150,s=10){this.position=t,this.owner=i,this.radius=e,this.duration=s,this.lifetime=0}update(t){return this.lifetime+=t,this.lifetime>=this.duration}isExpired(){return this.lifetime>=this.duration}}class O{constructor(t,i,e){this.position=t,this.owner=e,this.lifetime=0,this.maxLifetime=5,this.velocity=i}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.lifetime+=t}shouldExplode(){return this.lifetime>=this.maxLifetime}}class B extends T{constructor(t,i){super(t,i,100,200,5,1.5,15),this.projectileToCreate=null,this.isHero=!0}useAbility(t){if(!super.useAbility(t))return!1;const i=new x(300*t.x,300*t.y);return this.projectileToCreate=new O(new x(this.position.x,this.position.y),i,this.owner),!0}getAndClearProjectile(){const t=this.projectileToCreate;return this.projectileToCreate=null,t}}class H{constructor(t,i,e=null){this.position=t,this.owner=i,this.attachedToAsteroid=e,this.maxHealth=150,this.attackCooldown=0,this.target=null,this.health=this.maxHealth}update(t,i){this.attackCooldown>0&&(this.attackCooldown-=t),this.target&&!this.isTargetDead(this.target)||(this.target=this.findNearestEnemy(i)),this.target&&this.attackCooldown<=0&&this.position.distanceTo(this.target.position)<=300&&(this.attack(this.target),this.attackCooldown=1/3)}isTargetDead(t){return"health"in t&&t.health<=0}findNearestEnemy(t){let i=null,e=1/0;for(const s of t){if("health"in s&&s.health<=0)continue;const t=this.position.distanceTo(s.position);t<e&&(e=t,i=s)}return i}attack(t){"health"in t&&(t.health-=12)}takeDamage(t){this.health-=t}isDead(){return this.health<=0}}class W extends T{constructor(t,i){super(t,i,90,180,6,2,12),this.isHero=!0}useAbility(t){return!!super.useAbility(t)}}class U extends T{constructor(t,i){super(t,i,140,0,0,0,5),this.isDrilling=!1,this.isHidden=!1,this.drillDirection=null,this.drillVelocity=new x(0,0),this.hiddenInAsteroid=null,this.isHero=!0}attack(t){}useAbility(t){return!this.isDrilling&&!!super.useAbility(t)&&(this.isDrilling=!0,this.isHidden=!1,this.drillDirection=t.normalize(),this.drillVelocity=new x(500*this.drillDirection.x,500*this.drillDirection.y),!0)}updateDrilling(t){this.isDrilling&&this.drillVelocity&&(this.position.x+=this.drillVelocity.x*t,this.position.y+=this.drillVelocity.y*t)}stopDrilling(){this.isDrilling=!1,this.drillVelocity=new x(0,0)}hideInAsteroid(t){this.isHidden=!0,this.hiddenInAsteroid=t,this.position=new x(t.position.x,t.position.y)}isHiddenInAsteroid(){return this.isHidden}}class ${constructor(){this.players=[],this.suns=[],this.spaceDust=[],this.warpGates=[],this.asteroids=[],this.muzzleFlashes=[],this.bulletCasings=[],this.bouncingBullets=[],this.abilityBullets=[],this.influenceZones=[],this.influenceBallProjectiles=[],this.deployedTurrets=[],this.gameTime=0,this.stateHash=0,this.stateHashTickCounter=0,this.isRunning=!1,this.countdownTime=3,this.isCountdownActive=!0,this.mirrorsMovedToSun=!1,this.mapSize=2e3,this.MAX_PUSH_DISTANCE=10,this.PUSH_MULTIPLIER=15}update(i){this.gameTime+=i,this.isCountdownActive&&(this.countdownTime-=i,this.mirrorsMovedToSun||(this.initializeMirrorMovement(),this.mirrorsMovedToSun=!0),this.countdownTime<=0&&(this.isCountdownActive=!1,this.countdownTime=0));for(const t of this.asteroids)t.update(i);for(const t of this.players)if(!t.isDefeated()){if(t.stellarForge){const e=new x(t.stellarForge.position.x,t.stellarForge.position.y);if(t.stellarForge.updateLightStatus(t.solarMirrors,this.suns,this.asteroids),this.isCountdownActive||(t.stellarForge.update(i,this),this.checkCollision(t.stellarForge.position,t.stellarForge.radius,t.stellarForge)&&(t.stellarForge.position=e,t.stellarForge.targetPosition=null,t.stellarForge.velocity=new x(0,0))),!this.isCountdownActive){const i=t.stellarForge.shouldCrunch();if(i>0){const e=Math.floor(i/50);for(let i=0;i<e;i++){const s=2*Math.PI*i/e,o=210,n=new x(t.stellarForge.position.x+Math.cos(s)*o,t.stellarForge.position.y+Math.sin(s)*o),r=new I(n,t);t.units.push(r),t.unitsCreated++}e>0&&console.log(`${t.name} forge crunch spawned ${e} Starlings with ${i.toFixed(0)} solarium`)}}}for(const e of t.solarMirrors){const s=new x(e.position.x,e.position.y);if(e.update(i,this),this.checkCollision(e.position,20,e)&&(e.position=s,e.targetPosition=null,e.velocity=new x(0,0)),e.updateReflectionAngle(t.stellarForge,this.suns,this.asteroids),e.hasLineOfSightToLight(this.suns,this.asteroids)&&t.stellarForge&&e.hasLineOfSightToForge(t.stellarForge,this.asteroids)){const s=e.generateSolarium(i);t.stellarForge.addPendingSolarium(s)}}}this.updateSpaceDust(i);const e=[],s=[];for(const t of this.players)t.isDefeated()||(e.push(...t.units),t.stellarForge&&s.push(t.stellarForge));for(const s of this.players){if(s.isDefeated())continue;const o=[];for(const t of this.players)t===s||t.isDefeated()||(o.push(...t.units),o.push(...t.buildings),t.stellarForge&&o.push(t.stellarForge));if(!this.isCountdownActive)for(const t of s.units){if(t instanceof I&&t.updateAI(this,o),t.update(i,o,e),t instanceof A){const i=t.getAndClearLastShotEffects();i.muzzleFlash&&this.muzzleFlashes.push(i.muzzleFlash),i.casing&&this.bulletCasings.push(i.casing),i.bouncingBullet&&this.bouncingBullets.push(i.bouncingBullet)}const s=t.getAndClearLastAbilityEffects();if(this.abilityBullets.push(...s),t instanceof B){const i=t.getAndClearProjectile();i&&this.influenceBallProjectiles.push(i)}t instanceof L&&(t.updateBeamSegments(i),t.abilityCooldown>t.abilityCooldownTime-.1&&t.drillDirection&&(this.processRayBeamAbility(t),t.drillDirection=null)),t instanceof W&&t.abilityCooldown>t.abilityCooldownTime-.1&&this.processTurretDeployment(t),t instanceof U&&t.isDrilling&&(t.updateDrilling(i),this.processDrillerCollisions(t,i))}const n=s.units.filter(t=>t.isDead());if(s.unitsLost+=n.length,s.units=s.units.filter(t=>!t.isDead()),!this.isCountdownActive)for(const t of s.buildings)if(t.update(i,o,e),t instanceof m){const i=t.getAndClearLastShotEffects();i.muzzleFlash&&this.muzzleFlashes.push(i.muzzleFlash),i.casing&&this.bulletCasings.push(i.casing),i.bouncingBullet&&this.bouncingBullets.push(i.bouncingBullet)}if(!this.isCountdownActive)for(const e of s.buildings)if(!e.isComplete)if(s.stellarForge&&e.position.distanceTo(s.stellarForge.position)<=t&&s.stellarForge){const t=.2*i;e.addBuildProgress(t)}else{let t=0;for(const i of s.solarMirrors){if(!i.hasLineOfSightToLight(this.suns,this.asteroids))continue;const s=new p(i.position,new x(e.position.x-i.position.x,e.position.y-i.position.y).normalize(),1);let o=!0;for(const t of this.asteroids)if(s.intersectsPolygon(t.getWorldVertices())){o=!1;break}if(o){const e=this.suns.reduce((t,e)=>i.position.distanceTo(e.position)<(t?i.position.distanceTo(t.position):1/0)?e:t,null);if(e){const s=i.position.distanceTo(e.position);t+=Math.max(1,2*(1-Math.min(1,s/h)))}}}if(t>0){const s=t/10*.2*i;e.addBuildProgress(s)}}s.buildings=s.buildings.filter(t=>!t.isDestroyed())}this.isCountdownActive||(this.resolveUnitCollisions(e),this.resolveUnitObstacleCollisions(e)),this.stateHashTickCounter+=1,this.stateHashTickCounter%30==0&&this.updateStateHash();for(const t of this.muzzleFlashes)t.update(i);this.muzzleFlashes=this.muzzleFlashes.filter(t=>!t.shouldDespawn());for(const t of this.bulletCasings){t.update(i);for(const i of this.spaceDust)if(t.position.distanceTo(i.position)<5){const e=new x(i.position.x-t.position.x,i.position.y-t.position.y).normalize();i.applyForce(new x(50*e.x,50*e.y)),t.applyCollision(new x(50*-e.x,50*-e.y))}}this.bulletCasings=this.bulletCasings.filter(t=>!t.shouldDespawn());for(const t of this.bouncingBullets)t.update(i);this.bouncingBullets=this.bouncingBullets.filter(t=>!t.shouldDespawn());for(const t of this.abilityBullets){t.update(i);for(const i of this.players)if(i!==t.owner){for(const e of i.units)if(t.checkHit(e)){e.takeDamage(t.damage),t.lifetime=t.maxLifetime;break}i.stellarForge&&t.checkHit(i.stellarForge)&&(i.stellarForge.health-=t.damage,t.lifetime=t.maxLifetime)}}this.abilityBullets=this.abilityBullets.filter(t=>!t.shouldDespawn()),this.influenceZones=this.influenceZones.filter(t=>!t.update(i));for(const t of this.influenceBallProjectiles)if(t.update(i),t.shouldExplode()){const i=new z(new x(t.position.x,t.position.y),t.owner);this.influenceZones.push(i)}this.influenceBallProjectiles=this.influenceBallProjectiles.filter(t=>!t.shouldExplode());const o=[];for(const t of this.players)t.isDefeated()||(o.push(...t.units),o.push(...t.buildings),t.stellarForge&&o.push(t.stellarForge));for(const t of this.deployedTurrets){const e=o.filter(i=>(i instanceof T||i instanceof f||i instanceof y)&&i.owner!==t.owner);t.update(i,e)}this.deployedTurrets=this.deployedTurrets.filter(t=>!t.isDead())}updateSpaceDust(s){for(const o of this.spaceDust){o.update(s);let n=null;for(let s=0;s<this.players.length;s++){const r=this.players[s];if(r.stellarForge&&!r.isDefeated()){const l=o.position.distanceTo(r.stellarForge.position);if(l<t){const t=0===s?i:e;(!n||l<n.distance)&&(n={color:t,distance:l})}}}if(n){const i=1-n.distance/t;o.updateColor(n.color,i)}else o.updateColor(null,0)}for(const t of this.warpGates)if(t.isCharging&&t.chargeTime>=1)for(const i of this.spaceDust){const e=i.position.distanceTo(t.position);if(e<200&&e>5){const o=new x(t.position.x-i.position.x,t.position.y-i.position.y).normalize(),n=new x(-o.y,o.x),r=new x(50*o.x+20*n.x,50*o.y+20*n.y);i.applyForce(new x(r.x*s/e,r.y*s/e))}}for(const t of this.players)if(t.stellarForge&&!t.isDefeated()){const i=t.stellarForge.getCurrentCrunch();if(i&&i.isActive())for(const t of this.spaceDust){const e=t.position.distanceTo(i.position);if("suck"===i.phase&&e<250){if(e>5){const o=new x(i.position.x-t.position.x,i.position.y-t.position.y).normalize(),n=150/Math.sqrt(e);t.applyForce(new x(o.x*n*s,o.y*n*s))}}else if("wave"===i.phase&&e<300&&e>5){const o=new x(t.position.x-i.position.x,t.position.y-i.position.y).normalize(),n=300*i.getPhaseProgress(),r=Math.abs(e-n),l=50,a=200*Math.exp(-r/l);t.applyForce(new x(o.x*a*s,o.y*a*s))}}}}initializeMirrorMovement(){if(0===this.suns.length)return;const t=this.suns[0];for(const i of this.players){if(!i.stellarForge||i.solarMirrors.length<2)continue;const e=i.stellarForge.position,s=e.x-t.position.x,o=e.y-t.position.y,n=Math.atan2(o,s),r=n+Math.PI/2,l=n-Math.PI/2;if(i.solarMirrors.length>=1){const t=new x(e.x+Math.cos(r)*a,e.y+Math.sin(r)*a);i.solarMirrors[0].setTarget(t)}if(i.solarMirrors.length>=2){const t=new x(e.x+Math.cos(l)*a,e.y+Math.sin(l)*a);i.solarMirrors[1].setTarget(t)}}}isPointInShadow(t){if(0===this.suns.length)return!0;for(const i of this.suns){const e=new x(i.position.x-t.x,i.position.y-t.y).normalize(),s=new p(t,e),o=t.distanceTo(i.position);let n=!0;for(const t of this.asteroids){const i=s.getIntersectionDistance(t.getWorldVertices());if(null!==i&&i<o){n=!1;break}}if(n)return!1}return!0}isObjectVisibleToPlayer(i,e){if(!this.isPointInShadow(i))return!0;for(const t of e.units)if(t.position.distanceTo(i)<=150)return!0;return!!(e.stellarForge&&e.stellarForge.position.distanceTo(i)<=t)}processRayBeamAbility(t){if(!t.drillDirection)return;const i=[];let e=new x(t.position.x,t.position.y),s=t.drillDirection.normalize(),o=0;const n=2e3;for(;o<5;){let r=null,l=n;for(const t of this.asteroids){const i=this.rayIntersectsAsteroid(e,s,t);if(i){const t=e.distanceTo(i);t<l&&(l=t,r={pos:i,type:"asteroid"})}}for(const i of this.players)if(i!==t.owner){for(const t of i.units){const i=this.rayIntersectsUnit(e,s,t.position);if(i){const s=e.distanceTo(i);s<l&&(l=s,r={pos:i,type:"unit",target:t})}}if(i.stellarForge){const t=this.rayIntersectsUnit(e,s,i.stellarForge.position,i.stellarForge.radius);if(t){const s=e.distanceTo(t);s<l&&(l=s,r={pos:t,type:"forge",target:i.stellarForge})}}}for(const t of this.suns){const i=this.rayIntersectsUnit(e,s,t.position,t.radius);if(i){const t=e.distanceTo(i);t<l&&(l=t,r={pos:i,type:"sun"})}}const a=this.rayIntersectsEdge(e,s);if(a&&e.distanceTo(a)<l&&(l=e.distanceTo(a),r={pos:a,type:"edge"}),!r){const o=new x(e.x+s.x*n,e.y+s.y*n);i.push(new R(e,o,t.owner));break}if(i.push(new R(e,r.pos,t.owner)),"unit"===r.type||"forge"===r.type){r.target&&r.target.takeDamage(25);break}if("sun"===r.type||"edge"===r.type)break;"asteroid"===r.type&&(o++,e=r.pos,s=new x(-s.x,-s.y))}t.setBeamSegments(i)}rayIntersectsAsteroid(t,i,e){const s=new x(e.position.x-t.x,e.position.y-t.y),o=s.x*i.x+s.y*i.y;if(o<0)return null;const n=new x(t.x+i.x*o,t.y+i.y*o);return n.distanceTo(e.position)<60?n:null}rayIntersectsUnit(t,i,e,s=8){const o=new x(e.x-t.x,e.y-t.y),n=o.x*i.x+o.y*i.y;if(n<0)return null;const r=new x(t.x+i.x*n,t.y+i.y*n);return r.distanceTo(e)<s?r:null}rayIntersectsEdge(t,i){const e=this.mapSize;let s=null,o=1/0;const n=[{x:0,normal:new x(1,0)},{x:e,normal:new x(-1,0)},{y:0,normal:new x(0,1)},{y:e,normal:new x(0,-1)}];for(const e of n){let n=null;if("x"in e&&void 0!==e.x){if(Math.abs(i.x)>.001){const s=(e.x-t.x)/i.x;s>0&&(n=new x(e.x,t.y+i.y*s))}}else if("y"in e&&void 0!==e.y&&Math.abs(i.y)>.001){const s=(e.y-t.y)/i.y;s>0&&(n=new x(t.x+i.x*s,e.y))}if(n){const i=t.distanceTo(n);i<o&&(o=i,s=n)}}return s}processTurretDeployment(t){let i=null,e=1/0;for(const s of this.asteroids){const o=t.position.distanceTo(s.position);o<e&&o<200&&(e=o,i=s)}if(i){const e=new H(new x(i.position.x,i.position.y),t.owner,i);this.deployedTurrets.push(e)}}processDrillerCollisions(t,i){for(const i of this.suns)if(t.position.distanceTo(i.position)<i.radius+10)return t.health=0,void t.stopDrilling();for(const i of this.asteroids)if(i.containsPoint(t.position))return t.hideInAsteroid(i),void t.stopDrilling();for(const i of this.players)if(i!==t.owner){for(const e of i.units)t.position.distanceTo(e.position)<15&&e.takeDamage(30);for(const e of i.buildings)t.position.distanceTo(e.position)<40&&e.takeDamage(60);i.stellarForge&&t.position.distanceTo(i.stellarForge.position)<i.stellarForge.radius+10&&(i.stellarForge.health-=60)}const e=this.mapSize;if(t.position.x<0||t.position.x>e||t.position.y<0||t.position.y>e){const s=Math.sqrt(Math.pow(t.drillVelocity.x,2)+Math.pow(t.drillVelocity.y,2));if(s>0){const e=200*i,o=Math.max(0,s-e);0===o?t.stopDrilling():(t.drillVelocity.x=t.drillVelocity.x/s*o,t.drillVelocity.y=t.drillVelocity.y/s*o)}t.position.x=Math.max(0,Math.min(e,t.position.x)),t.position.y=Math.max(0,Math.min(e,t.position.y))}}resolveUnitCollisions(t){for(let i=0;i<t.length;i++){const e=t[i];if(!e.isDead())for(let s=i+1;s<t.length;s++){const o=t[s];if(o.isDead())continue;let n=o.position.x-e.position.x,r=o.position.y-e.position.y,l=n*n+r*r;if(0===l&&(n=i%2==0?1:-1,r=0,l=1),l<400){const t=Math.sqrt(l),i=20-t,s=n/t*i,a=r/t*i;e.isHero&&!o.isHero?(o.position.x+=s,o.position.y+=a):!e.isHero&&o.isHero?(e.position.x-=s,e.position.y-=a):(e.position.x-=.5*s,e.position.y-=.5*a,o.position.x+=.5*s,o.position.y+=.5*a)}}}}resolveUnitObstacleCollisions(t){for(const i of t){if(i.isDead())continue;const t=new x(i.position.x,i.position.y);if(this.checkCollision(i.position,10)){let e=0,s=0,o=0;for(const t of this.suns){const n=i.position.x-t.position.x,r=i.position.y-t.position.y,l=Math.sqrt(n*n+r*r),a=t.radius+10;if(l<a){const t=(a-l)/a;e+=n/l*t,s+=r/l*t,o++}}for(const t of this.players)if(t.stellarForge&&t!==i.owner){const n=t.stellarForge,r=i.position.x-n.position.x,l=i.position.y-n.position.y,a=Math.sqrt(r*r+l*l),h=n.radius+10;if(a<h){const t=(h-a)/h;e+=r/a*t,s+=l/a*t,o++}}for(const t of this.players)for(const n of t.solarMirrors){if(n.owner===i.owner)continue;const t=i.position.x-n.position.x,r=i.position.y-n.position.y,l=Math.sqrt(t*t+r*r),a=30;if(l<a){const i=(a-l)/a;e+=t/l*i,s+=r/l*i,o++}}for(const t of this.players)for(const n of t.buildings){const t=i.position.x-n.position.x,r=i.position.y-n.position.y,l=Math.sqrt(t*t+r*r),a=n.radius+10;if(l<a){const i=(a-l)/a;e+=t/l*i,s+=r/l*i,o++}}if(o>0){const o=Math.sqrt(e*e+s*s);if(o>0){const n=Math.min(this.MAX_PUSH_DISTANCE,o*this.PUSH_MULTIPLIER);i.position.x=t.x+e/o*n,i.position.y=t.y+s/o*n}}this.checkCollision(i.position,10)&&(i.position=t,i.rallyPoint=null)}}}checkCollision(t,i=10,e=null){for(const e of this.suns)if(t.distanceTo(e.position)<e.radius+i)return!0;for(const i of this.asteroids)if(i.containsPoint(t))return!0;for(const s of this.players){if(s.stellarForge){if(s.stellarForge===e)continue;if(t.distanceTo(s.stellarForge.position)<s.stellarForge.radius+i)return!0}for(const o of s.solarMirrors)if(o!==e&&t.distanceTo(o.position)<20+i)return!0;for(const o of s.buildings)if(o!==e&&t.distanceTo(o.position)<o.radius+i)return!0}return!1}updateStateHash(){let t=2166136261;const i=i=>{const e=Math.floor(100*i);t=Math.imul(t^e,16777619)},e=i=>{t=Math.imul(t^i,16777619)},s=t=>{e(t.length);for(let i=0;i<t.length;i++)e(t.charCodeAt(i))};i(this.gameTime),i(this.suns.length),i(this.asteroids.length);for(const t of this.players){if(i(t.solarium),t.stellarForge){i(t.stellarForge.position.x),i(t.stellarForge.position.y),i(t.stellarForge.health),e(t.stellarForge.unitQueue.length);for(const i of t.stellarForge.unitQueue)s(i);t.stellarForge.targetPosition?(i(t.stellarForge.targetPosition.x),i(t.stellarForge.targetPosition.y)):(i(-1),i(-1)),i(t.stellarForge.velocity.x),i(t.stellarForge.velocity.y)}else i(-1);for(const e of t.solarMirrors)i(e.position.x),i(e.position.y),i(e.health),e.targetPosition?(i(e.targetPosition.x),i(e.targetPosition.y)):(i(-1),i(-1)),i(e.velocity.x),i(e.velocity.y);for(const e of t.units)i(e.position.x),i(e.position.y),i(e.health),i(e.isHero?1:0);for(const e of t.buildings)i(e.position.x),i(e.position.y),i(e.health),i(e.isComplete?1:0)}this.stateHash=t>>>0}initializeSpaceDust(t,i,e){this.spaceDust=[];for(let s=0;s<t;s++){const t=(Math.random()-.5)*i,s=(Math.random()-.5)*e;this.spaceDust.push(new F(new x(t,s)))}}initializeAsteroids(t,i,e){this.asteroids=[];for(let s=0;s<t;s++){let t=!1,s=0,o=0,n=0,r=0;for(;!t&&s<50;){const l=Math.random()*Math.PI*2,a=200+Math.random()*(Math.min(i,e)/2-300);o=Math.cos(l)*a,n=Math.sin(l)*a,r=30+50*Math.random(),t=!0;for(const i of this.asteroids){const e=o-i.position.x,s=n-i.position.y;if(Math.sqrt(e*e+s*s)<r+i.size){t=!1;break}}s++}if(t){const t=3+Math.floor(7*Math.random());this.asteroids.push(new u(new x(o,n),t,r))}}}checkVictoryConditions(){const t=this.players.filter(t=>!t.isDefeated());return 1===t.length?t[0]:null}initializePlayer(t,i,e){t.stellarForge=new y(i,t);for(const i of e){const e=new g(i,t);t.solarMirrors.push(e)}}}class G{constructor(t){this.camera=new x(0,0),this.zoom=1,this.selectionStart=null,this.selectionEnd=null,this.abilityArrowStart=null,this.abilityArrowEnd=null,this.selectedUnits=new Set,this.pathPreviewForge=null,this.pathPreviewPoints=[],this.pathPreviewEnd=null,this.tapEffects=[],this.swipeEffects=[],this.viewingPlayer=null,this.showInfo=!1,this.showInGameMenu=!1,this.isPaused=!1,this.MOVE_ORDER_DOT_RADIUS=12,this.starLayers=[],this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Could not get 2D context from canvas");this.ctx=i,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.initializeStarLayers()}resizeCanvas(){const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=`${window.innerWidth}px`,this.canvas.style.height=`${window.innerHeight}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t)}initializeStarLayers(){let t=42;const i=()=>(t=(9301*t+49297)%233280,t/233280);for(const t of o){const e=[];for(let o=0;o<t.count;o++)e.push({x:i()*s-2e3,y:i()*s-2e3,size:t.sizeRange[0]+i()*(t.sizeRange[1]-t.sizeRange[0]),brightness:.3+.7*i()});this.starLayers.push({stars:e,parallaxFactor:t.parallaxFactor})}}worldToScreen(t){const i=this.canvas.width/2,e=this.canvas.height/2;return new x(i+(t.x-this.camera.x)*this.zoom,e+(t.y-this.camera.y)*this.zoom)}isWithinRenderBounds(t,i,e=0){const s=i/2;return t.x>=-s-e&&t.x<=s+e&&t.y>=-s-e&&t.y<=s+e}screenToWorld(t,i){const e=this.canvas.width/2,s=this.canvas.height/2;return new x(this.camera.x+(t-e)/this.zoom,this.camera.y+(i-s)/this.zoom)}getFactionColor(t){switch(t){case d.RADIANT:return"#FFD700";case d.AURUM:return"#DAA520";case d.SOLARI:return"#FF8C00";default:return"#FFFFFF"}}drawSun(t){const i=this.worldToScreen(t.position),e=t.radius*this.zoom,s=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,e);s.addColorStop(0,"rgba(255, 255, 150, 1)"),s.addColorStop(.5,"rgba(255, 200, 50, 0.5)"),s.addColorStop(1,"rgba(255, 150, 0, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFF00",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,.6*e,0,2*Math.PI),this.ctx.fill()}drawLensFlare(t){const i=this.worldToScreen(t.position),e=t.radius*this.zoom,s=window.devicePixelRatio||1,o=this.canvas.width/s,n=this.canvas.height/s,r=o/2,l=n/2,a=i.x-r,h=i.y-l;if(Math.sqrt(a*a+h*h)>Math.sqrt(o*o+n*n)/2+e)return;const c=[{offset:-.3,size:.4,alpha:.15,color:"rgba(255, 200, 100, "},{offset:-.5,size:.25,alpha:.12,color:"rgba(100, 150, 255, "},{offset:.4,size:.3,alpha:.1,color:"rgba(255, 150, 150, "},{offset:.7,size:.2,alpha:.08,color:"rgba(150, 255, 200, "}];for(const t of c){const i=r+a*t.offset,s=l+h*t.offset,o=e*t.size,n=this.ctx.createRadialGradient(i,s,0,i,s,o);n.addColorStop(0,`${t.color}${t.alpha})`),n.addColorStop(.5,`${t.color}${.5*t.alpha})`),n.addColorStop(1,`${t.color}0)`),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(i,s,o,0,2*Math.PI),this.ctx.fill()}this.ctx.save(),this.ctx.globalAlpha=.2,this.ctx.strokeStyle="rgba(255, 255, 200, 0.3)",this.ctx.lineWidth=2;for(let t=0;t<6;t++){const s=Math.PI/3*t,o=1.5*e,n=i.x+Math.cos(s)*e*.7,r=i.y+Math.sin(s)*e*.7,l=i.x+Math.cos(s)*o,a=i.y+Math.sin(s)*o,h=this.ctx.createLinearGradient(n,r,l,a);h.addColorStop(0,"rgba(255, 255, 200, 0.4)"),h.addColorStop(1,"rgba(255, 255, 200, 0)"),this.ctx.strokeStyle=h,this.ctx.beginPath(),this.ctx.moveTo(n,r),this.ctx.lineTo(l,a),this.ctx.stroke()}this.ctx.restore()}drawStellarForge(t,i,e,s){const o=this.worldToScreen(t.position),n=40*this.zoom;let l=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(l=!0,this.ctx.globalAlpha=r)}if(t.isSelected){if(this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,1.5*n,0,2*Math.PI),this.ctx.stroke(),t.minionPath.length>0){this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.setLineDash([10,5]),this.ctx.beginPath();const i=this.worldToScreen(t.position);this.ctx.moveTo(i.x,i.y);for(const i of t.minionPath){const t=this.worldToScreen(i);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="#FFFF00";for(let i=0;i<t.minionPath.length;i++){const e=t.minionPath[i],s=this.worldToScreen(e);this.ctx.beginPath(),this.ctx.arc(s.x,s.y,5,0,2*Math.PI),this.ctx.fill(),i===t.minionPath.length-1&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,8,0,2*Math.PI),this.ctx.stroke())}}this.pathPreviewForge===t&&(this.pathPreviewPoints.length>0||this.pathPreviewEnd)&&this.drawMinionPathPreview(t.position,this.pathPreviewPoints,this.pathPreviewEnd),this.drawHeroButtons(t,o,n)}this.ctx.fillStyle=i,this.ctx.strokeStyle=t.isReceivingLight?"#00FF00":"#FF0000",this.ctx.lineWidth=3,this.ctx.beginPath();for(let t=0;t<6;t++){const i=Math.PI/3*t,e=o.x+n*Math.cos(i),s=o.y+n*Math.sin(i);0===t?this.ctx.moveTo(e,s):this.ctx.lineTo(e,s)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();const a=2*n,h=o.x-a/2,c=o.y-n-15;this.ctx.fillStyle="#333",this.ctx.fillRect(h,c,a,6);const d=t.health/1e3;this.ctx.fillStyle=d>.5?"#00FF00":d>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(h,c,a*d,6),t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,i),l&&(this.ctx.globalAlpha=1)}drawHeroButtons(t,i,e){const s=20*this.zoom,o=2.5*e,n=[{x:0,y:-1,label:"H1"},{x:1,y:0,label:"H2"},{x:0,y:1,label:"H3"},{x:-1,y:0,label:"H4"}];for(let t=0;t<n.length;t++){const e=n[t],r=i.x+e.x*o,l=i.y+e.y*o,a=!0;this.ctx.fillStyle=a?"rgba(0, 255, 136, 0.3)":"rgba(128, 128, 128, 0.3)",this.ctx.strokeStyle=a?"#00FF88":"#888888",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(r,l,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=a?"#FFFFFF":"#666666",this.ctx.font=12*this.zoom+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e.label,r,l)}this.ctx.fillStyle="#AAAAAA",this.ctx.font=10*this.zoom+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText("Hero Production (Stub)",i.x,i.y+2.5*e)}drawSolarMirror(t,i,e){const s=this.worldToScreen(t.position),o=20*this.zoom;this.ctx.save();const n=Math.max(0,Math.min(1,1-t.closestSunDistance/h));if(n>.1&&t.closestSunDistance!==1/0){const i=15*this.zoom*(1+n),o=this.ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,i);o.addColorStop(0,`rgba(255, 255, 150, ${.8*n})`),o.addColorStop(.5,`rgba(255, 255, 100, ${.4*n})`),o.addColorStop(1,"rgba(255, 255, 50, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,i,0,2*Math.PI),this.ctx.fill();const r=t.getClosestVisibleSun(e.suns,e.asteroids);if(r){const i=t.owner.stellarForge;let o=null;if(i&&t.hasLineOfSightToForge(i,e.asteroids))o=new x(i.position.x-t.position.x,i.position.y-t.position.y).normalize();else{const i=new x(r.position.x-t.position.x,r.position.y-t.position.y).normalize();o=new x(-i.x,-i.y)}const l=100,a=new x(t.position.x+o.x*l,t.position.y+o.y*l),h=this.worldToScreen(a),c=this.ctx.createLinearGradient(s.x,s.y,h.x,h.y);c.addColorStop(0,`rgba(255, 255, 200, ${1*n})`),c.addColorStop(.7,`rgba(255, 255, 150, ${.6*n})`),c.addColorStop(1,"rgba(255, 255, 100, 0)"),this.ctx.strokeStyle=c,this.ctx.lineWidth=15*this.zoom*n,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(h.x,h.y),this.ctx.stroke();const d=20*this.zoom*n,p=this.ctx.createRadialGradient(h.x,h.y,0,h.x,h.y,d);p.addColorStop(0,`rgba(255, 255, 255, ${.9*n})`),p.addColorStop(.5,`rgba(255, 255, 200, ${.5*n})`),p.addColorStop(1,"rgba(255, 255, 150, 0)"),this.ctx.fillStyle=p,this.ctx.beginPath(),this.ctx.arc(h.x,h.y,d,0,2*Math.PI),this.ctx.fill()}}this.ctx.translate(s.x,s.y),this.ctx.rotate(t.reflectionAngle);const r=2*o,l=.3*o,a=this.ctx.createLinearGradient(0,-l/2,0,l/2);a.addColorStop(0,"#FFFFFF"),a.addColorStop(.5,"#E0E0E0"),a.addColorStop(1,"#C0C0C0"),this.ctx.fillStyle=a,this.ctx.fillRect(-r/2,-l/2,r,l),this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.strokeRect(-r/2,-l/2,r,l),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(-r/2,0,3,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(r/2,0,3,0,2*Math.PI),this.ctx.fill(),t.isSelected&&(this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=3,this.ctx.strokeRect(-r/2-3,-l/2-3,r+6,l+6)),this.ctx.restore(),t.efficiency<1&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(s.x,s.y,.3*o,0,2*Math.PI),this.ctx.fill()),t.moveOrder>0&&t.targetPosition&&this.drawMoveOrderIndicator(t.position,t.targetPosition,t.moveOrder,i)}drawSpaceDust(t,i,e){const s=this.worldToScreen(t.position),o=2*this.zoom;let n=t.currentColor;if(null!==e&&i.isPointInShadow(t.position)){const s=this.getClosestInfluenceOwnerIndex(t.position,i);null!==s&&s!==e&&(n=t.baseColor)}this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.fill()}getClosestInfluenceOwnerIndex(i,e){let s=1/0,o=null;for(let n=0;n<e.players.length;n++){const r=e.players[n];if(r.stellarForge&&!r.isDefeated()){const e=i.distanceTo(r.stellarForge.position);e<t&&e<s&&(s=e,o=n)}}return o}drawAsteroid(t){const i=t.getWorldVertices();if(0===i.length)return;const e=i.map(t=>this.worldToScreen(t));this.ctx.fillStyle="#666666",this.ctx.strokeStyle="#888888",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)this.ctx.lineTo(e[t].x,e[t].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}drawSunRays(t){for(const i of t.suns){const t=this.worldToScreen(i.position),e=2*Math.max(this.canvas.width,this.canvas.height),s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e);s.addColorStop(0,"rgba(255, 255, 220, 0.25)"),s.addColorStop(.15,"rgba(255, 255, 210, 0.15)"),s.addColorStop(.35,"rgba(255, 255, 200, 0.08)"),s.addColorStop(.6,"rgba(255, 255, 190, 0.03)"),s.addColorStop(1,"rgba(255, 255, 180, 0)"),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}for(const i of t.suns){this.ctx.save(),this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="rgba(0, 0, 20, 0.5)";let e=!1;this.ctx.beginPath();for(const s of t.asteroids){const t=s.getWorldVertices();for(let s=0;s<t.length;s++){const o=t[s],r=t[(s+1)%t.length],l=new x((o.x+r.x)/2,(o.y+r.y)/2),a=new x(i.position.x-l.x,i.position.y-l.y),h=new x(-(r.y-o.y),r.x-o.x);if(a.x*h.x+a.y*h.y<0){const t=new x(o.x-i.position.x,o.y-i.position.y).normalize(),s=new x(r.x-i.position.x,r.y-i.position.y).normalize(),l=new x(o.x+t.x*n,o.y+t.y*n),a=new x(r.x+s.x*n,r.y+s.y*n),h=this.worldToScreen(o),c=this.worldToScreen(r),d=this.worldToScreen(l),p=this.worldToScreen(a);this.ctx.moveTo(h.x,h.y),this.ctx.lineTo(c.x,c.y),this.ctx.lineTo(p.x,p.y),this.ctx.lineTo(d.x,d.y),this.ctx.closePath(),e=!0}}}e&&this.ctx.fill(),this.ctx.restore()}}drawInfluenceCircle(t,i,e){const s=this.worldToScreen(t),o=i*this.zoom;this.ctx.strokeStyle=e,this.ctx.lineWidth=2,this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,o,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1}drawWarpGate(t){const i=this.worldToScreen(t.position),e=50*this.zoom,s=t.chargeTime/6,o=Math.min(e,s*e);if(t.isComplete){this.ctx.fillStyle="rgba(0, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.stroke();const t=20*this.zoom,s=e+30*this.zoom,o=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(let e=0;e<4;e++){const n=o[e],r=i.x+Math.cos(n)*s,l=i.y+Math.sin(n)*s;this.ctx.fillStyle="#444444",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(r,l,t,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font=12*this.zoom+"px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(`B${e+1}`,r,l)}this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}else this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=3,this.ctx.globalAlpha=.5+.2*Math.sin(5*t.chargeTime),this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=5,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o+5,0,s*Math.PI*2),this.ctx.stroke()}drawUnit(t,i,e,s,o=1){const n=this.worldToScreen(t.position),l=8*this.zoom*o,a=this.selectedUnits.has(t);let h=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(h=!0,this.ctx.globalAlpha=r)}if(a&&t.isHero&&!s){const e=t.attackRange*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.globalAlpha=.2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,e,0,2*Math.PI),this.ctx.stroke(),this.ctx.globalAlpha=h?r:1}a&&(this.ctx.strokeStyle="#00FF00",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,l+4,0,2*Math.PI),this.ctx.stroke()),this.ctx.fillStyle=i,this.ctx.strokeStyle=a?"#00FF00":"#FFFFFF",this.ctx.lineWidth=a?2:1,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,l,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const c=3*l,d=n.x-c/2,x=n.y-l-8;this.ctx.fillStyle="#333",this.ctx.fillRect(d,x,c,3);const p=t.health/t.maxHealth;if(this.ctx.fillStyle=p>.5?"#00FF00":p>.25?"#FFFF00":"#FF0000",this.ctx.fillRect(d,x,c*p,3),t.target){const i=t.target.position.x-t.position.x,e=t.target.position.y-t.position.y,s=Math.atan2(e,i);this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(n.x+Math.cos(s)*l*1.5,n.y+Math.sin(s)*l*1.5),this.ctx.stroke()}t.moveOrder>0&&t.rallyPoint&&this.drawMoveOrderIndicator(t.position,t.rallyPoint,t.moveOrder,i),h&&(this.ctx.globalAlpha=1)}drawMoveOrderIndicator(t,i,e,s){const o=this.worldToScreen(t),n=this.worldToScreen(i);this.ctx.strokeStyle=s,this.ctx.lineWidth=1,this.ctx.globalAlpha=.5,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(n.x,n.y),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=1;const r=this.MOVE_ORDER_DOT_RADIUS;this.ctx.fillStyle=s,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,r,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e.toString(),n.x,n.y)}drawMuzzleFlash(t){const i=this.worldToScreen(t.position),e=5*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(t.angle),this.ctx.fillStyle=`rgba(255, 255, 100, ${s})`,this.ctx.beginPath(),this.ctx.ellipse(0,0,2*e,e,0,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}drawBulletCasing(t){const i=this.worldToScreen(t.position),e=3*this.zoom,s=5*this.zoom,o=1-t.lifetime/t.maxLifetime;this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(t.rotation),this.ctx.fillStyle=`rgba(255, 215, 0, ${o})`,this.ctx.fillRect(-e/2,-s/2,e,s),this.ctx.restore()}drawBouncingBullet(t){const i=this.worldToScreen(t.position),e=3*this.zoom,s=1-t.lifetime/t.maxLifetime;this.ctx.fillStyle=`rgba(255, 255, 0, ${s})`,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.fill()}drawAbilityBullet(t){const i=this.worldToScreen(t.position),e=4*this.zoom,s=t.lifetime/t.maxLifetime,o=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=`${o}`,this.ctx.globalAlpha=s,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawInfluenceZone(t){const i=this.worldToScreen(t.position),e=t.radius*this.zoom,s=Math.max(.1,1-t.lifetime/t.duration),o=this.getFactionColor(t.owner.faction);this.ctx.strokeStyle=o,this.ctx.globalAlpha=.6*s,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.stroke();const n=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,e);n.addColorStop(0,`${o}40`),n.addColorStop(1,`${o}10`),this.ctx.fillStyle=n,this.ctx.globalAlpha=.3*s,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.globalAlpha=1}drawInfluenceBallProjectile(t){const i=this.worldToScreen(t.position),e=12*this.zoom,s=this.getFactionColor(t.owner.faction),o=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,e);o.addColorStop(0,s),o.addColorStop(.5,`${s}AA`),o.addColorStop(1,`${s}00`),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,.3*e,0,2*Math.PI),this.ctx.fill()}drawDeployedTurret(t){const i=this.worldToScreen(t.position),e=15*this.zoom,s=this.getFactionColor(t.owner.faction);this.ctx.fillStyle=s,this.ctx.fillRect(i.x-.6*e,i.y-.4*e,1.2*e,.8*e),this.ctx.fillStyle=s,this.ctx.fillRect(i.x-.3*e,i.y-e,.6*e,e);const o=1.5*e,n=4*this.zoom,r=t.health/t.maxHealth;this.ctx.fillStyle="#333333",this.ctx.fillRect(i.x-o/2,i.y+e,o,n),this.ctx.fillStyle=r>.3?"#00FF00":"#FF0000",this.ctx.fillRect(i.x-o/2,i.y+e,o*r,n)}drawGrave(t,i,e,s){let o=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=r)}this.drawUnit(t,i,e,s);const n=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y-l),this.ctx.lineTo(n.x,n.y+l),this.ctx.moveTo(n.x-.7*l,n.y-.3*l),this.ctx.lineTo(n.x+.7*l,n.y-.3*l),this.ctx.stroke();for(const e of t.getProjectiles())this.drawGraveProjectile(e,i);o&&(this.ctx.globalAlpha=1)}drawStarling(t,i,e,s){let o=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=r)}this.drawUnit(t,i,e,s,.3);const n=this.worldToScreen(t.position),l=6*this.zoom*.3;this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(n.x-l,n.y),this.ctx.lineTo(n.x-.3*l,n.y-.5*l),this.ctx.lineTo(n.x,n.y),this.ctx.lineTo(n.x+.3*l,n.y-.5*l),this.ctx.lineTo(n.x+l,n.y),this.ctx.stroke(),o&&(this.ctx.globalAlpha=1)}drawRay(t,i,e,s){let o=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=r)}this.drawUnit(t,i,e,s);const n=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y-l),this.ctx.lineTo(n.x-.3*l,n.y),this.ctx.lineTo(n.x+.3*l,n.y),this.ctx.lineTo(n.x,n.y+l),this.ctx.stroke();const a=t.getBeamSegments();for(const t of a){const e=this.worldToScreen(t.startPos),s=this.worldToScreen(t.endPos),o=1-t.lifetime/t.maxLifetime;this.ctx.strokeStyle=i,this.ctx.globalAlpha=o,this.ctx.lineWidth=3*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}o&&(this.ctx.globalAlpha=1)}drawInfluenceBall(t,i,e,s){let o=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=r)}this.drawUnit(t,i,e,s);const n=this.worldToScreen(t.position),l=12*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,l,0,2*Math.PI),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(n.x,n.y,.6*l,0,2*Math.PI),this.ctx.stroke(),o&&(this.ctx.globalAlpha=1)}drawTurretDeployer(t,i,e,s){let o=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=r)}this.drawUnit(t,i,e,s);const n=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.fillStyle=i,this.ctx.fillRect(n.x-.5*l,n.y-.3*l,l,.6*l),this.ctx.fillRect(n.x-.2*l,n.y-l,.4*l,l),o&&(this.ctx.globalAlpha=1)}drawDriller(t,i,e,s){if(t.isHiddenInAsteroid())return;let o=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(o=!0,this.ctx.globalAlpha=r)}this.drawUnit(t,i,e,s);const n=this.worldToScreen(t.position),l=10*this.zoom;this.ctx.strokeStyle=i,this.ctx.lineWidth=2*this.zoom,this.ctx.beginPath(),this.ctx.moveTo(n.x-l,n.y),this.ctx.lineTo(n.x,n.y-.5*l),this.ctx.lineTo(n.x+l,n.y),this.ctx.lineTo(n.x,n.y+.5*l),this.ctx.closePath(),this.ctx.stroke(),o&&(this.ctx.globalAlpha=1)}drawMinigun(t,i,e,s){const o=this.worldToScreen(t.position),n=t.radius*this.zoom;let l=!1;if(s&&this.viewingPlayer){if(!e.isObjectVisibleToPlayer(t.position,this.viewingPlayer))return;e.isPointInShadow(t.position)&&(l=!0,this.ctx.globalAlpha=r)}if(!t.isComplete){this.ctx.fillStyle="rgba(0, 255, 255, 0.2)",this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const i=2*n,e=4,s=o.x-i/2,r=o.y+n+5;return this.ctx.fillStyle="#333333",this.ctx.fillRect(s,r,i,e),this.ctx.fillStyle="#00FF00",this.ctx.fillRect(s,r,i*t.buildProgress,e),void(l&&(this.ctx.globalAlpha=1))}this.ctx.fillStyle=i,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o.x,o.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke();const a=.6*n;this.ctx.fillStyle="#666666",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,a,0,2*Math.PI),this.ctx.fill();let h=0;if(t.target){const i=t.target.position.x-t.position.x,e=t.target.position.y-t.position.y;h=Math.atan2(e,i)}const c=1.2*n,d=4*this.zoom;this.ctx.strokeStyle="#333333",this.ctx.lineWidth=d,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(o.x+Math.cos(h)*c,o.y+Math.sin(h)*c),this.ctx.stroke();const x=2*n,p=o.x-x/2,u=o.y-n-10;this.ctx.fillStyle="#FF0000",this.ctx.fillRect(p,u,x,4);const g=t.health/t.maxHealth;this.ctx.fillStyle="#00FF00",this.ctx.fillRect(p,u,x*g,4),l&&(this.ctx.globalAlpha=1)}drawGraveProjectile(t,i){const e=this.worldToScreen(t.position),s=4*this.zoom;if(t.isAttacking&&t.trail.length>1){this.ctx.strokeStyle=i,this.ctx.lineWidth=2*this.zoom,this.ctx.globalAlpha=.5,this.ctx.beginPath();for(let i=0;i<t.trail.length;i++){const e=this.worldToScreen(t.trail[i]);0===i?this.ctx.moveTo(e.x,e.y):this.ctx.lineTo(e.x,e.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}this.ctx.fillStyle=i,this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1*this.zoom,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),t.isAttacking&&(this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,1.5*s,0,2*Math.PI),this.ctx.fill())}drawConnections(t,i,e){if(!t.stellarForge)return;if(this.viewingPlayer&&t!==this.viewingPlayer)return;const s=this.worldToScreen(t.stellarForge.position);for(const o of t.solarMirrors){const n=this.worldToScreen(o.position),r=o.hasLineOfSightToLight(i,e),l=o.getClosestVisibleSun(i,e),a=o.hasLineOfSightToForge(t.stellarForge,e);if(l){const t=this.worldToScreen(l.position);this.ctx.strokeStyle=r?"rgba(0, 255, 0, 0.4)":"rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke(),this.ctx.setLineDash([])}this.ctx.strokeStyle=a?"rgba(0, 150, 255, 0.4)":"rgba(255, 0, 0, 0.4)",this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.setLineDash([]),r&&a&&(this.ctx.fillStyle="rgba(255, 255, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(n.x,n.y,15*this.zoom,0,2*Math.PI),this.ctx.fill())}}drawUI(t){if(this.showInfo){const i=window.devicePixelRatio||1,e=this.canvas.width/i,s=this.canvas.height/i,o=e<600,n=o?13:16,r=n+4,l=Math.min(300,e-20),a=20+5*r+60*t.players.length;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,10,l,a),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${n}px Arial`;let h=30;this.ctx.fillText("SoL - Speed of Light RTS",20,h),h+=r,this.ctx.fillText(`Game Time: ${t.gameTime.toFixed(1)}s`,20,h),h+=r,this.ctx.fillText(`Dust Particles: ${t.spaceDust.length}`,20,h),h+=r,this.ctx.fillText(`Asteroids: ${t.asteroids.length}`,20,h),h+=r,this.ctx.fillText(`Warp Gates: ${t.warpGates.length}`,20,h);let c=h+r;for(const i of t.players){const t=this.getFactionColor(i.faction);if(this.ctx.fillStyle=t,this.ctx.fillText(`${i.name} (${i.faction})`,20,c),this.ctx.fillStyle="#FFFFFF",this.ctx.fillText(`Solarium: ${i.solarium.toFixed(1)}`,20,c+20),i.stellarForge){const t=i.stellarForge.isReceivingLight?" Light":" No Light";this.ctx.fillText(`${t} | HP: ${i.stellarForge.health.toFixed(0)}`,20,c+40)}c+=60}const d=o?G.CONTROL_LINES_COMPACT:G.CONTROL_LINES_FULL,x=o?12:14,p=x+4,u=Math.min(450,e-20),g=p*d.length+14,y=10,f=s-g-10;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(y,f,u,g),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`${x}px Arial`;let m=f+p;for(const t of d)this.ctx.fillText(t,20,m),m+=p}}drawSelectionRectangle(){if(!this.selectionStart||!this.selectionEnd)return;const t=Math.min(this.selectionStart.x,this.selectionEnd.x),i=Math.min(this.selectionStart.y,this.selectionEnd.y),e=Math.abs(this.selectionEnd.x-this.selectionStart.x),s=Math.abs(this.selectionEnd.y-this.selectionStart.y);this.ctx.strokeStyle="rgba(0, 255, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(t,i,e,s),this.ctx.fillStyle="rgba(0, 255, 0, 0.1)",this.ctx.fillRect(t,i,e,s),this.ctx.setLineDash([])}drawAbilityArrow(){if(!this.abilityArrowStart||!this.abilityArrowEnd)return;const t=this.abilityArrowEnd.x-this.abilityArrowStart.x,i=this.abilityArrowEnd.y-this.abilityArrowStart.y;if(Math.sqrt(t*t+i*i)<10)return;this.ctx.strokeStyle="rgba(255, 215, 0, 0.9)",this.ctx.lineWidth=4,this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(this.abilityArrowStart.x,this.abilityArrowStart.y),this.ctx.lineTo(this.abilityArrowEnd.x,this.abilityArrowEnd.y),this.ctx.stroke();const e=Math.atan2(i,t),s=Math.PI/6;this.ctx.fillStyle="rgba(255, 215, 0, 0.9)",this.ctx.beginPath(),this.ctx.moveTo(this.abilityArrowEnd.x,this.abilityArrowEnd.y),this.ctx.lineTo(this.abilityArrowEnd.x-20*Math.cos(e-s),this.abilityArrowEnd.y-20*Math.sin(e-s)),this.ctx.lineTo(this.abilityArrowEnd.x-20*Math.cos(e+s),this.abilityArrowEnd.y-20*Math.sin(e+s)),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 215, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(this.abilityArrowStart.x,this.abilityArrowStart.y,8,0,2*Math.PI),this.ctx.fill()}drawMinionPathPreview(t,i,e){this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=3,this.ctx.setLineDash([6,6]),this.ctx.beginPath();const s=this.worldToScreen(t);this.ctx.moveTo(s.x,s.y);for(let t=0;t<i.length;t++){const e=this.worldToScreen(i[t]);this.ctx.lineTo(e.x,e.y)}if(e){const t=this.worldToScreen(e);this.ctx.lineTo(t.x,t.y)}this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(255, 255, 0, 0.9)";for(let t=0;t<i.length;t++){const e=this.worldToScreen(i[t]);this.ctx.beginPath(),this.ctx.arc(e.x,e.y,4,0,2*Math.PI),this.ctx.fill()}if(e){const t=this.worldToScreen(e);this.ctx.strokeStyle="rgba(255, 255, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,6,0,2*Math.PI),this.ctx.stroke()}}createTapEffect(t,i){this.tapEffects.push({position:new x(t,i),progress:0})}createSwipeEffect(t,i,e,s){this.swipeEffects.push({start:new x(t,i),end:new x(e,s),progress:0})}updateAndDrawTapEffects(){for(let t=this.tapEffects.length-1;t>=0;t--){const i=this.tapEffects[t];if(i.progress+=.05,i.progress>=1){this.tapEffects.splice(t,1);continue}const e=40*i.progress,s=1-i.progress;this.ctx.strokeStyle=`rgba(100, 200, 255, ${s})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(i.position.x,i.position.y,e,0,2*Math.PI),this.ctx.stroke();const o=this.ctx.createRadialGradient(i.position.x,i.position.y,0,i.position.x,i.position.y,.5*e);o.addColorStop(0,`rgba(100, 200, 255, ${.5*s})`),o.addColorStop(1,"rgba(100, 200, 255, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(i.position.x,i.position.y,.5*e,0,2*Math.PI),this.ctx.fill()}}updateAndDrawSwipeEffects(){for(let t=this.swipeEffects.length-1;t>=0;t--){const i=this.swipeEffects[t];if(i.progress+=.08,i.progress>=1){this.swipeEffects.splice(t,1);continue}const e=i.end.x-i.start.x,s=i.end.y-i.start.y,o=Math.sqrt(e*e+s*s);if(o<5)continue;const n=1-i.progress,r=o*i.progress;this.ctx.strokeStyle=`rgba(255, 200, 100, ${.7*n})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(i.start.x,i.start.y);const l=i.start.x+e/o*r,a=i.start.y+s/o*r;if(this.ctx.lineTo(l,a),this.ctx.stroke(),i.progress>.3){const t=Math.atan2(s,e);this.ctx.fillStyle=`rgba(255, 200, 100, ${n})`,this.ctx.beginPath(),this.ctx.moveTo(l,a),this.ctx.lineTo(l-15*Math.cos(t-Math.PI/6),a-15*Math.sin(t-Math.PI/6)),this.ctx.lineTo(l-15*Math.cos(t+Math.PI/6),a-15*Math.sin(t+Math.PI/6)),this.ctx.closePath(),this.ctx.fill()}for(let t=0;t<5;t++){const l=t/5,a=i.start.x+e/o*r*l,h=i.start.y+s/o*r*l,c=n*(1-l)*.3,d=this.ctx.createRadialGradient(a,h,0,a,h,10);d.addColorStop(0,`rgba(255, 200, 100, ${c})`),d.addColorStop(1,"rgba(255, 200, 100, 0)"),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(a,h,10,0,2*Math.PI),this.ctx.fill()}}}render(o){this.ctx.fillStyle="#000011",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.starLayers){this.ctx.fillStyle="#FFFFFF";const i=window.devicePixelRatio||1;for(const e of t.stars){const o=this.camera.x*t.parallaxFactor,n=this.camera.y*t.parallaxFactor,r=this.canvas.width/i/2,l=this.canvas.height/i/2,a=r+(e.x-o),h=l+(e.y-n),c=(a+r)%(2*r+s)-r,d=(h+l)%(2*l+s)-l;c>=-100&&c<=this.canvas.width/i+100&&d>=-100&&d<=this.canvas.height/i+100&&(this.ctx.globalAlpha=e.brightness,this.ctx.fillRect(c,d,e.size,e.size))}this.ctx.globalAlpha=1}const n=this.viewingPlayer?o.players.indexOf(this.viewingPlayer):null;for(const t of o.spaceDust)this.isWithinRenderBounds(t.position,o.mapSize,10)&&this.drawSpaceDust(t,o,n);for(const t of o.suns)this.drawSun(t);this.drawSunRays(o);for(const t of o.suns)this.drawLensFlare(t);for(const t of o.asteroids)this.isWithinRenderBounds(t.position,o.mapSize,t.size)&&this.drawAsteroid(t);const r=[];for(let s=0;s<o.players.length;s++){const l=o.players[s];if((null===n||s===n)&&l.stellarForge&&!l.isDefeated()){const o=0===s?i:e;r.push({position:l.stellarForge.position,radius:t,color:o})}}const l=new Map;for(const t of r)l.has(t.color)||l.set(t.color,[]),l.get(t.color).push({position:t.position,radius:t.radius});for(const[t,i]of l)if(1===i.length)this.drawInfluenceCircle(i[0].position,i[0].radius,t);else{this.ctx.save(),this.ctx.beginPath();for(const t of i){const i=this.worldToScreen(t.position),e=t.radius*this.zoom;this.ctx.moveTo(i.x+e,i.y),this.ctx.arc(i.x,i.y,e,0,2*Math.PI)}this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle=t,this.ctx.globalAlpha=.05,this.ctx.fill(),this.ctx.globalAlpha=.3,this.ctx.strokeStyle=t,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}for(const t of o.players)t.isDefeated()||this.drawConnections(t,o.suns,o.asteroids);for(const t of o.players){if(t.isDefeated())continue;const i=this.getFactionColor(t.faction),e=null!==this.viewingPlayer&&t!==this.viewingPlayer;if(!e)for(const e of t.solarMirrors)this.drawSolarMirror(e,i,o);t.stellarForge&&this.drawStellarForge(t.stellarForge,i,o,e)}for(const t of o.warpGates)this.drawWarpGate(t);for(const t of o.players){if(t.isDefeated())continue;const i=this.getFactionColor(t.faction),e=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const s of t.units)s instanceof D?this.drawGrave(s,i,o,e):s instanceof I?this.drawStarling(s,i,o,e):s instanceof L?this.drawRay(s,i,o,e):s instanceof B?this.drawInfluenceBall(s,i,o,e):s instanceof W?this.drawTurretDeployer(s,i,o,e):s instanceof U?this.drawDriller(s,i,o,e):this.drawUnit(s,i,o,e)}for(const t of o.players){if(t.isDefeated())continue;const i=this.getFactionColor(t.faction),e=null!==this.viewingPlayer&&t!==this.viewingPlayer;for(const s of t.buildings)s instanceof m&&this.drawMinigun(s,i,o,e)}for(const t of o.muzzleFlashes)this.drawMuzzleFlash(t);for(const t of o.bulletCasings)this.drawBulletCasing(t);for(const t of o.bouncingBullets)this.drawBouncingBullet(t);for(const t of o.abilityBullets)this.drawAbilityBullet(t);for(const t of o.influenceZones)this.drawInfluenceZone(t);for(const t of o.influenceBallProjectiles)this.drawInfluenceBallProjectile(t);for(const t of o.deployedTurrets)this.drawDeployedTurret(t);this.drawBorderFade(o.mapSize),this.drawUI(o),this.drawSelectionRectangle(),this.drawAbilityArrow(),this.updateAndDrawTapEffects(),this.updateAndDrawSwipeEffects();const a=o.checkVictoryConditions();if(a&&this.drawEndGameStatsScreen(o,a),o.isCountdownActive){this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#FFD700",this.ctx.font="bold 120px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=Math.ceil(o.countdownTime),i=t>0?t.toString():"Go!";this.ctx.fillText(i,this.canvas.width/2,this.canvas.height/2),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}o.isCountdownActive||a||this.drawMenuButton(),this.showInGameMenu&&!a&&this.drawInGameMenuOverlay()}drawMenuButton(){window.devicePixelRatio;this.ctx.fillStyle="rgba(50, 50, 50, 0.8)",this.ctx.fillRect(10,10,50,50),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(10,10,50,50),this.ctx.fillStyle="#FFFFFF";this.ctx.fillRect(20,22.5,30,3),this.ctx.fillRect(20,33.5,30,3),this.ctx.fillRect(20,44.5,30,3)}drawInGameMenuOverlay(){const t=window.devicePixelRatio||1,i=this.canvas.width/t,e=this.canvas.height/t,s=i<600;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(0,0,i,e);const o=Math.min(400,i-40),n=Math.min(350,e-40),r=(i-o)/2,l=(e-n)/2;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(r,l,o,n),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(r,l,o,n),this.ctx.fillStyle="#FFD700",this.ctx.font=`bold ${s?24:32}px Arial`,this.ctx.textAlign="center",this.ctx.fillText("GAME MENU",i/2,l+50);const a=Math.min(300,o-40),h=s?44:50,c=(i-a)/2;let d=l+(s?80:100);const x=s?14:20,p=(t,e)=>{this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(c,e,a,h),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(c,e,a,h),this.ctx.fillStyle="#FFFFFF",this.ctx.font=(s?18:20)+"px Arial",this.ctx.fillText(t,i/2,e+.65*h)};p("Resume",d),d+=h+x,p(this.showInfo?"Hide Info":"Show Info",d),d+=h+x,p("Surrender",d),this.ctx.textAlign="left"}drawEndGameStatsScreen(t,i){const e=window.devicePixelRatio||1,s=this.canvas.width/e,o=this.canvas.height/e,n=s<700;this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.fillRect(0,0,s,o),this.ctx.fillStyle=this.getFactionColor(i.faction);const r=Math.max(28,Math.min(48,.12*s));this.ctx.font=`bold ${r}px Arial`,this.ctx.textAlign="center",this.ctx.fillText(`${i.name} WINS!`,s/2,80);const l=Math.min(700,s-40),a=Math.min(450,o-200),h=(s-l)/2;this.ctx.fillStyle="rgba(30, 30, 30, 0.95)",this.ctx.fillRect(h,130,l,a),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(h,130,l,a),this.ctx.fillStyle="#FFD700";const c=Math.max(18,Math.min(28,.07*s));this.ctx.font=`bold ${c}px Arial`,this.ctx.fillText("MATCH STATISTICS",s/2,180);const d=Math.max(14,Math.min(20,.045*s));this.ctx.font=`${d}px Arial`;let x=230;const p=Math.max(100,Math.min(200,.4*l)),u=t.players.length,g=l-48-p,y=Math.max(50,g/u),f=h+24,m=f+p;this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText("Statistic",f,x),this.ctx.textAlign="right";for(let i=0;i<t.players.length;i++){const e=t.players[i],s=this.getFactionColor(e.faction);this.ctx.fillStyle=s;const o=m+y*(i+1);this.ctx.fillText(e.name,o,x)}x+=n?32:40;const S=[{label:"Units Created",key:"unitsCreated"},{label:"Units Lost",key:"unitsLost"},{label:"Solarium Gathered",key:"solariumGathered"},{label:"Final Solarium",key:"solarium"}];for(const i of S){this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.fillText(i.label,f,x),this.ctx.textAlign="right";for(let e=0;e<t.players.length;e++){const s=t.players[e],o="solarium"===i.key?s[i.key].toFixed(1):s[i.key],n=m+y*(e+1);this.ctx.fillText(String(o),n,x)}x+=n?28:35}const w=Math.min(300,s-60),F=n?50:60,b=(s-w)/2,M=Math.min(130+a+30,o-F-20);this.ctx.fillStyle="rgba(80, 80, 80, 0.9)",this.ctx.fillRect(b,M,w,F),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=3,this.ctx.strokeRect(b,M,w,F),this.ctx.fillStyle="#FFFFFF",this.ctx.font=`bold ${n?20:24}px Arial`,this.ctx.textAlign="center",this.ctx.fillText("Continue",s/2,M+.65*F),this.ctx.textAlign="left"}drawBorderFade(t){const i=window.devicePixelRatio||1,e=this.canvas.width/i,s=this.canvas.height/i,o=150,n=t/2,r=this.worldToScreen(new x(-n,-n)),l=this.worldToScreen(new x(n,-n)),a=this.worldToScreen(new x(-n,n)),h=this.worldToScreen(new x(-n+o,0)),c=(this.worldToScreen(new x(n-o,0)),this.worldToScreen(new x(0,-n+o))),d=(this.worldToScreen(new x(0,n-o)),Math.abs(h.x-r.x)),p=Math.abs(c.y-r.y);if(this.ctx.save(),r.x<e){const t=this.ctx.createLinearGradient(r.x,0,r.x+d,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,r.x+d,s)}if(l.x>0){const t=this.ctx.createLinearGradient(l.x,0,l.x-d,0);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(l.x-d,0,e-(l.x-d),s)}if(r.y<s){const t=this.ctx.createLinearGradient(0,r.y,0,r.y+p);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,e,r.y+p)}if(a.y>0){const t=this.ctx.createLinearGradient(0,a.y,0,a.y-p);t.addColorStop(0,"rgba(0, 0, 0, 1)"),t.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,a.y-p,e,s-(a.y-p))}this.ctx.restore()}setZoom(t){this.zoom=Math.max(.5,Math.min(2,t))}setCameraPosition(t){this.camera=t}}G.CONTROL_LINES_FULL=["Controls: Drag to select units","Pan: WASD/Arrows or mouse edge or two-finger drag","Zoom: Scroll/Pinch (zooms toward cursor)","Hold still 6 seconds in influence to open warp gate"],G.CONTROL_LINES_COMPACT=["Controls: Drag to select units","Pan: WASD/Arrows or two-finger drag","Zoom: Scroll/Pinch toward cursor","Hold still 6s in influence to open warp gate"];const N="[EMPTY]",_=(t,i)=>({id:t,name:N,description:N,faction:i,maxHealth:0,attackDamage:0,attackSpeed:0,attackRange:0,attackIgnoresDefense:!1,defense:0,regen:0,abilityDescription:N});class V{constructor(){this.onStartCallback=null,this.currentScreen="main",this.carouselMenu=null,this.heroUnits=[_("radiant-1",d.RADIANT),_("radiant-2",d.RADIANT),_("radiant-3",d.RADIANT),_("radiant-4",d.RADIANT),_("radiant-5",d.RADIANT),_("radiant-6",d.RADIANT),_("radiant-7",d.RADIANT),_("radiant-8",d.RADIANT),_("radiant-9",d.RADIANT),_("radiant-10",d.RADIANT),_("radiant-11",d.RADIANT),_("radiant-12",d.RADIANT),{id:"radiant-13",name:"Marine",description:"Rapid-fire ranged specialist",faction:d.RADIANT,maxHealth:100,attackDamage:10,attackSpeed:5,attackRange:300,attackIgnoresDefense:!1,defense:10,regen:4,abilityDescription:"Bullet storm: fires a spread of shots toward a target direction"},_("aurum-1",d.AURUM),_("aurum-2",d.AURUM),_("aurum-3",d.AURUM),_("aurum-4",d.AURUM),_("aurum-5",d.AURUM),_("aurum-6",d.AURUM),_("aurum-7",d.AURUM),_("aurum-8",d.AURUM),_("aurum-9",d.AURUM),_("aurum-10",d.AURUM),_("aurum-11",d.AURUM),_("aurum-12",d.AURUM),{id:"aurum-13",name:"Grave",description:"Gravitic sentinel with orbiting projectiles",faction:d.AURUM,maxHealth:150,attackDamage:15,attackSpeed:2,attackRange:100,attackIgnoresDefense:!1,defense:18,regen:3,abilityDescription:"Orbits gravitic shards that launch at targets and return"},_("solari-1",d.SOLARI),_("solari-2",d.SOLARI),_("solari-3",d.SOLARI),_("solari-4",d.SOLARI),_("solari-5",d.SOLARI),_("solari-6",d.SOLARI),_("solari-7",d.SOLARI),_("solari-8",d.SOLARI),_("solari-9",d.SOLARI),_("solari-10",d.SOLARI),_("solari-11",d.SOLARI),_("solari-12",d.SOLARI)],this.availableMaps=[{id:"standard",name:"Standard Battle",description:"Classic 1v1 map with a single sun at the center. Balanced gameplay with moderate obstacles.",numSuns:1,numAsteroids:10,mapSize:2e3},{id:"twin-suns",name:"Twin Suns",description:"Two suns create complex lighting patterns. Control multiple light sources for economic dominance.",numSuns:2,numAsteroids:12,mapSize:2500},{id:"asteroid-field",name:"Asteroid Field",description:"Dense asteroid field creates tactical challenges. Careful mirror placement is crucial.",numSuns:1,numAsteroids:20,mapSize:2e3},{id:"open-space",name:"Open Space",description:"Minimal obstacles in a vast arena. Pure strategic combat with fewer terrain advantages.",numSuns:1,numAsteroids:5,mapSize:3e3}],this.settings={selectedMap:this.availableMaps[0],difficulty:"normal",soundEnabled:!0,musicEnabled:!0,isBattleStatsInfoEnabled:!1,selectedFaction:null,selectedHeroes:[]},this.menuElement=this.createMenuElement(),document.body.appendChild(this.menuElement)}createMenuElement(){const t=document.createElement("div");return t.id="mainMenu",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.padding="24px 16px",t.style.boxSizing="border-box",t.style.backgroundColor="rgba(0, 0, 10, 0.95)",t.style.display="flex",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",t.style.fontFamily="Arial, sans-serif",t.style.color="#FFFFFF",t.style.overflowY="auto",t.style.overflowX="hidden",this.renderMainScreenContent(t),t}clearMenu(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.menuElement&&(this.menuElement.innerHTML="")}renderMainScreen(t){this.clearMenu(),this.renderMainScreenContent(t)}renderMainScreenContent(t){const i=window.innerWidth<600,e=document.createElement("h1");e.textContent="SoL",e.style.fontSize=i?"48px":"72px",e.style.marginBottom="10px",e.style.color="#FFD700",e.style.textShadow="0 0 20px rgba(255, 215, 0, 0.5)",e.style.textAlign="center",e.style.maxWidth="100%",t.appendChild(e);const s=document.createElement("h2");s.textContent="Speed of Light RTS",s.style.fontSize=i?"18px":"24px",s.style.marginBottom="30px",s.style.color="#AAAAAA",s.style.textAlign="center",s.style.maxWidth="100%",t.appendChild(s);const o=document.createElement("p");o.textContent="Select a menu option below",o.style.fontSize=i?"14px":"16px",o.style.marginBottom="40px",o.style.maxWidth="500px",o.style.textAlign="center",o.style.lineHeight="1.5",t.appendChild(o);const n=document.createElement("div");n.style.width="100%",n.style.maxWidth=i?"100%":"900px",n.style.padding=i?"0 10px":"0",n.style.marginBottom="40px",t.appendChild(n),this.carouselMenu=new q(n,[{id:"loadout",name:"LOADOUT",description:"Select faction & heroes"},{id:"start",name:"START",description:"Begin game"},{id:"maps",name:"MAPS",description:"Select map"},{id:"settings",name:"SETTINGS",description:"Configure game"}]),this.carouselMenu.onSelect(t=>{switch(t.id){case"loadout":this.currentScreen="faction-select",this.renderFactionSelectionScreen(this.menuElement);break;case"start":this.hide(),this.onStartCallback&&this.onStartCallback(this.settings);break;case"maps":this.currentScreen="maps",this.renderMapSelectionScreen(this.menuElement);break;case"settings":this.currentScreen="settings",this.renderSettingsScreen(this.menuElement)}});const r=document.createElement("div");r.style.marginTop="20px",r.style.fontSize=i?"12px":"14px",r.style.color="#AAAAAA";let l="Not configured";this.settings.selectedFaction&&4===this.settings.selectedHeroes.length?l=`<span style="color: #00FF88;">${this.settings.selectedFaction} - 4 heroes</span>`:this.settings.selectedFaction&&(l=`<span style="color: #FFA500;">${this.settings.selectedFaction} - ${this.settings.selectedHeroes.length}/4 heroes</span>`),r.innerHTML=`\n            <div style="text-align: center;">\n                <div>Loadout: ${l}</div>\n                <div style="margin-top: 5px;">Map: <span style="color: #FFD700;">${this.settings.selectedMap.name}</span></div>\n            </div>\n        `,t.appendChild(r);const a=document.createElement("div");a.style.marginTop="40px",a.style.fontSize=i?"12px":"14px",a.style.color="#888888",a.innerHTML='\n            <div style="text-align: center;">\n                <div> Ray-traced lighting and shadows</div>\n                <div style="margin-top: 5px;"> Asteroid obstacles with dynamic polygons</div>\n                <div style="margin-top: 5px;"> Solar mirrors with line-of-sight visualization</div>\n                <div style="margin-top: 5px;"> Touch and mouse controls</div>\n            </div>\n        ',t.appendChild(a)}renderMapSelectionScreen(t){this.clearMenu();const i=window.innerWidth<600,e=document.createElement("h2");e.textContent="Select Map",e.style.fontSize=i?"32px":"48px",e.style.marginBottom=i?"20px":"30px",e.style.color="#FFD700",e.style.textAlign="center",e.style.maxWidth="100%",t.appendChild(e);const s=document.createElement("div");s.style.display="grid",s.style.gridTemplateColumns=`repeat(auto-fit, minmax(${i?220:300}px, 1fr))`,s.style.gap="20px",s.style.maxWidth="900px",s.style.padding="20px",s.style.marginBottom="30px";for(const t of this.availableMaps){const i=document.createElement("div");i.style.backgroundColor="rgba(255, 255, 255, 0.05)",i.style.border=t.id===this.settings.selectedMap.id?"3px solid #FFD700":"2px solid rgba(255, 255, 255, 0.2)",i.style.borderRadius="10px",i.style.padding="20px",i.style.cursor="pointer",i.style.transition="all 0.3s",i.addEventListener("mouseenter",()=>{t.id!==this.settings.selectedMap.id&&(i.style.backgroundColor="rgba(255, 255, 255, 0.1)",i.style.transform="scale(1.02)")}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor="rgba(255, 255, 255, 0.05)",i.style.transform="scale(1)"}),i.addEventListener("click",()=>{this.settings.selectedMap=t,this.renderMapSelectionScreen(this.menuElement)});const e=document.createElement("h3");e.textContent=t.name,e.style.fontSize="24px",e.style.marginBottom="10px",e.style.color=t.id===this.settings.selectedMap.id?"#FFD700":"#FFFFFF",i.appendChild(e);const o=document.createElement("p");o.textContent=t.description,o.style.fontSize="14px",o.style.lineHeight="1.5",o.style.marginBottom="15px",o.style.color="#CCCCCC",i.appendChild(o);const n=document.createElement("div");n.style.fontSize="12px",n.style.color="#888888",n.innerHTML=`\n                <div> Suns: ${t.numSuns}</div>\n                <div> Asteroids: ${t.numAsteroids}</div>\n                <div> Size: ${t.mapSize}px</div>\n            `,i.appendChild(n),s.appendChild(i)}t.appendChild(s);const o=this.createButton("BACK",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#666666");t.appendChild(o)}renderSettingsScreen(t){this.clearMenu();const i=window.innerWidth<600,e=document.createElement("h2");e.textContent="Settings",e.style.fontSize=i?"32px":"48px",e.style.marginBottom=i?"20px":"30px",e.style.color="#FFD700",e.style.textAlign="center",e.style.maxWidth="100%",t.appendChild(e);const s=document.createElement("div");s.style.maxWidth="500px",s.style.width="100%",s.style.padding="20px";const o=this.createSettingSection("Difficulty",this.createSelect(["easy","normal","hard"],this.settings.difficulty,t=>{this.settings.difficulty=t}));s.appendChild(o);const n=this.createSettingSection("Sound Effects",this.createToggle(this.settings.soundEnabled,t=>{this.settings.soundEnabled=t}));s.appendChild(n);const r=this.createSettingSection("Music",this.createToggle(this.settings.musicEnabled,t=>{this.settings.musicEnabled=t}));s.appendChild(r);const l=this.createSettingSection("Battle Stats Info",this.createToggle(this.settings.isBattleStatsInfoEnabled,t=>{this.settings.isBattleStatsInfoEnabled=t}));s.appendChild(l),t.appendChild(s);const a=this.createButton("BACK",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#666666");a.style.marginTop="30px",t.appendChild(a)}renderFactionSelectionScreen(t){this.clearMenu();const i=window.innerWidth<600,e=document.createElement("h2");e.textContent="Select Your Faction",e.style.fontSize=i?"32px":"48px",e.style.marginBottom=i?"20px":"30px",e.style.color="#FFD700",e.style.textAlign="center",e.style.maxWidth="100%",t.appendChild(e);const s=document.createElement("div");s.style.display="grid",s.style.gridTemplateColumns=`repeat(auto-fit, minmax(${i?220:280}px, 1fr))`,s.style.gap="20px",s.style.maxWidth="900px",s.style.padding="20px",s.style.marginBottom="30px";const o=[{id:d.RADIANT,name:"Radiant",description:"Masters of light manipulation. Enhanced mirror efficiency and faster light-based attacks.",color:"#00AAFF"},{id:d.AURUM,name:"Aurum",description:"Wealth-oriented civilization. Economic bonuses and resource multiplication.",color:"#FFD700"},{id:d.SOLARI,name:"Solari",description:"Sun-worshipping empire. Stronger structures and enhanced solar collection.",color:"#FF6600"}];for(const t of o){const i=document.createElement("div");i.style.backgroundColor="rgba(255, 255, 255, 0.05)",i.style.border=this.settings.selectedFaction===t.id?`3px solid ${t.color}`:"2px solid rgba(255, 255, 255, 0.2)",i.style.borderRadius="10px",i.style.padding="20px",i.style.cursor="pointer",i.style.transition="all 0.3s",i.style.minHeight="200px",i.addEventListener("mouseenter",()=>{this.settings.selectedFaction!==t.id&&(i.style.backgroundColor="rgba(255, 255, 255, 0.1)",i.style.transform="scale(1.02)")}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor="rgba(255, 255, 255, 0.05)",i.style.transform="scale(1)"}),i.addEventListener("click",()=>{this.settings.selectedFaction=t.id,this.settings.selectedHeroes=[],this.renderFactionSelectionScreen(this.menuElement)});const e=document.createElement("h3");e.textContent=t.name,e.style.fontSize="28px",e.style.marginBottom="15px",e.style.color=this.settings.selectedFaction===t.id?t.color:"#FFFFFF",i.appendChild(e);const o=document.createElement("p");o.textContent=t.description,o.style.fontSize="14px",o.style.lineHeight="1.5",o.style.color="#CCCCCC",i.appendChild(o),s.appendChild(i)}t.appendChild(s);const n=document.createElement("div");if(n.style.display="flex",n.style.gap="20px",n.style.marginTop="20px",n.style.flexWrap="wrap",n.style.justifyContent="center",i&&(n.style.flexDirection="column",n.style.alignItems="center"),this.settings.selectedFaction){const t=this.createButton("SELECT HEROES",()=>{this.currentScreen="loadout-select",this.renderLoadoutSelectionScreen(this.menuElement)},"#00FF88");n.appendChild(t)}const r=this.createButton("BACK",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#666666");n.appendChild(r),t.appendChild(n)}renderLoadoutSelectionScreen(t){this.clearMenu();const i=window.innerWidth<600;if(!this.settings.selectedFaction)return void this.renderFactionSelectionScreen(t);const e=document.createElement("h2");e.textContent=`Select 4 Heroes - ${this.settings.selectedFaction}`,e.style.fontSize=i?"28px":"42px",e.style.marginBottom=i?"15px":"20px",e.style.color="#FFD700",e.style.textAlign="center",e.style.maxWidth="100%",t.appendChild(e);const s=document.createElement("div");s.textContent=`Selected: ${this.settings.selectedHeroes.length} / 4`,s.style.fontSize=i?"16px":"18px",s.style.marginBottom=i?"20px":"30px",s.style.color=4===this.settings.selectedHeroes.length?"#00FF88":"#CCCCCC",t.appendChild(s);const o=document.createElement("div");o.style.display="grid",o.style.gridTemplateColumns=`repeat(auto-fit, minmax(${i?220:280}px, 1fr))`,o.style.gap="15px",o.style.maxWidth="1200px",o.style.padding="20px",o.style.marginBottom="20px",o.style.maxHeight=i?"none":"600px",o.style.overflowY=i?"visible":"auto";const n=this.heroUnits.filter(t=>t.faction===this.settings.selectedFaction);for(const t of n){const i=this.settings.selectedHeroes.includes(t.id),e=i||this.settings.selectedHeroes.length<4,s=document.createElement("div");s.style.backgroundColor=i?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.border=i?"3px solid #00FF88":"2px solid rgba(255, 255, 255, 0.2)",s.style.borderRadius="10px",s.style.padding="15px",s.style.cursor=e?"pointer":"not-allowed",s.style.transition="all 0.3s",s.style.opacity=e?"1":"0.5",s.style.minHeight="300px",e&&(s.addEventListener("mouseenter",()=>{i||(s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.transform="scale(1.02)")}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor=i?"rgba(0, 255, 136, 0.1)":"rgba(255, 255, 255, 0.05)",s.style.transform="scale(1)"}),s.addEventListener("click",()=>{i?this.settings.selectedHeroes=this.settings.selectedHeroes.filter(i=>i!==t.id):this.settings.selectedHeroes.length<4&&this.settings.selectedHeroes.push(t.id),this.renderLoadoutSelectionScreen(this.menuElement)}));const n=document.createElement("h4");n.textContent=t.name,n.style.fontSize="18px",n.style.marginBottom="8px",n.style.color=i?"#00FF88":"#FFFFFF",s.appendChild(n);const r=document.createElement("p");r.textContent=t.description,r.style.fontSize="12px",r.style.lineHeight="1.4",r.style.color="#AAAAAA",r.style.marginBottom="10px",s.appendChild(r);const l=document.createElement("div");l.style.fontSize="11px",l.style.lineHeight="1.6",l.style.color="#CCCCCC",l.style.marginBottom="8px",l.style.padding="8px",l.style.backgroundColor="rgba(0, 0, 0, 0.3)",l.style.borderRadius="5px";const a=document.createElement("div");a.textContent=` Health: ${t.maxHealth}`,l.appendChild(a);const h=document.createElement("div");h.textContent=` Regen: ${t.regen}%`,l.appendChild(h);const c=document.createElement("div");c.textContent=` Defense: ${t.defense}%`,l.appendChild(c);const d=document.createElement("div"),x=t.attackIgnoresDefense?"":"",p=t.attackIgnoresDefense?" (ignores defense)":"";d.textContent=`${x} Attack: ${t.attackDamage}${p}`,l.appendChild(d);const u=document.createElement("div");u.textContent=` Speed: ${t.attackSpeed}/s`,l.appendChild(u);const g=document.createElement("div");g.textContent=` Range: ${t.attackRange}`,l.appendChild(g),s.appendChild(l);const y=document.createElement("div");if(y.style.fontSize="11px",y.style.lineHeight="1.4",y.style.color="#FFD700",y.style.marginBottom="8px",y.style.fontStyle="italic",y.textContent=` ${t.abilityDescription}`,s.appendChild(y),i){const t=document.createElement("div");t.textContent=" Selected",t.style.fontSize="12px",t.style.marginTop="8px",t.style.color="#00FF88",t.style.fontWeight="bold",s.appendChild(t)}o.appendChild(s)}t.appendChild(o);const r=document.createElement("div");if(r.style.display="flex",r.style.gap="20px",r.style.marginTop="20px",r.style.flexWrap="wrap",r.style.justifyContent="center",i&&(r.style.flexDirection="column",r.style.alignItems="center"),4===this.settings.selectedHeroes.length){const t=this.createButton("CONFIRM LOADOUT",()=>{this.currentScreen="main",this.renderMainScreen(this.menuElement)},"#00FF88");r.appendChild(t)}const l=this.createButton("BACK",()=>{this.currentScreen="faction-select",this.renderFactionSelectionScreen(this.menuElement)},"#666666");r.appendChild(l),t.appendChild(r)}createButton(t,i,e="#FFD700"){const s=document.createElement("button");return s.textContent=t,s.style.fontSize="24px",s.style.padding="15px 40px",s.style.backgroundColor=e,s.style.color="#666666"===e?"#FFFFFF":"#000000",s.style.border="none",s.style.borderRadius="5px",s.style.cursor="pointer",s.style.fontWeight="bold",s.style.transition="all 0.3s",s.addEventListener("mouseenter",()=>{const t="#FFD700"===e?"#FFA500":"#00AAFF"===e?"#0088DD":"#00FF88"===e?"#00DD66":"#888888";s.style.backgroundColor=t,s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor=e,s.style.transform="scale(1)"}),s.addEventListener("click",i),s}createSettingSection(t,i){const e=document.createElement("div");e.style.marginBottom="30px",e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center";const s=document.createElement("label");return s.textContent=t,s.style.fontSize="18px",s.style.color="#FFFFFF",e.appendChild(s),e.appendChild(i),e}createSelect(t,i,e){const s=document.createElement("select");s.style.fontSize="16px",s.style.padding="8px 15px",s.style.backgroundColor="rgba(255, 255, 255, 0.1)",s.style.color="#FFFFFF",s.style.border="2px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="5px",s.style.cursor="pointer";for(const e of t){const t=document.createElement("option");t.value=e,t.textContent=e.charAt(0).toUpperCase()+e.slice(1),t.selected=e===i,t.style.backgroundColor="#000011",s.appendChild(t)}return s.addEventListener("change",()=>{e(s.value)}),s}createToggle(t,i){const e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.gap="10px";const s=document.createElement("div");s.style.width="60px",s.style.height="30px",s.style.backgroundColor=t?"#00FF88":"#666666",s.style.borderRadius="15px",s.style.position="relative",s.style.cursor="pointer",s.style.transition="all 0.3s";const o=document.createElement("div");return o.style.width="26px",o.style.height="26px",o.style.backgroundColor="#FFFFFF",o.style.borderRadius="50%",o.style.position="absolute",o.style.top="2px",o.style.left=t?"32px":"2px",o.style.transition="all 0.3s",s.appendChild(o),s.addEventListener("click",()=>{const e=!t;t=e,s.style.backgroundColor=e?"#00FF88":"#666666",o.style.left=e?"32px":"2px",i(e)}),e.appendChild(s),e}onStart(t){this.onStartCallback=t}hide(){this.menuElement.style.display="none"}show(){this.menuElement.style.display="flex",this.currentScreen="main",this.renderMainScreen(this.menuElement)}destroy(){this.carouselMenu&&(this.carouselMenu.destroy(),this.carouselMenu=null),this.menuElement.parentNode&&this.menuElement.parentNode.removeChild(this.menuElement)}getSettings(){return this.settings}}class q{constructor(t,i){this.currentIndex=0,this.targetIndex=0,this.scrollOffset=0,this.isDragging=!1,this.dragStartX=0,this.dragStartOffset=0,this.velocity=0,this.onSelectCallback=null,this.animationFrameId=null,this.hasDragged=!1,this.container=t,this.options=i,this.setupContainer(),this.setupEventHandlers(),this.startAnimation()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="400px",this.container.style.overflow="hidden",this.container.style.cursor="grab",this.container.style.userSelect="none",this.container.style.touchAction="pan-y"}setupEventHandlers(){this.container.addEventListener("mousedown",t=>{this.startDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mousemove",t=>{this.isDragging&&(this.updateDrag(t.clientX),t.preventDefault())}),this.container.addEventListener("mouseup",t=>{this.endDrag(t.clientX),t.preventDefault()}),this.container.addEventListener("mouseleave",()=>{this.isDragging&&this.endDrag(this.dragStartX)}),this.container.addEventListener("touchstart",t=>{1===t.touches.length&&(this.startDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchmove",t=>{this.isDragging&&1===t.touches.length&&(this.updateDrag(t.touches[0].clientX),t.preventDefault())},{passive:!1}),this.container.addEventListener("touchend",t=>{if(this.isDragging){const i=t.changedTouches[0];this.endDrag(i.clientX),t.preventDefault()}},{passive:!1})}startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartOffset=this.scrollOffset,this.velocity=0,this.hasDragged=!1,this.container.style.cursor="grabbing"}updateDrag(t){if(!this.isDragging)return;const i=t-this.dragStartX;this.scrollOffset=this.dragStartOffset+i,this.velocity=i*q.VELOCITY_MULTIPLIER,Math.abs(i)>5&&(this.hasDragged=!0)}endDrag(t){if(!this.isDragging)return;if(this.isDragging=!1,this.container.style.cursor="grab",!this.hasDragged)return void this.handleClick(t);const i=-this.scrollOffset/q.ITEM_WIDTH;let e=Math.round(i+this.velocity*q.VELOCITY_FACTOR);e=Math.max(0,Math.min(this.options.length-1,e)),this.targetIndex=e,this.currentIndex=e}handleClick(t){const i=this.container.getBoundingClientRect(),e=i.width/2,s=t-i.left-e,o=this.currentIndex+Math.round(s/q.ITEM_WIDTH),n=Math.max(0,Math.min(this.options.length-1,o));n===this.currentIndex?this.onSelectCallback&&this.onSelectCallback(this.options[this.currentIndex]):(this.targetIndex=n,this.currentIndex=n)}startAnimation(){const t=()=>{this.update(),this.render(),this.animationFrameId=requestAnimationFrame(t)};t()}update(){const t=-this.currentIndex*q.ITEM_WIDTH-this.scrollOffset;this.scrollOffset+=t*q.SMOOTH_INTERPOLATION_FACTOR,!this.isDragging&&Math.abs(this.velocity)>.1?(this.velocity*=q.VELOCITY_DECAY_FACTOR,this.scrollOffset+=this.velocity):this.velocity=0}render(){this.container.innerHTML="";const t=this.container.getBoundingClientRect(),i=t.width/2,e=t.height/2;for(let t=0;t<this.options.length;t++){const s=this.options[t],o=t-this.currentIndex,n=Math.abs(o),r=i+this.scrollOffset+t*q.ITEM_WIDTH;let l=1,a=1;0===n?(l=1,a=1):1===n?(l=.75,a=.75):2===n?(l=.5,a=.5):(l=Math.max(.25,1-.25*n),a=Math.max(.25,1-.25*n));const h=q.BASE_SIZE*l,c=document.createElement("div");c.style.position="absolute",c.style.left=r-h/2+"px",c.style.top=e-h/2+"px",c.style.width=`${h}px`,c.style.height=`${h}px`,c.style.backgroundColor=0===n?"#FFD700":"#00AAFF",c.style.border="3px solid rgba(255, 255, 255, 0.5)",c.style.borderRadius="10px",c.style.opacity=a.toString(),c.style.transition="background-color 0.2s",c.style.display="flex",c.style.flexDirection="column",c.style.justifyContent="center",c.style.alignItems="center",c.style.pointerEvents="none",c.style.color="#000000",c.style.fontWeight="bold",c.style.textAlign="center",c.style.padding="10px",c.style.boxSizing="border-box";const d=document.createElement("div");if(d.textContent=s.name,d.style.fontSize=`${Math.max(12,16*l)}px`,d.style.marginBottom="5px",c.appendChild(d),0===n){const t=document.createElement("div");t.textContent=s.description,t.style.fontSize=`${Math.max(8,10*l)}px`,t.style.color="#333333",t.style.overflow="hidden",t.style.textOverflow="ellipsis",c.appendChild(t)}this.container.appendChild(c)}const s=document.createElement("div");s.textContent="Drag to browse  Click center to select",s.style.position="absolute",s.style.bottom="20px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.color="#AAAAAA",s.style.fontSize="14px",s.style.pointerEvents="none",this.container.appendChild(s)}onSelect(t){this.onSelectCallback=t}destroy(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}q.ITEM_WIDTH=200,q.BASE_SIZE=120,q.VELOCITY_MULTIPLIER=.1,q.VELOCITY_FACTOR=.001,q.SMOOTH_INTERPOLATION_FACTOR=.15,q.VELOCITY_DECAY_FACTOR=.9;class j{hasOnlyHeroUnitsSelected(){return this.selectedUnits.size>0&&Array.from(this.selectedUnits).every(t=>t.isHero)}clearPathPreview(){this.pathPoints=[],this.isDrawingPath=!1,this.renderer.pathPreviewForge=null,this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=null}toggleInGameMenu(){this.showInGameMenu=!this.showInGameMenu,this.isPaused=this.showInGameMenu,this.renderer.showInGameMenu=this.showInGameMenu,this.renderer.isPaused=this.isPaused}toggleInfo(){this.showInfo=!this.showInfo,this.renderer.showInfo=this.showInfo}surrender(){if(!this.game)return;const t=this.game.players[0];t.stellarForge&&(t.stellarForge.health=0),this.showInGameMenu=!1,this.isPaused=!1,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,console.log("Player surrendered")}returnToMainMenu(){this.stop(),this.game=null,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInGameMenu=!1,this.renderer.isPaused=!1,this.renderer.showInfo=this.showInfo,this.menu.show()}constructor(){this.game=null,this.lastTime=0,this.isRunning=!1,this.isPaused=!1,this.showInGameMenu=!1,this.showInfo=!1,this.holdStartTime=null,this.holdPosition=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1,this.selectedUnits=new Set,this.selectedMirrors=new Set,this.selectedBase=null,this.isSelecting=!1,this.selectionStartScreen=null,this.isDraggingHeroArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.moveOrderCounter=0;const t=document.getElementById("gameCanvas");if(!t)throw new Error("Canvas element not found");this.renderer=new G(t),this.menu=new V,this.menu.onStart(t=>this.startNewGame(t)),this.showInfo=this.menu.getSettings().isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.setupInputHandlers(t)}startNewGame(t){if(this.game=this.createGameFromSettings(t),this.game.players.length>0){this.renderer.viewingPlayer=this.game.players[0];const t=this.game.players[0];t.stellarForge&&(this.renderer.setCameraPosition(t.stellarForge.position),this.renderer.setZoom(.5))}this.showInfo=t.isBattleStatsInfoEnabled,this.renderer.showInfo=this.showInfo,this.start()}createGameFromSettings(t){const i=function(t){const i=new $;i.suns.push(new S(new x(0,0),1,100));const e=new x(-700,700),s=new x(700,-700),o=Math.random()<.5?[e,s]:[s,e];for(let e=0;e<t.length&&!(e>=o.length);e++){const[s,n]=t[e],r=new w(s,n),l=o[e],h=a,c=[new x(l.x-h,l.y),new x(l.x+h,l.y)];i.initializePlayer(r,l,c),i.players.push(r)}if(i.players.length>=2)for(let t=0;t<i.players.length;t++){const e=i.players[t],s=(t+1)%i.players.length,o=i.players[s];e.stellarForge&&o.stellarForge&&e.stellarForge.initializeDefaultPath(o.stellarForge.position)}i.initializeSpaceDust(1e3,2e3,2e3),i.initializeAsteroids(10,2e3,2e3);const n=-Math.PI/4,r=new x(Math.cos(n)*l,Math.sin(n)*l);i.asteroids.push(new u(r,6,120));const h=3*Math.PI/4,c=new x(Math.cos(h)*l,Math.sin(h)*l);return i.asteroids.push(new u(c,6,120)),i.isRunning=!0,i}([["Player 1",d.RADIANT],["Player 2",d.AURUM]]),e=t.selectedMap;i.mapSize=e.mapSize,i.suns=[],"twin-suns"===e.id?(i.suns.push(new S(new x(-300,-300),1,100)),i.suns.push(new S(new x(300,300),1,100))):i.suns.push(new S(new x(0,0),1,100));const s=i.asteroids.slice(-2);return i.asteroids=[],i.initializeAsteroids(e.numAsteroids,e.mapSize,e.mapSize),"standard"===e.id&&i.asteroids.push(...s),i.spaceDust=[],i.initializeSpaceDust(1e3,e.mapSize,e.mapSize),i}setupInputHandlers(t){let i=!1,e=!1,s=0,o=0,n=0,r=0,l=0;const a=20,h=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window,c=new Set;t.addEventListener("wheel",t=>{t.preventDefault();const i=this.renderer.screenToWorld(t.clientX,t.clientY),e=t.deltaY>0?.9:1.1,s=this.renderer.zoom;this.renderer.setZoom(s*e);const o=this.renderer.screenToWorld(t.clientX,t.clientY),n=this.renderer.camera;this.renderer.setCameraPosition(new x(n.x+(i.x-o.x),n.y+(i.y-o.y)))});const d=(t,i)=>{s=t,o=i,this.selectionStartScreen=new x(t,i),this.isSelecting=!1;const e=this.renderer.screenToWorld(t,i);this.startHold(e)},p=(t,n,r=!1)=>{if(!e)return s=t,void(o=n);const l=t-s,a=n-o,h=Math.sqrt(l*l+a*a);if(r){i||(i=!0,this.cancelHold(),this.renderer.selectionStart=null,this.renderer.selectionEnd=null);const t=this.renderer.camera;this.renderer.setCameraPosition(new x(t.x-l/this.renderer.zoom,t.y-a/this.renderer.zoom))}else if(h>5){const e=this.hasOnlyHeroUnitsSelected();if(this.isSelecting||i||this.isDraggingHeroArrow||this.isDrawingPath||(this.selectedBase&&this.selectedBase.isSelected?(this.isDrawingPath=!0,this.pathPoints=[],this.renderer.pathPreviewForge=this.selectedBase,this.renderer.pathPreviewPoints=this.pathPoints,this.cancelHold()):e?(this.isDraggingHeroArrow=!0,this.cancelHold()):(this.isSelecting=!0,this.cancelHold())),this.isSelecting)this.renderer.selectionStart=this.selectionStartScreen,this.renderer.selectionEnd=new x(t,n);else if(this.isDraggingHeroArrow)this.renderer.abilityArrowStart=this.selectionStartScreen,this.renderer.abilityArrowEnd=new x(t,n);else if(this.isDrawingPath){const i=this.renderer.screenToWorld(t,n);(0===this.pathPoints.length||this.pathPoints[this.pathPoints.length-1].distanceTo(i)>50)&&this.pathPoints.push(new x(i.x,i.y)),this.renderer.pathPreviewForge=this.selectedBase,this.renderer.pathPreviewPoints=this.pathPoints,this.renderer.pathPreviewEnd=new x(i.x,i.y)}}s=t,o=n},u=()=>{const t=this.selectionStartScreen&&Math.abs(s-this.selectionStartScreen.x)<5&&Math.abs(o-this.selectionStartScreen.y)<5;if(t&&this.game){const t=this.game.checkVictoryConditions();if(!t&&!this.game.isCountdownActive&&s<=70&&o<=70)return this.toggleInGameMenu(),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(this.showInGameMenu&&!t){const t=window.devicePixelRatio||1,n=300,r=50,l=(this.renderer.canvas.width/t-n)/2;let a=(this.renderer.canvas.height/t-350)/2+100;const h=20;if(s>=l&&s<=l+n&&o>=a&&o<=a+r)return this.toggleInGameMenu(),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(a+=r+h,s>=l&&s<=l+n&&o>=a&&o<=a+r)return this.toggleInfo(),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();if(a+=r+h,s>=l&&s<=l+n&&o>=a&&o<=a+r)return this.surrender(),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(t){const t=window.devicePixelRatio||1,n=this.renderer.canvas.width/t,r=(this.renderer.canvas.height,300),l=(n-r)/2,a=610;if(s>=l&&s<=l+r&&o>=a&&o<=a+60)return this.returnToMainMenu(),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}if(t&&this.selectionStartScreen&&this.renderer.createTapEffect(s,o),this.game&&t){const t=this.renderer.screenToWorld(s,o),n=this.game.players[0];if(n.stellarForge&&n.stellarForge.containsPoint(t)){if(n.stellarForge.isSelected)n.stellarForge.isSelected=!1,this.selectedBase=null,this.clearPathPreview(),console.log("Stellar Forge deselected");else{n.stellarForge.isSelected=!0,this.selectedBase=n.stellarForge,this.selectedUnits.clear(),this.selectedMirrors.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of n.solarMirrors)t.isSelected=!1;this.clearPathPreview(),console.log("Stellar Forge selected")}return i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}let r=null;for(const i of n.solarMirrors)if(i.containsPoint(t)){r=i;break}if(r){if(r.isSelected)r.isSelected=!1,this.selectedMirrors.delete(r),this.clearPathPreview(),console.log("Solar Mirror deselected");else{r.isSelected=!0,this.selectedMirrors.clear(),this.selectedMirrors.add(r),n.stellarForge&&(n.stellarForge.isSelected=!1),this.selectedBase=null,this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits;for(const t of n.solarMirrors)t!==r&&(t.isSelected=!1);this.clearPathPreview(),console.log("Solar Mirror selected")}return i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}for(const s of this.game.warpGates){if(!s.isComplete)continue;if(s.owner!==n)continue;const o=20,r=80,l=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(let a=0;a<4;a++){const h=l[a],c=new x(s.position.x+Math.cos(h)*r,s.position.y+Math.sin(h)*r);if(t.distanceTo(c)<=o){if(0===a)if(n.spendSolarium(150)){const t=new m(new x(s.position.x,s.position.y),n);n.buildings.push(t),console.log(`Minigun building queued at warp gate (${s.position.x.toFixed(0)}, ${s.position.y.toFixed(0)})`);const i=this.game.warpGates.indexOf(s);i>-1&&this.game.warpGates.splice(i,1)}else console.log("Not enough solarium to build Minigun");return i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}}}if(n.stellarForge&&n.stellarForge.isSelected)return n.stellarForge.setTarget(t),n.stellarForge.isSelected=!1,console.log(`Stellar Forge moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold();const l=n.solarMirrors.find(t=>t.isSelected);if(l)return l.setTarget(t),l.isSelected=!1,console.log(`Solar Mirror moving to (${t.x.toFixed(0)}, ${t.y.toFixed(0)})`),i=!1,e=!1,this.isSelecting=!1,this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,void this.endHold()}if(this.isSelecting&&this.selectionStartScreen&&this.game){const t=new x(s,o);this.selectUnitsInRectangle(this.selectionStartScreen,t)}else if(this.isDrawingPath&&this.pathPoints.length>0&&this.selectedBase&&this.game)this.pathPoints.length>0&&(this.selectedBase.setMinionPath(this.pathPoints),console.log(`Path set with ${this.pathPoints.length} waypoints`)),this.clearPathPreview();else if(!this.isSelecting&&(this.selectedUnits.size>0||this.selectedMirrors.size>0||this.selectedBase)&&this.selectionStartScreen&&this.game){const t=new x(s,o),i=this.selectionStartScreen.distanceTo(t),e=Math.max(5,10),n=this.hasOnlyHeroUnitsSelected();if(this.selectedUnits.size>0&&(!n&&i>=5||n&&this.isDraggingHeroArrow&&i>=e)){n||this.renderer.createSwipeEffect(this.selectionStartScreen.x,this.selectionStartScreen.y,t.x,t.y);const i=t.x-this.selectionStartScreen.x,e=t.y-this.selectionStartScreen.y,s=Math.sqrt(i*i+e*e),o=new x(i/s,e/s);let r=!1;for(const t of this.selectedUnits)t.useAbility(o)&&(r=!0);r&&console.log(`Ability activated in direction (${o.x.toFixed(2)}, ${o.y.toFixed(2)})`),this.selectedUnits.clear(),this.renderer.selectedUnits=this.selectedUnits}else{const t=this.renderer.screenToWorld(s,o);this.moveOrderCounter++;for(const i of this.selectedUnits)i.rallyPoint=new x(t.x,t.y),i.moveOrder=this.moveOrderCounter;for(const i of this.selectedMirrors)i.setTarget(new x(t.x,t.y)),i.moveOrder=this.moveOrderCounter,i.isSelected=!1;this.selectedBase&&(this.selectedBase.setTarget(new x(t.x,t.y)),this.selectedBase.moveOrder=this.moveOrderCounter,this.selectedBase.isSelected=!1),this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null,this.renderer.selectedUnits=this.selectedUnits,console.log(`Movement target set at (${t.x.toFixed(0)}, ${t.y.toFixed(0)}) - Move order #${this.moveOrderCounter}`)}}i=!1,e=!1,this.isSelecting=!1,this.isDraggingHeroArrow=!1,this.isDrawingPath=!1,this.pathPoints=[],this.selectionStartScreen=null,this.renderer.selectionStart=null,this.renderer.selectionEnd=null,this.renderer.abilityArrowStart=null,this.renderer.abilityArrowEnd=null,this.endHold()};t.addEventListener("mousedown",t=>{e=!0,d(t.clientX,t.clientY)}),t.addEventListener("mousemove",t=>{n=t.clientX,r=t.clientY,p(t.clientX,t.clientY,!1)}),t.addEventListener("mouseup",()=>{u()}),t.addEventListener("mouseleave",()=>{u()}),t.addEventListener("touchstart",t=>{if(1===t.touches.length)t.preventDefault(),e=!0,d(t.touches[0].clientX,t.touches[0].clientY);else if(2===t.touches.length){t.preventDefault(),e=!0,i=!1;const n=t.touches[0],r=t.touches[1];s=(n.clientX+r.clientX)/2,o=(n.clientY+r.clientY)/2;const a=r.clientX-n.clientX,h=r.clientY-n.clientY;l=Math.sqrt(a*a+h*h),this.cancelHold()}},{passive:!1}),t.addEventListener("touchmove",t=>{if(1===t.touches.length&&e){t.preventDefault();const i=t.touches[0];p(i.clientX,i.clientY,!1)}else if(2===t.touches.length){t.preventDefault();const i=t.touches[0],e=t.touches[1],s=(i.clientX+e.clientX)/2,o=(i.clientY+e.clientY)/2,n=e.clientX-i.clientX,r=e.clientY-i.clientY,a=Math.sqrt(n*n+r*r);if(Math.abs(a-l)>1){const t=this.renderer.screenToWorld(s,o),i=a/l,e=this.renderer.zoom;this.renderer.setZoom(e*i);const n=this.renderer.screenToWorld(s,o),r=this.renderer.camera;this.renderer.setCameraPosition(new x(r.x+(t.x-n.x),r.y+(t.y-n.y))),l=a}p(s,o,!0)}},{passive:!1}),t.addEventListener("touchend",t=>{if(0===t.touches.length)u(),l=0;else if(1===t.touches.length){const e=t.touches[0];s=e.clientX,o=e.clientY,i=!1,l=0}}),t.addEventListener("touchcancel",()=>{u(),l=0}),window.addEventListener("keydown",t=>{const i=t.key.toLowerCase();if("escape"===i&&this.game&&!this.game.isCountdownActive&&!this.game.checkVictoryConditions())return t.preventDefault(),void this.toggleInGameMenu();["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(i)&&(t.preventDefault(),c.add(i))}),window.addEventListener("keyup",t=>{const i=t.key.toLowerCase();c.delete(i)});const g=()=>{const s=c.size>0,o=!h&&!e&&!i&&(n<a||n>t.width-a||r<a||r>t.height-a);if(s||o){const i=this.renderer.camera;let e=0,s=0;(c.has("w")||c.has("arrowup"))&&(s-=10),(c.has("s")||c.has("arrowdown"))&&(s+=10),(c.has("a")||c.has("arrowleft"))&&(e-=10),(c.has("d")||c.has("arrowright"))&&(e+=10),o&&(n<a&&(e-=5),n>t.width-a&&(e+=5),r<a&&(s-=5),r>t.height-a&&(s+=5)),0===e&&0===s||this.renderer.setCameraPosition(new x(i.x+e/this.renderer.zoom,i.y+s/this.renderer.zoom))}requestAnimationFrame(g)};g()}startHold(i){if(!this.game)return;const e=this.game.players[0];if(e.stellarForge)if(this.selectedMirrors.size>0){let t=!1;for(const e of this.selectedMirrors){if(!e.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const s=new p(e.position,new x(i.x-e.position.x,i.y-e.position.y).normalize(),1);let o=!0;for(const t of this.game.asteroids)if(s.intersectsPolygon(t.getWorldVertices())){o=!1;break}if(o){t=!0;break}}t&&(this.holdStartTime=Date.now(),this.holdPosition=i,this.isUsingMirrorsForWarpGate=!0,console.log("Starting mirror-based warp gate at",i))}else i.distanceTo(e.stellarForge.position)<t&&(this.holdStartTime=Date.now(),this.holdPosition=i,this.isUsingMirrorsForWarpGate=!1)}selectUnitsInRectangle(t,i){if(!this.game)return;const e=this.renderer.screenToWorld(t.x,t.y),s=this.renderer.screenToWorld(i.x,i.y),o=Math.min(e.x,s.x),n=Math.max(e.x,s.x),r=Math.min(e.y,s.y),l=Math.max(e.y,s.y);this.selectedUnits.clear(),this.selectedMirrors.clear(),this.selectedBase=null;const a=this.game.players[0];if(a&&!a.isDefeated()){for(const t of a.units)t.position.x>=o&&t.position.x<=n&&t.position.y>=r&&t.position.y<=l&&this.selectedUnits.add(t);for(const t of a.solarMirrors)t.position.x>=o&&t.position.x<=n&&t.position.y>=r&&t.position.y<=l?(this.selectedMirrors.add(t),t.isSelected=!0):t.isSelected=!1;a.stellarForge&&a.stellarForge.position.x>=o&&a.stellarForge.position.x<=n&&a.stellarForge.position.y>=r&&a.stellarForge.position.y<=l&&0===this.selectedUnits.size?(this.selectedBase=a.stellarForge,a.stellarForge.isSelected=!0):a.stellarForge&&(a.stellarForge.isSelected=!1),this.renderer.selectedUnits=this.selectedUnits,console.log(`Selected ${this.selectedUnits.size} units, ${this.selectedMirrors.size} mirrors, ${this.selectedBase?"1 base":"0 bases"}`)}}cancelHold(){if(this.game){if(this.currentWarpGate){this.currentWarpGate.cancel(),this.scatterParticles(this.currentWarpGate.position);const t=this.game.warpGates.indexOf(this.currentWarpGate);t>-1&&this.game.warpGates.splice(t,1)}this.holdStartTime=null,this.holdPosition=null,this.currentWarpGate=null,this.isUsingMirrorsForWarpGate=!1}}endHold(){this.holdStartTime=null,this.holdPosition=null,this.isUsingMirrorsForWarpGate=!1}scatterParticles(t){if(this.game)for(const i of this.game.spaceDust)if(i.position.distanceTo(t)<150){const e=new x(i.position.x-t.x,i.position.y-t.y).normalize();i.applyForce(new x(200*e.x,200*e.y))}}update(t){if(this.game&&!this.isPaused){if(this.game.isRunning&&this.game.update(t),this.holdStartTime&&this.holdPosition&&(Date.now()-this.holdStartTime)/1e3>=1&&!this.currentWarpGate){const t=this.game.players[0];this.currentWarpGate=new k(this.holdPosition,t),this.currentWarpGate.startCharging(),this.game.warpGates.push(this.currentWarpGate)}if(this.currentWarpGate){const i=null!==this.holdStartTime&&null!==this.holdPosition;let e=1;if(this.isUsingMirrorsForWarpGate&&i){this.game.players[0];let t=0;for(const i of this.selectedMirrors){if(!i.hasLineOfSightToLight(this.game.suns,this.game.asteroids))continue;const e=new p(i.position,new x(this.currentWarpGate.position.x-i.position.x,this.currentWarpGate.position.y-i.position.y).normalize(),1);let s=!0;for(const t of this.game.asteroids)if(e.intersectsPolygon(t.getWorldVertices())){s=!1;break}if(s){const e=this.game.suns.reduce((t,e)=>i.position.distanceTo(e.position)<(t?i.position.distanceTo(t.position):1/0)?e:t,null);if(e){const s=i.position.distanceTo(e.position);t+=Math.max(1,2*(1-Math.min(1,s/h)))}}}e=.5+.5*t}this.currentWarpGate.update(t,i,e)}}}render(){this.game&&this.renderer.render(this.game)}gameLoop(t){if(!this.isRunning)return;const i=0===this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,this.update(Math.min(i,.1)),this.render(),requestAnimationFrame(t=>this.gameLoop(t))}start(){this.game&&(this.isRunning=!0,this.lastTime=0,requestAnimationFrame(t=>this.gameLoop(t)))}stop(){this.isRunning=!1}}document.addEventListener("DOMContentLoaded",()=>{new j})})();